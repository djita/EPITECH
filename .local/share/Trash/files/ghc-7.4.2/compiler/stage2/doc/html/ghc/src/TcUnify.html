<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>typecheck/TcUnify.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%

Type subsumption and unification

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcUnify</span> <span class='hs-layout'>(</span>
<a name="line-9"></a>  <span class='hs-comment'>-- Full-blown subsumption</span>
<a name="line-10"></a>  <span class='hs-varid'>tcWrapResult</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSubType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcGen</span><span class='hs-layout'>,</span> 
<a name="line-11"></a>  <span class='hs-varid'>checkConstraints</span><span class='hs-layout'>,</span> <span class='hs-varid'>newImplication</span><span class='hs-layout'>,</span> <span class='hs-varid'>sigCtxt</span><span class='hs-layout'>,</span>
<a name="line-12"></a>
<a name="line-13"></a>  <span class='hs-comment'>-- Various unifications</span>
<a name="line-14"></a>  <span class='hs-varid'>unifyType</span><span class='hs-layout'>,</span> <span class='hs-varid'>unifyTypeList</span><span class='hs-layout'>,</span> <span class='hs-varid'>unifyTheta</span><span class='hs-layout'>,</span> <span class='hs-varid'>unifyKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>unifyKindEq</span><span class='hs-layout'>,</span>
<a name="line-15"></a>
<a name="line-16"></a>  <span class='hs-comment'>--------------------------------</span>
<a name="line-17"></a>  <span class='hs-comment'>-- Holes</span>
<a name="line-18"></a>  <span class='hs-varid'>tcInfer</span><span class='hs-layout'>,</span>
<a name="line-19"></a>  <span class='hs-varid'>matchExpectedListTy</span><span class='hs-layout'>,</span>
<a name="line-20"></a>  <span class='hs-varid'>matchExpectedPArrTy</span><span class='hs-layout'>,</span>
<a name="line-21"></a>  <span class='hs-varid'>matchExpectedTyConApp</span><span class='hs-layout'>,</span>
<a name="line-22"></a>  <span class='hs-varid'>matchExpectedAppTy</span><span class='hs-layout'>,</span> 
<a name="line-23"></a>  <span class='hs-varid'>matchExpectedFunTys</span><span class='hs-layout'>,</span>
<a name="line-24"></a>  <span class='hs-varid'>matchExpectedFunKind</span><span class='hs-layout'>,</span>
<a name="line-25"></a>  <span class='hs-varid'>wrapFunResCoercion</span><span class='hs-layout'>,</span>
<a name="line-26"></a>  <span class='hs-varid'>failWithMisMatch</span><span class='hs-layout'>,</span>
<a name="line-27"></a>
<a name="line-28"></a>  <span class='hs-comment'>--------------------------------</span>
<a name="line-29"></a>  <span class='hs-comment'>-- Errors</span>
<a name="line-30"></a>  <span class='hs-varid'>mkKindErrorCtxt</span>
<a name="line-31"></a>
<a name="line-32"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-33"></a>
<a name="line-34"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-35"></a>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TypeRep</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcErrors</span>	<span class='hs-layout'>(</span> <span class='hs-varid'>unifyCtxt</span> <span class='hs-layout'>)</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcMType</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcIface</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span> <span class='hs-varid'>isSystemName</span> <span class='hs-layout'>)</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Inst</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Kind</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysWiredIn</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ErrUtils</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span> <span class='hs-layout'>(</span> <span class='hs-varid'>allMaybes</span> <span class='hs-layout'>)</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-60"></a>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
             matchExpected functions
%*                                                                      *
%************************************************************************

Note [Herald for matchExpectedFunTys]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The 'herald' always looks like:
   "The equation(s) for 'f' have"
   "The abstraction (\x.e) takes"
   "The section (+ x) expects"
   "The function 'f' is applied to"

This is used to construct a message of form

   The abstraction `\Just 1 -> ...' takes two arguments
   but its type `Maybe a -> a' has only one

   The equation(s) for `f' have two arguments
   but its type `Maybe a -> a' has only one

   The section `(f 3)' requires 'f' to take two arguments
   but its type `Int -> Int' has only one

   The function 'f' is applied to two arguments
   but its type `Int -> Int' has only one

Note [matchExpectedFunTys]
~~~~~~~~~~~~~~~~~~~~~~~~~~
matchExpectedFunTys checks that an (Expected rho) has the form
of an n-ary function.  It passes the decomposed type to the
thing_inside, and returns a wrapper to coerce between the two types

It's used wherever a language construct must have a functional type,
namely:
	A lambda expression
	A function definition
     An operator section

This is not (currently) where deep skolemisation occurs;
matchExpectedFunTys does not skolmise nested foralls in the 
expected type, becuase it expects that to have been done already


\begin{code}
<pre><a name="line-1"></a><a name="matchExpectedFunTys"></a><span class='hs-definition'>matchExpectedFunTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> 	<span class='hs-comment'>-- See Note [Herald for matchExpectedFunTys]</span>
<a name="line-2"></a>            	    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span>
<a name="line-3"></a>            	    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span> 
<a name="line-4"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcSigmaType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcRhoType</span><span class='hs-layout'>)</span>
<a name="line-5"></a>
<a name="line-6"></a><span class='hs-comment'>-- If    matchExpectFunTys n ty = (co, [t1,..,tn], ty_r)</span>
<a name="line-7"></a><span class='hs-comment'>-- then  co : ty ~ (t1 -&gt; ... -&gt; tn -&gt; ty_r)</span>
<a name="line-8"></a><span class='hs-comment'>--</span>
<a name="line-9"></a><span class='hs-comment'>-- Does not allocate unnecessary meta variables: if the input already is </span>
<a name="line-10"></a><span class='hs-comment'>-- a function, we just take it apart.  Not only is this efficient, </span>
<a name="line-11"></a><span class='hs-comment'>-- it's important for higher rank: the argument might be of form</span>
<a name="line-12"></a><span class='hs-comment'>--		(forall a. ty) -&gt; other</span>
<a name="line-13"></a><span class='hs-comment'>-- If allocated (fresh-meta-var1 -&gt; fresh-meta-var2) and unified, we'd</span>
<a name="line-14"></a><span class='hs-comment'>-- hide the forall inside a meta-variable</span>
<a name="line-15"></a>
<a name="line-16"></a><span class='hs-definition'>matchExpectedFunTys</span> <span class='hs-varid'>herald</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>orig_ty</span> 
<a name="line-17"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>orig_ty</span>
<a name="line-18"></a>  <span class='hs-keyword'>where</span>
<a name="line-19"></a>    <span class='hs-comment'>-- If     go n ty = (co, [t1,..,tn], ty_r)</span>
<a name="line-20"></a>    <span class='hs-comment'>-- then   co : ty ~ t1 -&gt; .. -&gt; tn -&gt; ty_r</span>
<a name="line-21"></a>
<a name="line-22"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n_req</span> <span class='hs-varid'>ty</span>
<a name="line-23"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n_req</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcReflCo</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-24"></a>
<a name="line-25"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n_req</span> <span class='hs-varid'>ty</span>
<a name="line-26"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>n_req</span> <span class='hs-varid'>ty'</span>
<a name="line-27"></a>
<a name="line-28"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n_req</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg_ty</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-29"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isPredTy</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span>
<a name="line-30"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty_r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_req</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span>
<a name="line-31"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcFunCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcReflCo</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_ty</span><span class='hs-conop'>:</span><span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty_r</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-32"></a>
<a name="line-33"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>	      <span class='hs-comment'>-- A common case</span>
<a name="line-34"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isSynFamilyTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-35"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span><span class='hs-layout'>,</span><span class='hs-varid'>msg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mk_ctxt</span> <span class='hs-varid'>emptyTidyEnv</span>
<a name="line-36"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>failWithTcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span><span class='hs-layout'>,</span><span class='hs-varid'>msg</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-37"></a>
<a name="line-38"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n_req</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-39"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-40"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMetaTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-41"></a>	   <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cts</span> <span class='hs-keyword'>of</span>
<a name="line-42"></a>	       <span class='hs-conid'>Indirect</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>n_req</span> <span class='hs-varid'>ty'</span>
<a name="line-43"></a>	       <span class='hs-conid'>Flexi</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>defer</span> <span class='hs-varid'>n_req</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-44"></a>
<a name="line-45"></a>       <span class='hs-comment'>-- In all other cases we bale out into ordinary unification</span>
<a name="line-46"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n_req</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defer</span> <span class='hs-varid'>n_req</span> <span class='hs-varid'>ty</span>
<a name="line-47"></a>
<a name="line-48"></a>    <span class='hs-comment'>------------</span>
<a name="line-49"></a>    <span class='hs-varid'>defer</span> <span class='hs-varid'>n_req</span> <span class='hs-varid'>fun_ty</span> 
<a name="line-50"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxtM</span> <span class='hs-varid'>mk_ctxt</span> <span class='hs-varop'>$</span>
<a name="line-51"></a>        <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>arg_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTys</span> <span class='hs-varid'>n_req</span> <span class='hs-varid'>argTypeKind</span>
<a name="line-52"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>res_ty</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>openTypeKind</span>
<a name="line-53"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>co</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyType</span> <span class='hs-varid'>fun_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTys</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-54"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-55"></a>
<a name="line-56"></a>    <span class='hs-comment'>------------</span>
<a name="line-57"></a>    <span class='hs-varid'>mk_ctxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>Message</span><span class='hs-layout'>)</span>
<a name="line-58"></a>    <span class='hs-varid'>mk_ctxt</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>orig_ty1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>orig_ty</span>
<a name="line-59"></a>                     <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig_ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>orig_ty1</span>
<a name="line-60"></a>                           <span class='hs-layout'>(</span><span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitFunTys</span> <span class='hs-varid'>orig_ty2</span>
<a name="line-61"></a>                           <span class='hs-varid'>n_actual</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>args</span>
<a name="line-62"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>mk_msg</span> <span class='hs-varid'>orig_ty2</span> <span class='hs-varid'>n_actual</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-63"></a>
<a name="line-64"></a>    <span class='hs-varid'>mk_msg</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>n_args</span>
<a name="line-65"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>herald</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>speakNOf</span> <span class='hs-varid'>arity</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"argument"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span> <span class='hs-varop'>$$</span> 
<a name="line-66"></a>	<span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"but its type"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> 
<a name="line-67"></a>	     <span class='hs-keyword'>if</span> <span class='hs-varid'>n_args</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"has none"</span><span class='hs-layout'>)</span> 
<a name="line-68"></a>	     <span class='hs-keyword'>else</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"has only"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>speakN</span> <span class='hs-varid'>n_args</span><span class='hs-keyglyph'>]</span>
</pre>\end{code}


\begin{code}
<pre><a name="line-1"></a><a name="matchExpectedListTy"></a><span class='hs-comment'>----------------------</span>
<a name="line-2"></a><span class='hs-definition'>matchExpectedListTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcRhoType</span><span class='hs-layout'>)</span>
<a name="line-3"></a><span class='hs-comment'>-- Special case for lists</span>
<a name="line-4"></a><span class='hs-definition'>matchExpectedListTy</span> <span class='hs-varid'>exp_ty</span>
<a name="line-5"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>elt_ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchExpectedTyConApp</span> <span class='hs-varid'>listTyCon</span> <span class='hs-varid'>exp_ty</span>
<a name="line-6"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="matchExpectedPArrTy"></a><span class='hs-comment'>----------------------</span>
<a name="line-9"></a><span class='hs-definition'>matchExpectedPArrTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcRhoType</span><span class='hs-layout'>)</span>
<a name="line-10"></a><span class='hs-comment'>-- Special case for parrs</span>
<a name="line-11"></a><span class='hs-definition'>matchExpectedPArrTy</span> <span class='hs-varid'>exp_ty</span>
<a name="line-12"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>elt_ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchExpectedTyConApp</span> <span class='hs-varid'>parrTyCon</span> <span class='hs-varid'>exp_ty</span>
<a name="line-13"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="matchExpectedTyConApp"></a><span class='hs-comment'>----------------------</span>
<a name="line-16"></a><span class='hs-definition'>matchExpectedTyConApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span>                <span class='hs-comment'>-- T :: forall kv1 ... kvm. k1 -&gt; ... -&gt; kn -&gt; *</span>
<a name="line-17"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span> 	      <span class='hs-comment'>-- orig_ty</span>
<a name="line-18"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>,</span>      <span class='hs-comment'>-- T k1 k2 k3 a b c ~ orig_ty</span>
<a name="line-19"></a>                              <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcSigmaType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Element types, k1 k2 k3 a b c</span>
<a name="line-20"></a>                              
<a name="line-21"></a><span class='hs-comment'>-- It's used for wired-in tycons, so we call checkWiredInTyCon</span>
<a name="line-22"></a><span class='hs-comment'>-- Precondition: never called with FunTyCon</span>
<a name="line-23"></a><span class='hs-comment'>-- Precondition: input type :: *</span>
<a name="line-24"></a>
<a name="line-25"></a><span class='hs-definition'>matchExpectedTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>orig_ty</span>
<a name="line-26"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>checkWiredInTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-27"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>orig_ty</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>}</span>
<a name="line-28"></a>  <span class='hs-keyword'>where</span>
<a name="line-29"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcSigmaType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcSigmaType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-30"></a>    <span class='hs-comment'>-- If     go n ty tys = (co, [t1..tn] ++ tys)</span>
<a name="line-31"></a>    <span class='hs-comment'>-- then   co : T t1..tn ~ ty</span>
<a name="line-32"></a>
<a name="line-33"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n_req</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>tys</span>
<a name="line-34"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>n_req</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>tys</span>
<a name="line-35"></a>
<a name="line-36"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n_req</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-37"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-38"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMetaTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-39"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cts</span> <span class='hs-keyword'>of</span>
<a name="line-40"></a>               <span class='hs-conid'>Indirect</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>n_req</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>tys</span>
<a name="line-41"></a>               <span class='hs-conid'>Flexi</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>defer</span> <span class='hs-varid'>n_req</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span>
<a name="line-42"></a>
<a name="line-43"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n_req</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-44"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tycon</span>
<a name="line-45"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>n_req</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- ty::*</span>
<a name="line-46"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcReflCo</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-47"></a>
<a name="line-48"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n_req</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-49"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n_req</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span>
<a name="line-50"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_req</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>fun</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span> <span class='hs-conop'>:</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> 
<a name="line-51"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcAppCo</span> <span class='hs-varid'>co</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcReflCo</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-52"></a>
<a name="line-53"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n_req</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defer</span> <span class='hs-varid'>n_req</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>tys</span>
<a name="line-54"></a>
<a name="line-55"></a>    <span class='hs-comment'>----------</span>
<a name="line-56"></a>    <span class='hs-varid'>defer</span> <span class='hs-varid'>n_req</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>tys</span>
<a name="line-57"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kappa_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varid'>newMetaKindVar</span><span class='hs-layout'>)</span> <span class='hs-varid'>kvs</span>
<a name="line-58"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>arg_kinds'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>substKiWith</span> <span class='hs-varid'>kvs</span> <span class='hs-varid'>kappa_tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_kinds</span>
<a name="line-59"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>tau_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>arg_kinds'</span>
<a name="line-60"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyType</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>kappa_tys</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tau_tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-61"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>kappa_tys</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tau_tys</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-62"></a>      <span class='hs-keyword'>where</span>
<a name="line-63"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitForAllTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-64"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>arg_kinds</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitKindFunTysN</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_req</span> <span class='hs-comment'>-</span> <span class='hs-varid'>length</span> <span class='hs-varid'>kvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>body</span>
<a name="line-65"></a>
<a name="line-66"></a><a name="matchExpectedAppTy"></a><span class='hs-comment'>----------------------</span>
<a name="line-67"></a><span class='hs-definition'>matchExpectedAppTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRhoType</span>                         <span class='hs-comment'>-- orig_ty</span>
<a name="line-68"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>,</span>                   <span class='hs-comment'>-- m a ~ orig_ty</span>
<a name="line-69"></a>                           <span class='hs-layout'>(</span><span class='hs-conid'>TcSigmaType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcSigmaType</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Returns m, a</span>
<a name="line-70"></a><span class='hs-comment'>-- If the incoming type is a mutable type variable of kind k, then</span>
<a name="line-71"></a><span class='hs-comment'>-- matchExpectedAppTy returns a new type variable (m: * -&gt; k); note the *.</span>
<a name="line-72"></a>
<a name="line-73"></a><span class='hs-definition'>matchExpectedAppTy</span> <span class='hs-varid'>orig_ty</span>
<a name="line-74"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>orig_ty</span>
<a name="line-75"></a>  <span class='hs-keyword'>where</span>
<a name="line-76"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-77"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty'</span>
<a name="line-78"></a>
<a name="line-79"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSplitAppTy_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-80"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcReflCo</span> <span class='hs-varid'>orig_ty</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-81"></a>
<a name="line-82"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-83"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-84"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMetaTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-85"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cts</span> <span class='hs-keyword'>of</span>
<a name="line-86"></a>               <span class='hs-conid'>Indirect</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-87"></a>               <span class='hs-conid'>Flexi</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>defer</span> <span class='hs-layout'>}</span>
<a name="line-88"></a>
<a name="line-89"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defer</span>
<a name="line-90"></a>
<a name="line-91"></a>    <span class='hs-comment'>-- Defer splitting by generating an equality constraint</span>
<a name="line-92"></a>    <span class='hs-varid'>defer</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>kind1</span>
<a name="line-93"></a>               <span class='hs-layout'>;</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>kind2</span>
<a name="line-94"></a>               <span class='hs-layout'>;</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyType</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-varid'>orig_ty</span>
<a name="line-95"></a>               <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-96"></a>
<a name="line-97"></a>    <span class='hs-varid'>orig_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>orig_ty</span>
<a name="line-98"></a>    <span class='hs-varid'>kind1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkArrowKind</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>defaultKind</span> <span class='hs-varid'>orig_kind</span><span class='hs-layout'>)</span>
<a name="line-99"></a>    <span class='hs-varid'>kind2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftedTypeKind</span>    <span class='hs-comment'>-- m :: * -&gt; k</span>
<a name="line-100"></a>                              <span class='hs-comment'>-- arg type :: *</span>
<a name="line-101"></a>        <span class='hs-comment'>-- The defaultKind is a bit smelly.  If you remove it,</span>
<a name="line-102"></a>        <span class='hs-comment'>-- try compiling        f x = do { x }</span>
<a name="line-103"></a>        <span class='hs-comment'>-- and you'll get a kind mis-match.  It smells, but</span>
<a name="line-104"></a>        <span class='hs-comment'>-- not enough to lose sleep over.</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
                Subsumption checking
%*                                                                      *
%************************************************************************

All the tcSub calls have the form
                tcSub actual_ty expected_ty
which checks
                actual_ty <= expected_ty

That is, that a value of type actual_ty is acceptable in
a place expecting a value of type expected_ty.

It returns a coercion function
        co_fn :: actual_ty ~ expected_ty
which takes an HsExpr of type actual_ty into one of type
expected_ty.

\begin{code}
<pre><a name="line-1"></a><a name="tcSubType"></a><span class='hs-definition'>tcSubType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-2"></a><span class='hs-comment'>-- Check that ty_actual is more polymorphic than ty_expected</span>
<a name="line-3"></a><span class='hs-comment'>-- Both arguments might be polytypes, so we must instantiate and skolemise</span>
<a name="line-4"></a><span class='hs-comment'>-- Returns a wrapper of shape   ty_actual ~ ty_expected</span>
<a name="line-5"></a><span class='hs-definition'>tcSubType</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isSigmaTy</span> <span class='hs-varid'>ty_actual</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>sk_wrap</span><span class='hs-layout'>,</span> <span class='hs-varid'>inst_wrap</span><span class='hs-layout'>)</span> 
<a name="line-8"></a>            <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGen</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty_expected</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>sk_rho</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-9"></a>            <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_wrap</span><span class='hs-layout'>,</span> <span class='hs-varid'>in_rho</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>deeplyInstantiate</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>ty_actual</span>
<a name="line-10"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>cow</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyType</span> <span class='hs-varid'>in_rho</span> <span class='hs-varid'>sk_rho</span>
<a name="line-11"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>coToHsWrapper</span> <span class='hs-varid'>cow</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>in_wrap</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-12"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>sk_wrap</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>inst_wrap</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-13"></a>
<a name="line-14"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>	<span class='hs-comment'>-- Urgh!  It seems deeply weird to have equality</span>
<a name="line-15"></a>    		<span class='hs-comment'>-- when actual is not a polytype, and it makes a big </span>
<a name="line-16"></a>		<span class='hs-comment'>-- difference e.g. tcfail104</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cow</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyType</span> <span class='hs-varid'>ty_actual</span> <span class='hs-varid'>ty_expected</span>
<a name="line-18"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>coToHsWrapper</span> <span class='hs-varid'>cow</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-19"></a>  
<a name="line-20"></a><a name="tcInfer"></a><span class='hs-definition'>tcInfer</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>
<a name="line-21"></a><span class='hs-definition'>tcInfer</span> <span class='hs-varid'>tc_infer</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>openTypeKind</span>
<a name="line-22"></a>                      <span class='hs-layout'>;</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_infer</span> <span class='hs-varid'>ty</span>
<a name="line-23"></a>		      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="tcWrapResult"></a><span class='hs-comment'>-----------------</span>
<a name="line-26"></a><span class='hs-definition'>tcWrapResult</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>TcId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>
<a name="line-27"></a><span class='hs-definition'>tcWrapResult</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>actual_ty</span> <span class='hs-varid'>res_ty</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cow</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyType</span> <span class='hs-varid'>actual_ty</span> <span class='hs-varid'>res_ty</span>
<a name="line-29"></a>       	        <span class='hs-comment'>-- Both types are deeply skolemised</span>
<a name="line-30"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsWrapCo</span> <span class='hs-varid'>cow</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-31"></a>
<a name="line-32"></a><a name="wrapFunResCoercion"></a><span class='hs-comment'>-----------------------------------</span>
<a name="line-33"></a><span class='hs-definition'>wrapFunResCoercion</span>
<a name="line-34"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span>     <span class='hs-comment'>-- Type of args</span>
<a name="line-35"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>    <span class='hs-comment'>-- HsExpr a -&gt; HsExpr b</span>
<a name="line-36"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>HsWrapper</span>        <span class='hs-comment'>-- HsExpr (arg_tys -&gt; a) -&gt; HsExpr (arg_tys -&gt; b)</span>
<a name="line-37"></a><span class='hs-definition'>wrapFunResCoercion</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varid'>co_fn_res</span>
<a name="line-38"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isIdHsWrapper</span> <span class='hs-varid'>co_fn_res</span>
<a name="line-39"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>idHsWrapper</span>
<a name="line-40"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>arg_tys</span>
<a name="line-41"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>co_fn_res</span>
<a name="line-42"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-43"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>arg_ids</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newSysLocalIds</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"sub"</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_tys</span>
<a name="line-44"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkWpLams</span> <span class='hs-varid'>arg_ids</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>co_fn_res</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>mkWpEvVarApps</span> <span class='hs-varid'>arg_ids</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}



%************************************************************************
%*                                                                      *
\subsection{Generalisation}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="tcGen"></a><span class='hs-definition'>tcGen</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>
<a name="line-2"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRhoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span>
<a name="line-3"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrapper</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span>
<a name="line-4"></a>        <span class='hs-comment'>-- The expression has type: spec_ty -&gt; expected_ty</span>
<a name="line-5"></a>
<a name="line-6"></a><span class='hs-definition'>tcGen</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>expected_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-7"></a>   <span class='hs-comment'>-- We expect expected_ty to be a forall-type</span>
<a name="line-8"></a>   <span class='hs-comment'>-- If not, the call is a no-op</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcGen"</span> <span class='hs-varid'>empty</span>
<a name="line-10"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>given</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>deeplySkolemise</span> <span class='hs-varid'>expected_ty</span>
<a name="line-11"></a>
<a name="line-12"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-varid'>debugIsOn</span> <span class='hs-varop'>$</span>
<a name="line-13"></a>              <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcGen"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span>
<a name="line-14"></a>                           <span class='hs-varid'>text</span> <span class='hs-str'>"expected_ty"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>expected_ty</span><span class='hs-layout'>,</span>
<a name="line-15"></a>                           <span class='hs-varid'>text</span> <span class='hs-str'>"inst ty"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tvs'</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>rho'</span> <span class='hs-keyglyph'>]</span>
<a name="line-16"></a>
<a name="line-17"></a>	<span class='hs-comment'>-- Generally we must check that the "forall_tvs" havn't been constrained</span>
<a name="line-18"></a>        <span class='hs-comment'>-- The interesting bit here is that we must include the free variables</span>
<a name="line-19"></a>        <span class='hs-comment'>-- of the expected_ty.  Here's an example:</span>
<a name="line-20"></a>        <span class='hs-comment'>--       runST (newVar True)</span>
<a name="line-21"></a>        <span class='hs-comment'>-- Here, if we don't make a check, we'll get a type (ST s (MutVar s Bool))</span>
<a name="line-22"></a>        <span class='hs-comment'>-- for (newVar True), with s fresh.  Then we unify with the runST's arg type</span>
<a name="line-23"></a>        <span class='hs-comment'>-- forall s'. ST s' a. That unifies s' with s, and a with MutVar s Bool.</span>
<a name="line-24"></a>        <span class='hs-comment'>-- So now s' isn't unconstrained because it's linked to a.</span>
<a name="line-25"></a>        <span class='hs-comment'>-- </span>
<a name="line-26"></a>	<span class='hs-comment'>-- However [Oct 10] now that the untouchables are a range of </span>
<a name="line-27"></a>        <span class='hs-comment'>-- TcTyVars, all this is handled automatically with no need for</span>
<a name="line-28"></a>	<span class='hs-comment'>-- extra faffing around</span>
<a name="line-29"></a>
<a name="line-30"></a>        <span class='hs-comment'>-- Use the *instantiated* type in the SkolemInfo</span>
<a name="line-31"></a>        <span class='hs-comment'>-- so that the names of displayed type variables line up</span>
<a name="line-32"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>skol_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SigSkol</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPiTypes</span> <span class='hs-varid'>given</span> <span class='hs-varid'>rho'</span><span class='hs-layout'>)</span>
<a name="line-33"></a>
<a name="line-34"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkConstraints</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>tvs'</span> <span class='hs-varid'>given</span> <span class='hs-varop'>$</span>
<a name="line-35"></a>                                <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>tvs'</span> <span class='hs-varid'>rho'</span>
<a name="line-36"></a>
<a name="line-37"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>mkWpLet</span> <span class='hs-varid'>ev_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-38"></a>	  <span class='hs-comment'>-- The ev_binds returned by checkConstraints is very</span>
<a name="line-39"></a>	  <span class='hs-comment'>-- often empty, in which case mkWpLet is a no-op</span>
<a name="line-40"></a>
<a name="line-41"></a><a name="checkConstraints"></a><span class='hs-definition'>checkConstraints</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SkolemInfo</span>
<a name="line-42"></a>		 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>		<span class='hs-comment'>-- Skolems</span>
<a name="line-43"></a>		 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span>             <span class='hs-comment'>-- Given</span>
<a name="line-44"></a>		 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>result</span>
<a name="line-45"></a>		 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcEvBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span>
<a name="line-46"></a>
<a name="line-47"></a><span class='hs-definition'>checkConstraints</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-varid'>given</span> <span class='hs-varid'>thing_inside</span>
<a name="line-48"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>given</span>
<a name="line-49"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyTcEvBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-50"></a>      <span class='hs-comment'>-- Just for efficiency.  We check every function argument with</span>
<a name="line-51"></a>      <span class='hs-comment'>-- tcPolyExpr, which uses tcGen and hence checkConstraints.</span>
<a name="line-52"></a>
<a name="line-53"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-54"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newImplication</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-varid'>given</span> <span class='hs-varid'>thing_inside</span>
<a name="line-55"></a>
<a name="line-56"></a><a name="newImplication"></a><span class='hs-definition'>newImplication</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SkolemInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-57"></a>	       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>result</span>
<a name="line-58"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcEvBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span>
<a name="line-59"></a><span class='hs-definition'>newImplication</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-varid'>given</span> <span class='hs-varid'>thing_inside</span>
<a name="line-60"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>skol_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-layout'>)</span>
<a name="line-61"></a>    <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isSkolemTyVar</span> <span class='hs-varid'>skol_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-layout'>)</span>
<a name="line-62"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>result</span><span class='hs-layout'>,</span> <span class='hs-varid'>untch</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>wanted</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>captureConstraints</span>  <span class='hs-varop'>$</span> 
<a name="line-63"></a>                                      <span class='hs-varid'>captureUntouchables</span> <span class='hs-varop'>$</span>
<a name="line-64"></a>                                      <span class='hs-varid'>thing_inside</span>
<a name="line-65"></a>
<a name="line-66"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isEmptyWC</span> <span class='hs-varid'>wanted</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>hasEqualities</span> <span class='hs-varid'>given</span><span class='hs-layout'>)</span>
<a name="line-67"></a>       	    <span class='hs-comment'>-- Optimisation : if there are no wanteds, and the givens</span>
<a name="line-68"></a>       	    <span class='hs-comment'>-- are sufficiently simple, don't generate an implication</span>
<a name="line-69"></a>       	    <span class='hs-comment'>-- at all.  Reason for the hasEqualities test:</span>
<a name="line-70"></a>	    <span class='hs-comment'>-- we don't want to lose the "inaccessible alternative"</span>
<a name="line-71"></a>	    <span class='hs-comment'>-- error check</span>
<a name="line-72"></a>         <span class='hs-keyword'>then</span> 
<a name="line-73"></a>            <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyTcEvBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span>
<a name="line-74"></a>         <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-75"></a>       <span class='hs-layout'>{</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTcEvBinds</span>
<a name="line-76"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>lcl_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLclTypeEnv</span>
<a name="line-77"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCtLoc</span> <span class='hs-varid'>skol_info</span>
<a name="line-78"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>emitImplication</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Implic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_untch</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>untch</span>
<a name="line-79"></a>             		     	  <span class='hs-layout'>,</span> <span class='hs-varid'>ic_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl_env</span>
<a name="line-80"></a>             		     	  <span class='hs-layout'>,</span> <span class='hs-varid'>ic_skols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>skol_tvs</span>
<a name="line-81"></a>                             	  <span class='hs-layout'>,</span> <span class='hs-varid'>ic_given</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>given</span>
<a name="line-82"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>ic_wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wanted</span>
<a name="line-83"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>ic_insol</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insolubleWC</span> <span class='hs-varid'>wanted</span>
<a name="line-84"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>ic_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-85"></a>             		     	  <span class='hs-layout'>,</span> <span class='hs-varid'>ic_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span>
<a name="line-86"></a>
<a name="line-87"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcEvBinds</span> <span class='hs-varid'>ev_binds_var</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
                Boxy unification
%*                                                                      *
%************************************************************************

The exported functions are all defined as versions of some
non-exported generic functions.

\begin{code}
<pre><a name="line-1"></a><a name="unifyType"></a><span class='hs-definition'>unifyType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTauType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTauType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-2"></a><span class='hs-comment'>-- Actual and expected types</span>
<a name="line-3"></a><span class='hs-comment'>-- Returns a coercion : ty1 ~ ty2</span>
<a name="line-4"></a><span class='hs-definition'>unifyType</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uType</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="unifyPred"></a><span class='hs-comment'>---------------</span>
<a name="line-7"></a><span class='hs-definition'>unifyPred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-8"></a><span class='hs-comment'>-- Actual and expected types</span>
<a name="line-9"></a><span class='hs-definition'>unifyPred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unifyType</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="unifyTheta"></a><span class='hs-comment'>---------------</span>
<a name="line-12"></a><span class='hs-definition'>unifyTheta</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcCoercion</span><span class='hs-keyglyph'>]</span>
<a name="line-13"></a><span class='hs-comment'>-- Actual and expected types</span>
<a name="line-14"></a><span class='hs-definition'>unifyTheta</span> <span class='hs-varid'>theta1</span> <span class='hs-varid'>theta2</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>equalLength</span> <span class='hs-varid'>theta1</span> <span class='hs-varid'>theta2</span><span class='hs-layout'>)</span>
<a name="line-16"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Contexts differ in length"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-17"></a>                         <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>parens</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Use -XRelaxedPolyRec to allow this"</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-18"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>zipWithM</span> <span class='hs-varid'>unifyPred</span> <span class='hs-varid'>theta1</span> <span class='hs-varid'>theta2</span> <span class='hs-layout'>}</span>
</pre>\end{code}

@unifyTypeList@ takes a single list of @TauType@s and unifies them
all together.  It is used, for example, when typechecking explicit
lists, when all the elts should be of the same type.

\begin{code}
<pre><a name="line-1"></a><a name="unifyTypeList"></a><span class='hs-definition'>unifyTypeList</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTauType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-definition'>unifyTypeList</span> <span class='hs-conid'>[]</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-3"></a><span class='hs-definition'>unifyTypeList</span> <span class='hs-keyglyph'>[</span><span class='hs-keyword'>_</span><span class='hs-keyglyph'>]</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-4"></a><span class='hs-definition'>unifyTypeList</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-conop'>:</span><span class='hs-varid'>tys</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>ty2</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyType</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-5"></a>                                     <span class='hs-layout'>;</span> <span class='hs-varid'>unifyTypeList</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
                 uType and friends									
%*                                                                      *
%************************************************************************

uType is the heart of the unifier.  Each arg occurs twice, because
we want to report errors in terms of synomyms if possible.  The first of
the pair is used in error messages only; it is always the same as the
second, except that if the first is a synonym then the second may be a
de-synonym'd version.  This way we get better error messages.

\begin{code}
<pre><a name="line-1"></a><a name="SwapFlag"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>SwapFlag</span> 
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NotSwapped</span>	<span class='hs-comment'>-- Args are: actual,   expected</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>IsSwapped</span>   <span class='hs-comment'>-- Args are: expected, actual</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>SwapFlag</span> <span class='hs-keyword'>where</span>
<a name="line-6"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>IsSwapped</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Is-swapped"</span><span class='hs-layout'>)</span>
<a name="line-7"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>NotSwapped</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Not-swapped"</span><span class='hs-layout'>)</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="unSwap"></a><span class='hs-definition'>unSwap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SwapFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>-&gt;</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>-&gt;</span><span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span>
<a name="line-10"></a><span class='hs-definition'>unSwap</span> <span class='hs-conid'>NotSwapped</span> <span class='hs-varid'>f</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>
<a name="line-11"></a><span class='hs-definition'>unSwap</span> <span class='hs-conid'>IsSwapped</span>  <span class='hs-varid'>f</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-varid'>b</span> <span class='hs-varid'>a</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="uType"></a><span class='hs-comment'>------------</span>
<a name="line-14"></a><span class='hs-definition'>uType</span><span class='hs-layout'>,</span> <span class='hs-varid'>uType_np</span><span class='hs-layout'>,</span> <span class='hs-varid'>uType_defer</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EqOrigin</span><span class='hs-keyglyph'>]</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>    <span class='hs-comment'>-- ty1 is the *actual* type</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>    <span class='hs-comment'>-- ty2 is the *expected* type</span>
<a name="line-18"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="uType_defer"></a><span class='hs-comment'>--------------</span>
<a name="line-21"></a><span class='hs-comment'>-- It is always safe to defer unification to the main constraint solver</span>
<a name="line-22"></a><span class='hs-comment'>-- See Note [Deferred unification]</span>
<a name="line-23"></a><span class='hs-definition'>uType_defer</span> <span class='hs-layout'>(</span><span class='hs-varid'>item</span> <span class='hs-conop'>:</span> <span class='hs-varid'>origin</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-24"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapEqCtxt</span> <span class='hs-varid'>origin</span> <span class='hs-varop'>$</span>
<a name="line-25"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>eqv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEq</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-26"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCtLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeEqOrigin</span> <span class='hs-varid'>item</span><span class='hs-layout'>)</span>
<a name="line-27"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>emitFlat</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkEvVarX</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-28"></a>
<a name="line-29"></a>       <span class='hs-comment'>-- Error trace only</span>
<a name="line-30"></a>       <span class='hs-comment'>-- NB. do *not* call mkErrInfo unless tracing is on, because</span>
<a name="line-31"></a>       <span class='hs-comment'>-- it is hugely expensive (#5631)</span>
<a name="line-32"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ifDOptM</span> <span class='hs-conid'>Opt_D_dump_tc_trace</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-33"></a>            <span class='hs-layout'>{</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getErrCtxt</span>
<a name="line-34"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkErrInfo</span> <span class='hs-varid'>emptyTidyEnv</span> <span class='hs-varid'>ctxt</span>
<a name="line-35"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"utype_defer"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>eqv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span>
<a name="line-36"></a>                                           <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>origin</span><span class='hs-layout'>,</span> <span class='hs-varid'>doc</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-37"></a>            <span class='hs-layout'>}</span>
<a name="line-38"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcCoVarCo</span> <span class='hs-varid'>eqv</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-39"></a><span class='hs-definition'>uType_defer</span> <span class='hs-conid'>[]</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>
<a name="line-40"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"uType_defer"</span>
<a name="line-41"></a>
<a name="line-42"></a><span class='hs-comment'>--------------</span>
<a name="line-43"></a><span class='hs-comment'>-- Push a new item on the origin stack (the most common case)</span>
<a name="line-44"></a><span class='hs-definition'>uType</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>  <span class='hs-comment'>-- Push a new item on the origin stack</span>
<a name="line-45"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uType_np</span> <span class='hs-layout'>(</span><span class='hs-varid'>pushOrigin</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>origin</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-46"></a>
<a name="line-47"></a><a name="uType_np"></a><span class='hs-comment'>--------------</span>
<a name="line-48"></a><span class='hs-comment'>-- unify_np (short for "no push" on the origin stack) does the work</span>
<a name="line-49"></a><span class='hs-definition'>uType_np</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>orig_ty1</span> <span class='hs-varid'>orig_ty2</span>
<a name="line-50"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"u_tys "</span> <span class='hs-varop'>$</span> <span class='hs-varid'>vcat</span> 
<a name="line-51"></a>              <span class='hs-keyglyph'>[</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>orig_ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"~"</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>orig_ty2</span><span class='hs-keyglyph'>]</span>
<a name="line-52"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>origin</span><span class='hs-keyglyph'>]</span>
<a name="line-53"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>orig_ty1</span> <span class='hs-varid'>orig_ty2</span>
<a name="line-54"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isTcReflCo</span> <span class='hs-varid'>co</span>
<a name="line-55"></a>            <span class='hs-keyword'>then</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"u_tys yields no coercion"</span> <span class='hs-varid'>empty</span>
<a name="line-56"></a>            <span class='hs-keyword'>else</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"u_tys yields coercion:"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-57"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>co</span> <span class='hs-layout'>}</span>
<a name="line-58"></a>  <span class='hs-keyword'>where</span>
<a name="line-59"></a>    <span class='hs-varid'>bale_out</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EqOrigin</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-60"></a>    <span class='hs-varid'>bale_out</span> <span class='hs-varid'>origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithMisMatch</span> <span class='hs-varid'>origin</span>
<a name="line-61"></a>
<a name="line-62"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-63"></a>	<span class='hs-comment'>-- The arguments to 'go' are always semantically identical </span>
<a name="line-64"></a>	<span class='hs-comment'>-- to orig_ty{1,2} except for looking through type synonyms</span>
<a name="line-65"></a>
<a name="line-66"></a>        <span class='hs-comment'>-- Variables; go for uVar</span>
<a name="line-67"></a>	<span class='hs-comment'>-- Note that we pass in *original* (before synonym expansion), </span>
<a name="line-68"></a>        <span class='hs-comment'>-- so that type variables tend to get filled in with </span>
<a name="line-69"></a>        <span class='hs-comment'>-- the most informative version of the type</span>
<a name="line-70"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tyvar1</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uVar</span> <span class='hs-varid'>origin</span> <span class='hs-conid'>NotSwapped</span> <span class='hs-varid'>tyvar1</span> <span class='hs-varid'>ty2</span>
<a name="line-71"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tyvar2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uVar</span> <span class='hs-varid'>origin</span> <span class='hs-conid'>IsSwapped</span>  <span class='hs-varid'>tyvar2</span> <span class='hs-varid'>ty1</span>
<a name="line-72"></a>
<a name="line-73"></a>        <span class='hs-comment'>-- See Note [Expanding synonyms during unification]</span>
<a name="line-74"></a>	<span class='hs-comment'>--</span>
<a name="line-75"></a>	<span class='hs-comment'>-- Also NB that we recurse to 'go' so that we don't push a</span>
<a name="line-76"></a>	<span class='hs-comment'>-- new item on the origin stack. As a result if we have</span>
<a name="line-77"></a>	<span class='hs-comment'>--   type Foo = Int</span>
<a name="line-78"></a>	<span class='hs-comment'>-- and we try to unify  Foo ~ Bool</span>
<a name="line-79"></a>	<span class='hs-comment'>-- we'll end up saying "can't match Foo with Bool"</span>
<a name="line-80"></a>	<span class='hs-comment'>-- rather than "can't match "Int with Bool".  See Trac #4535.</span>
<a name="line-81"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-82"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2</span>
<a name="line-83"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span>  <span class='hs-varid'>ty2'</span>
<a name="line-84"></a>      	     
<a name="line-85"></a>        <span class='hs-comment'>-- Functions (or predicate functions) just check the two parts</span>
<a name="line-86"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>fun1</span> <span class='hs-varid'>arg1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>fun2</span> <span class='hs-varid'>arg2</span><span class='hs-layout'>)</span>
<a name="line-87"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_l</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>uType</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>fun1</span> <span class='hs-varid'>fun2</span>
<a name="line-88"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>co_r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>uType</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>arg1</span> <span class='hs-varid'>arg2</span>
<a name="line-89"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkTcFunCo</span> <span class='hs-varid'>co_l</span> <span class='hs-varid'>co_r</span> <span class='hs-layout'>}</span>
<a name="line-90"></a>
<a name="line-91"></a>        <span class='hs-comment'>-- Always defer if a type synonym family (type function)</span>
<a name="line-92"></a>      	<span class='hs-comment'>-- is involved.  (Data families behave rigidly.)</span>
<a name="line-93"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc1</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span>
<a name="line-94"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isSynFamilyTyCon</span> <span class='hs-varid'>tc1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uType_defer</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>   
<a name="line-95"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc2</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-96"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isSynFamilyTyCon</span> <span class='hs-varid'>tc2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uType_defer</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>   
<a name="line-97"></a>
<a name="line-98"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc1</span> <span class='hs-varid'>tys1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc2</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span>
<a name="line-99"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tc2</span>	   <span class='hs-comment'>-- See Note [TyCon app]</span>
<a name="line-100"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>uList</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>uType</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>tys2</span>
<a name="line-101"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkTcTyConAppCo</span> <span class='hs-varid'>tc1</span> <span class='hs-varid'>cos</span> <span class='hs-layout'>}</span>
<a name="line-102"></a>     
<a name="line-103"></a>	<span class='hs-comment'>-- See Note [Care with type applications]</span>
<a name="line-104"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span>
<a name="line-105"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>s2</span><span class='hs-layout'>,</span><span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSplitAppTy_maybe</span> <span class='hs-varid'>ty2</span>
<a name="line-106"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_s</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>uType_np</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span>  <span class='hs-comment'>-- See Note [Unifying AppTy]</span>
<a name="line-107"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>co_t</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>uType</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>        
<a name="line-108"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkTcAppCo</span> <span class='hs-varid'>co_s</span> <span class='hs-varid'>co_t</span> <span class='hs-layout'>}</span>
<a name="line-109"></a>
<a name="line-110"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-111"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>s1</span><span class='hs-layout'>,</span><span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSplitAppTy_maybe</span> <span class='hs-varid'>ty1</span>
<a name="line-112"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_s</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>uType_np</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span>
<a name="line-113"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>co_t</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>uType</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-114"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkTcAppCo</span> <span class='hs-varid'>co_s</span> <span class='hs-varid'>co_t</span> <span class='hs-layout'>}</span>
<a name="line-115"></a>
<a name="line-116"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-117"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tcIsForAllTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>||</span> <span class='hs-varid'>tcIsForAllTy</span> <span class='hs-varid'>ty2</span> 
<a name="line-118"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unifySigmaTy</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-119"></a>
<a name="line-120"></a>        <span class='hs-comment'>-- Anything else fails</span>
<a name="line-121"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bale_out</span> <span class='hs-varid'>origin</span>
<a name="line-122"></a>
<a name="line-123"></a><a name="unifySigmaTy"></a><span class='hs-definition'>unifySigmaTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EqOrigin</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-124"></a><span class='hs-definition'>unifySigmaTy</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-125"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs1</span><span class='hs-layout'>,</span> <span class='hs-varid'>body1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitForAllTys</span> <span class='hs-varid'>ty1</span>
<a name="line-126"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>tvs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>body2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitForAllTys</span> <span class='hs-varid'>ty2</span>
<a name="line-127"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>equalLength</span> <span class='hs-varid'>tvs1</span> <span class='hs-varid'>tvs2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>failWithMisMatch</span> <span class='hs-varid'>origin</span><span class='hs-layout'>)</span>
<a name="line-128"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInstSkolTyVars</span> <span class='hs-varid'>tvs1</span>
<a name="line-129"></a>                  <span class='hs-comment'>-- Get location from monad, not from tvs1</span>
<a name="line-130"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tys</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>skol_tvs</span>
<a name="line-131"></a>             <span class='hs-varid'>in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>skol_tvs</span><span class='hs-layout'>)</span>
<a name="line-132"></a>             <span class='hs-varid'>phi1</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>substTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipTyEnv</span> <span class='hs-varid'>tvs1</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>body1</span>
<a name="line-133"></a>             <span class='hs-varid'>phi2</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>substTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipTyEnv</span> <span class='hs-varid'>tvs2</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>body2</span>
<a name="line-134"></a>	     <span class='hs-varid'>skol_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnifyForAllSkol</span> <span class='hs-varid'>ty1</span>
<a name="line-135"></a>
<a name="line-136"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkConstraints</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-conid'>[]</span> <span class='hs-varop'>$</span>
<a name="line-137"></a>                           <span class='hs-varid'>uType</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>phi1</span> <span class='hs-varid'>phi2</span>
<a name="line-138"></a>
<a name="line-139"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldr</span> <span class='hs-varid'>mkTcForAllCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcLetCo</span> <span class='hs-varid'>ev_binds</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>skol_tvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-140"></a>
<a name="line-141"></a><a name="uList"></a><span class='hs-comment'>---------------</span>
<a name="line-142"></a><span class='hs-definition'>uList</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EqOrigin</span><span class='hs-keyglyph'>]</span> 
<a name="line-143"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>EqOrigin</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-144"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span>
<a name="line-145"></a><span class='hs-comment'>-- Unify corresponding elements of two lists of types, which</span>
<a name="line-146"></a><span class='hs-comment'>-- should be of equal length.  We charge down the list explicitly so that</span>
<a name="line-147"></a><span class='hs-comment'>-- we can complain if their lengths differ.</span>
<a name="line-148"></a><span class='hs-definition'>uList</span> <span class='hs-keyword'>_</span>       <span class='hs-keyword'>_</span>     <span class='hs-conid'>[]</span>         <span class='hs-conid'>[]</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>
<a name="line-149"></a><span class='hs-definition'>uList</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>unify</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-conop'>:</span><span class='hs-varid'>tys1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty2</span><span class='hs-conop'>:</span><span class='hs-varid'>tys2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>x</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unify</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>;</span>
<a name="line-150"></a>                                              <span class='hs-layout'>;</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>uList</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>unify</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>tys2</span>
<a name="line-151"></a>                                              <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-152"></a><span class='hs-definition'>uList</span> <span class='hs-varid'>origin</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithMisMatch</span> <span class='hs-varid'>origin</span>
<a name="line-153"></a>       <span class='hs-comment'>-- See Note [Mismatched type lists and application decomposition]</span>
<a name="line-154"></a>
</pre>\end{code}

Note [Care with type applications]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Note: type applications need a bit of care!
They can match FunTy and TyConApp, so use splitAppTy_maybe
NB: we've already dealt with type variables and Notes,
so if one type is an App the other one jolly well better be too

Note [Unifying AppTy]
~~~~~~~~~~~~~~~~~~~~~
Considerm unifying  (m Int) ~ (IO Int) where m is a unification variable 
that is now bound to (say) (Bool ->).  Then we want to report 
     "Can't unify (Bool -> Int) with (IO Int)
and not 
     "Can't unify ((->) Bool) with IO"
That is why we use the "_np" variant of uType, which does not alter the error
message.

Note [TyCon app]
~~~~~~~~~~~~~~~~
When we find two TyConApps, the argument lists are guaranteed equal
length.  Reason: intially the kinds of the two types to be unified is
the same. The only way it can become not the same is when unifying two
AppTys (f1 a1)~(f2 a2).  In that case there can't be a TyConApp in
the f1,f2 (because it'd absorb the app).  If we unify f1~f2 first,
which we do, that ensures that f1,f2 have the same kind; and that
means a1,a2 have the same kind.  And now the argument repeats.

Note [Mismatched type lists and application decomposition]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we find two TyConApps, you might think that the argument lists 
are guaranteed equal length.  But they aren't. Consider matching
	w (T x) ~ Foo (T x y)
We do match (w ~ Foo) first, but in some circumstances we simply create
a deferred constraint; and then go ahead and match (T x ~ T x y).
This came up in Trac #3950.

So either 
   (a) either we must check for identical argument kinds 
       when decomposing applications,
  
   (b) or we must be prepared for ill-kinded unification sub-problems

Currently we adopt (b) since it seems more robust -- no need to maintain
a global invariant.

Note [Expanding synonyms during unification]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We expand synonyms during unification, but:
 * We expand *after* the variable case so that we tend to unify
   variables with un-expanded type synonym. This just makes it
   more likely that the inferred types will mention type synonyms
   understandable to the user

 * We expand *before* the TyConApp case.  For example, if we have
      type Phantom a = Int
   and are unifying
      Phantom Int ~ Phantom Char
   it is *wrong* to unify Int and Char.

Note [Deferred Unification]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
We may encounter a unification ty1 ~ ty2 that cannot be performed syntactically,
and yet its consistency is undetermined. Previously, there was no way to still
make it consistent. So a mismatch error was issued.

Now these unfications are deferred until constraint simplification, where type
family instances and given equations may (or may not) establish the consistency.
Deferred unifications are of the form
                F ... ~ ...
or              x ~ ...
where F is a type function and x is a type variable.
E.g.
        id :: x ~ y => x -> y
        id e = e

involves the unfication x = y. It is deferred until we bring into account the
context x ~ y to establish that it holds.

If available, we defer original types (rather than those where closed type
synonyms have already been expanded via tcCoreView).  This is, as usual, to
improve error messages.


%************************************************************************
%*                                                                      *
                 uVar and friends
%*                                                                      *
%************************************************************************

@uVar@ is called when at least one of the types being unified is a
variable.  It does {\em not} assume that the variable is a fixed point
of the substitution; rather, notice that @uVar@ (defined below) nips
back into @uTys@ if it turns out that the variable is already bound.

\begin{code}
<pre><a name="line-1"></a><a name="uVar"></a><span class='hs-definition'>uVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EqOrigin</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SwapFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTauType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-2"></a><span class='hs-definition'>uVar</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>swapped</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"uVar"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>origin</span>
<a name="line-4"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>swapped</span>
<a name="line-5"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv1</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span>
<a name="line-6"></a>                       		<span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>" ~ "</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-7"></a>                       		<span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-8"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>details</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupTcTyVar</span> <span class='hs-varid'>tv1</span>
<a name="line-9"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>details</span> <span class='hs-keyword'>of</span>
<a name="line-10"></a>            <span class='hs-conid'>Filled</span> <span class='hs-varid'>ty1</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unSwap</span> <span class='hs-varid'>swapped</span> <span class='hs-layout'>(</span><span class='hs-varid'>uType_np</span> <span class='hs-varid'>origin</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-11"></a>            <span class='hs-conid'>Unfilled</span> <span class='hs-varid'>details1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>uUnfilledVar</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>swapped</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>details1</span> <span class='hs-varid'>ty2</span>
<a name="line-12"></a>        <span class='hs-layout'>}</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="uUnfilledVar"></a><span class='hs-comment'>----------------</span>
<a name="line-15"></a><span class='hs-definition'>uUnfilledVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EqOrigin</span><span class='hs-keyglyph'>]</span>
<a name="line-16"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SwapFlag</span>
<a name="line-17"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVarDetails</span>       <span class='hs-comment'>-- Tyvar 1</span>
<a name="line-18"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTauType</span>  			<span class='hs-comment'>-- Type 2</span>
<a name="line-19"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-20"></a><span class='hs-comment'>-- "Unfilled" means that the variable is definitely not a filled-in meta tyvar</span>
<a name="line-21"></a><span class='hs-comment'>--            It might be a skolem, or untouchable, or meta</span>
<a name="line-22"></a>
<a name="line-23"></a><span class='hs-definition'>uUnfilledVar</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>swapped</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>details1</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv2</span><span class='hs-layout'>)</span>
<a name="line-24"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tv1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tv2</span>  <span class='hs-comment'>-- Same type variable =&gt; no-op</span>
<a name="line-25"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcReflCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-26"></a>
<a name="line-27"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-comment'>-- Distinct type variables</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>lookup2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupTcTyVar</span> <span class='hs-varid'>tv2</span>
<a name="line-29"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookup2</span> <span class='hs-keyword'>of</span>
<a name="line-30"></a>            <span class='hs-conid'>Filled</span> <span class='hs-varid'>ty2'</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>uUnfilledVar</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>swapped</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>details1</span> <span class='hs-varid'>ty2'</span> 
<a name="line-31"></a>            <span class='hs-conid'>Unfilled</span> <span class='hs-varid'>details2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>uUnfilledVars</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>swapped</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>details1</span> <span class='hs-varid'>tv2</span> <span class='hs-varid'>details2</span>
<a name="line-32"></a>        <span class='hs-layout'>}</span>
<a name="line-33"></a>
<a name="line-34"></a><span class='hs-definition'>uUnfilledVar</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>swapped</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>details1</span> <span class='hs-varid'>non_var_ty2</span>  <span class='hs-comment'>-- ty2 is not a type variable</span>
<a name="line-35"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>details1</span> <span class='hs-keyword'>of</span>
<a name="line-36"></a>      <span class='hs-conid'>MetaTv</span> <span class='hs-conid'>TauTv</span> <span class='hs-varid'>ref1</span> 
<a name="line-37"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_ty2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkTauTvUpdate</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>non_var_ty2</span>
<a name="line-38"></a>              <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_ty2'</span> <span class='hs-keyword'>of</span>
<a name="line-39"></a>                  <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Occ/kind defer"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span><span class='hs-layout'>;</span> <span class='hs-varid'>defer</span> <span class='hs-layout'>}</span>
<a name="line-40"></a>                  <span class='hs-conid'>Just</span> <span class='hs-varid'>ty2'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>updateMeta</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ref1</span> <span class='hs-varid'>ty2'</span>
<a name="line-41"></a>              <span class='hs-layout'>}</span>
<a name="line-42"></a>
<a name="line-43"></a>      <span class='hs-sel'>_other</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Skolem defer"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span><span class='hs-layout'>;</span> <span class='hs-varid'>defer</span> <span class='hs-layout'>}</span>	<span class='hs-comment'>-- Skolems of all sorts</span>
<a name="line-44"></a>  <span class='hs-keyword'>where</span>
<a name="line-45"></a>    <span class='hs-varid'>defer</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>non_var_ty2</span>	<span class='hs-comment'>-- Note [Avoid deferring]</span>
<a name="line-46"></a>    	    	         	   		<span class='hs-comment'>-- non_var_ty2 isn't expanded yet</span>
<a name="line-47"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uUnfilledVar</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>swapped</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>details1</span> <span class='hs-varid'>ty2'</span>
<a name="line-48"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-49"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unSwap</span> <span class='hs-varid'>swapped</span> <span class='hs-layout'>(</span><span class='hs-varid'>uType_defer</span> <span class='hs-varid'>origin</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span> <span class='hs-varid'>non_var_ty2</span>
<a name="line-50"></a>          <span class='hs-comment'>-- Occurs check or an untouchable: just defer</span>
<a name="line-51"></a>	  <span class='hs-comment'>-- NB: occurs check isn't necessarily fatal: </span>
<a name="line-52"></a>	  <span class='hs-comment'>--     eg tv1 occured in type family parameter</span>
<a name="line-53"></a>
<a name="line-54"></a><a name="uUnfilledVars"></a><span class='hs-comment'>----------------</span>
<a name="line-55"></a><span class='hs-definition'>uUnfilledVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EqOrigin</span><span class='hs-keyglyph'>]</span>
<a name="line-56"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SwapFlag</span>
<a name="line-57"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVarDetails</span>      <span class='hs-comment'>-- Tyvar 1</span>
<a name="line-58"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVarDetails</span>      <span class='hs-comment'>-- Tyvar 2</span>
<a name="line-59"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-60"></a><span class='hs-comment'>-- Invarant: The type variables are distinct,</span>
<a name="line-61"></a><span class='hs-comment'>--           Neither is filled in yet</span>
<a name="line-62"></a>
<a name="line-63"></a><span class='hs-definition'>uUnfilledVars</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>swapped</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>details1</span> <span class='hs-varid'>tv2</span> <span class='hs-varid'>details2</span>
<a name="line-64"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"uUnfilledVars"</span> <span class='hs-layout'>(</span>    <span class='hs-varid'>text</span> <span class='hs-str'>"trying to unify"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>k1</span>
<a name="line-65"></a>                                  <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"with"</span>            <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>k2</span><span class='hs-layout'>)</span>
<a name="line-66"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkKindErrorCtxt</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>k1</span> <span class='hs-varid'>k2</span>
<a name="line-67"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>sub_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addErrCtxtM</span> <span class='hs-varid'>ctxt</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unifyKind</span> <span class='hs-varid'>k1</span> <span class='hs-varid'>k2</span>
<a name="line-68"></a>
<a name="line-69"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>sub_kind</span><span class='hs-layout'>,</span> <span class='hs-varid'>details1</span><span class='hs-layout'>,</span> <span class='hs-varid'>details2</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-70"></a>           <span class='hs-comment'>-- k1 &lt; k2, so update tv2</span>
<a name="line-71"></a>           <span class='hs-layout'>(</span><span class='hs-conid'>LT</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>MetaTv</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ref2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>updateMeta</span> <span class='hs-varid'>tv2</span> <span class='hs-varid'>ref2</span> <span class='hs-varid'>ty1</span>
<a name="line-72"></a>
<a name="line-73"></a>           <span class='hs-comment'>-- k2 &lt; k1, so update tv1</span>
<a name="line-74"></a>           <span class='hs-layout'>(</span><span class='hs-conid'>GT</span><span class='hs-layout'>,</span> <span class='hs-conid'>MetaTv</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ref1</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>updateMeta</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ref1</span> <span class='hs-varid'>ty2</span>
<a name="line-75"></a>
<a name="line-76"></a>	   <span class='hs-comment'>-- k1 = k2, so we are free to update either way</span>
<a name="line-77"></a>           <span class='hs-layout'>(</span><span class='hs-conid'>EQ</span><span class='hs-layout'>,</span> <span class='hs-conid'>MetaTv</span> <span class='hs-varid'>i1</span> <span class='hs-varid'>ref1</span><span class='hs-layout'>,</span> <span class='hs-conid'>MetaTv</span> <span class='hs-varid'>i2</span> <span class='hs-varid'>ref2</span><span class='hs-layout'>)</span>
<a name="line-78"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>nicer_to_update_tv1</span> <span class='hs-varid'>i1</span> <span class='hs-varid'>i2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>updateMeta</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ref1</span> <span class='hs-varid'>ty2</span>
<a name="line-79"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>updateMeta</span> <span class='hs-varid'>tv2</span> <span class='hs-varid'>ref2</span> <span class='hs-varid'>ty1</span>
<a name="line-80"></a>           <span class='hs-layout'>(</span><span class='hs-conid'>EQ</span><span class='hs-layout'>,</span> <span class='hs-conid'>MetaTv</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ref1</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>updateMeta</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ref1</span> <span class='hs-varid'>ty2</span>
<a name="line-81"></a>           <span class='hs-layout'>(</span><span class='hs-conid'>EQ</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>MetaTv</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ref2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>updateMeta</span> <span class='hs-varid'>tv2</span> <span class='hs-varid'>ref2</span> <span class='hs-varid'>ty1</span>
<a name="line-82"></a>
<a name="line-83"></a>	   <span class='hs-comment'>-- Can't do it in-place, so defer</span>
<a name="line-84"></a>	   <span class='hs-comment'>-- This happens for skolems of all sorts</span>
<a name="line-85"></a>           <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unSwap</span> <span class='hs-varid'>swapped</span> <span class='hs-layout'>(</span><span class='hs-varid'>uType_defer</span> <span class='hs-varid'>origin</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-layout'>}</span> 
<a name="line-86"></a>  <span class='hs-keyword'>where</span>
<a name="line-87"></a>    <span class='hs-varid'>k1</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv1</span>
<a name="line-88"></a>    <span class='hs-varid'>k2</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv2</span>
<a name="line-89"></a>    <span class='hs-varid'>ty1</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv1</span>
<a name="line-90"></a>    <span class='hs-varid'>ty2</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv2</span>
<a name="line-91"></a>
<a name="line-92"></a>    <span class='hs-varid'>nicer_to_update_tv1</span> <span class='hs-keyword'>_</span>     <span class='hs-conid'>SigTv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-93"></a>    <span class='hs-varid'>nicer_to_update_tv1</span> <span class='hs-conid'>SigTv</span> <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-94"></a>    <span class='hs-varid'>nicer_to_update_tv1</span> <span class='hs-keyword'>_</span>         <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isSystemName</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>varName</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span>
<a name="line-95"></a>        <span class='hs-comment'>-- Try not to update SigTvs; and try to update sys-y type</span>
<a name="line-96"></a>        <span class='hs-comment'>-- variables in preference to ones gotten (say) by</span>
<a name="line-97"></a>        <span class='hs-comment'>-- instantiating a polymorphic function with a user-written</span>
<a name="line-98"></a>        <span class='hs-comment'>-- type sig</span>
<a name="line-99"></a>
<a name="line-100"></a><a name="checkTauTvUpdate"></a><span class='hs-comment'>----------------</span>
<a name="line-101"></a><span class='hs-definition'>checkTauTvUpdate</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>
<a name="line-102"></a><span class='hs-comment'>--    (checkTauTvUpdate tv ty)</span>
<a name="line-103"></a><span class='hs-comment'>-- We are about to update the TauTv tv with ty.</span>
<a name="line-104"></a><span class='hs-comment'>-- Check (a) that tv doesn't occur in ty (occurs check)</span>
<a name="line-105"></a><span class='hs-comment'>--       (b) that kind(ty) is a sub-kind of kind(tv)</span>
<a name="line-106"></a><span class='hs-comment'>--       (c) that ty does not contain any type families, see Note [Type family sharing]</span>
<a name="line-107"></a><span class='hs-comment'>-- </span>
<a name="line-108"></a><span class='hs-comment'>-- We have two possible outcomes:</span>
<a name="line-109"></a><span class='hs-comment'>-- (1) Return the type to update the type variable with, </span>
<a name="line-110"></a><span class='hs-comment'>--        [we know the update is ok]</span>
<a name="line-111"></a><span class='hs-comment'>-- (2) Return Nothing,</span>
<a name="line-112"></a><span class='hs-comment'>--        [the update might be dodgy]</span>
<a name="line-113"></a><span class='hs-comment'>--</span>
<a name="line-114"></a><span class='hs-comment'>-- Note that "Nothing" does not mean "definite error".  For example</span>
<a name="line-115"></a><span class='hs-comment'>--   type family F a</span>
<a name="line-116"></a><span class='hs-comment'>--   type instance F Int = Int</span>
<a name="line-117"></a><span class='hs-comment'>-- consider</span>
<a name="line-118"></a><span class='hs-comment'>--   a ~ F a</span>
<a name="line-119"></a><span class='hs-comment'>-- This is perfectly reasonable, if we later get a ~ Int.  For now, though,</span>
<a name="line-120"></a><span class='hs-comment'>-- we return Nothing, leaving it to the later constraint simplifier to</span>
<a name="line-121"></a><span class='hs-comment'>-- sort matters out.</span>
<a name="line-122"></a>
<a name="line-123"></a><span class='hs-definition'>checkTauTvUpdate</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span>
<a name="line-124"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>ty</span>
<a name="line-125"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>k2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty'</span>
<a name="line-126"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>k1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-127"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkKindErrorCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>k1</span> <span class='hs-varid'>k2</span>
<a name="line-128"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>sub_k</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addErrCtxtM</span> <span class='hs-varid'>ctxt</span> <span class='hs-varop'>$</span>
<a name="line-129"></a>                  <span class='hs-varid'>unifyKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span>
<a name="line-130"></a>
<a name="line-131"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>sub_k</span> <span class='hs-keyword'>of</span>
<a name="line-132"></a>           <span class='hs-conid'>LT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-133"></a>           <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ok</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-134"></a>  <span class='hs-keyword'>where</span> 
<a name="line-135"></a>    <span class='hs-varid'>ok</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TcType</span> 
<a name="line-136"></a>    <span class='hs-comment'>-- Checks that tv does not occur in the arg type</span>
<a name="line-137"></a>    <span class='hs-comment'>-- expanding type synonyms where necessary to make this so</span>
<a name="line-138"></a>    <span class='hs-comment'>-- eg type Phantom a = Bool</span>
<a name="line-139"></a>    <span class='hs-comment'>--     ok (tv -&gt; Int)         = Nothing</span>
<a name="line-140"></a>    <span class='hs-comment'>--     ok (x -&gt; Int)          = Just (x -&gt; Int)</span>
<a name="line-141"></a>    <span class='hs-comment'>--     ok (Phantom tv -&gt; Int) = Just (Bool -&gt; Int)</span>
<a name="line-142"></a>    <span class='hs-varid'>ok</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> 
<a name="line-143"></a>    <span class='hs-varid'>ok</span> <span class='hs-varid'>this_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> 
<a name="line-144"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isSynFamilyTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>allMaybes</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ok</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> 
<a name="line-145"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span> 
<a name="line-146"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isSynTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty_expanded</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>this_ty</span>
<a name="line-147"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ok</span> <span class='hs-varid'>ty_expanded</span> <span class='hs-comment'>-- See Note [Type synonyms and the occur check] </span>
<a name="line-148"></a>    <span class='hs-varid'>ok</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>arg'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ok</span> <span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>res'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ok</span> <span class='hs-varid'>res</span>
<a name="line-149"></a>                       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg'</span> <span class='hs-varid'>res'</span><span class='hs-layout'>)</span> 
<a name="line-150"></a>    <span class='hs-varid'>ok</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>fun'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ok</span> <span class='hs-varid'>fun</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>arg'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ok</span> <span class='hs-varid'>arg</span> 
<a name="line-151"></a>                       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun'</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>)</span> 
<a name="line-152"></a>    <span class='hs-varid'>ok</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ok</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty1'</span><span class='hs-layout'>)</span> 
<a name="line-153"></a>    <span class='hs-comment'>-- Fall-through </span>
<a name="line-154"></a>    <span class='hs-varid'>ok</span> <span class='hs-sel'>_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span> 
</pre>\end{code}

Note [Avoid deferring]
~~~~~~~~~~~~~~~~~~~~~~
We try to avoid creating deferred constraints for two reasons.  
  * First, efficiency.  
  * Second, currently we can only defer some constraints 
    under a forall.  See unifySigmaTy.
So expanding synonyms here is a good thing to do.  Example (Trac #4917)
       a ~ Const a b
where type Const a b = a.  We can solve this immediately, even when
'a' is a skolem, just by expanding the synonym; and we should do so
 in case this unification happens inside unifySigmaTy (sigh).

Note [Type synonyms and the occur check]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Generally speaking we try to update a variable with type synonyms not
expanded, which improves later error messages, unless looking
inside a type synonym may help resolve a spurious occurs check
error. Consider:
          type A a = ()

          f :: (A a -> a -> ()) -> ()
          f = \ _ -> ()

          x :: ()
          x = f (\ x p -> p x)

We will eventually get a constraint of the form t ~ A t. The ok function above will 
properly expand the type (A t) to just (), which is ok to be unified with t. If we had
unified with the original type A t, we would lead the type checker into an infinite loop. 

Hence, if the occurs check fails for a type synonym application, then (and *only* then), 
the ok function expands the synonym to detect opportunities for occurs check success using
the underlying definition of the type synonym. 

The same applies later on in the constraint interaction code; see TcInteract, 
function @occ_check_ok@. 


Note [Type family sharing]
~~~~~~~~~~~~~~ 
We must avoid eagerly unifying type variables to types that contain function symbols, 
because this may lead to loss of sharing, and in turn, in very poor performance of the
constraint simplifier. Assume that we have a wanted constraint: 
{ 
  m1 ~ [F m2], 
  m2 ~ [F m3], 
  m3 ~ [F m4], 
  D m1, 
  D m2, 
  D m3 
} 
where D is some type class. If we eagerly unify m1 := [F m2], m2 := [F m3], m3 := [F m2], 
then, after zonking, our constraint simplifier will be faced with the following wanted 
constraint: 
{ 
  D [F [F [F m4]]], 
  D [F [F m4]], 
  D [F m4] 
} 
which has to be flattened by the constraint solver. However, because the sharing is lost, 
an polynomially larger number of flatten skolems will be created and the constraint sets 
we are working with will be polynomially larger. 

Instead, if we defer the unifications m1 := [F m2], etc. we will only be generating three 
flatten skolems, which is the maximum possible sharing arising from the original constraint. 

\begin{code}
<pre><a name="line-1"></a><a name="LookupTyVarResult"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>LookupTyVarResult</span>	<span class='hs-comment'>-- The result of a lookupTcTyVar call</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Unfilled</span> <span class='hs-conid'>TcTyVarDetails</span>	<span class='hs-comment'>-- SkolemTv or virgin MetaTv</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Filled</span>   <span class='hs-conid'>TcType</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="lookupTcTyVar"></a><span class='hs-definition'>lookupTcTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>LookupTyVarResult</span>
<a name="line-6"></a><span class='hs-definition'>lookupTcTyVar</span> <span class='hs-varid'>tyvar</span> 
<a name="line-7"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>MetaTv</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>details</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>meta_details</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMutVar</span> <span class='hs-varid'>ref</span>
<a name="line-9"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>meta_details</span> <span class='hs-keyword'>of</span>
<a name="line-10"></a>           <span class='hs-conid'>Indirect</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Filled</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-11"></a>           <span class='hs-conid'>Flexi</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is_untch</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isUntouchable</span> <span class='hs-varid'>tyvar</span>
<a name="line-12"></a>                       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span>    <span class='hs-comment'>-- Note [Unifying untouchables]</span>
<a name="line-13"></a>                             <span class='hs-varid'>ret_details</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_untch</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vanillaSkolemTv</span>
<a name="line-14"></a>                                         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>details</span>
<a name="line-15"></a>       	               <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Unfilled</span> <span class='hs-varid'>ret_details</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Unfilled</span> <span class='hs-varid'>details</span><span class='hs-layout'>)</span>
<a name="line-18"></a>  <span class='hs-keyword'>where</span>
<a name="line-19"></a>    <span class='hs-varid'>details</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tyvar</span> <span class='hs-layout'>)</span>
<a name="line-20"></a>              <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tyvar</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="updateMeta"></a><span class='hs-definition'>updateMeta</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>MetaDetails</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-23"></a><span class='hs-definition'>updateMeta</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ref1</span> <span class='hs-varid'>ty2</span>
<a name="line-24"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>writeMetaTyVarRef</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ref1</span> <span class='hs-varid'>ty2</span>
<a name="line-25"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcReflCo</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}

Note [Unifying untouchables]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We treat an untouchable type variable as if it was a skolem.  That
ensures it won't unify with anything.  It's a slight had, because
we return a made-up TcTyVarDetails, but I think it works smoothly.


%************************************************************************
%*                                                                      *
        Errors and contexts
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="pushOrigin"></a><span class='hs-definition'>pushOrigin</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EqOrigin</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EqOrigin</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-definition'>pushOrigin</span> <span class='hs-varid'>ty_act</span> <span class='hs-varid'>ty_exp</span> <span class='hs-varid'>origin</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnifyOrigin</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uo_actual</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_act</span><span class='hs-layout'>,</span> <span class='hs-varid'>uo_expected</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_exp</span> <span class='hs-layout'>}</span> <span class='hs-conop'>:</span> <span class='hs-varid'>origin</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="wrapEqCtxt"></a><span class='hs-comment'>---------------</span>
<a name="line-6"></a><span class='hs-definition'>wrapEqCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EqOrigin</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-7"></a><span class='hs-comment'>-- Build a suitable error context from the origin and do the thing inside</span>
<a name="line-8"></a><span class='hs-comment'>-- The "couldn't match" error comes from the innermost item on the stack,</span>
<a name="line-9"></a><span class='hs-comment'>-- and, if there is more than one item, the "Expected/inferred" part</span>
<a name="line-10"></a><span class='hs-comment'>-- comes from the outermost item</span>
<a name="line-11"></a><span class='hs-definition'>wrapEqCtxt</span> <span class='hs-conid'>[]</span>    <span class='hs-varid'>thing_inside</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>thing_inside</span>
<a name="line-12"></a><span class='hs-definition'>wrapEqCtxt</span> <span class='hs-varid'>items</span> <span class='hs-varid'>thing_inside</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxtM</span> <span class='hs-layout'>(</span><span class='hs-varid'>unifyCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>last</span> <span class='hs-varid'>items</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="failWithMisMatch"></a><span class='hs-comment'>---------------</span>
<a name="line-15"></a><span class='hs-definition'>failWithMisMatch</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EqOrigin</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-16"></a><span class='hs-comment'>-- Generate the message when two types fail to match,</span>
<a name="line-17"></a><span class='hs-comment'>-- going to some trouble to make it helpful.</span>
<a name="line-18"></a><span class='hs-comment'>-- We take the failing types from the top of the origin stack</span>
<a name="line-19"></a><span class='hs-comment'>-- rather than reporting the particular ones we are looking </span>
<a name="line-20"></a><span class='hs-comment'>-- at right now</span>
<a name="line-21"></a><span class='hs-definition'>failWithMisMatch</span> <span class='hs-layout'>(</span><span class='hs-varid'>item</span><span class='hs-conop'>:</span><span class='hs-varid'>origin</span><span class='hs-layout'>)</span>
<a name="line-22"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapEqCtxt</span> <span class='hs-varid'>origin</span> <span class='hs-varop'>$</span>
<a name="line-23"></a>    <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>ty_act</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-layout'>(</span><span class='hs-varid'>uo_actual</span> <span class='hs-varid'>item</span><span class='hs-layout'>)</span>
<a name="line-24"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>ty_exp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-layout'>(</span><span class='hs-varid'>uo_expected</span> <span class='hs-varid'>item</span><span class='hs-layout'>)</span>
<a name="line-25"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>env0</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInitTidyEnv</span>
<a name="line-26"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>pp_exp</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenType</span> <span class='hs-varid'>env0</span> <span class='hs-varid'>ty_exp</span>
<a name="line-27"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>pp_act</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenType</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>ty_act</span>
<a name="line-28"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>failWithTcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>misMatchMsg</span> <span class='hs-varid'>pp_act</span> <span class='hs-varid'>pp_exp</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-29"></a><span class='hs-definition'>failWithMisMatch</span> <span class='hs-conid'>[]</span> 
<a name="line-30"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"failWithMisMatch"</span>
<a name="line-31"></a>
<a name="line-32"></a><a name="misMatchMsg"></a><span class='hs-definition'>misMatchMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-33"></a><span class='hs-definition'>misMatchMsg</span> <span class='hs-varid'>ty_act</span> <span class='hs-varid'>ty_exp</span>
<a name="line-34"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Couldn't match expected type"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty_exp</span><span class='hs-layout'>)</span>
<a name="line-35"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>12</span> <span class='hs-varop'>$</span>   <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"with actual type"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty_act</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
</pre>\end{code}


-----------------------------------------
	UNUSED FOR NOW
-----------------------------------------

----------------
----------------
-- If an error happens we try to figure out whether the function
-- function has been given too many or too few arguments, and say so.
addSubCtxt :: InstOrigin -> TcType -> TcType -> TcM a -> TcM a
addSubCtxt orig actual_res_ty expected_res_ty thing_inside
  = addErrCtxtM mk_err thing_inside
  where
    mk_err tidy_env
      = do { exp_ty' <- zonkTcType expected_res_ty
           ; act_ty' <- zonkTcType actual_res_ty
           ; let (env1, exp_ty'') = tidyOpenType tidy_env exp_ty'
                 (env2, act_ty'') = tidyOpenType env1     act_ty'
                 (exp_args, _)    = tcSplitFunTys exp_ty''
                 (act_args, _)    = tcSplitFunTys act_ty''

                 len_act_args     = length act_args
                 len_exp_args     = length exp_args

                 message = case orig of
                             OccurrenceOf fun
                                  | len_exp_args < len_act_args -> wrongArgsCtxt "too few"  fun
                                  | len_exp_args > len_act_args -> wrongArgsCtxt "too many" fun
                             _ -> mkExpectedActualMsg act_ty'' exp_ty''
           ; return (env2, message) }


%************************************************************************
%*                                                                      *
                Kind unification
%*                                                                      *
%************************************************************************

Unifying kinds is much, much simpler than unifying types.

One small wrinkle is that as far as the user is concerned, types of kind
Constraint should only be allowed to occur where we expect *exactly* that kind.
We SHOULD NOT allow a type of kind fact to appear in a position expecting
one of argTypeKind or openTypeKind.

The situation is different in the core of the compiler, where we are perfectly
happy to have types of kind Constraint on either end of an arrow.

\begin{code}
<pre><a name="line-1"></a><a name="matchExpectedFunKind"></a><span class='hs-definition'>matchExpectedFunKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcKind</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-comment'>-- Like unifyFunTy, but does not fail; instead just returns Nothing</span>
<a name="line-3"></a>
<a name="line-4"></a><span class='hs-definition'>matchExpectedFunKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>kvar</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-5"></a>    <span class='hs-varid'>maybe_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMetaTyVar</span> <span class='hs-varid'>kvar</span>
<a name="line-6"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>maybe_kind</span> <span class='hs-keyword'>of</span>
<a name="line-7"></a>      <span class='hs-conid'>Indirect</span> <span class='hs-varid'>fun_kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>matchExpectedFunKind</span> <span class='hs-varid'>fun_kind</span>
<a name="line-8"></a>      <span class='hs-conid'>Flexi</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-9"></a>          <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>arg_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-10"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>res_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-11"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>writeMetaTyVar</span> <span class='hs-varid'>kvar</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkArrowKind</span> <span class='hs-varid'>arg_kind</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span>
<a name="line-12"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_kind</span><span class='hs-layout'>,</span><span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-13"></a>
<a name="line-14"></a><span class='hs-definition'>matchExpectedFunKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg_kind</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_kind</span><span class='hs-layout'>,</span><span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-15"></a><span class='hs-definition'>matchExpectedFunKind</span> <span class='hs-keyword'>_</span>                         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="unifyKind"></a><span class='hs-comment'>-----------------  </span>
<a name="line-18"></a><span class='hs-definition'>unifyKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcKind</span>           <span class='hs-comment'>-- k1 (actual)</span>
<a name="line-19"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span>           <span class='hs-comment'>-- k2 (expected)</span>
<a name="line-20"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Ordering</span>     <span class='hs-comment'>-- Returns the relation between the kinds</span>
<a name="line-21"></a>                              <span class='hs-comment'>-- LT &lt;=&gt; k1 is a sub-kind of k2</span>
<a name="line-22"></a>
<a name="line-23"></a><span class='hs-definition'>unifyKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>kv1</span><span class='hs-layout'>)</span> <span class='hs-varid'>k2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uKVar</span> <span class='hs-conid'>False</span> <span class='hs-varid'>kv1</span> <span class='hs-varid'>k2</span>
<a name="line-24"></a><span class='hs-definition'>unifyKind</span> <span class='hs-varid'>k1</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>kv2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uKVar</span> <span class='hs-conid'>True</span>  <span class='hs-varid'>kv2</span> <span class='hs-varid'>k1</span>
<a name="line-25"></a>
<a name="line-26"></a><span class='hs-definition'>unifyKind</span> <span class='hs-varid'>k1</span> <span class='hs-varid'>k2</span>       <span class='hs-comment'>-- See Note [Expanding synonyms during unification]</span>
<a name="line-27"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>k1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>k1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unifyKind</span> <span class='hs-varid'>k1'</span> <span class='hs-varid'>k2</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>k2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>k2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unifyKind</span> <span class='hs-varid'>k1</span>  <span class='hs-varid'>k2'</span>
<a name="line-29"></a>
<a name="line-30"></a><span class='hs-definition'>unifyKind</span> <span class='hs-varid'>k1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>kc1</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-varid'>k2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>kc2</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-31"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>kc1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>kc2</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>EQ</span>
<a name="line-32"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>kc1</span> <span class='hs-varop'>`tcIsSubKindCon`</span> <span class='hs-varid'>kc2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>LT</span>
<a name="line-33"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>kc2</span> <span class='hs-varop'>`tcIsSubKindCon`</span> <span class='hs-varid'>kc1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>GT</span>
<a name="line-34"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unifyKindMisMatch</span> <span class='hs-varid'>k1</span> <span class='hs-varid'>k2</span>
<a name="line-35"></a>
<a name="line-36"></a><span class='hs-definition'>unifyKind</span> <span class='hs-varid'>k1</span> <span class='hs-varid'>k2</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unifyKindEq</span> <span class='hs-varid'>k1</span> <span class='hs-varid'>k2</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>EQ</span> <span class='hs-layout'>}</span>
<a name="line-37"></a>  <span class='hs-comment'>-- In all other cases, let unifyKindEq do the work</span>
<a name="line-38"></a>
<a name="line-39"></a><a name="uKVar"></a><span class='hs-definition'>uKVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MetaKindVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Ordering</span>
<a name="line-40"></a><span class='hs-definition'>uKVar</span> <span class='hs-varid'>isFlipped</span> <span class='hs-varid'>kv1</span> <span class='hs-varid'>k2</span>
<a name="line-41"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>kv1</span>
<a name="line-42"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>mb_k1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMetaTyVar</span> <span class='hs-varid'>kv1</span>
<a name="line-43"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_k1</span> <span class='hs-keyword'>of</span>
<a name="line-44"></a>            <span class='hs-conid'>Flexi</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>uUnboundKVar</span> <span class='hs-varid'>kv1</span> <span class='hs-varid'>k2</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>EQ</span>
<a name="line-45"></a>            <span class='hs-conid'>Indirect</span> <span class='hs-varid'>k1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unifyKind</span> <span class='hs-varid'>k1</span> <span class='hs-varid'>k2</span> <span class='hs-layout'>}</span>
<a name="line-46"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>kv2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>k2</span><span class='hs-layout'>,</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>kv2</span>
<a name="line-47"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uKVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varid'>isFlipped</span><span class='hs-layout'>)</span> <span class='hs-varid'>kv2</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>kv1</span><span class='hs-layout'>)</span>
<a name="line-48"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>kv2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>k2</span><span class='hs-layout'>,</span> <span class='hs-varid'>kv1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>kv2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>EQ</span>
<a name="line-49"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isFlipped</span> 
<a name="line-50"></a>                <span class='hs-keyword'>then</span> <span class='hs-varid'>unifyKindMisMatch</span> <span class='hs-varid'>k2</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>kv1</span><span class='hs-layout'>)</span>
<a name="line-51"></a>                <span class='hs-keyword'>else</span> <span class='hs-varid'>unifyKindMisMatch</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>kv1</span><span class='hs-layout'>)</span> <span class='hs-varid'>k2</span>
<a name="line-52"></a>
<a name="line-53"></a><a name="unifyKindEq"></a><span class='hs-comment'>---------------------------</span>
<a name="line-54"></a><span class='hs-definition'>unifyKindEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-55"></a><span class='hs-definition'>unifyKindEq</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>kv1</span><span class='hs-layout'>)</span> <span class='hs-varid'>k2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uKVarEq</span> <span class='hs-conid'>False</span> <span class='hs-varid'>kv1</span> <span class='hs-varid'>k2</span>
<a name="line-56"></a><span class='hs-definition'>unifyKindEq</span> <span class='hs-varid'>k1</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>kv2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uKVarEq</span> <span class='hs-conid'>True</span>  <span class='hs-varid'>kv2</span> <span class='hs-varid'>k1</span>
<a name="line-57"></a>
<a name="line-58"></a><span class='hs-definition'>unifyKindEq</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>a1</span> <span class='hs-varid'>r1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>a2</span> <span class='hs-varid'>r2</span><span class='hs-layout'>)</span>
<a name="line-59"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unifyKindEq</span> <span class='hs-varid'>a1</span> <span class='hs-varid'>a2</span><span class='hs-layout'>;</span> <span class='hs-varid'>unifyKindEq</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>r2</span> <span class='hs-layout'>}</span>
<a name="line-60"></a>  
<a name="line-61"></a><span class='hs-definition'>unifyKindEq</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>kc1</span> <span class='hs-varid'>k1s</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>kc2</span> <span class='hs-varid'>k2s</span><span class='hs-layout'>)</span>
<a name="line-62"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>kc1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>kc2</span>
<a name="line-63"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>k1s</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>k2s</span><span class='hs-layout'>)</span>
<a name="line-64"></a>       <span class='hs-comment'>-- Should succeed since the kind constructors are the same, </span>
<a name="line-65"></a>       <span class='hs-comment'>-- and the kinds are sort-checked, thus fully applied</span>
<a name="line-66"></a>    <span class='hs-varid'>zipWithM_</span> <span class='hs-varid'>unifyKindEq</span> <span class='hs-varid'>k1s</span> <span class='hs-varid'>k2s</span>
<a name="line-67"></a>
<a name="line-68"></a><span class='hs-definition'>unifyKindEq</span> <span class='hs-varid'>k1</span> <span class='hs-varid'>k2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unifyKindMisMatch</span> <span class='hs-varid'>k1</span> <span class='hs-varid'>k2</span>
<a name="line-69"></a>
<a name="line-70"></a><a name="uKVarEq"></a><span class='hs-comment'>----------------</span>
<a name="line-71"></a><span class='hs-comment'>-- For better error messages, we record whether we've flipped the kinds</span>
<a name="line-72"></a><span class='hs-comment'>-- during the process.</span>
<a name="line-73"></a><span class='hs-definition'>uKVarEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MetaKindVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-74"></a><span class='hs-definition'>uKVarEq</span> <span class='hs-varid'>isFlipped</span> <span class='hs-varid'>kv1</span> <span class='hs-varid'>k2</span>
<a name="line-75"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>kv1</span>
<a name="line-76"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>mb_k1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMetaTyVar</span> <span class='hs-varid'>kv1</span>
<a name="line-77"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_k1</span> <span class='hs-keyword'>of</span>
<a name="line-78"></a>            <span class='hs-conid'>Flexi</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>uUnboundKVar</span> <span class='hs-varid'>kv1</span> <span class='hs-varid'>k2</span>
<a name="line-79"></a>            <span class='hs-conid'>Indirect</span> <span class='hs-varid'>k1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unifyKindEq</span> <span class='hs-varid'>k1</span> <span class='hs-varid'>k2</span> <span class='hs-layout'>}</span>
<a name="line-80"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>kv2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>k2</span><span class='hs-layout'>,</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>kv2</span>
<a name="line-81"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uKVarEq</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varid'>isFlipped</span><span class='hs-layout'>)</span> <span class='hs-varid'>kv2</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>kv1</span><span class='hs-layout'>)</span>
<a name="line-82"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>kv2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>k2</span><span class='hs-layout'>,</span> <span class='hs-varid'>kv1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>kv2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-83"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isFlipped</span> 
<a name="line-84"></a>                <span class='hs-keyword'>then</span> <span class='hs-varid'>unifyKindMisMatch</span> <span class='hs-varid'>k2</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>kv1</span><span class='hs-layout'>)</span>
<a name="line-85"></a>                <span class='hs-keyword'>else</span> <span class='hs-varid'>unifyKindMisMatch</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>kv1</span><span class='hs-layout'>)</span> <span class='hs-varid'>k2</span>
<a name="line-86"></a>
<a name="line-87"></a><a name="uUnboundKVar"></a><span class='hs-comment'>----------------</span>
<a name="line-88"></a><span class='hs-definition'>uUnboundKVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MetaKindVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-89"></a><span class='hs-definition'>uUnboundKVar</span> <span class='hs-varid'>kv1</span> <span class='hs-varid'>k2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>kv2</span><span class='hs-layout'>)</span>
<a name="line-90"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>kv1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>kv2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-91"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>kv2</span>   <span class='hs-comment'>-- Distinct kind variables</span>
<a name="line-92"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>mb_k2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMetaTyVar</span> <span class='hs-varid'>kv2</span>
<a name="line-93"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_k2</span> <span class='hs-keyword'>of</span>
<a name="line-94"></a>            <span class='hs-conid'>Indirect</span> <span class='hs-varid'>k2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>uUnboundKVar</span> <span class='hs-varid'>kv1</span> <span class='hs-varid'>k2</span>
<a name="line-95"></a>            <span class='hs-conid'>Flexi</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>writeMetaTyVar</span> <span class='hs-varid'>kv1</span> <span class='hs-varid'>k2</span> <span class='hs-layout'>}</span>
<a name="line-96"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>writeMetaTyVar</span> <span class='hs-varid'>kv1</span> <span class='hs-varid'>k2</span>
<a name="line-97"></a>
<a name="line-98"></a><span class='hs-definition'>uUnboundKVar</span> <span class='hs-varid'>kv1</span> <span class='hs-varid'>non_var_k2</span>
<a name="line-99"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>k2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-varid'>non_var_k2</span>
<a name="line-100"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>kindOccurCheck</span> <span class='hs-varid'>kv1</span> <span class='hs-varid'>k2'</span>
<a name="line-101"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>k2''</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kindSimpleKind</span> <span class='hs-varid'>k2'</span>
<a name="line-102"></a>                <span class='hs-comment'>-- MetaKindVars must be bound only to simple kinds</span>
<a name="line-103"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>writeMetaTyVar</span> <span class='hs-varid'>kv1</span> <span class='hs-varid'>k2''</span> <span class='hs-layout'>}</span>
<a name="line-104"></a>
<a name="line-105"></a><a name="kindOccurCheck"></a><span class='hs-comment'>----------------</span>
<a name="line-106"></a><span class='hs-definition'>kindOccurCheck</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-107"></a><span class='hs-definition'>kindOccurCheck</span> <span class='hs-varid'>kv1</span> <span class='hs-varid'>k2</span>   <span class='hs-comment'>-- k2 is zonked</span>
<a name="line-108"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>elemVarSet</span> <span class='hs-varid'>kv1</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>k2</span><span class='hs-layout'>)</span>
<a name="line-109"></a>    <span class='hs-keyword'>then</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>kindOccurCheckErr</span> <span class='hs-varid'>kv1</span> <span class='hs-varid'>k2</span><span class='hs-layout'>)</span>
<a name="line-110"></a>    <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-111"></a>
<a name="line-112"></a><a name="kindSimpleKind"></a><span class='hs-definition'>kindSimpleKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SimpleKind</span>
<a name="line-113"></a><span class='hs-comment'>-- (kindSimpleKind k) returns a simple kind k' such that k' &lt;= k</span>
<a name="line-114"></a><span class='hs-definition'>kindSimpleKind</span> <span class='hs-varid'>k</span>
<a name="line-115"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isOpenTypeKind</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-116"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isArgTypeKind</span>  <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-117"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>k</span>
<a name="line-118"></a>
<a name="line-119"></a><a name="mkKindErrorCtxt"></a><span class='hs-definition'>mkKindErrorCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span>
<a name="line-120"></a><span class='hs-definition'>mkKindErrorCtxt</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>k1</span> <span class='hs-varid'>k2</span> <span class='hs-varid'>env0</span>
<a name="line-121"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenType</span> <span class='hs-varid'>env0</span> <span class='hs-varid'>ty1</span>
<a name="line-122"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenType</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>ty2</span>
<a name="line-123"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>env3</span><span class='hs-layout'>,</span> <span class='hs-varid'>k1'</span> <span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenKind</span> <span class='hs-varid'>env2</span> <span class='hs-varid'>k1</span>
<a name="line-124"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>env4</span><span class='hs-layout'>,</span> <span class='hs-varid'>k2'</span> <span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenKind</span> <span class='hs-varid'>env3</span> <span class='hs-varid'>k2</span>
<a name="line-125"></a>    <span class='hs-keyword'>in</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>ty1'</span>
<a name="line-126"></a>          <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>ty2'</span>
<a name="line-127"></a>          <span class='hs-varid'>k1</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-varid'>k1'</span>
<a name="line-128"></a>          <span class='hs-varid'>k2</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-varid'>k2'</span>
<a name="line-129"></a>          <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env4</span><span class='hs-layout'>,</span> 
<a name="line-130"></a>                  <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Kind incompatibility when matching types:"</span><span class='hs-layout'>)</span>
<a name="line-131"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>k1</span>
<a name="line-132"></a>                                      <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>k2</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-133"></a>
<a name="line-134"></a><a name="unifyKindMisMatch"></a><span class='hs-definition'>unifyKindMisMatch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-135"></a><span class='hs-definition'>unifyKindMisMatch</span> <span class='hs-varid'>ki1</span> <span class='hs-varid'>ki2</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-136"></a>    <span class='hs-varid'>ki1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-varid'>ki1</span>
<a name="line-137"></a>    <span class='hs-varid'>ki2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-varid'>ki2</span>
<a name="line-138"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Couldn't match kind"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-139"></a>              <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ki1'</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-140"></a>                      <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"against"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-141"></a>                      <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ki2'</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-142"></a>    <span class='hs-varid'>failWithTc</span> <span class='hs-varid'>msg</span>
<a name="line-143"></a>
<a name="line-144"></a><a name="kindOccurCheckErr"></a><span class='hs-comment'>----------------</span>
<a name="line-145"></a><span class='hs-definition'>kindOccurCheckErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-146"></a><span class='hs-definition'>kindOccurCheckErr</span> <span class='hs-varid'>tyvar</span> <span class='hs-varid'>ty</span>
<a name="line-147"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Occurs check: cannot construct the infinite kind:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-148"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>,</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'='</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection{Checking signature type variables}
%*                                                                      *
%************************************************************************

@checkSigTyVars@ checks that a set of universally quantified type varaibles
are not mentioned in the environment.  In particular:

        (a) Not mentioned in the type of a variable in the envt
                eg the signature for f in this:

                        g x = ... where
                                        f :: a->[a]
                                        f y = [x,y]

                Here, f is forced to be monorphic by the free occurence of x.

        (d) Not (unified with another type variable that is) in scope.
                eg f x :: (r->r) = (\y->y) :: forall a. a->r
            when checking the expression type signature, we find that
            even though there is nothing in scope whose type mentions r,
            nevertheless the type signature for the expression isn't right.

            Another example is in a class or instance declaration:
                class C a where
                   op :: forall b. a -> b
                   op x = x
            Here, b gets unified with a

Before doing this, the substitution is applied to the signature type variable.

-- \begin{code}
checkSigTyVars :: [TcTyVar] -> TcM ()
checkSigTyVars sig_tvs = check_sig_tyvars emptyVarSet sig_tvs

checkSigTyVarsWrt :: TcTyVarSet -> [TcTyVar] -> TcM ()
-- The extra_tvs can include boxy type variables;
--      e.g. TcMatches.tcCheckExistentialPat
checkSigTyVarsWrt extra_tvs sig_tvs
  = do  { extra_tvs' <- zonkTcTyVarsAndFV extra_tvs
        ; check_sig_tyvars extra_tvs' sig_tvs }

check_sig_tyvars
        :: TcTyVarSet   -- Global type variables. The universally quantified
                        --      tyvars should not mention any of these
                        --      Guaranteed already zonked.
        -> [TcTyVar]    -- Universally-quantified type variables in the signature
                        --      Guaranteed to be skolems
        -> TcM ()
check_sig_tyvars _ []
  = return ()
check_sig_tyvars extra_tvs sig_tvs
  = ASSERT( all isTcTyVar sig_tvs && all isSkolemTyVar sig_tvs )
    do  { gbl_tvs <- tcGetGlobalTyVars
        ; traceTc "check_sig_tyvars" $ vcat 
               [ text "sig_tys" <+> ppr sig_tvs
               , text "gbl_tvs" <+> ppr gbl_tvs
               , text "extra_tvs" <+> ppr extra_tvs]

        ; let env_tvs = gbl_tvs `unionVarSet` extra_tvs
        ; when (any (`elemVarSet` env_tvs) sig_tvs)
               (bleatEscapedTvs env_tvs sig_tvs sig_tvs)
        }

bleatEscapedTvs :: TcTyVarSet   -- The global tvs
                -> [TcTyVar]    -- The possibly-escaping type variables
                -> [TcTyVar]    -- The zonked versions thereof
                -> TcM ()
-- Complain about escaping type variables
-- We pass a list of type variables, at least one of which
-- escapes.  The first list contains the original signature type variable,
-- while the second  contains the type variable it is unified to (usually itself)
bleatEscapedTvs globals sig_tvs zonked_tvs
  = do  { env0 <- tcInitTidyEnv
        ; let (env1, tidy_tvs)        = tidyOpenTyVars env0 sig_tvs
              (env2, tidy_zonked_tvs) = tidyOpenTyVars env1 zonked_tvs

        ; (env3, msgs) <- foldlM check (env2, []) (tidy_tvs `zip` tidy_zonked_tvs)
        ; failWithTcM (env3, main_msg $$ nest 2 (vcat msgs)) }
  where
    main_msg = ptext (sLit "Inferred type is less polymorphic than expected")

    check (tidy_env, msgs) (sig_tv, zonked_tv)
      | not (zonked_tv `elemVarSet` globals) = return (tidy_env, msgs)
      | otherwise
      = do { lcl_env <- getLclTypeEnv
           ; (tidy_env1, globs) <- findGlobals (unitVarSet zonked_tv) lcl_env tidy_env
           ; return (tidy_env1, escape_msg sig_tv zonked_tv globs : msgs) }

-----------------------
escape_msg :: Var -> Var -> [SDoc] -> SDoc
escape_msg sig_tv zonked_tv globs
  | notNull globs
  = vcat [sep [msg, ptext (sLit "is mentioned in the environment:")],
          nest 2 (vcat globs)]
  | otherwise
  = msg <+> ptext (sLit "escapes")
        -- Sigh.  It's really hard to give a good error message
        -- all the time.   One bad case is an existential pattern match.
        -- We rely on the "When..." context to help.
  where
    msg = ptext (sLit "Quantified type variable") <+> quotes (ppr sig_tv) <+> is_bound_to
    is_bound_to
        | sig_tv == zonked_tv = empty
        | otherwise = ptext (sLit "is unified with") <+> quotes (ppr zonked_tv) <+> ptext (sLit "which")
-- \end{code}

These two context are used with checkSigTyVars

\begin{code}
<pre><a name="line-1"></a><a name="sigCtxt"></a><span class='hs-definition'>sigCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTauType</span>
<a name="line-2"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>Message</span><span class='hs-layout'>)</span>
<a name="line-3"></a><span class='hs-definition'>sigCtxt</span> <span class='hs-varid'>id</span> <span class='hs-varid'>sig_tvs</span> <span class='hs-varid'>sig_theta</span> <span class='hs-varid'>sig_tau</span> <span class='hs-varid'>tidy_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-4"></a>    <span class='hs-varid'>actual_tau</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>sig_tau</span>
<a name="line-5"></a>    <span class='hs-keyword'>let</span>
<a name="line-6"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidy_sig_tvs</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenTyVars</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>sig_tvs</span>
<a name="line-7"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidy_sig_rho</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenType</span> <span class='hs-varid'>env1</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPhiTy</span> <span class='hs-varid'>sig_theta</span> <span class='hs-varid'>sig_tau</span><span class='hs-layout'>)</span>
<a name="line-8"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>env3</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidy_actual_tau</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenType</span> <span class='hs-varid'>env2</span> <span class='hs-varid'>actual_tau</span>
<a name="line-9"></a>        <span class='hs-varid'>sub_msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Signature type:    "</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprType</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkForAllTys</span> <span class='hs-varid'>tidy_sig_tvs</span> <span class='hs-varid'>tidy_sig_rho</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-10"></a>                        <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Type to generalise:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprType</span> <span class='hs-varid'>tidy_actual_tau</span>
<a name="line-11"></a>                   <span class='hs-keyglyph'>]</span>
<a name="line-12"></a>        <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"When trying to generalise the type inferred for"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-13"></a>                    <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varid'>sub_msg</span><span class='hs-keyglyph'>]</span>
<a name="line-14"></a>
<a name="line-15"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env3</span><span class='hs-layout'>,</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span>
</pre>\end{code}
</body>
</html>
