<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>simplCore/CSE.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The AQUA Project, Glasgow University, 1993-1998
%
\section{Common subexpression}

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>CSE</span> <span class='hs-layout'>(</span>
<a name="line-9"></a>	<span class='hs-varid'>cseProgram</span>
<a name="line-10"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-13"></a>
<a name="line-14"></a><span class='hs-comment'>-- Note [Keep old CSEnv rep]</span>
<a name="line-15"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-16"></a><span class='hs-comment'>-- Temporarily retain code for the old representation for CSEnv</span>
<a name="line-17"></a><span class='hs-comment'>-- Keeping it only so that we can switch back if a bug shows up</span>
<a name="line-18"></a><span class='hs-comment'>-- or we want to do some performance comparisions</span>
<a name="line-19"></a><span class='hs-comment'>--</span>
<a name="line-20"></a><span class='hs-comment'>-- NB: when you remove this, also delete hashExpr from CoreUtils</span>
<a name="line-21"></a><span class='hs-cpp'>#ifdef OLD_CSENV_REP</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreUtils</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>exprIsBig</span><span class='hs-layout'>,</span> <span class='hs-varid'>hashExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>eqExpr</span> <span class='hs-layout'>)</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>StaticFlags</span>	<span class='hs-layout'>(</span> <span class='hs-varid'>opt_PprStyle_Debug</span> <span class='hs-layout'>)</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>		<span class='hs-layout'>(</span> <span class='hs-varid'>lengthExceeds</span> <span class='hs-layout'>)</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqFM</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-27"></a><span class='hs-cpp'>#else</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TrieMap</span>
<a name="line-29"></a><span class='hs-cpp'>#endif</span>
<a name="line-30"></a>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreSubst</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>		<span class='hs-layout'>(</span> <span class='hs-conid'>Var</span> <span class='hs-layout'>)</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>		<span class='hs-layout'>(</span> <span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-varid'>idType</span><span class='hs-layout'>,</span> <span class='hs-varid'>idInlineActivation</span><span class='hs-layout'>,</span> <span class='hs-varid'>zapIdOccInfo</span> <span class='hs-layout'>)</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreUtils</span>	<span class='hs-layout'>(</span> <span class='hs-varid'>mkAltExpr</span>
<a name="line-35"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>exprIsTrivial</span><span class='hs-layout'>,</span> <span class='hs-varid'>exprIsCheap</span> <span class='hs-layout'>)</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>		<span class='hs-layout'>(</span> <span class='hs-varid'>isUnboxedTupleCon</span> <span class='hs-layout'>)</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>		<span class='hs-layout'>(</span> <span class='hs-varid'>tyConAppArgs</span> <span class='hs-layout'>)</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreSyn</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>	<span class='hs-layout'>(</span> <span class='hs-varid'>isAlwaysActive</span> <span class='hs-layout'>)</span>
<a name="line-41"></a>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>
</pre>\end{code}


			Simple common sub-expression
			~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we see
	x1 = C a b
	x2 = C x1 b
we build up a reverse mapping:   C a b  -> x1
				 C x1 b -> x2
and apply that to the rest of the program.

When we then see
	y1 = C a b
	y2 = C y1 b
we replace the C a b with x1.  But then we *dont* want to
add   x1 -> y1  to the mapping.  Rather, we want the reverse, y1 -> x1
so that a subsequent binding
	y2 = C y1 b
will get transformed to C x1 b, and then to x2.  

So we carry an extra var->var substitution which we apply *before* looking up in the
reverse mapping.


Note [Shadowing]
~~~~~~~~~~~~~~~~
We have to be careful about shadowing.
For example, consider
	f = \x -> let y = x+x in
	              h = \x -> x+x
	          in ...

Here we must *not* do CSE on the inner x+x!  The simplifier used to guarantee no
shadowing, but it doesn't any more (it proved too hard), so we clone as we go.
We can simply add clones to the substitution already described.

Note [Case binders 1]
~~~~~~~~~~~~~~~~~~~~~~
Consider

	f = \x -> case x of wild { 
			(a:as) -> case a of wild1 {
				    (p,q) -> ...(wild1:as)...

Here, (wild1:as) is morally the same as (a:as) and hence equal to wild.
But that's not quite obvious.  In general we want to keep it as (wild1:as),
but for CSE purpose that's a bad idea.

So we add the binding (wild1 -> a) to the extra var->var mapping.
Notice this is exactly backwards to what the simplifier does, which is
to try to replaces uses of 'a' with uses of 'wild1'

Note [Case binders 2]
~~~~~~~~~~~~~~~~~~~~~~
Consider
	case (h x) of y -> ...(h x)...

We'd like to replace (h x) in the alternative, by y.  But because of
the preceding [Note: case binders 1], we only want to add the mapping
	scrutinee -> case binder
to the reverse CSE mapping if the scrutinee is a non-trivial expression.
(If the scrutinee is a simple variable we want to add the mapping
	case binder -> scrutinee 
to the substitution

Note [Unboxed tuple case binders]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
	case f x of t { (# a,b #) -> 
	case ... of
	  True -> f x
	  False -> 0 }

We must not replace (f x) by t, because t is an unboxed-tuple binder.
Instead, we shoudl replace (f x) by (# a,b #).  That is, the "reverse mapping" is
	f x --> (# a,b #)
That is why the CSEMap has pairs of expressions.

Note [CSE for INLINE and NOINLINE]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We are careful to do no CSE inside functions that the user has marked as
INLINE or NOINLINE.  In terms of Core, that means 

	a) we do not do CSE inside an InlineRule

	b) we do not do CSE on the RHS of a binding b=e
	   unless b's InlinePragma is AlwaysActive

Here's why (examples from Roman Leshchinskiy).  Consider

	yes :: Int
	{-# NOINLINE yes #-}
	yes = undefined

	no :: Int
	{-# NOINLINE no #-}
	no = undefined

	foo :: Int -> Int -> Int
	{-# NOINLINE foo #-}
	foo m n = n

	{-# RULES "foo/no" foo no = id #-}

	bar :: Int -> Int
	bar = foo yes

We do not expect the rule to fire.  But if we do CSE, then we get
yes=no, and the rule does fire.  Worse, whether we get yes=no or
no=yes depends on the order of the definitions.

In general, CSE should probably never touch things with INLINE pragmas
as this could lead to surprising results.  Consider

	{-# INLINE foo #-}
	foo = <rhs>

	{-# NOINLINE bar #-}
	bar = <rhs>	-- Same rhs as foo

If CSE produces
	foo = bar
then foo will never be inlined (when it should be); but if it produces
	bar = foo
bar will be inlined (when it should not be). Even if we remove INLINE foo,
we'd still like foo to be inlined if rhs is small. This won't happen
with foo = bar.

Not CSE-ing inside INLINE also solves an annoying bug in CSE. Consider
a worker/wrapper, in which the worker has turned into a single variable:
	$wf = h
	f = \x -> ...$wf...
Now CSE may transform to
	f = \x -> ...h...
But the WorkerInfo for f still says $wf, which is now dead!  This won't
happen now that we don't look inside INLINEs (which wrappers are).


%************************************************************************
%*									*
\section{Common subexpression}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="cseProgram"></a><span class='hs-definition'>cseProgram</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span>
<a name="line-2"></a><span class='hs-definition'>cseProgram</span> <span class='hs-varid'>binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cseBinds</span> <span class='hs-varid'>emptyCSEnv</span> <span class='hs-varid'>binds</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="cseBinds"></a><span class='hs-definition'>cseBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CSEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreBind</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreBind</span><span class='hs-keyglyph'>]</span>
<a name="line-5"></a><span class='hs-definition'>cseBinds</span> <span class='hs-keyword'>_</span>   <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-6"></a><span class='hs-definition'>cseBinds</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-conop'>:</span><span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>b'</span><span class='hs-conop'>:</span><span class='hs-varid'>bs'</span><span class='hs-layout'>)</span>
<a name="line-7"></a>		    <span class='hs-keyword'>where</span>
<a name="line-8"></a>		      <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>b'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cseBind</span>  <span class='hs-varid'>env</span>  <span class='hs-varid'>b</span>
<a name="line-9"></a>		      <span class='hs-varid'>bs'</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cseBinds</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>bs</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="cseBind"></a><span class='hs-definition'>cseBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CSEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CSEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreBind</span><span class='hs-layout'>)</span>
<a name="line-12"></a><span class='hs-definition'>cseBind</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>b</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> 
<a name="line-13"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-conid'>NonRec</span> <span class='hs-varid'>b'</span> <span class='hs-varid'>e'</span><span class='hs-layout'>)</span>
<a name="line-14"></a>  <span class='hs-keyword'>where</span>
<a name="line-15"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>b'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addBinder</span> <span class='hs-varid'>env</span> <span class='hs-varid'>b</span>
<a name="line-16"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>e'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cseRhs</span> <span class='hs-varid'>env1</span> <span class='hs-layout'>(</span><span class='hs-varid'>b'</span><span class='hs-layout'>,</span><span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-definition'>cseBind</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span>
<a name="line-19"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-conid'>Rec</span> <span class='hs-layout'>(</span><span class='hs-varid'>bs'</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>es'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-20"></a>  <span class='hs-keyword'>where</span>
<a name="line-21"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>bs</span><span class='hs-layout'>,</span><span class='hs-varid'>es</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip</span> <span class='hs-varid'>pairs</span>
<a name="line-22"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>bs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addRecBinders</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bs</span>
<a name="line-23"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>es'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>cseRhs</span> <span class='hs-varid'>env1</span> <span class='hs-layout'>(</span><span class='hs-varid'>bs'</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>es</span><span class='hs-layout'>)</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="cseRhs"></a><span class='hs-definition'>cseRhs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CSEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>OutBndr</span><span class='hs-layout'>,</span> <span class='hs-conid'>InExpr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CSEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>OutExpr</span><span class='hs-layout'>)</span>
<a name="line-26"></a><span class='hs-definition'>cseRhs</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>id'</span><span class='hs-layout'>,</span><span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-27"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupCSEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>rhs'</span> <span class='hs-keyword'>of</span>
<a name="line-28"></a>	<span class='hs-conid'>Just</span> <span class='hs-varid'>other_expr</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span><span class='hs-layout'>,</span> 			         <span class='hs-varid'>other_expr</span><span class='hs-layout'>)</span>
<a name="line-29"></a>	<span class='hs-conid'>Nothing</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>addCSEnvItem</span> <span class='hs-varid'>env</span> <span class='hs-varid'>rhs'</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>id'</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span>
<a name="line-30"></a>  <span class='hs-keyword'>where</span>
<a name="line-31"></a>    <span class='hs-varid'>rhs'</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isAlwaysActive</span> <span class='hs-layout'>(</span><span class='hs-varid'>idInlineActivation</span> <span class='hs-varid'>id'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cseExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>rhs</span>
<a name="line-32"></a>	 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>			           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span>
<a name="line-33"></a>		<span class='hs-comment'>-- See Note [CSE for INLINE and NOINLINE]</span>
<a name="line-34"></a>
<a name="line-35"></a><a name="tryForCSE"></a><span class='hs-definition'>tryForCSE</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CSEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OutExpr</span>
<a name="line-36"></a><span class='hs-definition'>tryForCSE</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span>
<a name="line-37"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>exprIsTrivial</span> <span class='hs-varid'>expr'</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expr'</span>	<span class='hs-comment'>-- No point</span>
<a name="line-38"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>smaller</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupCSEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>smaller</span>
<a name="line-39"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expr'</span>
<a name="line-40"></a>  <span class='hs-keyword'>where</span>
<a name="line-41"></a>    <span class='hs-varid'>expr'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cseExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span>
<a name="line-42"></a>
<a name="line-43"></a><a name="cseExpr"></a><span class='hs-definition'>cseExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CSEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OutExpr</span>
<a name="line-44"></a><span class='hs-definition'>cseExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>csEnvSubst</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-45"></a><span class='hs-definition'>cseExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Coercion</span> <span class='hs-layout'>(</span><span class='hs-varid'>substCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>csEnvSubst</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>
<a name="line-46"></a><span class='hs-definition'>cseExpr</span> <span class='hs-keyword'>_</span>   <span class='hs-layout'>(</span><span class='hs-conid'>Lit</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Lit</span> <span class='hs-varid'>lit</span>
<a name="line-47"></a><span class='hs-definition'>cseExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>		   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupSubst</span> <span class='hs-varid'>env</span> <span class='hs-varid'>v</span>
<a name="line-48"></a><span class='hs-definition'>cseExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>f</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>        	   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>App</span> <span class='hs-layout'>(</span><span class='hs-varid'>cseExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tryForCSE</span> <span class='hs-varid'>env</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-49"></a><span class='hs-definition'>cseExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-varid'>t</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Tick</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-varid'>cseExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-50"></a><span class='hs-definition'>cseExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>e</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Cast</span> <span class='hs-layout'>(</span><span class='hs-varid'>cseExpr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>substCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>csEnvSubst</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-51"></a><span class='hs-definition'>cseExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-varid'>b</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>	     	   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>b'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addBinder</span> <span class='hs-varid'>env</span> <span class='hs-varid'>b</span>
<a name="line-52"></a>				     <span class='hs-keyword'>in</span> <span class='hs-conid'>Lam</span> <span class='hs-varid'>b'</span> <span class='hs-layout'>(</span><span class='hs-varid'>cseExpr</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-53"></a><span class='hs-definition'>cseExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Let</span> <span class='hs-varid'>bind</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>    	   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cseBind</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bind</span>
<a name="line-54"></a>				     <span class='hs-keyword'>in</span> <span class='hs-conid'>Let</span> <span class='hs-varid'>bind'</span> <span class='hs-layout'>(</span><span class='hs-varid'>cseExpr</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-55"></a><span class='hs-definition'>cseExpr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Case</span> <span class='hs-varid'>scrut</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Case</span> <span class='hs-varid'>scrut'</span> <span class='hs-varid'>bndr''</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>alts'</span>
<a name="line-56"></a>				   <span class='hs-keyword'>where</span>
<a name="line-57"></a>                                     <span class='hs-varid'>alts'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cseAlts</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>scrut'</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>bndr''</span> <span class='hs-varid'>alts</span>
<a name="line-58"></a>				     <span class='hs-varid'>scrut'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tryForCSE</span> <span class='hs-varid'>env</span> <span class='hs-varid'>scrut</span>
<a name="line-59"></a>				     <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndr'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addBinder</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bndr</span>
<a name="line-60"></a>				     <span class='hs-varid'>bndr''</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zapIdOccInfo</span> <span class='hs-varid'>bndr'</span>
<a name="line-61"></a>					<span class='hs-comment'>-- The swizzling from Note [Case binders 2] may</span>
<a name="line-62"></a>					<span class='hs-comment'>-- cause a dead case binder to be alive, so we</span>
<a name="line-63"></a>					<span class='hs-comment'>-- play safe here and bring them all to life</span>
<a name="line-64"></a>
<a name="line-65"></a><a name="cseAlts"></a><span class='hs-definition'>cseAlts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CSEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OutExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InBndr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InBndr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>InAlt</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>OutAlt</span><span class='hs-keyglyph'>]</span>
<a name="line-66"></a>
<a name="line-67"></a><span class='hs-definition'>cseAlts</span> <span class='hs-varid'>env</span> <span class='hs-varid'>scrut'</span> <span class='hs-varid'>bndr</span> <span class='hs-sel'>_bndr'</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>DataAlt</span> <span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-68"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isUnboxedTupleCon</span> <span class='hs-varid'>con</span>
<a name="line-69"></a>	<span class='hs-comment'>-- Unboxed tuples are special because the case binder isn't</span>
<a name="line-70"></a>	<span class='hs-comment'>-- a real value.  See Note [Unboxed tuple case binders]</span>
<a name="line-71"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>DataAlt</span> <span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>args''</span><span class='hs-layout'>,</span> <span class='hs-varid'>tryForCSE</span> <span class='hs-varid'>new_env</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-72"></a>  <span class='hs-keyword'>where</span>
<a name="line-73"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>args'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addBinders</span> <span class='hs-varid'>env</span> <span class='hs-varid'>args</span>
<a name="line-74"></a>    <span class='hs-varid'>args''</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>zapIdOccInfo</span> <span class='hs-varid'>args'</span>	<span class='hs-comment'>-- They should all be ids</span>
<a name="line-75"></a>	<span class='hs-comment'>-- Same motivation for zapping as [Case binders 2] only this time</span>
<a name="line-76"></a>	<span class='hs-comment'>-- it's Note [Unboxed tuple case binders]</span>
<a name="line-77"></a>    <span class='hs-varid'>new_env</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>exprIsCheap</span> <span class='hs-varid'>scrut'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env'</span>
<a name="line-78"></a>	    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> 	 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendCSEnv</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>scrut'</span> <span class='hs-varid'>tup_value</span>
<a name="line-79"></a>    <span class='hs-varid'>tup_value</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAltExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataAlt</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-varid'>args''</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConAppArgs</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-80"></a>
<a name="line-81"></a><span class='hs-definition'>cseAlts</span> <span class='hs-varid'>env</span> <span class='hs-varid'>scrut'</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>bndr'</span> <span class='hs-varid'>alts</span>
<a name="line-82"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>cse_alt</span> <span class='hs-varid'>alts</span>
<a name="line-83"></a>  <span class='hs-keyword'>where</span>
<a name="line-84"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>con_target</span><span class='hs-layout'>,</span> <span class='hs-varid'>alt_env</span><span class='hs-layout'>)</span>
<a name="line-85"></a>	<span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>scrut'</span> <span class='hs-keyword'>of</span>
<a name="line-86"></a>	    <span class='hs-conid'>Var</span> <span class='hs-varid'>v'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>v'</span><span class='hs-layout'>,</span>     <span class='hs-varid'>extendCSSubst</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>v'</span><span class='hs-layout'>)</span>	<span class='hs-comment'>-- See Note [Case binders 1]</span>
<a name="line-87"></a>								<span class='hs-comment'>-- map: bndr -&gt; v'</span>
<a name="line-88"></a>
<a name="line-89"></a>	    <span class='hs-keyword'>_</span>      <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-layout'>(</span><span class='hs-varid'>bndr'</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendCSEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>scrut'</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span>  <span class='hs-varid'>bndr'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- See Note [Case binders 2]</span>
<a name="line-90"></a>								    <span class='hs-comment'>-- map: scrut' -&gt; bndr'</span>
<a name="line-91"></a>
<a name="line-92"></a>    <span class='hs-varid'>arg_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConAppArgs</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span>
<a name="line-93"></a>
<a name="line-94"></a>    <span class='hs-varid'>cse_alt</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataAlt</span> <span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-95"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-96"></a>		<span class='hs-comment'>-- Don't try CSE if there are no args; it just increases the number</span>
<a name="line-97"></a>		<span class='hs-comment'>-- of live vars.  E.g.</span>
<a name="line-98"></a>		<span class='hs-comment'>--	case x of { True -&gt; ....True.... }</span>
<a name="line-99"></a>		<span class='hs-comment'>-- Don't replace True by x!  </span>
<a name="line-100"></a>		<span class='hs-comment'>-- Hence the 'null args', which also deal with literals and DEFAULT</span>
<a name="line-101"></a>	<span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataAlt</span> <span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>args'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tryForCSE</span> <span class='hs-varid'>new_env</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-102"></a>	<span class='hs-keyword'>where</span>
<a name="line-103"></a>	  <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>args'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addBinders</span> <span class='hs-varid'>alt_env</span> <span class='hs-varid'>args</span>
<a name="line-104"></a>	  <span class='hs-varid'>new_env</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendCSEnv</span> <span class='hs-varid'>env'</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAltExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataAlt</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-varid'>args'</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span>
<a name="line-105"></a>					   <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>con_target</span><span class='hs-layout'>)</span>
<a name="line-106"></a>
<a name="line-107"></a>    <span class='hs-varid'>cse_alt</span> <span class='hs-layout'>(</span><span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-108"></a>	<span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>args'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tryForCSE</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-109"></a>	<span class='hs-keyword'>where</span>
<a name="line-110"></a>	  <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>args'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addBinders</span> <span class='hs-varid'>alt_env</span> <span class='hs-varid'>args</span>
</pre>\end{code}


%************************************************************************
%*									*
\section{The CSE envt}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="InExpr"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>InExpr</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreExpr</span>		<span class='hs-comment'>-- Pre-cloning</span>
<a name="line-2"></a><a name="InBndr"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>InBndr</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreBndr</span>
<a name="line-3"></a><a name="InAlt"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>InAlt</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreAlt</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="OutExpr"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>OutExpr</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreExpr</span>	<span class='hs-comment'>-- Post-cloning</span>
<a name="line-6"></a><a name="OutBndr"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>OutBndr</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreBndr</span>
<a name="line-7"></a><a name="OutAlt"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>OutAlt</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoreAlt</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-comment'>-- See Note [Keep old CsEnv rep]</span>
<a name="line-10"></a><span class='hs-cpp'>#ifdef OLD_CSENV_REP</span>
<a name="line-11"></a><a name="CSEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CSEnv</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cs_map</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CSEMap</span>
<a name="line-12"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>cs_subst</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-layout'>}</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="CSEMap"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CSEMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UniqFM</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>OutExpr</span><span class='hs-layout'>,</span> <span class='hs-conid'>OutExpr</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>	<span class='hs-comment'>-- This is the reverse mapping</span>
<a name="line-15"></a>	<span class='hs-comment'>-- It maps the hash-code of an expression e to list of (e,e') pairs</span>
<a name="line-16"></a>	<span class='hs-comment'>-- This means that it's good to replace e by e'</span>
<a name="line-17"></a>	<span class='hs-comment'>-- INVARIANT: The expr in the range has already been CSE'd</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="emptyCSEnv"></a><span class='hs-definition'>emptyCSEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CSEnv</span>
<a name="line-20"></a><span class='hs-definition'>emptyCSEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cs_map</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyUFM</span><span class='hs-layout'>,</span> <span class='hs-varid'>cs_subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptySubst</span> <span class='hs-layout'>}</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="lookupCSEnv"></a><span class='hs-definition'>lookupCSEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CSEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OutExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>OutExpr</span>
<a name="line-23"></a><span class='hs-definition'>lookupCSEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>CS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cs_map</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>oldmap</span><span class='hs-layout'>,</span> <span class='hs-varid'>cs_subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sub</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>expr</span>
<a name="line-24"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupUFM</span> <span class='hs-varid'>oldmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>hashExpr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-25"></a>             	<span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-26"></a>         	<span class='hs-conid'>Just</span> <span class='hs-varid'>pairs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>lookup_list</span> <span class='hs-varid'>pairs</span>
<a name="line-27"></a>  <span class='hs-keyword'>where</span>
<a name="line-28"></a>    <span class='hs-varid'>in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substInScope</span> <span class='hs-varid'>sub</span>
<a name="line-29"></a>
<a name="line-30"></a>  <span class='hs-comment'>-- In this lookup we use full expression equality</span>
<a name="line-31"></a>  <span class='hs-comment'>-- Reason: when expressions differ we generally find out quickly</span>
<a name="line-32"></a>  <span class='hs-comment'>--         but I found that cheapEqExpr was saying (\x.x) /= (\y.y),</span>
<a name="line-33"></a>  <span class='hs-comment'>-- 	     and this kind of thing happened in real programs</span>
<a name="line-34"></a>    <span class='hs-varid'>lookup_list</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>OutExpr</span><span class='hs-layout'>,</span><span class='hs-conid'>OutExpr</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>OutExpr</span>
<a name="line-35"></a>    <span class='hs-varid'>lookup_list</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>e</span><span class='hs-layout'>,</span><span class='hs-varid'>e'</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>es</span><span class='hs-layout'>)</span> 
<a name="line-36"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>eqExpr</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>e</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>e'</span>
<a name="line-37"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>	                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookup_list</span> <span class='hs-varid'>es</span>
<a name="line-38"></a>    <span class='hs-varid'>lookup_list</span> <span class='hs-conid'>[]</span>                       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-39"></a>
<a name="line-40"></a><a name="addCSEnvItem"></a><span class='hs-definition'>addCSEnvItem</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CSEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OutExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OutExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CSEnv</span>
<a name="line-41"></a><span class='hs-definition'>addCSEnvItem</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>expr'</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>exprIsBig</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span>
<a name="line-42"></a>			    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendCSEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>expr'</span>
<a name="line-43"></a>   <span class='hs-comment'>-- We don't try to CSE big expressions, because they are expensive to compare</span>
<a name="line-44"></a>   <span class='hs-comment'>-- (and are unlikely to be the same anyway)</span>
<a name="line-45"></a>
<a name="line-46"></a><a name="extendCSEnv"></a><span class='hs-definition'>extendCSEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CSEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OutExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OutExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CSEnv</span>
<a name="line-47"></a><span class='hs-definition'>extendCSEnv</span> <span class='hs-varid'>cse</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cs_map</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>oldmap</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>expr'</span>
<a name="line-48"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cse</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cs_map</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addToUFM_C</span> <span class='hs-varid'>combine</span> <span class='hs-varid'>oldmap</span> <span class='hs-varid'>hash</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>expr</span><span class='hs-layout'>,</span> <span class='hs-varid'>expr'</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-49"></a>  <span class='hs-keyword'>where</span>
<a name="line-50"></a>    <span class='hs-varid'>hash</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hashExpr</span> <span class='hs-varid'>expr</span>
<a name="line-51"></a>    <span class='hs-varid'>combine</span> <span class='hs-varid'>old</span> <span class='hs-varid'>new</span> 
<a name="line-52"></a>	<span class='hs-keyglyph'>=</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-varid'>result</span> <span class='hs-varop'>`lengthExceeds`</span> <span class='hs-num'>4</span><span class='hs-layout'>,</span> <span class='hs-varid'>short_msg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varid'>long_msg</span> <span class='hs-layout'>)</span> <span class='hs-varid'>result</span>
<a name="line-53"></a>	<span class='hs-keyword'>where</span>
<a name="line-54"></a>	  <span class='hs-varid'>result</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new</span> <span class='hs-varop'>++</span> <span class='hs-varid'>old</span>
<a name="line-55"></a>	  <span class='hs-varid'>short_msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"extendCSEnv: long list, length"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span>
<a name="line-56"></a>	  <span class='hs-varid'>long_msg</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>opt_PprStyle_Debug</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"hash code"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>hash</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>result</span> 
<a name="line-57"></a>		   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>	        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-58"></a>
<a name="line-59"></a><span class='hs-cpp'>#else</span>
<a name="line-60"></a><span class='hs-comment'>------------ NEW ----------------</span>
<a name="line-61"></a>
<a name="line-62"></a><a name="CSEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CSEnv</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cs_map</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreMap</span> <span class='hs-layout'>(</span><span class='hs-conid'>OutExpr</span><span class='hs-layout'>,</span> <span class='hs-conid'>OutExpr</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- Key, value</span>
<a name="line-63"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>cs_subst</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Subst</span> <span class='hs-layout'>}</span>
<a name="line-64"></a>
<a name="line-65"></a><span class='hs-definition'>emptyCSEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CSEnv</span>
<a name="line-66"></a><span class='hs-definition'>emptyCSEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cs_map</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyCoreMap</span><span class='hs-layout'>,</span> <span class='hs-varid'>cs_subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptySubst</span> <span class='hs-layout'>}</span>
<a name="line-67"></a>
<a name="line-68"></a><span class='hs-definition'>lookupCSEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CSEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OutExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>OutExpr</span>
<a name="line-69"></a><span class='hs-definition'>lookupCSEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>CS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cs_map</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>csmap</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>expr</span> 
<a name="line-70"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupCoreMap</span> <span class='hs-varid'>csmap</span> <span class='hs-varid'>expr</span> <span class='hs-keyword'>of</span>
<a name="line-71"></a>      <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>e</span>
<a name="line-72"></a>      <span class='hs-conid'>Nothing</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-73"></a>
<a name="line-74"></a><span class='hs-definition'>addCSEnvItem</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CSEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OutExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OutExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CSEnv</span>
<a name="line-75"></a><span class='hs-definition'>addCSEnvItem</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendCSEnv</span>
<a name="line-76"></a>   <span class='hs-comment'>-- We used to avoid trying to CSE big expressions, on the grounds</span>
<a name="line-77"></a>   <span class='hs-comment'>-- that they are expensive to compare.  But now we have CoreMaps</span>
<a name="line-78"></a>   <span class='hs-comment'>-- we can happily insert them and laziness will mean that the</span>
<a name="line-79"></a>   <span class='hs-comment'>-- insertions only get fully done if we look up in that part</span>
<a name="line-80"></a>   <span class='hs-comment'>-- of the trie. No need for a size test.</span>
<a name="line-81"></a>
<a name="line-82"></a><span class='hs-definition'>extendCSEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CSEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OutExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OutExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CSEnv</span>
<a name="line-83"></a><span class='hs-definition'>extendCSEnv</span> <span class='hs-varid'>cse</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>expr'</span>
<a name="line-84"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cse</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cs_map</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendCoreMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>cs_map</span> <span class='hs-varid'>cse</span><span class='hs-layout'>)</span> <span class='hs-varid'>expr</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr</span><span class='hs-layout'>,</span><span class='hs-varid'>expr'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-85"></a><span class='hs-cpp'>#endif</span>
<a name="line-86"></a>
<a name="line-87"></a><a name="csEnvSubst"></a><span class='hs-definition'>csEnvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CSEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Subst</span>
<a name="line-88"></a><span class='hs-definition'>csEnvSubst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cs_subst</span>
<a name="line-89"></a>
<a name="line-90"></a><a name="lookupSubst"></a><span class='hs-definition'>lookupSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CSEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OutExpr</span>
<a name="line-91"></a><span class='hs-definition'>lookupSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>CS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cs_subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sub</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupIdSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"CSE.lookupSubst"</span><span class='hs-layout'>)</span> <span class='hs-varid'>sub</span> <span class='hs-varid'>x</span>
<a name="line-92"></a>
<a name="line-93"></a><a name="extendCSSubst"></a><span class='hs-definition'>extendCSSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CSEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CSEnv</span>
<a name="line-94"></a><span class='hs-definition'>extendCSSubst</span> <span class='hs-varid'>cse</span> <span class='hs-varid'>x</span> <span class='hs-varid'>y</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cse</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cs_subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendIdSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>cs_subst</span> <span class='hs-varid'>cse</span><span class='hs-layout'>)</span> <span class='hs-varid'>x</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>y</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-95"></a>
<a name="line-96"></a><a name="addBinder"></a><span class='hs-definition'>addBinder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CSEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CSEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>Var</span><span class='hs-layout'>)</span>
<a name="line-97"></a><span class='hs-definition'>addBinder</span> <span class='hs-varid'>cse</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>cse</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cs_subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sub'</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-varid'>v'</span><span class='hs-layout'>)</span> 
<a name="line-98"></a>                <span class='hs-keyword'>where</span>
<a name="line-99"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>sub'</span><span class='hs-layout'>,</span> <span class='hs-varid'>v'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substBndr</span> <span class='hs-layout'>(</span><span class='hs-varid'>cs_subst</span> <span class='hs-varid'>cse</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span>
<a name="line-100"></a>
<a name="line-101"></a><a name="addBinders"></a><span class='hs-definition'>addBinders</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CSEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CSEnv</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-102"></a><span class='hs-definition'>addBinders</span> <span class='hs-varid'>cse</span> <span class='hs-varid'>vs</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>cse</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cs_subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sub'</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-varid'>vs'</span><span class='hs-layout'>)</span> 
<a name="line-103"></a>                <span class='hs-keyword'>where</span>
<a name="line-104"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>sub'</span><span class='hs-layout'>,</span> <span class='hs-varid'>vs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substBndrs</span> <span class='hs-layout'>(</span><span class='hs-varid'>cs_subst</span> <span class='hs-varid'>cse</span><span class='hs-layout'>)</span> <span class='hs-varid'>vs</span>
<a name="line-105"></a>
<a name="line-106"></a><a name="addRecBinders"></a><span class='hs-definition'>addRecBinders</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CSEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CSEnv</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-107"></a><span class='hs-definition'>addRecBinders</span> <span class='hs-varid'>cse</span> <span class='hs-varid'>vs</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>cse</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cs_subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sub'</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-varid'>vs'</span><span class='hs-layout'>)</span> 
<a name="line-108"></a>                <span class='hs-keyword'>where</span>
<a name="line-109"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>sub'</span><span class='hs-layout'>,</span> <span class='hs-varid'>vs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substRecBndrs</span> <span class='hs-layout'>(</span><span class='hs-varid'>cs_subst</span> <span class='hs-varid'>cse</span><span class='hs-layout'>)</span> <span class='hs-varid'>vs</span>
</pre>\end{code}
</body>
</html>
