<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>codeGen/CgHeapery.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%
\section[CgHeapery]{Heap management functions}

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>CgHeapery</span> <span class='hs-layout'>(</span>
<a name="line-9"></a>	<span class='hs-varid'>initHeapUsage</span><span class='hs-layout'>,</span> <span class='hs-varid'>getVirtHp</span><span class='hs-layout'>,</span> <span class='hs-varid'>setVirtHp</span><span class='hs-layout'>,</span> <span class='hs-varid'>setRealHp</span><span class='hs-layout'>,</span> 
<a name="line-10"></a>	<span class='hs-varid'>getHpRelOffset</span><span class='hs-layout'>,</span>	<span class='hs-varid'>hpRel</span><span class='hs-layout'>,</span>
<a name="line-11"></a>
<a name="line-12"></a>	<span class='hs-varid'>funEntryChecks</span><span class='hs-layout'>,</span> <span class='hs-varid'>thunkEntryChecks</span><span class='hs-layout'>,</span> 
<a name="line-13"></a>	<span class='hs-varid'>altHeapCheck</span><span class='hs-layout'>,</span> <span class='hs-varid'>unbxTupleHeapCheck</span><span class='hs-layout'>,</span> 
<a name="line-14"></a>	<span class='hs-varid'>hpChkGen</span><span class='hs-layout'>,</span> <span class='hs-varid'>hpChkNodePointsAssignSp0</span><span class='hs-layout'>,</span>
<a name="line-15"></a>	<span class='hs-varid'>stkChkGen</span><span class='hs-layout'>,</span> <span class='hs-varid'>stkChkNodePoints</span><span class='hs-layout'>,</span>
<a name="line-16"></a>
<a name="line-17"></a>	<span class='hs-varid'>layOutDynConstr</span><span class='hs-layout'>,</span> <span class='hs-varid'>layOutStaticConstr</span><span class='hs-layout'>,</span>
<a name="line-18"></a>	<span class='hs-varid'>mkVirtHeapOffsets</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkStaticClosureFields</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkStaticClosure</span><span class='hs-layout'>,</span>
<a name="line-19"></a>
<a name="line-20"></a>	<span class='hs-varid'>allocDynClosure</span><span class='hs-layout'>,</span> <span class='hs-varid'>emitSetDynHdr</span>
<a name="line-21"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-22"></a>
<a name="line-23"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-24"></a>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>StgSyn</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CLabel</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgUtils</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgMonad</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgProf</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgTicky</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgParallel</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgStackery</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgCallConv</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ClosureInfo</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SMRep</span>
<a name="line-36"></a>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OldCmm</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OldCmmUtils</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CostCentre</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Constants</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-48"></a>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>
</pre>\end{code}


%************************************************************************
%*									*
\subsection[CgUsages-heapery]{Monad things for fiddling with heap usage}
%*									*
%************************************************************************

The heap always grows upwards, so hpRel is easy

\begin{code}
<pre><a name="line-1"></a><a name="hpRel"></a><span class='hs-definition'>hpRel</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>VirtualHpOffset</span> 	<span class='hs-comment'>-- virtual offset of Hp</span>
<a name="line-2"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VirtualHpOffset</span> 	<span class='hs-comment'>-- virtual offset of The Thing</span>
<a name="line-3"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WordOff</span>			<span class='hs-comment'>-- integer word offset</span>
<a name="line-4"></a><span class='hs-definition'>hpRel</span> <span class='hs-varid'>hp</span> <span class='hs-varid'>off</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>off</span> <span class='hs-comment'>-</span> <span class='hs-varid'>hp</span>
</pre>\end{code}

@initHeapUsage@ applies a function to the amount of heap that it uses.
It initialises the heap usage to zeros, and passes on an unchanged
heap usage.

It is usually a prelude to performing a GC check, so everything must
be in a tidy and consistent state.

rje: Note the slightly suble fixed point behaviour needed here

\begin{code}
<pre><a name="line-1"></a><a name="initHeapUsage"></a><span class='hs-definition'>initHeapUsage</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>VirtualHpOffset</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-2"></a><span class='hs-definition'>initHeapUsage</span> <span class='hs-varid'>fcode</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>orig_hp_usage</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHpUsage</span>
<a name="line-4"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>setHpUsage</span> <span class='hs-varid'>initHpUsage</span>
<a name="line-5"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>fixC_</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>heap_usage2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-6"></a>		<span class='hs-layout'>{</span> <span class='hs-varid'>fcode</span> <span class='hs-layout'>(</span><span class='hs-varid'>heapHWM</span> <span class='hs-varid'>heap_usage2</span><span class='hs-layout'>)</span>
<a name="line-7"></a>		<span class='hs-layout'>;</span> <span class='hs-varid'>getHpUsage</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-8"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>setHpUsage</span> <span class='hs-varid'>orig_hp_usage</span> <span class='hs-layout'>}</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="setVirtHp"></a><span class='hs-definition'>setVirtHp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>VirtualHpOffset</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-11"></a><span class='hs-definition'>setVirtHp</span> <span class='hs-varid'>new_virtHp</span>
<a name="line-12"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>hp_usage</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHpUsage</span>
<a name="line-13"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>setHpUsage</span> <span class='hs-layout'>(</span><span class='hs-varid'>hp_usage</span> <span class='hs-layout'>{</span><span class='hs-varid'>virtHp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_virtHp</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="getVirtHp"></a><span class='hs-definition'>getVirtHp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>VirtualHpOffset</span>
<a name="line-16"></a><span class='hs-definition'>getVirtHp</span> 
<a name="line-17"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>hp_usage</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHpUsage</span>
<a name="line-18"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>virtHp</span> <span class='hs-varid'>hp_usage</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="setRealHp"></a><span class='hs-definition'>setRealHp</span> <span class='hs-keyglyph'>::</span>  <span class='hs-conid'>VirtualHpOffset</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-21"></a><span class='hs-definition'>setRealHp</span> <span class='hs-varid'>new_realHp</span>
<a name="line-22"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>hp_usage</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHpUsage</span>
<a name="line-23"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>setHpUsage</span> <span class='hs-layout'>(</span><span class='hs-varid'>hp_usage</span> <span class='hs-layout'>{</span><span class='hs-varid'>realHp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_realHp</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="getHpRelOffset"></a><span class='hs-definition'>getHpRelOffset</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>VirtualHpOffset</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>CmmExpr</span>
<a name="line-26"></a><span class='hs-definition'>getHpRelOffset</span> <span class='hs-varid'>virtual_offset</span>
<a name="line-27"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>hp_usg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHpUsage</span>
<a name="line-28"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmmRegOffW</span> <span class='hs-varid'>hpReg</span> <span class='hs-layout'>(</span><span class='hs-varid'>hpRel</span> <span class='hs-layout'>(</span><span class='hs-varid'>realHp</span> <span class='hs-varid'>hp_usg</span><span class='hs-layout'>)</span> <span class='hs-varid'>virtual_offset</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}


%************************************************************************
%*									*
		Layout of heap objects
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="layOutDynConstr"></a><span class='hs-definition'>layOutDynConstr</span><span class='hs-layout'>,</span> <span class='hs-varid'>layOutStaticConstr</span>
<a name="line-2"></a>	<span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span>
<a name="line-3"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>CgRep</span><span class='hs-layout'>,</span><span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-4"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClosureInfo</span><span class='hs-layout'>,</span>
<a name="line-5"></a>	    <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-conid'>VirtualHpOffset</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-definition'>layOutDynConstr</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>layOutConstr</span> <span class='hs-conid'>False</span>
<a name="line-8"></a><a name="layOutStaticConstr"></a><span class='hs-definition'>layOutStaticConstr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>layOutConstr</span> <span class='hs-conid'>True</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="layOutConstr"></a><span class='hs-definition'>layOutConstr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>CgRep</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-11"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClosureInfo</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>VirtualHpOffset</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-12"></a><span class='hs-definition'>layOutConstr</span> <span class='hs-varid'>is_static</span> <span class='hs-varid'>data_con</span> <span class='hs-varid'>args</span>
<a name="line-13"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkConInfo</span> <span class='hs-varid'>is_static</span> <span class='hs-varid'>data_con</span> <span class='hs-varid'>tot_wds</span> <span class='hs-varid'>ptr_wds</span><span class='hs-layout'>,</span>
<a name="line-14"></a>      <span class='hs-varid'>things_w_offsets</span><span class='hs-layout'>)</span>
<a name="line-15"></a>  <span class='hs-keyword'>where</span>
<a name="line-16"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tot_wds</span><span class='hs-layout'>,</span>		 <span class='hs-comment'>--  #ptr_wds + #nonptr_wds</span>
<a name="line-17"></a>     <span class='hs-varid'>ptr_wds</span><span class='hs-layout'>,</span>		 <span class='hs-comment'>--  #ptr_wds</span>
<a name="line-18"></a>     <span class='hs-varid'>things_w_offsets</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVirtHeapOffsets</span> <span class='hs-conid'>False</span><span class='hs-comment'>{-not a thunk-}</span> <span class='hs-varid'>args</span>
</pre>\end{code}

@mkVirtHeapOffsets@ always returns boxed things with smaller offsets
than the unboxed things, and furthermore, the offsets in the result
list

\begin{code}
<pre><a name="line-1"></a><a name="mkVirtHeapOffsets"></a><span class='hs-definition'>mkVirtHeapOffsets</span>
<a name="line-2"></a>	  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>		<span class='hs-comment'>-- True &lt;=&gt; is a thunk</span>
<a name="line-3"></a>	  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>CgRep</span><span class='hs-layout'>,</span><span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>	<span class='hs-comment'>-- Things to make offsets for</span>
<a name="line-4"></a>	  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>WordOff</span><span class='hs-layout'>,</span>		<span class='hs-comment'>-- _Total_ number of words allocated</span>
<a name="line-5"></a>	      <span class='hs-conid'>WordOff</span><span class='hs-layout'>,</span>		<span class='hs-comment'>-- Number of words allocated for *pointers*</span>
<a name="line-6"></a>	      <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>VirtualHpOffset</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-7"></a>				<span class='hs-comment'>-- Things with their offsets from start of </span>
<a name="line-8"></a>				<span class='hs-comment'>--  object in order of increasing offset</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-comment'>-- First in list gets lowest offset, which is initial offset + 1.</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-definition'>mkVirtHeapOffsets</span> <span class='hs-varid'>is_thunk</span> <span class='hs-varid'>things</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>non_void_things</span>		      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterOut</span> <span class='hs-layout'>(</span><span class='hs-varid'>isVoidArg</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fst</span><span class='hs-layout'>)</span> <span class='hs-varid'>things</span>
<a name="line-14"></a>	<span class='hs-layout'>(</span><span class='hs-varid'>ptrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>non_ptrs</span><span class='hs-layout'>)</span>    	      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>separateByPtrFollowness</span> <span class='hs-varid'>non_void_things</span>
<a name="line-15"></a>    	<span class='hs-layout'>(</span><span class='hs-varid'>wds_of_ptrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptrs_w_offsets</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>computeOffset</span> <span class='hs-num'>0</span> <span class='hs-varid'>ptrs</span>
<a name="line-16"></a>	<span class='hs-layout'>(</span><span class='hs-varid'>tot_wds</span><span class='hs-layout'>,</span> <span class='hs-varid'>non_ptrs_w_offsets</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>computeOffset</span> <span class='hs-varid'>wds_of_ptrs</span> <span class='hs-varid'>non_ptrs</span>
<a name="line-17"></a>    <span class='hs-keyword'>in</span>
<a name="line-18"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tot_wds</span><span class='hs-layout'>,</span> <span class='hs-varid'>wds_of_ptrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptrs_w_offsets</span> <span class='hs-varop'>++</span> <span class='hs-varid'>non_ptrs_w_offsets</span><span class='hs-layout'>)</span>
<a name="line-19"></a>  <span class='hs-keyword'>where</span>
<a name="line-20"></a>    <span class='hs-varid'>hdr_size</span> 	<span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_thunk</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>thunkHdrSize</span>
<a name="line-21"></a>		<span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fixedHdrSize</span>
<a name="line-22"></a>
<a name="line-23"></a>    <span class='hs-varid'>computeOffset</span> <span class='hs-varid'>wds_so_far</span> <span class='hs-layout'>(</span><span class='hs-varid'>rep</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-24"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>wds_so_far</span> <span class='hs-varop'>+</span> <span class='hs-varid'>cgRepSizeW</span> <span class='hs-varid'>rep</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing</span><span class='hs-layout'>,</span> <span class='hs-varid'>hdr_size</span> <span class='hs-varop'>+</span> <span class='hs-varid'>wds_so_far</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*									*
		Lay out a static closure
%*									*
%************************************************************************

Make a static closure, adding on any extra padding needed for CAFs,
and adding a static link field if necessary.

\begin{code}
<pre><a name="line-1"></a><a name="mkStaticClosureFields"></a><span class='hs-definition'>mkStaticClosureFields</span> 
<a name="line-2"></a>	<span class='hs-keyglyph'>::</span> <span class='hs-conid'>ClosureInfo</span> 
<a name="line-3"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CostCentreStack</span> 
<a name="line-4"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> 		<span class='hs-comment'>-- Has CAF refs</span>
<a name="line-5"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmLit</span><span class='hs-keyglyph'>]</span>		<span class='hs-comment'>-- Payload</span>
<a name="line-6"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmLit</span><span class='hs-keyglyph'>]</span>		<span class='hs-comment'>-- The full closure</span>
<a name="line-7"></a><span class='hs-definition'>mkStaticClosureFields</span> <span class='hs-varid'>cl_info</span> <span class='hs-varid'>ccs</span> <span class='hs-varid'>caf_refs</span> <span class='hs-varid'>payload</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkStaticClosure</span> <span class='hs-varid'>info_lbl</span> <span class='hs-varid'>ccs</span> <span class='hs-varid'>payload</span> <span class='hs-varid'>padding_wds</span> 
<a name="line-9"></a>	<span class='hs-varid'>static_link_field</span> <span class='hs-varid'>saved_info_field</span>
<a name="line-10"></a>  <span class='hs-keyword'>where</span>
<a name="line-11"></a>    <span class='hs-varid'>info_lbl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>infoTableLabelFromCI</span> <span class='hs-varid'>cl_info</span>
<a name="line-12"></a>
<a name="line-13"></a>    <span class='hs-comment'>-- CAFs must have consistent layout, regardless of whether they</span>
<a name="line-14"></a>    <span class='hs-comment'>-- are actually updatable or not.  The layout of a CAF is:</span>
<a name="line-15"></a>    <span class='hs-comment'>--</span>
<a name="line-16"></a>    <span class='hs-comment'>--        3 saved_info</span>
<a name="line-17"></a>    <span class='hs-comment'>--        2 static_link</span>
<a name="line-18"></a>    <span class='hs-comment'>--        1 indirectee</span>
<a name="line-19"></a>    <span class='hs-comment'>--        0 info ptr</span>
<a name="line-20"></a>    <span class='hs-comment'>--</span>
<a name="line-21"></a>    <span class='hs-comment'>-- the static_link and saved_info fields must always be in the same</span>
<a name="line-22"></a>    <span class='hs-comment'>-- place.  So we use closureNeedsUpdSpace rather than</span>
<a name="line-23"></a>    <span class='hs-comment'>-- closureUpdReqd here:</span>
<a name="line-24"></a>
<a name="line-25"></a>    <span class='hs-varid'>is_caf</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>closureNeedsUpdSpace</span> <span class='hs-varid'>cl_info</span>
<a name="line-26"></a>
<a name="line-27"></a>    <span class='hs-varid'>padding_wds</span>
<a name="line-28"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>is_caf</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-29"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>payload</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkIntCLit</span> <span class='hs-num'>0</span><span class='hs-keyglyph'>]</span>
<a name="line-30"></a>
<a name="line-31"></a>    <span class='hs-varid'>static_link_field</span>
<a name="line-32"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_caf</span> <span class='hs-varop'>||</span> <span class='hs-varid'>staticClosureNeedsLink</span> <span class='hs-varid'>cl_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>static_link_value</span><span class='hs-keyglyph'>]</span>
<a name="line-33"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>				   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-34"></a>
<a name="line-35"></a>    <span class='hs-varid'>saved_info_field</span>
<a name="line-36"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_caf</span>     <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkIntCLit</span> <span class='hs-num'>0</span><span class='hs-keyglyph'>]</span>
<a name="line-37"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-38"></a>
<a name="line-39"></a>	<span class='hs-comment'>-- for a static constructor which has NoCafRefs, we set the</span>
<a name="line-40"></a>	<span class='hs-comment'>-- static link field to a non-zero value so the garbage</span>
<a name="line-41"></a>	<span class='hs-comment'>-- collector will ignore it.</span>
<a name="line-42"></a>    <span class='hs-varid'>static_link_value</span>
<a name="line-43"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-varid'>caf_refs</span>	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkIntCLit</span> <span class='hs-num'>0</span>
<a name="line-44"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkIntCLit</span> <span class='hs-num'>1</span>
<a name="line-45"></a>
<a name="line-46"></a><a name="mkStaticClosure"></a><span class='hs-definition'>mkStaticClosure</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CLabel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CostCentreStack</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmLit</span><span class='hs-keyglyph'>]</span>
<a name="line-47"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmLit</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmLit</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmLit</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmLit</span><span class='hs-keyglyph'>]</span>
<a name="line-48"></a><span class='hs-definition'>mkStaticClosure</span> <span class='hs-varid'>info_lbl</span> <span class='hs-varid'>ccs</span> <span class='hs-varid'>payload</span> <span class='hs-varid'>padding_wds</span> <span class='hs-varid'>static_link_field</span> <span class='hs-varid'>saved_info_field</span>
<a name="line-49"></a>  <span class='hs-keyglyph'>=</span>  <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmLabel</span> <span class='hs-varid'>info_lbl</span><span class='hs-keyglyph'>]</span>
<a name="line-50"></a>  <span class='hs-varop'>++</span> <span class='hs-varid'>variable_header_words</span>
<a name="line-51"></a>  <span class='hs-varop'>++</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>padLitToWord</span> <span class='hs-varid'>payload</span>
<a name="line-52"></a>  <span class='hs-varop'>++</span> <span class='hs-varid'>padding_wds</span>
<a name="line-53"></a>  <span class='hs-varop'>++</span> <span class='hs-varid'>static_link_field</span>
<a name="line-54"></a>  <span class='hs-varop'>++</span> <span class='hs-varid'>saved_info_field</span>
<a name="line-55"></a>  <span class='hs-keyword'>where</span>
<a name="line-56"></a>    <span class='hs-varid'>variable_header_words</span>
<a name="line-57"></a>	<span class='hs-keyglyph'>=</span>  <span class='hs-varid'>staticGranHdr</span>
<a name="line-58"></a>	<span class='hs-varop'>++</span> <span class='hs-varid'>staticParHdr</span>
<a name="line-59"></a>	<span class='hs-varop'>++</span> <span class='hs-varid'>staticProfHdr</span> <span class='hs-varid'>ccs</span>
<a name="line-60"></a>	<span class='hs-varop'>++</span> <span class='hs-varid'>staticTickyHdr</span>
<a name="line-61"></a>
<a name="line-62"></a><a name="padLitToWord"></a><span class='hs-definition'>padLitToWord</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmLit</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmLit</span><span class='hs-keyglyph'>]</span>
<a name="line-63"></a><span class='hs-definition'>padLitToWord</span> <span class='hs-varid'>lit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lit</span> <span class='hs-conop'>:</span> <span class='hs-varid'>padding</span> <span class='hs-varid'>pad_length</span>
<a name="line-64"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>width</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeWidth</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmmLitType</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span>
<a name="line-65"></a>        <span class='hs-varid'>pad_length</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wORD_SIZE</span> <span class='hs-comment'>-</span> <span class='hs-varid'>widthInBytes</span> <span class='hs-varid'>width</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-66"></a>
<a name="line-67"></a>        <span class='hs-varid'>padding</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;=</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-68"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>`rem`</span> <span class='hs-num'>2</span> <span class='hs-varop'>/=</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmInt</span> <span class='hs-num'>0</span> <span class='hs-conid'>W8</span>  <span class='hs-conop'>:</span> <span class='hs-varid'>padding</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-69"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>`rem`</span> <span class='hs-num'>4</span> <span class='hs-varop'>/=</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmInt</span> <span class='hs-num'>0</span> <span class='hs-conid'>W16</span> <span class='hs-conop'>:</span> <span class='hs-varid'>padding</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>2</span><span class='hs-layout'>)</span>
<a name="line-70"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>`rem`</span> <span class='hs-num'>8</span> <span class='hs-varop'>/=</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmInt</span> <span class='hs-num'>0</span> <span class='hs-conid'>W32</span> <span class='hs-conop'>:</span> <span class='hs-varid'>padding</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>4</span><span class='hs-layout'>)</span>
<a name="line-71"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmInt</span> <span class='hs-num'>0</span> <span class='hs-conid'>W64</span> <span class='hs-conop'>:</span> <span class='hs-varid'>padding</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>8</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*									*
\subsection[CgHeapery-heap-overflow]{Heap overflow checking}
%*									*
%************************************************************************

The new code  for heapChecks. For GrAnSim the code for doing a heap check
and doing a context switch has been separated. Especially, the HEAP_CHK
macro only performs a heap check. THREAD_CONTEXT_SWITCH should be used for
doing a context switch. GRAN_FETCH_AND_RESCHEDULE must be put at the
beginning of every slow entry code in order to simulate the fetching of
closures. If fetching is necessary (i.e. current closure is not local) then
an automatic context switch is done.

--------------------------------------------------------------
A heap/stack check at a function or thunk entry point.

\begin{code}
<pre><a name="line-1"></a><a name="funEntryChecks"></a><span class='hs-definition'>funEntryChecks</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ClosureInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmStmts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-2"></a><span class='hs-definition'>funEntryChecks</span> <span class='hs-varid'>cl_info</span> <span class='hs-varid'>reg_save_code</span> <span class='hs-varid'>code</span> 
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hpStkCheck</span> <span class='hs-varid'>cl_info</span> <span class='hs-conid'>True</span> <span class='hs-varid'>reg_save_code</span> <span class='hs-varid'>code</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="thunkEntryChecks"></a><span class='hs-definition'>thunkEntryChecks</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ClosureInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-6"></a><span class='hs-definition'>thunkEntryChecks</span> <span class='hs-varid'>cl_info</span> <span class='hs-varid'>code</span> 
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hpStkCheck</span> <span class='hs-varid'>cl_info</span> <span class='hs-conid'>False</span> <span class='hs-varid'>noStmts</span> <span class='hs-varid'>code</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="hpStkCheck"></a><span class='hs-definition'>hpStkCheck</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ClosureInfo</span>	<span class='hs-comment'>-- Function closure</span>
<a name="line-10"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> 		<span class='hs-comment'>-- Is a function? (not a thunk)</span>
<a name="line-11"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmStmts</span>		<span class='hs-comment'>-- Register saves</span>
<a name="line-12"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-13"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-14"></a>
<a name="line-15"></a><span class='hs-definition'>hpStkCheck</span> <span class='hs-varid'>cl_info</span> <span class='hs-varid'>is_fun</span> <span class='hs-varid'>reg_save_code</span> <span class='hs-varid'>code</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>getFinalStackHW</span>	<span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>spHw</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-17"></a>	<span class='hs-layout'>{</span> <span class='hs-varid'>sp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getRealSp</span>
<a name="line-18"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>stk_words</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>spHw</span> <span class='hs-comment'>-</span> <span class='hs-varid'>sp</span>
<a name="line-19"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>initHeapUsage</span>	<span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>hpHw</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-20"></a>	    <span class='hs-layout'>{</span>	<span class='hs-comment'>-- Emit heap checks, but be sure to do it lazily so </span>
<a name="line-21"></a>		<span class='hs-comment'>-- that the conditionals on hpHw don't cause a black hole</span>
<a name="line-22"></a>	      <span class='hs-varid'>codeOnly</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-23"></a>		<span class='hs-layout'>{</span> <span class='hs-varid'>do_checks</span> <span class='hs-varid'>stk_words</span> <span class='hs-varid'>hpHw</span> <span class='hs-varid'>full_save_code</span> <span class='hs-varid'>rts_label</span>
<a name="line-24"></a>		<span class='hs-layout'>;</span> <span class='hs-varid'>tickyAllocHeap</span> <span class='hs-varid'>hpHw</span> <span class='hs-layout'>}</span>
<a name="line-25"></a>	    <span class='hs-layout'>;</span> <span class='hs-varid'>setRealHp</span> <span class='hs-varid'>hpHw</span>
<a name="line-26"></a>	    <span class='hs-layout'>;</span> <span class='hs-varid'>code</span> <span class='hs-layout'>}</span>
<a name="line-27"></a>	<span class='hs-layout'>}</span>
<a name="line-28"></a>  <span class='hs-keyword'>where</span>
<a name="line-29"></a>    <span class='hs-varid'>node_asst</span> 
<a name="line-30"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-varid'>nodeMustPointToIt</span> <span class='hs-layout'>(</span><span class='hs-varid'>closureLFInfo</span> <span class='hs-varid'>cl_info</span><span class='hs-layout'>)</span>
<a name="line-31"></a>	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>noStmts</span>
<a name="line-32"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-33"></a>	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>oneStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmAssign</span> <span class='hs-varid'>nodeReg</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLabel</span> <span class='hs-varid'>closure_lbl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-34"></a>        <span class='hs-comment'>-- Strictly speaking, we should tag node here.  But if</span>
<a name="line-35"></a>        <span class='hs-comment'>-- node doesn't point to the closure, the code for the closure</span>
<a name="line-36"></a>        <span class='hs-comment'>-- cannot depend on the value of R1 anyway, so we're safe.</span>
<a name="line-37"></a>    <span class='hs-varid'>closure_lbl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>closureLabelFromCI</span> <span class='hs-varid'>cl_info</span>
<a name="line-38"></a>
<a name="line-39"></a>    <span class='hs-varid'>full_save_code</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>node_asst</span> <span class='hs-varop'>`plusStmts`</span> <span class='hs-varid'>reg_save_code</span>
<a name="line-40"></a>
<a name="line-41"></a>    <span class='hs-varid'>rts_label</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_fun</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmReg</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmGlobal</span> <span class='hs-conid'>GCFun</span><span class='hs-layout'>)</span>
<a name="line-42"></a>				<span class='hs-comment'>-- Function entry point</span>
<a name="line-43"></a>	      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmReg</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmGlobal</span> <span class='hs-conid'>GCEnter1</span><span class='hs-layout'>)</span>
<a name="line-44"></a>				<span class='hs-comment'>-- Thunk or case return</span>
<a name="line-45"></a>	<span class='hs-comment'>-- In the thunk/case-return case, R1 points to a closure</span>
<a name="line-46"></a>	<span class='hs-comment'>-- which should be (re)-entered after GC</span>
</pre>\end{code}

Heap checks in a case alternative are nice and easy, provided this is
a bog-standard algebraic case.  We have in our hand:

       * one return address, on the stack,
       * one return value, in Node.

the canned code for this heap check failure just pushes Node on the
stack, saying 'EnterGHC' to return.  The scheduler will return by
entering the top value on the stack, which in turn will return through
the return address, getting us back to where we were.  This is
therefore only valid if the return value is *lifted* (just being
boxed isn't good enough).

For primitive returns, we have an unlifted value in some register
(either R1 or FloatReg1 or DblReg1).  This means using specialised
heap-check code for these cases.

\begin{code}
<pre><a name="line-1"></a><a name="altHeapCheck"></a><span class='hs-definition'>altHeapCheck</span> 
<a name="line-2"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AltType</span>	<span class='hs-comment'>-- PolyAlt, PrimAlt, AlgAlt, but *not* UbxTupAlt</span>
<a name="line-3"></a>		<span class='hs-comment'>--	(Unboxed tuples are dealt with by ubxTupleHeapCheck)</span>
<a name="line-4"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>	<span class='hs-comment'>-- Continuation</span>
<a name="line-5"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-6"></a><span class='hs-definition'>altHeapCheck</span> <span class='hs-varid'>alt_type</span> <span class='hs-varid'>code</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initHeapUsage</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>hpHw</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-8"></a>	<span class='hs-layout'>{</span> <span class='hs-varid'>codeOnly</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-9"></a>	     <span class='hs-layout'>{</span> <span class='hs-varid'>do_checks</span> <span class='hs-num'>0</span> <span class='hs-comment'>{- no stack chk -}</span> <span class='hs-varid'>hpHw</span>
<a name="line-10"></a>			 <span class='hs-varid'>noStmts</span> <span class='hs-comment'>{- nothign to save -}</span>
<a name="line-11"></a>			 <span class='hs-layout'>(</span><span class='hs-varid'>rts_label</span> <span class='hs-varid'>alt_type</span><span class='hs-layout'>)</span>
<a name="line-12"></a>	     <span class='hs-layout'>;</span> <span class='hs-varid'>tickyAllocHeap</span> <span class='hs-varid'>hpHw</span> <span class='hs-layout'>}</span>
<a name="line-13"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>setRealHp</span> <span class='hs-varid'>hpHw</span>
<a name="line-14"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>code</span> <span class='hs-layout'>}</span>
<a name="line-15"></a>  <span class='hs-keyword'>where</span>
<a name="line-16"></a>    <span class='hs-varid'>rts_label</span> <span class='hs-conid'>PolyAlt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLabel</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCmmCodeLabel</span> <span class='hs-varid'>rtsPackageId</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"stg_gc_unpt_r1"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-17"></a>      	<span class='hs-comment'>-- Do *not* enter R1 after a heap check in</span>
<a name="line-18"></a>	<span class='hs-comment'>-- a polymorphic case.  It might be a function</span>
<a name="line-19"></a>	<span class='hs-comment'>-- and the entry code for a function (currently)</span>
<a name="line-20"></a>	<span class='hs-comment'>-- applies it</span>
<a name="line-21"></a>	<span class='hs-comment'>--</span>
<a name="line-22"></a>	<span class='hs-comment'>-- However R1 is guaranteed to be a pointer</span>
<a name="line-23"></a>
<a name="line-24"></a>    <span class='hs-varid'>rts_label</span> <span class='hs-layout'>(</span><span class='hs-conid'>AlgAlt</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stg_gc_enter1</span>
<a name="line-25"></a>	<span class='hs-comment'>-- Enter R1 after the heap check; it's a pointer</span>
<a name="line-26"></a> 	
<a name="line-27"></a>    <span class='hs-varid'>rts_label</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimAlt</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-28"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmLit</span> <span class='hs-varop'>$</span> <span class='hs-conid'>CmmLabel</span> <span class='hs-varop'>$</span> 
<a name="line-29"></a>	<span class='hs-keyword'>case</span> <span class='hs-varid'>primRepToCgRep</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConPrimRep</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-30"></a>	  <span class='hs-conid'>VoidArg</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkCmmCodeLabel</span> <span class='hs-varid'>rtsPackageId</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"stg_gc_noregs"</span><span class='hs-layout'>)</span>
<a name="line-31"></a>	  <span class='hs-conid'>FloatArg</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkCmmCodeLabel</span> <span class='hs-varid'>rtsPackageId</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"stg_gc_f1"</span><span class='hs-layout'>)</span>
<a name="line-32"></a>	  <span class='hs-conid'>DoubleArg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkCmmCodeLabel</span> <span class='hs-varid'>rtsPackageId</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"stg_gc_d1"</span><span class='hs-layout'>)</span>
<a name="line-33"></a>	  <span class='hs-conid'>LongArg</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkCmmCodeLabel</span> <span class='hs-varid'>rtsPackageId</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"stg_gc_l1"</span><span class='hs-layout'>)</span>
<a name="line-34"></a>				<span class='hs-comment'>-- R1 is boxed but unlifted: </span>
<a name="line-35"></a>	  <span class='hs-conid'>PtrArg</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkCmmCodeLabel</span> <span class='hs-varid'>rtsPackageId</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"stg_gc_unpt_r1"</span><span class='hs-layout'>)</span>
<a name="line-36"></a>				<span class='hs-comment'>-- R1 is unboxed:</span>
<a name="line-37"></a>	  <span class='hs-conid'>NonPtrArg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkCmmCodeLabel</span> <span class='hs-varid'>rtsPackageId</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"stg_gc_unbx_r1"</span><span class='hs-layout'>)</span>
<a name="line-38"></a>
<a name="line-39"></a>    <span class='hs-varid'>rts_label</span> <span class='hs-layout'>(</span><span class='hs-conid'>UbxTupAlt</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"altHeapCheck"</span>
</pre>\end{code}


Unboxed tuple alternatives and let-no-escapes (the two most annoying
constructs to generate code for!)  For unboxed tuple returns, there
are an arbitrary number of possibly unboxed return values, some of
which will be in registers, and the others will be on the stack.  We
always organise the stack-resident fields into pointers &
non-pointers, and pass the number of each to the heap check code.

\begin{code}
<pre><a name="line-1"></a><a name="unbxTupleHeapCheck"></a><span class='hs-definition'>unbxTupleHeapCheck</span> 
<a name="line-2"></a>	<span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>GlobalReg</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>	<span class='hs-comment'>-- Live registers</span>
<a name="line-3"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WordOff</span>	<span class='hs-comment'>-- no. of stack slots containing ptrs</span>
<a name="line-4"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WordOff</span>	<span class='hs-comment'>-- no. of stack slots containing nonptrs</span>
<a name="line-5"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmStmts</span>	<span class='hs-comment'>-- code to insert in the failure path</span>
<a name="line-6"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-7"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-definition'>unbxTupleHeapCheck</span> <span class='hs-varid'>regs</span> <span class='hs-varid'>ptrs</span> <span class='hs-varid'>nptrs</span> <span class='hs-varid'>fail_code</span> <span class='hs-varid'>code</span>
<a name="line-10"></a>  <span class='hs-comment'>-- We can't manage more than 255 pointers/non-pointers </span>
<a name="line-11"></a>  <span class='hs-comment'>-- in a generic heap check.</span>
<a name="line-12"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ptrs</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>255</span> <span class='hs-varop'>||</span> <span class='hs-varid'>nptrs</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>255</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"altHeapCheck"</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> 
<a name="line-14"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initHeapUsage</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>hpHw</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-15"></a>	<span class='hs-layout'>{</span> <span class='hs-varid'>codeOnly</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>do_checks</span> <span class='hs-num'>0</span> <span class='hs-comment'>{- no stack check -}</span> <span class='hs-varid'>hpHw</span>
<a name="line-16"></a>				    <span class='hs-varid'>full_fail_code</span> <span class='hs-varid'>rts_label</span>
<a name="line-17"></a>			<span class='hs-layout'>;</span> <span class='hs-varid'>tickyAllocHeap</span> <span class='hs-varid'>hpHw</span> <span class='hs-layout'>}</span>
<a name="line-18"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>setRealHp</span> <span class='hs-varid'>hpHw</span>
<a name="line-19"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>code</span> <span class='hs-layout'>}</span>
<a name="line-20"></a>  <span class='hs-keyword'>where</span>
<a name="line-21"></a>    <span class='hs-varid'>full_fail_code</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fail_code</span> <span class='hs-varop'>`plusStmts`</span> <span class='hs-varid'>oneStmt</span> <span class='hs-varid'>assign_liveness</span>
<a name="line-22"></a>    <span class='hs-varid'>assign_liveness</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmAssign</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>VanillaReg</span> <span class='hs-num'>9</span> <span class='hs-conid'>VNonGcPtr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 	<span class='hs-comment'>-- Ho ho ho!</span>
<a name="line-23"></a>				<span class='hs-layout'>(</span><span class='hs-conid'>CmmLit</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkWordCLit</span> <span class='hs-varid'>liveness</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-24"></a>    <span class='hs-varid'>liveness</span> 	    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRegLiveness</span> <span class='hs-varid'>regs</span> <span class='hs-varid'>ptrs</span> <span class='hs-varid'>nptrs</span>
<a name="line-25"></a>    <span class='hs-varid'>rts_label</span>	    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLabel</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCmmCodeLabel</span> <span class='hs-varid'>rtsPackageId</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"stg_gc_ut"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-26"></a>
</pre>\end{code}


%************************************************************************
%*									*
		Heap/Stack Checks.
%*									*
%************************************************************************

When failing a check, we save a return address on the stack and
jump to a pre-compiled code fragment that saves the live registers
and returns to the scheduler.

The return address in most cases will be the beginning of the basic
block in which the check resides, since we need to perform the check
again on re-entry because someone else might have stolen the resource
in the meantime.

\begin{code}
<pre><a name="line-1"></a><a name="do_checks"></a><span class='hs-definition'>do_checks</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WordOff</span>	<span class='hs-comment'>-- Stack headroom</span>
<a name="line-2"></a>	  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WordOff</span>	<span class='hs-comment'>-- Heap  headroom</span>
<a name="line-3"></a>	  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmStmts</span>	<span class='hs-comment'>-- Assignments to perform on failure</span>
<a name="line-4"></a>	  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmExpr</span>	<span class='hs-comment'>-- Rts address to jump to on failure</span>
<a name="line-5"></a>	  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-6"></a><span class='hs-definition'>do_checks</span> <span class='hs-num'>0</span> <span class='hs-num'>0</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nopC</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-definition'>do_checks</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>hp</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>hp</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>bLOCKS_PER_MBLOCK</span> <span class='hs-varop'>*</span> <span class='hs-varid'>bLOCK_SIZE_W</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sorry</span> <span class='hs-layout'>(</span><span class='hs-varid'>unlines</span> <span class='hs-keyglyph'>[</span>
<a name="line-11"></a>            <span class='hs-str'>"Trying to allocate more than "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-varid'>bLOCKS_PER_MBLOCK</span> <span class='hs-varop'>*</span> <span class='hs-varid'>bLOCK_SIZE</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-str'>" bytes."</span><span class='hs-layout'>,</span> 
<a name="line-12"></a>            <span class='hs-str'>""</span><span class='hs-layout'>,</span>
<a name="line-13"></a>            <span class='hs-str'>"See: http://hackage.haskell.org/trac/ghc/ticket/4505"</span><span class='hs-layout'>,</span>
<a name="line-14"></a>            <span class='hs-str'>"Suggestion: read data from a file instead of having large static data"</span><span class='hs-layout'>,</span>
<a name="line-15"></a>            <span class='hs-str'>"structures in the code."</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-16"></a>
<a name="line-17"></a><span class='hs-definition'>do_checks</span> <span class='hs-varid'>stk</span> <span class='hs-varid'>hp</span> <span class='hs-varid'>reg_save_code</span> <span class='hs-varid'>rts_lbl</span>
<a name="line-18"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>do_checks'</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLit</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkIntCLit</span> <span class='hs-layout'>(</span><span class='hs-varid'>stk</span><span class='hs-varop'>*</span><span class='hs-varid'>wORD_SIZE</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-19"></a>	       <span class='hs-layout'>(</span><span class='hs-conid'>CmmLit</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkIntCLit</span> <span class='hs-layout'>(</span><span class='hs-varid'>hp</span><span class='hs-varop'>*</span><span class='hs-varid'>wORD_SIZE</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-20"></a>	 <span class='hs-layout'>(</span><span class='hs-varid'>stk</span> <span class='hs-varop'>/=</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>hp</span> <span class='hs-varop'>/=</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-varid'>reg_save_code</span> <span class='hs-varid'>rts_lbl</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="do_checks'"></a><span class='hs-comment'>-- The offsets are now in *bytes*</span>
<a name="line-23"></a><span class='hs-definition'>do_checks'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmStmts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-24"></a><span class='hs-definition'>do_checks'</span> <span class='hs-varid'>stk_expr</span> <span class='hs-varid'>hp_expr</span> <span class='hs-varid'>stk_nonzero</span> <span class='hs-varid'>hp_nonzero</span> <span class='hs-varid'>reg_save_code</span> <span class='hs-varid'>rts_lbl</span>
<a name="line-25"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>doGranAllocate</span> <span class='hs-varid'>hp_expr</span>
<a name="line-26"></a>
<a name="line-27"></a>        <span class='hs-comment'>-- The failure block: this saves the registers and jumps to</span>
<a name="line-28"></a>        <span class='hs-comment'>-- the appropriate RTS stub.</span>
<a name="line-29"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>exit_blk_id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>forkLabelledCode</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-30"></a>			<span class='hs-layout'>;</span> <span class='hs-varid'>emitStmts</span> <span class='hs-varid'>reg_save_code</span>
<a name="line-31"></a>			<span class='hs-layout'>;</span> <span class='hs-varid'>stmtC</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmJump</span> <span class='hs-varid'>rts_lbl</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-32"></a>
<a name="line-33"></a>	<span class='hs-comment'>-- In the case of a heap-check failure, we must also set</span>
<a name="line-34"></a>	<span class='hs-comment'>-- HpAlloc.  NB. HpAlloc is *only* set if Hp has been</span>
<a name="line-35"></a>	<span class='hs-comment'>-- incremented by the heap check, it must not be set in the</span>
<a name="line-36"></a>	<span class='hs-comment'>-- event that a stack check failed, because the RTS stub will</span>
<a name="line-37"></a>	<span class='hs-comment'>-- retreat Hp by HpAlloc.</span>
<a name="line-38"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>hp_blk_id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>hp_nonzero</span>
<a name="line-39"></a>                          <span class='hs-keyword'>then</span> <span class='hs-varid'>forkLabelledCode</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-40"></a>				  <span class='hs-varid'>stmtC</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmAssign</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmGlobal</span> <span class='hs-conid'>HpAlloc</span><span class='hs-layout'>)</span> <span class='hs-varid'>hp_expr</span><span class='hs-layout'>)</span>
<a name="line-41"></a>				  <span class='hs-varid'>stmtC</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmBranch</span> <span class='hs-varid'>exit_blk_id</span><span class='hs-layout'>)</span>
<a name="line-42"></a>                          <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-varid'>exit_blk_id</span>
<a name="line-43"></a>
<a name="line-44"></a>	<span class='hs-comment'>-- Check for stack overflow *FIRST*; otherwise</span>
<a name="line-45"></a>	<span class='hs-comment'>-- we might bumping Hp and then failing stack oflo</span>
<a name="line-46"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>whenC</span> <span class='hs-varid'>stk_nonzero</span>
<a name="line-47"></a>		<span class='hs-layout'>(</span><span class='hs-varid'>stmtC</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmCondBranch</span> <span class='hs-varid'>stk_oflo</span> <span class='hs-varid'>exit_blk_id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-48"></a>
<a name="line-49"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>whenC</span> <span class='hs-varid'>hp_nonzero</span>
<a name="line-50"></a>		<span class='hs-layout'>(</span><span class='hs-varid'>stmtsC</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmAssign</span> <span class='hs-varid'>hpReg</span> 
<a name="line-51"></a>				<span class='hs-layout'>(</span><span class='hs-varid'>cmmOffsetExprB</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-varid'>hpReg</span><span class='hs-layout'>)</span> <span class='hs-varid'>hp_expr</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-52"></a>		        <span class='hs-conid'>CmmCondBranch</span> <span class='hs-varid'>hp_oflo</span> <span class='hs-varid'>hp_blk_id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-53"></a>		<span class='hs-comment'>-- Bump heap pointer, and test for heap exhaustion</span>
<a name="line-54"></a>		<span class='hs-comment'>-- Note that we don't move the heap pointer unless the </span>
<a name="line-55"></a>		<span class='hs-comment'>-- stack check succeeds.  Otherwise we might end up</span>
<a name="line-56"></a>		<span class='hs-comment'>-- with slop at the end of the current block, which can </span>
<a name="line-57"></a>		<span class='hs-comment'>-- confuse the LDV profiler.</span>
<a name="line-58"></a>    <span class='hs-layout'>}</span>
<a name="line-59"></a>  <span class='hs-keyword'>where</span>
<a name="line-60"></a>	<span class='hs-comment'>-- Stk overflow if (Sp - stk_bytes &lt; SpLim)</span>
<a name="line-61"></a>    <span class='hs-varid'>stk_oflo</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmMachOp</span> <span class='hs-varid'>mo_wordULt</span> 
<a name="line-62"></a>		  <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmMachOp</span> <span class='hs-varid'>mo_wordSub</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmReg</span> <span class='hs-varid'>spReg</span><span class='hs-layout'>,</span> <span class='hs-varid'>stk_expr</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-63"></a>		   <span class='hs-conid'>CmmReg</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmGlobal</span> <span class='hs-conid'>SpLim</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-64"></a>
<a name="line-65"></a>	<span class='hs-comment'>-- Hp overflow if (Hp &gt; HpLim)</span>
<a name="line-66"></a>	<span class='hs-comment'>-- (Hp has been incremented by now)</span>
<a name="line-67"></a>	<span class='hs-comment'>-- HpLim points to the LAST WORD of valid allocation space.</span>
<a name="line-68"></a>    <span class='hs-varid'>hp_oflo</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmMachOp</span> <span class='hs-varid'>mo_wordUGt</span> 
<a name="line-69"></a>		  <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmReg</span> <span class='hs-varid'>hpReg</span><span class='hs-layout'>,</span> <span class='hs-conid'>CmmReg</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmGlobal</span> <span class='hs-conid'>HpLim</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
</pre>\end{code}

%************************************************************************
%*									*
     Generic Heap/Stack Checks - used in the RTS
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="hpChkGen"></a><span class='hs-definition'>hpChkGen</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-2"></a><span class='hs-definition'>hpChkGen</span> <span class='hs-varid'>bytes</span> <span class='hs-varid'>liveness</span> <span class='hs-varid'>reentry</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>do_checks'</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLit</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkIntCLit</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>bytes</span> <span class='hs-conid'>False</span> <span class='hs-conid'>True</span> <span class='hs-varid'>assigns</span> <span class='hs-varid'>stg_gc_gen</span>
<a name="line-4"></a>  <span class='hs-keyword'>where</span>
<a name="line-5"></a>    <span class='hs-varid'>assigns</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkStmts</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>mk_vanilla_assignment</span> <span class='hs-num'>9</span> <span class='hs-varid'>liveness</span><span class='hs-layout'>,</span>
<a name="line-6"></a>	    		<span class='hs-varid'>mk_vanilla_assignment</span> <span class='hs-num'>10</span> <span class='hs-varid'>reentry</span> <span class='hs-keyglyph'>]</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="hpChkNodePointsAssignSp0"></a><span class='hs-comment'>-- a heap check where R1 points to the closure to enter on return, and</span>
<a name="line-9"></a><span class='hs-comment'>-- we want to assign to Sp[0] on failure (used in AutoApply.cmm:BUILD_PAP).</span>
<a name="line-10"></a><span class='hs-definition'>hpChkNodePointsAssignSp0</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-11"></a><span class='hs-definition'>hpChkNodePointsAssignSp0</span> <span class='hs-varid'>bytes</span> <span class='hs-varid'>sp0</span>
<a name="line-12"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>do_checks'</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLit</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkIntCLit</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>bytes</span> <span class='hs-conid'>False</span> <span class='hs-conid'>True</span> <span class='hs-varid'>assign</span> <span class='hs-varid'>stg_gc_enter1</span>
<a name="line-13"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>assign</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>oneStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmStore</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-varid'>spReg</span><span class='hs-layout'>)</span> <span class='hs-varid'>sp0</span><span class='hs-layout'>)</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="stkChkGen"></a><span class='hs-definition'>stkChkGen</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-16"></a><span class='hs-definition'>stkChkGen</span> <span class='hs-varid'>bytes</span> <span class='hs-varid'>liveness</span> <span class='hs-varid'>reentry</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>do_checks'</span> <span class='hs-varid'>bytes</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLit</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkIntCLit</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conid'>True</span> <span class='hs-conid'>False</span> <span class='hs-varid'>assigns</span> <span class='hs-varid'>stg_gc_gen</span>
<a name="line-18"></a>  <span class='hs-keyword'>where</span>
<a name="line-19"></a>    <span class='hs-varid'>assigns</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkStmts</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>mk_vanilla_assignment</span> <span class='hs-num'>9</span> <span class='hs-varid'>liveness</span><span class='hs-layout'>,</span>
<a name="line-20"></a>	    		<span class='hs-varid'>mk_vanilla_assignment</span> <span class='hs-num'>10</span> <span class='hs-varid'>reentry</span> <span class='hs-keyglyph'>]</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="mk_vanilla_assignment"></a><span class='hs-definition'>mk_vanilla_assignment</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmStmt</span>
<a name="line-23"></a><span class='hs-definition'>mk_vanilla_assignment</span> <span class='hs-varid'>n</span> <span class='hs-varid'>e</span>
<a name="line-24"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmAssign</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>VanillaReg</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>vgcFlag</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmmExprType</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="stkChkNodePoints"></a><span class='hs-definition'>stkChkNodePoints</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-27"></a><span class='hs-definition'>stkChkNodePoints</span> <span class='hs-varid'>bytes</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>do_checks'</span> <span class='hs-varid'>bytes</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLit</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkIntCLit</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conid'>True</span> <span class='hs-conid'>False</span> <span class='hs-varid'>noStmts</span> <span class='hs-varid'>stg_gc_enter1</span>
<a name="line-29"></a>
<a name="line-30"></a><a name="stg_gc_gen"></a><span class='hs-definition'>stg_gc_gen</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmExpr</span>
<a name="line-31"></a><span class='hs-definition'>stg_gc_gen</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLabel</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCmmCodeLabel</span> <span class='hs-varid'>rtsPackageId</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"stg_gc_gen"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-32"></a><a name="stg_gc_enter1"></a><span class='hs-definition'>stg_gc_enter1</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmExpr</span>
<a name="line-33"></a><span class='hs-definition'>stg_gc_enter1</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmReg</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmGlobal</span> <span class='hs-conid'>GCEnter1</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*									*
\subsection[initClosure]{Initialise a dynamic closure}
%*									*
%************************************************************************

@allocDynClosure@ puts the thing in the heap, and modifies the virtual Hp
to account for this.

\begin{code}
<pre><a name="line-1"></a><a name="allocDynClosure"></a><span class='hs-definition'>allocDynClosure</span>
<a name="line-2"></a>	<span class='hs-keyglyph'>::</span> <span class='hs-conid'>ClosureInfo</span>
<a name="line-3"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmExpr</span> 		<span class='hs-comment'>-- Cost Centre to stick in the object</span>
<a name="line-4"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmExpr</span> 		<span class='hs-comment'>-- Cost Centre to blame for this alloc</span>
<a name="line-5"></a>				<span class='hs-comment'>-- (usually the same; sometimes "OVERHEAD")</span>
<a name="line-6"></a>
<a name="line-7"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>CmmExpr</span><span class='hs-layout'>,</span> <span class='hs-conid'>VirtualHpOffset</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>	<span class='hs-comment'>-- Offsets from start of the object</span>
<a name="line-8"></a>					<span class='hs-comment'>-- ie Info ptr has offset zero.</span>
<a name="line-9"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>VirtualHpOffset</span>	<span class='hs-comment'>-- Returns virt offset of object</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-definition'>allocDynClosure</span> <span class='hs-varid'>cl_info</span> <span class='hs-varid'>use_cc</span> <span class='hs-sel'>_blame_cc</span> <span class='hs-varid'>amodes_with_offsets</span>
<a name="line-12"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>virt_hp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getVirtHp</span>
<a name="line-13"></a>
<a name="line-14"></a>	<span class='hs-comment'>-- FIND THE OFFSET OF THE INFO-PTR WORD</span>
<a name="line-15"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span>	<span class='hs-varid'>info_offset</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>virt_hp</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span>
<a name="line-16"></a>		<span class='hs-comment'>-- info_offset is the VirtualHpOffset of the first</span>
<a name="line-17"></a>		<span class='hs-comment'>-- word of the new object</span>
<a name="line-18"></a>		<span class='hs-comment'>-- Remember, virtHp points to last allocated word, </span>
<a name="line-19"></a>		<span class='hs-comment'>-- ie 1 *before* the info-ptr word of new object.</span>
<a name="line-20"></a>
<a name="line-21"></a>		<span class='hs-varid'>info_ptr</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLabel</span> <span class='hs-layout'>(</span><span class='hs-varid'>infoTableLabelFromCI</span> <span class='hs-varid'>cl_info</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-22"></a>		<span class='hs-varid'>hdr_w_offsets</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initDynHdr</span> <span class='hs-varid'>info_ptr</span> <span class='hs-varid'>use_cc</span> <span class='hs-varop'>`zip`</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>0</span><span class='hs-keyglyph'>..</span><span class='hs-keyglyph'>]</span>
<a name="line-23"></a>
<a name="line-24"></a>	<span class='hs-comment'>-- SAY WHAT WE ARE ABOUT TO DO</span>
<a name="line-25"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>profDynAlloc</span> <span class='hs-varid'>cl_info</span> <span class='hs-varid'>use_cc</span>	
<a name="line-26"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>tickyDynAlloc</span> <span class='hs-varid'>cl_info</span>
<a name="line-27"></a>
<a name="line-28"></a>	<span class='hs-comment'>-- ALLOCATE THE OBJECT</span>
<a name="line-29"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>base</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHpRelOffset</span> <span class='hs-varid'>info_offset</span>
<a name="line-30"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>hpStore</span> <span class='hs-varid'>base</span> <span class='hs-layout'>(</span><span class='hs-varid'>hdr_w_offsets</span> <span class='hs-varop'>++</span> <span class='hs-varid'>amodes_with_offsets</span><span class='hs-layout'>)</span>
<a name="line-31"></a>
<a name="line-32"></a>	<span class='hs-comment'>-- BUMP THE VIRTUAL HEAP POINTER</span>
<a name="line-33"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>setVirtHp</span> <span class='hs-layout'>(</span><span class='hs-varid'>virt_hp</span> <span class='hs-varop'>+</span> <span class='hs-varid'>closureSize</span> <span class='hs-varid'>cl_info</span><span class='hs-layout'>)</span>
<a name="line-34"></a>	
<a name="line-35"></a>	<span class='hs-comment'>-- RETURN PTR TO START OF OBJECT</span>
<a name="line-36"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>returnFC</span> <span class='hs-varid'>info_offset</span> <span class='hs-layout'>}</span>
<a name="line-37"></a>
<a name="line-38"></a>
<a name="line-39"></a><a name="initDynHdr"></a><span class='hs-definition'>initDynHdr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmExpr</span> 
<a name="line-40"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmExpr</span>		<span class='hs-comment'>-- Cost centre to put in object</span>
<a name="line-41"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmExpr</span><span class='hs-keyglyph'>]</span>
<a name="line-42"></a><span class='hs-definition'>initDynHdr</span> <span class='hs-varid'>info_ptr</span> <span class='hs-varid'>cc</span>
<a name="line-43"></a>  <span class='hs-keyglyph'>=</span>  <span class='hs-keyglyph'>[</span><span class='hs-varid'>info_ptr</span><span class='hs-keyglyph'>]</span>
<a name="line-44"></a>     	<span class='hs-comment'>-- ToDo: Gransim stuff</span>
<a name="line-45"></a>	<span class='hs-comment'>-- ToDo: Parallel stuff</span>
<a name="line-46"></a>  <span class='hs-varop'>++</span> <span class='hs-varid'>dynProfHdr</span> <span class='hs-varid'>cc</span>
<a name="line-47"></a>	<span class='hs-comment'>-- No ticky header</span>
<a name="line-48"></a>
<a name="line-49"></a><a name="hpStore"></a><span class='hs-definition'>hpStore</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>CmmExpr</span><span class='hs-layout'>,</span> <span class='hs-conid'>VirtualHpOffset</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-50"></a><span class='hs-comment'>-- Store the item (expr,off) in base[off]</span>
<a name="line-51"></a><span class='hs-definition'>hpStore</span> <span class='hs-varid'>base</span> <span class='hs-varid'>es</span>
<a name="line-52"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stmtsC</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>CmmStore</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmmOffsetW</span> <span class='hs-varid'>base</span> <span class='hs-varid'>off</span><span class='hs-layout'>)</span> <span class='hs-varid'>val</span> 
<a name="line-53"></a>	   <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>val</span><span class='hs-layout'>,</span> <span class='hs-varid'>off</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>es</span> <span class='hs-keyglyph'>]</span>
<a name="line-54"></a>
<a name="line-55"></a><a name="emitSetDynHdr"></a><span class='hs-definition'>emitSetDynHdr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-56"></a><span class='hs-definition'>emitSetDynHdr</span> <span class='hs-varid'>base</span> <span class='hs-varid'>info_ptr</span> <span class='hs-varid'>ccs</span> 
<a name="line-57"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hpStore</span> <span class='hs-varid'>base</span> <span class='hs-layout'>(</span><span class='hs-varid'>zip</span> <span class='hs-layout'>(</span><span class='hs-varid'>initDynHdr</span> <span class='hs-varid'>info_ptr</span> <span class='hs-varid'>ccs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>0</span><span class='hs-keyglyph'>..</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
</pre>\end{code}
</body>
</html>
