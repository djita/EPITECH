<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>typecheck/TcDeriv.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%

Handles @deriving@ clauses on @data@ declarations.

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcDeriv</span> <span class='hs-layout'>(</span> <span class='hs-varid'>tcDeriving</span> <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>
<a name="line-13"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-14"></a>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInst</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEnv</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcClassDcl</span><span class='hs-layout'>(</span> <span class='hs-varid'>tcAddDeclCtxt</span> <span class='hs-layout'>)</span>	<span class='hs-comment'>-- Small helper</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcGenDeriv</span>			<span class='hs-comment'>-- Deriv stuff</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcGenGenerics</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>InstEnv</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Inst</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInstEnv</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcHsType</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcMType</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcSimplify</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span>
<a name="line-28"></a>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnBinds</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnEnv</span>  
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnSource</span>   <span class='hs-layout'>(</span> <span class='hs-varid'>addTcgDUs</span> <span class='hs-layout'>)</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HscTypes</span>
<a name="line-33"></a>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ErrUtils</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MkId</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RdrName</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameSet</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ListSetOps</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>
<a name="line-54"></a>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
</pre>\end{code}

%************************************************************************
%*									*
		Overview
%*									*
%************************************************************************

Overall plan
~~~~~~~~~~~~
1.  Convert the decls (i.e. data/newtype deriving clauses,
    plus standalone deriving) to [EarlyDerivSpec]

2.  Infer the missing contexts for the Left DerivSpecs

3.  Add the derived bindings, generating InstInfos


\begin{code}
<pre><a name="line-1"></a><a name="DerivSpec"></a><span class='hs-comment'>-- DerivSpec is purely  local to this module</span>
<a name="line-2"></a><a name="DerivSpec"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>DerivSpec</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ds_loc</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span>
<a name="line-3"></a>		     <span class='hs-layout'>,</span> <span class='hs-varid'>ds_orig</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span>
<a name="line-4"></a>		     <span class='hs-layout'>,</span> <span class='hs-varid'>ds_name</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span>
<a name="line-5"></a>		     <span class='hs-layout'>,</span> <span class='hs-varid'>ds_tvs</span>     <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-6"></a>		     <span class='hs-layout'>,</span> <span class='hs-varid'>ds_theta</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThetaType</span>
<a name="line-7"></a>		     <span class='hs-layout'>,</span> <span class='hs-varid'>ds_cls</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span>
<a name="line-8"></a>		     <span class='hs-layout'>,</span> <span class='hs-varid'>ds_tys</span>     <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-9"></a>		     <span class='hs-layout'>,</span> <span class='hs-varid'>ds_tc</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span>
<a name="line-10"></a>		     <span class='hs-layout'>,</span> <span class='hs-varid'>ds_tc_args</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-11"></a>		     <span class='hs-layout'>,</span> <span class='hs-varid'>ds_newtype</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-layout'>}</span>
<a name="line-12"></a>	<span class='hs-comment'>-- This spec implies a dfun declaration of the form</span>
<a name="line-13"></a>	<span class='hs-comment'>--	 df :: forall tvs. theta =&gt; C tys</span>
<a name="line-14"></a>	<span class='hs-comment'>-- The Name is the name for the DFun we'll build</span>
<a name="line-15"></a>	<span class='hs-comment'>-- The tyvars bind all the variables in the theta</span>
<a name="line-16"></a>	<span class='hs-comment'>-- For type families, the tycon in</span>
<a name="line-17"></a>	<span class='hs-comment'>--	 in ds_tys is the *family* tycon</span>
<a name="line-18"></a>	<span class='hs-comment'>--	 in ds_tc, ds_tc_args is the *representation* tycon</span>
<a name="line-19"></a>	<span class='hs-comment'>-- For non-family tycons, both are the same</span>
<a name="line-20"></a>
<a name="line-21"></a>	<span class='hs-comment'>-- ds_newtype = True  &lt;=&gt; Newtype deriving</span>
<a name="line-22"></a>	<span class='hs-comment'>--		False &lt;=&gt; Vanilla deriving</span>
</pre>\end{code}

Example:

     newtype instance T [a] = MkT (Tree a) deriving( C s )
==>
     axiom T [a] = :RTList a
     axiom :RTList a = Tree a

     DS { ds_tvs = [a,s], ds_cls = C, ds_tys = [s, T [a]]
        , ds_tc = :RTList, ds_tc_args = [a]
        , ds_newtype = True }

\begin{code}
<pre><a name="line-1"></a><a name="DerivContext"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>DerivContext</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>ThetaType</span>
<a name="line-2"></a>   <span class='hs-comment'>-- Nothing 	 &lt;=&gt; Vanilla deriving; infer the context of the instance decl</span>
<a name="line-3"></a>   <span class='hs-comment'>-- Just theta &lt;=&gt; Standalone deriving: context supplied by programmer</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="EarlyDerivSpec"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>EarlyDerivSpec</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>DerivSpec</span> <span class='hs-conid'>DerivSpec</span>
<a name="line-6"></a>	<span class='hs-comment'>-- Left  ds =&gt; the context for the instance should be inferred</span>
<a name="line-7"></a>	<span class='hs-comment'>--	       In this case ds_theta is the list of all the</span>
<a name="line-8"></a>	<span class='hs-comment'>--		  constraints needed, such as (Eq [a], Eq a)</span>
<a name="line-9"></a>	<span class='hs-comment'>--		  The inference process is to reduce this to a</span>
<a name="line-10"></a>	<span class='hs-comment'>--		  simpler form (e.g. Eq a)</span>
<a name="line-11"></a>	<span class='hs-comment'>--</span>
<a name="line-12"></a>	<span class='hs-comment'>-- Right ds =&gt; the exact context for the instance is supplied</span>
<a name="line-13"></a>	<span class='hs-comment'>--	       by the programmer; it is ds_theta</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="pprDerivSpec"></a><span class='hs-definition'>pprDerivSpec</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DerivSpec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-16"></a><span class='hs-definition'>pprDerivSpec</span> <span class='hs-layout'>(</span><span class='hs-conid'>DS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ds_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>l</span><span class='hs-layout'>,</span> <span class='hs-varid'>ds_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>ds_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span>
<a name="line-17"></a>		   <span class='hs-varid'>ds_cls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>c</span><span class='hs-layout'>,</span> <span class='hs-varid'>ds_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>ds_theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-18"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>l</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>c</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tys</span><span class='hs-keyglyph'>]</span>
<a name="line-19"></a>	    <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>equals</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-20"></a>
<a name="line-21"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>DerivSpec</span> <span class='hs-keyword'>where</span>
<a name="line-22"></a>  <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprDerivSpec</span>
</pre>\end{code}


Inferring missing contexts
~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider

	data T a b = C1 (Foo a) (Bar b)
		   | C2 Int (T b a)
		   | C3 (T a a)
		   deriving (Eq)

[NOTE: See end of these comments for what to do with
	data (C a, D b) => T a b = ...
]

We want to come up with an instance declaration of the form

	instance (Ping a, Pong b, ...) => Eq (T a b) where
		x == y = ...

It is pretty easy, albeit tedious, to fill in the code "...".  The
trick is to figure out what the context for the instance decl is,
namely @Ping@, @Pong@ and friends.

Let's call the context reqd for the T instance of class C at types
(a,b, ...)  C (T a b).  Thus:

	Eq (T a b) = (Ping a, Pong b, ...)

Now we can get a (recursive) equation from the @data@ decl:

	Eq (T a b) = Eq (Foo a) u Eq (Bar b)	-- From C1
		   u Eq (T b a) u Eq Int	-- From C2
		   u Eq (T a a)			-- From C3

Foo and Bar may have explicit instances for @Eq@, in which case we can
just substitute for them.  Alternatively, either or both may have
their @Eq@ instances given by @deriving@ clauses, in which case they
form part of the system of equations.

Now all we need do is simplify and solve the equations, iterating to
find the least fixpoint.  Notice that the order of the arguments can
switch around, as here in the recursive calls to T.

Let's suppose Eq (Foo a) = Eq a, and Eq (Bar b) = Ping b.

We start with:

	Eq (T a b) = {}		-- The empty set

Next iteration:
	Eq (T a b) = Eq (Foo a) u Eq (Bar b)	-- From C1
		   u Eq (T b a) u Eq Int	-- From C2
		   u Eq (T a a)			-- From C3

	After simplification:
		   = Eq a u Ping b u {} u {} u {}
		   = Eq a u Ping b

Next iteration:

	Eq (T a b) = Eq (Foo a) u Eq (Bar b)	-- From C1
		   u Eq (T b a) u Eq Int	-- From C2
		   u Eq (T a a)			-- From C3

	After simplification:
		   = Eq a u Ping b
		   u (Eq b u Ping a)
		   u (Eq a u Ping a)

		   = Eq a u Ping b u Eq b u Ping a

The next iteration gives the same result, so this is the fixpoint.  We
need to make a canonical form of the RHS to ensure convergence.  We do
this by simplifying the RHS to a form in which

	- the classes constrain only tyvars
	- the list is sorted by tyvar (major key) and then class (minor key)
	- no duplicates, of course

So, here are the synonyms for the ``equation'' structures:


Note [Data decl contexts]
~~~~~~~~~~~~~~~~~~~~~~~~~
Consider

	data (RealFloat a) => Complex a = !a :+ !a deriving( Read )

We will need an instance decl like:

	instance (Read a, RealFloat a) => Read (Complex a) where
	  ...

The RealFloat in the context is because the read method for Complex is bound
to construct a Complex, and doing that requires that the argument type is
in RealFloat.

But this ain't true for Show, Eq, Ord, etc, since they don't construct
a Complex; they only take them apart.

Our approach: identify the offending classes, and add the data type
context to the instance decl.  The "offending classes" are

	Read, Enum?

FURTHER NOTE ADDED March 2002.  In fact, Haskell98 now requires that
pattern matching against a constructor from a data type with a context
gives rise to the constraints for that context -- or at least the thinned
version.  So now all classes are "offending".

Note [Newtype deriving]
~~~~~~~~~~~~~~~~~~~~~~~
Consider this:
    class C a b
    instance C [a] Char
    newtype T = T Char deriving( C [a] )

Notice the free 'a' in the deriving.  We have to fill this out to
    newtype T = T Char deriving( forall a. C [a] )

And then translate it to:
    instance C [a] Char => C [a] T where ...


Note [Newtype deriving superclasses]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
(See also Trac #1220 for an interesting exchange on newtype
deriving and superclasses.)

The 'tys' here come from the partial application in the deriving
clause. The last arg is the new instance type.

We must pass the superclasses; the newtype might be an instance
of them in a different way than the representation type
E.g.		newtype Foo a = Foo a deriving( Show, Num, Eq )
Then the Show instance is not done via isomorphism; it shows
	Foo 3 as "Foo 3"
The Num instance is derived via isomorphism, but the Show superclass
dictionary must the Show instance for Foo, *not* the Show dictionary
gotten from the Num dictionary. So we must build a whole new dictionary
not just use the Num one.  The instance we want is something like:
     instance (Num a, Show (Foo a), Eq (Foo a)) => Num (Foo a) where
     	(+) = ((+)@a)
     	...etc...
There may be a coercion needed which we get from the tycon for the newtype
when the dict is constructed in TcInstDcls.tcInstDecl2


Note [Unused constructors and deriving clauses]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
See Trac #3221.  Consider
   data T = T1 | T2 deriving( Show )
Are T1 and T2 unused?  Well, no: the deriving clause expands to mention
both of them.  So we gather defs/uses from deriving just like anything else.

%************************************************************************
%*									*
\subsection[TcDeriv-driver]{Top-level function for \tr{derivings}}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="tcDeriving"></a><span class='hs-definition'>tcDeriving</span>  <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LTyClDecl</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- All type constructors</span>
<a name="line-2"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LInstDecl</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- All instance declarations</span>
<a name="line-3"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LDerivDecl</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- All stand-alone deriving declarations</span>
<a name="line-4"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcGblEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bag</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstInfo</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>HsValBinds</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-5"></a><span class='hs-definition'>tcDeriving</span> <span class='hs-varid'>tycl_decls</span> <span class='hs-varid'>inst_decls</span> <span class='hs-varid'>deriv_decls</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>recoverM</span> <span class='hs-layout'>(</span><span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>g</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-7"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>g</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyBag</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyValBindsOut</span><span class='hs-layout'>)</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-8"></a>    <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span>   	<span class='hs-comment'>-- Fish the "deriving"-related information out of the TcEnv</span>
<a name="line-9"></a>		<span class='hs-comment'>-- And make the necessary "equations".</span>
<a name="line-10"></a>	  <span class='hs-varid'>is_boot</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcIsHsBoot</span>
<a name="line-11"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcDeriving"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>is_boot</span><span class='hs-layout'>)</span>
<a name="line-12"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>early_specs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>makeDerivSpecs</span> <span class='hs-varid'>is_boot</span> <span class='hs-varid'>tycl_decls</span> <span class='hs-varid'>inst_decls</span> <span class='hs-varid'>deriv_decls</span>
<a name="line-13"></a>
<a name="line-14"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>overlap_flag</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getOverlapFlag</span>
<a name="line-15"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>infer_specs</span><span class='hs-layout'>,</span> <span class='hs-varid'>given_specs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitEithers</span> <span class='hs-varid'>early_specs</span>
<a name="line-16"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>insts1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>genInst</span> <span class='hs-conid'>True</span> <span class='hs-varid'>overlap_flag</span><span class='hs-layout'>)</span> <span class='hs-varid'>given_specs</span>
<a name="line-17"></a>
<a name="line-18"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>final_specs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>extendLocalInstEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>iSpec</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fst</span><span class='hs-layout'>)</span> <span class='hs-varid'>insts1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-19"></a>                           <span class='hs-varid'>inferInstanceContexts</span> <span class='hs-varid'>overlap_flag</span> <span class='hs-varid'>infer_specs</span>
<a name="line-20"></a>
<a name="line-21"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>insts2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>genInst</span> <span class='hs-conid'>False</span> <span class='hs-varid'>overlap_flag</span><span class='hs-layout'>)</span> <span class='hs-varid'>final_specs</span>
<a name="line-22"></a>
<a name="line-23"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>inst_infos</span><span class='hs-layout'>,</span> <span class='hs-varid'>deriv_stuff</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip</span> <span class='hs-layout'>(</span><span class='hs-varid'>insts1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>insts2</span><span class='hs-layout'>)</span>
<a name="line-24"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-25"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>newTyCons</span><span class='hs-layout'>,</span> <span class='hs-varid'>famInsts</span><span class='hs-layout'>,</span> <span class='hs-varid'>extraInstances</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> 
<a name="line-26"></a>                <span class='hs-varid'>genAuxBinds</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionManyBags</span> <span class='hs-varid'>deriv_stuff</span><span class='hs-layout'>)</span>
<a name="line-27"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>inst_info</span><span class='hs-layout'>,</span> <span class='hs-varid'>rn_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>rn_dus</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-28"></a>            <span class='hs-varid'>renameDeriv</span> <span class='hs-varid'>is_boot</span> <span class='hs-layout'>(</span><span class='hs-varid'>inst_infos</span> <span class='hs-varop'>++</span> <span class='hs-layout'>(</span><span class='hs-varid'>bagToList</span> <span class='hs-varid'>extraInstances</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>binds</span>
<a name="line-29"></a>
<a name="line-30"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDOpts</span>
<a name="line-31"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>liftIO</span> <span class='hs-layout'>(</span><span class='hs-varid'>dumpIfSet_dyn</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Opt_D_dump_deriv</span> <span class='hs-str'>"Derived instances"</span>
<a name="line-32"></a>	         <span class='hs-layout'>(</span><span class='hs-varid'>ddump_deriving</span> <span class='hs-varid'>inst_info</span> <span class='hs-varid'>rn_binds</span> <span class='hs-varid'>newTyCons</span> <span class='hs-varid'>famInsts</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-33"></a>
<a name="line-34"></a>  <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>all_tycons</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>ATyCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>bagToList</span> <span class='hs-varid'>newTyCons</span><span class='hs-layout'>)</span>
<a name="line-35"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>gbl_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExtendGlobalEnv</span> <span class='hs-varid'>all_tycons</span> <span class='hs-varop'>$</span>
<a name="line-36"></a>               <span class='hs-varid'>tcExtendGlobalEnvImplicit</span> <span class='hs-layout'>(</span><span class='hs-varid'>concatMap</span> <span class='hs-varid'>implicitTyThings</span> <span class='hs-varid'>all_tycons</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-37"></a>               <span class='hs-varid'>tcExtendLocalFamInstEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>mkLocalFamInst</span> <span class='hs-layout'>(</span><span class='hs-varid'>bagToList</span> <span class='hs-varid'>famInsts</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-38"></a>               <span class='hs-varid'>tcExtendLocalInstEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>iSpec</span> <span class='hs-layout'>(</span><span class='hs-varid'>bagToList</span> <span class='hs-varid'>inst_info</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-39"></a>
<a name="line-40"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>addTcgDUs</span> <span class='hs-varid'>gbl_env</span> <span class='hs-varid'>rn_dus</span><span class='hs-layout'>,</span> <span class='hs-varid'>inst_info</span><span class='hs-layout'>,</span> <span class='hs-varid'>rn_binds</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-41"></a>  <span class='hs-keyword'>where</span>
<a name="line-42"></a>    <span class='hs-varid'>ddump_deriving</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstInfo</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsValBinds</span> <span class='hs-conid'>Name</span> 
<a name="line-43"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>TyCon</span>  <span class='hs-comment'>-- ^ Empty data constructors</span>
<a name="line-44"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>TyCon</span>  <span class='hs-comment'>-- ^ Rep type family instances</span>
<a name="line-45"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-46"></a>    <span class='hs-varid'>ddump_deriving</span> <span class='hs-varid'>inst_infos</span> <span class='hs-varid'>extra_binds</span> <span class='hs-varid'>repMetaTys</span> <span class='hs-varid'>repTyCons</span>
<a name="line-47"></a>      <span class='hs-keyglyph'>=</span>    <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Derived instances:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-48"></a>              <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprInstInfoDetails</span> <span class='hs-varid'>i</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>text</span> <span class='hs-str'>""</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>bagToList</span> <span class='hs-varid'>inst_infos</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-49"></a>                 <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>extra_binds</span><span class='hs-layout'>)</span>
<a name="line-50"></a>        <span class='hs-varop'>$$</span> <span class='hs-varid'>hangP</span> <span class='hs-str'>"Generic representation:"</span> <span class='hs-layout'>(</span>
<a name="line-51"></a>              <span class='hs-varid'>hangP</span> <span class='hs-str'>"Generated datatypes for meta-information:"</span>
<a name="line-52"></a>               <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>bagToList</span> <span class='hs-varid'>repMetaTys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-53"></a>           <span class='hs-varop'>$$</span> <span class='hs-varid'>hangP</span> <span class='hs-str'>"Representation types:"</span>
<a name="line-54"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pprTyFamInst</span> <span class='hs-layout'>(</span><span class='hs-varid'>bagToList</span> <span class='hs-varid'>repTyCons</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-55"></a>    
<a name="line-56"></a>    <span class='hs-varid'>pprTyFamInst</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>t</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>synTyConType</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-57"></a>    <span class='hs-varid'>hangP</span> <span class='hs-varid'>s</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>""</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-varid'>x</span>
<a name="line-58"></a>
<a name="line-59"></a>
<a name="line-60"></a><a name="renameDeriv"></a><span class='hs-definition'>renameDeriv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-61"></a>	    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>InstInfo</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-62"></a>	    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsBind</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>,</span> <span class='hs-conid'>LSig</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-63"></a> 	    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstInfo</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>HsValBinds</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>DefUses</span><span class='hs-layout'>)</span>
<a name="line-64"></a><span class='hs-definition'>renameDeriv</span> <span class='hs-varid'>is_boot</span> <span class='hs-varid'>inst_infos</span> <span class='hs-varid'>bagBinds</span>
<a name="line-65"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_boot</span>	<span class='hs-comment'>-- If we are compiling a hs-boot file, don't generate any derived bindings</span>
<a name="line-66"></a>		<span class='hs-comment'>-- The inst-info bindings will all be empty, but it's easier to</span>
<a name="line-67"></a>		<span class='hs-comment'>-- just use rn_inst_info to change the type appropriately</span>
<a name="line-68"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>rn_inst_infos</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndUnzipM</span> <span class='hs-varid'>rn_inst_info</span> <span class='hs-varid'>inst_infos</span>
<a name="line-69"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-varid'>listToBag</span> <span class='hs-varid'>rn_inst_infos</span>
<a name="line-70"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>emptyValBindsOut</span><span class='hs-layout'>,</span> <span class='hs-varid'>usesOnly</span> <span class='hs-layout'>(</span><span class='hs-varid'>plusFVs</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-71"></a>
<a name="line-72"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-73"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>discardWarnings</span> <span class='hs-varop'>$</span> 	 <span class='hs-comment'>-- Discard warnings about unused bindings etc</span>
<a name="line-74"></a>    <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span>
<a name="line-75"></a>        <span class='hs-comment'>-- Bring the extra deriving stuff into scope</span>
<a name="line-76"></a>        <span class='hs-comment'>-- before renaming the instances themselves</span>
<a name="line-77"></a>	<span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>aux_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>aux_sigs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndUnzipBagM</span> <span class='hs-varid'>return</span> <span class='hs-varid'>bagBinds</span>
<a name="line-78"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>aux_val_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ValBindsIn</span> <span class='hs-varid'>aux_binds</span> <span class='hs-layout'>(</span><span class='hs-varid'>bagToList</span> <span class='hs-varid'>aux_sigs</span><span class='hs-layout'>)</span>
<a name="line-79"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>rn_aux_lhs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnTopBindsLHS</span> <span class='hs-varid'>emptyFsEnv</span> <span class='hs-varid'>aux_val_binds</span>
<a name="line-80"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectHsValBinders</span> <span class='hs-varid'>rn_aux_lhs</span>
<a name="line-81"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>bindLocalNames</span> <span class='hs-varid'>bndrs</span> <span class='hs-varop'>$</span> 
<a name="line-82"></a>    <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>rn_aux</span><span class='hs-layout'>,</span> <span class='hs-varid'>dus_aux</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnValBindsRHS</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocalBindCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNameSet</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>rn_aux_lhs</span>
<a name="line-83"></a>	<span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>rn_inst_infos</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_insts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndUnzipM</span> <span class='hs-varid'>rn_inst_info</span> <span class='hs-varid'>inst_infos</span>
<a name="line-84"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>listToBag</span> <span class='hs-varid'>rn_inst_infos</span><span class='hs-layout'>,</span> <span class='hs-varid'>rn_aux</span><span class='hs-layout'>,</span>
<a name="line-85"></a>                  <span class='hs-varid'>dus_aux</span> <span class='hs-varop'>`plusDU`</span> <span class='hs-varid'>usesOnly</span> <span class='hs-layout'>(</span><span class='hs-varid'>plusFVs</span> <span class='hs-varid'>fvs_insts</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-86"></a>
<a name="line-87"></a>  <span class='hs-keyword'>where</span>
<a name="line-88"></a>    <span class='hs-varid'>rn_inst_info</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InstInfo</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstInfo</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-89"></a>    <span class='hs-varid'>rn_inst_info</span> <span class='hs-varid'>info</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>InstInfo</span> <span class='hs-layout'>{</span> <span class='hs-varid'>iBinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NewTypeDerived</span> <span class='hs-varid'>coi</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-90"></a>	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-varid'>info</span> <span class='hs-layout'>{</span> <span class='hs-varid'>iBinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NewTypeDerived</span> <span class='hs-varid'>coi</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>}</span>
<a name="line-91"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>mkFVs</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>dataConName</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConDataCons</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-92"></a>	  <span class='hs-comment'>-- See Note [Newtype deriving and unused constructors]</span>
<a name="line-93"></a>
<a name="line-94"></a>    <span class='hs-varid'>rn_inst_info</span> <span class='hs-varid'>inst_info</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>InstInfo</span> <span class='hs-layout'>{</span> <span class='hs-varid'>iSpec</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst</span><span class='hs-layout'>,</span> <span class='hs-varid'>iBinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VanillaInst</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>sigs</span> <span class='hs-varid'>standalone_deriv</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-95"></a>	<span class='hs-keyglyph'>=</span> 	<span class='hs-comment'>-- Bring the right type variables into</span>
<a name="line-96"></a>		<span class='hs-comment'>-- scope (yuk), and rename the method binds</span>
<a name="line-97"></a>	   <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>null</span> <span class='hs-varid'>sigs</span> <span class='hs-layout'>)</span>
<a name="line-98"></a>	   <span class='hs-varid'>bindLocalNames</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>varName</span> <span class='hs-varid'>tyvars</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-99"></a> 	   <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>rn_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnMethodBinds</span> <span class='hs-varid'>clas_nm</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-varid'>binds</span>
<a name="line-100"></a>	      <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>binds'</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VanillaInst</span> <span class='hs-varid'>rn_binds</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>standalone_deriv</span>
<a name="line-101"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>inst_info</span> <span class='hs-layout'>{</span> <span class='hs-varid'>iBinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binds'</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-102"></a>	<span class='hs-keyword'>where</span>
<a name="line-103"></a>	  <span class='hs-layout'>(</span><span class='hs-varid'>tyvars</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>clas</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>instanceHead</span> <span class='hs-varid'>inst</span>
<a name="line-104"></a>	  <span class='hs-varid'>clas_nm</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>className</span> <span class='hs-varid'>clas</span>
</pre>\end{code}

Note [Newtype deriving and unused constructors]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this (see Trac #1954):

  module Bug(P) where
  newtype P a = MkP (IO a) deriving Monad

If you compile with -fwarn-unused-binds you do not expect the warning
"Defined but not used: data consructor MkP". Yet the newtype deriving
code does not explicitly mention MkP, but it should behave as if you
had written
  instance Monad P where
     return x = MkP (return x)
     ...etc...

So we want to signal a user of the data constructor 'MkP'.  That's
what we do in rn_inst_info, and it's the only reason we have the TyCon
stored in NewTypeDerived.


%************************************************************************
%*									*
		From HsSyn to DerivSpec
%*									*
%************************************************************************

@makeDerivSpecs@ fishes around to find the info about needed derived instances.

\begin{code}
<pre><a name="line-1"></a><a name="makeDerivSpecs"></a><span class='hs-definition'>makeDerivSpecs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> 
<a name="line-2"></a>	       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LTyClDecl</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> 
<a name="line-3"></a>	       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LInstDecl</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-4"></a>	       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LDerivDecl</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> 
<a name="line-5"></a>	       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EarlyDerivSpec</span><span class='hs-keyglyph'>]</span>
<a name="line-6"></a><span class='hs-definition'>makeDerivSpecs</span> <span class='hs-varid'>is_boot</span> <span class='hs-varid'>tycl_decls</span> <span class='hs-varid'>inst_decls</span> <span class='hs-varid'>deriv_decls</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_boot</span>     <span class='hs-comment'>-- No 'deriving' at all in hs-boot files</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>add_deriv_err</span> <span class='hs-varid'>deriv_locs</span> 
<a name="line-9"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>}</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>eqns1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndRecoverM</span> <span class='hs-varid'>deriveTyData</span> <span class='hs-varid'>all_tydata</span>
<a name="line-12"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>eqns2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndRecoverM</span> <span class='hs-varid'>deriveStandalone</span> <span class='hs-varid'>deriv_decls</span>
<a name="line-13"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>eqns1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>eqns2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-14"></a>  <span class='hs-keyword'>where</span>
<a name="line-15"></a>    <span class='hs-varid'>extractTyDataPreds</span> <span class='hs-varid'>decls</span>
<a name="line-16"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>d</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyData</span> <span class='hs-layout'>{</span><span class='hs-varid'>tcdDerivs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>preds</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>decls</span><span class='hs-layout'>,</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>preds</span><span class='hs-keyglyph'>]</span>
<a name="line-17"></a>
<a name="line-18"></a>    <span class='hs-varid'>all_tydata</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>LTyClDecl</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-19"></a>        <span class='hs-comment'>-- Derived predicate paired with its data type declaration</span>
<a name="line-20"></a>    <span class='hs-varid'>all_tydata</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extractTyDataPreds</span> <span class='hs-layout'>(</span><span class='hs-varid'>instDeclATs</span> <span class='hs-varid'>inst_decls</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tycl_decls</span><span class='hs-layout'>)</span>
<a name="line-21"></a>
<a name="line-22"></a>    <span class='hs-varid'>deriv_locs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLoc</span> <span class='hs-varop'>.</span> <span class='hs-varid'>snd</span><span class='hs-layout'>)</span> <span class='hs-varid'>all_tydata</span>
<a name="line-23"></a>                 <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-varid'>getLoc</span> <span class='hs-varid'>deriv_decls</span>
<a name="line-24"></a>
<a name="line-25"></a>    <span class='hs-varid'>add_deriv_err</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-26"></a>                        <span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Deriving not permitted in hs-boot file"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-27"></a>                                   <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Use an instance declaration instead"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="deriveStandalone"></a><span class='hs-comment'>------------------------------------------------------------------</span>
<a name="line-30"></a><span class='hs-definition'>deriveStandalone</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LDerivDecl</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>EarlyDerivSpec</span>
<a name="line-31"></a><span class='hs-comment'>-- Standalone deriving declarations</span>
<a name="line-32"></a><span class='hs-comment'>--  e.g.   deriving instance Show a =&gt; Show (T a)</span>
<a name="line-33"></a><span class='hs-comment'>-- Rather like tcLocalInstDecl</span>
<a name="line-34"></a><span class='hs-definition'>deriveStandalone</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>DerivDecl</span> <span class='hs-varid'>deriv_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-35"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span>                   <span class='hs-varop'>$</span>
<a name="line-36"></a>    <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>standaloneCtxt</span> <span class='hs-varid'>deriv_ty</span><span class='hs-layout'>)</span>  <span class='hs-varop'>$</span>
<a name="line-37"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Standalone deriving decl for"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>deriv_ty</span><span class='hs-layout'>)</span>
<a name="line-38"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>inst_tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsInstHead</span> <span class='hs-conid'>TcType</span><span class='hs-varop'>.</span><span class='hs-conid'>InstDeclCtxt</span> <span class='hs-varid'>deriv_ty</span>
<a name="line-39"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Standalone deriving;"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>vcat</span>
<a name="line-40"></a>              <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"tvs:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tvs</span>
<a name="line-41"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"theta:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>theta</span>
<a name="line-42"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"cls:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cls</span>
<a name="line-43"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"tys:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>inst_tys</span> <span class='hs-keyglyph'>]</span>
<a name="line-44"></a>		<span class='hs-comment'>-- C.f. TcInstDcls.tcLocalInstDecl1</span>
<a name="line-45"></a>
<a name="line-46"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>cls_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>take</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>inst_tys</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>inst_tys</span>
<a name="line-47"></a>             <span class='hs-varid'>inst_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>last</span> <span class='hs-varid'>inst_tys</span>
<a name="line-48"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Standalone deriving:"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>vcat</span>
<a name="line-49"></a>              <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"class:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cls</span>
<a name="line-50"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"class types:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cls_tys</span>
<a name="line-51"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"type:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>inst_ty</span> <span class='hs-keyglyph'>]</span>
<a name="line-52"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mkEqnHelp</span> <span class='hs-conid'>StandAloneDerivOrigin</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>cls_tys</span> <span class='hs-varid'>inst_ty</span>
<a name="line-53"></a>                   <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>theta</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-54"></a>
<a name="line-55"></a><a name="deriveTyData"></a><span class='hs-comment'>------------------------------------------------------------------</span>
<a name="line-56"></a><span class='hs-definition'>deriveTyData</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>LTyClDecl</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>EarlyDerivSpec</span>
<a name="line-57"></a><span class='hs-comment'>-- The deriving clause of a data or newtype declaration</span>
<a name="line-58"></a><span class='hs-definition'>deriveTyData</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>deriv_pred</span><span class='hs-layout'>,</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>decl</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyData</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcdLName</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tycon_name</span><span class='hs-layout'>,</span>
<a name="line-59"></a>					           <span class='hs-varid'>tcdTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv_names</span><span class='hs-layout'>,</span>
<a name="line-60"></a>				    	           <span class='hs-varid'>tcdTyPats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_pats</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-61"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span>     <span class='hs-varop'>$</span>	<span class='hs-comment'>-- Use the location of the 'deriving' item</span>
<a name="line-62"></a>    <span class='hs-varid'>tcAddDeclCtxt</span> <span class='hs-varid'>decl</span> <span class='hs-varop'>$</span>
<a name="line-63"></a>    <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get_lhs</span> <span class='hs-varid'>ty_pats</span>
<a name="line-64"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>tcExtendTyVarEnv</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>$</span>	<span class='hs-comment'>-- Deriving preds may (now) mention</span>
<a name="line-65"></a>					<span class='hs-comment'>-- the type variables for the type constructor</span>
<a name="line-66"></a>
<a name="line-67"></a>    <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>deriv_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>cls_tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsDeriv</span> <span class='hs-varid'>deriv_pred</span>
<a name="line-68"></a>		<span class='hs-comment'>-- The "deriv_pred" is a LHsType to take account of the fact that for</span>
<a name="line-69"></a>		<span class='hs-comment'>-- newtype deriving we allow deriving (forall a. C [a]).</span>
<a name="line-70"></a>
<a name="line-71"></a>	<span class='hs-comment'>-- Given data T a b c = ... deriving( C d ),</span>
<a name="line-72"></a>	<span class='hs-comment'>-- we want to drop type variables from T so that (C d (T a)) is well-kinded</span>
<a name="line-73"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>cls_tyvars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>classTyVars</span> <span class='hs-varid'>cls</span>
<a name="line-74"></a>	      <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>last</span> <span class='hs-varid'>cls_tyvars</span><span class='hs-layout'>)</span>
<a name="line-75"></a>	      <span class='hs-layout'>(</span><span class='hs-varid'>arg_kinds</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitKindFunTys</span> <span class='hs-varid'>kind</span>
<a name="line-76"></a>	      <span class='hs-varid'>n_args_to_drop</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>arg_kinds</span>
<a name="line-77"></a>	      <span class='hs-varid'>n_args_to_keep</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span> <span class='hs-comment'>-</span> <span class='hs-varid'>n_args_to_drop</span>
<a name="line-78"></a>	      <span class='hs-varid'>args_to_drop</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>drop</span> <span class='hs-varid'>n_args_to_keep</span> <span class='hs-varid'>tc_args</span>
<a name="line-79"></a>	      <span class='hs-varid'>inst_ty</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>take</span> <span class='hs-varid'>n_args_to_keep</span> <span class='hs-varid'>tc_args</span><span class='hs-layout'>)</span>
<a name="line-80"></a>	      <span class='hs-varid'>inst_ty_kind</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>inst_ty</span>
<a name="line-81"></a>	      <span class='hs-varid'>dropped_tvs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapCatMaybes</span> <span class='hs-varid'>getTyVar_maybe</span> <span class='hs-varid'>args_to_drop</span><span class='hs-layout'>)</span>
<a name="line-82"></a>	      <span class='hs-varid'>univ_tvs</span>       <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>`extendVarSetList`</span> <span class='hs-varid'>deriv_tvs</span><span class='hs-layout'>)</span>
<a name="line-83"></a>					<span class='hs-varop'>`minusVarSet`</span> <span class='hs-varid'>dropped_tvs</span>
<a name="line-84"></a>
<a name="line-85"></a>	<span class='hs-comment'>-- Check that the result really is well-kinded</span>
<a name="line-86"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_args_to_keep</span> <span class='hs-varop'>&gt;=</span> <span class='hs-num'>0</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>inst_ty_kind</span> <span class='hs-varop'>`eqKind`</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-87"></a>		  <span class='hs-layout'>(</span><span class='hs-varid'>derivingKindErr</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>cls_tys</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-88"></a>
<a name="line-89"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>sizeVarSet</span> <span class='hs-varid'>dropped_tvs</span> <span class='hs-varop'>==</span> <span class='hs-varid'>n_args_to_drop</span> <span class='hs-varop'>&amp;&amp;</span> 		 <span class='hs-comment'>-- (a)</span>
<a name="line-90"></a>	           <span class='hs-varid'>tyVarsOfTypes</span> <span class='hs-layout'>(</span><span class='hs-varid'>inst_ty</span><span class='hs-conop'>:</span><span class='hs-varid'>cls_tys</span><span class='hs-layout'>)</span> <span class='hs-varop'>`subVarSet`</span> <span class='hs-varid'>univ_tvs</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- (b)</span>
<a name="line-91"></a>		  <span class='hs-layout'>(</span><span class='hs-varid'>derivingEtaErr</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>cls_tys</span> <span class='hs-varid'>inst_ty</span><span class='hs-layout'>)</span>
<a name="line-92"></a>		<span class='hs-comment'>-- Check that</span>
<a name="line-93"></a>		<span class='hs-comment'>--  (a) The data type can be eta-reduced; eg reject:</span>
<a name="line-94"></a>		<span class='hs-comment'>--		data instance T a a = ... deriving( Monad )</span>
<a name="line-95"></a>		<span class='hs-comment'>--  (b) The type class args do not mention any of the dropped type</span>
<a name="line-96"></a>		<span class='hs-comment'>--      variables</span>
<a name="line-97"></a>		<span class='hs-comment'>--		newtype T a s = ... deriving( ST s )</span>
<a name="line-98"></a>
<a name="line-99"></a>	<span class='hs-comment'>-- Type families can't be partially applied</span>
<a name="line-100"></a>	<span class='hs-comment'>-- e.g.   newtype instance T Int a = MkT [a] deriving( Monad )</span>
<a name="line-101"></a>	<span class='hs-comment'>-- Note [Deriving, type families, and partial applications]</span>
<a name="line-102"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isFamilyTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span> <span class='hs-varid'>n_args_to_drop</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span>
<a name="line-103"></a>		  <span class='hs-layout'>(</span><span class='hs-varid'>typeFamilyPapErr</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>cls_tys</span> <span class='hs-varid'>inst_ty</span><span class='hs-layout'>)</span>
<a name="line-104"></a>
<a name="line-105"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>mkEqnHelp</span> <span class='hs-conid'>DerivOrigin</span> <span class='hs-layout'>(</span><span class='hs-varid'>varSetElemsKvsFirst</span> <span class='hs-varid'>univ_tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>cls_tys</span> <span class='hs-varid'>inst_ty</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-106"></a>  <span class='hs-keyword'>where</span>
<a name="line-107"></a>	<span class='hs-comment'>-- Tiresomely we must figure out the "lhs", which is awkward for type families</span>
<a name="line-108"></a>	<span class='hs-comment'>-- E.g.   data T a b = .. deriving( Eq )</span>
<a name="line-109"></a>	<span class='hs-comment'>-- 	    Here, the lhs is (T a b)</span>
<a name="line-110"></a>	<span class='hs-comment'>--	  data instance TF Int b = ... deriving( Eq )</span>
<a name="line-111"></a>	<span class='hs-comment'>--	    Here, the lhs is (TF Int b)</span>
<a name="line-112"></a>	<span class='hs-comment'>-- But if we just look up the tycon_name, we get is the *family*</span>
<a name="line-113"></a>	<span class='hs-comment'>-- tycon, but not pattern types -- they are in the *rep* tycon.</span>
<a name="line-114"></a>    <span class='hs-varid'>get_lhs</span> <span class='hs-conid'>Nothing</span>     <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupTyCon</span> <span class='hs-varid'>tycon_name</span>
<a name="line-115"></a>			     <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConTyVars</span> <span class='hs-varid'>tc</span>
<a name="line-116"></a>			     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-117"></a>    <span class='hs-comment'>-- JPM: to fix</span>
<a name="line-118"></a>    <span class='hs-varid'>get_lhs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>pats</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>hs_app</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nlHsTyConApp</span> <span class='hs-varid'>tycon_name</span> <span class='hs-varid'>pats</span>
<a name="line-119"></a>			     <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc_app</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsQuantifiedType</span> <span class='hs-varid'>tv_names</span> <span class='hs-varid'>hs_app</span>
<a name="line-120"></a>			     <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitTyConApp</span> <span class='hs-varid'>tc_app</span>
<a name="line-121"></a>			     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc_args</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-122"></a>
<a name="line-123"></a><span class='hs-definition'>deriveTyData</span> <span class='hs-sel'>_other</span>
<a name="line-124"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"derivTyData"</span>	<span class='hs-comment'>-- Caller ensures that only TyData can happen</span>
</pre>\end{code}

Note [Deriving, type families, and partial applications]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When there are no type families, it's quite easy:

    newtype S a = MkS [a]
    -- :CoS :: S  ~ []	-- Eta-reduced

    instance Eq [a] => Eq (S a) 	-- by coercion sym (Eq (:CoS a)) : Eq [a] ~ Eq (S a)
    instance Monad [] => Monad S	-- by coercion sym (Monad :CoS)  : Monad [] ~ Monad S

When type familes are involved it's trickier:

    data family T a b
    newtype instance T Int a = MkT [a] deriving( Eq, Monad )
    -- :RT is the representation type for (T Int a)
    --  :CoF:R1T a :: T Int a ~ :RT a	-- Not eta reduced
    --  :Co:R1T    :: :RT ~ []		-- Eta-reduced

    instance Eq [a] => Eq (T Int a) 	-- easy by coercion
    instance Monad [] => Monad (T Int)	-- only if we can eta reduce???

The "???" bit is that we don't build the :CoF thing in eta-reduced form
Henc the current typeFamilyPapErr, even though the instance makes sense.
After all, we can write it out
    instance Monad [] => Monad (T Int)	-- only if we can eta reduce???
      return x = MkT [x]
      ... etc ...

\begin{code}
<pre><a name="line-1"></a><a name="mkEqnHelp"></a><span class='hs-definition'>mkEqnHelp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DerivContext</span>	<span class='hs-comment'>-- Just    =&gt; context supplied (standalone deriving)</span>
<a name="line-3"></a>				<span class='hs-comment'>-- Nothing =&gt; context inferred (deriving on data decl)</span>
<a name="line-4"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRn</span> <span class='hs-conid'>EarlyDerivSpec</span>
<a name="line-5"></a><span class='hs-comment'>-- Make the EarlyDerivSpec for an instance</span>
<a name="line-6"></a><span class='hs-comment'>--	forall tvs. theta =&gt; cls (tys ++ [ty])</span>
<a name="line-7"></a><span class='hs-comment'>-- where the 'theta' is optional (that's the Maybe part)</span>
<a name="line-8"></a><span class='hs-comment'>-- Assumes that this declaration is well-kinded</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-definition'>mkEqnHelp</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>cls_tys</span> <span class='hs-varid'>tc_app</span> <span class='hs-varid'>mtheta</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tycon</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSplitTyConApp_maybe</span> <span class='hs-varid'>tc_app</span>
<a name="line-12"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>isAlgTyCon</span> <span class='hs-varid'>tycon</span>	<span class='hs-comment'>-- Check for functions, primitive types etc</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_alg_eqn</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>tc_args</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>derivingThingErr</span> <span class='hs-conid'>False</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>cls_tys</span> <span class='hs-varid'>tc_app</span>
<a name="line-16"></a>	       <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The last argument of the instance must be a data or newtype application"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-17"></a>
<a name="line-18"></a>  <span class='hs-keyword'>where</span>
<a name="line-19"></a>     <span class='hs-varid'>bale_out</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>derivingThingErr</span> <span class='hs-conid'>False</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>cls_tys</span> <span class='hs-varid'>tc_app</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span>
<a name="line-20"></a>
<a name="line-21"></a>     <span class='hs-varid'>mk_alg_eqn</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>tc_args</span>
<a name="line-22"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>className</span> <span class='hs-varid'>cls</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>typeableClassNames</span>
<a name="line-23"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDOpts</span>
<a name="line-24"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>checkTypeableConditions</span> <span class='hs-layout'>(</span><span class='hs-varid'>dflags</span><span class='hs-layout'>,</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-25"></a>               <span class='hs-conid'>Just</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>bale_out</span> <span class='hs-varid'>err</span>
<a name="line-26"></a>               <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mk_typeable_eqn</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>tc_args</span> <span class='hs-varid'>mtheta</span> <span class='hs-layout'>}</span>
<a name="line-27"></a>
<a name="line-28"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isDataFamilyTyCon</span> <span class='hs-varid'>tycon</span>
<a name="line-29"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tc_args</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tycon</span>
<a name="line-30"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bale_out</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Unsaturated data family application"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-31"></a>
<a name="line-32"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-33"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>rep_tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>rep_tc_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupDataFamInst</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>tc_args</span>
<a name="line-34"></a>      	          <span class='hs-comment'>-- Be careful to test rep_tc here: in the case of families,</span>
<a name="line-35"></a>      	          <span class='hs-comment'>-- we want to check the instance tycon, not the family tycon</span>
<a name="line-36"></a>
<a name="line-37"></a>      	   <span class='hs-comment'>-- For standalone deriving (mtheta /= Nothing),</span>
<a name="line-38"></a>      	   <span class='hs-comment'>-- check that all the data constructors are in scope.</span>
<a name="line-39"></a>      	   <span class='hs-layout'>;</span> <span class='hs-varid'>rdr_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGlobalRdrEnv</span>
<a name="line-40"></a>      	   <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>hidden_data_cons</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isWiredInName</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConName</span> <span class='hs-varid'>rep_tc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-41"></a>                                    <span class='hs-layout'>(</span><span class='hs-varid'>isAbstractTyCon</span> <span class='hs-varid'>rep_tc</span> <span class='hs-varop'>||</span> 
<a name="line-42"></a>                                     <span class='hs-varid'>any</span> <span class='hs-varid'>not_in_scope</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConDataCons</span> <span class='hs-varid'>rep_tc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-43"></a>      	         <span class='hs-varid'>not_in_scope</span> <span class='hs-varid'>dc</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupGRE_Name</span> <span class='hs-varid'>rdr_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConName</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-44"></a>      	   <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isNothing</span> <span class='hs-varid'>mtheta</span> <span class='hs-varop'>||</span> <span class='hs-varid'>not</span> <span class='hs-varid'>hidden_data_cons</span><span class='hs-layout'>)</span>
<a name="line-45"></a>      	   	    <span class='hs-layout'>(</span><span class='hs-varid'>bale_out</span> <span class='hs-layout'>(</span><span class='hs-varid'>derivingHiddenErr</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-46"></a>
<a name="line-47"></a>      	   <span class='hs-layout'>;</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDOpts</span>
<a name="line-48"></a>      	   <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isDataTyCon</span> <span class='hs-varid'>rep_tc</span> <span class='hs-keyword'>then</span>
<a name="line-49"></a>      	   	<span class='hs-varid'>mkDataTypeEqn</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>cls_tys</span>
<a name="line-50"></a>      	   		      <span class='hs-varid'>tycon</span> <span class='hs-varid'>tc_args</span> <span class='hs-varid'>rep_tc</span> <span class='hs-varid'>rep_tc_args</span> <span class='hs-varid'>mtheta</span>
<a name="line-51"></a>      	     <span class='hs-keyword'>else</span>
<a name="line-52"></a>      	   	<span class='hs-varid'>mkNewTypeEqn</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>cls_tys</span>
<a name="line-53"></a>      	   		     <span class='hs-varid'>tycon</span> <span class='hs-varid'>tc_args</span> <span class='hs-varid'>rep_tc</span> <span class='hs-varid'>rep_tc_args</span> <span class='hs-varid'>mtheta</span> <span class='hs-layout'>}</span>
</pre>\end{code}


%************************************************************************
%*									*
		Deriving data types
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="mkDataTypeEqn"></a><span class='hs-definition'>mkDataTypeEqn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span>
<a name="line-2"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DynFlags</span>
<a name="line-3"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span>                  <span class='hs-comment'>-- Universally quantified type variables in the instance</span>
<a name="line-4"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span>                  <span class='hs-comment'>-- Class for which we need to derive an instance</span>
<a name="line-5"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>                 <span class='hs-comment'>-- Other parameters to the class except the last</span>
<a name="line-6"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span>                  <span class='hs-comment'>-- Type constructor for which the instance is requested</span>
<a name="line-7"></a>					<span class='hs-comment'>--    (last parameter to the type class)</span>
<a name="line-8"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>                 <span class='hs-comment'>-- Parameters to the type constructor</span>
<a name="line-9"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span>                  <span class='hs-comment'>-- rep of the above (for type families)</span>
<a name="line-10"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>                 <span class='hs-comment'>-- rep of the above</span>
<a name="line-11"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DerivContext</span>        <span class='hs-comment'>-- Context of the instance, for standalone deriving</span>
<a name="line-12"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRn</span> <span class='hs-conid'>EarlyDerivSpec</span>    <span class='hs-comment'>-- Return 'Nothing' if error</span>
<a name="line-13"></a>
<a name="line-14"></a><span class='hs-definition'>mkDataTypeEqn</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>cls_tys</span>
<a name="line-15"></a>              <span class='hs-varid'>tycon</span> <span class='hs-varid'>tc_args</span> <span class='hs-varid'>rep_tc</span> <span class='hs-varid'>rep_tc_args</span> <span class='hs-varid'>mtheta</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>checkSideConditions</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>mtheta</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>cls_tys</span> <span class='hs-varid'>rep_tc</span> <span class='hs-keyword'>of</span>
<a name="line-17"></a>	<span class='hs-comment'>-- NB: pass the *representation* tycon to checkSideConditions</span>
<a name="line-18"></a>	<span class='hs-conid'>CanDerive</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go_for_it</span>
<a name="line-19"></a>	<span class='hs-conid'>NonDerivableClass</span>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>bale_out</span> <span class='hs-layout'>(</span><span class='hs-varid'>nonStdErr</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span>
<a name="line-20"></a>	<span class='hs-conid'>DerivableClassError</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>bale_out</span> <span class='hs-varid'>msg</span>
<a name="line-21"></a>  <span class='hs-keyword'>where</span>
<a name="line-22"></a>    <span class='hs-varid'>go_for_it</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_data_eqn</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>tc_args</span> <span class='hs-varid'>rep_tc</span> <span class='hs-varid'>rep_tc_args</span> <span class='hs-varid'>mtheta</span>
<a name="line-23"></a>    <span class='hs-varid'>bale_out</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>derivingThingErr</span> <span class='hs-conid'>False</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>cls_tys</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>tc_args</span><span class='hs-layout'>)</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="mk_data_eqn"></a><span class='hs-definition'>mk_data_eqn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span>
<a name="line-26"></a>   	    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DerivContext</span>
<a name="line-27"></a>   	    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>EarlyDerivSpec</span>
<a name="line-28"></a><span class='hs-definition'>mk_data_eqn</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>tc_args</span> <span class='hs-varid'>rep_tc</span> <span class='hs-varid'>rep_tc_args</span> <span class='hs-varid'>mtheta</span>
<a name="line-29"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>dfun_name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>new_dfun_name</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tycon</span>
<a name="line-30"></a>  	<span class='hs-layout'>;</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-31"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>inst_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>tc_args</span><span class='hs-keyglyph'>]</span>
<a name="line-32"></a>	      <span class='hs-varid'>inferred_constraints</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inferConstraints</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>inst_tys</span> <span class='hs-varid'>rep_tc</span> <span class='hs-varid'>rep_tc_args</span>
<a name="line-33"></a>	      <span class='hs-varid'>spec</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ds_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span><span class='hs-layout'>,</span> <span class='hs-varid'>ds_orig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orig</span>
<a name="line-34"></a>			<span class='hs-layout'>,</span> <span class='hs-varid'>ds_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dfun_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>ds_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span>
<a name="line-35"></a>			<span class='hs-layout'>,</span> <span class='hs-varid'>ds_cls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>ds_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_tys</span>
<a name="line-36"></a>			<span class='hs-layout'>,</span> <span class='hs-varid'>ds_tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rep_tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>ds_tc_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rep_tc_args</span>
<a name="line-37"></a>			<span class='hs-layout'>,</span> <span class='hs-varid'>ds_theta</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>mtheta</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>inferred_constraints</span>
<a name="line-38"></a>			<span class='hs-layout'>,</span> <span class='hs-varid'>ds_newtype</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span> <span class='hs-layout'>}</span>
<a name="line-39"></a>
<a name="line-40"></a>  	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>isJust</span> <span class='hs-varid'>mtheta</span> <span class='hs-keyword'>then</span> <span class='hs-conid'>Right</span> <span class='hs-varid'>spec</span>	<span class='hs-comment'>-- Specified context</span>
<a name="line-41"></a>				   <span class='hs-keyword'>else</span> <span class='hs-conid'>Left</span> <span class='hs-varid'>spec</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>	<span class='hs-comment'>-- Infer context</span>
<a name="line-42"></a>
<a name="line-43"></a><a name="mk_typeable_eqn"></a><span class='hs-comment'>----------------------</span>
<a name="line-44"></a><span class='hs-definition'>mk_typeable_eqn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span>
<a name="line-45"></a>   	    	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DerivContext</span>
<a name="line-46"></a>   	    	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>EarlyDerivSpec</span>
<a name="line-47"></a><span class='hs-definition'>mk_typeable_eqn</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>tc_args</span> <span class='hs-varid'>mtheta</span>
<a name="line-48"></a>	<span class='hs-comment'>-- The Typeable class is special in several ways</span>
<a name="line-49"></a>	<span class='hs-comment'>-- 	  data T a b = ... deriving( Typeable )</span>
<a name="line-50"></a>	<span class='hs-comment'>-- gives</span>
<a name="line-51"></a>	<span class='hs-comment'>--	  instance Typeable2 T where ...</span>
<a name="line-52"></a>	<span class='hs-comment'>-- Notice that:</span>
<a name="line-53"></a>	<span class='hs-comment'>-- 1. There are no constraints in the instance</span>
<a name="line-54"></a>	<span class='hs-comment'>-- 2. There are no type variables either</span>
<a name="line-55"></a>	<span class='hs-comment'>-- 3. The actual class we want to generate isn't necessarily</span>
<a name="line-56"></a>	<span class='hs-comment'>--	Typeable; it depends on the arity of the type</span>
<a name="line-57"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isNothing</span> <span class='hs-varid'>mtheta</span>	<span class='hs-comment'>-- deriving on a data type decl</span>
<a name="line-58"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>cls</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>typeableClassKey</span><span class='hs-layout'>)</span>
<a name="line-59"></a>		  <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Use deriving( Typeable ) on a data type declaration"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-60"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>real_cls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupClass</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeableClassNames</span> <span class='hs-varop'>!!</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span>
<a name="line-61"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>mk_typeable_eqn</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>real_cls</span> <span class='hs-varid'>tycon</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-62"></a>
<a name="line-63"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>		<span class='hs-comment'>-- standaone deriving</span>
<a name="line-64"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>tc_args</span><span class='hs-layout'>)</span>
<a name="line-65"></a>		  <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Derived typeable instance must be of form (Typeable"</span><span class='hs-layout'>)</span>
<a name="line-66"></a>			<span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>int</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tycon</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>rparen</span><span class='hs-layout'>)</span>
<a name="line-67"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>dfun_name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>new_dfun_name</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tycon</span>
<a name="line-68"></a>  	<span class='hs-layout'>;</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-69"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Right</span> <span class='hs-varop'>$</span>
<a name="line-70"></a>		  <span class='hs-conid'>DS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ds_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span><span class='hs-layout'>,</span> <span class='hs-varid'>ds_orig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orig</span><span class='hs-layout'>,</span> <span class='hs-varid'>ds_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dfun_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>ds_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-71"></a>		     <span class='hs-layout'>,</span> <span class='hs-varid'>ds_cls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>ds_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-conid'>[]</span><span class='hs-keyglyph'>]</span>
<a name="line-72"></a>		     <span class='hs-layout'>,</span> <span class='hs-varid'>ds_tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>,</span> <span class='hs-varid'>ds_tc_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-73"></a>		     <span class='hs-layout'>,</span> <span class='hs-varid'>ds_theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mtheta</span> <span class='hs-varop'>`orElse`</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>ds_newtype</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-layout'>}</span>
<a name="line-74"></a>
<a name="line-75"></a><a name="inferConstraints"></a><span class='hs-comment'>----------------------</span>
<a name="line-76"></a><span class='hs-definition'>inferConstraints</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThetaType</span>
<a name="line-77"></a><span class='hs-comment'>-- Generate a sufficiently large set of constraints that typechecking the</span>
<a name="line-78"></a><span class='hs-comment'>-- generated method definitions should succeed.   This set will be simplified</span>
<a name="line-79"></a><span class='hs-comment'>-- before being used in the instance declaration</span>
<a name="line-80"></a><span class='hs-definition'>inferConstraints</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>inst_tys</span> <span class='hs-varid'>rep_tc</span> <span class='hs-varid'>rep_tc_args</span>
<a name="line-81"></a>  <span class='hs-comment'>-- Generic constraints are easy</span>
<a name="line-82"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>cls</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>genClassKey</span>
<a name="line-83"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-84"></a>  <span class='hs-comment'>-- The others are a bit more complicated</span>
<a name="line-85"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-86"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>equalLength</span> <span class='hs-varid'>rep_tc_tvs</span> <span class='hs-varid'>all_rep_tc_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cls</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>rep_tc</span> <span class='hs-layout'>)</span>
<a name="line-87"></a>    <span class='hs-varid'>stupid_constraints</span> <span class='hs-varop'>++</span> <span class='hs-varid'>extra_constraints</span>
<a name="line-88"></a>    <span class='hs-varop'>++</span> <span class='hs-varid'>sc_constraints</span> <span class='hs-varop'>++</span> <span class='hs-varid'>con_arg_constraints</span>
<a name="line-89"></a>  <span class='hs-keyword'>where</span>
<a name="line-90"></a>       <span class='hs-comment'>-- Constraints arising from the arguments of each constructor</span>
<a name="line-91"></a>    <span class='hs-varid'>con_arg_constraints</span>
<a name="line-92"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>mkClassPred</span> <span class='hs-varid'>cls</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg_ty</span><span class='hs-keyglyph'>]</span>
<a name="line-93"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>data_con</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConDataCons</span> <span class='hs-varid'>rep_tc</span><span class='hs-layout'>,</span>
<a name="line-94"></a>          <span class='hs-varid'>arg_ty</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isVanillaDataCon</span> <span class='hs-varid'>data_con</span> <span class='hs-layout'>)</span>
<a name="line-95"></a>    			<span class='hs-varid'>get_constrained_tys</span> <span class='hs-varop'>$</span>
<a name="line-96"></a>    		 	<span class='hs-varid'>dataConInstOrigArgTys</span> <span class='hs-varid'>data_con</span> <span class='hs-varid'>all_rep_tc_args</span><span class='hs-layout'>,</span>
<a name="line-97"></a>          <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isUnLiftedType</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-98"></a>    		<span class='hs-comment'>-- No constraints for unlifted types</span>
<a name="line-99"></a>    		<span class='hs-comment'>-- See Note [Deriving and unboxed types]</span>
<a name="line-100"></a>
<a name="line-101"></a>    		<span class='hs-comment'>-- For functor-like classes, two things are different</span>
<a name="line-102"></a>    		<span class='hs-comment'>-- (a) We recurse over argument types to generate constraints</span>
<a name="line-103"></a>    		<span class='hs-comment'>--     See Functor examples in TcGenDeriv</span>
<a name="line-104"></a>    		<span class='hs-comment'>-- (b) The rep_tc_args will be one short</span>
<a name="line-105"></a>    <span class='hs-varid'>is_functor_like</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getUnique</span> <span class='hs-varid'>cls</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>functorLikeClassKeys</span>
<a name="line-106"></a>
<a name="line-107"></a>    <span class='hs-varid'>get_constrained_tys</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-108"></a>    <span class='hs-varid'>get_constrained_tys</span> <span class='hs-varid'>tys</span>
<a name="line-109"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_functor_like</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>deepSubtypesContaining</span> <span class='hs-varid'>last_tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-110"></a>    	<span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>	  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span>
<a name="line-111"></a>
<a name="line-112"></a>    <span class='hs-varid'>rep_tc_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConTyVars</span> <span class='hs-varid'>rep_tc</span>
<a name="line-113"></a>    <span class='hs-varid'>last_tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>last</span> <span class='hs-varid'>rep_tc_tvs</span>
<a name="line-114"></a>    <span class='hs-varid'>all_rep_tc_args</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_functor_like</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rep_tc_args</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>last_tv</span><span class='hs-keyglyph'>]</span>
<a name="line-115"></a>    		    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rep_tc_args</span>
<a name="line-116"></a>
<a name="line-117"></a>    	<span class='hs-comment'>-- Constraints arising from superclasses</span>
<a name="line-118"></a>    	<span class='hs-comment'>-- See Note [Superclasses of derived instance]</span>
<a name="line-119"></a>    <span class='hs-varid'>sc_constraints</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTheta</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipOpenTvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>classTyVars</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span> <span class='hs-varid'>inst_tys</span><span class='hs-layout'>)</span>
<a name="line-120"></a>    				<span class='hs-layout'>(</span><span class='hs-varid'>classSCTheta</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span>
<a name="line-121"></a>
<a name="line-122"></a>    	<span class='hs-comment'>-- Stupid constraints</span>
<a name="line-123"></a>    <span class='hs-varid'>stupid_constraints</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTheta</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConStupidTheta</span> <span class='hs-varid'>rep_tc</span><span class='hs-layout'>)</span>
<a name="line-124"></a>    <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipTopTvSubst</span> <span class='hs-varid'>rep_tc_tvs</span> <span class='hs-varid'>all_rep_tc_args</span>
<a name="line-125"></a>
<a name="line-126"></a>	<span class='hs-comment'>-- Extra Data constraints</span>
<a name="line-127"></a>	<span class='hs-comment'>-- The Data class (only) requires that for</span>
<a name="line-128"></a>	<span class='hs-comment'>--    instance (...) =&gt; Data (T t1 t2)</span>
<a name="line-129"></a>	<span class='hs-comment'>-- IF   t1:*, t2:*</span>
<a name="line-130"></a>	<span class='hs-comment'>-- THEN (Data t1, Data t2) are among the (...) constraints</span>
<a name="line-131"></a>	<span class='hs-comment'>-- Reason: when the IF holds, we generate a method</span>
<a name="line-132"></a>	<span class='hs-comment'>-- 	       dataCast2 f = gcast2 f</span>
<a name="line-133"></a>	<span class='hs-comment'>--         and we need the Data constraints to typecheck the method</span>
<a name="line-134"></a>    <span class='hs-varid'>extra_constraints</span>
<a name="line-135"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>cls</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>dataClassKey</span>
<a name="line-136"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>all</span> <span class='hs-layout'>(</span><span class='hs-varid'>isLiftedTypeKind</span> <span class='hs-varop'>.</span> <span class='hs-varid'>typeKind</span><span class='hs-layout'>)</span> <span class='hs-varid'>rep_tc_args</span>
<a name="line-137"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkClassPred</span> <span class='hs-varid'>cls</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rep_tc_args</span><span class='hs-keyglyph'>]</span>
<a name="line-138"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-139"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
</pre>\end{code}

Note [Deriving and unboxed types]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We have some special hacks to support things like
   data T = MkT Int# deriving( Ord, Show )

Specifically
  * For Show we use TcGenDeriv.box_if_necy to box the Int# into an Int
    (which we know how to show)

  * For Eq, Ord, we ust TcGenDeriv.primOrdOps to give Ord operations
    on some primitive types

It's all a bit ad hoc.


\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>------------------------------------------------------------------</span>
<a name="line-2"></a><span class='hs-comment'>-- Check side conditions that dis-allow derivability for particular classes</span>
<a name="line-3"></a><span class='hs-comment'>-- This is *apart* from the newtype-deriving mechanism</span>
<a name="line-4"></a><span class='hs-comment'>--</span>
<a name="line-5"></a><span class='hs-comment'>-- Here we get the representation tycon in case of family instances as it has</span>
<a name="line-6"></a><span class='hs-comment'>-- the data constructors - but we need to be careful to fall back to the</span>
<a name="line-7"></a><span class='hs-comment'>-- family tycon (with indexes) in error messages.</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="DerivStatus"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>DerivStatus</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CanDerive</span>
<a name="line-10"></a>		 <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DerivableClassError</span> <span class='hs-conid'>SDoc</span>	<span class='hs-comment'>-- Standard class, but can't do it</span>
<a name="line-11"></a>     		 <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NonDerivableClass</span>		<span class='hs-comment'>-- Non-standard class</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="checkSideConditions"></a><span class='hs-definition'>checkSideConditions</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DerivContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DerivStatus</span>
<a name="line-14"></a><span class='hs-definition'>checkSideConditions</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>mtheta</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>cls_tys</span> <span class='hs-varid'>rep_tc</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cond</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sideConditions</span> <span class='hs-varid'>mtheta</span> <span class='hs-varid'>cls</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>cond</span> <span class='hs-layout'>(</span><span class='hs-varid'>dflags</span><span class='hs-layout'>,</span> <span class='hs-varid'>rep_tc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-17"></a>	<span class='hs-conid'>Just</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DerivableClassError</span> <span class='hs-varid'>err</span>	<span class='hs-comment'>-- Class-specific error</span>
<a name="line-18"></a>	<span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>cls_tys</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CanDerive</span>	<span class='hs-comment'>-- All derivable classes are unary, so</span>
<a name="line-19"></a>						<span class='hs-comment'>-- cls_tys (the type args other than last)</span>
<a name="line-20"></a>						<span class='hs-comment'>-- should be null</span>
<a name="line-21"></a>		 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DerivableClassError</span> <span class='hs-varid'>ty_args_why</span>	<span class='hs-comment'>-- e.g. deriving( Eq s )</span>
<a name="line-22"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NonDerivableClass</span>	<span class='hs-comment'>-- Not a standard class</span>
<a name="line-23"></a>  <span class='hs-keyword'>where</span>
<a name="line-24"></a>    <span class='hs-varid'>ty_args_why</span>	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkClassPred</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>cls_tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is not a class"</span><span class='hs-layout'>)</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="checkTypeableConditions"></a><span class='hs-definition'>checkTypeableConditions</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Condition</span>
<a name="line-27"></a><span class='hs-definition'>checkTypeableConditions</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkFlag</span> <span class='hs-conid'>Opt_DeriveDataTypeable</span> <span class='hs-varop'>`andCond`</span> <span class='hs-varid'>cond_typeableOK</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="nonStdErr"></a><span class='hs-definition'>nonStdErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-30"></a><span class='hs-definition'>nonStdErr</span> <span class='hs-varid'>cls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is not a derivable class"</span><span class='hs-layout'>)</span>
<a name="line-31"></a>
<a name="line-32"></a><a name="sideConditions"></a><span class='hs-definition'>sideConditions</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DerivContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Condition</span>
<a name="line-33"></a><span class='hs-definition'>sideConditions</span> <span class='hs-varid'>mtheta</span> <span class='hs-varid'>cls</span>
<a name="line-34"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>cls_key</span> <span class='hs-varop'>==</span> <span class='hs-varid'>eqClassKey</span>      	   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>cond_std</span> <span class='hs-varop'>`andCond`</span> <span class='hs-varid'>cond_args</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span>
<a name="line-35"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>cls_key</span> <span class='hs-varop'>==</span> <span class='hs-varid'>ordClassKey</span>     	   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>cond_std</span> <span class='hs-varop'>`andCond`</span> <span class='hs-varid'>cond_args</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span>
<a name="line-36"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>cls_key</span> <span class='hs-varop'>==</span> <span class='hs-varid'>showClassKey</span>    	   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>cond_std</span> <span class='hs-varop'>`andCond`</span> <span class='hs-varid'>cond_args</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span>
<a name="line-37"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>cls_key</span> <span class='hs-varop'>==</span> <span class='hs-varid'>readClassKey</span>    	   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>cond_std</span> <span class='hs-varop'>`andCond`</span> <span class='hs-varid'>cond_args</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span>
<a name="line-38"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>cls_key</span> <span class='hs-varop'>==</span> <span class='hs-varid'>enumClassKey</span>    	   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>cond_std</span> <span class='hs-varop'>`andCond`</span> <span class='hs-varid'>cond_isEnumeration</span><span class='hs-layout'>)</span>
<a name="line-39"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>cls_key</span> <span class='hs-varop'>==</span> <span class='hs-varid'>ixClassKey</span>      	   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>cond_std</span> <span class='hs-varop'>`andCond`</span> <span class='hs-varid'>cond_enumOrProduct</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span>
<a name="line-40"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>cls_key</span> <span class='hs-varop'>==</span> <span class='hs-varid'>boundedClassKey</span> 	   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>cond_std</span> <span class='hs-varop'>`andCond`</span> <span class='hs-varid'>cond_enumOrProduct</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span>
<a name="line-41"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>cls_key</span> <span class='hs-varop'>==</span> <span class='hs-varid'>dataClassKey</span>    	   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>checkFlag</span> <span class='hs-conid'>Opt_DeriveDataTypeable</span> <span class='hs-varop'>`andCond`</span>
<a name="line-42"></a>                                           <span class='hs-varid'>cond_std</span> <span class='hs-varop'>`andCond`</span> <span class='hs-varid'>cond_args</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span>
<a name="line-43"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>cls_key</span> <span class='hs-varop'>==</span> <span class='hs-varid'>functorClassKey</span> 	   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>checkFlag</span> <span class='hs-conid'>Opt_DeriveFunctor</span> <span class='hs-varop'>`andCond`</span>
<a name="line-44"></a>    	                                   <span class='hs-varid'>cond_functorOK</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span>	 <span class='hs-comment'>-- NB: no cond_std!</span>
<a name="line-45"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>cls_key</span> <span class='hs-varop'>==</span> <span class='hs-varid'>foldableClassKey</span>	   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>checkFlag</span> <span class='hs-conid'>Opt_DeriveFoldable</span> <span class='hs-varop'>`andCond`</span>
<a name="line-46"></a>    	                                   <span class='hs-varid'>cond_functorOK</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Functor/Fold/Trav works ok for rank-n types</span>
<a name="line-47"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>cls_key</span> <span class='hs-varop'>==</span> <span class='hs-varid'>traversableClassKey</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>checkFlag</span> <span class='hs-conid'>Opt_DeriveTraversable</span> <span class='hs-varop'>`andCond`</span>
<a name="line-48"></a>    	                                   <span class='hs-varid'>cond_functorOK</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-49"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>cls_key</span> <span class='hs-varop'>==</span> <span class='hs-varid'>genClassKey</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>cond_RepresentableOk</span> <span class='hs-varop'>`andCond`</span>
<a name="line-50"></a>                                           <span class='hs-varid'>checkFlag</span> <span class='hs-conid'>Opt_DeriveGeneric</span><span class='hs-layout'>)</span>
<a name="line-51"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-52"></a>  <span class='hs-keyword'>where</span>
<a name="line-53"></a>    <span class='hs-varid'>cls_key</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getUnique</span> <span class='hs-varid'>cls</span>
<a name="line-54"></a>    <span class='hs-varid'>cond_std</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cond_stdOK</span> <span class='hs-varid'>mtheta</span>
<a name="line-55"></a>
<a name="line-56"></a><a name="Condition"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>Condition</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>DynFlags</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyCon</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>SDoc</span>
<a name="line-57"></a>	<span class='hs-comment'>-- first Bool is whether or not we are allowed to derive Data and Typeable</span>
<a name="line-58"></a>	<span class='hs-comment'>-- second Bool is whether or not we are allowed to derive Functor</span>
<a name="line-59"></a>	<span class='hs-comment'>-- TyCon is the *representation* tycon if the</span>
<a name="line-60"></a>	<span class='hs-comment'>--	data type is an indexed one</span>
<a name="line-61"></a>	<span class='hs-comment'>-- Nothing =&gt; OK</span>
<a name="line-62"></a>
<a name="line-63"></a><a name="orCond"></a><span class='hs-definition'>orCond</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Condition</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Condition</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Condition</span>
<a name="line-64"></a><span class='hs-definition'>orCond</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>c2</span> <span class='hs-varid'>tc</span>
<a name="line-65"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>of</span>
<a name="line-66"></a>	<span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>	    <span class='hs-comment'>-- c1 succeeds</span>
<a name="line-67"></a>	<span class='hs-conid'>Just</span> <span class='hs-varid'>x</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>c2</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>of</span>    <span class='hs-comment'>-- c1 fails</span>
<a name="line-68"></a>		     <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-69"></a>		     <span class='hs-conid'>Just</span> <span class='hs-varid'>y</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"  or"</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>y</span><span class='hs-layout'>)</span>
<a name="line-70"></a>			            <span class='hs-comment'>-- Both fail</span>
<a name="line-71"></a>
<a name="line-72"></a><a name="andCond"></a><span class='hs-definition'>andCond</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Condition</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Condition</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Condition</span>
<a name="line-73"></a><span class='hs-definition'>andCond</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>c2</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>of</span>
<a name="line-74"></a>		     <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>c2</span> <span class='hs-varid'>tc</span>	<span class='hs-comment'>-- c1 succeeds</span>
<a name="line-75"></a>		     <span class='hs-conid'>Just</span> <span class='hs-varid'>x</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>x</span>	<span class='hs-comment'>-- c1 fails</span>
<a name="line-76"></a>
<a name="line-77"></a><a name="cond_stdOK"></a><span class='hs-definition'>cond_stdOK</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DerivContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Condition</span>
<a name="line-78"></a><span class='hs-definition'>cond_stdOK</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>
<a name="line-79"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>	<span class='hs-comment'>-- Don't check these conservative conditions for</span>
<a name="line-80"></a>		<span class='hs-comment'>-- standalone deriving; just generate the code</span>
<a name="line-81"></a>		<span class='hs-comment'>-- and let the typechecker handle the result</span>
<a name="line-82"></a><span class='hs-definition'>cond_stdOK</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>rep_tc</span><span class='hs-layout'>)</span>
<a name="line-83"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>data_cons</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>no_cons_why</span> <span class='hs-varid'>rep_tc</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>suggestion</span><span class='hs-layout'>)</span>
<a name="line-84"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>con_whys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-varid'>con_whys</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>suggestion</span><span class='hs-layout'>)</span>
<a name="line-85"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      	<span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-86"></a>  <span class='hs-keyword'>where</span>
<a name="line-87"></a>    <span class='hs-varid'>suggestion</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Possible fix: use a standalone deriving declaration instead"</span><span class='hs-layout'>)</span>
<a name="line-88"></a>    <span class='hs-varid'>data_cons</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConDataCons</span> <span class='hs-varid'>rep_tc</span>
<a name="line-89"></a>    <span class='hs-varid'>con_whys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapCatMaybes</span> <span class='hs-varid'>check_con</span> <span class='hs-varid'>data_cons</span>
<a name="line-90"></a>
<a name="line-91"></a>    <span class='hs-varid'>check_con</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>SDoc</span>
<a name="line-92"></a>    <span class='hs-varid'>check_con</span> <span class='hs-varid'>con</span>
<a name="line-93"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isVanillaDataCon</span> <span class='hs-varid'>con</span>
<a name="line-94"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isTauTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConOrigArgTys</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-95"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>badCon</span> <span class='hs-varid'>con</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"must have a Haskell-98 type"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-96"></a>
<a name="line-97"></a><a name="no_cons_why"></a><span class='hs-definition'>no_cons_why</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-98"></a><span class='hs-definition'>no_cons_why</span> <span class='hs-varid'>rep_tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprSourceTyCon</span> <span class='hs-varid'>rep_tc</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-99"></a>		     <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"must have at least one data constructor"</span><span class='hs-layout'>)</span>
<a name="line-100"></a>
<a name="line-101"></a><a name="cond_RepresentableOk"></a><span class='hs-definition'>cond_RepresentableOk</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Condition</span>
<a name="line-102"></a><span class='hs-definition'>cond_RepresentableOk</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>canDoGenerics</span> <span class='hs-varid'>t</span>
<a name="line-103"></a>
<a name="line-104"></a><a name="cond_enumOrProduct"></a><span class='hs-definition'>cond_enumOrProduct</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Condition</span>
<a name="line-105"></a><span class='hs-definition'>cond_enumOrProduct</span> <span class='hs-varid'>cls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cond_isEnumeration</span> <span class='hs-varop'>`orCond`</span>
<a name="line-106"></a>		         <span class='hs-layout'>(</span><span class='hs-varid'>cond_isProduct</span> <span class='hs-varop'>`andCond`</span> <span class='hs-varid'>cond_args</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span>
<a name="line-107"></a>
<a name="line-108"></a><a name="cond_args"></a><span class='hs-definition'>cond_args</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Condition</span>
<a name="line-109"></a><span class='hs-comment'>-- For some classes (eg Eq, Ord) we allow unlifted arg types</span>
<a name="line-110"></a><span class='hs-comment'>-- by generating specilaised code.  For others (eg Data) we don't.</span>
<a name="line-111"></a><span class='hs-definition'>cond_args</span> <span class='hs-varid'>cls</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-112"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>bad_args</span> <span class='hs-keyword'>of</span>
<a name="line-113"></a>      <span class='hs-conid'>[]</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-114"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Don't know how to derive"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-115"></a>                         <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"for type"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-116"></a>  <span class='hs-keyword'>where</span>
<a name="line-117"></a>    <span class='hs-varid'>bad_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>arg_ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConDataCons</span> <span class='hs-varid'>tc</span>
<a name="line-118"></a>		        <span class='hs-layout'>,</span> <span class='hs-varid'>arg_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dataConOrigArgTys</span> <span class='hs-varid'>con</span>
<a name="line-119"></a>			<span class='hs-layout'>,</span> <span class='hs-varid'>isUnLiftedType</span> <span class='hs-varid'>arg_ty</span>
<a name="line-120"></a>                     	<span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>ok_ty</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-121"></a>
<a name="line-122"></a>    <span class='hs-varid'>cls_key</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>classKey</span> <span class='hs-varid'>cls</span>
<a name="line-123"></a>    <span class='hs-varid'>ok_ty</span> <span class='hs-varid'>arg_ty</span>
<a name="line-124"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>cls_key</span> <span class='hs-varop'>==</span> <span class='hs-varid'>eqClassKey</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>check_in</span> <span class='hs-varid'>arg_ty</span> <span class='hs-varid'>ordOpTbl</span>
<a name="line-125"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>cls_key</span> <span class='hs-varop'>==</span> <span class='hs-varid'>ordClassKey</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>check_in</span> <span class='hs-varid'>arg_ty</span> <span class='hs-varid'>ordOpTbl</span>
<a name="line-126"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>cls_key</span> <span class='hs-varop'>==</span> <span class='hs-varid'>showClassKey</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>check_in</span> <span class='hs-varid'>arg_ty</span> <span class='hs-varid'>boxConTbl</span>
<a name="line-127"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>    <span class='hs-comment'>-- Read, Ix etc</span>
<a name="line-128"></a>
<a name="line-129"></a>    <span class='hs-varid'>check_in</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span><span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-130"></a>    <span class='hs-varid'>check_in</span> <span class='hs-varid'>arg_ty</span> <span class='hs-varid'>tbl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>eqType</span> <span class='hs-varid'>arg_ty</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fst</span><span class='hs-layout'>)</span> <span class='hs-varid'>tbl</span>
<a name="line-131"></a>
<a name="line-132"></a>
<a name="line-133"></a><a name="cond_isEnumeration"></a><span class='hs-definition'>cond_isEnumeration</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Condition</span>
<a name="line-134"></a><span class='hs-definition'>cond_isEnumeration</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>rep_tc</span><span class='hs-layout'>)</span>
<a name="line-135"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEnumerationTyCon</span> <span class='hs-varid'>rep_tc</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-136"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>		        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>why</span>
<a name="line-137"></a>  <span class='hs-keyword'>where</span>
<a name="line-138"></a>    <span class='hs-varid'>why</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprSourceTyCon</span> <span class='hs-varid'>rep_tc</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-139"></a>	          <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"must be an enumeration type"</span><span class='hs-layout'>)</span>
<a name="line-140"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"(an enumeration consists of one or more nullary, non-GADT constructors)"</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-141"></a>		  <span class='hs-comment'>-- See Note [Enumeration types] in TyCon</span>
<a name="line-142"></a>
<a name="line-143"></a><a name="cond_isProduct"></a><span class='hs-definition'>cond_isProduct</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Condition</span>
<a name="line-144"></a><span class='hs-definition'>cond_isProduct</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>rep_tc</span><span class='hs-layout'>)</span>
<a name="line-145"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isProductTyCon</span> <span class='hs-varid'>rep_tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-146"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>	          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>why</span>
<a name="line-147"></a>  <span class='hs-keyword'>where</span>
<a name="line-148"></a>    <span class='hs-varid'>why</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprSourceTyCon</span> <span class='hs-varid'>rep_tc</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-149"></a>	  <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"must have precisely one constructor"</span><span class='hs-layout'>)</span>
<a name="line-150"></a>
<a name="line-151"></a><a name="cond_typeableOK"></a><span class='hs-definition'>cond_typeableOK</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Condition</span>
<a name="line-152"></a><span class='hs-comment'>-- OK for Typeable class</span>
<a name="line-153"></a><span class='hs-comment'>-- Currently: (a) args all of kind *</span>
<a name="line-154"></a><span class='hs-comment'>--	      (b) 7 or fewer args</span>
<a name="line-155"></a><span class='hs-definition'>cond_typeableOK</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-156"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>7</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>too_many</span>
<a name="line-157"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>all</span> <span class='hs-layout'>(</span><span class='hs-varid'>isSubArgTypeKind</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyVarKind</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConTyVars</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-158"></a>                      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>bad_kind</span>
<a name="line-159"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>	      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-160"></a>  <span class='hs-keyword'>where</span>
<a name="line-161"></a>    <span class='hs-varid'>too_many</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprSourceTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-162"></a>	       <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"must have 7 or fewer arguments"</span><span class='hs-layout'>)</span>
<a name="line-163"></a>    <span class='hs-varid'>bad_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprSourceTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-164"></a>	       <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"must only have arguments of kind `*'"</span><span class='hs-layout'>)</span>
<a name="line-165"></a>
<a name="line-166"></a><a name="functorLikeClassKeys"></a><span class='hs-definition'>functorLikeClassKeys</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Unique</span><span class='hs-keyglyph'>]</span>
<a name="line-167"></a><span class='hs-definition'>functorLikeClassKeys</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>functorClassKey</span><span class='hs-layout'>,</span> <span class='hs-varid'>foldableClassKey</span><span class='hs-layout'>,</span> <span class='hs-varid'>traversableClassKey</span><span class='hs-keyglyph'>]</span>
<a name="line-168"></a>
<a name="line-169"></a><a name="cond_functorOK"></a><span class='hs-definition'>cond_functorOK</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Condition</span>
<a name="line-170"></a><span class='hs-comment'>-- OK for Functor/Foldable/Traversable class</span>
<a name="line-171"></a><span class='hs-comment'>-- Currently: (a) at least one argument</span>
<a name="line-172"></a><span class='hs-comment'>--            (b) don't use argument contravariantly</span>
<a name="line-173"></a><span class='hs-comment'>--            (c) don't use argument in the wrong place, e.g. data T a = T (X a a)</span>
<a name="line-174"></a><span class='hs-comment'>--            (d) optionally: don't use function types</span>
<a name="line-175"></a><span class='hs-comment'>--            (e) no "stupid context" on data type</span>
<a name="line-176"></a><span class='hs-definition'>cond_functorOK</span> <span class='hs-varid'>allowFunctions</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>rep_tc</span><span class='hs-layout'>)</span>
<a name="line-177"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>tc_tvs</span>
<a name="line-178"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Data type"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>rep_tc</span><span class='hs-layout'>)</span>
<a name="line-179"></a>          <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"must have some type parameters"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-180"></a>
<a name="line-181"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>bad_stupid_theta</span><span class='hs-layout'>)</span>
<a name="line-182"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Data type"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>rep_tc</span><span class='hs-layout'>)</span>
<a name="line-183"></a>          <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"must not have a class context"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprTheta</span> <span class='hs-varid'>bad_stupid_theta</span><span class='hs-layout'>)</span>
<a name="line-184"></a>
<a name="line-185"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-186"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>msum</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>check_con</span> <span class='hs-varid'>data_cons</span><span class='hs-layout'>)</span>	<span class='hs-comment'>-- msum picks the first 'Just', if any</span>
<a name="line-187"></a>  <span class='hs-keyword'>where</span>
<a name="line-188"></a>    <span class='hs-varid'>tc_tvs</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConTyVars</span> <span class='hs-varid'>rep_tc</span>
<a name="line-189"></a>    <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>last_tv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>snocView</span> <span class='hs-varid'>tc_tvs</span>
<a name="line-190"></a>    <span class='hs-varid'>bad_stupid_theta</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>is_bad</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConStupidTheta</span> <span class='hs-varid'>rep_tc</span><span class='hs-layout'>)</span>
<a name="line-191"></a>    <span class='hs-varid'>is_bad</span> <span class='hs-varid'>pred</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>last_tv</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>pred</span>
<a name="line-192"></a>
<a name="line-193"></a>    <span class='hs-varid'>data_cons</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConDataCons</span> <span class='hs-varid'>rep_tc</span>
<a name="line-194"></a>    <span class='hs-varid'>check_con</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>msum</span> <span class='hs-layout'>(</span><span class='hs-varid'>check_vanilla</span> <span class='hs-varid'>con</span> <span class='hs-conop'>:</span> <span class='hs-varid'>foldDataConArgs</span> <span class='hs-layout'>(</span><span class='hs-varid'>ft_check</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span>
<a name="line-195"></a>
<a name="line-196"></a>    <span class='hs-varid'>check_vanilla</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>SDoc</span>
<a name="line-197"></a>    <span class='hs-varid'>check_vanilla</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isVanillaDataCon</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-198"></a>    		      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>	     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>badCon</span> <span class='hs-varid'>con</span> <span class='hs-varid'>existential</span><span class='hs-layout'>)</span>
<a name="line-199"></a>
<a name="line-200"></a>    <span class='hs-varid'>ft_check</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FFoldType</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span>
<a name="line-201"></a>    <span class='hs-varid'>ft_check</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FT</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ft_triv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_var</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-202"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>ft_co_var</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>badCon</span> <span class='hs-varid'>con</span> <span class='hs-varid'>covariant</span><span class='hs-layout'>)</span>
<a name="line-203"></a>	      	      <span class='hs-layout'>,</span> <span class='hs-varid'>ft_fun</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>x</span> <span class='hs-varid'>y</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>allowFunctions</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>x</span> <span class='hs-varop'>`mplus`</span> <span class='hs-varid'>y</span>
<a name="line-204"></a>                                                           <span class='hs-keyword'>else</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>badCon</span> <span class='hs-varid'>con</span> <span class='hs-varid'>functions</span><span class='hs-layout'>)</span>
<a name="line-205"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>ft_tup</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-varid'>xs</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>msum</span> <span class='hs-varid'>xs</span>
<a name="line-206"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>ft_ty_app</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-varid'>x</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>x</span>
<a name="line-207"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>ft_bad_app</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>badCon</span> <span class='hs-varid'>con</span> <span class='hs-varid'>wrong_arg</span><span class='hs-layout'>)</span>
<a name="line-208"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>ft_forall</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-varid'>x</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>x</span> <span class='hs-layout'>}</span>
<a name="line-209"></a>
<a name="line-210"></a>    <span class='hs-varid'>existential</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"must not have existential arguments"</span><span class='hs-layout'>)</span>
<a name="line-211"></a>    <span class='hs-varid'>covariant</span> 	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"must not use the type variable in a function argument"</span><span class='hs-layout'>)</span>
<a name="line-212"></a>    <span class='hs-varid'>functions</span> 	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"must not contain function types"</span><span class='hs-layout'>)</span>
<a name="line-213"></a>    <span class='hs-varid'>wrong_arg</span> 	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"must not use the type variable in an argument other than the last"</span><span class='hs-layout'>)</span>
<a name="line-214"></a>
<a name="line-215"></a><a name="checkFlag"></a><span class='hs-definition'>checkFlag</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ExtensionFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Condition</span>
<a name="line-216"></a><span class='hs-definition'>checkFlag</span> <span class='hs-varid'>flag</span> <span class='hs-layout'>(</span><span class='hs-varid'>dflags</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-217"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>xopt</span> <span class='hs-varid'>flag</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-218"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>why</span>
<a name="line-219"></a>  <span class='hs-keyword'>where</span>
<a name="line-220"></a>    <span class='hs-varid'>why</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"You need -X"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-varid'>flag_str</span>
<a name="line-221"></a>          <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"to derive an instance for this class"</span><span class='hs-layout'>)</span>
<a name="line-222"></a>    <span class='hs-varid'>flag_str</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>f</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xFlags</span><span class='hs-layout'>,</span> <span class='hs-varid'>f</span><span class='hs-varop'>==</span><span class='hs-varid'>flag</span> <span class='hs-keyglyph'>]</span> <span class='hs-keyword'>of</span>
<a name="line-223"></a>                 <span class='hs-keyglyph'>[</span><span class='hs-varid'>s</span><span class='hs-keyglyph'>]</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>s</span>
<a name="line-224"></a>                 <span class='hs-varid'>other</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"checkFlag"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>other</span><span class='hs-layout'>)</span>
<a name="line-225"></a>
<a name="line-226"></a><a name="std_class_via_iso"></a><span class='hs-definition'>std_class_via_iso</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-227"></a><span class='hs-comment'>-- These standard classes can be derived for a newtype</span>
<a name="line-228"></a><span class='hs-comment'>-- using the isomorphism trick *even if no -XGeneralizedNewtypeDeriving</span>
<a name="line-229"></a><span class='hs-comment'>-- because giving so gives the same results as generating the boilerplate</span>
<a name="line-230"></a><span class='hs-definition'>std_class_via_iso</span> <span class='hs-varid'>clas</span>
<a name="line-231"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>classKey</span> <span class='hs-varid'>clas</span> <span class='hs-varop'>`elem`</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>eqClassKey</span><span class='hs-layout'>,</span> <span class='hs-varid'>ordClassKey</span><span class='hs-layout'>,</span> <span class='hs-varid'>ixClassKey</span><span class='hs-layout'>,</span> <span class='hs-varid'>boundedClassKey</span><span class='hs-keyglyph'>]</span>
<a name="line-232"></a>	<span class='hs-comment'>-- Not Read/Show because they respect the type</span>
<a name="line-233"></a>	<span class='hs-comment'>-- Not Enum, because newtypes are never in Enum</span>
<a name="line-234"></a>
<a name="line-235"></a>
<a name="line-236"></a><a name="non_iso_class"></a><span class='hs-definition'>non_iso_class</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-237"></a><span class='hs-comment'>-- *Never* derive Read, Show, Typeable, Data, Generic by isomorphism,</span>
<a name="line-238"></a><span class='hs-comment'>-- even with -XGeneralizedNewtypeDeriving</span>
<a name="line-239"></a><span class='hs-definition'>non_iso_class</span> <span class='hs-varid'>cls</span>
<a name="line-240"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>classKey</span> <span class='hs-varid'>cls</span> <span class='hs-varop'>`elem`</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span> <span class='hs-varid'>readClassKey</span><span class='hs-layout'>,</span> <span class='hs-varid'>showClassKey</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataClassKey</span>
<a name="line-241"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>genClassKey</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>++</span> <span class='hs-varid'>typeableClassKeys</span><span class='hs-layout'>)</span>
<a name="line-242"></a>
<a name="line-243"></a><a name="typeableClassKeys"></a><span class='hs-definition'>typeableClassKeys</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Unique</span><span class='hs-keyglyph'>]</span>
<a name="line-244"></a><span class='hs-definition'>typeableClassKeys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>getUnique</span> <span class='hs-varid'>typeableClassNames</span>
<a name="line-245"></a>
<a name="line-246"></a><a name="new_dfun_name"></a><span class='hs-definition'>new_dfun_name</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Name</span>
<a name="line-247"></a><span class='hs-definition'>new_dfun_name</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tycon</span> 	<span class='hs-comment'>-- Just a simple wrapper</span>
<a name="line-248"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>	<span class='hs-comment'>-- The location of the instance decl, not of the tycon</span>
<a name="line-249"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>newDFunName</span> <span class='hs-varid'>clas</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-conid'>[]</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span>
<a name="line-250"></a>	<span class='hs-comment'>-- The type passed to newDFunName is only used to generate</span>
<a name="line-251"></a>	<span class='hs-comment'>-- a suitable string; hence the empty type arg list</span>
<a name="line-252"></a>
<a name="line-253"></a><a name="badCon"></a><span class='hs-definition'>badCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-254"></a><span class='hs-definition'>badCon</span> <span class='hs-varid'>con</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Constructor"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>msg</span>
</pre>\end{code}

Note [Superclasses of derived instance]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In general, a derived instance decl needs the superclasses of the derived
class too.  So if we have
	data T a = ...deriving( Ord )
then the initial context for Ord (T a) should include Eq (T a).  Often this is
redundant; we'll also generate an Ord constraint for each constructor argument,
and that will probably generate enough constraints to make the Eq (T a) constraint
be satisfied too.  But not always; consider:

 data S a = S
 instance Eq (S a)
 instance Ord (S a)

 data T a = MkT (S a) deriving( Ord )
 instance Num a => Eq (T a)

The derived instance for (Ord (T a)) must have a (Num a) constraint!
Similarly consider:
	data T a = MkT deriving( Data, Typeable )
Here there *is* no argument field, but we must nevertheless generate
a context for the Data instances:
	instance Typable a => Data (T a) where ...


%************************************************************************
%*									*
		Deriving newtypes
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="mkNewTypeEqn"></a><span class='hs-definition'>mkNewTypeEqn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span>
<a name="line-2"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-3"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DerivContext</span>
<a name="line-4"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRn</span> <span class='hs-conid'>EarlyDerivSpec</span>
<a name="line-5"></a><span class='hs-definition'>mkNewTypeEqn</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>tvs</span>
<a name="line-6"></a>             <span class='hs-varid'>cls</span> <span class='hs-varid'>cls_tys</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>tc_args</span> <span class='hs-varid'>rep_tycon</span> <span class='hs-varid'>rep_tc_args</span> <span class='hs-varid'>mtheta</span>
<a name="line-7"></a><span class='hs-comment'>-- Want: instance (...) =&gt; cls (cls_tys ++ [tycon tc_args]) where ...</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>can_derive_via_isomorphism</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>newtype_deriving</span> <span class='hs-varop'>||</span> <span class='hs-varid'>std_class_via_iso</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"newtype deriving:"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tycon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>rep_tys</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>all_preds</span><span class='hs-layout'>)</span>
<a name="line-10"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>dfun_name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>new_dfun_name</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tycon</span>
<a name="line-11"></a>  	<span class='hs-layout'>;</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-12"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>spec</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ds_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span><span class='hs-layout'>,</span> <span class='hs-varid'>ds_orig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orig</span>
<a name="line-13"></a>			<span class='hs-layout'>,</span> <span class='hs-varid'>ds_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dfun_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>ds_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>varSetElemsKvsFirst</span> <span class='hs-varid'>dfun_tvs</span>
<a name="line-14"></a>			<span class='hs-layout'>,</span> <span class='hs-varid'>ds_cls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>ds_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_tys</span>
<a name="line-15"></a>			<span class='hs-layout'>,</span> <span class='hs-varid'>ds_tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rep_tycon</span><span class='hs-layout'>,</span> <span class='hs-varid'>ds_tc_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rep_tc_args</span>
<a name="line-16"></a>			<span class='hs-layout'>,</span> <span class='hs-varid'>ds_theta</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>mtheta</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>all_preds</span>
<a name="line-17"></a>			<span class='hs-layout'>,</span> <span class='hs-varid'>ds_newtype</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span>
<a name="line-18"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>isJust</span> <span class='hs-varid'>mtheta</span> <span class='hs-keyword'>then</span> <span class='hs-conid'>Right</span> <span class='hs-varid'>spec</span>
<a name="line-19"></a>				   <span class='hs-keyword'>else</span> <span class='hs-conid'>Left</span> <span class='hs-varid'>spec</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-20"></a>
<a name="line-21"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-22"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>checkSideConditions</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>mtheta</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>cls_tys</span> <span class='hs-varid'>rep_tycon</span> <span class='hs-keyword'>of</span>
<a name="line-23"></a>      <span class='hs-conid'>CanDerive</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go_for_it</span> 	<span class='hs-comment'>-- Use the standard H98 method</span>
<a name="line-24"></a>      <span class='hs-conid'>DerivableClassError</span> <span class='hs-varid'>msg</span> 	<span class='hs-comment'>-- Error with standard class</span>
<a name="line-25"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>can_derive_via_isomorphism</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>bale_out</span> <span class='hs-layout'>(</span><span class='hs-varid'>msg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>suggest_nd</span><span class='hs-layout'>)</span>
<a name="line-26"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>bale_out</span> <span class='hs-varid'>msg</span>
<a name="line-27"></a>      <span class='hs-conid'>NonDerivableClass</span> 	<span class='hs-comment'>-- Must use newtype deriving</span>
<a name="line-28"></a>      	<span class='hs-keyglyph'>|</span> <span class='hs-varid'>newtype_deriving</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>bale_out</span> <span class='hs-varid'>cant_derive_err</span>  <span class='hs-comment'>-- Too hard, even with newtype deriving</span>
<a name="line-29"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>can_derive_via_isomorphism</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>bale_out</span> <span class='hs-layout'>(</span><span class='hs-varid'>non_std</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>suggest_nd</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Try newtype deriving!</span>
<a name="line-30"></a>      	<span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>bale_out</span> <span class='hs-varid'>non_std</span>
<a name="line-31"></a>  <span class='hs-keyword'>where</span>
<a name="line-32"></a>        <span class='hs-varid'>newtype_deriving</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xopt</span> <span class='hs-conid'>Opt_GeneralizedNewtypeDeriving</span> <span class='hs-varid'>dflags</span>
<a name="line-33"></a>        <span class='hs-varid'>go_for_it</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_data_eqn</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>tc_args</span> <span class='hs-varid'>rep_tycon</span> <span class='hs-varid'>rep_tc_args</span> <span class='hs-varid'>mtheta</span>
<a name="line-34"></a>	<span class='hs-varid'>bale_out</span> <span class='hs-varid'>msg</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>derivingThingErr</span> <span class='hs-varid'>newtype_deriving</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>cls_tys</span> <span class='hs-varid'>inst_ty</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span>
<a name="line-35"></a>
<a name="line-36"></a>	<span class='hs-varid'>non_std</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nonStdErr</span> <span class='hs-varid'>cls</span>
<a name="line-37"></a>        <span class='hs-varid'>suggest_nd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Try -XGeneralizedNewtypeDeriving for GHC's newtype-deriving extension"</span><span class='hs-layout'>)</span>
<a name="line-38"></a>
<a name="line-39"></a>	<span class='hs-comment'>-- Here is the plan for newtype derivings.  We see</span>
<a name="line-40"></a>	<span class='hs-comment'>--	  newtype T a1...an = MkT (t ak+1...an) deriving (.., C s1 .. sm, ...)</span>
<a name="line-41"></a>	<span class='hs-comment'>-- where t is a type,</span>
<a name="line-42"></a>	<span class='hs-comment'>-- 	 ak+1...an is a suffix of a1..an, and are all tyars</span>
<a name="line-43"></a>	<span class='hs-comment'>--	 ak+1...an do not occur free in t, nor in the s1..sm</span>
<a name="line-44"></a>	<span class='hs-comment'>-- 	 (C s1 ... sm) is a  *partial applications* of class C</span>
<a name="line-45"></a>	<span class='hs-comment'>--			with the last parameter missing</span>
<a name="line-46"></a>	<span class='hs-comment'>--	 (T a1 .. ak) matches the kind of C's last argument</span>
<a name="line-47"></a>	<span class='hs-comment'>--		(and hence so does t)</span>
<a name="line-48"></a>	<span class='hs-comment'>-- The latter kind-check has been done by deriveTyData already,</span>
<a name="line-49"></a>	<span class='hs-comment'>-- and tc_args are already trimmed</span>
<a name="line-50"></a>	<span class='hs-comment'>--</span>
<a name="line-51"></a>	<span class='hs-comment'>-- We generate the instance</span>
<a name="line-52"></a>	<span class='hs-comment'>--	 instance forall ({a1..ak} u fvs(s1..sm)).</span>
<a name="line-53"></a>	<span class='hs-comment'>--		  C s1 .. sm t =&gt; C s1 .. sm (T a1...ak)</span>
<a name="line-54"></a>	<span class='hs-comment'>-- where T a1...ap is the partial application of</span>
<a name="line-55"></a>	<span class='hs-comment'>-- 	 the LHS of the correct kind and p &gt;= k</span>
<a name="line-56"></a>	<span class='hs-comment'>--</span>
<a name="line-57"></a>	<span class='hs-comment'>--	NB: the variables below are:</span>
<a name="line-58"></a>	<span class='hs-comment'>--		tc_tvs = [a1, ..., an]</span>
<a name="line-59"></a>	<span class='hs-comment'>--		tyvars_to_keep = [a1, ..., ak]</span>
<a name="line-60"></a>	<span class='hs-comment'>--		rep_ty = t ak .. an</span>
<a name="line-61"></a>	<span class='hs-comment'>--		deriv_tvs = fvs(s1..sm) \ tc_tvs</span>
<a name="line-62"></a>	<span class='hs-comment'>--		tys = [s1, ..., sm]</span>
<a name="line-63"></a>	<span class='hs-comment'>--		rep_fn' = t</span>
<a name="line-64"></a>	<span class='hs-comment'>--</span>
<a name="line-65"></a>	<span class='hs-comment'>-- Running example: newtype T s a = MkT (ST s a) deriving( Monad )</span>
<a name="line-66"></a>	<span class='hs-comment'>-- We generate the instance</span>
<a name="line-67"></a>	<span class='hs-comment'>--	instance Monad (ST s) =&gt; Monad (T s) where</span>
<a name="line-68"></a>
<a name="line-69"></a>	<span class='hs-varid'>nt_eta_arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-layout'>(</span><span class='hs-varid'>fst</span> <span class='hs-layout'>(</span><span class='hs-varid'>newTyConEtadRhs</span> <span class='hs-varid'>rep_tycon</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-70"></a>		<span class='hs-comment'>-- For newtype T a b = MkT (S a a b), the TyCon machinery already</span>
<a name="line-71"></a>		<span class='hs-comment'>-- eta-reduces the representation type, so we know that</span>
<a name="line-72"></a>		<span class='hs-comment'>-- 	T a ~ S a a</span>
<a name="line-73"></a>		<span class='hs-comment'>-- That's convenient here, because we may have to apply</span>
<a name="line-74"></a>		<span class='hs-comment'>-- it to fewer than its original complement of arguments</span>
<a name="line-75"></a>
<a name="line-76"></a>	<span class='hs-comment'>-- Note [Newtype representation]</span>
<a name="line-77"></a>	<span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-78"></a>	<span class='hs-comment'>-- Need newTyConRhs (*not* a recursive representation finder)</span>
<a name="line-79"></a>	<span class='hs-comment'>-- to get the representation type. For example</span>
<a name="line-80"></a>	<span class='hs-comment'>--	newtype B = MkB Int</span>
<a name="line-81"></a>	<span class='hs-comment'>--	newtype A = MkA B deriving( Num )</span>
<a name="line-82"></a>	<span class='hs-comment'>-- We want the Num instance of B, *not* the Num instance of Int,</span>
<a name="line-83"></a>	<span class='hs-comment'>-- when making the Num instance of A!</span>
<a name="line-84"></a>	<span class='hs-varid'>rep_inst_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newTyConInstRhs</span> <span class='hs-varid'>rep_tycon</span> <span class='hs-varid'>rep_tc_args</span>
<a name="line-85"></a>	<span class='hs-varid'>rep_tys</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls_tys</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>rep_inst_ty</span><span class='hs-keyglyph'>]</span>
<a name="line-86"></a>	<span class='hs-varid'>rep_pred</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkClassPred</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>rep_tys</span>
<a name="line-87"></a>		<span class='hs-comment'>-- rep_pred is the representation dictionary, from where</span>
<a name="line-88"></a>		<span class='hs-comment'>-- we are gong to get all the methods for the newtype</span>
<a name="line-89"></a>		<span class='hs-comment'>-- dictionary</span>
<a name="line-90"></a>
<a name="line-91"></a>
<a name="line-92"></a>    <span class='hs-comment'>-- Next we figure out what superclass dictionaries to use</span>
<a name="line-93"></a>    <span class='hs-comment'>-- See Note [Newtype deriving superclasses] above</span>
<a name="line-94"></a>
<a name="line-95"></a>	<span class='hs-varid'>cls_tyvars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>classTyVars</span> <span class='hs-varid'>cls</span>
<a name="line-96"></a>	<span class='hs-varid'>dfun_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarsOfTypes</span> <span class='hs-varid'>inst_tys</span>
<a name="line-97"></a>	<span class='hs-varid'>inst_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>tc_args</span>
<a name="line-98"></a>	<span class='hs-varid'>inst_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls_tys</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>inst_ty</span><span class='hs-keyglyph'>]</span>
<a name="line-99"></a>	<span class='hs-varid'>sc_theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTheta</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipOpenTvSubst</span> <span class='hs-varid'>cls_tyvars</span> <span class='hs-varid'>inst_tys</span><span class='hs-layout'>)</span>
<a name="line-100"></a>			      <span class='hs-layout'>(</span><span class='hs-varid'>classSCTheta</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span>
<a name="line-101"></a>
<a name="line-102"></a>		<span class='hs-comment'>-- If there are no tyvars, there's no need</span>
<a name="line-103"></a>		<span class='hs-comment'>-- to abstract over the dictionaries we need</span>
<a name="line-104"></a>		<span class='hs-comment'>-- Example: 	newtype T = MkT Int deriving( C )</span>
<a name="line-105"></a>		<span class='hs-comment'>-- We get the derived instance</span>
<a name="line-106"></a>		<span class='hs-comment'>--		instance C T</span>
<a name="line-107"></a>		<span class='hs-comment'>-- rather than</span>
<a name="line-108"></a>		<span class='hs-comment'>--		instance C Int =&gt; C T</span>
<a name="line-109"></a>	<span class='hs-varid'>all_preds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rep_pred</span> <span class='hs-conop'>:</span> <span class='hs-varid'>sc_theta</span>		<span class='hs-comment'>-- NB: rep_pred comes first</span>
<a name="line-110"></a>
<a name="line-111"></a>	<span class='hs-comment'>-------------------------------------------------------------------</span>
<a name="line-112"></a>	<span class='hs-comment'>--  Figuring out whether we can only do this newtype-deriving thing</span>
<a name="line-113"></a>
<a name="line-114"></a>	<span class='hs-varid'>can_derive_via_isomorphism</span>
<a name="line-115"></a>	   <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>non_iso_class</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span>
<a name="line-116"></a>	   <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>arity_ok</span>
<a name="line-117"></a>	   <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>eta_ok</span>
<a name="line-118"></a>	   <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>ats_ok</span>
<a name="line-119"></a><span class='hs-comment'>--	   &amp;&amp; not (isRecursiveTyCon tycon)	-- Note [Recursive newtypes]</span>
<a name="line-120"></a>
<a name="line-121"></a>	<span class='hs-varid'>arity_ok</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>cls_tys</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>classArity</span> <span class='hs-varid'>cls</span>
<a name="line-122"></a> 		<span class='hs-comment'>-- Well kinded; eg not: newtype T ... deriving( ST )</span>
<a name="line-123"></a>		<span class='hs-comment'>--			because ST needs *2* type params</span>
<a name="line-124"></a>
<a name="line-125"></a>	<span class='hs-comment'>-- Check that eta reduction is OK</span>
<a name="line-126"></a>	<span class='hs-varid'>eta_ok</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nt_eta_arity</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>rep_tc_args</span>
<a name="line-127"></a>		<span class='hs-comment'>-- The newtype can be eta-reduced to match the number</span>
<a name="line-128"></a>		<span class='hs-comment'>--     of type argument actually supplied</span>
<a name="line-129"></a>		<span class='hs-comment'>--	  newtype T a b = MkT (S [a] b) deriving( Monad )</span>
<a name="line-130"></a>		<span class='hs-comment'>--     Here the 'b' must be the same in the rep type (S [a] b)</span>
<a name="line-131"></a>		<span class='hs-comment'>--     And the [a] must not mention 'b'.  That's all handled</span>
<a name="line-132"></a>		<span class='hs-comment'>--     by nt_eta_rity.</span>
<a name="line-133"></a>
<a name="line-134"></a>	<span class='hs-varid'>ats_ok</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>classATs</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span>
<a name="line-135"></a>	       <span class='hs-comment'>-- No associated types for the class, because we don't</span>
<a name="line-136"></a>	       <span class='hs-comment'>-- currently generate type 'instance' decls; and cannot do</span>
<a name="line-137"></a>	       <span class='hs-comment'>-- so for 'data' instance decls</span>
<a name="line-138"></a>
<a name="line-139"></a>	<span class='hs-varid'>cant_derive_err</span>
<a name="line-140"></a>	   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppUnless</span> <span class='hs-varid'>arity_ok</span> <span class='hs-varid'>arity_msg</span>
<a name="line-141"></a>		  <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-varid'>eta_ok</span> <span class='hs-varid'>eta_msg</span>
<a name="line-142"></a>		  <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-varid'>ats_ok</span> <span class='hs-varid'>ats_msg</span> <span class='hs-keyglyph'>]</span>
<a name="line-143"></a>        <span class='hs-varid'>arity_msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkClassPred</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>cls_tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"does not have arity 1"</span><span class='hs-layout'>)</span>
<a name="line-144"></a>	<span class='hs-varid'>eta_msg</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"cannot eta-reduce the representation type enough"</span><span class='hs-layout'>)</span>
<a name="line-145"></a>	<span class='hs-varid'>ats_msg</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the class has associated types"</span><span class='hs-layout'>)</span>
</pre>\end{code}

Note [Recursive newtypes]
~~~~~~~~~~~~~~~~~~~~~~~~~
Newtype deriving works fine, even if the newtype is recursive.
e.g. 	newtype S1 = S1 [T1 ()]
	newtype T1 a = T1 (StateT S1 IO a ) deriving( Monad )
Remember, too, that type families are curretly (conservatively) given
a recursive flag, so this also allows newtype deriving to work
for type famillies.

We used to exclude recursive types, because we had a rather simple
minded way of generating the instance decl:
   newtype A = MkA [A]
   instance Eq [A] => Eq A	-- Makes typechecker loop!
But now we require a simple context, so it's ok.


%************************************************************************
%*									*
\subsection[TcDeriv-fixpoint]{Finding the fixed point of \tr{deriving} equations}
%*									*
%************************************************************************

A ``solution'' (to one of the equations) is a list of (k,TyVarTy tv)
terms, which is the final correct RHS for the corresponding original
equation.
\begin{itemize}
\item
Each (k,TyVarTy tv) in a solution constrains only a type
variable, tv.

\item
The (k,TyVarTy tv) pairs in a solution are canonically
ordered by sorting on type varible, tv, (major key) and then class, k,
(minor key)
\end{itemize}

\begin{code}
<pre><a name="line-1"></a><a name="inferInstanceContexts"></a><span class='hs-definition'>inferInstanceContexts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OverlapFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>DerivSpec</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>DerivSpec</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-definition'>inferInstanceContexts</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-definition'>inferInstanceContexts</span> <span class='hs-varid'>oflag</span> <span class='hs-varid'>infer_specs</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"inferInstanceContexts"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pprDerivSpec</span> <span class='hs-varid'>infer_specs</span><span class='hs-layout'>)</span>
<a name="line-7"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>iterate_deriv</span> <span class='hs-num'>1</span> <span class='hs-varid'>initial_solutions</span> <span class='hs-layout'>}</span>
<a name="line-8"></a>  <span class='hs-keyword'>where</span>
<a name="line-9"></a>    <span class='hs-comment'>------------------------------------------------------------------</span>
<a name="line-10"></a>	<span class='hs-comment'>-- The initial solutions for the equations claim that each</span>
<a name="line-11"></a>	<span class='hs-comment'>-- instance has an empty context; this solution is certainly</span>
<a name="line-12"></a>	<span class='hs-comment'>-- in canonical form.</span>
<a name="line-13"></a>    <span class='hs-varid'>initial_solutions</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ThetaType</span><span class='hs-keyglyph'>]</span>
<a name="line-14"></a>    <span class='hs-varid'>initial_solutions</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>|</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>infer_specs</span> <span class='hs-keyglyph'>]</span>
<a name="line-15"></a>
<a name="line-16"></a>    <span class='hs-comment'>------------------------------------------------------------------</span>
<a name="line-17"></a>	<span class='hs-comment'>-- iterate_deriv calculates the next batch of solutions,</span>
<a name="line-18"></a>	<span class='hs-comment'>-- compares it with the current one; finishes if they are the</span>
<a name="line-19"></a>	<span class='hs-comment'>-- same, otherwise recurses with the new solutions.</span>
<a name="line-20"></a>	<span class='hs-comment'>-- It fails if any iteration fails</span>
<a name="line-21"></a>    <span class='hs-varid'>iterate_deriv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ThetaType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>DerivSpec</span><span class='hs-keyglyph'>]</span>
<a name="line-22"></a>    <span class='hs-varid'>iterate_deriv</span> <span class='hs-varid'>n</span> <span class='hs-varid'>current_solns</span>
<a name="line-23"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>20</span> 	<span class='hs-comment'>-- Looks as if we are in an infinite loop</span>
<a name="line-24"></a>		<span class='hs-comment'>-- This can happen if we have -XUndecidableInstances</span>
<a name="line-25"></a>		<span class='hs-comment'>-- (See TcSimplify.tcSimplifyDeriv.)</span>
<a name="line-26"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"solveDerivEqns: probable loop"</span>
<a name="line-27"></a>		 <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pprDerivSpec</span> <span class='hs-varid'>infer_specs</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>current_solns</span><span class='hs-layout'>)</span>
<a name="line-28"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-29"></a>      <span class='hs-keyglyph'>=</span>	<span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> 	  <span class='hs-comment'>-- Extend the inst info from the explicit instance decls</span>
<a name="line-30"></a>		  <span class='hs-comment'>-- with the current set of solutions, and simplify each RHS</span>
<a name="line-31"></a>	     <span class='hs-keyword'>let</span> <span class='hs-varid'>inst_specs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWithEqual</span> <span class='hs-str'>"add_solns"</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInstance</span> <span class='hs-varid'>oflag</span><span class='hs-layout'>)</span>
<a name="line-32"></a>					   <span class='hs-varid'>current_solns</span> <span class='hs-varid'>infer_specs</span>
<a name="line-33"></a>	   <span class='hs-layout'>;</span> <span class='hs-varid'>new_solns</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkNoErrs</span> <span class='hs-varop'>$</span>
<a name="line-34"></a>	     		  <span class='hs-varid'>extendLocalInstEnv</span> <span class='hs-varid'>inst_specs</span> <span class='hs-varop'>$</span>
<a name="line-35"></a>	     		  <span class='hs-varid'>mapM</span> <span class='hs-varid'>gen_soln</span> <span class='hs-varid'>infer_specs</span>
<a name="line-36"></a>
<a name="line-37"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>eqList</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-38"></a>                 <span class='hs-varid'>eqList</span> <span class='hs-varid'>f</span> <span class='hs-varid'>xs</span> <span class='hs-varid'>ys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>xs</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>ys</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>and</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipWith</span> <span class='hs-varid'>f</span> <span class='hs-varid'>xs</span> <span class='hs-varid'>ys</span><span class='hs-layout'>)</span>
<a name="line-39"></a>
<a name="line-40"></a>	   <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-layout'>(</span><span class='hs-varid'>eqList</span> <span class='hs-layout'>(</span><span class='hs-varid'>eqList</span> <span class='hs-varid'>eqType</span><span class='hs-layout'>)</span> <span class='hs-varid'>current_solns</span> <span class='hs-varid'>new_solns</span><span class='hs-layout'>)</span> <span class='hs-keyword'>then</span>
<a name="line-41"></a>		<span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>spec</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ds_theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>soln</span> <span class='hs-layout'>}</span>
<a name="line-42"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>spec</span><span class='hs-layout'>,</span> <span class='hs-varid'>soln</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zip</span> <span class='hs-varid'>infer_specs</span> <span class='hs-varid'>current_solns</span> <span class='hs-keyglyph'>]</span>
<a name="line-43"></a>	     <span class='hs-keyword'>else</span>
<a name="line-44"></a>		<span class='hs-varid'>iterate_deriv</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_solns</span> <span class='hs-layout'>}</span>
<a name="line-45"></a>
<a name="line-46"></a>    <span class='hs-comment'>------------------------------------------------------------------</span>
<a name="line-47"></a>    <span class='hs-varid'>gen_soln</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DerivSpec</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PredType</span><span class='hs-keyglyph'>]</span>
<a name="line-48"></a>    <span class='hs-varid'>gen_soln</span> <span class='hs-layout'>(</span><span class='hs-conid'>DS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ds_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span><span class='hs-layout'>,</span> <span class='hs-varid'>ds_orig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orig</span><span class='hs-layout'>,</span> <span class='hs-varid'>ds_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyvars</span>
<a name="line-49"></a>		 <span class='hs-layout'>,</span> <span class='hs-varid'>ds_cls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>clas</span><span class='hs-layout'>,</span> <span class='hs-varid'>ds_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>ds_theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deriv_rhs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-50"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span>	<span class='hs-varop'>$</span>
<a name="line-51"></a>	<span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>derivInstCtxt</span> <span class='hs-varid'>the_pred</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-52"></a>	<span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>theta</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>simplifyDeriv</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>the_pred</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>deriv_rhs</span>
<a name="line-53"></a>	   	<span class='hs-comment'>-- checkValidInstance tyvars theta clas inst_tys</span>
<a name="line-54"></a>		<span class='hs-comment'>-- Not necessary; see Note [Exotic derived instance contexts]</span>
<a name="line-55"></a>		<span class='hs-comment'>-- 		  in TcSimplify</span>
<a name="line-56"></a>
<a name="line-57"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"TcDeriv"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>deriv_rhs</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>theta</span><span class='hs-layout'>)</span>
<a name="line-58"></a>		<span class='hs-comment'>-- Claim: the result instance declaration is guaranteed valid</span>
<a name="line-59"></a>		<span class='hs-comment'>-- Hence no need to call:</span>
<a name="line-60"></a>		<span class='hs-comment'>--   checkValidInstance tyvars theta clas inst_tys</span>
<a name="line-61"></a>	   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>sortLe</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>p1</span> <span class='hs-varid'>p2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>cmpType</span> <span class='hs-varid'>p1</span> <span class='hs-varid'>p2</span> <span class='hs-varop'>/=</span> <span class='hs-conid'>GT</span><span class='hs-layout'>)</span> <span class='hs-varid'>theta</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>	<span class='hs-comment'>-- Canonicalise before returning the solution</span>
<a name="line-62"></a>      <span class='hs-keyword'>where</span>
<a name="line-63"></a>        <span class='hs-varid'>the_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkClassPred</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>inst_tys</span>
<a name="line-64"></a>
<a name="line-65"></a><a name="mkInstance"></a><span class='hs-comment'>------------------------------------------------------------------</span>
<a name="line-66"></a><span class='hs-definition'>mkInstance</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OverlapFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DerivSpec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Instance</span>
<a name="line-67"></a><span class='hs-definition'>mkInstance</span> <span class='hs-varid'>overlap_flag</span> <span class='hs-varid'>theta</span>
<a name="line-68"></a>	    <span class='hs-layout'>(</span><span class='hs-conid'>DS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ds_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dfun_name</span>
<a name="line-69"></a>		<span class='hs-layout'>,</span> <span class='hs-varid'>ds_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>ds_cls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>clas</span><span class='hs-layout'>,</span> <span class='hs-varid'>ds_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-70"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLocalInstance</span> <span class='hs-varid'>dfun</span> <span class='hs-varid'>overlap_flag</span>
<a name="line-71"></a>  <span class='hs-keyword'>where</span>
<a name="line-72"></a>    <span class='hs-varid'>dfun</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkDictFunId</span> <span class='hs-varid'>dfun_name</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>theta</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tys</span>
<a name="line-73"></a>
<a name="line-74"></a>
<a name="line-75"></a><a name="extendLocalInstEnv"></a><span class='hs-definition'>extendLocalInstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Instance</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-76"></a><span class='hs-comment'>-- Add new locally-defined instances; don't bother to check</span>
<a name="line-77"></a><span class='hs-comment'>-- for functional dependency errors -- that'll happen in TcInstDcls</span>
<a name="line-78"></a><span class='hs-definition'>extendLocalInstEnv</span> <span class='hs-varid'>dfuns</span> <span class='hs-varid'>thing_inside</span>
<a name="line-79"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-80"></a>      <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span>  <span class='hs-varid'>inst_env'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendInstEnvList</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_inst_env</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>dfuns</span>
<a name="line-81"></a>	     <span class='hs-varid'>env'</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcg_inst_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_env'</span> <span class='hs-layout'>}</span>
<a name="line-82"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>setGblEnv</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>}</span>
</pre>\end{code}


%************************************************************************
%*									*
\subsection[TcDeriv-normal-binds]{Bindings for the various classes}
%*									*
%************************************************************************

After all the trouble to figure out the required context for the
derived instance declarations, all that's left is to chug along to
produce them.  They will then be shoved into @tcInstDecls2@, which
will do all its usual business.

There are lots of possibilities for code to generate.  Here are
various general remarks.

PRINCIPLES:
\begin{itemize}
\item
We want derived instances of @Eq@ and @Ord@ (both v common) to be
``you-couldn't-do-better-by-hand'' efficient.

\item
Deriving @Show@---also pretty common--- should also be reasonable good code.

\item
Deriving for the other classes isn't that common or that big a deal.
\end{itemize}

PRAGMATICS:

\begin{itemize}
\item
Deriving @Ord@ is done mostly with the 1.3 @compare@ method.

\item
Deriving @Eq@ also uses @compare@, if we're deriving @Ord@, too.

\item
We {\em normally} generate code only for the non-defaulted methods;
there are some exceptions for @Eq@ and (especially) @Ord@...

\item
Sometimes we use a @_con2tag_<tycon>@ function, which returns a data
constructor's numeric (@Int#@) tag.  These are generated by
@gen_tag_n_con_binds@, and the heuristic for deciding if one of
these is around is given by @hasCon2TagFun@.

The examples under the different sections below will make this
clearer.

\item
Much less often (really just for deriving @Ix@), we use a
@_tag2con_<tycon>@ function.  See the examples.

\item
We use the renamer!!!  Reason: we're supposed to be
producing @LHsBinds Name@ for the methods, but that means
producing correctly-uniquified code on the fly.  This is entirely
possible (the @TcM@ monad has a @UniqueSupply@), but it is painful.
So, instead, we produce @MonoBinds RdrName@ then heave 'em through
the renamer.  What a great hack!
\end{itemize}

\begin{code}
<pre><a name="line-1"></a><a name="genInst"></a><span class='hs-comment'>-- Generate the InstInfo for the required instance paired with the</span>
<a name="line-2"></a><span class='hs-comment'>--   *representation* tycon for that instance,</span>
<a name="line-3"></a><span class='hs-comment'>-- plus any auxiliary bindings required</span>
<a name="line-4"></a><span class='hs-comment'>--</span>
<a name="line-5"></a><span class='hs-comment'>-- Representation tycons differ from the tycon in the instance signature in</span>
<a name="line-6"></a><span class='hs-comment'>-- case of instances for indexed families.</span>
<a name="line-7"></a><span class='hs-comment'>--</span>
<a name="line-8"></a><span class='hs-definition'>genInst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>             <span class='hs-comment'>-- True &lt;=&gt; standalone deriving</span>
<a name="line-9"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OverlapFlag</span>
<a name="line-10"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DerivSpec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstInfo</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>,</span> <span class='hs-conid'>BagDerivStuff</span><span class='hs-layout'>)</span>
<a name="line-11"></a><span class='hs-definition'>genInst</span> <span class='hs-varid'>standalone_deriv</span> <span class='hs-varid'>oflag</span>
<a name="line-12"></a>        <span class='hs-varid'>spec</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>DS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ds_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ds_tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rep_tycon</span><span class='hs-layout'>,</span> <span class='hs-varid'>ds_tc_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rep_tc_args</span>
<a name="line-13"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>ds_theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>ds_newtype</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_newtype</span>
<a name="line-14"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>ds_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>ds_cls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>clas</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_newtype</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstInfo</span> <span class='hs-layout'>{</span> <span class='hs-varid'>iSpec</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_spec</span>
<a name="line-17"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>iBinds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NewTypeDerived</span> <span class='hs-varid'>co</span> <span class='hs-varid'>rep_tycon</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyBag</span><span class='hs-layout'>)</span>
<a name="line-18"></a>
<a name="line-19"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fix_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getFixityEnv</span>
<a name="line-21"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>meth_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>deriv_stuff</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>genDerivStuff</span> <span class='hs-layout'>(</span><span class='hs-varid'>getSrcSpan</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> 
<a name="line-22"></a>                                        <span class='hs-varid'>fix_env</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>name</span> <span class='hs-varid'>rep_tycon</span>
<a name="line-23"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>inst_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>InstInfo</span> <span class='hs-layout'>{</span> <span class='hs-varid'>iSpec</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_spec</span>
<a name="line-24"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>iBinds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VanillaInst</span> <span class='hs-varid'>meth_binds</span> <span class='hs-conid'>[]</span>
<a name="line-25"></a>                                                <span class='hs-varid'>standalone_deriv</span> <span class='hs-layout'>}</span>
<a name="line-26"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-varid'>inst_info</span><span class='hs-layout'>,</span> <span class='hs-varid'>deriv_stuff</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-27"></a>  <span class='hs-keyword'>where</span>
<a name="line-28"></a>
<a name="line-29"></a>    <span class='hs-varid'>inst_spec</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInstance</span> <span class='hs-varid'>oflag</span> <span class='hs-varid'>theta</span> <span class='hs-varid'>spec</span>
<a name="line-30"></a>    <span class='hs-varid'>co1</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tyConFamilyCoercion_maybe</span> <span class='hs-varid'>rep_tycon</span> <span class='hs-keyword'>of</span>
<a name="line-31"></a>              <span class='hs-conid'>Just</span> <span class='hs-varid'>co_con</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkTcAxInstCo</span> <span class='hs-varid'>co_con</span> <span class='hs-varid'>rep_tc_args</span>
<a name="line-32"></a>              <span class='hs-conid'>Nothing</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>id_co</span>
<a name="line-33"></a>              <span class='hs-comment'>-- Not a family =&gt; rep_tycon = main tycon</span>
<a name="line-34"></a>    <span class='hs-varid'>co2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcAxInstCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>newTyConCo</span> <span class='hs-varid'>rep_tycon</span><span class='hs-layout'>)</span> <span class='hs-varid'>rep_tc_args</span>
<a name="line-35"></a>    <span class='hs-varid'>co</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcForAllCos</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>co1</span> <span class='hs-varop'>`mkTcTransCo`</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-36"></a>    <span class='hs-varid'>id_co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcReflCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>rep_tycon</span> <span class='hs-varid'>rep_tc_args</span><span class='hs-layout'>)</span>
<a name="line-37"></a>
<a name="line-38"></a><span class='hs-comment'>-- Example: newtype instance N [a] = N1 (Tree a)</span>
<a name="line-39"></a><span class='hs-comment'>--          deriving instance Eq b =&gt; Eq (N [(b,b)])</span>
<a name="line-40"></a><span class='hs-comment'>-- From the instance, we get an implicit newtype R1:N a = N1 (Tree a)</span>
<a name="line-41"></a><span class='hs-comment'>-- When dealing with the deriving clause</span>
<a name="line-42"></a><span class='hs-comment'>--    co1 : N [(b,b)] ~ R1:N (b,b)</span>
<a name="line-43"></a><span class='hs-comment'>--    co2 : R1:N (b,b) ~ Tree (b,b)</span>
<a name="line-44"></a><span class='hs-comment'>--    co  : N [(b,b)] ~ Tree (b,b)</span>
<a name="line-45"></a>
<a name="line-46"></a><a name="genDerivStuff"></a><span class='hs-definition'>genDerivStuff</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FixityEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span>
<a name="line-47"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>,</span> <span class='hs-conid'>BagDerivStuff</span><span class='hs-layout'>)</span>
<a name="line-48"></a><span class='hs-definition'>genDerivStuff</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>fix_env</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>name</span> <span class='hs-varid'>tycon</span>
<a name="line-49"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>className</span> <span class='hs-varid'>clas</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>typeableClassNames</span>
<a name="line-50"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>gen_Typeable_binds</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyBag</span><span class='hs-layout'>)</span>
<a name="line-51"></a>
<a name="line-52"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>classKey</span> <span class='hs-varid'>clas</span> <span class='hs-varop'>==</span> <span class='hs-varid'>genClassKey</span>   <span class='hs-comment'>-- Special case because monadic</span>
<a name="line-53"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gen_Generic_binds</span> <span class='hs-varid'>tycon</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameModule</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-54"></a>
<a name="line-55"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>	                   <span class='hs-comment'>-- Non-monadic generators</span>
<a name="line-56"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>assocMaybe</span> <span class='hs-varid'>gen_list</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varid'>clas</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-57"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>gen_fn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>gen_fn</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span>
<a name="line-58"></a>        <span class='hs-conid'>Nothing</span>	    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"genDerivStuff: bad derived class"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>clas</span><span class='hs-layout'>)</span>
<a name="line-59"></a>  <span class='hs-keyword'>where</span>
<a name="line-60"></a>    <span class='hs-varid'>gen_list</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Unique</span><span class='hs-layout'>,</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>,</span> <span class='hs-conid'>BagDerivStuff</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-61"></a>    <span class='hs-varid'>gen_list</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>eqClassKey</span><span class='hs-layout'>,</span>            <span class='hs-varid'>gen_Eq_binds</span><span class='hs-layout'>)</span>
<a name="line-62"></a>               <span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>ordClassKey</span><span class='hs-layout'>,</span>           <span class='hs-varid'>gen_Ord_binds</span><span class='hs-layout'>)</span>
<a name="line-63"></a>               <span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>enumClassKey</span><span class='hs-layout'>,</span>          <span class='hs-varid'>gen_Enum_binds</span><span class='hs-layout'>)</span>
<a name="line-64"></a>               <span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>boundedClassKey</span><span class='hs-layout'>,</span>       <span class='hs-varid'>gen_Bounded_binds</span><span class='hs-layout'>)</span>
<a name="line-65"></a>               <span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>ixClassKey</span><span class='hs-layout'>,</span>            <span class='hs-varid'>gen_Ix_binds</span><span class='hs-layout'>)</span>
<a name="line-66"></a>               <span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>showClassKey</span><span class='hs-layout'>,</span>          <span class='hs-varid'>gen_Show_binds</span> <span class='hs-varid'>fix_env</span><span class='hs-layout'>)</span>
<a name="line-67"></a>               <span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>readClassKey</span><span class='hs-layout'>,</span>          <span class='hs-varid'>gen_Read_binds</span> <span class='hs-varid'>fix_env</span><span class='hs-layout'>)</span>
<a name="line-68"></a>               <span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>dataClassKey</span><span class='hs-layout'>,</span>          <span class='hs-varid'>gen_Data_binds</span><span class='hs-layout'>)</span>
<a name="line-69"></a>               <span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>functorClassKey</span><span class='hs-layout'>,</span>       <span class='hs-varid'>gen_Functor_binds</span><span class='hs-layout'>)</span>
<a name="line-70"></a>               <span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>foldableClassKey</span><span class='hs-layout'>,</span>      <span class='hs-varid'>gen_Foldable_binds</span><span class='hs-layout'>)</span>
<a name="line-71"></a>               <span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>traversableClassKey</span><span class='hs-layout'>,</span>   <span class='hs-varid'>gen_Traversable_binds</span><span class='hs-layout'>)</span>
<a name="line-72"></a>               <span class='hs-keyglyph'>]</span>
</pre>\end{code}

%************************************************************************
%*									*
\subsection[TcDeriv-taggery-Names]{What con2tag/tag2con functions are available?}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="derivingKindErr"></a><span class='hs-definition'>derivingKindErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Message</span>
<a name="line-2"></a><span class='hs-definition'>derivingKindErr</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>cls_tys</span> <span class='hs-varid'>cls_kind</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Cannot derive well-kinded instance of form"</span><span class='hs-layout'>)</span>
<a name="line-4"></a>		<span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprClassPred</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>cls_tys</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"..."</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-5"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Class"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span>
<a name="line-6"></a>	    <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"expects an argument of kind"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprKind</span> <span class='hs-varid'>cls_kind</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="derivingEtaErr"></a><span class='hs-definition'>derivingEtaErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Message</span>
<a name="line-9"></a><span class='hs-definition'>derivingEtaErr</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>cls_tys</span> <span class='hs-varid'>inst_ty</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Cannot eta-reduce to an instance of form"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-11"></a>	 <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"instance (...) =&gt;"</span><span class='hs-layout'>)</span>
<a name="line-12"></a>		<span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprClassPred</span> <span class='hs-varid'>cls</span> <span class='hs-layout'>(</span><span class='hs-varid'>cls_tys</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>inst_ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="typeFamilyPapErr"></a><span class='hs-definition'>typeFamilyPapErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Message</span>
<a name="line-15"></a><span class='hs-definition'>typeFamilyPapErr</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>cls_tys</span> <span class='hs-varid'>inst_ty</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Derived instance"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprClassPred</span> <span class='hs-varid'>cls</span> <span class='hs-layout'>(</span><span class='hs-varid'>cls_tys</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>inst_ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-17"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"requires illegal partial application of data type family"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="derivingThingErr"></a><span class='hs-definition'>derivingThingErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Message</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Message</span>
<a name="line-20"></a><span class='hs-definition'>derivingThingErr</span> <span class='hs-varid'>newtype_deriving</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>why</span>
<a name="line-21"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Can't make a derived instance of"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-22"></a>	     <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-23"></a>          <span class='hs-varop'>$$</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varid'>extra</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span><span class='hs-layout'>,</span>
<a name="line-24"></a>	 <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varid'>why</span><span class='hs-keyglyph'>]</span>
<a name="line-25"></a>  <span class='hs-keyword'>where</span>
<a name="line-26"></a>    <span class='hs-varid'>extra</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>newtype_deriving</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"(even with cunning newtype deriving)"</span><span class='hs-layout'>)</span>
<a name="line-27"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-28"></a>    <span class='hs-varid'>pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkClassPred</span> <span class='hs-varid'>clas</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-29"></a>
<a name="line-30"></a><a name="derivingHiddenErr"></a><span class='hs-definition'>derivingHiddenErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-31"></a><span class='hs-definition'>derivingHiddenErr</span> <span class='hs-varid'>tc</span>
<a name="line-32"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The data constructors of"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"are not all in scope"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-33"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"so you cannot derive an instance for it"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-34"></a>
<a name="line-35"></a><a name="standaloneCtxt"></a><span class='hs-definition'>standaloneCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-36"></a><span class='hs-definition'>standaloneCtxt</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In the stand-alone deriving instance for"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-37"></a>		       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-38"></a>
<a name="line-39"></a><a name="derivInstCtxt"></a><span class='hs-definition'>derivInstCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Message</span>
<a name="line-40"></a><span class='hs-definition'>derivInstCtxt</span> <span class='hs-varid'>pred</span>
<a name="line-41"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"When deriving the instance for"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span>
</pre>\end{code}
</body>
</html>
