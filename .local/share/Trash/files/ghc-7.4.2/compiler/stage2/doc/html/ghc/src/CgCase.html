<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>codeGen/CgCase.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>CgCase</span> <span class='hs-layout'>(</span>	<span class='hs-varid'>cgCase</span><span class='hs-layout'>,</span> <span class='hs-varid'>saveVolatileVarsAndRegs</span><span class='hs-layout'>,</span> 
<a name="line-9"></a>		<span class='hs-varid'>restoreCurrentCostCentre</span>
<a name="line-10"></a>	<span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-13"></a>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>CgExpr</span>  <span class='hs-layout'>(</span> <span class='hs-varid'>cgExpr</span> <span class='hs-layout'>)</span>
<a name="line-15"></a>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgMonad</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgBindery</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgCon</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgHeapery</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgCallConv</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgStackery</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgTailCall</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgPrimOp</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgForeignCall</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgUtils</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgProf</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgInfoTbls</span>
<a name="line-28"></a>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ClosureInfo</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OldCmmUtils</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OldCmm</span>
<a name="line-32"></a>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>StgSyn</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>StaticFlags</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ForeignCall</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreSyn</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrimOp</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-45"></a>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span> <span class='hs-layout'>(</span><span class='hs-varid'>when</span><span class='hs-layout'>)</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="GCFlag"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>GCFlag</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GCMayHappen</span>	<span class='hs-comment'>-- The scrutinee may involve GC, so everything must be</span>
<a name="line-3"></a>		<span class='hs-comment'>-- tidy before the code for the scrutinee.</span>
<a name="line-4"></a>
<a name="line-5"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NoGC</span>	<span class='hs-comment'>-- The scrutinee is a primitive value, or a call to a</span>
<a name="line-6"></a>		<span class='hs-comment'>-- primitive op which does no GC.  Hence the case can</span>
<a name="line-7"></a>		<span class='hs-comment'>-- be done inline, without tidying up first.</span>
</pre>\end{code}

It is quite interesting to decide whether to put a heap-check
at the start of each alternative.  Of course we certainly have
to do so if the case forces an evaluation, or if there is a primitive
op which can trigger GC.

A more interesting situation is this:

 \begin{verbatim}
	!A!;
	...A...
	case x# of
	  0#      -> !B!; ...B...
	  default -> !C!; ...C...
 \end{verbatim}

where \tr{!x!} indicates a possible heap-check point. The heap checks
in the alternatives {\em can} be omitted, in which case the topmost
heapcheck will take their worst case into account.

In favour of omitting \tr{!B!}, \tr{!C!}:

 - {\em May} save a heap overflow test,
	if ...A... allocates anything.  The other advantage
	of this is that we can use relative addressing
	from a single Hp to get at all the closures so allocated.

 - No need to save volatile vars etc across the case

Against:

  - May do more allocation than reqd.  This sometimes bites us
	badly.  For example, nfib (ha!)  allocates about 30\% more space if the
	worst-casing is done, because many many calls to nfib are leaf calls
	which don't need to allocate anything.

	This never hurts us if there is only one alternative.

\begin{code}
<pre><a name="line-1"></a><a name="cgCase"></a><span class='hs-definition'>cgCase</span>	<span class='hs-keyglyph'>::</span> <span class='hs-conid'>StgExpr</span>
<a name="line-2"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgLiveVars</span>
<a name="line-3"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgLiveVars</span>
<a name="line-4"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-5"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AltType</span>
<a name="line-6"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StgAlt</span><span class='hs-keyglyph'>]</span>
<a name="line-7"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
</pre>\end{code}

Special case #1: case of literal.

\begin{code}
<pre><a name="line-1"></a><a name="cgCase"></a><span class='hs-definition'>cgCase</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgLit</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span> <span class='hs-sel'>_live_in_whole_case</span> <span class='hs-sel'>_live_in_alts</span> <span class='hs-varid'>bndr</span>
<a name="line-2"></a>       <span class='hs-varid'>alt_type</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>PrimAlt</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>alts</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>tmp_reg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bindNewToTemp</span> <span class='hs-varid'>bndr</span>
<a name="line-4"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>cm_lit</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cgLit</span> <span class='hs-varid'>lit</span>
<a name="line-5"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>stmtC</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmAssign</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLocal</span> <span class='hs-varid'>tmp_reg</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLit</span> <span class='hs-varid'>cm_lit</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-6"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>cgPrimAlts</span> <span class='hs-conid'>NoGC</span> <span class='hs-varid'>alt_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLocal</span> <span class='hs-varid'>tmp_reg</span><span class='hs-layout'>)</span> <span class='hs-varid'>alts</span> <span class='hs-layout'>}</span>
</pre>\end{code}

Special case #2: scrutinising a primitive-typed variable.	No
evaluation required.  We don't save volatile variables, nor do we do a
heap-check in the alternatives.	 Instead, the heap usage of the
alternatives is worst-cased and passed upstream.  This can result in
allocating more heap than strictly necessary, but it will sometimes
eliminate a heap check altogether.

\begin{code}
<pre><a name="line-1"></a><a name="cgCase"></a><span class='hs-definition'>cgCase</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgApp</span> <span class='hs-sel'>_v</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-sel'>_live_in_whole_case</span> <span class='hs-sel'>_live_in_alts</span> <span class='hs-varid'>bndr</span>
<a name="line-2"></a>       <span class='hs-layout'>(</span><span class='hs-conid'>PrimAlt</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>DEFAULT</span><span class='hs-layout'>,</span><span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>rhs</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isVoidArg</span> <span class='hs-layout'>(</span><span class='hs-varid'>idCgRep</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>null</span> <span class='hs-varid'>bndrs</span> <span class='hs-layout'>)</span>
<a name="line-5"></a>    <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Case of void constant; missing optimisation somewhere"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span>
<a name="line-6"></a>    <span class='hs-varid'>cgExpr</span> <span class='hs-varid'>rhs</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-definition'>cgCase</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgApp</span> <span class='hs-varid'>v</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-sel'>_live_in_whole_case</span> <span class='hs-sel'>_live_in_alts</span> <span class='hs-varid'>bndr</span>
<a name="line-9"></a>       <span class='hs-varid'>alt_type</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>PrimAlt</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>alts</span>
<a name="line-10"></a>  <span class='hs-comment'>-- Note [ticket #3132]: we might be looking at a case of a lifted Id</span>
<a name="line-11"></a>  <span class='hs-comment'>-- that was cast to an unlifted type.  The Id will always be bottom,</span>
<a name="line-12"></a>  <span class='hs-comment'>-- but we don't want the code generator to fall over here.  If we</span>
<a name="line-13"></a>  <span class='hs-comment'>-- just emit an assignment here, the assignment will be</span>
<a name="line-14"></a>  <span class='hs-comment'>-- type-incorrect Cmm.  Hence we check that the types match, and if</span>
<a name="line-15"></a>  <span class='hs-comment'>-- they don't we'll fall through and emit the usual enter/return</span>
<a name="line-16"></a>  <span class='hs-comment'>-- code.  Test case: codeGen/should_compile/3132.hs</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isUnLiftedType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-18"></a>
<a name="line-19"></a>  <span class='hs-comment'>-- However, we also want to allow an assignment to be generated</span>
<a name="line-20"></a>  <span class='hs-comment'>-- in the case when the types are compatible, because this allows</span>
<a name="line-21"></a>  <span class='hs-comment'>-- some slightly-dodgy but occasionally-useful casts to be used,</span>
<a name="line-22"></a>  <span class='hs-comment'>-- such as in RtClosureInspect where we cast an HValue to a MutVar#</span>
<a name="line-23"></a>  <span class='hs-comment'>-- so we can print out the contents of the MutVar#.  If we generate</span>
<a name="line-24"></a>  <span class='hs-comment'>-- code that enters the HValue, then we'll get a runtime panic, because</span>
<a name="line-25"></a>  <span class='hs-comment'>-- the HValue really is a MutVar#.  The types are compatible though,</span>
<a name="line-26"></a>  <span class='hs-comment'>-- so we can just generate an assignment.</span>
<a name="line-27"></a>  <span class='hs-varop'>||</span> <span class='hs-varid'>reps_compatible</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>=</span>  <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varid'>reps_compatible</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-29"></a>            <span class='hs-varid'>panic</span> <span class='hs-str'>"cgCase: reps do not match, perhaps a dodgy unsafeCoerce?"</span>
<a name="line-30"></a>
<a name="line-31"></a>          <span class='hs-comment'>-- Careful! we can't just bind the default binder to the same thing</span>
<a name="line-32"></a>	  <span class='hs-comment'>-- as the scrutinee, since it might be a stack location, and having</span>
<a name="line-33"></a>	  <span class='hs-comment'>-- two bindings pointing at the same stack locn doesn't work (it</span>
<a name="line-34"></a>	  <span class='hs-comment'>-- confuses nukeDeadBindings).  Hence, use a new temp.</span>
<a name="line-35"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>v_info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCgIdInfo</span> <span class='hs-varid'>v</span>
<a name="line-36"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>amode</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>idInfoToAmode</span> <span class='hs-varid'>v_info</span>
<a name="line-37"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>tmp_reg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bindNewToTemp</span> <span class='hs-varid'>bndr</span>
<a name="line-38"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>stmtC</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmAssign</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLocal</span> <span class='hs-varid'>tmp_reg</span><span class='hs-layout'>)</span> <span class='hs-varid'>amode</span><span class='hs-layout'>)</span>
<a name="line-39"></a>
<a name="line-40"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>cgPrimAlts</span> <span class='hs-conid'>NoGC</span> <span class='hs-varid'>alt_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLocal</span> <span class='hs-varid'>tmp_reg</span><span class='hs-layout'>)</span> <span class='hs-varid'>alts</span> <span class='hs-layout'>}</span>
<a name="line-41"></a>  <span class='hs-keyword'>where</span>
<a name="line-42"></a>    <span class='hs-varid'>reps_compatible</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idCgRep</span> <span class='hs-varid'>v</span> <span class='hs-varop'>==</span> <span class='hs-varid'>idCgRep</span> <span class='hs-varid'>bndr</span>
</pre>\end{code}

Special case #2.5; seq#

  case seq# a s of v
    (# s', a' #) -> e

  ==>

  case a of v
    (# s', a' #) -> e

  (taking advantage of the fact that the return convention for (# State#, a #)
  is the same as the return convention for just 'a')

\begin{code}
<pre><a name="line-1"></a><a name="cgCase"></a><span class='hs-definition'>cgCase</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgOpApp</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgPrimOp</span> <span class='hs-conid'>SeqOp</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StgVarArg</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-keyglyph'>]</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-2"></a>       <span class='hs-varid'>live_in_whole_case</span> <span class='hs-varid'>live_in_alts</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>alt_type</span> <span class='hs-varid'>alts</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cgCase</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgApp</span> <span class='hs-varid'>a</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-varid'>live_in_whole_case</span> <span class='hs-varid'>live_in_alts</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>alt_type</span> <span class='hs-varid'>alts</span>
</pre>\end{code}

Special case #3: inline PrimOps and foreign calls.

\begin{code}
<pre><a name="line-1"></a><a name="cgCase"></a><span class='hs-definition'>cgCase</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgOpApp</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgPrimOp</span> <span class='hs-varid'>primop</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> 
<a name="line-2"></a>       <span class='hs-sel'>_live_in_whole_case</span> <span class='hs-varid'>live_in_alts</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>alt_type</span> <span class='hs-varid'>alts</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>primOpOutOfLine</span> <span class='hs-varid'>primop</span><span class='hs-layout'>)</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cgInlinePrimOp</span> <span class='hs-varid'>primop</span> <span class='hs-varid'>args</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>alt_type</span> <span class='hs-varid'>live_in_alts</span> <span class='hs-varid'>alts</span>
</pre>\end{code}

TODO: Case-of-case of primop can probably be done inline too (but
maybe better to translate it out beforehand).  See
ghc/lib/misc/PackedString.lhs for examples where this crops up (with
4.02).

Special case #4: inline foreign calls: an unsafe foreign call can be done
right here, just like an inline primop.

\begin{code}
<pre><a name="line-1"></a><a name="cgCase"></a><span class='hs-definition'>cgCase</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgOpApp</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgFCallOp</span> <span class='hs-varid'>fcall</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> 
<a name="line-2"></a>       <span class='hs-sel'>_live_in_whole_case</span> <span class='hs-varid'>live_in_alts</span> <span class='hs-sel'>_bndr</span> <span class='hs-sel'>_alt_type</span> <span class='hs-varid'>alts</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>unsafe_foreign_call</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isSingleton</span> <span class='hs-varid'>alts</span> <span class='hs-layout'>)</span>
<a name="line-5"></a>    <span class='hs-keyword'>do</span>	<span class='hs-comment'>--  *must* be an unboxed tuple alt.</span>
<a name="line-6"></a>	<span class='hs-comment'>-- exactly like the cgInlinePrimOp case for unboxed tuple alts..</span>
<a name="line-7"></a>	<span class='hs-layout'>{</span> <span class='hs-varid'>res_tmps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapFCs</span> <span class='hs-varid'>bindNewToTemp</span> <span class='hs-varid'>non_void_res_ids</span>
<a name="line-8"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>res_hints</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeForeignHint</span><span class='hs-varop'>.</span><span class='hs-varid'>idType</span><span class='hs-layout'>)</span> <span class='hs-varid'>non_void_res_ids</span>
<a name="line-9"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>cgForeignCall</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipWith</span> <span class='hs-conid'>CmmHinted</span> <span class='hs-varid'>res_tmps</span> <span class='hs-varid'>res_hints</span><span class='hs-layout'>)</span> <span class='hs-varid'>fcall</span> <span class='hs-varid'>args</span> <span class='hs-varid'>live_in_alts</span>
<a name="line-10"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>cgExpr</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>}</span>
<a name="line-11"></a>  <span class='hs-keyword'>where</span>
<a name="line-12"></a>   <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ids</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>head</span> <span class='hs-varid'>alts</span>
<a name="line-13"></a>   <span class='hs-varid'>non_void_res_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>nonVoidArg</span> <span class='hs-varop'>.</span> <span class='hs-varid'>idCgRep</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ids</span>
<a name="line-14"></a>
<a name="line-15"></a>   <span class='hs-varid'>unsafe_foreign_call</span>
<a name="line-16"></a>	 <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>fcall</span> <span class='hs-keyword'>of</span>
<a name="line-17"></a>	 	<span class='hs-conid'>CCall</span> <span class='hs-layout'>(</span><span class='hs-conid'>CCallSpec</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>playSafe</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
</pre>\end{code}

Special case: scrutinising a non-primitive variable.
This can be done a little better than the general case, because
we can reuse/trim the stack slot holding the variable (if it is in one).

\begin{code}
<pre><a name="line-1"></a><a name="cgCase"></a><span class='hs-definition'>cgCase</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgApp</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-2"></a>	<span class='hs-sel'>_live_in_whole_case</span> <span class='hs-varid'>live_in_alts</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>alt_type</span> <span class='hs-varid'>alts</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>fun_info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCgIdInfo</span> <span class='hs-varid'>fun</span>
<a name="line-4"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>arg_amodes</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getArgAmodes</span> <span class='hs-varid'>args</span>
<a name="line-5"></a>
<a name="line-6"></a>	<span class='hs-comment'>-- Nuking dead bindings *before* calculating the saves is the</span>
<a name="line-7"></a>	<span class='hs-comment'>-- value-add here.  We might end up freeing up some slots currently</span>
<a name="line-8"></a>	<span class='hs-comment'>-- occupied by variables only required for the call.</span>
<a name="line-9"></a>	<span class='hs-comment'>-- NOTE: we need to look up the variables used in the call before</span>
<a name="line-10"></a>	<span class='hs-comment'>-- doing this, because some of them may not be in the environment</span>
<a name="line-11"></a>	<span class='hs-comment'>-- afterward.</span>
<a name="line-12"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>nukeDeadBindings</span> <span class='hs-varid'>live_in_alts</span>	
<a name="line-13"></a>	<span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>save_assts</span><span class='hs-layout'>,</span> <span class='hs-varid'>alts_eob_info</span><span class='hs-layout'>,</span> <span class='hs-varid'>maybe_cc_slot</span><span class='hs-layout'>)</span>
<a name="line-14"></a>		<span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>saveVolatileVarsAndRegs</span> <span class='hs-varid'>live_in_alts</span>
<a name="line-15"></a>
<a name="line-16"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>scrut_eob_info</span>
<a name="line-17"></a>	    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>forkEval</span> <span class='hs-varid'>alts_eob_info</span> 
<a name="line-18"></a>			<span class='hs-layout'>(</span><span class='hs-varid'>allocStackTop</span> <span class='hs-varid'>retAddrSizeW</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>nopC</span><span class='hs-layout'>)</span>
<a name="line-19"></a>			<span class='hs-layout'>(</span><span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>deAllocStackTop</span> <span class='hs-varid'>retAddrSizeW</span>
<a name="line-20"></a>			    <span class='hs-layout'>;</span> <span class='hs-varid'>cgEvalAlts</span> <span class='hs-varid'>maybe_cc_slot</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>alt_type</span> <span class='hs-varid'>alts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-21"></a>
<a name="line-22"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>setEndOfBlockInfo</span> <span class='hs-varid'>scrut_eob_info</span>
<a name="line-23"></a>			    <span class='hs-layout'>(</span><span class='hs-varid'>performTailCall</span> <span class='hs-varid'>fun_info</span> <span class='hs-varid'>arg_amodes</span> <span class='hs-varid'>save_assts</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}

Note about return addresses: we *always* push a return address, even
if because of an optimisation we end up jumping direct to the return
code (not through the address itself).  The alternatives always assume
that the return address is on the stack.  The return address is
required in case the alternative performs a heap check, since it
encodes the liveness of the slots in the activation record.

On entry to the case alternative, we can re-use the slot containing
the return address immediately after the heap check.  That's what the
deAllocStackTop call is doing above.

Finally, here is the general case.

\begin{code}
<pre><a name="line-1"></a><a name="cgCase"></a><span class='hs-definition'>cgCase</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>live_in_whole_case</span> <span class='hs-varid'>live_in_alts</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>alt_type</span> <span class='hs-varid'>alts</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span>	<span class='hs-comment'>-- Figure out what volatile variables to save</span>
<a name="line-3"></a>	  <span class='hs-varid'>nukeDeadBindings</span> <span class='hs-varid'>live_in_whole_case</span>
<a name="line-4"></a>    
<a name="line-5"></a>	<span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>save_assts</span><span class='hs-layout'>,</span> <span class='hs-varid'>alts_eob_info</span><span class='hs-layout'>,</span> <span class='hs-varid'>maybe_cc_slot</span><span class='hs-layout'>)</span>
<a name="line-6"></a>		<span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>saveVolatileVarsAndRegs</span> <span class='hs-varid'>live_in_alts</span>
<a name="line-7"></a>
<a name="line-8"></a>	     <span class='hs-comment'>-- Save those variables right now!</span>
<a name="line-9"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>emitStmts</span> <span class='hs-varid'>save_assts</span>
<a name="line-10"></a>
<a name="line-11"></a>	    <span class='hs-comment'>-- generate code for the alts</span>
<a name="line-12"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>scrut_eob_info</span>
<a name="line-13"></a>	       <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>forkEval</span> <span class='hs-varid'>alts_eob_info</span>
<a name="line-14"></a>		      	   <span class='hs-layout'>(</span><span class='hs-keyword'>do</span> 	<span class='hs-layout'>{</span> <span class='hs-varid'>nukeDeadBindings</span> <span class='hs-varid'>live_in_alts</span>
<a name="line-15"></a>				<span class='hs-layout'>;</span> <span class='hs-varid'>allocStackTop</span> <span class='hs-varid'>retAddrSizeW</span>   <span class='hs-comment'>-- space for retn address </span>
<a name="line-16"></a>				<span class='hs-layout'>;</span> <span class='hs-varid'>nopC</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-17"></a>			   <span class='hs-layout'>(</span><span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>deAllocStackTop</span> <span class='hs-varid'>retAddrSizeW</span>
<a name="line-18"></a>				<span class='hs-layout'>;</span> <span class='hs-varid'>cgEvalAlts</span> <span class='hs-varid'>maybe_cc_slot</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>alt_type</span> <span class='hs-varid'>alts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-19"></a>
<a name="line-20"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>setEndOfBlockInfo</span> <span class='hs-varid'>scrut_eob_info</span> <span class='hs-layout'>(</span><span class='hs-varid'>cgExpr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-21"></a>    <span class='hs-layout'>}</span>
</pre>\end{code}

There's a lot of machinery going on behind the scenes to manage the
stack pointer here.  forkEval takes the virtual Sp and free list from
the first argument, and turns that into the *real* Sp for the second
argument.  It also uses this virtual Sp as the args-Sp in the EOB info
returned, so that the scrutinee will trim the real Sp back to the
right place before doing whatever it does.  
  --SDM (who just spent an hour figuring this out, and didn't want to 
	 forget it).

Why don't we push the return address just before evaluating the
scrutinee?  Because the slot reserved for the return address might
contain something useful, so we wait until performing a tail call or
return before pushing the return address (see
CgTailCall.pushReturnAddress).  

This also means that the environment doesn't need to know about the
free stack slot for the return address (for generating bitmaps),
because we don't reserve it until just before the eval.

TODO!!  Problem: however, we have to save the current cost centre
stack somewhere, because at the eval point the current CCS might be
different.  So we pick a free stack slot and save CCCS in it.  One
consequence of this is that activation records on the stack don't
follow the layout of closures when we're profiling.  The CCS could be
anywhere within the record).

%************************************************************************
%*									*
		Inline primops
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="cgInlinePrimOp"></a><span class='hs-definition'>cgInlinePrimOp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StgArg</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AltType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgLiveVars</span>
<a name="line-2"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>AltCon</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Bool</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>StgExpr</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-3"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-4"></a><span class='hs-definition'>cgInlinePrimOp</span> <span class='hs-varid'>primop</span> <span class='hs-varid'>args</span> <span class='hs-varid'>bndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimAlt</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>live_in_alts</span> <span class='hs-varid'>alts</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isVoidArg</span> <span class='hs-layout'>(</span><span class='hs-varid'>idCgRep</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>con</span> <span class='hs-varop'>==</span> <span class='hs-conid'>DEFAULT</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isSingleton</span> <span class='hs-varid'>alts</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>bs</span> <span class='hs-layout'>)</span>
<a name="line-7"></a>    <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> 	<span class='hs-comment'>-- VOID RESULT; just sequencing, </span>
<a name="line-8"></a>		<span class='hs-comment'>-- so get in there and do it</span>
<a name="line-9"></a>		<span class='hs-comment'>-- The bndr should not occur, so no need to bind it</span>
<a name="line-10"></a>	  <span class='hs-varid'>cgPrimOp</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>primop</span> <span class='hs-varid'>args</span> <span class='hs-varid'>live_in_alts</span>
<a name="line-11"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>cgExpr</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>}</span>
<a name="line-12"></a>  <span class='hs-keyword'>where</span>
<a name="line-13"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>con</span><span class='hs-layout'>,</span><span class='hs-varid'>bs</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>head</span> <span class='hs-varid'>alts</span>
<a name="line-14"></a>
<a name="line-15"></a><span class='hs-definition'>cgInlinePrimOp</span> <span class='hs-varid'>primop</span> <span class='hs-varid'>args</span> <span class='hs-varid'>bndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimAlt</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span> <span class='hs-varid'>live_in_alts</span> <span class='hs-varid'>alts</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> 	<span class='hs-comment'>-- PRIMITIVE ALTS, with non-void result</span>
<a name="line-17"></a>	  <span class='hs-varid'>tmp_reg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bindNewToTemp</span> <span class='hs-varid'>bndr</span>
<a name="line-18"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>cgPrimOp</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tmp_reg</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>primop</span> <span class='hs-varid'>args</span> <span class='hs-varid'>live_in_alts</span>
<a name="line-19"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>cgPrimAlts</span> <span class='hs-conid'>NoGC</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimAlt</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLocal</span> <span class='hs-varid'>tmp_reg</span><span class='hs-layout'>)</span> <span class='hs-varid'>alts</span> <span class='hs-layout'>}</span>
<a name="line-20"></a>
<a name="line-21"></a><span class='hs-definition'>cgInlinePrimOp</span> <span class='hs-varid'>primop</span> <span class='hs-varid'>args</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>UbxTupAlt</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>live_in_alts</span> <span class='hs-varid'>alts</span>
<a name="line-22"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isSingleton</span> <span class='hs-varid'>alts</span> <span class='hs-layout'>)</span>
<a name="line-23"></a>    <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span>  	<span class='hs-comment'>-- UNBOXED TUPLE ALTS</span>
<a name="line-24"></a>	 	<span class='hs-comment'>-- No heap check, no yield, just get in there and do it.</span>
<a name="line-25"></a>		<span class='hs-comment'>-- NB: the case binder isn't bound to anything; </span>
<a name="line-26"></a>		<span class='hs-comment'>--     it has a unboxed tuple type</span>
<a name="line-27"></a>	  
<a name="line-28"></a>	  <span class='hs-varid'>res_tmps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapFCs</span> <span class='hs-varid'>bindNewToTemp</span> <span class='hs-varid'>non_void_res_ids</span>
<a name="line-29"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>cgPrimOp</span> <span class='hs-varid'>res_tmps</span> <span class='hs-varid'>primop</span> <span class='hs-varid'>args</span> <span class='hs-varid'>live_in_alts</span>
<a name="line-30"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>cgExpr</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>}</span>
<a name="line-31"></a>  <span class='hs-keyword'>where</span>
<a name="line-32"></a>   <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ids</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>head</span> <span class='hs-varid'>alts</span>
<a name="line-33"></a>   <span class='hs-varid'>non_void_res_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>nonVoidArg</span> <span class='hs-varop'>.</span> <span class='hs-varid'>idCgRep</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ids</span>
<a name="line-34"></a>
<a name="line-35"></a><span class='hs-definition'>cgInlinePrimOp</span> <span class='hs-varid'>primop</span> <span class='hs-varid'>args</span> <span class='hs-varid'>bndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>AlgAlt</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span> <span class='hs-varid'>live_in_alts</span> <span class='hs-varid'>alts</span>
<a name="line-36"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 	<span class='hs-layout'>{</span> 	<span class='hs-comment'>-- ENUMERATION TYPE RETURN</span>
<a name="line-37"></a>		<span class='hs-comment'>-- Typical: case a &gt;# b of { True -&gt; ..; False -&gt; .. }</span>
<a name="line-38"></a>		<span class='hs-comment'>-- The primop itself returns an index into the table of</span>
<a name="line-39"></a>		<span class='hs-comment'>-- closures for the enumeration type.</span>
<a name="line-40"></a>	   <span class='hs-varid'>tag_amode</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isEnumerationTyCon</span> <span class='hs-varid'>tycon</span> <span class='hs-layout'>)</span>
<a name="line-41"></a>			<span class='hs-varid'>do_enum_primop</span> <span class='hs-varid'>primop</span>
<a name="line-42"></a>
<a name="line-43"></a>	 	<span class='hs-comment'>-- Bind the default binder if necessary</span>
<a name="line-44"></a>		<span class='hs-comment'>-- (avoiding it avoids the assignment)</span>
<a name="line-45"></a>		<span class='hs-comment'>-- The deadness info is set by StgVarInfo</span>
<a name="line-46"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>whenC</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isDeadBinder</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-47"></a>		<span class='hs-layout'>(</span><span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tmp_reg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bindNewToTemp</span> <span class='hs-varid'>bndr</span>
<a name="line-48"></a>		    <span class='hs-layout'>;</span> <span class='hs-varid'>stmtC</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmAssign</span>
<a name="line-49"></a>                             <span class='hs-layout'>(</span><span class='hs-conid'>CmmLocal</span> <span class='hs-varid'>tmp_reg</span><span class='hs-layout'>)</span>
<a name="line-50"></a>                             <span class='hs-layout'>(</span><span class='hs-varid'>tagToClosure</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>tag_amode</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-51"></a>
<a name="line-52"></a>		<span class='hs-comment'>-- Compile the alts</span>
<a name="line-53"></a>	<span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>branches</span><span class='hs-layout'>,</span> <span class='hs-varid'>mb_deflt</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cgAlgAlts</span> <span class='hs-conid'>NoGC</span> <span class='hs-conid'>Nothing</span><span class='hs-comment'>{-cc_slot-}</span>
<a name="line-54"></a>				   	    <span class='hs-layout'>(</span><span class='hs-conid'>AlgAlt</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span> <span class='hs-varid'>alts</span>
<a name="line-55"></a>
<a name="line-56"></a>		<span class='hs-comment'>-- Do the switch</span>
<a name="line-57"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>emitSwitch</span> <span class='hs-varid'>tag_amode</span> <span class='hs-varid'>branches</span> <span class='hs-varid'>mb_deflt</span> <span class='hs-num'>0</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConFamilySize</span> <span class='hs-varid'>tycon</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-58"></a>	<span class='hs-layout'>}</span>
<a name="line-59"></a>  <span class='hs-keyword'>where</span>
<a name="line-60"></a>
<a name="line-61"></a>    <span class='hs-varid'>do_enum_primop</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>CmmExpr</span>	<span class='hs-comment'>-- Returns amode for result</span>
<a name="line-62"></a>    <span class='hs-varid'>do_enum_primop</span> <span class='hs-conid'>TagToEnumOp</span>	<span class='hs-comment'>-- No code!</span>
<a name="line-63"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-64"></a>         <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getArgAmode</span> <span class='hs-varid'>arg</span>
<a name="line-65"></a>	 <span class='hs-varid'>return</span> <span class='hs-varid'>e</span>
<a name="line-66"></a>    <span class='hs-varid'>do_enum_primop</span> <span class='hs-varid'>primop</span>
<a name="line-67"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>tmp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTemp</span> <span class='hs-varid'>bWord</span>
<a name="line-68"></a>	   <span class='hs-varid'>cgPrimOp</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tmp</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>primop</span> <span class='hs-varid'>args</span> <span class='hs-varid'>live_in_alts</span>
<a name="line-69"></a>    	   <span class='hs-varid'>returnFC</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLocal</span> <span class='hs-varid'>tmp</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-70"></a>
<a name="line-71"></a><span class='hs-definition'>cgInlinePrimOp</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>bndr</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>
<a name="line-72"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"cgCase: case of primop has polymorphic type"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*									*
\subsection[CgCase-alts]{Alternatives}
%*									*
%************************************************************************

@cgEvalAlts@ returns an addressing mode for a continuation for the
alternatives of a @case@, used in a context when there
is some evaluation to be done.

\begin{code}
<pre><a name="line-1"></a><a name="cgEvalAlts"></a><span class='hs-definition'>cgEvalAlts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>VirtualSpOffset</span>	<span class='hs-comment'>-- Offset of cost-centre to be restored, if any</span>
<a name="line-2"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-3"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AltType</span>
<a name="line-4"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StgAlt</span><span class='hs-keyglyph'>]</span>
<a name="line-5"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>Sequel</span>	<span class='hs-comment'>-- Any addr modes inside are guaranteed</span>
<a name="line-6"></a>				<span class='hs-comment'>-- to be a label so that we can duplicate it </span>
<a name="line-7"></a>				<span class='hs-comment'>-- without risk of duplicating code</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-definition'>cgEvalAlts</span> <span class='hs-varid'>cc_slot</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>alt_type</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>PrimAlt</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span> <span class='hs-varid'>alts</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-keyword'>let</span>   <span class='hs-varid'>rep</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConCgRep</span> <span class='hs-varid'>tycon</span>
<a name="line-11"></a>		<span class='hs-varid'>reg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataReturnConvPrim</span> <span class='hs-varid'>rep</span>	<span class='hs-comment'>-- Bottom for voidRep</span>
<a name="line-12"></a>
<a name="line-13"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>abs_c</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>forkProc</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-14"></a>		<span class='hs-layout'>{</span> 	<span class='hs-comment'>-- Bind the case binder, except if it's void</span>
<a name="line-15"></a>			<span class='hs-comment'>-- (reg is bottom in that case)</span>
<a name="line-16"></a>		  <span class='hs-varid'>whenC</span> <span class='hs-layout'>(</span><span class='hs-varid'>nonVoidArg</span> <span class='hs-varid'>rep</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-17"></a>		  <span class='hs-varid'>bindNewToReg</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>reg</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLFArgument</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span>
<a name="line-18"></a>		<span class='hs-layout'>;</span> <span class='hs-varid'>restoreCurrentCostCentre</span> <span class='hs-varid'>cc_slot</span> <span class='hs-conid'>True</span>
<a name="line-19"></a>		<span class='hs-layout'>;</span> <span class='hs-varid'>cgPrimAlts</span> <span class='hs-conid'>GCMayHappen</span> <span class='hs-varid'>alt_type</span> <span class='hs-varid'>reg</span> <span class='hs-varid'>alts</span> <span class='hs-layout'>}</span>
<a name="line-20"></a>
<a name="line-21"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>lbl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>emitReturnTarget</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span> <span class='hs-varid'>abs_c</span>
<a name="line-22"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>returnFC</span> <span class='hs-layout'>(</span><span class='hs-conid'>CaseAlts</span> <span class='hs-varid'>lbl</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-23"></a>
<a name="line-24"></a><span class='hs-definition'>cgEvalAlts</span> <span class='hs-varid'>cc_slot</span> <span class='hs-varid'>bndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>UbxTupAlt</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>con</span><span class='hs-layout'>,</span><span class='hs-varid'>args</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>rhs</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-25"></a>  <span class='hs-keyglyph'>=</span>	<span class='hs-comment'>-- Unboxed tuple case</span>
<a name="line-26"></a>	<span class='hs-comment'>-- By now, the simplifier should have have turned it</span>
<a name="line-27"></a>	<span class='hs-comment'>-- into 	case e of (# a,b #) -&gt; e</span>
<a name="line-28"></a>	<span class='hs-comment'>-- There shouldn't be a </span>
<a name="line-29"></a>	<span class='hs-comment'>--		case e of DEFAULT -&gt; e</span>
<a name="line-30"></a>    <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>con</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-conid'>DataAlt</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span><span class='hs-layout'>;</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span>
<a name="line-31"></a>	     <span class='hs-varid'>text</span> <span class='hs-str'>"cgEvalAlts: dodgy case of unboxed tuple type"</span> <span class='hs-layout'>)</span>
<a name="line-32"></a>    <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> 	<span class='hs-comment'>-- forkAbsC for the RHS, so that the envt is</span>
<a name="line-33"></a>		<span class='hs-comment'>-- not changed for the emitReturn call</span>
<a name="line-34"></a>	  <span class='hs-varid'>abs_c</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>forkProc</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> 
<a name="line-35"></a>		<span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>live_regs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>nptrs</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bindUnboxedTupleComponents</span> <span class='hs-varid'>args</span>
<a name="line-36"></a>			<span class='hs-comment'>-- Restore the CC *after* binding the tuple components, </span>
<a name="line-37"></a>			<span class='hs-comment'>-- so that we get the stack offset of the saved CC right.</span>
<a name="line-38"></a>		<span class='hs-layout'>;</span> <span class='hs-varid'>restoreCurrentCostCentre</span> <span class='hs-varid'>cc_slot</span> <span class='hs-conid'>True</span>
<a name="line-39"></a>			<span class='hs-comment'>-- Generate a heap check if necessary</span>
<a name="line-40"></a>			<span class='hs-comment'>-- and finally the code for the alternative</span>
<a name="line-41"></a>		<span class='hs-layout'>;</span> <span class='hs-varid'>unbxTupleHeapCheck</span> <span class='hs-varid'>live_regs</span> <span class='hs-varid'>ptrs</span> <span class='hs-varid'>nptrs</span> <span class='hs-varid'>noStmts</span>
<a name="line-42"></a>				     <span class='hs-layout'>(</span><span class='hs-varid'>cgExpr</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-43"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>lbl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>emitReturnTarget</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span> <span class='hs-varid'>abs_c</span>
<a name="line-44"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>returnFC</span> <span class='hs-layout'>(</span><span class='hs-conid'>CaseAlts</span> <span class='hs-varid'>lbl</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-45"></a>
<a name="line-46"></a><span class='hs-definition'>cgEvalAlts</span> <span class='hs-varid'>cc_slot</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>alt_type</span> <span class='hs-varid'>alts</span>
<a name="line-47"></a>  <span class='hs-keyglyph'>=</span> 	<span class='hs-comment'>-- Algebraic and polymorphic case</span>
<a name="line-48"></a>    <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span>	<span class='hs-comment'>-- Bind the default binder</span>
<a name="line-49"></a>	  <span class='hs-varid'>bindNewToReg</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>nodeReg</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLFArgument</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span>
<a name="line-50"></a>
<a name="line-51"></a>	<span class='hs-comment'>-- Generate sequel info for use downstream</span>
<a name="line-52"></a>	<span class='hs-comment'>-- At the moment, we only do it if the type is vector-returnable.</span>
<a name="line-53"></a>	<span class='hs-comment'>-- Reason: if not, then it costs extra to label the</span>
<a name="line-54"></a>	<span class='hs-comment'>-- alternatives, because we'd get return code like:</span>
<a name="line-55"></a>	<span class='hs-comment'>--</span>
<a name="line-56"></a>	<span class='hs-comment'>--	switch TagReg { 0 : JMP(alt_1); 1 : JMP(alt_2) ..etc }</span>
<a name="line-57"></a>	<span class='hs-comment'>--</span>
<a name="line-58"></a>	<span class='hs-comment'>-- which is worse than having the alt code in the switch statement</span>
<a name="line-59"></a>
<a name="line-60"></a>	<span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>alts</span><span class='hs-layout'>,</span> <span class='hs-varid'>mb_deflt</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cgAlgAlts</span> <span class='hs-conid'>GCMayHappen</span> <span class='hs-varid'>cc_slot</span> <span class='hs-varid'>alt_type</span> <span class='hs-varid'>alts</span>
<a name="line-61"></a>
<a name="line-62"></a>	<span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>lbl</span><span class='hs-layout'>,</span> <span class='hs-varid'>branches</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>emitAlgReturnTarget</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span> 
<a name="line-63"></a>				<span class='hs-varid'>alts</span> <span class='hs-varid'>mb_deflt</span> <span class='hs-varid'>fam_sz</span>
<a name="line-64"></a>
<a name="line-65"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>returnFC</span> <span class='hs-layout'>(</span><span class='hs-conid'>CaseAlts</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>branches</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-66"></a>  <span class='hs-keyword'>where</span>
<a name="line-67"></a>    <span class='hs-varid'>fam_sz</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>alt_type</span> <span class='hs-keyword'>of</span>
<a name="line-68"></a>    		<span class='hs-conid'>AlgAlt</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tyConFamilySize</span> <span class='hs-varid'>tc</span>
<a name="line-69"></a>    		<span class='hs-conid'>PolyAlt</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-num'>0</span>
<a name="line-70"></a>    		<span class='hs-conid'>PrimAlt</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"cgEvalAlts: PrimAlt"</span>
<a name="line-71"></a>    		<span class='hs-conid'>UbxTupAlt</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"cgEvalAlts: UbxTupAlt"</span>
</pre>\end{code}


HWL comment on {\em GrAnSim\/}  (adding GRAN_YIELDs for context switch): If
we  do  an inlining of the  case  no separate  functions  for returning are
created, so we don't have to generate a GRAN_YIELD in that case.  This info
must be  propagated  to cgAlgAltRhs (where the  GRAN_YIELD  macro might  be
emitted). Hence, the new Bool arg to cgAlgAltRhs.

%************************************************************************
%*									*
\subsection[CgCase-alg-alts]{Algebraic alternatives}
%*									*
%************************************************************************

In @cgAlgAlts@, none of the binders in the alternatives are
assumed to be yet bound.

HWL comment on {\em GrAnSim\/} (adding GRAN_YIELDs for context switch): The
last   arg of  cgAlgAlts  indicates  if we  want  a context   switch at the
beginning of  each alternative. Normally we  want that. The  only exception
are inlined alternatives.

\begin{code}
<pre><a name="line-1"></a><a name="cgAlgAlts"></a><span class='hs-definition'>cgAlgAlts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GCFlag</span>
<a name="line-2"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>VirtualSpOffset</span>
<a name="line-3"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AltType</span>				<span class='hs-comment'>--  ** AlgAlt or PolyAlt only **</span>
<a name="line-4"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StgAlt</span><span class='hs-keyglyph'>]</span>				<span class='hs-comment'>-- The alternatives</span>
<a name="line-5"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-layout'>(</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>ConTagZ</span><span class='hs-layout'>,</span> <span class='hs-conid'>CgStmts</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- The branches</span>
<a name="line-6"></a>		  <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CgStmts</span> <span class='hs-layout'>)</span>	<span class='hs-comment'>-- The default case</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-definition'>cgAlgAlts</span> <span class='hs-varid'>gc_flag</span> <span class='hs-varid'>cc_slot</span> <span class='hs-varid'>alt_type</span> <span class='hs-varid'>alts</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>alts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>forkAlts</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>cgAlgAlt</span> <span class='hs-varid'>gc_flag</span> <span class='hs-varid'>cc_slot</span> <span class='hs-varid'>alt_type</span> <span class='hs-varid'>alt</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>alt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>alts</span><span class='hs-keyglyph'>]</span>
<a name="line-10"></a>       <span class='hs-keyword'>let</span>
<a name="line-11"></a>	    <span class='hs-varid'>mb_deflt</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>alts</span> <span class='hs-keyword'>of</span> <span class='hs-comment'>-- DEFAULT is always first, if present</span>
<a name="line-12"></a>			 <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>DEFAULT</span><span class='hs-layout'>,</span><span class='hs-varid'>blks</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>blks</span>
<a name="line-13"></a>			 <span class='hs-keyword'>_</span>    		      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-14"></a>
<a name="line-15"></a>	    <span class='hs-varid'>branches</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>dataConTagZ</span> <span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>blks</span><span class='hs-layout'>)</span> 
<a name="line-16"></a>	   	       <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataAlt</span> <span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>blks</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>alts</span><span class='hs-keyglyph'>]</span>
<a name="line-17"></a>       <span class='hs-comment'>-- in</span>
<a name="line-18"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>branches</span><span class='hs-layout'>,</span> <span class='hs-varid'>mb_deflt</span><span class='hs-layout'>)</span>
<a name="line-19"></a>
<a name="line-20"></a>
<a name="line-21"></a><a name="cgAlgAlt"></a><span class='hs-definition'>cgAlgAlt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GCFlag</span>
<a name="line-22"></a>      	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>VirtualSpOffset</span>	<span class='hs-comment'>-- Turgid state</span>
<a name="line-23"></a>      	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AltType</span>			<span class='hs-comment'>--  ** AlgAlt or PolyAlt only **</span>
<a name="line-24"></a>      	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgAlt</span>
<a name="line-25"></a>      	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-layout'>(</span><span class='hs-conid'>AltCon</span><span class='hs-layout'>,</span> <span class='hs-conid'>CgStmts</span><span class='hs-layout'>)</span>
<a name="line-26"></a>
<a name="line-27"></a><span class='hs-definition'>cgAlgAlt</span> <span class='hs-varid'>gc_flag</span> <span class='hs-varid'>cc_slot</span> <span class='hs-varid'>alt_type</span> <span class='hs-layout'>(</span><span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-sel'>_use_mask</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>abs_c</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCgStmts</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-29"></a>		<span class='hs-layout'>{</span> <span class='hs-varid'>bind_con_args</span> <span class='hs-varid'>con</span> <span class='hs-varid'>args</span>
<a name="line-30"></a>		<span class='hs-layout'>;</span> <span class='hs-varid'>restoreCurrentCostCentre</span> <span class='hs-varid'>cc_slot</span> <span class='hs-conid'>True</span>
<a name="line-31"></a>		<span class='hs-layout'>;</span> <span class='hs-varid'>maybeAltHeapCheck</span> <span class='hs-varid'>gc_flag</span> <span class='hs-varid'>alt_type</span> <span class='hs-layout'>(</span><span class='hs-varid'>cgExpr</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-32"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>abs_c</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-33"></a>  <span class='hs-keyword'>where</span>
<a name="line-34"></a>    <span class='hs-varid'>bind_con_args</span> <span class='hs-conid'>DEFAULT</span>      <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nopC</span>
<a name="line-35"></a>    <span class='hs-varid'>bind_con_args</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataAlt</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindConArgs</span> <span class='hs-varid'>dc</span> <span class='hs-varid'>args</span>
<a name="line-36"></a>    <span class='hs-varid'>bind_con_args</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitAlt</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"cgAlgAlt: LitAlt"</span>
</pre>\end{code}


%************************************************************************
%*									*
\subsection[CgCase-prim-alts]{Primitive alternatives}
%*									*
%************************************************************************

@cgPrimAlts@ generates suitable a @CSwitch@
for dealing with the alternatives of a primitive @case@, given an
addressing mode for the thing to scrutinise.  It also keeps track of
the maximum stack depth encountered down any branch.

As usual, no binders in the alternatives are yet bound.

\begin{code}
<pre><a name="line-1"></a><a name="cgPrimAlts"></a><span class='hs-definition'>cgPrimAlts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GCFlag</span>
<a name="line-2"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AltType</span>	<span class='hs-comment'>-- Always PrimAlt, but passed to maybeAltHeapCheck</span>
<a name="line-3"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmReg</span>	<span class='hs-comment'>-- Scrutinee</span>
<a name="line-4"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StgAlt</span><span class='hs-keyglyph'>]</span>	<span class='hs-comment'>-- Alternatives</span>
<a name="line-5"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-6"></a><span class='hs-comment'>-- NB: cgPrimAlts emits code that does the case analysis.</span>
<a name="line-7"></a><span class='hs-comment'>-- It's often used in inline situations, rather than to genearte</span>
<a name="line-8"></a><span class='hs-comment'>-- a labelled return point.  That's why its interface is a little</span>
<a name="line-9"></a><span class='hs-comment'>-- different to cgAlgAlts</span>
<a name="line-10"></a><span class='hs-comment'>--</span>
<a name="line-11"></a><span class='hs-comment'>-- INVARIANT: the default binder is already bound</span>
<a name="line-12"></a><span class='hs-definition'>cgPrimAlts</span> <span class='hs-varid'>gc_flag</span> <span class='hs-varid'>alt_type</span> <span class='hs-varid'>scrutinee</span> <span class='hs-varid'>alts</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>tagged_absCs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>forkAlts</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>cgPrimAlt</span> <span class='hs-varid'>gc_flag</span> <span class='hs-varid'>alt_type</span><span class='hs-layout'>)</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span>
<a name="line-14"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>DEFAULT</span><span class='hs-layout'>,</span> <span class='hs-varid'>deflt_absC</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>others</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tagged_absCs</span>	<span class='hs-comment'>-- There is always a default</span>
<a name="line-15"></a>	      <span class='hs-varid'>alt_absCs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>lit</span><span class='hs-layout'>,</span><span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitAlt</span> <span class='hs-varid'>lit</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>others</span><span class='hs-keyglyph'>]</span>
<a name="line-16"></a> 	<span class='hs-layout'>;</span> <span class='hs-varid'>emitLitSwitch</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-varid'>scrutinee</span><span class='hs-layout'>)</span> <span class='hs-varid'>alt_absCs</span> <span class='hs-varid'>deflt_absC</span> <span class='hs-layout'>}</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="cgPrimAlt"></a><span class='hs-definition'>cgPrimAlt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GCFlag</span>
<a name="line-19"></a>	  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AltType</span>
<a name="line-20"></a>	  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgAlt</span>				<span class='hs-comment'>-- The alternative</span>
<a name="line-21"></a>	  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-layout'>(</span><span class='hs-conid'>AltCon</span><span class='hs-layout'>,</span> <span class='hs-conid'>CgStmts</span><span class='hs-layout'>)</span>	<span class='hs-comment'>-- Its compiled form</span>
<a name="line-22"></a>
<a name="line-23"></a><span class='hs-definition'>cgPrimAlt</span> <span class='hs-varid'>gc_flag</span> <span class='hs-varid'>alt_type</span> <span class='hs-layout'>(</span><span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-24"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>con</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-conid'>DEFAULT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span><span class='hs-layout'>;</span> <span class='hs-conid'>LitAlt</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span><span class='hs-layout'>;</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span> <span class='hs-layout'>}</span> <span class='hs-layout'>)</span>
<a name="line-25"></a>    <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>abs_c</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCgStmts</span> <span class='hs-layout'>(</span><span class='hs-varid'>maybeAltHeapCheck</span> <span class='hs-varid'>gc_flag</span> <span class='hs-varid'>alt_type</span> <span class='hs-layout'>(</span><span class='hs-varid'>cgExpr</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-26"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>returnFC</span> <span class='hs-layout'>(</span><span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>abs_c</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-27"></a><span class='hs-definition'>cgPrimAlt</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"cgPrimAlt: non-empty lists"</span>
</pre>\end{code}


%************************************************************************
%*									*
\subsection[CgCase-tidy]{Code for tidying up prior to an eval}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="maybeAltHeapCheck"></a><span class='hs-definition'>maybeAltHeapCheck</span> 
<a name="line-2"></a>	<span class='hs-keyglyph'>::</span> <span class='hs-conid'>GCFlag</span> 
<a name="line-3"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AltType</span>	<span class='hs-comment'>-- PolyAlt, PrimAlt, AlgAlt, but *not* UbxTupAlt</span>
<a name="line-4"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>		<span class='hs-comment'>-- Continuation</span>
<a name="line-5"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-6"></a><span class='hs-definition'>maybeAltHeapCheck</span> <span class='hs-conid'>NoGC</span>	      <span class='hs-keyword'>_</span>        <span class='hs-varid'>code</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>code</span>
<a name="line-7"></a><span class='hs-definition'>maybeAltHeapCheck</span> <span class='hs-conid'>GCMayHappen</span> <span class='hs-varid'>alt_type</span> <span class='hs-varid'>code</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>altHeapCheck</span> <span class='hs-varid'>alt_type</span> <span class='hs-varid'>code</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="saveVolatileVarsAndRegs"></a><span class='hs-definition'>saveVolatileVarsAndRegs</span>
<a name="line-10"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StgLiveVars</span>                    <span class='hs-comment'>-- Vars which should be made safe</span>
<a name="line-11"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmStmts</span><span class='hs-layout'>,</span>  	      <span class='hs-comment'>-- Assignments to do the saves</span>
<a name="line-12"></a>	      <span class='hs-conid'>EndOfBlockInfo</span><span class='hs-layout'>,</span>	      <span class='hs-comment'>-- sequel for the alts</span>
<a name="line-13"></a>              <span class='hs-conid'>Maybe</span> <span class='hs-conid'>VirtualSpOffset</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Slot for current cost centre</span>
<a name="line-14"></a>
<a name="line-15"></a><span class='hs-definition'>saveVolatileVarsAndRegs</span> <span class='hs-varid'>vars</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>var_saves</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>saveVolatileVars</span> <span class='hs-varid'>vars</span>
<a name="line-17"></a>	<span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>maybe_cc_slot</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_save</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>saveCurrentCostCentre</span>
<a name="line-18"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>eob_info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getEndOfBlockInfo</span>
<a name="line-19"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>returnFC</span> <span class='hs-layout'>(</span><span class='hs-varid'>var_saves</span> <span class='hs-varop'>`plusStmts`</span> <span class='hs-varid'>cc_save</span><span class='hs-layout'>,</span>
<a name="line-20"></a>		    <span class='hs-varid'>eob_info</span><span class='hs-layout'>,</span>
<a name="line-21"></a>		    <span class='hs-varid'>maybe_cc_slot</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-22"></a>
<a name="line-23"></a>
<a name="line-24"></a><a name="saveVolatileVars"></a><span class='hs-definition'>saveVolatileVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StgLiveVars</span>		<span class='hs-comment'>-- Vars which should be made safe</span>
<a name="line-25"></a>		 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>CmmStmts</span>	<span class='hs-comment'>-- Assignments to to the saves</span>
<a name="line-26"></a>
<a name="line-27"></a><span class='hs-definition'>saveVolatileVars</span> <span class='hs-varid'>vars</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>stmts_s</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapFCs</span> <span class='hs-varid'>save_it</span> <span class='hs-layout'>(</span><span class='hs-varid'>varSetElems</span> <span class='hs-varid'>vars</span><span class='hs-layout'>)</span>
<a name="line-29"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldr</span> <span class='hs-varid'>plusStmts</span> <span class='hs-varid'>noStmts</span> <span class='hs-varid'>stmts_s</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-30"></a>  <span class='hs-keyword'>where</span>
<a name="line-31"></a>    <span class='hs-varid'>save_it</span> <span class='hs-varid'>var</span>
<a name="line-32"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCAddrModeIfVolatile</span> <span class='hs-varid'>var</span>
<a name="line-33"></a>	   <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>v</span> <span class='hs-keyword'>of</span>
<a name="line-34"></a>		<span class='hs-conid'>Nothing</span>	        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>noStmts</span> 	   <span class='hs-comment'>-- Non-volatile</span>
<a name="line-35"></a>		<span class='hs-conid'>Just</span> <span class='hs-varid'>vol_amode</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>save_var</span> <span class='hs-varid'>var</span> <span class='hs-varid'>vol_amode</span>  <span class='hs-comment'>-- Aha! It's volatile</span>
<a name="line-36"></a>	<span class='hs-layout'>}</span>
<a name="line-37"></a>
<a name="line-38"></a>    <span class='hs-varid'>save_var</span> <span class='hs-varid'>var</span> <span class='hs-varid'>vol_amode</span>
<a name="line-39"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>slot</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>allocPrimStack</span> <span class='hs-layout'>(</span><span class='hs-varid'>idCgRep</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span>
<a name="line-40"></a>	   <span class='hs-layout'>;</span> <span class='hs-varid'>rebindToStack</span> <span class='hs-varid'>var</span> <span class='hs-varid'>slot</span>
<a name="line-41"></a>	   <span class='hs-layout'>;</span> <span class='hs-varid'>sp_rel</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSpRelOffset</span> <span class='hs-varid'>slot</span>
<a name="line-42"></a>	   <span class='hs-layout'>;</span> <span class='hs-varid'>returnFC</span> <span class='hs-layout'>(</span><span class='hs-varid'>oneStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmStore</span> <span class='hs-varid'>sp_rel</span> <span class='hs-varid'>vol_amode</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}

---------------------------------------------------------------------------

When we save the current cost centre (which is done for lexical
scoping), we allocate a free stack location, and return (a)~the
virtual offset of the location, to pass on to the alternatives, and
(b)~the assignment to do the save (just as for @saveVolatileVars@).

\begin{code}
<pre><a name="line-1"></a><a name="saveCurrentCostCentre"></a><span class='hs-definition'>saveCurrentCostCentre</span> <span class='hs-keyglyph'>::</span>
<a name="line-2"></a>	<span class='hs-conid'>FCode</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>VirtualSpOffset</span><span class='hs-layout'>,</span>	<span class='hs-comment'>-- Where we decide to store it</span>
<a name="line-3"></a>	       <span class='hs-conid'>CmmStmts</span><span class='hs-layout'>)</span>		<span class='hs-comment'>-- Assignment to save it</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-definition'>saveCurrentCostCentre</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>opt_SccProfilingOn</span> 
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>returnFC</span> <span class='hs-layout'>(</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-varid'>noStmts</span><span class='hs-layout'>)</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>slot</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>allocPrimStack</span> <span class='hs-conid'>PtrArg</span>
<a name="line-10"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>sp_rel</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSpRelOffset</span> <span class='hs-varid'>slot</span>
<a name="line-11"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>returnFC</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>slot</span><span class='hs-layout'>,</span>
<a name="line-12"></a>		    <span class='hs-varid'>oneStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmStore</span> <span class='hs-varid'>sp_rel</span> <span class='hs-varid'>curCCS</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="restoreCurrentCostCentre"></a><span class='hs-comment'>-- Sometimes we don't free the slot containing the cost centre after restoring it</span>
<a name="line-15"></a><span class='hs-comment'>-- (see CgLetNoEscape.cgLetNoEscapeBody).</span>
<a name="line-16"></a><span class='hs-definition'>restoreCurrentCostCentre</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>VirtualSpOffset</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-17"></a><span class='hs-definition'>restoreCurrentCostCentre</span> <span class='hs-conid'>Nothing</span>     <span class='hs-sel'>_freeit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nopC</span>
<a name="line-18"></a><span class='hs-definition'>restoreCurrentCostCentre</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>slot</span><span class='hs-layout'>)</span> <span class='hs-varid'>freeit</span>
<a name="line-19"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 	<span class='hs-layout'>{</span> <span class='hs-varid'>sp_rel</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSpRelOffset</span> <span class='hs-varid'>slot</span>
<a name="line-20"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>whenC</span> <span class='hs-varid'>freeit</span> <span class='hs-layout'>(</span><span class='hs-varid'>freeStackSlots</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>slot</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-21"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>stmtC</span> <span class='hs-layout'>(</span><span class='hs-varid'>storeCurCCS</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLoad</span> <span class='hs-varid'>sp_rel</span> <span class='hs-varid'>bWord</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}

</body>
</html>
