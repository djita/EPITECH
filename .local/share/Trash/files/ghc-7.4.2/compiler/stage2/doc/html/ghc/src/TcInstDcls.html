<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>typecheck/TcInstDcls.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%

TcInstDecls: Typechecking instance declarations

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcInstDcls</span> <span class='hs-layout'>(</span> <span class='hs-varid'>tcInstDecls1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcInstDecls2</span> <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>
<a name="line-13"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcBinds</span>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcTyClsDecls</span>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcClassDcl</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcPat</span>      <span class='hs-layout'>(</span> <span class='hs-varid'>addInlinePrags</span> <span class='hs-layout'>)</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcMType</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BuildTyCl</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Inst</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>InstEnv</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInst</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInstEnv</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcDeriv</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEnv</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcHsType</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcUnify</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MkCore</span>     <span class='hs-layout'>(</span> <span class='hs-varid'>nO_METHOD_BINDING_ERROR_ID</span> <span class='hs-layout'>)</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>     <span class='hs-layout'>(</span> <span class='hs-varid'>mkVarSet</span><span class='hs-layout'>,</span> <span class='hs-varid'>varSetElems</span> <span class='hs-layout'>)</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Pair</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreUnfold</span> <span class='hs-layout'>(</span> <span class='hs-varid'>mkDFunUnfolding</span> <span class='hs-layout'>)</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreSyn</span>    <span class='hs-layout'>(</span> <span class='hs-conid'>Expr</span><span class='hs-layout'>(</span><span class='hs-conid'>Var</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>varToCoreExpr</span> <span class='hs-layout'>)</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>  <span class='hs-layout'>(</span> <span class='hs-varid'>typeableClassNames</span> <span class='hs-layout'>)</span>
<a name="line-42"></a>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MkId</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameSet</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-54"></a>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Maybe</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>     <span class='hs-layout'>(</span> <span class='hs-varid'>orElse</span> <span class='hs-layout'>)</span>
</pre>\end{code}

Typechecking instance declarations is done in two passes. The first
pass, made by @tcInstDecls1@, collects information to be used in the
second pass.

This pre-processed info includes the as-yet-unprocessed bindings
inside the instance declaration.  These are type-checked in the second
pass, when the class-instance envs and GVE contain all the info from
all the instance and value decls.  Indeed that's the reason we need
two passes over the instance decls.


Note [How instance declarations are translated]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Here is how we translation instance declarations into Core

Running example:
        class C a where
           op1, op2 :: Ix b => a -> b -> b
           op2 = <dm-rhs>

        instance C a => C [a]
           {-# INLINE [2] op1 #-}
           op1 = <rhs>
===>
        -- Method selectors
        op1,op2 :: forall a. C a => forall b. Ix b => a -> b -> b
        op1 = ...
        op2 = ...

        -- Default methods get the 'self' dictionary as argument
        -- so they can call other methods at the same type
        -- Default methods get the same type as their method selector
        $dmop2 :: forall a. C a => forall b. Ix b => a -> b -> b
        $dmop2 = /\a. \(d:C a). /\b. \(d2: Ix b). <dm-rhs>
               -- NB: type variables 'a' and 'b' are *both* in scope in <dm-rhs>
               -- Note [Tricky type variable scoping]

        -- A top-level definition for each instance method
        -- Here op1_i, op2_i are the "instance method Ids"
        -- The INLINE pragma comes from the user pragma
        {-# INLINE [2] op1_i #-}  -- From the instance decl bindings
        op1_i, op2_i :: forall a. C a => forall b. Ix b => [a] -> b -> b
        op1_i = /\a. \(d:C a).
               let this :: C [a]
                   this = df_i a d
                     -- Note [Subtle interaction of recursion and overlap]

                   local_op1 :: forall b. Ix b => [a] -> b -> b
                   local_op1 = <rhs>
                     -- Source code; run the type checker on this
                     -- NB: Type variable 'a' (but not 'b') is in scope in <rhs>
                     -- Note [Tricky type variable scoping]

               in local_op1 a d

        op2_i = /\a \d:C a. $dmop2 [a] (df_i a d)

        -- The dictionary function itself
        {-# NOINLINE CONLIKE df_i #-}   -- Never inline dictionary functions
        df_i :: forall a. C a -> C [a]
        df_i = /\a. \d:C a. MkC (op1_i a d) (op2_i a d)
                -- But see Note [Default methods in instances]
                -- We can't apply the type checker to the default-method call

        -- Use a RULE to short-circuit applications of the class ops
        {-# RULE "op1@C[a]" forall a, d:C a.
                            op1 [a] (df_i d) = op1_i a d #-}

Note [Instances and loop breakers]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
* Note that df_i may be mutually recursive with both op1_i and op2_i.
  It's crucial that df_i is not chosen as the loop breaker, even
  though op1_i has a (user-specified) INLINE pragma.

* Instead the idea is to inline df_i into op1_i, which may then select
  methods from the MkC record, and thereby break the recursion with
  df_i, leaving a *self*-recurisve op1_i.  (If op1_i doesn't call op at
  the same type, it won't mention df_i, so there won't be recursion in
  the first place.)

* If op1_i is marked INLINE by the user there's a danger that we won't
  inline df_i in it, and that in turn means that (since it'll be a
  loop-breaker because df_i isn't), op1_i will ironically never be
  inlined.  But this is OK: the recursion breaking happens by way of
  a RULE (the magic ClassOp rule above), and RULES work inside InlineRule
  unfoldings. See Note [RULEs enabled in SimplGently] in SimplUtils

Note [ClassOp/DFun selection]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
One thing we see a lot is stuff like
    op2 (df d1 d2)
where 'op2' is a ClassOp and 'df' is DFun.  Now, we could inline *both*
'op2' and 'df' to get
     case (MkD ($cop1 d1 d2) ($cop2 d1 d2) ... of
       MkD _ op2 _ _ _ -> op2
And that will reduce to ($cop2 d1 d2) which is what we wanted.

But it's tricky to make this work in practice, because it requires us to
inline both 'op2' and 'df'.  But neither is keen to inline without having
seen the other's result; and it's very easy to get code bloat (from the
big intermediate) if you inline a bit too much.

Instead we use a cunning trick.
 * We arrange that 'df' and 'op2' NEVER inline.

 * We arrange that 'df' is ALWAYS defined in the sylised form
      df d1 d2 = MkD ($cop1 d1 d2) ($cop2 d1 d2) ...

 * We give 'df' a magical unfolding (DFunUnfolding [$cop1, $cop2, ..])
   that lists its methods.

 * We make CoreUnfold.exprIsConApp_maybe spot a DFunUnfolding and return
   a suitable constructor application -- inlining df "on the fly" as it
   were.

 * We give the ClassOp 'op2' a BuiltinRule that extracts the right piece
   iff its argument satisfies exprIsConApp_maybe.  This is done in
   MkId mkDictSelId

 * We make 'df' CONLIKE, so that shared uses stil match; eg
      let d = df d1 d2
      in ...(op2 d)...(op1 d)...

Note [Single-method classes]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If the class has just one method (or, more accurately, just one element
of {superclasses + methods}), then we use a different strategy.

   class C a where op :: a -> a
   instance C a => C [a] where op = <blah>

We translate the class decl into a newtype, which just gives a
top-level axiom. The "constructor" MkC expands to a cast, as does the
class-op selector.

   axiom Co:C a :: C a ~ (a->a)

   op :: forall a. C a -> (a -> a)
   op a d = d |> (Co:C a)

   MkC :: forall a. (a->a) -> C a
   MkC = /\a.\op. op |> (sym Co:C a)

The clever RULE stuff doesn't work now, because ($df a d) isn't
a constructor application, so exprIsConApp_maybe won't return
Just <blah>.

Instead, we simply rely on the fact that casts are cheap:

   $df :: forall a. C a => C [a]
   {-# INLINE df #-}  -- NB: INLINE this
   $df = /\a. \d. MkC [a] ($cop_list a d)
       = $cop_list |> forall a. C a -> (sym (Co:C [a]))

   $cop_list :: forall a. C a => [a] -> [a]
   $cop_list = <blah>

So if we see
   (op ($df a d))
we'll inline 'op' and '$df', since both are simply casts, and
good things happen.

Why do we use this different strategy?  Because otherwise we
end up with non-inlined dictionaries that look like
    $df = $cop |> blah
which adds an extra indirection to every use, which seems stupid.  See
Trac #4138 for an example (although the regression reported there
wasn't due to the indirction).

There is an awkward wrinkle though: we want to be very
careful when we have
    instance C a => C [a] where
      {-# INLINE op #-}
      op = ...
then we'll get an INLINE pragma on $cop_list but it's important that
$cop_list only inlines when it's applied to *two* arguments (the
dictionary and the list argument).  So we nust not eta-expand $df
above.  We ensure that this doesn't happen by putting an INLINE
pragma on the dfun itself; after all, it ends up being just a cast.

There is one more dark corner to the INLINE story, even more deeply
buried.  Consider this (Trac #3772):

    class DeepSeq a => C a where
      gen :: Int -> a

    instance C a => C [a] where
      gen n = ...

    class DeepSeq a where
      deepSeq :: a -> b -> b

    instance DeepSeq a => DeepSeq [a] where
      {-# INLINE deepSeq #-}
      deepSeq xs b = foldr deepSeq b xs

That gives rise to these defns:

    $cdeepSeq :: DeepSeq a -> [a] -> b -> b
    -- User INLINE( 3 args )!
    $cdeepSeq a (d:DS a) b (x:[a]) (y:b) = ...

    $fDeepSeq[] :: DeepSeq a -> DeepSeq [a]
    -- DFun (with auto INLINE pragma)
    $fDeepSeq[] a d = $cdeepSeq a d |> blah

    $cp1 a d :: C a => DeepSep [a]
    -- We don't want to eta-expand this, lest
    -- $cdeepSeq gets inlined in it!
    $cp1 a d = $fDeepSep[] a (scsel a d)

    $fC[] :: C a => C [a]
    -- Ordinary DFun
    $fC[] a d = MkC ($cp1 a d) ($cgen a d)

Here $cp1 is the code that generates the superclass for C [a].  The
issue is this: we must not eta-expand $cp1 either, or else $fDeepSeq[]
and then $cdeepSeq will inline there, which is definitely wrong.  Like
on the dfun, we solve this by adding an INLINE pragma to $cp1.

Note [Subtle interaction of recursion and overlap]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this
  class C a where { op1,op2 :: a -> a }
  instance C a => C [a] where
    op1 x = op2 x ++ op2 x
    op2 x = ...
  instance C [Int] where
    ...

When type-checking the C [a] instance, we need a C [a] dictionary (for
the call of op2).  If we look up in the instance environment, we find
an overlap.  And in *general* the right thing is to complain (see Note
[Overlapping instances] in InstEnv).  But in *this* case it's wrong to
complain, because we just want to delegate to the op2 of this same
instance.

Why is this justified?  Because we generate a (C [a]) constraint in
a context in which 'a' cannot be instantiated to anything that matches
other overlapping instances, or else we would not be excecuting this
version of op1 in the first place.

It might even be a bit disguised:

  nullFail :: C [a] => [a] -> [a]
  nullFail x = op2 x ++ op2 x

  instance C a => C [a] where
    op1 x = nullFail x

Precisely this is used in package 'regex-base', module Context.hs.
See the overlapping instances for RegexContext, and the fact that they
call 'nullFail' just like the example above.  The DoCon package also
does the same thing; it shows up in module Fraction.hs

Conclusion: when typechecking the methods in a C [a] instance, we want to
treat the 'a' as an *existential* type variable, in the sense described
by Note [Binding when looking up instances].  That is why isOverlappableTyVar
responds True to an InstSkol, which is the kind of skolem we use in
tcInstDecl2.


Note [Tricky type variable scoping]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In our example
        class C a where
           op1, op2 :: Ix b => a -> b -> b
           op2 = <dm-rhs>

        instance C a => C [a]
           {-# INLINE [2] op1 #-}
           op1 = <rhs>

note that 'a' and 'b' are *both* in scope in <dm-rhs>, but only 'a' is
in scope in <rhs>.  In particular, we must make sure that 'b' is in
scope when typechecking <dm-rhs>.  This is achieved by subFunTys,
which brings appropriate tyvars into scope. This happens for both
<dm-rhs> and for <rhs>, but that doesn't matter: the *renamer* will have
complained if 'b' is mentioned in <rhs>.



%************************************************************************
%*                                                                      *
\subsection{Extracting instance decls}
%*                                                                      *
%************************************************************************

Gather up the instance declarations from their various sources

\begin{code}
<pre><a name="line-1"></a><a name="tcInstDecls1"></a><span class='hs-definition'>tcInstDecls1</span>    <span class='hs-comment'>-- Deal with both source-code and imported instance decls</span>
<a name="line-2"></a>   <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LTyClDecl</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>          <span class='hs-comment'>-- For deriving stuff</span>
<a name="line-3"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LInstDecl</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>          <span class='hs-comment'>-- Source code instance decls</span>
<a name="line-4"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LDerivDecl</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>         <span class='hs-comment'>-- Source code stand-alone deriving decls</span>
<a name="line-5"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcGblEnv</span><span class='hs-layout'>,</span>            <span class='hs-comment'>-- The full inst env</span>
<a name="line-6"></a>           <span class='hs-keyglyph'>[</span><span class='hs-conid'>InstInfo</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- Source-code instance decls to process;</span>
<a name="line-7"></a>                                <span class='hs-comment'>-- contains all dfuns for this module</span>
<a name="line-8"></a>           <span class='hs-conid'>HsValBinds</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>     <span class='hs-comment'>-- Supporting bindings for derived instances</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-definition'>tcInstDecls1</span> <span class='hs-varid'>tycl_decls</span> <span class='hs-varid'>inst_decls</span> <span class='hs-varid'>deriv_decls</span> 
<a name="line-11"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkNoErrs</span> <span class='hs-varop'>$</span>
<a name="line-12"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>        <span class='hs-comment'>-- Stop if addInstInfos etc discovers any errors</span>
<a name="line-13"></a>                <span class='hs-comment'>-- (they recover, so that we get more than one error each</span>
<a name="line-14"></a>                <span class='hs-comment'>-- round)</span>
<a name="line-15"></a>
<a name="line-16"></a>                <span class='hs-comment'>-- (1) Do class and family instance declarations</span>
<a name="line-17"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>idx_tycons</span>        <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndRecoverM</span> <span class='hs-varid'>tcTopFamInstDecl</span> <span class='hs-varop'>$</span>
<a name="line-18"></a>                              <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>isFamInstDecl</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tycl_decls</span>
<a name="line-19"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>local_info_tycons</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndRecoverM</span> <span class='hs-varid'>tcLocalInstDecl1</span>  <span class='hs-varid'>inst_decls</span>
<a name="line-20"></a>
<a name="line-21"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>local_info</span><span class='hs-layout'>,</span>
<a name="line-22"></a>                <span class='hs-varid'>at_tycons_s</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip</span> <span class='hs-varid'>local_info_tycons</span>
<a name="line-23"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>at_idx_tycons</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concat</span> <span class='hs-varid'>at_tycons_s</span> <span class='hs-varop'>++</span> <span class='hs-varid'>idx_tycons</span>
<a name="line-24"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>at_things</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>ATyCon</span> <span class='hs-varid'>at_idx_tycons</span> <span class='hs-layout'>}</span>
<a name="line-25"></a>
<a name="line-26"></a>                <span class='hs-comment'>-- (2) Add the tycons of indexed types and their implicit</span>
<a name="line-27"></a>                <span class='hs-comment'>--     tythings to the global environment</span>
<a name="line-28"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcExtendGlobalEnvImplicit</span> <span class='hs-varid'>at_things</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-29"></a>       <span class='hs-layout'>{</span> <span class='hs-varid'>tcg_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcAddImplicits</span> <span class='hs-varid'>at_things</span>
<a name="line-30"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>setGblEnv</span> <span class='hs-varid'>tcg_env</span> <span class='hs-varop'>$</span>
<a name="line-31"></a>
<a name="line-32"></a>
<a name="line-33"></a>                <span class='hs-comment'>-- Next, construct the instance environment so far, consisting</span>
<a name="line-34"></a>                <span class='hs-comment'>-- of</span>
<a name="line-35"></a>                <span class='hs-comment'>--   (a) local instance decls</span>
<a name="line-36"></a>                <span class='hs-comment'>--   (b) local family instance decls</span>
<a name="line-37"></a>         <span class='hs-varid'>addInsts</span> <span class='hs-varid'>local_info</span>         <span class='hs-varop'>$</span>
<a name="line-38"></a>         <span class='hs-varid'>addFamInsts</span> <span class='hs-varid'>at_idx_tycons</span>   <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-39"></a>
<a name="line-40"></a>                <span class='hs-comment'>-- (3) Compute instances from "deriving" clauses;</span>
<a name="line-41"></a>                <span class='hs-comment'>-- This stuff computes a context for the derived instance</span>
<a name="line-42"></a>                <span class='hs-comment'>-- decl, so it needs to know about all the instances possible</span>
<a name="line-43"></a>                <span class='hs-comment'>-- NB: class instance declarations can contain derivings as</span>
<a name="line-44"></a>                <span class='hs-comment'>--     part of associated data type declarations</span>
<a name="line-45"></a>         <span class='hs-varid'>failIfErrsM</span>    <span class='hs-comment'>-- If the addInsts stuff gave any errors, don't</span>
<a name="line-46"></a>                        <span class='hs-comment'>-- try the deriving stuff, because that may give</span>
<a name="line-47"></a>                        <span class='hs-comment'>-- more errors still</span>
<a name="line-48"></a>
<a name="line-49"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>gbl_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>deriv_inst_info</span><span class='hs-layout'>,</span> <span class='hs-varid'>deriv_binds</span><span class='hs-layout'>)</span>
<a name="line-50"></a>              <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcDeriving</span> <span class='hs-varid'>tycl_decls</span> <span class='hs-varid'>inst_decls</span> <span class='hs-varid'>deriv_decls</span>
<a name="line-51"></a>
<a name="line-52"></a>       <span class='hs-comment'>-- Check that if the module is compiled with -XSafe, there are no</span>
<a name="line-53"></a>       <span class='hs-comment'>-- hand written instances of Typeable as then unsafe casts could be</span>
<a name="line-54"></a>       <span class='hs-comment'>-- performed. Derived instances are OK.</span>
<a name="line-55"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDOpts</span>
<a name="line-56"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>safeLanguageOn</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-57"></a>             <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>typInstCheck</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-58"></a>                               <span class='hs-layout'>(</span><span class='hs-varid'>addErrAt</span> <span class='hs-layout'>(</span><span class='hs-varid'>getSrcSpan</span> <span class='hs-varop'>$</span> <span class='hs-varid'>iSpec</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-varid'>typInstErr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-59"></a>                   <span class='hs-varid'>local_info</span>
<a name="line-60"></a>       <span class='hs-comment'>-- As above but for Safe Inference mode.</span>
<a name="line-61"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>safeInferOn</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-62"></a>             <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>typInstCheck</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-varid'>recordUnsafeInfer</span><span class='hs-layout'>)</span> <span class='hs-varid'>local_info</span>
<a name="line-63"></a>
<a name="line-64"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-varid'>gbl_env</span>
<a name="line-65"></a>                <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>bagToList</span> <span class='hs-varid'>deriv_inst_info</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-varid'>local_info</span>
<a name="line-66"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>deriv_binds</span><span class='hs-layout'>)</span>
<a name="line-67"></a>    <span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-68"></a>  <span class='hs-keyword'>where</span>
<a name="line-69"></a>    <span class='hs-varid'>typInstCheck</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_cls</span> <span class='hs-layout'>(</span><span class='hs-varid'>iSpec</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>typeableClassNames</span>
<a name="line-70"></a>    <span class='hs-varid'>typInstErr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sLit</span> <span class='hs-varop'>$</span> <span class='hs-str'>"Can't create hand written instances of Typeable in Safe"</span>
<a name="line-71"></a>                              <span class='hs-varop'>++</span> <span class='hs-str'>" Haskell! Can only derive them"</span>
<a name="line-72"></a>
<a name="line-73"></a><a name="addInsts"></a><span class='hs-definition'>addInsts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>InstInfo</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-74"></a><span class='hs-definition'>addInsts</span> <span class='hs-varid'>infos</span> <span class='hs-varid'>thing_inside</span>
<a name="line-75"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcExtendLocalInstEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>iSpec</span> <span class='hs-varid'>infos</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-76"></a>
<a name="line-77"></a><a name="addFamInsts"></a><span class='hs-definition'>addFamInsts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCon</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-78"></a><span class='hs-definition'>addFamInsts</span> <span class='hs-varid'>tycons</span> <span class='hs-varid'>thing_inside</span>
<a name="line-79"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcExtendLocalFamInstEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>mkLocalFamInst</span> <span class='hs-varid'>tycons</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="tcLocalInstDecl1"></a><span class='hs-definition'>tcLocalInstDecl1</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LInstDecl</span> <span class='hs-conid'>Name</span>
<a name="line-2"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstInfo</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCon</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-3"></a>        <span class='hs-comment'>-- A source-file instance declaration</span>
<a name="line-4"></a>        <span class='hs-comment'>-- Type-check all the stuff before the "where"</span>
<a name="line-5"></a>        <span class='hs-comment'>--</span>
<a name="line-6"></a>        <span class='hs-comment'>-- We check for respectable instance type, and context</span>
<a name="line-7"></a><span class='hs-definition'>tcLocalInstDecl1</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstDecl</span> <span class='hs-varid'>poly_ty</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>uprags</span> <span class='hs-varid'>ats</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span>                      <span class='hs-varop'>$</span>
<a name="line-9"></a>    <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>instDeclCtxt1</span> <span class='hs-varid'>poly_ty</span><span class='hs-layout'>)</span>  <span class='hs-varop'>$</span>
<a name="line-10"></a>
<a name="line-11"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>is_boot</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcIsHsBoot</span>
<a name="line-12"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varid'>is_boot</span> <span class='hs-varop'>||</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyLHsBinds</span> <span class='hs-varid'>binds</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>uprags</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-13"></a>                  <span class='hs-varid'>badBootDeclErr</span>
<a name="line-14"></a>
<a name="line-15"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>clas</span><span class='hs-layout'>,</span> <span class='hs-varid'>inst_tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsInstHead</span> <span class='hs-conid'>InstDeclCtxt</span> <span class='hs-varid'>poly_ty</span>
<a name="line-16"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>mini_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>classTyVars</span> <span class='hs-varid'>clas</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>inst_tys</span><span class='hs-layout'>)</span>
<a name="line-17"></a>
<a name="line-18"></a>        <span class='hs-comment'>-- Next, process any associated types.</span>
<a name="line-19"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcLocalInstDecl"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>poly_ty</span><span class='hs-layout'>)</span>
<a name="line-20"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>idx_tycons0</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExtendTyVarEnv</span> <span class='hs-varid'>tyvars</span> <span class='hs-varop'>$</span>
<a name="line-21"></a>                         <span class='hs-varid'>mapAndRecoverM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcAssocDecl</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>mini_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>ats</span>
<a name="line-22"></a>
<a name="line-23"></a>        <span class='hs-comment'>-- Check for missing associated types and build them</span>
<a name="line-24"></a>        <span class='hs-comment'>-- from their defaults (if available)</span>
<a name="line-25"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>defined_ats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNameSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcdName</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>ats</span>
<a name="line-26"></a>              <span class='hs-varid'>check_at_instance</span> <span class='hs-layout'>(</span><span class='hs-varid'>fam_tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>defs</span><span class='hs-layout'>)</span>
<a name="line-27"></a>                 <span class='hs-comment'>-- User supplied instances ==&gt; everything is OK</span>
<a name="line-28"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tyConName</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varop'>`elemNameSet`</span> <span class='hs-varid'>defined_ats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-29"></a>                 <span class='hs-comment'>-- No defaults ==&gt; generate a warning</span>
<a name="line-30"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>defs</span>                                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConName</span> <span class='hs-varid'>fam_tc</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-31"></a>                 <span class='hs-comment'>-- No user instance, have defaults ==&gt; instatiate them</span>
<a name="line-32"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-33"></a>                    <span class='hs-varid'>defs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>forM</span> <span class='hs-varid'>defs</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-conid'>ATD</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>pat_tys</span> <span class='hs-varid'>rhs</span> <span class='hs-sel'>_loc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-34"></a>                      <span class='hs-keyword'>let</span> <span class='hs-varid'>mini_env_subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>mini_env</span>
<a name="line-35"></a>                          <span class='hs-varid'>tvs'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>varSetElems</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span>
<a name="line-36"></a>                          <span class='hs-varid'>pat_tys'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTys</span> <span class='hs-varid'>mini_env_subst</span> <span class='hs-varid'>pat_tys</span>
<a name="line-37"></a>                          <span class='hs-varid'>rhs'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>mini_env_subst</span> <span class='hs-varid'>rhs</span>
<a name="line-38"></a>                      <span class='hs-varid'>rep_tc_name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFamInstTyConName</span> <span class='hs-layout'>(</span><span class='hs-varid'>noLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConName</span> <span class='hs-varid'>fam_tc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>pat_tys'</span>
<a name="line-39"></a>                      <span class='hs-varid'>buildSynTyCon</span> <span class='hs-varid'>rep_tc_name</span> <span class='hs-varid'>tvs'</span>
<a name="line-40"></a>                                    <span class='hs-layout'>(</span><span class='hs-conid'>SynonymTyCon</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span>
<a name="line-41"></a>                                    <span class='hs-layout'>(</span><span class='hs-varid'>mkArrowKinds</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-42"></a>                                    <span class='hs-conid'>NoParentTyCon</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>fam_tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat_tys'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-43"></a>                    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-varid'>defs'</span><span class='hs-layout'>)</span>
<a name="line-44"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>missing_at_stuff</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>check_at_instance</span> <span class='hs-layout'>(</span><span class='hs-varid'>classATItems</span> <span class='hs-varid'>clas</span><span class='hs-layout'>)</span>
<a name="line-45"></a>        
<a name="line-46"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>omitted</span><span class='hs-layout'>,</span> <span class='hs-varid'>idx_tycons1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip</span> <span class='hs-varid'>missing_at_stuff</span>
<a name="line-47"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>warn</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>woptM</span> <span class='hs-conid'>Opt_WarnMissingMethods</span>
<a name="line-48"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>warnTc</span> <span class='hs-varid'>warn</span> <span class='hs-varop'>.</span> <span class='hs-varid'>omittedATWarn</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>catMaybes</span> <span class='hs-varid'>omitted</span><span class='hs-layout'>)</span>
<a name="line-49"></a>
<a name="line-50"></a>        <span class='hs-comment'>-- Finally, construct the Core representation of the instance.</span>
<a name="line-51"></a>        <span class='hs-comment'>-- (This no longer includes the associated types.)</span>
<a name="line-52"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>dfun_name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newDFunName</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>inst_tys</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLoc</span> <span class='hs-varid'>poly_ty</span><span class='hs-layout'>)</span>
<a name="line-53"></a>                <span class='hs-comment'>-- Dfun location is that of instance *header*</span>
<a name="line-54"></a>
<a name="line-55"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>overlap_flag</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getOverlapFlag</span>
<a name="line-56"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>dfun</span>  	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkDictFunId</span> <span class='hs-varid'>dfun_name</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>theta</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>inst_tys</span>
<a name="line-57"></a>              <span class='hs-varid'>ispec</span> 	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLocalInstance</span> <span class='hs-varid'>dfun</span> <span class='hs-varid'>overlap_flag</span>
<a name="line-58"></a>              <span class='hs-varid'>inst_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>InstInfo</span> <span class='hs-layout'>{</span> <span class='hs-varid'>iSpec</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ispec</span><span class='hs-layout'>,</span> <span class='hs-varid'>iBinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VanillaInst</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>uprags</span> <span class='hs-conid'>False</span> <span class='hs-layout'>}</span>
<a name="line-59"></a>
<a name="line-60"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>inst_info</span><span class='hs-layout'>,</span> <span class='hs-varid'>idx_tycons0</span> <span class='hs-varop'>++</span> <span class='hs-varid'>concat</span> <span class='hs-varid'>idx_tycons1</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
               Type checking family instances
%*                                                                      *
%************************************************************************

Family instances are somewhat of a hybrid.  They are processed together with
class instance heads, but can contain data constructors and hence they share a
lot of kinding and type checking code with ordinary algebraic data types (and
GADTs).

\begin{code}
<pre><a name="line-1"></a><a name="tcTopFamInstDecl"></a><span class='hs-definition'>tcTopFamInstDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LTyClDecl</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TyCon</span>
<a name="line-2"></a><span class='hs-definition'>tcTopFamInstDecl</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span>      <span class='hs-varop'>$</span>
<a name="line-4"></a>    <span class='hs-varid'>tcAddDeclCtxt</span> <span class='hs-varid'>decl</span>  <span class='hs-varop'>$</span>
<a name="line-5"></a>    <span class='hs-varid'>tcFamInstDecl</span> <span class='hs-conid'>TopLevel</span> <span class='hs-varid'>decl</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="tcFamInstDecl"></a><span class='hs-definition'>tcFamInstDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TopLevelFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyClDecl</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TyCon</span>
<a name="line-8"></a><span class='hs-definition'>tcFamInstDecl</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>decl</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- type family instances require -XTypeFamilies</span>
<a name="line-10"></a>         <span class='hs-comment'>-- and can't (currently) be in an hs-boot file</span>
<a name="line-11"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcFamInstDecl"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span>
<a name="line-12"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>fam_tc_lname</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcdLName</span> <span class='hs-varid'>decl</span>
<a name="line-13"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>type_families</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_TypeFamilies</span>
<a name="line-14"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>is_boot</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcIsHsBoot</span>   <span class='hs-comment'>-- Are we compiling an hs-boot file?</span>
<a name="line-15"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-varid'>type_families</span> <span class='hs-varop'>$</span> <span class='hs-varid'>badFamInstDecl</span> <span class='hs-varid'>fam_tc_lname</span>
<a name="line-16"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varid'>is_boot</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>badBootFamInstDeclErr</span>
<a name="line-17"></a>
<a name="line-18"></a>       <span class='hs-comment'>-- Look up the family TyCon and check for validity including</span>
<a name="line-19"></a>       <span class='hs-comment'>-- check that toplevel type instances are not for associated types.</span>
<a name="line-20"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>fam_tc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupLocatedTyCon</span> <span class='hs-varid'>fam_tc_lname</span>
<a name="line-21"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>isFamilyTyCon</span> <span class='hs-varid'>fam_tc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>notFamily</span> <span class='hs-varid'>fam_tc</span><span class='hs-layout'>)</span>
<a name="line-22"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTopLevel</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isTyConAssoc</span> <span class='hs-varid'>fam_tc</span><span class='hs-layout'>)</span>
<a name="line-23"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>addErr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>assocInClassErr</span> <span class='hs-varid'>fam_tc_lname</span><span class='hs-layout'>)</span>
<a name="line-24"></a>
<a name="line-25"></a>         <span class='hs-comment'>-- Now check the type/data instance itself</span>
<a name="line-26"></a>         <span class='hs-comment'>-- This is where type and data decls are treated separately</span>
<a name="line-27"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcFamInstDecl1</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>decl</span>
<a name="line-28"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkValidTyCon</span> <span class='hs-varid'>tc</span>     <span class='hs-comment'>-- Remember to check validity;</span>
<a name="line-29"></a>                                <span class='hs-comment'>-- no recursion to worry about here</span>
<a name="line-30"></a>
<a name="line-31"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>}</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="tcFamInstDecl1"></a><span class='hs-definition'>tcFamInstDecl1</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyClDecl</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TyCon</span>
<a name="line-34"></a>
<a name="line-35"></a>  <span class='hs-comment'>-- "type instance"</span>
<a name="line-36"></a><span class='hs-definition'>tcFamInstDecl1</span> <span class='hs-varid'>fam_tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>decl</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>TySynonym</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-37"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- (1) do the work of verifying the synonym</span>
<a name="line-38"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>t_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>t_typats</span><span class='hs-layout'>,</span> <span class='hs-varid'>t_rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSynFamInstDecl</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>decl</span>
<a name="line-39"></a>
<a name="line-40"></a>         <span class='hs-comment'>-- (2) check the well-formedness of the instance</span>
<a name="line-41"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkValidFamInst</span> <span class='hs-varid'>t_typats</span> <span class='hs-varid'>t_rhs</span>
<a name="line-42"></a>
<a name="line-43"></a>         <span class='hs-comment'>-- (3) construct representation tycon</span>
<a name="line-44"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>rep_tc_name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFamInstTyConName</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcdLName</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span> <span class='hs-varid'>t_typats</span>
<a name="line-45"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>buildSynTyCon</span> <span class='hs-varid'>rep_tc_name</span> <span class='hs-varid'>t_tvs</span>
<a name="line-46"></a>                       <span class='hs-layout'>(</span><span class='hs-conid'>SynonymTyCon</span> <span class='hs-varid'>t_rhs</span><span class='hs-layout'>)</span>
<a name="line-47"></a>                       <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>t_rhs</span><span class='hs-layout'>)</span>
<a name="line-48"></a>                       <span class='hs-conid'>NoParentTyCon</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>fam_tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>t_typats</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-49"></a>       <span class='hs-layout'>}</span>
<a name="line-50"></a>
<a name="line-51"></a>  <span class='hs-comment'>-- "newtype instance" and "data instance"</span>
<a name="line-52"></a><span class='hs-definition'>tcFamInstDecl1</span> <span class='hs-varid'>fam_tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>decl</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>TyData</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcdND</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_or_data</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdCtxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt</span>
<a name="line-53"></a>                                   <span class='hs-layout'>,</span> <span class='hs-varid'>tcdTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdTyPats</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>pats</span>
<a name="line-54"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>tcdCons</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cons</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-55"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- Check that the family declaration is for the right kind</span>
<a name="line-56"></a>         <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>isFamilyTyCon</span> <span class='hs-varid'>fam_tc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>notFamily</span> <span class='hs-varid'>fam_tc</span><span class='hs-layout'>)</span>
<a name="line-57"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>isAlgTyCon</span> <span class='hs-varid'>fam_tc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrongKindOfFamily</span> <span class='hs-varid'>fam_tc</span><span class='hs-layout'>)</span>
<a name="line-58"></a>
<a name="line-59"></a>         <span class='hs-comment'>-- Kind check type patterns</span>
<a name="line-60"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcFamTyPats</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>pats</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-sel'>_always_star</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>kcDataDecl</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> 
<a name="line-61"></a>           <span class='hs-keyglyph'>\</span><span class='hs-varid'>tvs'</span> <span class='hs-varid'>pats'</span> <span class='hs-varid'>resultKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-62"></a>
<a name="line-63"></a>         <span class='hs-comment'>-- Check that left-hand side contains no type family applications</span>
<a name="line-64"></a>         <span class='hs-comment'>-- (vanilla synonyms are fine, though, and we checked for</span>
<a name="line-65"></a>         <span class='hs-comment'>-- foralls earlier)</span>
<a name="line-66"></a>       <span class='hs-layout'>{</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>checkTyFamFreeness</span> <span class='hs-varid'>pats'</span>
<a name="line-67"></a>         
<a name="line-68"></a>         <span class='hs-comment'>-- Result kind must be '*' (otherwise, we have too few patterns)</span>
<a name="line-69"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>isLiftedTypeKind</span> <span class='hs-varid'>resultKind</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tooFewParmsErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConArity</span> <span class='hs-varid'>fam_tc</span><span class='hs-layout'>)</span>
<a name="line-70"></a>
<a name="line-71"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>stupid_theta</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsKindedContext</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>kcHsContext</span> <span class='hs-varid'>ctxt</span>
<a name="line-72"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>dataDeclChecks</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcdName</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_or_data</span> <span class='hs-varid'>stupid_theta</span> <span class='hs-varid'>cons</span>
<a name="line-73"></a>
<a name="line-74"></a>         <span class='hs-comment'>-- Construct representation tycon</span>
<a name="line-75"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>rep_tc_name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFamInstTyConName</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcdLName</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span> <span class='hs-varid'>pats'</span>
<a name="line-76"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ex_ok</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>       <span class='hs-comment'>-- Existentials ok for type families!</span>
<a name="line-77"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>fixM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-varid'>rep_tycon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-78"></a>             <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>orig_res_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>pats'</span>
<a name="line-79"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>data_cons</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcConDecls</span> <span class='hs-varid'>new_or_data</span> <span class='hs-varid'>ex_ok</span> <span class='hs-varid'>rep_tycon</span>
<a name="line-80"></a>                                       <span class='hs-layout'>(</span><span class='hs-varid'>tvs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig_res_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>cons</span>
<a name="line-81"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>tc_rhs</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-82"></a>                 <span class='hs-keyword'>case</span> <span class='hs-varid'>new_or_data</span> <span class='hs-keyword'>of</span>
<a name="line-83"></a>                   <span class='hs-conid'>DataType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkDataTyConRhs</span> <span class='hs-varid'>data_cons</span><span class='hs-layout'>)</span>
<a name="line-84"></a>                   <span class='hs-conid'>NewType</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>data_cons</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-85"></a>                               <span class='hs-varid'>mkNewTyConRhs</span> <span class='hs-varid'>rep_tc_name</span> <span class='hs-varid'>rep_tycon</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>data_cons</span><span class='hs-layout'>)</span>
<a name="line-86"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>buildAlgTyCon</span> <span class='hs-varid'>rep_tc_name</span> <span class='hs-varid'>tvs'</span> <span class='hs-varid'>stupid_theta</span> <span class='hs-varid'>tc_rhs</span> <span class='hs-conid'>Recursive</span>
<a name="line-87"></a>                             <span class='hs-varid'>h98_syntax</span> <span class='hs-conid'>NoParentTyCon</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>fam_tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>pats'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-88"></a>                 <span class='hs-comment'>-- We always assume that indexed types are recursive.  Why?</span>
<a name="line-89"></a>                 <span class='hs-comment'>-- (1) Due to their open nature, we can never be sure that a</span>
<a name="line-90"></a>                 <span class='hs-comment'>-- further instance might not introduce a new recursive</span>
<a name="line-91"></a>                 <span class='hs-comment'>-- dependency.  (2) They are always valid loop breakers as</span>
<a name="line-92"></a>                 <span class='hs-comment'>-- they involve a coercion.</span>
<a name="line-93"></a>             <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-94"></a>       <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-95"></a>    <span class='hs-keyword'>where</span>
<a name="line-96"></a>         <span class='hs-varid'>h98_syntax</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cons</span> <span class='hs-keyword'>of</span>      <span class='hs-comment'>-- All constructors have same shape</span>
<a name="line-97"></a>                        <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>con_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ResTyGADT</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-98"></a>                        <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-99"></a>
<a name="line-100"></a><span class='hs-definition'>tcFamInstDecl1</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tcFamInstDecl1"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span>
<a name="line-101"></a>
<a name="line-102"></a>
<a name="line-103"></a><a name="tcAssocDecl"></a><span class='hs-comment'>----------------</span>
<a name="line-104"></a><span class='hs-definition'>tcAssocDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span>           <span class='hs-comment'>-- ^ Class of associated type</span>
<a name="line-105"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarEnv</span> <span class='hs-conid'>Type</span>     <span class='hs-comment'>-- ^ Instantiation of class TyVars</span>
<a name="line-106"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LTyClDecl</span> <span class='hs-conid'>Name</span>  <span class='hs-comment'>-- ^ RHS</span>
<a name="line-107"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TyCon</span>
<a name="line-108"></a><span class='hs-definition'>tcAssocDecl</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>mini_env</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span>
<a name="line-109"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span>      <span class='hs-varop'>$</span>
<a name="line-110"></a>    <span class='hs-varid'>tcAddDeclCtxt</span> <span class='hs-varid'>decl</span>  <span class='hs-varop'>$</span>
<a name="line-111"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>at_tc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcFamInstDecl</span> <span class='hs-conid'>NotTopLevel</span> <span class='hs-varid'>decl</span>
<a name="line-112"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>fam_tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>at_tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConFamInst_maybe</span> <span class='hs-varid'>at_tc</span>
<a name="line-113"></a>  
<a name="line-114"></a>       <span class='hs-comment'>-- Check that the associated type comes from this class</span>
<a name="line-115"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>clas</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tyConAssoc_maybe</span> <span class='hs-varid'>fam_tc</span><span class='hs-layout'>)</span>
<a name="line-116"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>badATErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>className</span> <span class='hs-varid'>clas</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConName</span> <span class='hs-varid'>at_tc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-117"></a>
<a name="line-118"></a>       <span class='hs-comment'>-- See Note [Checking consistent instantiation] in TcTyClsDecls</span>
<a name="line-119"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>zipWithM_</span> <span class='hs-varid'>check_arg</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConTyVars</span> <span class='hs-varid'>fam_tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>at_tys</span>
<a name="line-120"></a>
<a name="line-121"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>at_tc</span> <span class='hs-layout'>}</span>
<a name="line-122"></a>  <span class='hs-keyword'>where</span>
<a name="line-123"></a>    <span class='hs-varid'>check_arg</span> <span class='hs-varid'>fam_tc_tv</span> <span class='hs-varid'>at_ty</span>
<a name="line-124"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>inst_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>mini_env</span> <span class='hs-varid'>fam_tc_tv</span>
<a name="line-125"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>inst_ty</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>at_ty</span><span class='hs-layout'>)</span> 
<a name="line-126"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>wrongATArgErr</span> <span class='hs-varid'>at_ty</span> <span class='hs-varid'>inst_ty</span><span class='hs-layout'>)</span>
<a name="line-127"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-128"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>   <span class='hs-comment'>-- Allow non-type-variable instantiation</span>
<a name="line-129"></a>                    <span class='hs-comment'>-- See Note [Associated type instances]</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
      Type-checking instance declarations, pass 2
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="tcInstDecls2"></a><span class='hs-definition'>tcInstDecls2</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LTyClDecl</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>InstInfo</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-3"></a><span class='hs-comment'>-- (a) From each class declaration,</span>
<a name="line-4"></a><span class='hs-comment'>--      generate any default-method bindings</span>
<a name="line-5"></a><span class='hs-comment'>-- (b) From each instance decl</span>
<a name="line-6"></a><span class='hs-comment'>--      generate the dfun binding</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-definition'>tcInstDecls2</span> <span class='hs-varid'>tycl_decls</span> <span class='hs-varid'>inst_decls</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-comment'>-- (a) Default methods from class decls</span>
<a name="line-10"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>class_decls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>isClassDecl</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tycl_decls</span>
<a name="line-11"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>dm_binds_s</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>tcClassDecl2</span> <span class='hs-varid'>class_decls</span>
<a name="line-12"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>dm_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unionManyBags</span> <span class='hs-varid'>dm_binds_s</span>
<a name="line-13"></a>
<a name="line-14"></a>          <span class='hs-comment'>-- (b) instance declarations</span>
<a name="line-15"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>dm_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collectHsBindsBinders</span> <span class='hs-varid'>dm_binds</span>
<a name="line-16"></a>              <span class='hs-comment'>-- Add the default method Ids (again)</span>
<a name="line-17"></a>              <span class='hs-comment'>-- See Note [Default methods and instances]</span>
<a name="line-18"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>inst_binds_s</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExtendLetEnv</span> <span class='hs-conid'>TopLevel</span> <span class='hs-varid'>dm_ids</span> <span class='hs-varop'>$</span>
<a name="line-19"></a>                          <span class='hs-varid'>mapM</span> <span class='hs-varid'>tcInstDecl2</span> <span class='hs-varid'>inst_decls</span>
<a name="line-20"></a>
<a name="line-21"></a>          <span class='hs-comment'>-- Done</span>
<a name="line-22"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>dm_binds</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>unionManyBags</span> <span class='hs-varid'>inst_binds_s</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}

See Note [Default methods and instances]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The default method Ids are already in the type environment (see Note
[Default method Ids and Template Haskell] in TcTyClsDcls), BUT they
don't have their InlinePragmas yet.  Usually that would not matter,
because the simplifier propagates information from binding site to
use.  But, unusually, when compiling instance decls we *copy* the
INLINE pragma from the default method to the method for that
particular operation (see Note [INLINE and default methods] below).

So right here in tcInstDecls2 we must re-extend the type envt with
the default method Ids replete with their INLINE pragmas.  Urk.

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><a name="tcInstDecl2"></a><span class='hs-definition'>tcInstDecl2</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InstInfo</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-3"></a>            <span class='hs-comment'>-- Returns a binding for the dfun</span>
<a name="line-4"></a><span class='hs-definition'>tcInstDecl2</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstInfo</span> <span class='hs-layout'>{</span> <span class='hs-varid'>iSpec</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ispec</span><span class='hs-layout'>,</span> <span class='hs-varid'>iBinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ibinds</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>recoverM</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varid'>emptyLHsBinds</span><span class='hs-layout'>)</span>             <span class='hs-varop'>$</span>
<a name="line-6"></a>    <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span>                              <span class='hs-varop'>$</span>
<a name="line-7"></a>    <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>instDeclCtxt2</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>dfun_id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-8"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>  <span class='hs-comment'>-- Instantiate the instance decl with skolem constants</span>
<a name="line-9"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>inst_tyvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>dfun_theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>inst_head</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSkolDFunType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>dfun_id</span><span class='hs-layout'>)</span>
<a name="line-10"></a>                     <span class='hs-comment'>-- We instantiate the dfun_id with superSkolems.</span>
<a name="line-11"></a>                     <span class='hs-comment'>-- See Note [Subtle interaction of recursion and overlap]</span>
<a name="line-12"></a>                     <span class='hs-comment'>-- and Note [Binding when looking up instances]</span>
<a name="line-13"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>clas</span><span class='hs-layout'>,</span> <span class='hs-varid'>inst_tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitDFunHead</span> <span class='hs-varid'>inst_head</span>
<a name="line-14"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>class_tyvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>sc_theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>sc_sels</span><span class='hs-layout'>,</span> <span class='hs-varid'>op_items</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>classBigSig</span> <span class='hs-varid'>clas</span>
<a name="line-15"></a>             <span class='hs-varid'>sc_theta'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTheta</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipOpenTvSubst</span> <span class='hs-varid'>class_tyvars</span> <span class='hs-varid'>inst_tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>sc_theta</span>
<a name="line-16"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>dfun_ev_vars</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEvVars</span> <span class='hs-varid'>dfun_theta</span>
<a name="line-17"></a>
<a name="line-18"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>sc_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>sc_binds</span><span class='hs-layout'>)</span>
<a name="line-19"></a>             <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndUnzipM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcSuperClass</span> <span class='hs-varid'>inst_tyvars</span> <span class='hs-varid'>dfun_ev_vars</span><span class='hs-layout'>)</span>
<a name="line-20"></a>                              <span class='hs-layout'>(</span><span class='hs-varid'>sc_sels</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>sc_theta'</span><span class='hs-layout'>)</span>
<a name="line-21"></a>
<a name="line-22"></a>       <span class='hs-comment'>-- Deal with 'SPECIALISE instance' pragmas</span>
<a name="line-23"></a>       <span class='hs-comment'>-- See Note [SPECIALISE instance pragmas]</span>
<a name="line-24"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>spec_info</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>spec_inst_prags</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSpecInstPrags</span> <span class='hs-varid'>dfun_id</span> <span class='hs-varid'>ibinds</span>
<a name="line-25"></a>
<a name="line-26"></a>        <span class='hs-comment'>-- Typecheck the methods</span>
<a name="line-27"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>meth_ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>meth_binds</span><span class='hs-layout'>)</span>
<a name="line-28"></a>           <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExtendTyVarEnv</span> <span class='hs-varid'>inst_tyvars</span> <span class='hs-varop'>$</span>
<a name="line-29"></a>                <span class='hs-comment'>-- The inst_tyvars scope over the 'where' part</span>
<a name="line-30"></a>                <span class='hs-comment'>-- Those tyvars are inside the dfun_id's type, which is a bit</span>
<a name="line-31"></a>                <span class='hs-comment'>-- bizarre, but OK so long as you realise it!</span>
<a name="line-32"></a>              <span class='hs-varid'>tcInstanceMethods</span> <span class='hs-varid'>dfun_id</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>inst_tyvars</span> <span class='hs-varid'>dfun_ev_vars</span>
<a name="line-33"></a>                                <span class='hs-varid'>inst_tys</span> <span class='hs-varid'>spec_info</span>
<a name="line-34"></a>                                <span class='hs-varid'>op_items</span> <span class='hs-varid'>ibinds</span>
<a name="line-35"></a>
<a name="line-36"></a>       <span class='hs-comment'>-- Create the result bindings</span>
<a name="line-37"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>self_dict</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newDict</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>inst_tys</span>
<a name="line-38"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>class_tc</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>classTyCon</span> <span class='hs-varid'>clas</span>
<a name="line-39"></a>             <span class='hs-keyglyph'>[</span><span class='hs-varid'>dict_constr</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConDataCons</span> <span class='hs-varid'>class_tc</span>
<a name="line-40"></a>             <span class='hs-varid'>dict_bind</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarBind</span> <span class='hs-varid'>self_dict</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>con_app_args</span><span class='hs-layout'>)</span>
<a name="line-41"></a>
<a name="line-42"></a>                     <span class='hs-comment'>-- We don't produce a binding for the dict_constr; instead we</span>
<a name="line-43"></a>                     <span class='hs-comment'>-- rely on the simplifier to unfold this saturated application</span>
<a name="line-44"></a>                     <span class='hs-comment'>-- We do this rather than generate an HsCon directly, because</span>
<a name="line-45"></a>                     <span class='hs-comment'>-- it means that the special cases (e.g. dictionary with only one</span>
<a name="line-46"></a>                     <span class='hs-comment'>-- member) are dealt with by the common MkId.mkDataConWrapId</span>
<a name="line-47"></a>                     <span class='hs-comment'>-- code rather than needing to be repeated here.</span>
<a name="line-48"></a>                     <span class='hs-comment'>--    con_app_tys  = MkD ty1 ty2</span>
<a name="line-49"></a>                     <span class='hs-comment'>--    con_app_scs  = MkD ty1 ty2 sc1 sc2</span>
<a name="line-50"></a>                     <span class='hs-comment'>--    con_app_args = MkD ty1 ty2 sc1 sc2 op1 op2</span>
<a name="line-51"></a>             <span class='hs-varid'>con_app_tys</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapId</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkWpTyApps</span> <span class='hs-varid'>inst_tys</span><span class='hs-layout'>)</span>
<a name="line-52"></a>                                   <span class='hs-layout'>(</span><span class='hs-varid'>dataConWrapId</span> <span class='hs-varid'>dict_constr</span><span class='hs-layout'>)</span>
<a name="line-53"></a>             <span class='hs-varid'>con_app_scs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkHsWrap</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkWpEvApps</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>mk_sc_ev_term</span> <span class='hs-varid'>sc_args</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>con_app_tys</span>
<a name="line-54"></a>             <span class='hs-varid'>con_app_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-varid'>mk_app</span> <span class='hs-varid'>con_app_scs</span> <span class='hs-varop'>$</span>
<a name="line-55"></a>                            <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapId</span> <span class='hs-varid'>arg_wrapper</span><span class='hs-layout'>)</span> <span class='hs-varid'>meth_ids</span>
<a name="line-56"></a>
<a name="line-57"></a>             <span class='hs-varid'>mk_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Id</span>
<a name="line-58"></a>             <span class='hs-varid'>mk_app</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HsApp</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-59"></a>
<a name="line-60"></a>             <span class='hs-varid'>mk_sc_ev_term</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvTerm</span>
<a name="line-61"></a>             <span class='hs-varid'>mk_sc_ev_term</span> <span class='hs-varid'>sc</span>
<a name="line-62"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>inst_tv_tys</span>
<a name="line-63"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>null</span> <span class='hs-varid'>dfun_ev_vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvId</span> <span class='hs-varid'>sc</span>
<a name="line-64"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvDFunApp</span> <span class='hs-varid'>sc</span> <span class='hs-varid'>inst_tv_tys</span> <span class='hs-varid'>dfun_ev_vars</span>
<a name="line-65"></a>
<a name="line-66"></a>             <span class='hs-varid'>inst_tv_tys</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>inst_tyvars</span>
<a name="line-67"></a>             <span class='hs-varid'>arg_wrapper</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWpEvVarApps</span> <span class='hs-varid'>dfun_ev_vars</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>mkWpTyApps</span> <span class='hs-varid'>inst_tv_tys</span>
<a name="line-68"></a>
<a name="line-69"></a>                <span class='hs-comment'>-- Do not inline the dfun; instead give it a magic DFunFunfolding</span>
<a name="line-70"></a>                <span class='hs-comment'>-- See Note [ClassOp/DFun selection]</span>
<a name="line-71"></a>                <span class='hs-comment'>-- See also note [Single-method classes]</span>
<a name="line-72"></a>             <span class='hs-varid'>dfun_id_w_fun</span>
<a name="line-73"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isNewTyCon</span> <span class='hs-varid'>class_tc</span>
<a name="line-74"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dfun_id</span> <span class='hs-varop'>`setInlinePragma`</span> <span class='hs-varid'>alwaysInlinePragma</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inl_sat</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-num'>0</span> <span class='hs-layout'>}</span>
<a name="line-75"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-76"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dfun_id</span> <span class='hs-varop'>`setIdUnfolding`</span>  <span class='hs-varid'>mkDFunUnfolding</span> <span class='hs-varid'>dfun_ty</span> <span class='hs-varid'>dfun_args</span>
<a name="line-77"></a>                          <span class='hs-varop'>`setInlinePragma`</span> <span class='hs-varid'>dfunInlinePragma</span>
<a name="line-78"></a>
<a name="line-79"></a>             <span class='hs-varid'>dfun_args</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreExpr</span><span class='hs-keyglyph'>]</span>
<a name="line-80"></a>             <span class='hs-varid'>dfun_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>varToCoreExpr</span> <span class='hs-varid'>sc_args</span> <span class='hs-varop'>++</span>
<a name="line-81"></a>                         <span class='hs-varid'>map</span> <span class='hs-conid'>Var</span>           <span class='hs-varid'>meth_ids</span>
<a name="line-82"></a>
<a name="line-83"></a>             <span class='hs-varid'>export</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ABE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>abe_wrap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idHsWrapper</span><span class='hs-layout'>,</span> <span class='hs-varid'>abe_poly</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dfun_id_w_fun</span>
<a name="line-84"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>abe_mono</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>self_dict</span><span class='hs-layout'>,</span> <span class='hs-varid'>abe_prags</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SpecPrags</span> <span class='hs-varid'>spec_inst_prags</span> <span class='hs-layout'>}</span>
<a name="line-85"></a>             <span class='hs-varid'>main_bind</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AbsBinds</span> <span class='hs-layout'>{</span> <span class='hs-varid'>abs_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_tyvars</span>
<a name="line-86"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>abs_ev_vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dfun_ev_vars</span>
<a name="line-87"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>abs_exports</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>export</span><span class='hs-keyglyph'>]</span>
<a name="line-88"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>abs_ev_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyTcEvBinds</span>
<a name="line-89"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>abs_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitBag</span> <span class='hs-varid'>dict_bind</span> <span class='hs-layout'>}</span>
<a name="line-90"></a>
<a name="line-91"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitBag</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>main_bind</span><span class='hs-layout'>)</span> <span class='hs-varop'>`unionBags`</span>
<a name="line-92"></a>                 <span class='hs-varid'>listToBag</span> <span class='hs-varid'>meth_binds</span>      <span class='hs-varop'>`unionBags`</span>
<a name="line-93"></a>                 <span class='hs-varid'>unionManyBags</span> <span class='hs-varid'>sc_binds</span><span class='hs-layout'>)</span>
<a name="line-94"></a>       <span class='hs-layout'>}</span>
<a name="line-95"></a> <span class='hs-keyword'>where</span>
<a name="line-96"></a>   <span class='hs-varid'>dfun_ty</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idType</span> <span class='hs-varid'>dfun_id</span>
<a name="line-97"></a>   <span class='hs-varid'>dfun_id</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>instanceDFunId</span> <span class='hs-varid'>ispec</span>
<a name="line-98"></a>   <span class='hs-varid'>loc</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getSrcSpan</span> <span class='hs-varid'>dfun_id</span>
<a name="line-99"></a>
<a name="line-100"></a><a name="tcSuperClass"></a><span class='hs-comment'>------------------------------</span>
<a name="line-101"></a><span class='hs-definition'>tcSuperClass</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span>
<a name="line-102"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>PredType</span><span class='hs-layout'>)</span>
<a name="line-103"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcId</span><span class='hs-layout'>,</span> <span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>
<a name="line-104"></a>
<a name="line-105"></a><span class='hs-comment'>-- Build a top level decl like</span>
<a name="line-106"></a><span class='hs-comment'>--      sc_op = /\a \d. let sc = ... in</span>
<a name="line-107"></a><span class='hs-comment'>--                      sc</span>
<a name="line-108"></a><span class='hs-comment'>-- and return sc_op, that binding</span>
<a name="line-109"></a>
<a name="line-110"></a><span class='hs-definition'>tcSuperClass</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>ev_vars</span> <span class='hs-layout'>(</span><span class='hs-varid'>sc_sel</span><span class='hs-layout'>,</span> <span class='hs-varid'>sc_pred</span><span class='hs-layout'>)</span>
<a name="line-111"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>sc_dict</span><span class='hs-layout'>)</span>
<a name="line-112"></a>             <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newImplication</span> <span class='hs-conid'>InstSkol</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>ev_vars</span> <span class='hs-varop'>$</span>
<a name="line-113"></a>                <span class='hs-varid'>emitWanted</span> <span class='hs-conid'>ScOrigin</span> <span class='hs-varid'>sc_pred</span>
<a name="line-114"></a>
<a name="line-115"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUnique</span>
<a name="line-116"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>sc_op_ty</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkForAllTys</span> <span class='hs-varid'>tyvars</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkPiTypes</span> <span class='hs-varid'>ev_vars</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>sc_dict</span><span class='hs-layout'>)</span>
<a name="line-117"></a>             <span class='hs-varid'>sc_op_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkDerivedInternalName</span> <span class='hs-varid'>mkClassOpAuxOcc</span> <span class='hs-varid'>uniq</span>
<a name="line-118"></a>                                                <span class='hs-layout'>(</span><span class='hs-varid'>getName</span> <span class='hs-varid'>sc_sel</span><span class='hs-layout'>)</span>
<a name="line-119"></a>             <span class='hs-varid'>sc_op_id</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLocalId</span> <span class='hs-varid'>sc_op_name</span> <span class='hs-varid'>sc_op_ty</span>
<a name="line-120"></a>             <span class='hs-varid'>sc_op_bind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarBind</span> <span class='hs-varid'>sc_op_id</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>noSrcSpan</span> <span class='hs-varop'>$</span> <span class='hs-varid'>wrapId</span> <span class='hs-varid'>sc_wrapper</span> <span class='hs-varid'>sc_dict</span><span class='hs-layout'>)</span>
<a name="line-121"></a>             <span class='hs-varid'>sc_wrapper</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWpTyLams</span> <span class='hs-varid'>tyvars</span>
<a name="line-122"></a>                          <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>mkWpLams</span> <span class='hs-varid'>ev_vars</span>
<a name="line-123"></a>                          <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>mkWpLet</span> <span class='hs-varid'>ev_binds</span>
<a name="line-124"></a>
<a name="line-125"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>sc_op_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>unitBag</span> <span class='hs-varid'>sc_op_bind</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-126"></a>
<a name="line-127"></a><a name="tcSpecInstPrags"></a><span class='hs-comment'>------------------------------</span>
<a name="line-128"></a><span class='hs-definition'>tcSpecInstPrags</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DFunId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InstBindings</span> <span class='hs-conid'>Name</span>
<a name="line-129"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Located</span> <span class='hs-conid'>TcSpecPrag</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>PragFun</span><span class='hs-layout'>)</span>
<a name="line-130"></a><span class='hs-definition'>tcSpecInstPrags</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>NewTypeDerived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-131"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-132"></a><span class='hs-definition'>tcSpecInstPrags</span> <span class='hs-varid'>dfun_id</span> <span class='hs-layout'>(</span><span class='hs-conid'>VanillaInst</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>uprags</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-133"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>spec_inst_prags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapLocM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcSpecInst</span> <span class='hs-varid'>dfun_id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-134"></a>                            <span class='hs-varid'>filter</span> <span class='hs-varid'>isSpecInstLSig</span> <span class='hs-varid'>uprags</span>
<a name="line-135"></a>             <span class='hs-comment'>-- The filter removes the pragmas for methods</span>
<a name="line-136"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>spec_inst_prags</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkPragFun</span> <span class='hs-varid'>uprags</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}

Note [Superclass loop avoidance]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider the following (extreme) situation:
        class C a => D a where ...
        instance D [a] => D [a] where ...
Although this looks wrong (assume D [a] to prove D [a]), it is only a
more extreme case of what happens with recursive dictionaries, and it
can, just about, make sense because the methods do some work before
recursing.

To implement the dfun we must generate code for the superclass C [a],
which we had better not get by superclass selection from the supplied
argument:
       dfun :: forall a. D [a] -> D [a]
       dfun = \d::D [a] -> MkD (scsel d) ..

Rather, we want to get it by finding an instance for (C [a]).  We
achieve this by
    not making the superclasses of a "wanted"
    available for solving wanted constraints.

Test case SCLoop tests this fix.

Note [SPECIALISE instance pragmas]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider

   instance (Ix a, Ix b) => Ix (a,b) where
     {-# SPECIALISE instance Ix (Int,Int) #-}
     range (x,y) = ...

We do *not* want to make a specialised version of the dictionary
function.  Rather, we want specialised versions of each method.
Thus we should generate something like this:

  $dfIx :: (Ix a, Ix x) => Ix (a,b)
  {- DFUN [$crange, ...] -}
  $dfIx da db = Ix ($crange da db) (...other methods...)

  $dfIxPair :: (Ix a, Ix x) => Ix (a,b)
  {- DFUN [$crangePair, ...] -}
  $dfIxPair = Ix ($crangePair da db) (...other methods...)

  $crange :: (Ix a, Ix b) -> ((a,b),(a,b)) -> [(a,b)]
  {-# SPECIALISE $crange :: ((Int,Int),(Int,Int)) -> [(Int,Int)] #-}
  $crange da db = <blah>

  {-# RULE  range ($dfIx da db) = $crange da db #-}

Note that

  * The RULE is unaffected by the specialisation.  We don't want to
    specialise $dfIx, because then it would need a specialised RULE
    which is a pain.  The single RULE works fine at all specialisations.
    See Note [How instance declarations are translated] above

  * Instead, we want to specialise the *method*, $crange

In practice, rather than faking up a SPECIALISE pragama for each
method (which is painful, since we'd have to figure out its
specialised type), we call tcSpecPrag *as if* were going to specialise
$dfIx -- you can see that in the call to tcSpecInst.  That generates a
SpecPrag which, as it turns out, can be used unchanged for each method.
The "it turns out" bit is delicate, but it works fine!

\begin{code}
<pre><a name="line-1"></a><a name="tcSpecInst"></a><span class='hs-definition'>tcSpecInst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Sig</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcSpecPrag</span>
<a name="line-2"></a><span class='hs-definition'>tcSpecInst</span> <span class='hs-varid'>dfun_id</span> <span class='hs-varid'>prag</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SpecInstSig</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>spec_ctxt</span> <span class='hs-varid'>prag</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-4"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idName</span> <span class='hs-varid'>dfun_id</span>
<a name="line-5"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>clas</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsInstHead</span> <span class='hs-conid'>SpecInstCtxt</span> <span class='hs-varid'>hs_ty</span>
<a name="line-6"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>spec_dfun_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkDictFunTy</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>theta</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tys</span>
<a name="line-7"></a>
<a name="line-8"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>co_fn</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSubType</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpecPragOrigin</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-conid'>SpecInstCtxt</span>
<a name="line-9"></a>                             <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>dfun_id</span><span class='hs-layout'>)</span> <span class='hs-varid'>spec_dfun_ty</span>
<a name="line-10"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpecPrag</span> <span class='hs-varid'>dfun_id</span> <span class='hs-varid'>co_fn</span> <span class='hs-varid'>defaultInlinePragma</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-11"></a>  <span class='hs-keyword'>where</span>
<a name="line-12"></a>    <span class='hs-varid'>spec_ctxt</span> <span class='hs-varid'>prag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In the SPECIALISE pragma"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>prag</span><span class='hs-layout'>)</span>
<a name="line-13"></a>
<a name="line-14"></a><span class='hs-definition'>tcSpecInst</span> <span class='hs-keyword'>_</span>  <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tcSpecInst"</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
      Type-checking an instance method
%*                                                                      *
%************************************************************************

tcInstanceMethod
- Make the method bindings, as a [(NonRec, HsBinds)], one per method
- Remembering to use fresh Name (the instance method Name) as the binder
- Bring the instance method Ids into scope, for the benefit of tcInstSig
- Use sig_fn mapping instance method Name -> instance tyvars
- Ditto prag_fn
- Use tcValBinds to do the checking

\begin{code}
<pre><a name="line-1"></a><a name="tcInstanceMethods"></a><span class='hs-definition'>tcInstanceMethods</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DFunId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span>
<a name="line-3"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span>
<a name="line-4"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Located</span> <span class='hs-conid'>TcSpecPrag</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>PragFun</span><span class='hs-layout'>)</span>
<a name="line-5"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>DefMeth</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-6"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InstBindings</span> <span class='hs-conid'>Name</span>
<a name="line-7"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsBind</span> <span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-8"></a>        <span class='hs-comment'>-- The returned inst_meth_ids all have types starting</span>
<a name="line-9"></a>        <span class='hs-comment'>--      forall tvs. theta =&gt; ...</span>
<a name="line-10"></a><span class='hs-definition'>tcInstanceMethods</span> <span class='hs-varid'>dfun_id</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>dfun_ev_vars</span> <span class='hs-varid'>inst_tys</span>
<a name="line-11"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>spec_inst_prags</span><span class='hs-layout'>,</span> <span class='hs-varid'>prag_fn</span><span class='hs-layout'>)</span>
<a name="line-12"></a>                  <span class='hs-varid'>op_items</span> <span class='hs-layout'>(</span><span class='hs-conid'>VanillaInst</span> <span class='hs-varid'>binds</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>standalone_deriv</span><span class='hs-layout'>)</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAndUnzipM</span> <span class='hs-varid'>tc_item</span> <span class='hs-varid'>op_items</span>
<a name="line-14"></a>  <span class='hs-keyword'>where</span>
<a name="line-15"></a>    <span class='hs-comment'>----------------------</span>
<a name="line-16"></a>    <span class='hs-varid'>tc_item</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>DefMeth</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>LHsBind</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-17"></a>    <span class='hs-varid'>tc_item</span> <span class='hs-layout'>(</span><span class='hs-varid'>sel_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>dm_info</span><span class='hs-layout'>)</span>
<a name="line-18"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>findMethodBind</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>sel_id</span><span class='hs-layout'>)</span> <span class='hs-varid'>binds</span> <span class='hs-keyword'>of</span>
<a name="line-19"></a>            <span class='hs-conid'>Just</span> <span class='hs-varid'>user_bind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tc_body</span> <span class='hs-varid'>sel_id</span> <span class='hs-varid'>standalone_deriv</span> <span class='hs-varid'>user_bind</span>
<a name="line-20"></a>            <span class='hs-conid'>Nothing</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tc_def"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>sel_id</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;&gt;</span> 
<a name="line-21"></a>                              <span class='hs-varid'>tc_default</span> <span class='hs-varid'>sel_id</span> <span class='hs-varid'>dm_info</span>
<a name="line-22"></a>
<a name="line-23"></a>    <span class='hs-comment'>----------------------</span>
<a name="line-24"></a>    <span class='hs-varid'>tc_body</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsBind</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcId</span><span class='hs-layout'>,</span> <span class='hs-conid'>LHsBind</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-25"></a>    <span class='hs-varid'>tc_body</span> <span class='hs-varid'>sel_id</span> <span class='hs-varid'>generated_code</span> <span class='hs-varid'>rn_bind</span>
<a name="line-26"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>add_meth_ctxt</span> <span class='hs-varid'>sel_id</span> <span class='hs-varid'>generated_code</span> <span class='hs-varid'>rn_bind</span> <span class='hs-varop'>$</span>
<a name="line-27"></a>        <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>meth_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>local_meth_id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkMethIds</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>dfun_ev_vars</span>
<a name="line-28"></a>                                                   <span class='hs-varid'>inst_tys</span> <span class='hs-varid'>sel_id</span>
<a name="line-29"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>prags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prag_fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>sel_id</span><span class='hs-layout'>)</span>
<a name="line-30"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>meth_id1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addInlinePrags</span> <span class='hs-varid'>meth_id</span> <span class='hs-varid'>prags</span>
<a name="line-31"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>spec_prags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSpecPrags</span> <span class='hs-varid'>meth_id1</span> <span class='hs-varid'>prags</span>
<a name="line-32"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>bind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInstanceMethodBody</span> <span class='hs-conid'>InstSkol</span>
<a name="line-33"></a>                          <span class='hs-varid'>tyvars</span> <span class='hs-varid'>dfun_ev_vars</span>
<a name="line-34"></a>                          <span class='hs-varid'>meth_id1</span> <span class='hs-varid'>local_meth_id</span> <span class='hs-varid'>meth_sig_fn</span>
<a name="line-35"></a>                          <span class='hs-layout'>(</span><span class='hs-varid'>mk_meth_spec_prags</span> <span class='hs-varid'>meth_id1</span> <span class='hs-varid'>spec_prags</span><span class='hs-layout'>)</span>
<a name="line-36"></a>                          <span class='hs-varid'>rn_bind</span>
<a name="line-37"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>meth_id1</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-38"></a>
<a name="line-39"></a>    <span class='hs-comment'>----------------------</span>
<a name="line-40"></a>    <span class='hs-varid'>tc_default</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DefMeth</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcId</span><span class='hs-layout'>,</span> <span class='hs-conid'>LHsBind</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>
<a name="line-41"></a>
<a name="line-42"></a>    <span class='hs-varid'>tc_default</span> <span class='hs-varid'>sel_id</span> <span class='hs-layout'>(</span><span class='hs-conid'>GenDefMeth</span> <span class='hs-varid'>dm_name</span><span class='hs-layout'>)</span>
<a name="line-43"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>meth_bind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkGenericDefMethBind</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>inst_tys</span> <span class='hs-varid'>sel_id</span> <span class='hs-varid'>dm_name</span>
<a name="line-44"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>tc_body</span> <span class='hs-varid'>sel_id</span> <span class='hs-conid'>False</span> <span class='hs-comment'>{- Not generated code? -}</span> <span class='hs-varid'>meth_bind</span> <span class='hs-layout'>}</span>
<a name="line-45"></a>
<a name="line-46"></a>    <span class='hs-varid'>tc_default</span> <span class='hs-varid'>sel_id</span> <span class='hs-conid'>NoDefMeth</span>     <span class='hs-comment'>-- No default method at all</span>
<a name="line-47"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tc_def: warn"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>sel_id</span><span class='hs-layout'>)</span>
<a name="line-48"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>warnMissingMethod</span> <span class='hs-varid'>sel_id</span>
<a name="line-49"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>meth_id</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkMethIds</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>dfun_ev_vars</span>
<a name="line-50"></a>                                         <span class='hs-varid'>inst_tys</span> <span class='hs-varid'>sel_id</span>
<a name="line-51"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>meth_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkVarBind</span> <span class='hs-varid'>meth_id</span> <span class='hs-varop'>$</span>
<a name="line-52"></a>                              <span class='hs-varid'>mkLHsWrap</span> <span class='hs-varid'>lam_wrapper</span> <span class='hs-varid'>error_rhs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-53"></a>      <span class='hs-keyword'>where</span>
<a name="line-54"></a>        <span class='hs-varid'>error_rhs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsApp</span> <span class='hs-varid'>error_fun</span> <span class='hs-varid'>error_msg</span>
<a name="line-55"></a>        <span class='hs-varid'>error_fun</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>wrapId</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpTyApp</span> <span class='hs-varid'>meth_tau</span><span class='hs-layout'>)</span> <span class='hs-varid'>nO_METHOD_BINDING_ERROR_ID</span>
<a name="line-56"></a>        <span class='hs-varid'>error_msg</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsStringPrim</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFastString</span> <span class='hs-varid'>error_string</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-57"></a>        <span class='hs-varid'>meth_tau</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funResultTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>applyTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>sel_id</span><span class='hs-layout'>)</span> <span class='hs-varid'>inst_tys</span><span class='hs-layout'>)</span>
<a name="line-58"></a>        <span class='hs-varid'>error_string</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>showSDoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>hcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>loc</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"|"</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>sel_id</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-59"></a>        <span class='hs-varid'>lam_wrapper</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWpTyLams</span> <span class='hs-varid'>tyvars</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>mkWpLams</span> <span class='hs-varid'>dfun_ev_vars</span>
<a name="line-60"></a>
<a name="line-61"></a>    <span class='hs-varid'>tc_default</span> <span class='hs-varid'>sel_id</span> <span class='hs-layout'>(</span><span class='hs-conid'>DefMeth</span> <span class='hs-varid'>dm_name</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- A polymorphic default method</span>
<a name="line-62"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>   <span class='hs-comment'>-- Build the typechecked version directly,</span>
<a name="line-63"></a>                 <span class='hs-comment'>-- without calling typecheck_method;</span>
<a name="line-64"></a>                 <span class='hs-comment'>-- see Note [Default methods in instances]</span>
<a name="line-65"></a>                 <span class='hs-comment'>-- Generate   /\as.\ds. let self = df as ds</span>
<a name="line-66"></a>                 <span class='hs-comment'>--                      in $dm inst_tys self</span>
<a name="line-67"></a>                 <span class='hs-comment'>-- The 'let' is necessary only because HsSyn doesn't allow</span>
<a name="line-68"></a>                 <span class='hs-comment'>-- you to apply a function to a dictionary *expression*.</span>
<a name="line-69"></a>
<a name="line-70"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>self_dict</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newDict</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>inst_tys</span>
<a name="line-71"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>self_ev_bind</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvBind</span> <span class='hs-varid'>self_dict</span>
<a name="line-72"></a>                                <span class='hs-layout'>(</span><span class='hs-conid'>EvDFunApp</span> <span class='hs-varid'>dfun_id</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>tyvars</span><span class='hs-layout'>)</span> <span class='hs-varid'>dfun_ev_vars</span><span class='hs-layout'>)</span>
<a name="line-73"></a>
<a name="line-74"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>meth_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>local_meth_id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkMethIds</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>dfun_ev_vars</span>
<a name="line-75"></a>                                                   <span class='hs-varid'>inst_tys</span> <span class='hs-varid'>sel_id</span>
<a name="line-76"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>dm_id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupId</span> <span class='hs-varid'>dm_name</span>
<a name="line-77"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>dm_inline_prag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idInlinePragma</span> <span class='hs-varid'>dm_id</span>
<a name="line-78"></a>                 <span class='hs-varid'>rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HsWrap</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkWpEvVarApps</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>self_dict</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>mkWpTyApps</span> <span class='hs-varid'>inst_tys</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-79"></a>                       <span class='hs-conid'>HsVar</span> <span class='hs-varid'>dm_id</span>
<a name="line-80"></a>
<a name="line-81"></a>                 <span class='hs-varid'>meth_bind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarBind</span> <span class='hs-varid'>local_meth_id</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-82"></a>                 <span class='hs-varid'>meth_id1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>meth_id</span> <span class='hs-varop'>`setInlinePragma`</span> <span class='hs-varid'>dm_inline_prag</span>
<a name="line-83"></a>                        <span class='hs-comment'>-- Copy the inline pragma (if any) from the default</span>
<a name="line-84"></a>                        <span class='hs-comment'>-- method to this version. Note [INLINE and default methods]</span>
<a name="line-85"></a>
<a name="line-86"></a>                  
<a name="line-87"></a>                 <span class='hs-varid'>export</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ABE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>abe_wrap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idHsWrapper</span><span class='hs-layout'>,</span> <span class='hs-varid'>abe_poly</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>meth_id1</span>
<a name="line-88"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>abe_mono</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>local_meth_id</span>
<a name="line-89"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>abe_prags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_meth_spec_prags</span> <span class='hs-varid'>meth_id1</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>}</span>
<a name="line-90"></a>                 <span class='hs-varid'>bind</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AbsBinds</span> <span class='hs-layout'>{</span> <span class='hs-varid'>abs_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>abs_ev_vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dfun_ev_vars</span>
<a name="line-91"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>abs_exports</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>export</span><span class='hs-keyglyph'>]</span>
<a name="line-92"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>abs_ev_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvBinds</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitBag</span> <span class='hs-varid'>self_ev_bind</span><span class='hs-layout'>)</span>
<a name="line-93"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>abs_binds</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitBag</span> <span class='hs-varid'>meth_bind</span> <span class='hs-layout'>}</span>
<a name="line-94"></a>             <span class='hs-comment'>-- Default methods in an instance declaration can't have their own</span>
<a name="line-95"></a>             <span class='hs-comment'>-- INLINE or SPECIALISE pragmas. It'd be possible to allow them, but</span>
<a name="line-96"></a>             <span class='hs-comment'>-- currently they are rejected with</span>
<a name="line-97"></a>             <span class='hs-comment'>--           "INLINE pragma lacks an accompanying binding"</span>
<a name="line-98"></a>
<a name="line-99"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>meth_id1</span><span class='hs-layout'>,</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-100"></a>
<a name="line-101"></a>    <span class='hs-comment'>----------------------</span>
<a name="line-102"></a>    <span class='hs-varid'>mk_meth_spec_prags</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LTcSpecPrag</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSpecPrags</span>
<a name="line-103"></a>        <span class='hs-comment'>-- Adapt the SPECIALISE pragmas to work for this method Id</span>
<a name="line-104"></a>        <span class='hs-comment'>-- There are two sources:</span>
<a name="line-105"></a>        <span class='hs-comment'>--   * spec_inst_prags: {-# SPECIALISE instance :: &lt;blah&gt; #-}</span>
<a name="line-106"></a>        <span class='hs-comment'>--     These ones have the dfun inside, but [perhaps surprisingly]</span>
<a name="line-107"></a>        <span class='hs-comment'>--     the correct wrapper</span>
<a name="line-108"></a>        <span class='hs-comment'>--   * spec_prags_for_me: {-# SPECIALISE op :: &lt;blah&gt; #-}</span>
<a name="line-109"></a>    <span class='hs-varid'>mk_meth_spec_prags</span> <span class='hs-varid'>meth_id</span> <span class='hs-varid'>spec_prags_for_me</span>
<a name="line-110"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SpecPrags</span> <span class='hs-layout'>(</span><span class='hs-varid'>spec_prags_for_me</span> <span class='hs-varop'>++</span>
<a name="line-111"></a>                   <span class='hs-keyglyph'>[</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpecPrag</span> <span class='hs-varid'>meth_id</span> <span class='hs-varid'>wrap</span> <span class='hs-varid'>inl</span><span class='hs-layout'>)</span>
<a name="line-112"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpecPrag</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>wrap</span> <span class='hs-varid'>inl</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>spec_inst_prags</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-113"></a>
<a name="line-114"></a>    <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getSrcSpan</span> <span class='hs-varid'>dfun_id</span>
<a name="line-115"></a>    <span class='hs-varid'>meth_sig_fn</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-varid'>loc</span><span class='hs-layout'>)</span>       <span class='hs-comment'>-- The 'Just' says "yes, there's a type sig"</span>
<a name="line-116"></a>        <span class='hs-comment'>-- But there are no scoped type variables from local_method_id</span>
<a name="line-117"></a>        <span class='hs-comment'>-- Only the ones from the instance decl itself, which are already</span>
<a name="line-118"></a>        <span class='hs-comment'>-- in scope.  Example:</span>
<a name="line-119"></a>        <span class='hs-comment'>--      class C a where { op :: forall b. Eq b =&gt; ... }</span>
<a name="line-120"></a>        <span class='hs-comment'>--      instance C [c] where { op = &lt;rhs&gt; }</span>
<a name="line-121"></a>        <span class='hs-comment'>-- In &lt;rhs&gt;, 'c' is scope but 'b' is not!</span>
<a name="line-122"></a>
<a name="line-123"></a>        <span class='hs-comment'>-- For instance decls that come from standalone deriving clauses</span>
<a name="line-124"></a>        <span class='hs-comment'>-- we want to print out the full source code if there's an error</span>
<a name="line-125"></a>        <span class='hs-comment'>-- because otherwise the user won't see the code at all</span>
<a name="line-126"></a>    <span class='hs-varid'>add_meth_ctxt</span> <span class='hs-varid'>sel_id</span> <span class='hs-varid'>generated_code</span> <span class='hs-varid'>rn_bind</span> <span class='hs-varid'>thing</span>
<a name="line-127"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>generated_code</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addLandmarkErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>derivBindCtxt</span> <span class='hs-varid'>sel_id</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>inst_tys</span> <span class='hs-varid'>rn_bind</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing</span>
<a name="line-128"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>thing</span>
<a name="line-129"></a>
<a name="line-130"></a>
<a name="line-131"></a><span class='hs-definition'>tcInstanceMethods</span> <span class='hs-varid'>dfun_id</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>dfun_ev_vars</span> <span class='hs-varid'>inst_tys</span>
<a name="line-132"></a>                  <span class='hs-keyword'>_</span> <span class='hs-varid'>op_items</span> <span class='hs-layout'>(</span><span class='hs-conid'>NewTypeDerived</span> <span class='hs-varid'>coi</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-133"></a>
<a name="line-134"></a><span class='hs-comment'>-- Running example:</span>
<a name="line-135"></a><span class='hs-comment'>--   class Show b =&gt; Foo a b where</span>
<a name="line-136"></a><span class='hs-comment'>--     op :: a -&gt; b -&gt; b</span>
<a name="line-137"></a><span class='hs-comment'>--   newtype N a = MkN (Tree [a])</span>
<a name="line-138"></a><span class='hs-comment'>--   deriving instance (Show p, Foo Int p) =&gt; Foo Int (N p)</span>
<a name="line-139"></a><span class='hs-comment'>--               -- NB: standalone deriving clause means</span>
<a name="line-140"></a><span class='hs-comment'>--               --     that the contex is user-specified</span>
<a name="line-141"></a><span class='hs-comment'>-- Hence op :: forall a b. Foo a b =&gt; a -&gt; b -&gt; b</span>
<a name="line-142"></a><span class='hs-comment'>--</span>
<a name="line-143"></a><span class='hs-comment'>-- We're going to make an instance like</span>
<a name="line-144"></a><span class='hs-comment'>--   instance (Show p, Foo Int p) =&gt; Foo Int (N p)</span>
<a name="line-145"></a><span class='hs-comment'>--      op = $copT</span>
<a name="line-146"></a><span class='hs-comment'>--</span>
<a name="line-147"></a><span class='hs-comment'>--   $copT :: forall p. (Show p, Foo Int p) =&gt; Int -&gt; N p -&gt; N p</span>
<a name="line-148"></a><span class='hs-comment'>--   $copT p (d1:Show p) (d2:Foo Int p)</span>
<a name="line-149"></a><span class='hs-comment'>--     = op Int (Tree [p]) rep_d |&gt; op_co</span>
<a name="line-150"></a><span class='hs-comment'>--     where</span>
<a name="line-151"></a><span class='hs-comment'>--       rep_d :: Foo Int (Tree [p]) = ...d1...d2...</span>
<a name="line-152"></a><span class='hs-comment'>--       op_co :: (Int -&gt; Tree [p] -&gt; Tree [p]) ~ (Int -&gt; T p -&gt; T p)</span>
<a name="line-153"></a><span class='hs-comment'>-- We get op_co by substituting [Int/a] and [co/b] in type for op</span>
<a name="line-154"></a><span class='hs-comment'>-- where co : [p] ~ T p</span>
<a name="line-155"></a><span class='hs-comment'>--</span>
<a name="line-156"></a><span class='hs-comment'>-- Notice that the dictionary bindings "..d1..d2.." must be generated</span>
<a name="line-157"></a><span class='hs-comment'>-- by the constraint solver, since the &lt;context&gt; may be</span>
<a name="line-158"></a><span class='hs-comment'>-- user-specified.</span>
<a name="line-159"></a>
<a name="line-160"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rep_d_stuff</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkConstraints</span> <span class='hs-conid'>InstSkol</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>dfun_ev_vars</span> <span class='hs-varop'>$</span>
<a name="line-161"></a>                        <span class='hs-varid'>emitWanted</span> <span class='hs-conid'>ScOrigin</span> <span class='hs-varid'>rep_pred</span>
<a name="line-162"></a>
<a name="line-163"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapAndUnzipM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_item</span> <span class='hs-varid'>rep_d_stuff</span><span class='hs-layout'>)</span> <span class='hs-varid'>op_items</span> <span class='hs-layout'>}</span>
<a name="line-164"></a>  <span class='hs-keyword'>where</span>
<a name="line-165"></a>     <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getSrcSpan</span> <span class='hs-varid'>dfun_id</span>
<a name="line-166"></a>     <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>init_inst_tys</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>snocView</span> <span class='hs-varid'>inst_tys</span>
<a name="line-167"></a>     <span class='hs-varid'>rep_ty</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pFst</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcCoercionKind</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- [p]</span>
<a name="line-168"></a>     <span class='hs-varid'>rep_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkClassPred</span> <span class='hs-varid'>clas</span> <span class='hs-layout'>(</span><span class='hs-varid'>init_inst_tys</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>rep_ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-169"></a>
<a name="line-170"></a>     <span class='hs-comment'>-- co : [p] ~ T p</span>
<a name="line-171"></a>     <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcSymCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcInstCos</span> <span class='hs-varid'>coi</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>tyvars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-172"></a>
<a name="line-173"></a>     <span class='hs-comment'>----------------</span>
<a name="line-174"></a>     <span class='hs-varid'>tc_item</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcEvBinds</span><span class='hs-layout'>,</span> <span class='hs-conid'>EvVar</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>DefMeth</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcId</span><span class='hs-layout'>,</span> <span class='hs-conid'>LHsBind</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>
<a name="line-175"></a>     <span class='hs-varid'>tc_item</span> <span class='hs-layout'>(</span><span class='hs-varid'>rep_ev_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>rep_d</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>sel_id</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-176"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>meth_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>local_meth_id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkMethIds</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>dfun_ev_vars</span>
<a name="line-177"></a>                                                    <span class='hs-varid'>inst_tys</span> <span class='hs-varid'>sel_id</span>
<a name="line-178"></a>
<a name="line-179"></a>            <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>meth_rhs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapId</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_op_wrapper</span> <span class='hs-varid'>sel_id</span> <span class='hs-varid'>rep_d</span><span class='hs-layout'>)</span> <span class='hs-varid'>sel_id</span>
<a name="line-180"></a>                  <span class='hs-varid'>meth_bind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarBind</span> <span class='hs-varid'>local_meth_id</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>meth_rhs</span><span class='hs-layout'>)</span>
<a name="line-181"></a>                  <span class='hs-varid'>export</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ABE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>abe_wrap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idHsWrapper</span><span class='hs-layout'>,</span> <span class='hs-varid'>abe_poly</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>meth_id</span>
<a name="line-182"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>abe_mono</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>local_meth_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>abe_prags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noSpecPrags</span> <span class='hs-layout'>}</span>
<a name="line-183"></a>                  <span class='hs-varid'>bind</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AbsBinds</span> <span class='hs-layout'>{</span> <span class='hs-varid'>abs_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>abs_ev_vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dfun_ev_vars</span>
<a name="line-184"></a>                                   <span class='hs-layout'>,</span> <span class='hs-varid'>abs_exports</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>export</span><span class='hs-keyglyph'>]</span>
<a name="line-185"></a>                                   <span class='hs-layout'>,</span> <span class='hs-varid'>abs_ev_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rep_ev_binds</span>
<a name="line-186"></a>                                   <span class='hs-layout'>,</span> <span class='hs-varid'>abs_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitBag</span> <span class='hs-varop'>$</span> <span class='hs-varid'>meth_bind</span> <span class='hs-layout'>}</span>
<a name="line-187"></a>
<a name="line-188"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>meth_id</span><span class='hs-layout'>,</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-189"></a>
<a name="line-190"></a>     <span class='hs-comment'>----------------</span>
<a name="line-191"></a>     <span class='hs-varid'>mk_op_wrapper</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-192"></a>     <span class='hs-varid'>mk_op_wrapper</span> <span class='hs-varid'>sel_id</span> <span class='hs-varid'>rep_d</span>
<a name="line-193"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WpCast</span> <span class='hs-layout'>(</span><span class='hs-varid'>liftTcCoSubstWith</span> <span class='hs-varid'>sel_tvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>mkTcReflCo</span> <span class='hs-varid'>init_inst_tys</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>co</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-194"></a>                                   <span class='hs-varid'>local_meth_ty</span><span class='hs-layout'>)</span>
<a name="line-195"></a>         <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-conid'>WpEvApp</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvId</span> <span class='hs-varid'>rep_d</span><span class='hs-layout'>)</span>
<a name="line-196"></a>         <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>mkWpTyApps</span> <span class='hs-layout'>(</span><span class='hs-varid'>init_inst_tys</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>rep_ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-197"></a>       <span class='hs-keyword'>where</span>
<a name="line-198"></a>         <span class='hs-layout'>(</span><span class='hs-varid'>sel_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>sel_rho</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitForAllTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>sel_id</span><span class='hs-layout'>)</span>
<a name="line-199"></a>         <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>local_meth_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitPredFunTy_maybe</span> <span class='hs-varid'>sel_rho</span>
<a name="line-200"></a>                              <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tcInstanceMethods"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>sel_id</span><span class='hs-layout'>)</span>
<a name="line-201"></a>
<a name="line-202"></a><a name="mkMethIds"></a><span class='hs-comment'>----------------------</span>
<a name="line-203"></a><span class='hs-definition'>mkMethIds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcId</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>
<a name="line-204"></a><span class='hs-definition'>mkMethIds</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>dfun_ev_vars</span> <span class='hs-varid'>inst_tys</span> <span class='hs-varid'>sel_id</span>
<a name="line-205"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUnique</span>
<a name="line-206"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>meth_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkDerivedInternalName</span> <span class='hs-varid'>mkClassOpAuxOcc</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>sel_name</span>
<a name="line-207"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>local_meth_name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newLocalName</span> <span class='hs-varid'>sel_name</span>
<a name="line-208"></a>                  <span class='hs-comment'>-- Base the local_meth_name on the selector name, becuase</span>
<a name="line-209"></a>                  <span class='hs-comment'>-- type errors from tcInstanceMethodBody come from here</span>
<a name="line-210"></a>
<a name="line-211"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>meth_id</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLocalId</span> <span class='hs-varid'>meth_name</span> <span class='hs-varid'>meth_ty</span>
<a name="line-212"></a>              <span class='hs-varid'>local_meth_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLocalId</span> <span class='hs-varid'>local_meth_name</span> <span class='hs-varid'>local_meth_ty</span>
<a name="line-213"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>meth_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>local_meth_id</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-214"></a>  <span class='hs-keyword'>where</span>
<a name="line-215"></a>    <span class='hs-varid'>local_meth_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>instantiateMethod</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>sel_id</span> <span class='hs-varid'>inst_tys</span>
<a name="line-216"></a>    <span class='hs-varid'>meth_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkForAllTys</span> <span class='hs-varid'>tyvars</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkPiTypes</span> <span class='hs-varid'>dfun_ev_vars</span> <span class='hs-varid'>local_meth_ty</span>
<a name="line-217"></a>    <span class='hs-varid'>sel_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idName</span> <span class='hs-varid'>sel_id</span>
<a name="line-218"></a>
<a name="line-219"></a><a name="wrapId"></a><span class='hs-comment'>----------------------</span>
<a name="line-220"></a><span class='hs-definition'>wrapId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsExpr</span> <span class='hs-varid'>id</span>
<a name="line-221"></a><span class='hs-definition'>wrapId</span> <span class='hs-varid'>wrapper</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkHsWrap</span> <span class='hs-varid'>wrapper</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-222"></a>
<a name="line-223"></a><a name="derivBindCtxt"></a><span class='hs-definition'>derivBindCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span> <span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsBind</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-224"></a><span class='hs-definition'>derivBindCtxt</span> <span class='hs-varid'>sel_id</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tys</span> <span class='hs-sel'>_bind</span>
<a name="line-225"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"When typechecking the code for "</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>sel_id</span><span class='hs-layout'>)</span>
<a name="line-226"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"in a standalone derived instance for"</span><span class='hs-layout'>)</span>
<a name="line-227"></a>                    <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprClassPred</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span><span class='hs-layout'>)</span>
<a name="line-228"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"To see the code I am typechecking, use -ddump-deriv"</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-229"></a>
<a name="line-230"></a><span class='hs-comment'>-- Too voluminous</span>
<a name="line-231"></a><span class='hs-comment'>--        , nest 2 $ pprSetDepth AllTheWay $ ppr bind ]</span>
<a name="line-232"></a>
<a name="line-233"></a><a name="warnMissingMethod"></a><span class='hs-definition'>warnMissingMethod</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-234"></a><span class='hs-definition'>warnMissingMethod</span> <span class='hs-varid'>sel_id</span>
<a name="line-235"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>warn</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>woptM</span> <span class='hs-conid'>Opt_WarnMissingMethods</span>
<a name="line-236"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"warn"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>sel_id</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>warn</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>startsWithUnderscore</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>sel_id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-237"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>warnTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>warn</span>  <span class='hs-comment'>-- Warn only if -fwarn-missing-methods</span>
<a name="line-238"></a>                 <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>startsWithUnderscore</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>sel_id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-239"></a>                                        <span class='hs-comment'>-- Don't warn about _foo methods</span>
<a name="line-240"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"No explicit method nor default method for"</span><span class='hs-layout'>)</span>
<a name="line-241"></a>                 <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>sel_id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}

Note [Export helper functions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We arrange to export the "helper functions" of an instance declaration,
so that they are not subject to preInlineUnconditionally, even if their
RHS is trivial.  Reason: they are mentioned in the DFunUnfolding of
the dict fun as Ids, not as CoreExprs, so we can't substitute a
non-variable for them.

We could change this by making DFunUnfoldings have CoreExprs, but it
seems a bit simpler this way.

Note [Default methods in instances]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this

   class Baz v x where
      foo :: x -> x
      foo y = <blah>

   instance Baz Int Int

From the class decl we get

   $dmfoo :: forall v x. Baz v x => x -> x
   $dmfoo y = <blah>

Notice that the type is ambiguous.  That's fine, though. The instance
decl generates

   $dBazIntInt = MkBaz fooIntInt
   fooIntInt = $dmfoo Int Int $dBazIntInt

BUT this does mean we must generate the dictionary translation of
fooIntInt directly, rather than generating source-code and
type-checking it.  That was the bug in Trac #1061. In any case it's
less work to generate the translated version!

Note [INLINE and default methods]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Default methods need special case.  They are supposed to behave rather like
macros.  For exmample

  class Foo a where
    op1, op2 :: Bool -> a -> a

    {-# INLINE op1 #-}
    op1 b x = op2 (not b) x

  instance Foo Int where
    -- op1 via default method
    op2 b x = <blah>

The instance declaration should behave

   just as if 'op1' had been defined with the
   code, and INLINE pragma, from its original
   definition.

That is, just as if you'd written

  instance Foo Int where
    op2 b x = <blah>

    {-# INLINE op1 #-}
    op1 b x = op2 (not b) x

So for the above example we generate:


  {-# INLINE $dmop1 #-}
  -- $dmop1 has an InlineCompulsory unfolding
  $dmop1 d b x = op2 d (not b) x

  $fFooInt = MkD $cop1 $cop2

  {-# INLINE $cop1 #-}
  $cop1 = $dmop1 $fFooInt

  $cop2 = <blah>

Note carefullly:

* We *copy* any INLINE pragma from the default method $dmop1 to the
  instance $cop1.  Otherwise we'll just inline the former in the
  latter and stop, which isn't what the user expected

* Regardless of its pragma, we give the default method an
  unfolding with an InlineCompulsory source. That means
  that it'll be inlined at every use site, notably in
  each instance declaration, such as $cop1.  This inlining
  must happen even though
    a) $dmop1 is not saturated in $cop1
    b) $cop1 itself has an INLINE pragma

  It's vital that $dmop1 *is* inlined in this way, to allow the mutual
  recursion between $fooInt and $cop1 to be broken

* To communicate the need for an InlineCompulsory to the desugarer
  (which makes the Unfoldings), we use the IsDefaultMethod constructor
  in TcSpecPrags.


%************************************************************************
%*                                                                      *
\subsection{Error messages}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="instDeclCtxt1"></a><span class='hs-definition'>instDeclCtxt1</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2"></a><span class='hs-definition'>instDeclCtxt1</span> <span class='hs-varid'>hs_inst_ty</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_decl_ctxt</span> <span class='hs-layout'>(</span><span class='hs-keyword'>case</span> <span class='hs-varid'>unLoc</span> <span class='hs-varid'>hs_inst_ty</span> <span class='hs-keyword'>of</span>
<a name="line-4"></a>                        <span class='hs-conid'>HsForAllTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty'</span>
<a name="line-5"></a>                        <span class='hs-keyword'>_</span>                          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_inst_ty</span><span class='hs-layout'>)</span>     <span class='hs-comment'>-- Don't expect this</span>
<a name="line-6"></a><a name="instDeclCtxt2"></a><span class='hs-definition'>instDeclCtxt2</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-7"></a><span class='hs-definition'>instDeclCtxt2</span> <span class='hs-varid'>dfun_ty</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inst_decl_ctxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkClassPred</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-9"></a>  <span class='hs-keyword'>where</span>
<a name="line-10"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>cls</span><span class='hs-layout'>,</span><span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitDFunTy</span> <span class='hs-varid'>dfun_ty</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="inst_decl_ctxt"></a><span class='hs-definition'>inst_decl_ctxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-13"></a><span class='hs-definition'>inst_decl_ctxt</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In the instance declaration for"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-varid'>doc</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="omittedATWarn"></a><span class='hs-definition'>omittedATWarn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-16"></a><span class='hs-definition'>omittedATWarn</span> <span class='hs-varid'>at</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"No explicit AT declaration for"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>at</span><span class='hs-layout'>)</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="badBootFamInstDeclErr"></a><span class='hs-definition'>badBootFamInstDeclErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span>
<a name="line-20"></a><span class='hs-definition'>badBootFamInstDeclErr</span>
<a name="line-21"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal family instance in hs-boot file"</span><span class='hs-layout'>)</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="notFamily"></a><span class='hs-definition'>notFamily</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-24"></a><span class='hs-definition'>notFamily</span> <span class='hs-varid'>tycon</span>
<a name="line-25"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal family instance for"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span>
<a name="line-26"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tycon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is not an indexed type family"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-27"></a>
<a name="line-28"></a><a name="tooFewParmsErr"></a><span class='hs-definition'>tooFewParmsErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-29"></a><span class='hs-definition'>tooFewParmsErr</span> <span class='hs-varid'>arity</span>
<a name="line-30"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Family instance has too few parameters; expected"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-31"></a>    <span class='hs-varid'>ppr</span> <span class='hs-varid'>arity</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="assocInClassErr"></a><span class='hs-definition'>assocInClassErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Located</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-34"></a><span class='hs-definition'>assocInClassErr</span> <span class='hs-varid'>name</span>
<a name="line-35"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Associated type"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-36"></a>   <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"must be inside a class instance"</span><span class='hs-layout'>)</span>
<a name="line-37"></a>
<a name="line-38"></a><a name="badFamInstDecl"></a><span class='hs-definition'>badFamInstDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Located</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-39"></a><span class='hs-definition'>badFamInstDecl</span> <span class='hs-varid'>tc_name</span>
<a name="line-40"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal family instance for"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-41"></a>           <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc_name</span><span class='hs-layout'>)</span>
<a name="line-42"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>parens</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Use -XTypeFamilies to allow indexed type families"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
</pre>\end{code}
</body>
</html>
