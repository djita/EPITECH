<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>typecheck/TcMType.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%

Monadic type operations

This module contains monadic operations over types that contain
mutable type variables

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcMType</span> <span class='hs-layout'>(</span>
<a name="line-9"></a>  <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTauType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcThetaType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVarSet</span><span class='hs-layout'>,</span>
<a name="line-10"></a>
<a name="line-11"></a>  <span class='hs-comment'>--------------------------------</span>
<a name="line-12"></a>  <span class='hs-comment'>-- Creating new mutable type variables</span>
<a name="line-13"></a>  <span class='hs-varid'>newFlexiTyVar</span><span class='hs-layout'>,</span>
<a name="line-14"></a>  <span class='hs-varid'>newFlexiTyVarTy</span><span class='hs-layout'>,</span>		<span class='hs-comment'>-- Kind -&gt; TcM TcType</span>
<a name="line-15"></a>  <span class='hs-varid'>newFlexiTyVarTys</span><span class='hs-layout'>,</span>		<span class='hs-comment'>-- Int -&gt; Kind -&gt; TcM [TcType]</span>
<a name="line-16"></a>  <span class='hs-varid'>newMetaKindVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>newMetaKindVars</span><span class='hs-layout'>,</span>
<a name="line-17"></a>  <span class='hs-varid'>mkTcTyVarName</span><span class='hs-layout'>,</span>
<a name="line-18"></a>
<a name="line-19"></a>  <span class='hs-varid'>newMetaTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>readMetaTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>writeMetaTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>writeMetaTyVarRef</span><span class='hs-layout'>,</span>
<a name="line-20"></a>  <span class='hs-varid'>isFilledMetaTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>isFlexiMetaTyVar</span><span class='hs-layout'>,</span>
<a name="line-21"></a>
<a name="line-22"></a>  <span class='hs-comment'>--------------------------------</span>
<a name="line-23"></a>  <span class='hs-comment'>-- Creating new evidence variables</span>
<a name="line-24"></a>  <span class='hs-varid'>newEvVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>newEvVars</span><span class='hs-layout'>,</span>
<a name="line-25"></a>  <span class='hs-varid'>newEq</span><span class='hs-layout'>,</span> <span class='hs-varid'>newIP</span><span class='hs-layout'>,</span> <span class='hs-varid'>newDict</span><span class='hs-layout'>,</span>
<a name="line-26"></a>
<a name="line-27"></a>  <span class='hs-varid'>newWantedEvVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>newWantedEvVars</span><span class='hs-layout'>,</span>
<a name="line-28"></a>  <span class='hs-varid'>newTcEvBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>addTcEvBind</span><span class='hs-layout'>,</span>
<a name="line-29"></a>
<a name="line-30"></a>  <span class='hs-comment'>--------------------------------</span>
<a name="line-31"></a>  <span class='hs-comment'>-- Instantiation</span>
<a name="line-32"></a>  <span class='hs-varid'>tcInstTyVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcInstSigTyVars</span><span class='hs-layout'>,</span>
<a name="line-33"></a>  <span class='hs-varid'>tcInstType</span><span class='hs-layout'>,</span> 
<a name="line-34"></a>  <span class='hs-varid'>tcInstSkolTyVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcInstSuperSkolTyVars</span><span class='hs-layout'>,</span>
<a name="line-35"></a>  <span class='hs-varid'>tcInstSkolTyVarsX</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcInstSuperSkolTyVarsX</span><span class='hs-layout'>,</span>
<a name="line-36"></a>  <span class='hs-varid'>tcInstSkolTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcInstSkolType</span><span class='hs-layout'>,</span>
<a name="line-37"></a>  <span class='hs-varid'>tcSkolDFunType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSuperSkolTyVars</span><span class='hs-layout'>,</span>
<a name="line-38"></a>
<a name="line-39"></a>  <span class='hs-comment'>--------------------------------</span>
<a name="line-40"></a>  <span class='hs-comment'>-- Checking type validity</span>
<a name="line-41"></a>  <span class='hs-conid'>Rank</span><span class='hs-layout'>,</span> <span class='hs-conid'>UserTypeCtxt</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>checkValidType</span><span class='hs-layout'>,</span> <span class='hs-varid'>checkValidMonoType</span><span class='hs-layout'>,</span>
<a name="line-42"></a>  <span class='hs-varid'>expectedKindInCtxt</span><span class='hs-layout'>,</span> 
<a name="line-43"></a>  <span class='hs-varid'>checkValidTheta</span><span class='hs-layout'>,</span> 
<a name="line-44"></a>  <span class='hs-varid'>checkValidInstHead</span><span class='hs-layout'>,</span> <span class='hs-varid'>checkValidInstance</span><span class='hs-layout'>,</span> <span class='hs-varid'>validDerivPred</span><span class='hs-layout'>,</span>
<a name="line-45"></a>  <span class='hs-varid'>checkInstTermination</span><span class='hs-layout'>,</span> <span class='hs-varid'>checkValidFamInst</span><span class='hs-layout'>,</span> <span class='hs-varid'>checkTyFamFreeness</span><span class='hs-layout'>,</span> 
<a name="line-46"></a>  <span class='hs-varid'>arityErr</span><span class='hs-layout'>,</span> 
<a name="line-47"></a>  <span class='hs-varid'>growPredTyVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>growThetaTyVars</span><span class='hs-layout'>,</span> 
<a name="line-48"></a>
<a name="line-49"></a>  <span class='hs-comment'>--------------------------------</span>
<a name="line-50"></a>  <span class='hs-comment'>-- Zonking</span>
<a name="line-51"></a>  <span class='hs-varid'>zonkType</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkTcPredType</span><span class='hs-layout'>,</span> 
<a name="line-52"></a>  <span class='hs-varid'>zonkTcTypeCarefully</span><span class='hs-layout'>,</span> <span class='hs-varid'>skolemiseUnboundMetaTyVar</span><span class='hs-layout'>,</span>
<a name="line-53"></a>  <span class='hs-varid'>zonkTcTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkTcTyVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkTcTyVarsAndFV</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkSigTyVar</span><span class='hs-layout'>,</span>
<a name="line-54"></a>  <span class='hs-varid'>zonkQuantifiedTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkQuantifiedTyVars</span><span class='hs-layout'>,</span>
<a name="line-55"></a>  <span class='hs-varid'>zonkTcType</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkTcTypes</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkTcThetaType</span><span class='hs-layout'>,</span>
<a name="line-56"></a>
<a name="line-57"></a>  <span class='hs-varid'>zonkTcKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>defaultKindVarToStar</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkCt</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkCts</span><span class='hs-layout'>,</span>
<a name="line-58"></a>  <span class='hs-varid'>zonkImplication</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkEvVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkWantedEvVar</span><span class='hs-layout'>,</span>
<a name="line-59"></a>
<a name="line-60"></a>  <span class='hs-varid'>zonkWC</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkWantedEvVars</span><span class='hs-layout'>,</span>
<a name="line-61"></a>  <span class='hs-varid'>zonkTcTypeAndSubst</span><span class='hs-layout'>,</span>
<a name="line-62"></a>  <span class='hs-varid'>tcGetGlobalTyVars</span><span class='hs-layout'>,</span> 
<a name="line-63"></a>
<a name="line-64"></a>  <span class='hs-varid'>compatKindTcM</span><span class='hs-layout'>,</span> <span class='hs-varid'>isSubKindTcM</span>
<a name="line-65"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-66"></a>
<a name="line-67"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-68"></a>
<a name="line-69"></a><span class='hs-comment'>-- friends:</span>
<a name="line-70"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TypeRep</span>
<a name="line-71"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-72"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-73"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Kind</span>
<a name="line-74"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span>
<a name="line-75"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-76"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-77"></a>
<a name="line-78"></a><span class='hs-comment'>-- others:</span>
<a name="line-79"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>		<span class='hs-comment'>-- HsType</span>
<a name="line-80"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>        <span class='hs-comment'>-- TcType, amongst others</span>
<a name="line-81"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>IParam</span>
<a name="line-82"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-83"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FunDeps</span>
<a name="line-84"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-85"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-86"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ErrUtils</span>
<a name="line-87"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-88"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-89"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-90"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ListSetOps</span>
<a name="line-91"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-92"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-93"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-94"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-95"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unique</span><span class='hs-layout'>(</span> <span class='hs-conid'>Unique</span> <span class='hs-layout'>)</span>
<a name="line-96"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>
<a name="line-97"></a>
<a name="line-98"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-99"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>        <span class='hs-layout'>(</span> <span class='hs-layout'>(</span><span class='hs-varop'>\\</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>partition</span><span class='hs-layout'>,</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*									*
	Kind variables
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="newMetaKindVar"></a><span class='hs-definition'>newMetaKindVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcKind</span>
<a name="line-2"></a><span class='hs-definition'>newMetaKindVar</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUnique</span>
<a name="line-3"></a>		<span class='hs-layout'>;</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMutVar</span> <span class='hs-conid'>Flexi</span>
<a name="line-4"></a>		<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkMetaKindVar</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>ref</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="newMetaKindVars"></a><span class='hs-definition'>newMetaKindVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcKind</span><span class='hs-keyglyph'>]</span>
<a name="line-7"></a><span class='hs-definition'>newMetaKindVars</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>newMetaKindVar</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>nOfThem</span> <span class='hs-varid'>n</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*									*
     Evidence variables; range over constraints we can abstract over
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="newEvVars"></a><span class='hs-definition'>newEvVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-definition'>newEvVars</span> <span class='hs-varid'>theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>newEvVar</span> <span class='hs-varid'>theta</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="newWantedEvVar"></a><span class='hs-definition'>newWantedEvVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>EvVar</span> 
<a name="line-5"></a><span class='hs-definition'>newWantedEvVar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newEvVar</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="newWantedEvVars"></a><span class='hs-definition'>newWantedEvVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span> 
<a name="line-8"></a><span class='hs-definition'>newWantedEvVars</span> <span class='hs-varid'>theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>newWantedEvVar</span> <span class='hs-varid'>theta</span> 
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-comment'>--------------</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="newEvVar"></a><span class='hs-definition'>newEvVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>EvVar</span>
<a name="line-13"></a><span class='hs-comment'>-- Creates new *rigid* variables for predicates</span>
<a name="line-14"></a><span class='hs-definition'>newEvVar</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newName</span> <span class='hs-layout'>(</span><span class='hs-varid'>predTypeOccName</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> 
<a name="line-15"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLocalId</span> <span class='hs-varid'>name</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="newEq"></a><span class='hs-definition'>newEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>EvVar</span>
<a name="line-18"></a><span class='hs-definition'>newEq</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-19"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newName</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarOccFS</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"cobox"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-20"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLocalId</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkEqPred</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="newIP"></a><span class='hs-definition'>newIP</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IPName</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>IpId</span>
<a name="line-23"></a><span class='hs-definition'>newIP</span> <span class='hs-varid'>ip</span> <span class='hs-varid'>ty</span>
<a name="line-24"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 	<span class='hs-layout'>{</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newName</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarOccFS</span> <span class='hs-layout'>(</span><span class='hs-varid'>ipFastString</span> <span class='hs-varid'>ip</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-25"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLocalId</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkIPPred</span> <span class='hs-varid'>ip</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="newDict"></a><span class='hs-definition'>newDict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>DictId</span>
<a name="line-28"></a><span class='hs-definition'>newDict</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> 
<a name="line-29"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newName</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkDictOcc</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-30"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLocalId</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkClassPred</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-31"></a>
<a name="line-32"></a><a name="predTypeOccName"></a><span class='hs-definition'>predTypeOccName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OccName</span>
<a name="line-33"></a><span class='hs-definition'>predTypeOccName</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>classifyPredType</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-34"></a>    <span class='hs-conid'>ClassPred</span> <span class='hs-varid'>cls</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkDictOcc</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span>
<a name="line-35"></a>    <span class='hs-conid'>IPPred</span> <span class='hs-varid'>ip</span> <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkVarOccFS</span> <span class='hs-layout'>(</span><span class='hs-varid'>ipFastString</span> <span class='hs-varid'>ip</span><span class='hs-layout'>)</span>
<a name="line-36"></a>    <span class='hs-conid'>EqPred</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkVarOccFS</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"cobox"</span><span class='hs-layout'>)</span>
<a name="line-37"></a>    <span class='hs-conid'>TuplePred</span> <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkVarOccFS</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"tup"</span><span class='hs-layout'>)</span>
<a name="line-38"></a>    <span class='hs-conid'>IrredPred</span> <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkVarOccFS</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"irred"</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*									*
	SkolemTvs (immutable)
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="tcInstType"></a><span class='hs-definition'>tcInstType</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> 		<span class='hs-comment'>-- How to instantiate the type variables</span>
<a name="line-2"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> 					<span class='hs-comment'>-- Type to instantiate</span>
<a name="line-3"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcThetaType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>	<span class='hs-comment'>-- Result</span>
<a name="line-4"></a>		<span class='hs-comment'>-- (type vars (excl coercion vars), preds (incl equalities), rho)</span>
<a name="line-5"></a><span class='hs-definition'>tcInstType</span> <span class='hs-varid'>inst_tyvars</span> <span class='hs-varid'>ty</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcSplitForAllTys</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-7"></a>	<span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span>     <span class='hs-varid'>rho</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>let</span>	<span class='hs-comment'>-- There may be overloading despite no type variables;</span>
<a name="line-8"></a>				<span class='hs-comment'>-- 	(?x :: Int) =&gt; Int -&gt; Int</span>
<a name="line-9"></a>			   <span class='hs-layout'>(</span><span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitPhiTy</span> <span class='hs-varid'>rho</span>
<a name="line-10"></a>			 <span class='hs-keyword'>in</span>
<a name="line-11"></a>			 <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span>
<a name="line-12"></a>
<a name="line-13"></a>	<span class='hs-layout'>(</span><span class='hs-varid'>tyvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tyvars'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>inst_tyvars</span> <span class='hs-varid'>tyvars</span>
<a name="line-14"></a>
<a name="line-15"></a>			    <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span>  <span class='hs-varid'>tenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipTopTvSubst</span> <span class='hs-varid'>tyvars</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>tyvars'</span><span class='hs-layout'>)</span>
<a name="line-16"></a>				<span class='hs-comment'>-- Either the tyvars are freshly made, by inst_tyvars,</span>
<a name="line-17"></a>                                <span class='hs-comment'>-- or any nested foralls have different binders.</span>
<a name="line-18"></a>                                <span class='hs-comment'>-- Either way, zipTopTvSubst is ok</span>
<a name="line-19"></a>
<a name="line-20"></a>			    <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span>  <span class='hs-layout'>(</span><span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitPhiTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span>
<a name="line-21"></a>			    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyvars'</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="tcSkolDFunType"></a><span class='hs-definition'>tcSkolDFunType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcThetaType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>
<a name="line-24"></a><span class='hs-comment'>-- Instantiate a type signature with skolem constants, but </span>
<a name="line-25"></a><span class='hs-comment'>-- do *not* give them fresh names, because we want the name to</span>
<a name="line-26"></a><span class='hs-comment'>-- be in the type environment: it is lexically scoped.</span>
<a name="line-27"></a><span class='hs-definition'>tcSkolDFunType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcInstType</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcSuperSkolTyVars</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="tcSuperSkolTyVars"></a><span class='hs-definition'>tcSuperSkolTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-30"></a><span class='hs-comment'>-- Make skolem constants, but do *not* give them new names, as above</span>
<a name="line-31"></a><span class='hs-comment'>-- Moreover, make them "super skolems"; see comments with superSkolemTv</span>
<a name="line-32"></a><span class='hs-comment'>-- see Note [Kind substitution when instantiating]</span>
<a name="line-33"></a><span class='hs-comment'>-- Precondition: tyvars should be ordered (kind vars first)</span>
<a name="line-34"></a><span class='hs-definition'>tcSuperSkolTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>.</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>tcSuperSkolTyVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTopTvSubst</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-35"></a>
<a name="line-36"></a><a name="tcSuperSkolTyVar"></a><span class='hs-definition'>tcSuperSkolTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span>
<a name="line-37"></a><span class='hs-definition'>tcSuperSkolTyVar</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span>
<a name="line-38"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendTvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>new_tv</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_tv</span><span class='hs-layout'>)</span>
<a name="line-39"></a>  <span class='hs-keyword'>where</span>
<a name="line-40"></a>    <span class='hs-varid'>kind</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-41"></a>    <span class='hs-varid'>new_tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcTyVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarName</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>superSkolemTv</span>
<a name="line-42"></a>
<a name="line-43"></a><a name="tcInstSkolTyVar"></a><span class='hs-definition'>tcInstSkolTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span>
<a name="line-44"></a><span class='hs-comment'>-- Instantiate the tyvar, using </span>
<a name="line-45"></a><span class='hs-comment'>--      * the occ-name and kind of the supplied tyvar, </span>
<a name="line-46"></a><span class='hs-comment'>--      * the unique from the monad,</span>
<a name="line-47"></a><span class='hs-comment'>--      * the location either from the tyvar (skol_info = SigSkol)</span>
<a name="line-48"></a><span class='hs-comment'>--                     or from the monad (otherwise)</span>
<a name="line-49"></a><span class='hs-definition'>tcInstSkolTyVar</span> <span class='hs-varid'>overlappable</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tyvar</span>
<a name="line-50"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUnique</span>
<a name="line-51"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>loc</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-52"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>new_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInternalName</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>loc</span>
<a name="line-53"></a>              <span class='hs-varid'>new_tv</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcTyVar</span> <span class='hs-varid'>new_name</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>SkolemTv</span> <span class='hs-varid'>overlappable</span><span class='hs-layout'>)</span>
<a name="line-54"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendTvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tyvar</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>new_tv</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_tv</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-55"></a>  <span class='hs-keyword'>where</span>
<a name="line-56"></a>    <span class='hs-varid'>old_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarName</span> <span class='hs-varid'>tyvar</span>
<a name="line-57"></a>    <span class='hs-varid'>occ</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameOccName</span> <span class='hs-varid'>old_name</span>
<a name="line-58"></a>    <span class='hs-varid'>kind</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>)</span>
<a name="line-59"></a>
<a name="line-60"></a><a name="tcInstSkolTyVars'"></a><span class='hs-definition'>tcInstSkolTyVars'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-61"></a><span class='hs-comment'>-- Precondition: tyvars should be ordered (kind vars first)</span>
<a name="line-62"></a><span class='hs-comment'>-- see Note [Kind substitution when instantiating]</span>
<a name="line-63"></a><span class='hs-definition'>tcInstSkolTyVars'</span> <span class='hs-varid'>isSuperSkol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumLM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcInstSkolTyVar</span> <span class='hs-varid'>isSuperSkol</span><span class='hs-layout'>)</span>
<a name="line-64"></a>
<a name="line-65"></a><a name="tcInstSkolTyVars"></a><span class='hs-comment'>-- Wrappers</span>
<a name="line-66"></a><span class='hs-definition'>tcInstSkolTyVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcInstSuperSkolTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-67"></a><span class='hs-definition'>tcInstSkolTyVars</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tcInstSkolTyVars'</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTopTvSubst</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-68"></a><a name="tcInstSuperSkolTyVars"></a><span class='hs-definition'>tcInstSuperSkolTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tcInstSkolTyVars'</span> <span class='hs-conid'>True</span>  <span class='hs-layout'>(</span><span class='hs-varid'>mkTopTvSubst</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-69"></a>
<a name="line-70"></a><a name="tcInstSkolTyVarsX"></a><span class='hs-definition'>tcInstSkolTyVarsX</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcInstSuperSkolTyVarsX</span>
<a name="line-71"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-72"></a><span class='hs-definition'>tcInstSkolTyVarsX</span>      <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcInstSkolTyVars'</span> <span class='hs-conid'>False</span> <span class='hs-varid'>subst</span>
<a name="line-73"></a><a name="tcInstSuperSkolTyVarsX"></a><span class='hs-definition'>tcInstSuperSkolTyVarsX</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcInstSkolTyVars'</span> <span class='hs-conid'>True</span>  <span class='hs-varid'>subst</span>
<a name="line-74"></a>
<a name="line-75"></a><a name="tcInstSkolType"></a><span class='hs-definition'>tcInstSkolType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcThetaType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>
<a name="line-76"></a><span class='hs-comment'>-- Instantiate a type with fresh skolem constants</span>
<a name="line-77"></a><span class='hs-comment'>-- Binding location comes from the monad</span>
<a name="line-78"></a><span class='hs-definition'>tcInstSkolType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcInstType</span> <span class='hs-varid'>tcInstSkolTyVars</span> <span class='hs-varid'>ty</span>
<a name="line-79"></a>
<a name="line-80"></a><a name="tcInstSigTyVars"></a><span class='hs-definition'>tcInstSigTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-81"></a><span class='hs-comment'>-- Make meta SigTv type variables for patten-bound scoped type varaibles</span>
<a name="line-82"></a><span class='hs-comment'>-- We use SigTvs for them, so that they can't unify with arbitrary types</span>
<a name="line-83"></a><span class='hs-comment'>-- Precondition: tyvars should be ordered (kind vars first)</span>
<a name="line-84"></a><span class='hs-comment'>-- see Note [Kind substitution when instantiating]</span>
<a name="line-85"></a><span class='hs-definition'>tcInstSigTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>.</span> <span class='hs-varid'>mapAccumLM</span> <span class='hs-varid'>tcInstSigTyVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTopTvSubst</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-86"></a>
<a name="line-87"></a><a name="tcInstSigTyVar"></a><span class='hs-definition'>tcInstSigTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span>
<a name="line-88"></a><span class='hs-definition'>tcInstSigTyVar</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span>
<a name="line-89"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaUnique</span>
<a name="line-90"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMutVar</span> <span class='hs-conid'>Flexi</span>
<a name="line-91"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setNameUnique</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarName</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>uniq</span>
<a name="line-92"></a>                      <span class='hs-comment'>-- Use the same OccName so that the tidy-er</span>
<a name="line-93"></a>                      <span class='hs-comment'>-- doesn't rename 'a' to 'a0' etc</span>
<a name="line-94"></a>             <span class='hs-varid'>kind</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-95"></a>             <span class='hs-varid'>new_tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcTyVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>MetaTv</span> <span class='hs-conid'>SigTv</span> <span class='hs-varid'>ref</span><span class='hs-layout'>)</span>
<a name="line-96"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendTvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>new_tv</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_tv</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}

Note [Kind substitution when instantiating]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we instantiate a bunch of kind and type variables, first we
expect them to be sorted (kind variables first, then type variables).
Then we have to instantiate the kind variables, build a substitution
from old variables to the new variables, then instantiate the type
variables substituting the original kind.

Exemple: If we want to instantiate
  [(k1 :: BOX), (k2 :: BOX), (a :: k1 -> k2), (b :: k1)]
we want
  [(?k1 :: BOX), (?k2 :: BOX), (?a :: ?k1 -> ?k2), (?b :: ?k1)]
instead of the buggous
  [(?k1 :: BOX), (?k2 :: BOX), (?a :: k1 -> k2), (?b :: k1)]


%************************************************************************
%*									*
	MetaTvs (meta type variables; mutable)
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="newMetaTyVar"></a><span class='hs-definition'>newMetaTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MetaInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyVar</span>
<a name="line-2"></a><span class='hs-comment'>-- Make a new meta tyvar out of thin air</span>
<a name="line-3"></a><span class='hs-definition'>newMetaTyVar</span> <span class='hs-varid'>meta_info</span> <span class='hs-varid'>kind</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaUnique</span>
<a name="line-5"></a> 	<span class='hs-layout'>;</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMutVar</span> <span class='hs-conid'>Flexi</span>
<a name="line-6"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcTyVarName</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>s</span>
<a name="line-7"></a>              <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>meta_info</span> <span class='hs-keyword'>of</span>
<a name="line-8"></a>                        <span class='hs-conid'>TauTv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fsLit</span> <span class='hs-str'>"t"</span>
<a name="line-9"></a>                        <span class='hs-conid'>TcsTv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fsLit</span> <span class='hs-str'>"u"</span>
<a name="line-10"></a>                        <span class='hs-conid'>SigTv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fsLit</span> <span class='hs-str'>"a"</span>
<a name="line-11"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcTyVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>MetaTv</span> <span class='hs-varid'>meta_info</span> <span class='hs-varid'>ref</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="mkTcTyVarName"></a><span class='hs-definition'>mkTcTyVarName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FastString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>
<a name="line-14"></a><span class='hs-comment'>-- Make sure that fresh TcTyVar names finish with a digit</span>
<a name="line-15"></a><span class='hs-comment'>-- leaving the un-cluttered names free for user names</span>
<a name="line-16"></a><span class='hs-definition'>mkTcTyVarName</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSysTvName</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>str</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="readMetaTyVar"></a><span class='hs-comment'>-- Works for both type and kind variables</span>
<a name="line-19"></a><span class='hs-definition'>readMetaTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>MetaDetails</span>
<a name="line-20"></a><span class='hs-definition'>readMetaTyVar</span> <span class='hs-varid'>tyvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tyvar</span> <span class='hs-layout'>)</span>
<a name="line-21"></a>		      <span class='hs-varid'>readMutVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>metaTvRef</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>)</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="isFilledMetaTyVar"></a><span class='hs-definition'>isFilledMetaTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Bool</span>
<a name="line-24"></a><span class='hs-comment'>-- True of a filled-in (Indirect) meta type variable</span>
<a name="line-25"></a><span class='hs-definition'>isFilledMetaTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-26"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>
<a name="line-27"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>MetaTv</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 	<span class='hs-layout'>{</span> <span class='hs-varid'>details</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMutVar</span> <span class='hs-varid'>ref</span>
<a name="line-29"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>isIndirect</span> <span class='hs-varid'>details</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-30"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>
<a name="line-31"></a>
<a name="line-32"></a><a name="isFlexiMetaTyVar"></a><span class='hs-definition'>isFlexiMetaTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Bool</span>
<a name="line-33"></a><span class='hs-comment'>-- True of a un-filled-in (Flexi) meta type variable</span>
<a name="line-34"></a><span class='hs-definition'>isFlexiMetaTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-35"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>
<a name="line-36"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>MetaTv</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span>
<a name="line-37"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 	<span class='hs-layout'>{</span> <span class='hs-varid'>details</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMutVar</span> <span class='hs-varid'>ref</span>
<a name="line-38"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>isFlexi</span> <span class='hs-varid'>details</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-39"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>
<a name="line-40"></a>
<a name="line-41"></a><a name="writeMetaTyVar"></a><span class='hs-comment'>--------------------</span>
<a name="line-42"></a><span class='hs-comment'>-- Works with both type and kind variables</span>
<a name="line-43"></a><span class='hs-definition'>writeMetaTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-44"></a><span class='hs-comment'>-- Write into a currently-empty MetaTyVar</span>
<a name="line-45"></a>
<a name="line-46"></a><span class='hs-definition'>writeMetaTyVar</span> <span class='hs-varid'>tyvar</span> <span class='hs-varid'>ty</span>
<a name="line-47"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>debugIsOn</span> 
<a name="line-48"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>writeMetaTyVarRef</span> <span class='hs-varid'>tyvar</span> <span class='hs-layout'>(</span><span class='hs-varid'>metaTvRef</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-49"></a>
<a name="line-50"></a><span class='hs-comment'>-- Everything from here on only happens if DEBUG is on</span>
<a name="line-51"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>)</span>
<a name="line-52"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Writing to non-tc tyvar"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tyvar</span> <span class='hs-layout'>)</span>
<a name="line-53"></a>    <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-54"></a>
<a name="line-55"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>MetaTv</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tyvar</span>
<a name="line-56"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>writeMetaTyVarRef</span> <span class='hs-varid'>tyvar</span> <span class='hs-varid'>ref</span> <span class='hs-varid'>ty</span>
<a name="line-57"></a>
<a name="line-58"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-59"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Writing to non-meta tyvar"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tyvar</span> <span class='hs-layout'>)</span>
<a name="line-60"></a>    <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-61"></a>
<a name="line-62"></a><a name="writeMetaTyVarRef"></a><span class='hs-comment'>--------------------</span>
<a name="line-63"></a><span class='hs-definition'>writeMetaTyVarRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>MetaDetails</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-64"></a><span class='hs-comment'>-- Here the tyvar is for error checking only; </span>
<a name="line-65"></a><span class='hs-comment'>-- the ref cell must be for the same tyvar</span>
<a name="line-66"></a><span class='hs-definition'>writeMetaTyVarRef</span> <span class='hs-varid'>tyvar</span> <span class='hs-varid'>ref</span> <span class='hs-varid'>ty</span>
<a name="line-67"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>debugIsOn</span> 
<a name="line-68"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"writeMetaTyVar"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tyvar</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>":="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-69"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>writeMutVar</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>(</span><span class='hs-conid'>Indirect</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-70"></a>
<a name="line-71"></a><span class='hs-comment'>-- Everything from here on only happens if DEBUG is on</span>
<a name="line-72"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-73"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>meta_details</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMutVar</span> <span class='hs-varid'>ref</span><span class='hs-layout'>;</span> 
<a name="line-74"></a>       <span class='hs-comment'>-- Zonk kinds to allow the error check to work</span>
<a name="line-75"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>zonked_tv_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-varid'>tv_kind</span> 
<a name="line-76"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>zonked_ty_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-varid'>ty_kind</span>
<a name="line-77"></a>
<a name="line-78"></a>       <span class='hs-comment'>-- Check for double updates</span>
<a name="line-79"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isFlexi</span> <span class='hs-varid'>meta_details</span><span class='hs-layout'>,</span> 
<a name="line-80"></a>                  <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Double update of meta tyvar"</span><span class='hs-layout'>)</span>
<a name="line-81"></a>                   <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tyvar</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>meta_details</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-82"></a>
<a name="line-83"></a>         <span class='hs-varid'>traceTc</span> <span class='hs-str'>"writeMetaTyVar"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tyvar</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>":="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-84"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>writeMutVar</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>(</span><span class='hs-conid'>Indirect</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> 
<a name="line-85"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span>   <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isPredTy</span> <span class='hs-varid'>tv_kind</span><span class='hs-layout'>)</span> 
<a name="line-86"></a>                    <span class='hs-comment'>-- Don't check kinds for updates to coercion variables</span>
<a name="line-87"></a>               <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonked_ty_kind</span> <span class='hs-varop'>`isSubKind`</span> <span class='hs-varid'>zonked_tv_kind</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-88"></a>       <span class='hs-varop'>$</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Ill-kinded update to meta tyvar"</span><span class='hs-layout'>)</span>
<a name="line-89"></a>                        <span class='hs-num'>2</span> <span class='hs-layout'>(</span>    <span class='hs-varid'>ppr</span> <span class='hs-varid'>tyvar</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"::"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv_kind</span> 
<a name="line-90"></a>                           <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>":="</span> 
<a name="line-91"></a>                           <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span>    <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"::"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty_kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-92"></a>         <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-93"></a>  <span class='hs-keyword'>where</span>
<a name="line-94"></a>    <span class='hs-varid'>tv_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tyvar</span>
<a name="line-95"></a>    <span class='hs-varid'>ty_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty</span>
</pre>\end{code}


%************************************************************************
%*									*
	MetaTvs: TauTvs
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="newFlexiTyVar"></a><span class='hs-definition'>newFlexiTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyVar</span>
<a name="line-2"></a><span class='hs-definition'>newFlexiTyVar</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newMetaTyVar</span> <span class='hs-conid'>TauTv</span> <span class='hs-varid'>kind</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="newFlexiTyVarTy"></a><span class='hs-definition'>newFlexiTyVarTy</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-5"></a><span class='hs-definition'>newFlexiTyVarTy</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-6"></a>    <span class='hs-varid'>tc_tyvar</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVar</span> <span class='hs-varid'>kind</span>
<a name="line-7"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tc_tyvar</span><span class='hs-layout'>)</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="newFlexiTyVarTys"></a><span class='hs-definition'>newFlexiTyVarTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span>
<a name="line-10"></a><span class='hs-definition'>newFlexiTyVarTys</span> <span class='hs-varid'>n</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>nOfThem</span> <span class='hs-varid'>n</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="tcInstTyVars"></a><span class='hs-definition'>tcInstTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TvSubst</span><span class='hs-layout'>)</span>
<a name="line-13"></a><span class='hs-comment'>-- Instantiate with META type variables</span>
<a name="line-14"></a><span class='hs-definition'>tcInstTyVars</span> <span class='hs-varid'>tyvars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcInstTyVarsX</span> <span class='hs-varid'>emptyTvSubst</span> <span class='hs-varid'>tyvars</span>
<a name="line-15"></a>    <span class='hs-comment'>-- emptyTvSubst has an empty in-scope set, but that's fine here</span>
<a name="line-16"></a>    <span class='hs-comment'>-- Since the tyvars are freshly made, they cannot possibly be</span>
<a name="line-17"></a>    <span class='hs-comment'>-- captured by any existing for-alls.</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="tcInstTyVarsX"></a><span class='hs-definition'>tcInstTyVarsX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TvSubst</span><span class='hs-layout'>)</span>
<a name="line-20"></a><span class='hs-definition'>tcInstTyVarsX</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tyvars</span> <span class='hs-keyglyph'>=</span>
<a name="line-21"></a>  <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyvars'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAccumLM</span> <span class='hs-varid'>tcInstTyVar</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tyvars</span>
<a name="line-22"></a>     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyvars'</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>tyvars'</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-23"></a>
<a name="line-24"></a><a name="tcInstTyVar"></a><span class='hs-definition'>tcInstTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span>
<a name="line-25"></a><span class='hs-comment'>-- Make a new unification variable tyvar whose Name and Kind come from</span>
<a name="line-26"></a><span class='hs-comment'>-- an existing TyVar. We substitute kind variables in the kind.</span>
<a name="line-27"></a><span class='hs-definition'>tcInstTyVar</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tyvar</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaUnique</span>
<a name="line-29"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMutVar</span> <span class='hs-conid'>Flexi</span>
<a name="line-30"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSystemName</span> <span class='hs-varid'>uniq</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>)</span>
<a name="line-31"></a>              <span class='hs-varid'>kind</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>)</span>
<a name="line-32"></a>              <span class='hs-varid'>new_tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcTyVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>MetaTv</span> <span class='hs-conid'>TauTv</span> <span class='hs-varid'>ref</span><span class='hs-layout'>)</span>
<a name="line-33"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendTvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tyvar</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>new_tv</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_tv</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}


%************************************************************************
%*									*
	MetaTvs: SigTvs
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="zonkSigTyVar"></a><span class='hs-definition'>zonkSigTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyVar</span>
<a name="line-2"></a><span class='hs-definition'>zonkSigTyVar</span> <span class='hs-varid'>sig_tv</span> 
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isSkolemTyVar</span> <span class='hs-varid'>sig_tv</span> 
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>sig_tv</span>	<span class='hs-comment'>-- Happens in the call in TcBinds.checkDistinctTyVars</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isSigTyVar</span> <span class='hs-varid'>sig_tv</span> <span class='hs-layout'>)</span>
<a name="line-7"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTyVar</span> <span class='hs-varid'>sig_tv</span>
<a name="line-8"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcGetTyVar</span> <span class='hs-str'>"zonkSigTyVar"</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-9"></a>	<span class='hs-comment'>-- 'ty' is bound to be a type variable, because SigTvs</span>
<a name="line-10"></a>	<span class='hs-comment'>-- can only be unified with type variables</span>
</pre>\end{code}



%************************************************************************
%*									*
\subsection{Zonking -- the exernal interfaces}
%*									*
%************************************************************************

@tcGetGlobalTyVars@ returns a fully-zonked set of tyvars free in the environment.
To improve subsequent calls to the same function it writes the zonked set back into
the environment.

\begin{code}
<pre><a name="line-1"></a><a name="tcGetGlobalTyVars"></a><span class='hs-definition'>tcGetGlobalTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyVarSet</span>
<a name="line-2"></a><span class='hs-definition'>tcGetGlobalTyVars</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcLclEnv</span> <span class='hs-layout'>{</span><span class='hs-varid'>tcl_tyvars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gtv_var</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLclEnv</span>
<a name="line-4"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>gbl_tvs</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMutVar</span> <span class='hs-varid'>gtv_var</span>
<a name="line-5"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>gbl_tvs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTyVarsAndFV</span> <span class='hs-varid'>gbl_tvs</span>
<a name="line-6"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>writeMutVar</span> <span class='hs-varid'>gtv_var</span> <span class='hs-varid'>gbl_tvs'</span>
<a name="line-7"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>gbl_tvs'</span> <span class='hs-layout'>}</span>
</pre>\end{code}

-----------------  Type variables

\begin{code}
<pre><a name="line-1"></a><a name="zonkTcTyVars"></a><span class='hs-definition'>zonkTcTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-definition'>zonkTcTyVars</span> <span class='hs-varid'>tyvars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTcTyVar</span> <span class='hs-varid'>tyvars</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="zonkTcTyVarsAndFV"></a><span class='hs-definition'>zonkTcTyVarsAndFV</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyVarSet</span>
<a name="line-5"></a><span class='hs-definition'>zonkTcTyVarsAndFV</span> <span class='hs-varid'>tyvars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarsOfTypes</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTcTyVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>varSetElems</span> <span class='hs-varid'>tyvars</span><span class='hs-layout'>)</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="zonkTcTypeCarefully"></a><span class='hs-comment'>-----------------  Types</span>
<a name="line-8"></a><span class='hs-definition'>zonkTcTypeCarefully</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-9"></a><span class='hs-comment'>-- Do not zonk type variables free in the environment</span>
<a name="line-10"></a><span class='hs-definition'>zonkTcTypeCarefully</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>ty</span>   <span class='hs-comment'>-- I think this function is out of date</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-comment'>{-
<a name="line-13"></a>  = do { env_tvs &lt;- tcGetGlobalTyVars
<a name="line-14"></a>       ; zonkType (zonk_tv env_tvs) ty }
<a name="line-15"></a>  where
<a name="line-16"></a>    zonk_tv env_tvs tv
<a name="line-17"></a>      | tv `elemVarSet` env_tvs 
<a name="line-18"></a>      = return (TyVarTy tv)
<a name="line-19"></a>      | otherwise
<a name="line-20"></a>      = ASSERT( isTcTyVar tv )
<a name="line-21"></a>    	case tcTyVarDetails tv of
<a name="line-22"></a>          SkolemTv {}   -&gt; return (TyVarTy tv)
<a name="line-23"></a>          RuntimeUnk {} -&gt; return (TyVarTy tv)
<a name="line-24"></a>          FlatSkol ty   -&gt; zonkType (zonk_tv env_tvs) ty
<a name="line-25"></a>          MetaTv _ ref  -&gt; do { cts &lt;- readMutVar ref
<a name="line-26"></a>                              ; case cts of
<a name="line-27"></a>			           Flexi       -&gt; return (TyVarTy tv)
<a name="line-28"></a>			           Indirect ty -&gt; zonkType (zonk_tv env_tvs) ty }
<a name="line-29"></a>-}</span>
<a name="line-30"></a>
<a name="line-31"></a><a name="zonkTcType"></a><span class='hs-definition'>zonkTcType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-32"></a><span class='hs-comment'>-- Simply look through all Flexis</span>
<a name="line-33"></a><span class='hs-definition'>zonkTcType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zonkType</span> <span class='hs-varid'>zonkTcTyVar</span> <span class='hs-varid'>ty</span>
<a name="line-34"></a>
<a name="line-35"></a><a name="zonkTcTyVar"></a><span class='hs-definition'>zonkTcTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-36"></a><span class='hs-comment'>-- Simply look through all Flexis</span>
<a name="line-37"></a><span class='hs-definition'>zonkTcTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-38"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span> <span class='hs-keyword'>do</span>
<a name="line-39"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-40"></a>      <span class='hs-conid'>SkolemTv</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>zonk_kind_and_return</span>
<a name="line-41"></a>      <span class='hs-conid'>RuntimeUnk</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>zonk_kind_and_return</span>
<a name="line-42"></a>      <span class='hs-conid'>FlatSkol</span> <span class='hs-varid'>ty</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>ty</span>
<a name="line-43"></a>      <span class='hs-conid'>MetaTv</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ref</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMutVar</span> <span class='hs-varid'>ref</span>
<a name="line-44"></a>                          <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cts</span> <span class='hs-keyword'>of</span>
<a name="line-45"></a>		               <span class='hs-conid'>Flexi</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>zonk_kind_and_return</span>
<a name="line-46"></a>			       <span class='hs-conid'>Indirect</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-47"></a>  <span class='hs-keyword'>where</span>
<a name="line-48"></a>    <span class='hs-varid'>zonk_kind_and_return</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>z_tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTyVarKind</span> <span class='hs-varid'>tv</span>
<a name="line-49"></a>                              <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>z_tv</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-50"></a>
<a name="line-51"></a><a name="zonkTyVarKind"></a><span class='hs-definition'>zonkTyVarKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TyVar</span>
<a name="line-52"></a><span class='hs-definition'>zonkTyVarKind</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-53"></a>                      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>setTyVarKind</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>kind'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-54"></a>
<a name="line-55"></a><a name="zonkTcTypeAndSubst"></a><span class='hs-definition'>zonkTcTypeAndSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-56"></a><span class='hs-comment'>-- Zonk, and simultaneously apply a non-necessarily-idempotent substitution</span>
<a name="line-57"></a><span class='hs-definition'>zonkTcTypeAndSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zonkType</span> <span class='hs-varid'>zonk_tv</span> <span class='hs-varid'>ty</span>
<a name="line-58"></a>  <span class='hs-keyword'>where</span>
<a name="line-59"></a>    <span class='hs-varid'>zonk_tv</span> <span class='hs-varid'>tv</span>
<a name="line-60"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>z_tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>updateTyVarKindM</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-varid'>tv</span>
<a name="line-61"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-62"></a>                <span class='hs-conid'>SkolemTv</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>z_tv</span><span class='hs-layout'>)</span>
<a name="line-63"></a>                <span class='hs-conid'>RuntimeUnk</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>z_tv</span><span class='hs-layout'>)</span>
<a name="line-64"></a>                <span class='hs-conid'>FlatSkol</span> <span class='hs-varid'>ty</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>zonkType</span> <span class='hs-varid'>zonk_tv</span> <span class='hs-varid'>ty</span>
<a name="line-65"></a>                <span class='hs-conid'>MetaTv</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ref</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMutVar</span> <span class='hs-varid'>ref</span>
<a name="line-66"></a>                                    <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cts</span> <span class='hs-keyword'>of</span>
<a name="line-67"></a>      			           <span class='hs-conid'>Flexi</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>zonk_flexi</span> <span class='hs-varid'>z_tv</span>
<a name="line-68"></a>      			           <span class='hs-conid'>Indirect</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>zonkType</span> <span class='hs-varid'>zonk_tv</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-69"></a>    <span class='hs-varid'>zonk_flexi</span> <span class='hs-varid'>tv</span>
<a name="line-70"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupTyVar</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-71"></a>          <span class='hs-conid'>Just</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>zonkType</span> <span class='hs-varid'>zonk_tv</span> <span class='hs-varid'>ty</span>
<a name="line-72"></a>          <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-73"></a>
<a name="line-74"></a><a name="zonkTcTypes"></a><span class='hs-definition'>zonkTcTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span>
<a name="line-75"></a><span class='hs-definition'>zonkTcTypes</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>tys</span>
<a name="line-76"></a>
<a name="line-77"></a><a name="zonkTcThetaType"></a><span class='hs-definition'>zonkTcThetaType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcThetaType</span>
<a name="line-78"></a><span class='hs-definition'>zonkTcThetaType</span> <span class='hs-varid'>theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTcPredType</span> <span class='hs-varid'>theta</span>
<a name="line-79"></a>
<a name="line-80"></a><a name="zonkTcPredType"></a><span class='hs-definition'>zonkTcPredType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcPredType</span>
<a name="line-81"></a><span class='hs-definition'>zonkTcPredType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zonkTcType</span>
</pre>\end{code}

-------------------  These ...ToType, ...ToKind versions
		     are used at the end of type checking

\begin{code}
<pre><a name="line-1"></a><a name="defaultKindVarToStar"></a><span class='hs-definition'>defaultKindVarToStar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Kind</span>
<a name="line-2"></a><span class='hs-comment'>-- We have a meta-kind: unify it with '*'</span>
<a name="line-3"></a><span class='hs-definition'>defaultKindVarToStar</span> <span class='hs-varid'>kv</span> 
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-conid'>ASSERT</span> <span class='hs-layout'>(</span> <span class='hs-varid'>isKiVar</span> <span class='hs-varid'>kv</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>kv</span> <span class='hs-layout'>)</span>
<a name="line-5"></a>         <span class='hs-varid'>writeMetaTyVar</span> <span class='hs-varid'>kv</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-6"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-layout'>}</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="zonkQuantifiedTyVars"></a><span class='hs-definition'>zonkQuantifiedTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-9"></a><span class='hs-comment'>-- Precondition: a kind variable occurs before a type</span>
<a name="line-10"></a><span class='hs-comment'>--               variable mentioning it in its kind</span>
<a name="line-11"></a><span class='hs-definition'>zonkQuantifiedTyVars</span> <span class='hs-varid'>tyvars</span>
<a name="line-12"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionKiTyVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>varSetElems</span> <span class='hs-varid'>tyvars</span><span class='hs-layout'>)</span>
<a name="line-13"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>poly_kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_PolyKinds</span>
<a name="line-14"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>poly_kinds</span> <span class='hs-keyword'>then</span>
<a name="line-15"></a>             <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkQuantifiedTyVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>kvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-16"></a>           <span class='hs-comment'>-- Because of the order, any kind variables</span>
<a name="line-17"></a>           <span class='hs-comment'>-- mentioned in the kinds of the type variables refer to</span>
<a name="line-18"></a>           <span class='hs-comment'>-- the now-quantified versions</span>
<a name="line-19"></a>         <span class='hs-keyword'>else</span>
<a name="line-20"></a>             <span class='hs-comment'>-- In the non-PolyKinds case, default the kind variables</span>
<a name="line-21"></a>             <span class='hs-comment'>-- to *, and zonk the tyvars as usual.  Notice that this</span>
<a name="line-22"></a>             <span class='hs-comment'>-- may make zonkQuantifiedTyVars return a shorter list</span>
<a name="line-23"></a>             <span class='hs-comment'>-- than it was passed, but that's ok</span>
<a name="line-24"></a>             <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>meta_kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>skolem_kvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>kvs</span>
<a name="line-25"></a>                <span class='hs-layout'>;</span> <span class='hs-conid'>WARN</span> <span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>skolem_kvs</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>skolem_kvs</span> <span class='hs-layout'>)</span>
<a name="line-26"></a>                  <span class='hs-varid'>mapM_</span> <span class='hs-varid'>defaultKindVarToStar</span> <span class='hs-varid'>meta_kvs</span>
<a name="line-27"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkQuantifiedTyVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>skolem_kvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="zonkQuantifiedTyVar"></a><span class='hs-definition'>zonkQuantifiedTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyVar</span>
<a name="line-30"></a><span class='hs-comment'>-- The quantified type variables often include meta type variables</span>
<a name="line-31"></a><span class='hs-comment'>-- we want to freeze them into ordinary type variables, and</span>
<a name="line-32"></a><span class='hs-comment'>-- default their kind (e.g. from OpenTypeKind to TypeKind)</span>
<a name="line-33"></a><span class='hs-comment'>-- 			-- see notes with Kind.defaultKind</span>
<a name="line-34"></a><span class='hs-comment'>-- The meta tyvar is updated to point to the new skolem TyVar.  Now any </span>
<a name="line-35"></a><span class='hs-comment'>-- bound occurences of the original type variable will get zonked to </span>
<a name="line-36"></a><span class='hs-comment'>-- the immutable version.</span>
<a name="line-37"></a><span class='hs-comment'>--</span>
<a name="line-38"></a><span class='hs-comment'>-- We leave skolem TyVars alone; they are immutable.</span>
<a name="line-39"></a><span class='hs-comment'>--</span>
<a name="line-40"></a><span class='hs-comment'>-- This function is called on both kind and type variables,</span>
<a name="line-41"></a><span class='hs-comment'>-- but kind variables *only* if PolyKinds is on.</span>
<a name="line-42"></a><span class='hs-definition'>zonkQuantifiedTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-43"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span> 
<a name="line-44"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-45"></a>      <span class='hs-conid'>SkolemTv</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-46"></a>                        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>setTyVarKind</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>}</span>
<a name="line-47"></a>	<span class='hs-comment'>-- It might be a skolem type variable, </span>
<a name="line-48"></a>	<span class='hs-comment'>-- for example from a user type signature</span>
<a name="line-49"></a>
<a name="line-50"></a>      <span class='hs-conid'>MetaTv</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-51"></a>          <span class='hs-keyword'>do</span> <span class='hs-varid'>when</span> <span class='hs-varid'>debugIsOn</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-52"></a>                 <span class='hs-comment'>-- [Sept 04] Check for non-empty.</span>
<a name="line-53"></a>                 <span class='hs-comment'>-- See note [Silly Type Synonym]</span>
<a name="line-54"></a>                 <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readMutVar</span> <span class='hs-varid'>ref</span>
<a name="line-55"></a>                 <span class='hs-keyword'>case</span> <span class='hs-varid'>cts</span> <span class='hs-keyword'>of</span>
<a name="line-56"></a>                     <span class='hs-conid'>Flexi</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-57"></a>                     <span class='hs-conid'>Indirect</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>)</span>
<a name="line-58"></a>                                    <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-59"></a>             <span class='hs-varid'>skolemiseUnboundMetaTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vanillaSkolemTv</span>
<a name="line-60"></a>      <span class='hs-sel'>_other</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"zonkQuantifiedTyVar"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- FlatSkol, RuntimeUnk</span>
<a name="line-61"></a>
<a name="line-62"></a><a name="skolemiseUnboundMetaTyVar"></a><span class='hs-definition'>skolemiseUnboundMetaTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVarDetails</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TyVar</span>
<a name="line-63"></a><span class='hs-comment'>-- We have a Meta tyvar with a ref-cell inside it</span>
<a name="line-64"></a><span class='hs-comment'>-- Skolemise it, including giving it a new Name, so that</span>
<a name="line-65"></a><span class='hs-comment'>--   we are totally out of Meta-tyvar-land</span>
<a name="line-66"></a><span class='hs-comment'>-- We create a skolem TyVar, not a regular TyVar</span>
<a name="line-67"></a><span class='hs-comment'>--   See Note [Zonking to Skolem]</span>
<a name="line-68"></a><span class='hs-definition'>skolemiseUnboundMetaTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>details</span>
<a name="line-69"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span> 
<a name="line-70"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>span</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>    <span class='hs-comment'>-- Get the location from "here"</span>
<a name="line-71"></a>                                 <span class='hs-comment'>-- ie where we are generalising</span>
<a name="line-72"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUnique</span>      <span class='hs-comment'>-- Remove it from TcMetaTyVar unique land</span>
<a name="line-73"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-74"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>final_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defaultKind</span> <span class='hs-varid'>kind</span>
<a name="line-75"></a>              <span class='hs-varid'>final_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInternalName</span> <span class='hs-varid'>uniq</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>span</span>
<a name="line-76"></a>              <span class='hs-varid'>final_tv</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcTyVar</span> <span class='hs-varid'>final_name</span> <span class='hs-varid'>final_kind</span> <span class='hs-varid'>details</span>
<a name="line-77"></a>
<a name="line-78"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>writeMetaTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>final_tv</span><span class='hs-layout'>)</span>
<a name="line-79"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>final_tv</span> <span class='hs-layout'>}</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="zonkImplication"></a><span class='hs-definition'>zonkImplication</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Implication</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Implication</span>
<a name="line-2"></a><span class='hs-definition'>zonkImplication</span> <span class='hs-varid'>implic</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Implic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_given</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>given</span> 
<a name="line-3"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>ic_wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wanted</span>
<a name="line-4"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>ic_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>    <span class='hs-comment'>-- No need to zonk the skolems</span>
<a name="line-6"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>given'</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkEvVar</span> <span class='hs-varid'>given</span>
<a name="line-7"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>loc'</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkGivenLoc</span> <span class='hs-varid'>loc</span>
<a name="line-8"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wanted'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkWC</span> <span class='hs-varid'>wanted</span>
<a name="line-9"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>implic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_given</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>given'</span>
<a name="line-10"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>ic_wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wanted'</span>
<a name="line-11"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>ic_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="zonkEvVar"></a><span class='hs-definition'>zonkEvVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>EvVar</span>
<a name="line-14"></a><span class='hs-definition'>zonkEvVar</span> <span class='hs-varid'>var</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span>
<a name="line-15"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>setVarType</span> <span class='hs-varid'>var</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-16"></a>
<a name="line-17"></a>
<a name="line-18"></a><a name="zonkWC"></a><span class='hs-definition'>zonkWC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-19"></a><span class='hs-definition'>zonkWC</span> <span class='hs-layout'>(</span><span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_flat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flat</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implic</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insol</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>flat'</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapBagM</span> <span class='hs-varid'>zonkCt</span> <span class='hs-varid'>flat</span> 
<a name="line-21"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>implic'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapBagM</span> <span class='hs-varid'>zonkImplication</span> <span class='hs-varid'>implic</span>
<a name="line-22"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>insol'</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapBagM</span> <span class='hs-varid'>zonkCt</span> <span class='hs-varid'>insol</span>
<a name="line-23"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_flat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flat'</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implic'</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insol'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="zonkCt"></a><span class='hs-definition'>zonkCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Ct</span> 
<a name="line-26"></a><span class='hs-comment'>-- Zonking a Ct conservatively gives back a CNonCanonical</span>
<a name="line-27"></a><span class='hs-definition'>zonkCt</span> <span class='hs-varid'>ct</span> 
<a name="line-28"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>v'</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkEvVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_id</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-29"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>fl'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkFlavor</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_flavor</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-30"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> 
<a name="line-31"></a>         <span class='hs-conid'>CNonCanonical</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>v'</span>
<a name="line-32"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>cc_flavor</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fl'</span>
<a name="line-33"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>cc_depth</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cc_depth</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-34"></a><a name="zonkCts"></a><span class='hs-definition'>zonkCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Cts</span>
<a name="line-35"></a><span class='hs-definition'>zonkCts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapBagM</span> <span class='hs-varid'>zonkCt</span>
<a name="line-36"></a>
<a name="line-37"></a><a name="zonkWantedEvVars"></a><span class='hs-definition'>zonkWantedEvVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>WantedEvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-conid'>WantedEvVar</span><span class='hs-layout'>)</span>
<a name="line-38"></a><span class='hs-definition'>zonkWantedEvVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapBagM</span> <span class='hs-varid'>zonkWantedEvVar</span>
<a name="line-39"></a>
<a name="line-40"></a><a name="zonkWantedEvVar"></a><span class='hs-definition'>zonkWantedEvVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedEvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>WantedEvVar</span>
<a name="line-41"></a><span class='hs-definition'>zonkWantedEvVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvVarX</span> <span class='hs-varid'>v</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>v'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkEvVar</span> <span class='hs-varid'>v</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvVarX</span> <span class='hs-varid'>v'</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-42"></a>
<a name="line-43"></a><a name="zonkFlavor"></a><span class='hs-definition'>zonkFlavor</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>CtFlavor</span>
<a name="line-44"></a><span class='hs-definition'>zonkFlavor</span> <span class='hs-layout'>(</span><span class='hs-conid'>Given</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>gk</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>loc'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkGivenLoc</span> <span class='hs-varid'>loc</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Given</span> <span class='hs-varid'>loc'</span> <span class='hs-varid'>gk</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-45"></a><span class='hs-definition'>zonkFlavor</span> <span class='hs-varid'>fl</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>fl</span>
<a name="line-46"></a>
<a name="line-47"></a><a name="zonkGivenLoc"></a><span class='hs-definition'>zonkGivenLoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GivenLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>GivenLoc</span>
<a name="line-48"></a><span class='hs-comment'>-- GivenLocs may have unification variables inside them!</span>
<a name="line-49"></a><span class='hs-definition'>zonkGivenLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtLoc</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>span</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-50"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>skol_info'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkSkolemInfo</span> <span class='hs-varid'>skol_info</span>
<a name="line-51"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtLoc</span> <span class='hs-varid'>skol_info'</span> <span class='hs-varid'>span</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-52"></a>
<a name="line-53"></a><a name="zonkSkolemInfo"></a><span class='hs-definition'>zonkSkolemInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SkolemInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>SkolemInfo</span>
<a name="line-54"></a><span class='hs-definition'>zonkSkolemInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SigSkol</span> <span class='hs-varid'>cx</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>ty</span>
<a name="line-55"></a>                                     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>SigSkol</span> <span class='hs-varid'>cx</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-56"></a><span class='hs-definition'>zonkSkolemInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>InferSkol</span> <span class='hs-varid'>ntys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ntys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>do_one</span> <span class='hs-varid'>ntys</span>
<a name="line-57"></a>                                     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>InferSkol</span> <span class='hs-varid'>ntys'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-58"></a>  <span class='hs-keyword'>where</span>
<a name="line-59"></a>    <span class='hs-varid'>do_one</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-60"></a><span class='hs-definition'>zonkSkolemInfo</span> <span class='hs-varid'>skol_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>skol_info</span>
</pre>\end{code}

Note [Silly Type Synonyms]
~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this:
	type C u a = u	-- Note 'a' unused

	foo :: (forall a. C u a -> C u a) -> u
	foo x = ...

	bar :: Num u => u
	bar = foo (\t -> t + t)

* From the (\t -> t+t) we get type  {Num d} =>  d -> d
  where d is fresh.

* Now unify with type of foo's arg, and we get:
	{Num (C d a)} =>  C d a -> C d a
  where a is fresh.

* Now abstract over the 'a', but float out the Num (C d a) constraint
  because it does not 'really' mention a.  (see exactTyVarsOfType)
  The arg to foo becomes
	\/\a -> \t -> t+t

* So we get a dict binding for Num (C d a), which is zonked to give
	a = ()
  [Note Sept 04: now that we are zonking quantified type variables
  on construction, the 'a' will be frozen as a regular tyvar on
  quantification, so the floated dict will still have type (C d a).
  Which renders this whole note moot; happily!]

* Then the \/\a abstraction has a zonked 'a' in it.

All very silly.   I think its harmless to ignore the problem.  We'll end up with
a \/\a in the final result but all the occurrences of a will be zonked to ()

Note [Zonking to Skolem]
~~~~~~~~~~~~~~~~~~~~~~~~
We used to zonk quantified type variables to regular TyVars.  However, this
leads to problems.  Consider this program from the regression test suite:

  eval :: Int -> String -> String -> String
  eval 0 root actual = evalRHS 0 root actual

  evalRHS :: Int -> a
  evalRHS 0 root actual = eval 0 root actual

It leads to the deferral of an equality (wrapped in an implication constraint)

  forall a. () => ((String -> String -> String) ~ a)

which is propagated up to the toplevel (see TcSimplify.tcSimplifyInferCheck).
In the meantime `a' is zonked and quantified to form `evalRHS's signature.
This has the *side effect* of also zonking the `a' in the deferred equality
(which at this point is being handed around wrapped in an implication
constraint).

Finally, the equality (with the zonked `a') will be handed back to the
simplifier by TcRnDriver.tcRnSrcDecls calling TcSimplify.tcSimplifyTop.
If we zonk `a' with a regular type variable, we will have this regular type
variable now floating around in the simplifier, which in many places assumes to
only see proper TcTyVars.

We can avoid this problem by zonking with a skolem.  The skolem is rigid
(which we require for a quantified variable), but is still a TcTyVar that the
simplifier knows how to deal with.


%************************************************************************
%*									*
\subsection{Zonking -- the main work-horses: zonkType, zonkTyVar}
%*									*
%*		For internal use only!					*
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>-- For unbound, mutable tyvars, zonkType uses the function given to it</span>
<a name="line-2"></a><span class='hs-comment'>-- For tyvars bound at a for-all, zonkType zonks them to an immutable</span>
<a name="line-3"></a><span class='hs-comment'>--	type variable and zonks the kind too</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="zonkKind"></a><span class='hs-definition'>zonkKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Kind</span>
<a name="line-6"></a><span class='hs-definition'>zonkKind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zonkType</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="zonkType"></a><span class='hs-definition'>zonkType</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- What to do with TcTyVars</span>
<a name="line-9"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-10"></a><span class='hs-definition'>zonkType</span> <span class='hs-varid'>zonk_tc_tyvar</span> <span class='hs-varid'>ty</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-12"></a>  <span class='hs-keyword'>where</span>
<a name="line-13"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>tys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tys</span>
<a name="line-14"></a>                              <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span>
<a name="line-15"></a>
<a name="line-16"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>arg'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>arg</span>
<a name="line-17"></a>                              <span class='hs-varid'>res'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>res</span>
<a name="line-18"></a>                              <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg'</span> <span class='hs-varid'>res'</span><span class='hs-layout'>)</span>
<a name="line-19"></a>
<a name="line-20"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>fun'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>fun</span>
<a name="line-21"></a>                              <span class='hs-varid'>arg'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>arg</span>
<a name="line-22"></a>                              <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppTy</span> <span class='hs-varid'>fun'</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>)</span>
<a name="line-23"></a>		<span class='hs-comment'>-- NB the mkAppTy; we might have instantiated a</span>
<a name="line-24"></a>		<span class='hs-comment'>-- type variable to a type constructor, so we need</span>
<a name="line-25"></a>		<span class='hs-comment'>-- to pull the TyConApp to the top.</span>
<a name="line-26"></a>
<a name="line-27"></a>	<span class='hs-comment'>-- The two interesting cases!</span>
<a name="line-28"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tyvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zonk_tc_tyvar</span> <span class='hs-varid'>tyvar</span>
<a name="line-29"></a>		       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>	 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyVarTy</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>updateTyVarKindM</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-varid'>tyvar</span>
<a name="line-30"></a>		<span class='hs-comment'>-- Ordinary (non Tc) tyvars occur inside quantified types</span>
<a name="line-31"></a>
<a name="line-32"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tyvar</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isImmutableTyVar</span> <span class='hs-varid'>tyvar</span> <span class='hs-layout'>)</span> <span class='hs-keyword'>do</span>
<a name="line-33"></a>                             <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-34"></a>                             <span class='hs-varid'>tyvar'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>updateTyVarKindM</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-varid'>tyvar</span>
<a name="line-35"></a>                             <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tyvar'</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span>
</pre>\end{code}



%************************************************************************
%*									*
			Zonking kinds
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="compatKindTcM"></a><span class='hs-definition'>compatKindTcM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Bool</span>
<a name="line-2"></a><span class='hs-definition'>compatKindTcM</span> <span class='hs-varid'>k1</span> <span class='hs-varid'>k2</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>k1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-varid'>k1</span>
<a name="line-4"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>k2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-varid'>k2</span>
<a name="line-5"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>k1'</span> <span class='hs-varop'>`isSubKind`</span> <span class='hs-varid'>k2'</span> <span class='hs-varop'>||</span> <span class='hs-varid'>k2'</span> <span class='hs-varop'>`isSubKind`</span> <span class='hs-varid'>k1'</span> <span class='hs-layout'>}</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="isSubKindTcM"></a><span class='hs-definition'>isSubKindTcM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Bool</span>
<a name="line-8"></a><span class='hs-definition'>isSubKindTcM</span> <span class='hs-varid'>k1</span> <span class='hs-varid'>k2</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>k1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-varid'>k1</span>
<a name="line-10"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>k2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-varid'>k2</span>
<a name="line-11"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>k1'</span> <span class='hs-varop'>`isSubKind`</span> <span class='hs-varid'>k2'</span> <span class='hs-layout'>}</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="zonkTcKind"></a><span class='hs-comment'>-------------</span>
<a name="line-14"></a><span class='hs-definition'>zonkTcKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcKind</span>
<a name="line-15"></a><span class='hs-definition'>zonkTcKind</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>k</span>
</pre>\end{code}
			
%************************************************************************
%*									*
\subsection{Checking a user type}
%*									*
%************************************************************************

When dealing with a user-written type, we first translate it from an HsType
to a Type, performing kind checking, and then check various things that should 
be true about it.  We don't want to perform these checks at the same time
as the initial translation because (a) they are unnecessary for interface-file
types and (b) when checking a mutually recursive group of type and class decls,
we can't "look" at the tycons/classes yet.  Also, the checks are are rather
diverse, and used to really mess up the other code.

One thing we check for is 'rank'.  

	Rank 0: 	monotypes (no foralls)
	Rank 1:		foralls at the front only, Rank 0 inside
	Rank 2:		foralls at the front, Rank 1 on left of fn arrow,

	basic ::= tyvar | T basic ... basic

	r2  ::= forall tvs. cxt => r2a
	r2a ::= r1 -> r2a | basic
	r1  ::= forall tvs. cxt => r0
	r0  ::= r0 -> r0 | basic
	
Another thing is to check that type synonyms are saturated. 
This might not necessarily show up in kind checking.
	type A i = i
	data T k = MkT (k Int)
	f :: T A	-- BAD!

	
\begin{code}
<pre><a name="line-1"></a><a name="expectedKindInCtxt"></a><span class='hs-comment'>-- Depending on the context, we might accept any kind (for instance, in a TH</span>
<a name="line-2"></a><span class='hs-comment'>-- splice), or only certain kinds (like in type signatures).</span>
<a name="line-3"></a><span class='hs-definition'>expectedKindInCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Kind</span>
<a name="line-4"></a><span class='hs-definition'>expectedKindInCtxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>TySynCtxt</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span> <span class='hs-comment'>-- Any kind will do</span>
<a name="line-5"></a><span class='hs-definition'>expectedKindInCtxt</span> <span class='hs-conid'>ThBrackCtxt</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-6"></a><span class='hs-definition'>expectedKindInCtxt</span> <span class='hs-conid'>GhciCtxt</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-7"></a><span class='hs-definition'>expectedKindInCtxt</span> <span class='hs-conid'>ResSigCtxt</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>openTypeKind</span>
<a name="line-8"></a><span class='hs-definition'>expectedKindInCtxt</span> <span class='hs-conid'>ExprSigCtxt</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>openTypeKind</span>
<a name="line-9"></a><span class='hs-definition'>expectedKindInCtxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForSigCtxt</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-10"></a><span class='hs-definition'>expectedKindInCtxt</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>argTypeKind</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="checkValidType"></a><span class='hs-definition'>checkValidType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-13"></a><span class='hs-comment'>-- Checks that the type is valid for the given context</span>
<a name="line-14"></a><span class='hs-definition'>checkValidType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-15"></a>    <span class='hs-varid'>traceTc</span> <span class='hs-str'>"checkValidType"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"::"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-16"></a>    <span class='hs-varid'>unboxed</span>         <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_UnboxedTuples</span>
<a name="line-17"></a>    <span class='hs-varid'>rank2</span>           <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_Rank2Types</span>
<a name="line-18"></a>    <span class='hs-varid'>rankn</span>           <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_RankNTypes</span>
<a name="line-19"></a>    <span class='hs-varid'>polycomp</span>        <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_PolymorphicComponents</span>
<a name="line-20"></a>    <span class='hs-varid'>constraintKinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_ConstraintKinds</span>
<a name="line-21"></a>    <span class='hs-keyword'>let</span> 
<a name="line-22"></a>	<span class='hs-varid'>gen_rank</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>rankn</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ArbitraryRank</span>
<a name="line-23"></a>	           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>rank2</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Rank</span> <span class='hs-num'>2</span>
<a name="line-24"></a>	           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Rank</span> <span class='hs-varid'>n</span>
<a name="line-25"></a>	<span class='hs-varid'>rank</span>
<a name="line-26"></a>	  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>of</span>
<a name="line-27"></a>		 <span class='hs-conid'>DefaultDeclCtxt</span><span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MustBeMonoType</span>
<a name="line-28"></a>		 <span class='hs-conid'>ResSigCtxt</span>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MustBeMonoType</span>
<a name="line-29"></a>		 <span class='hs-conid'>LamPatSigCtxt</span>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>gen_rank</span> <span class='hs-num'>0</span>
<a name="line-30"></a>		 <span class='hs-conid'>BindPatSigCtxt</span>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>gen_rank</span> <span class='hs-num'>0</span>
<a name="line-31"></a>		 <span class='hs-conid'>TySynCtxt</span> <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>gen_rank</span> <span class='hs-num'>0</span>
<a name="line-32"></a>
<a name="line-33"></a>		 <span class='hs-conid'>ExprSigCtxt</span> 	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>gen_rank</span> <span class='hs-num'>1</span>
<a name="line-34"></a>		 <span class='hs-conid'>FunSigCtxt</span> <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>gen_rank</span> <span class='hs-num'>1</span>
<a name="line-35"></a>		 <span class='hs-conid'>InfSigCtxt</span> <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ArbitraryRank</span>	<span class='hs-comment'>-- Inferred type</span>
<a name="line-36"></a>		 <span class='hs-conid'>ConArgCtxt</span> <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>polycomp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>gen_rank</span> <span class='hs-num'>2</span>
<a name="line-37"></a>                                <span class='hs-comment'>-- We are given the type of the entire</span>
<a name="line-38"></a>                                <span class='hs-comment'>-- constructor, hence rank 1</span>
<a name="line-39"></a> 				<span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>gen_rank</span> <span class='hs-num'>1</span>
<a name="line-40"></a>
<a name="line-41"></a>		 <span class='hs-conid'>ForSigCtxt</span> <span class='hs-keyword'>_</span>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>gen_rank</span> <span class='hs-num'>1</span>
<a name="line-42"></a>		 <span class='hs-conid'>SpecInstCtxt</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>gen_rank</span> <span class='hs-num'>1</span>
<a name="line-43"></a>                 <span class='hs-conid'>ThBrackCtxt</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>gen_rank</span> <span class='hs-num'>1</span>
<a name="line-44"></a>		 <span class='hs-conid'>GhciCtxt</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ArbitraryRank</span>
<a name="line-45"></a>                 <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"checkValidType"</span>
<a name="line-46"></a>                                     <span class='hs-comment'>-- Can't happen; not used for *user* sigs</span>
<a name="line-47"></a>
<a name="line-48"></a>	<span class='hs-varid'>actual_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty</span>
<a name="line-49"></a>
<a name="line-50"></a>        <span class='hs-varid'>kind_ok</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>expectedKindInCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>of</span>
<a name="line-51"></a>                    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-52"></a>                    <span class='hs-conid'>Just</span> <span class='hs-varid'>k</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tcIsSubKind</span> <span class='hs-varid'>actual_kind</span> <span class='hs-varid'>k</span>
<a name="line-53"></a>	
<a name="line-54"></a>	<span class='hs-varid'>ubx_tup</span> 
<a name="line-55"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>unboxed</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UT_NotOk</span>
<a name="line-56"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>of</span>
<a name="line-57"></a>	              	   <span class='hs-conid'>TySynCtxt</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UT_Ok</span>
<a name="line-58"></a>	              	   <span class='hs-conid'>ExprSigCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UT_Ok</span>
<a name="line-59"></a>	              	   <span class='hs-conid'>ThBrackCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UT_Ok</span>
<a name="line-60"></a>		      	   <span class='hs-conid'>GhciCtxt</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UT_Ok</span>
<a name="line-61"></a>	              	   <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UT_NotOk</span>
<a name="line-62"></a>
<a name="line-63"></a>	<span class='hs-comment'>-- Check the internal validity of the type itself</span>
<a name="line-64"></a>    <span class='hs-varid'>check_type</span> <span class='hs-varid'>rank</span> <span class='hs-varid'>ubx_tup</span> <span class='hs-varid'>ty</span>
<a name="line-65"></a>
<a name="line-66"></a>	<span class='hs-comment'>-- Check that the thing has kind Type, and is lifted if necessary</span>
<a name="line-67"></a>	<span class='hs-comment'>-- Do this second, because we can't usefully take the kind of an </span>
<a name="line-68"></a>	<span class='hs-comment'>-- ill-formed type such as (a~Int)</span>
<a name="line-69"></a>    <span class='hs-varid'>checkTc</span> <span class='hs-varid'>kind_ok</span> <span class='hs-layout'>(</span><span class='hs-varid'>kindErr</span> <span class='hs-varid'>actual_kind</span><span class='hs-layout'>)</span>
<a name="line-70"></a>
<a name="line-71"></a>        <span class='hs-comment'>-- Check that the thing does not have kind Constraint,</span>
<a name="line-72"></a>        <span class='hs-comment'>-- if -XConstraintKinds isn't enabled</span>
<a name="line-73"></a>    <span class='hs-varid'>unless</span> <span class='hs-varid'>constraintKinds</span>
<a name="line-74"></a>      <span class='hs-varop'>$</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isConstraintKind</span> <span class='hs-varid'>actual_kind</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>predTupleErr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-75"></a>
<a name="line-76"></a><a name="checkValidMonoType"></a><span class='hs-definition'>checkValidMonoType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-77"></a><span class='hs-definition'>checkValidMonoType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>check_mono_type</span> <span class='hs-conid'>MustBeMonoType</span> <span class='hs-varid'>ty</span>
</pre>\end{code}


\begin{code}
<pre><a name="line-1"></a><a name="Rank"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Rank</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ArbitraryRank</span>	  <span class='hs-comment'>-- Any rank ok</span>
<a name="line-2"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-conid'>MustBeMonoType</span>  	  <span class='hs-comment'>-- Monotype regardless of flags</span>
<a name="line-3"></a>	  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TyConArgMonoType</span>	  <span class='hs-comment'>-- Monotype but could be poly if -XImpredicativeTypes</span>
<a name="line-4"></a>	  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SynArgMonoType</span>	  <span class='hs-comment'>-- Monotype but could be poly if -XLiberalTypeSynonyms</span>
<a name="line-5"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Rank</span> <span class='hs-conid'>Int</span>		  <span class='hs-comment'>-- Rank n, but could be more with -XRankNTypes</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="decRank"></a><span class='hs-definition'>decRank</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Rank</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Rank</span>		  <span class='hs-comment'>-- Function arguments</span>
<a name="line-8"></a><span class='hs-definition'>decRank</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rank</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Rank</span> <span class='hs-num'>0</span>
<a name="line-9"></a><span class='hs-definition'>decRank</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rank</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Rank</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-10"></a><span class='hs-definition'>decRank</span> <span class='hs-varid'>other_rank</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>other_rank</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="nonZeroRank"></a><span class='hs-definition'>nonZeroRank</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Rank</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-13"></a><span class='hs-definition'>nonZeroRank</span> <span class='hs-conid'>ArbitraryRank</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-14"></a><span class='hs-definition'>nonZeroRank</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rank</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> 	  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span><span class='hs-varop'>&gt;</span><span class='hs-num'>0</span>
<a name="line-15"></a><span class='hs-definition'>nonZeroRank</span> <span class='hs-keyword'>_</span>        	  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="UbxTupFlag"></a><span class='hs-comment'>----------------------------------------</span>
<a name="line-18"></a><a name="UbxTupFlag"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>UbxTupFlag</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UT_Ok</span>	<span class='hs-keyglyph'>|</span> <span class='hs-conid'>UT_NotOk</span>
<a name="line-19"></a>	<span class='hs-comment'>-- The "Ok" version means "ok if UnboxedTuples is on"</span>
<a name="line-20"></a>
<a name="line-21"></a><a name="check_mono_type"></a><span class='hs-comment'>----------------------------------------</span>
<a name="line-22"></a><span class='hs-definition'>check_mono_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Rank</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>KindOrType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>	<span class='hs-comment'>-- No foralls anywhere</span>
<a name="line-23"></a>				      		<span class='hs-comment'>-- No unlifted types of any kind</span>
<a name="line-24"></a><span class='hs-definition'>check_mono_type</span> <span class='hs-varid'>rank</span> <span class='hs-varid'>ty</span>
<a name="line-25"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isKind</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>  <span class='hs-comment'>-- IA0_NOTE: Do we need to check kinds?</span>
<a name="line-26"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-27"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>check_type</span> <span class='hs-varid'>rank</span> <span class='hs-conid'>UT_NotOk</span> <span class='hs-varid'>ty</span>
<a name="line-28"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isUnLiftedType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>unliftedArgErr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-29"></a>
<a name="line-30"></a><a name="check_type"></a><span class='hs-definition'>check_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Rank</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UbxTupFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-31"></a><span class='hs-comment'>-- The args say what the *type context* requires, independent</span>
<a name="line-32"></a><span class='hs-comment'>-- of *flag* settings.  You test the flag settings at usage sites.</span>
<a name="line-33"></a><span class='hs-comment'>-- </span>
<a name="line-34"></a><span class='hs-comment'>-- Rank is allowed rank for function args</span>
<a name="line-35"></a><span class='hs-comment'>-- Rank 0 means no for-alls anywhere</span>
<a name="line-36"></a>
<a name="line-37"></a><span class='hs-definition'>check_type</span> <span class='hs-varid'>rank</span> <span class='hs-varid'>ubx_tup</span> <span class='hs-varid'>ty</span>
<a name="line-38"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>theta</span><span class='hs-layout'>)</span>
<a name="line-39"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>nonZeroRank</span> <span class='hs-varid'>rank</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>forAllTyErr</span> <span class='hs-varid'>rank</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-40"></a>		<span class='hs-comment'>-- Reject e.g. (Maybe (?x::Int =&gt; Int)), </span>
<a name="line-41"></a>		<span class='hs-comment'>-- with a decent error message</span>
<a name="line-42"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>check_valid_theta</span> <span class='hs-conid'>SigmaCtxt</span> <span class='hs-varid'>theta</span>
<a name="line-43"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>check_type</span> <span class='hs-varid'>rank</span> <span class='hs-varid'>ubx_tup</span> <span class='hs-varid'>tau</span>	<span class='hs-comment'>-- Allow foralls to right of arrow</span>
<a name="line-44"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>checkAmbiguity</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>theta</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-45"></a>  <span class='hs-keyword'>where</span>
<a name="line-46"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitSigmaTy</span> <span class='hs-varid'>ty</span>
<a name="line-47"></a>   
<a name="line-48"></a><span class='hs-definition'>check_type</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-49"></a>
<a name="line-50"></a><span class='hs-definition'>check_type</span> <span class='hs-varid'>rank</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg_ty</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-51"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>check_type</span> <span class='hs-layout'>(</span><span class='hs-varid'>decRank</span> <span class='hs-varid'>rank</span><span class='hs-layout'>)</span> <span class='hs-conid'>UT_NotOk</span> <span class='hs-varid'>arg_ty</span>
<a name="line-52"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>check_type</span> <span class='hs-varid'>rank</span> 	    <span class='hs-conid'>UT_Ok</span>    <span class='hs-varid'>res_ty</span> <span class='hs-layout'>}</span>
<a name="line-53"></a>
<a name="line-54"></a><span class='hs-definition'>check_type</span> <span class='hs-varid'>rank</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-55"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>check_arg_type</span> <span class='hs-varid'>rank</span> <span class='hs-varid'>ty1</span>
<a name="line-56"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>check_arg_type</span> <span class='hs-varid'>rank</span> <span class='hs-varid'>ty2</span> <span class='hs-layout'>}</span>
<a name="line-57"></a>
<a name="line-58"></a><span class='hs-definition'>check_type</span> <span class='hs-varid'>rank</span> <span class='hs-varid'>ubx_tup</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-59"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isSynTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-60"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> 	<span class='hs-comment'>-- Check that the synonym has enough args</span>
<a name="line-61"></a>		<span class='hs-comment'>-- This applies equally to open and closed synonyms</span>
<a name="line-62"></a>	 	<span class='hs-comment'>-- It's OK to have an *over-applied* type synonym</span>
<a name="line-63"></a>		<span class='hs-comment'>--	data Tree a b = ...</span>
<a name="line-64"></a>		<span class='hs-comment'>--	type Foo a = Tree [a]</span>
<a name="line-65"></a>		<span class='hs-comment'>--	f :: Foo a b -&gt; ...</span>
<a name="line-66"></a> 	  <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>arity_msg</span>
<a name="line-67"></a>
<a name="line-68"></a>	<span class='hs-comment'>-- See Note [Liberal type synonyms]</span>
<a name="line-69"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>liberal</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_LiberalTypeSynonyms</span>
<a name="line-70"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>not</span> <span class='hs-varid'>liberal</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isSynFamilyTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>then</span>
<a name="line-71"></a>		<span class='hs-comment'>-- For H98 and synonym families, do check the type args</span>
<a name="line-72"></a>		<span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>check_mono_type</span> <span class='hs-conid'>SynArgMonoType</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-73"></a>
<a name="line-74"></a>	  <span class='hs-keyword'>else</span>	<span class='hs-comment'>-- In the liberal case (only for closed syns), expand then check</span>
<a name="line-75"></a>	  <span class='hs-keyword'>case</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>   
<a name="line-76"></a>	     <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>check_type</span> <span class='hs-varid'>rank</span> <span class='hs-varid'>ubx_tup</span> <span class='hs-varid'>ty'</span> 
<a name="line-77"></a>	     <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"check_tau_type"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-78"></a>    <span class='hs-layout'>}</span>
<a name="line-79"></a>    
<a name="line-80"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isUnboxedTupleTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-81"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>ub_tuples_allowed</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_UnboxedTuples</span>
<a name="line-82"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ubx_tup_ok</span> <span class='hs-varid'>ub_tuples_allowed</span><span class='hs-layout'>)</span> <span class='hs-varid'>ubx_tup_msg</span>
<a name="line-83"></a>
<a name="line-84"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>impred</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_ImpredicativeTypes</span>	
<a name="line-85"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>rank'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>impred</span> <span class='hs-keyword'>then</span> <span class='hs-conid'>ArbitraryRank</span> <span class='hs-keyword'>else</span> <span class='hs-conid'>TyConArgMonoType</span>
<a name="line-86"></a>		<span class='hs-comment'>-- c.f. check_arg_type</span>
<a name="line-87"></a>		<span class='hs-comment'>-- However, args are allowed to be unlifted, or</span>
<a name="line-88"></a>		<span class='hs-comment'>-- more unboxed tuples, so can't use check_arg_ty</span>
<a name="line-89"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>check_type</span> <span class='hs-varid'>rank'</span> <span class='hs-conid'>UT_Ok</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span>
<a name="line-90"></a>
<a name="line-91"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-92"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>check_arg_type</span> <span class='hs-varid'>rank</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-93"></a>
<a name="line-94"></a>  <span class='hs-keyword'>where</span>
<a name="line-95"></a>    <span class='hs-varid'>ubx_tup_ok</span> <span class='hs-varid'>ub_tuples_allowed</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ubx_tup</span> <span class='hs-keyword'>of</span>
<a name="line-96"></a>                                   <span class='hs-conid'>UT_Ok</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ub_tuples_allowed</span>
<a name="line-97"></a>                                   <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-98"></a>
<a name="line-99"></a>    <span class='hs-varid'>n_args</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span>
<a name="line-100"></a>    <span class='hs-varid'>tc_arity</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span>
<a name="line-101"></a>
<a name="line-102"></a>    <span class='hs-varid'>arity_msg</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arityErr</span> <span class='hs-str'>"Type synonym"</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConName</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tc_arity</span> <span class='hs-varid'>n_args</span>
<a name="line-103"></a>    <span class='hs-varid'>ubx_tup_msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ubxArgTyErr</span> <span class='hs-varid'>ty</span>
<a name="line-104"></a>
<a name="line-105"></a><span class='hs-definition'>check_type</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"check_type"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-106"></a>
<a name="line-107"></a><a name="check_arg_type"></a><span class='hs-comment'>----------------------------------------</span>
<a name="line-108"></a><span class='hs-definition'>check_arg_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Rank</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>KindOrType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-109"></a><span class='hs-comment'>-- The sort of type that can instantiate a type variable,</span>
<a name="line-110"></a><span class='hs-comment'>-- or be the argument of a type constructor.</span>
<a name="line-111"></a><span class='hs-comment'>-- Not an unboxed tuple, but now *can* be a forall (since impredicativity)</span>
<a name="line-112"></a><span class='hs-comment'>-- Other unboxed types are very occasionally allowed as type</span>
<a name="line-113"></a><span class='hs-comment'>-- arguments depending on the kind of the type constructor</span>
<a name="line-114"></a><span class='hs-comment'>-- </span>
<a name="line-115"></a><span class='hs-comment'>-- For example, we want to reject things like:</span>
<a name="line-116"></a><span class='hs-comment'>--</span>
<a name="line-117"></a><span class='hs-comment'>--	instance Ord a =&gt; Ord (forall s. T s a)</span>
<a name="line-118"></a><span class='hs-comment'>-- and</span>
<a name="line-119"></a><span class='hs-comment'>--	g :: T s (forall b.b)</span>
<a name="line-120"></a><span class='hs-comment'>--</span>
<a name="line-121"></a><span class='hs-comment'>-- NB: unboxed tuples can have polymorphic or unboxed args.</span>
<a name="line-122"></a><span class='hs-comment'>--     This happens in the workers for functions returning</span>
<a name="line-123"></a><span class='hs-comment'>--     product types with polymorphic components.</span>
<a name="line-124"></a><span class='hs-comment'>--     But not in user code.</span>
<a name="line-125"></a><span class='hs-comment'>-- Anyway, they are dealt with by a special case in check_tau_type</span>
<a name="line-126"></a>
<a name="line-127"></a><span class='hs-definition'>check_arg_type</span> <span class='hs-varid'>rank</span> <span class='hs-varid'>ty</span>
<a name="line-128"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isKind</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>  <span class='hs-comment'>-- IA0_NOTE: Do we need to check a kind?</span>
<a name="line-129"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-130"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>impred</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_ImpredicativeTypes</span>
<a name="line-131"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>rank'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>rank</span> <span class='hs-keyword'>of</span> 	    <span class='hs-comment'>-- Predictive =&gt; must be monotype</span>
<a name="line-132"></a>	      	        <span class='hs-conid'>MustBeMonoType</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MustBeMonoType</span>  <span class='hs-comment'>-- Monotype, regardless</span>
<a name="line-133"></a>			<span class='hs-sel'>_other</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>impred</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ArbitraryRank</span>
<a name="line-134"></a>			       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyConArgMonoType</span>
<a name="line-135"></a>			<span class='hs-comment'>-- Make sure that MustBeMonoType is propagated, </span>
<a name="line-136"></a>			<span class='hs-comment'>-- so that we don't suggest -XImpredicativeTypes in</span>
<a name="line-137"></a>			<span class='hs-comment'>--    (Ord (forall a.a)) =&gt; a -&gt; a</span>
<a name="line-138"></a>			<span class='hs-comment'>-- and so that if it Must be a monotype, we check that it is!</span>
<a name="line-139"></a>
<a name="line-140"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>check_type</span> <span class='hs-varid'>rank'</span> <span class='hs-conid'>UT_NotOk</span> <span class='hs-varid'>ty</span>
<a name="line-141"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isUnLiftedType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>unliftedArgErr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-142"></a>             <span class='hs-comment'>-- NB the isUnLiftedType test also checks for </span>
<a name="line-143"></a>             <span class='hs-comment'>--    T State#</span>
<a name="line-144"></a>             <span class='hs-comment'>-- where there is an illegal partial application of State# (which has</span>
<a name="line-145"></a>             <span class='hs-comment'>-- kind * -&gt; #); see Note [The kind invariant] in TypeRep</span>
<a name="line-146"></a>
<a name="line-147"></a><a name="forAllTyErr"></a><span class='hs-comment'>----------------------------------------</span>
<a name="line-148"></a><span class='hs-definition'>forAllTyErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Rank</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-149"></a><span class='hs-definition'>forAllTyErr</span> <span class='hs-varid'>rank</span> <span class='hs-varid'>ty</span> 
<a name="line-150"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal polymorphic or qualified type:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-151"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>suggestion</span> <span class='hs-keyglyph'>]</span>
<a name="line-152"></a>  <span class='hs-keyword'>where</span>
<a name="line-153"></a>    <span class='hs-varid'>suggestion</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>rank</span> <span class='hs-keyword'>of</span>
<a name="line-154"></a>    	       	   <span class='hs-conid'>Rank</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Perhaps you intended to use -XRankNTypes or -XRank2Types"</span><span class='hs-layout'>)</span>
<a name="line-155"></a>    	       	   <span class='hs-conid'>TyConArgMonoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Perhaps you intended to use -XImpredicativeTypes"</span><span class='hs-layout'>)</span>
<a name="line-156"></a>    	       	   <span class='hs-conid'>SynArgMonoType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Perhaps you intended to use -XLiberalTypeSynonyms"</span><span class='hs-layout'>)</span>
<a name="line-157"></a>		   <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>empty</span>      <span class='hs-comment'>-- Polytype is always illegal</span>
<a name="line-158"></a>
<a name="line-159"></a><a name="unliftedArgErr"></a><span class='hs-definition'>unliftedArgErr</span><span class='hs-layout'>,</span> <span class='hs-varid'>ubxArgTyErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-160"></a><span class='hs-definition'>unliftedArgErr</span>  <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal unlifted type:"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span>
<a name="line-161"></a><a name="ubxArgTyErr"></a><span class='hs-definition'>ubxArgTyErr</span>     <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal unboxed tuple type as function argument:"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span>
<a name="line-162"></a>
<a name="line-163"></a><a name="kindErr"></a><span class='hs-definition'>kindErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-164"></a><span class='hs-definition'>kindErr</span> <span class='hs-varid'>kind</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Expecting an ordinary type, but found a type of kind"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kind</span><span class='hs-keyglyph'>]</span>
</pre>\end{code}

Note [Liberal type synonyms]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If -XLiberalTypeSynonyms is on, expand closed type synonyms *before*
doing validity checking.  This allows us to instantiate a synonym defn
with a for-all type, or with a partially-applied type synonym.
	e.g.   type T a b = a
	       type S m   = m ()
	       f :: S (T Int)
Here, T is partially applied, so it's illegal in H98.  But if you
expand S first, then T we get just
	       f :: Int
which is fine.

IMPORTANT: suppose T is a type synonym.  Then we must do validity
checking on an appliation (T ty1 ty2)

	*either* before expansion (i.e. check ty1, ty2)
	*or* after expansion (i.e. expand T ty1 ty2, and then check)
	BUT NOT BOTH

If we do both, we get exponential behaviour!!

  data TIACons1 i r c = c i ::: r c
  type TIACons2 t x = TIACons1 t (TIACons1 t x)
  type TIACons3 t x = TIACons2 t (TIACons1 t x)
  type TIACons4 t x = TIACons2 t (TIACons2 t x)
  type TIACons7 t x = TIACons4 t (TIACons3 t x)


%************************************************************************
%*									*
\subsection{Checking a theta or source type}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="checkValidTheta"></a><span class='hs-definition'>checkValidTheta</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-definition'>checkValidTheta</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>theta</span> 
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>checkThetaCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>theta</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>check_valid_theta</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>theta</span><span class='hs-layout'>)</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="check_valid_theta"></a><span class='hs-comment'>-------------------------</span>
<a name="line-6"></a><span class='hs-definition'>check_valid_theta</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PredType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-7"></a><span class='hs-definition'>check_valid_theta</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-9"></a><span class='hs-definition'>check_valid_theta</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-10"></a>    <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDOpts</span>
<a name="line-11"></a>    <span class='hs-varid'>warnTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>notNull</span> <span class='hs-varid'>dups</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>dupPredWarn</span> <span class='hs-varid'>dups</span><span class='hs-layout'>)</span>
<a name="line-12"></a>    <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>check_pred_ty</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>theta</span>
<a name="line-13"></a>  <span class='hs-keyword'>where</span>
<a name="line-14"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>dups</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>removeDups</span> <span class='hs-varid'>cmpPred</span> <span class='hs-varid'>theta</span>
<a name="line-15"></a>
<a name="line-16"></a><a name="check_pred_ty"></a><span class='hs-comment'>-------------------------</span>
<a name="line-17"></a><span class='hs-definition'>check_pred_ty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-18"></a><span class='hs-definition'>check_pred_ty</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>check_pred_ty'</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>shallowPredTypePredTree</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="check_pred_ty'"></a><span class='hs-definition'>check_pred_ty'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredTree</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-21"></a><span class='hs-definition'>check_pred_ty'</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClassPred</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-22"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>	<span class='hs-comment'>-- Class predicates are valid in all contexts</span>
<a name="line-23"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>arity</span> <span class='hs-varop'>==</span> <span class='hs-varid'>n_tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>arity_err</span>
<a name="line-24"></a>
<a name="line-25"></a>		<span class='hs-comment'>-- Check the form of the argument types</span>
<a name="line-26"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>checkValidMonoType</span> <span class='hs-varid'>tys</span>
<a name="line-27"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>check_class_pred_tys</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-28"></a>		 <span class='hs-layout'>(</span><span class='hs-varid'>predTyVarErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkClassPred</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>how_to_allow</span><span class='hs-layout'>)</span>
<a name="line-29"></a>       <span class='hs-layout'>}</span>
<a name="line-30"></a>  <span class='hs-keyword'>where</span>
<a name="line-31"></a>    <span class='hs-varid'>class_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>className</span> <span class='hs-varid'>cls</span>
<a name="line-32"></a>    <span class='hs-varid'>arity</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>classArity</span> <span class='hs-varid'>cls</span>
<a name="line-33"></a>    <span class='hs-varid'>n_tys</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span>
<a name="line-34"></a>    <span class='hs-varid'>arity_err</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arityErr</span> <span class='hs-str'>"Class"</span> <span class='hs-varid'>class_name</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>n_tys</span>
<a name="line-35"></a>    <span class='hs-varid'>how_to_allow</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Use -XFlexibleContexts to permit this"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-36"></a>
<a name="line-37"></a>
<a name="line-38"></a><span class='hs-definition'>check_pred_ty'</span> <span class='hs-varid'>dflags</span> <span class='hs-sel'>_ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>EqPred</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-39"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>	<span class='hs-comment'>-- Equational constraints are valid in all contexts if type</span>
<a name="line-40"></a>		<span class='hs-comment'>-- families are permitted</span>
<a name="line-41"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>xopt</span> <span class='hs-conid'>Opt_TypeFamilies</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>||</span> <span class='hs-varid'>xopt</span> <span class='hs-conid'>Opt_GADTs</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> 
<a name="line-42"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>eqPredTyErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkEqPred</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-43"></a>
<a name="line-44"></a>		<span class='hs-comment'>-- Check the form of the argument types</span>
<a name="line-45"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkValidMonoType</span> <span class='hs-varid'>ty1</span>
<a name="line-46"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkValidMonoType</span> <span class='hs-varid'>ty2</span>
<a name="line-47"></a>       <span class='hs-layout'>}</span>
<a name="line-48"></a>
<a name="line-49"></a><span class='hs-definition'>check_pred_ty'</span> <span class='hs-keyword'>_</span> <span class='hs-sel'>_ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>IPPred</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkValidMonoType</span> <span class='hs-varid'>ty</span>
<a name="line-50"></a>	<span class='hs-comment'>-- Contrary to GHC 7.2 and below, we allow implicit parameters not only</span>
<a name="line-51"></a>	<span class='hs-comment'>-- in type signatures but also in instance decls, superclasses etc</span>
<a name="line-52"></a>	<span class='hs-comment'>-- The reason we didn't allow implicit params in instances is a bit</span>
<a name="line-53"></a>	<span class='hs-comment'>-- subtle:</span>
<a name="line-54"></a>	<span class='hs-comment'>-- If we allowed	instance (?x::Int, Eq a) =&gt; Foo [a] where ...</span>
<a name="line-55"></a>	<span class='hs-comment'>-- then when we saw (e :: (?x::Int) =&gt; t) it would be unclear how to </span>
<a name="line-56"></a>	<span class='hs-comment'>-- discharge all the potential usas of the ?x in e.   For example, a</span>
<a name="line-57"></a>	<span class='hs-comment'>-- constraint Foo [Int] might come out of e,and applying the</span>
<a name="line-58"></a>	<span class='hs-comment'>-- instance decl would show up two uses of ?x.</span>
<a name="line-59"></a>        <span class='hs-comment'>--</span>
<a name="line-60"></a>        <span class='hs-comment'>-- Happily this is not an issue in the new constraint solver.</span>
<a name="line-61"></a>
<a name="line-62"></a><span class='hs-definition'>check_pred_ty'</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>t</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TuplePred</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span>
<a name="line-63"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>xopt</span> <span class='hs-conid'>Opt_ConstraintKinds</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-64"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>predTupleErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>predTreePredType</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-65"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>check_pred_ty</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>ts</span> <span class='hs-layout'>}</span>
<a name="line-66"></a>    <span class='hs-comment'>-- This case will not normally be executed because without -XConstraintKinds</span>
<a name="line-67"></a>    <span class='hs-comment'>-- tuple types are only kind-checked as *</span>
<a name="line-68"></a>
<a name="line-69"></a><span class='hs-definition'>check_pred_ty'</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>IrredPred</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span>
<a name="line-70"></a>    <span class='hs-comment'>-- Allowing irreducible predicates in class superclasses is somewhat dangerous</span>
<a name="line-71"></a>    <span class='hs-comment'>-- because we can write:</span>
<a name="line-72"></a>    <span class='hs-comment'>--</span>
<a name="line-73"></a>    <span class='hs-comment'>--  type family Fooish x :: * -&gt; Constraint</span>
<a name="line-74"></a>    <span class='hs-comment'>--  type instance Fooish () = Foo</span>
<a name="line-75"></a>    <span class='hs-comment'>--  class Fooish () a =&gt; Foo a where</span>
<a name="line-76"></a>    <span class='hs-comment'>--</span>
<a name="line-77"></a>    <span class='hs-comment'>-- This will cause the constraint simplifier to loop because every time we canonicalise a</span>
<a name="line-78"></a>    <span class='hs-comment'>-- (Foo a) class constraint we add a (Fooish () a) constraint which will be immediately</span>
<a name="line-79"></a>    <span class='hs-comment'>-- solved to add+canonicalise another (Foo a) constraint.</span>
<a name="line-80"></a>    <span class='hs-comment'>--</span>
<a name="line-81"></a>    <span class='hs-comment'>-- It is equally dangerous to allow them in instance heads because in that case the</span>
<a name="line-82"></a>    <span class='hs-comment'>-- Paterson conditions may not detect duplication of a type variable or size change.</span>
<a name="line-83"></a>    <span class='hs-comment'>--</span>
<a name="line-84"></a>    <span class='hs-comment'>-- In both cases it's OK if the predicate is actually a synonym, though.</span>
<a name="line-85"></a>    <span class='hs-comment'>-- We'll also allow it if</span>
<a name="line-86"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>xopt</span> <span class='hs-conid'>Opt_ConstraintKinds</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-87"></a>               <span class='hs-layout'>(</span><span class='hs-varid'>predIrredErr</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span>
<a name="line-88"></a>       <span class='hs-keyword'>case</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>pred</span> <span class='hs-keyword'>of</span>
<a name="line-89"></a>         <span class='hs-conid'>Just</span> <span class='hs-varid'>pred'</span> <span class='hs-keyglyph'>-&gt;</span> 
<a name="line-90"></a>           <span class='hs-comment'>-- Synonym: just look through</span>
<a name="line-91"></a>           <span class='hs-varid'>check_pred_ty</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>pred'</span>
<a name="line-92"></a>         <span class='hs-conid'>Nothing</span>
<a name="line-93"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>xopt</span> <span class='hs-conid'>Opt_UndecidableInstances</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-94"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-95"></a>             <span class='hs-comment'>-- Make sure it is OK to have an irred pred in this context</span>
<a name="line-96"></a>             <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-keyword'>case</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>of</span> <span class='hs-conid'>ClassSCCtxt</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span><span class='hs-layout'>;</span> <span class='hs-conid'>InstDeclCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span><span class='hs-layout'>;</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span>
<a name="line-97"></a>                     <span class='hs-layout'>(</span><span class='hs-varid'>predIrredBadCtxtErr</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span>
<a name="line-98"></a>
<a name="line-99"></a><a name="check_class_pred_tys"></a><span class='hs-comment'>-------------------------</span>
<a name="line-100"></a><span class='hs-definition'>check_class_pred_tys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>KindOrType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-101"></a><span class='hs-definition'>check_class_pred_tys</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>kts</span>
<a name="line-102"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>of</span>
<a name="line-103"></a>	<span class='hs-conid'>SpecInstCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>	<span class='hs-comment'>-- {-# SPECIALISE instance Eq (T Int) #-} is fine</span>
<a name="line-104"></a>	<span class='hs-conid'>InstDeclCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>flexible_contexts</span> <span class='hs-varop'>||</span> <span class='hs-varid'>undecidable_ok</span> <span class='hs-varop'>||</span> <span class='hs-varid'>all</span> <span class='hs-varid'>tcIsTyVarTy</span> <span class='hs-varid'>tys</span>
<a name="line-105"></a>				<span class='hs-comment'>-- Further checks on head and theta in</span>
<a name="line-106"></a>				<span class='hs-comment'>-- checkInstTermination</span>
<a name="line-107"></a>	<span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>flexible_contexts</span> <span class='hs-varop'>||</span> <span class='hs-varid'>all</span> <span class='hs-varid'>tyvar_head</span> <span class='hs-varid'>tys</span>
<a name="line-108"></a>  <span class='hs-keyword'>where</span>
<a name="line-109"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>span</span> <span class='hs-varid'>isKind</span> <span class='hs-varid'>kts</span>  <span class='hs-comment'>-- see Note [Kind polymorphic type classes]</span>
<a name="line-110"></a>    <span class='hs-varid'>flexible_contexts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xopt</span> <span class='hs-conid'>Opt_FlexibleContexts</span> <span class='hs-varid'>dflags</span>
<a name="line-111"></a>    <span class='hs-varid'>undecidable_ok</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xopt</span> <span class='hs-conid'>Opt_UndecidableInstances</span> <span class='hs-varid'>dflags</span>
<a name="line-112"></a>
<a name="line-113"></a><span class='hs-comment'>{-
<a name="line-114"></a>Note [Kind polymorphic type classes]
<a name="line-115"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-116"></a>
<a name="line-117"></a>class C f where
<a name="line-118"></a>  empty :: f a
<a name="line-119"></a>-- C :: forall k. k -&gt; Constraint
<a name="line-120"></a>-- empty :: forall (a :: k). f a
<a name="line-121"></a>
<a name="line-122"></a>MultiParam:
<a name="line-123"></a>~~~~~~~~~~~
<a name="line-124"></a>
<a name="line-125"></a>instance C Maybe where
<a name="line-126"></a>  empty = Nothing
<a name="line-127"></a>
<a name="line-128"></a>The dictionary gets type [C * Maybe] even if it's not a MultiParam
<a name="line-129"></a>type class.
<a name="line-130"></a>
<a name="line-131"></a>Flexible:
<a name="line-132"></a>~~~~~~~~~
<a name="line-133"></a>
<a name="line-134"></a>data D a = D
<a name="line-135"></a>-- D :: forall k. k -&gt; *
<a name="line-136"></a>
<a name="line-137"></a>instance C D where
<a name="line-138"></a>  empty = D
<a name="line-139"></a>
<a name="line-140"></a>The dictionary gets type [C * (D *)]. IA0_TODO it should be
<a name="line-141"></a>generalized actually.
<a name="line-142"></a>
<a name="line-143"></a>-}</span>
<a name="line-144"></a>
<a name="line-145"></a><a name="tyvar_head"></a><span class='hs-comment'>-------------------------</span>
<a name="line-146"></a><span class='hs-definition'>tyvar_head</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-147"></a><span class='hs-definition'>tyvar_head</span> <span class='hs-varid'>ty</span>			<span class='hs-comment'>-- Haskell 98 allows predicates of form </span>
<a name="line-148"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tcIsTyVarTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>	<span class='hs-comment'>-- 	C (a ty1 .. tyn)</span>
<a name="line-149"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>			<span class='hs-comment'>-- where a is a type variable</span>
<a name="line-150"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcSplitAppTy_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-151"></a>	<span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tyvar_head</span> <span class='hs-varid'>ty</span>
<a name="line-152"></a>	<span class='hs-conid'>Nothing</span>	     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
</pre>\end{code}

Check for ambiguity
~~~~~~~~~~~~~~~~~~~
	  forall V. P => tau
is ambiguous if P contains generic variables
(i.e. one of the Vs) that are not mentioned in tau

However, we need to take account of functional dependencies
when we speak of 'mentioned in tau'.  Example:
	class C a b | a -> b where ...
Then the type
	forall x y. (C x y) => x
is not ambiguous because x is mentioned and x determines y

NB; the ambiguity check is only used for *user* types, not for types
coming from inteface files.  The latter can legitimately have
ambiguous types. Example

   class S a where s :: a -> (Int,Int)
   instance S Char where s _ = (1,1)
   f:: S a => [a] -> Int -> (Int,Int)
   f (_::[a]) x = (a*x,b)
	where (a,b) = s (undefined::a)

Here the worker for f gets the type
	fw :: forall a. S a => Int -> (# Int, Int #)

If the list of tv_names is empty, we have a monotype, and then we
don't need to check for ambiguity either, because the test can't fail
(see is_ambig).

In addition, GHC insists that at least one type variable
in each constraint is in V.  So we disallow a type like
	forall a. Eq b => b -> b
even in a scope where b is in scope.

\begin{code}
<pre><a name="line-1"></a><a name="checkAmbiguity"></a><span class='hs-definition'>checkAmbiguity</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-definition'>checkAmbiguity</span> <span class='hs-varid'>forall_tyvars</span> <span class='hs-varid'>theta</span> <span class='hs-varid'>tau_tyvars</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>complain</span> <span class='hs-layout'>(</span><span class='hs-varid'>filter</span> <span class='hs-varid'>is_ambig</span> <span class='hs-varid'>theta</span><span class='hs-layout'>)</span>
<a name="line-4"></a>  <span class='hs-keyword'>where</span>
<a name="line-5"></a>    <span class='hs-varid'>complain</span> <span class='hs-varid'>pred</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ambigErr</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span>
<a name="line-6"></a>    <span class='hs-varid'>extended_tau_vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>growThetaTyVars</span> <span class='hs-varid'>theta</span> <span class='hs-varid'>tau_tyvars</span>
<a name="line-7"></a>
<a name="line-8"></a>	<span class='hs-comment'>-- See Note [Implicit parameters and ambiguity] in TcSimplify</span>
<a name="line-9"></a>    <span class='hs-varid'>is_ambig</span> <span class='hs-varid'>pred</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isClassPred</span>  <span class='hs-varid'>pred</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-10"></a>			<span class='hs-varid'>any</span> <span class='hs-varid'>ambig_var</span> <span class='hs-layout'>(</span><span class='hs-varid'>varSetElems</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-11"></a>
<a name="line-12"></a>    <span class='hs-varid'>ambig_var</span> <span class='hs-varid'>ct_var</span>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct_var</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>forall_tyvars</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-13"></a>		        <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct_var</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>extended_tau_vars</span><span class='hs-layout'>)</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="ambigErr"></a><span class='hs-definition'>ambigErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-16"></a><span class='hs-definition'>ambigErr</span> <span class='hs-varid'>pred</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Ambiguous constraint"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprType</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-18"></a>	 <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"At least one of the forall'd type variables mentioned by the constraint"</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span>
<a name="line-19"></a>		 <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"must be reachable from the type after the '=&gt;'"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
</pre>\end{code}

Note [Growing the tau-tvs using constraints]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
(growInstsTyVars insts tvs) is the result of extending the set 
    of tyvars tvs using all conceivable links from pred

E.g. tvs = {a}, preds = {H [a] b, K (b,Int) c, Eq e}
Then grow precs tvs = {a,b,c}

\begin{code}
<pre><a name="line-1"></a><a name="growThetaTyVars"></a><span class='hs-definition'>growThetaTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVarSet</span>
<a name="line-2"></a><span class='hs-comment'>-- See Note [Growing the tau-tvs using constraints]</span>
<a name="line-3"></a><span class='hs-definition'>growThetaTyVars</span> <span class='hs-varid'>theta</span> <span class='hs-varid'>tvs</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fixVarSet</span> <span class='hs-varid'>mk_next</span> <span class='hs-varid'>tvs</span>
<a name="line-6"></a>  <span class='hs-keyword'>where</span>
<a name="line-7"></a>    <span class='hs-varid'>mk_next</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>grow_one</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>theta</span>
<a name="line-8"></a>    <span class='hs-varid'>grow_one</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>growPredTyVars</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tvs</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="growPredTyVars"></a><span class='hs-definition'>growPredTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPredType</span>
<a name="line-11"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVarSet</span>	<span class='hs-comment'>-- The set to extend</span>
<a name="line-12"></a>	       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVarSet</span>	<span class='hs-comment'>-- TyVars of the predicate if it intersects</span>
<a name="line-13"></a>	       	  		<span class='hs-comment'>-- the set, or is implicit parameter</span>
<a name="line-14"></a><span class='hs-definition'>growPredTyVars</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>classifyPredType</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span>
<a name="line-15"></a>  <span class='hs-keyword'>where</span>
<a name="line-16"></a>    <span class='hs-varid'>grow</span> <span class='hs-varid'>pred_tvs</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>pred_tvs</span> <span class='hs-varop'>`intersectsVarSet`</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pred_tvs</span>
<a name="line-17"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-18"></a>
<a name="line-19"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>IPPred</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>ty</span> <span class='hs-comment'>-- See Note [Implicit parameters and ambiguity]</span>
<a name="line-20"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClassPred</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>grow</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfTypes</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-21"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>EqPred</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>grow</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-22"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TuplePred</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unionVarSets</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varop'>.</span> <span class='hs-varid'>classifyPredType</span><span class='hs-layout'>)</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span>
<a name="line-23"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>IrredPred</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>grow</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
</pre>\end{code}
    
Note [Implicit parameters and ambiguity] 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Only a *class* predicate can give rise to ambiguity
An *implicit parameter* cannot.  For example:
	foo :: (?x :: [a]) => Int
	foo = length ?x
is fine.  The call site will suppply a particular 'x'

Furthermore, the type variables fixed by an implicit parameter
propagate to the others.  E.g.
	foo :: (Show a, ?x::[a]) => Int
	foo = show (?x++?x)
The type of foo looks ambiguous.  But it isn't, because at a call site
we might have
	let ?x = 5::Int in foo
and all is well.  In effect, implicit parameters are, well, parameters,
so we can take their type variables into account as part of the
"tau-tvs" stuff.  This is done in the function 'FunDeps.grow'.


\begin{code}
<pre><a name="line-1"></a><a name="checkThetaCtxt"></a><span class='hs-definition'>checkThetaCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2"></a><span class='hs-definition'>checkThetaCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>theta</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In the context:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprTheta</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span>
<a name="line-4"></a>	  <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"While checking"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprUserTypeCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>]</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="eqPredTyErr"></a><span class='hs-definition'>eqPredTyErr</span><span class='hs-layout'>,</span> <span class='hs-varid'>predTyVarErr</span><span class='hs-layout'>,</span> <span class='hs-varid'>predTupleErr</span><span class='hs-layout'>,</span> <span class='hs-varid'>predIrredErr</span><span class='hs-layout'>,</span> <span class='hs-varid'>predIrredBadCtxtErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-7"></a><span class='hs-definition'>eqPredTyErr</span>  <span class='hs-varid'>pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal equational constraint"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprType</span> <span class='hs-varid'>pred</span>
<a name="line-8"></a>		    <span class='hs-varop'>$$</span>
<a name="line-9"></a>		    <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Use -XGADTs or -XTypeFamilies to permit this"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-10"></a><a name="predTyVarErr"></a><span class='hs-definition'>predTyVarErr</span> <span class='hs-varid'>pred</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Non type-variable argument"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-11"></a>			  <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"in the constraint:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprType</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-12"></a><a name="predTupleErr"></a><span class='hs-definition'>predTupleErr</span> <span class='hs-varid'>pred</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal tuple constraint"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprType</span> <span class='hs-varid'>pred</span> <span class='hs-varop'>$$</span>
<a name="line-13"></a>                     <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Use -XConstraintKinds to permit this"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-14"></a><a name="predIrredErr"></a><span class='hs-definition'>predIrredErr</span> <span class='hs-varid'>pred</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal irreducible constraint"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprType</span> <span class='hs-varid'>pred</span> <span class='hs-varop'>$$</span>
<a name="line-15"></a>                     <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Use -XConstraintKinds to permit this"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-16"></a><a name="predIrredBadCtxtErr"></a><span class='hs-definition'>predIrredBadCtxtErr</span> <span class='hs-varid'>pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal irreducible constraint"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprType</span> <span class='hs-varid'>pred</span> <span class='hs-varop'>$$</span>
<a name="line-17"></a>                           <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"in superclass/instance head context"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-18"></a>                           <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Use -XUndecidableInstances to permit this"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-19"></a><a name="dupPredWarn"></a><span class='hs-definition'>dupPredWarn</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>PredType</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-20"></a><span class='hs-definition'>dupPredWarn</span> <span class='hs-varid'>dups</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Duplicate constraint(s):"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprWithCommas</span> <span class='hs-varid'>pprType</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>head</span> <span class='hs-varid'>dups</span><span class='hs-layout'>)</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="arityErr"></a><span class='hs-definition'>arityErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-23"></a><span class='hs-definition'>arityErr</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>name</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span>
<a name="line-24"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-varid'>kind</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"should have"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-25"></a>	   <span class='hs-varid'>n_arguments</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"but has been given"</span><span class='hs-layout'>,</span> 
<a name="line-26"></a>           <span class='hs-keyword'>if</span> <span class='hs-varid'>m</span><span class='hs-varop'>==</span><span class='hs-num'>0</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>text</span> <span class='hs-str'>"none"</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>int</span> <span class='hs-varid'>m</span><span class='hs-keyglyph'>]</span>
<a name="line-27"></a>    <span class='hs-keyword'>where</span>
<a name="line-28"></a>	<span class='hs-varid'>n_arguments</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"no arguments"</span><span class='hs-layout'>)</span>
<a name="line-29"></a>		    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>==</span> <span class='hs-num'>1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"1 argument"</span><span class='hs-layout'>)</span>
<a name="line-30"></a>		    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>True</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>int</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"arguments"</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
</pre>\end{code}

%************************************************************************
%*									*
\subsection{Checking for a decent instance head type}
%*									*
%************************************************************************

@checkValidInstHead@ checks the type {\em and} its syntactic constraints:
it must normally look like: @instance Foo (Tycon a b c ...) ...@

The exceptions to this syntactic checking: (1)~if the @GlasgowExts@
flag is on, or (2)~the instance is imported (they must have been
compiled elsewhere). In these cases, we let them go through anyway.

We can also have instances for functions: @instance Foo (a -> b) ...@.

\begin{code}
<pre><a name="line-1"></a><a name="checkValidInstHead"></a><span class='hs-definition'>checkValidInstHead</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-definition'>checkValidInstHead</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tys</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDOpts</span>
<a name="line-4"></a>
<a name="line-5"></a>           <span class='hs-comment'>-- Check language restrictions; </span>
<a name="line-6"></a>           <span class='hs-comment'>-- but not for SPECIALISE isntance pragmas</span>
<a name="line-7"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-varid'>spec_inst_prag</span> <span class='hs-varop'>$</span>
<a name="line-8"></a>         <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>xopt</span> <span class='hs-conid'>Opt_TypeSynonymInstances</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>||</span>
<a name="line-9"></a>                       <span class='hs-varid'>all</span> <span class='hs-varid'>tcInstHeadTyNotSynonym</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-10"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>instTypeErr</span> <span class='hs-varid'>pp_pred</span> <span class='hs-varid'>head_type_synonym_msg</span><span class='hs-layout'>)</span>
<a name="line-11"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>xopt</span> <span class='hs-conid'>Opt_FlexibleInstances</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>||</span>
<a name="line-12"></a>                       <span class='hs-varid'>all</span> <span class='hs-varid'>tcInstHeadTyAppAllTyVars</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-13"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>instTypeErr</span> <span class='hs-varid'>pp_pred</span> <span class='hs-varid'>head_type_args_tyvars_msg</span><span class='hs-layout'>)</span>
<a name="line-14"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>xopt</span> <span class='hs-conid'>Opt_MultiParamTypeClasses</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>||</span>
<a name="line-15"></a>                       <span class='hs-varid'>isSingleton</span> <span class='hs-layout'>(</span><span class='hs-varid'>dropWhile</span> <span class='hs-varid'>isKind</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- IA0_NOTE: only count type arguments</span>
<a name="line-16"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>instTypeErr</span> <span class='hs-varid'>pp_pred</span> <span class='hs-varid'>head_one_type_msg</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-17"></a>
<a name="line-18"></a>         <span class='hs-comment'>-- May not contain type family applications</span>
<a name="line-19"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>checkTyFamFreeness</span> <span class='hs-varid'>tys</span>
<a name="line-20"></a>
<a name="line-21"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>checkValidMonoType</span> <span class='hs-varid'>tys</span>
<a name="line-22"></a>	<span class='hs-comment'>-- For now, I only allow tau-types (not polytypes) in </span>
<a name="line-23"></a>	<span class='hs-comment'>-- the head of an instance decl.  </span>
<a name="line-24"></a>	<span class='hs-comment'>-- 	E.g.  instance C (forall a. a-&gt;a) is rejected</span>
<a name="line-25"></a>	<span class='hs-comment'>-- One could imagine generalising that, but I'm not sure</span>
<a name="line-26"></a>	<span class='hs-comment'>-- what all the consequences might be</span>
<a name="line-27"></a>       <span class='hs-layout'>}</span>
<a name="line-28"></a>
<a name="line-29"></a>  <span class='hs-keyword'>where</span>
<a name="line-30"></a>    <span class='hs-varid'>spec_inst_prag</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span> <span class='hs-conid'>SpecInstCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span><span class='hs-layout'>;</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span> <span class='hs-layout'>}</span>
<a name="line-31"></a>
<a name="line-32"></a>    <span class='hs-varid'>pp_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprClassPred</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tys</span>
<a name="line-33"></a>    <span class='hs-varid'>head_type_synonym_msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span>
<a name="line-34"></a>                <span class='hs-varid'>text</span> <span class='hs-str'>"All instance types must be of the form (T t1 ... tn)"</span> <span class='hs-varop'>$$</span>
<a name="line-35"></a>                <span class='hs-varid'>text</span> <span class='hs-str'>"where T is not a synonym."</span> <span class='hs-varop'>$$</span>
<a name="line-36"></a>                <span class='hs-varid'>text</span> <span class='hs-str'>"Use -XTypeSynonymInstances if you want to disable this."</span><span class='hs-layout'>)</span>
<a name="line-37"></a>
<a name="line-38"></a>    <span class='hs-varid'>head_type_args_tyvars_msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span>
<a name="line-39"></a>                <span class='hs-varid'>text</span> <span class='hs-str'>"All instance types must be of the form (T a1 ... an)"</span><span class='hs-layout'>,</span>
<a name="line-40"></a>                <span class='hs-varid'>text</span> <span class='hs-str'>"where a1 ... an are *distinct type variables*,"</span><span class='hs-layout'>,</span>
<a name="line-41"></a>                <span class='hs-varid'>text</span> <span class='hs-str'>"and each type variable appears at most once in the instance head."</span><span class='hs-layout'>,</span>
<a name="line-42"></a>                <span class='hs-varid'>text</span> <span class='hs-str'>"Use -XFlexibleInstances if you want to disable this."</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-43"></a>
<a name="line-44"></a>    <span class='hs-varid'>head_one_type_msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span>
<a name="line-45"></a>                <span class='hs-varid'>text</span> <span class='hs-str'>"Only one type can be given in an instance head."</span> <span class='hs-varop'>$$</span>
<a name="line-46"></a>                <span class='hs-varid'>text</span> <span class='hs-str'>"Use -XMultiParamTypeClasses if you want to allow more."</span><span class='hs-layout'>)</span>
<a name="line-47"></a>
<a name="line-48"></a><a name="instTypeErr"></a><span class='hs-definition'>instTypeErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-49"></a><span class='hs-definition'>instTypeErr</span> <span class='hs-varid'>pp_ty</span> <span class='hs-varid'>msg</span>
<a name="line-50"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal instance declaration for"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-varid'>pp_ty</span><span class='hs-layout'>,</span> 
<a name="line-51"></a>	 <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varid'>msg</span><span class='hs-keyglyph'>]</span>
</pre>\end{code}

validDeivPred checks for OK 'deriving' context.  See Note [Exotic
derived instance contexts] in TcSimplify.  However the predicate is
here because it uses sizeTypes, fvTypes.

Also check for a bizarre corner case, when the derived instance decl 
would look like
    instance C a b => D (T a) where ...
Note that 'b' isn't a parameter of T.  This gives rise to all sorts of
problems; in particular, it's hard to compare solutions for equality
when finding the fixpoint, and that means the inferContext loop does
not converge.  See Trac #5287.

\begin{code}
<pre><a name="line-1"></a><a name="validDerivPred"></a><span class='hs-definition'>validDerivPred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2"></a><span class='hs-definition'>validDerivPred</span> <span class='hs-varid'>tv_set</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>getClassPredTys_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-3"></a>  <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvTypes</span> <span class='hs-varid'>tys</span>
<a name="line-4"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>hasNoDups</span> <span class='hs-varid'>fvs</span> 
<a name="line-5"></a>                <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>sizeTypes</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>fvs</span>
<a name="line-6"></a>                <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>all</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>tv_set</span><span class='hs-layout'>)</span> <span class='hs-varid'>fvs</span>
<a name="line-7"></a>  <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
</pre>\end{code}


%************************************************************************
%*									*
\subsection{Checking instance for termination}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="checkValidInstance"></a><span class='hs-definition'>checkValidInstance</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThetaType</span>
<a name="line-2"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-3"></a><span class='hs-definition'>checkValidInstance</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>hs_type</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>theta</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>inst_tys</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLoc</span> <span class='hs-varid'>hs_type</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-5"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>head_loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>checkValidInstHead</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>inst_tys</span><span class='hs-layout'>)</span>
<a name="line-6"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkValidTheta</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>theta</span>
<a name="line-7"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>checkAmbiguity</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>theta</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfTypes</span> <span class='hs-varid'>inst_tys</span><span class='hs-layout'>)</span>
<a name="line-8"></a>
<a name="line-9"></a>	<span class='hs-comment'>-- Check that instance inference will terminate (if we care)</span>
<a name="line-10"></a>	<span class='hs-comment'>-- For Haskell 98 this will already have been done by checkValidTheta,</span>
<a name="line-11"></a>        <span class='hs-comment'>-- but as we may be using other extensions we need to check.</span>
<a name="line-12"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>undecidable_ok</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_UndecidableInstances</span>
<a name="line-13"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-varid'>undecidable_ok</span> <span class='hs-varop'>$</span>
<a name="line-14"></a>	  <span class='hs-varid'>mapM_</span> <span class='hs-varid'>addErrTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>checkInstTermination</span> <span class='hs-varid'>inst_tys</span> <span class='hs-varid'>theta</span><span class='hs-layout'>)</span>
<a name="line-15"></a>	
<a name="line-16"></a>	<span class='hs-comment'>-- The Coverage Condition</span>
<a name="line-17"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>undecidable_ok</span> <span class='hs-varop'>||</span> <span class='hs-varid'>checkInstCoverage</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>inst_tys</span><span class='hs-layout'>)</span>
<a name="line-18"></a>	  	  <span class='hs-layout'>(</span><span class='hs-varid'>instTypeErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprClassPred</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>inst_tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span>
<a name="line-19"></a>        <span class='hs-layout'>}</span>
<a name="line-20"></a>  <span class='hs-keyword'>where</span>
<a name="line-21"></a>    <span class='hs-varid'>msg</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the Coverage Condition fails for one of the functional dependencies;"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-22"></a>			 <span class='hs-varid'>undecidableMsg</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-23"></a>
<a name="line-24"></a>        <span class='hs-comment'>-- The location of the "head" of the instance</span>
<a name="line-25"></a>    <span class='hs-varid'>head_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>hs_type</span> <span class='hs-keyword'>of</span>
<a name="line-26"></a>                 <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsForAllTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>loc</span>
<a name="line-27"></a>                 <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-keyword'>_</span>                          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>loc</span>
</pre>\end{code}

Note [Paterson conditions]
~~~~~~~~~~~~~~~~~~~~~~~~~~

Termination test: the so-called "Paterson conditions" (see Section 5 of
"Understanding functionsl dependencies via Constraint Handling Rules, 
JFP Jan 2007).

We check that each assertion in the context satisfies:
 (1) no variable has more occurrences in the assertion than in the head, and
 (2) the assertion has fewer constructors and variables (taken together
     and counting repetitions) than the head.
This is only needed with -fglasgow-exts, as Haskell 98 restrictions
(which have already been checked) guarantee termination. 

The underlying idea is that 

    for any ground substitution, each assertion in the
    context has fewer type constructors than the head.


\begin{code}
<pre><a name="line-1"></a><a name="checkInstTermination"></a><span class='hs-definition'>checkInstTermination</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Message</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-definition'>checkInstTermination</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>theta</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapCatMaybes</span> <span class='hs-varid'>check</span> <span class='hs-varid'>theta</span>
<a name="line-4"></a>  <span class='hs-keyword'>where</span>
<a name="line-5"></a>   <span class='hs-varid'>fvs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvTypes</span> <span class='hs-varid'>tys</span>
<a name="line-6"></a>   <span class='hs-varid'>size</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sizeTypes</span> <span class='hs-varid'>tys</span>
<a name="line-7"></a>   <span class='hs-varid'>check</span> <span class='hs-varid'>pred</span> 
<a name="line-8"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>fvType</span> <span class='hs-varid'>pred</span> <span class='hs-varop'>\\</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-9"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>predUndecErr</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>nomoreMsg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>parens</span> <span class='hs-varid'>undecidableMsg</span><span class='hs-layout'>)</span>
<a name="line-10"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>sizePred</span> <span class='hs-varid'>pred</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>size</span>
<a name="line-11"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>predUndecErr</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>smallerMsg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>parens</span> <span class='hs-varid'>undecidableMsg</span><span class='hs-layout'>)</span>
<a name="line-12"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-13"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="predUndecErr"></a><span class='hs-definition'>predUndecErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-16"></a><span class='hs-definition'>predUndecErr</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>msg</span><span class='hs-layout'>,</span>
<a name="line-17"></a>			<span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"in the constraint:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprType</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="nomoreMsg"></a><span class='hs-definition'>nomoreMsg</span><span class='hs-layout'>,</span> <span class='hs-varid'>smallerMsg</span><span class='hs-layout'>,</span> <span class='hs-varid'>undecidableMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span>
<a name="line-20"></a><span class='hs-definition'>nomoreMsg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Variable occurs more often in a constraint than in the instance head"</span><span class='hs-layout'>)</span>
<a name="line-21"></a><a name="smallerMsg"></a><span class='hs-definition'>smallerMsg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Constraint is no smaller than the instance head"</span><span class='hs-layout'>)</span>
<a name="line-22"></a><a name="undecidableMsg"></a><span class='hs-definition'>undecidableMsg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Use -XUndecidableInstances to permit this"</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*									*
	Checking type instance well-formedness and termination
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="checkValidFamInst"></a><span class='hs-comment'>-- Check that a "type instance" is well-formed (which includes decidability</span>
<a name="line-2"></a><span class='hs-comment'>-- unless -XUndecidableInstances is given).</span>
<a name="line-3"></a><span class='hs-comment'>--</span>
<a name="line-4"></a><span class='hs-definition'>checkValidFamInst</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-5"></a><span class='hs-definition'>checkValidFamInst</span> <span class='hs-varid'>typats</span> <span class='hs-varid'>rhs</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- left-hand side contains no type family applications</span>
<a name="line-7"></a>         <span class='hs-comment'>-- (vanilla synonyms are fine, though)</span>
<a name="line-8"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>checkTyFamFreeness</span> <span class='hs-varid'>typats</span>
<a name="line-9"></a>
<a name="line-10"></a>         <span class='hs-comment'>-- the right-hand side is a tau type</span>
<a name="line-11"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkValidMonoType</span> <span class='hs-varid'>rhs</span>
<a name="line-12"></a>
<a name="line-13"></a>         <span class='hs-comment'>-- we have a decidable instance unless otherwise permitted</span>
<a name="line-14"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>undecidable_ok</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_UndecidableInstances</span>
<a name="line-15"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-varid'>undecidable_ok</span> <span class='hs-varop'>$</span>
<a name="line-16"></a>	   <span class='hs-varid'>mapM_</span> <span class='hs-varid'>addErrTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>checkFamInstRhs</span> <span class='hs-varid'>typats</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcTyFamInsts</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-17"></a>       <span class='hs-layout'>}</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="checkFamInstRhs"></a><span class='hs-comment'>-- Make sure that each type family instance is </span>
<a name="line-20"></a><span class='hs-comment'>--   (1) strictly smaller than the lhs,</span>
<a name="line-21"></a><span class='hs-comment'>--   (2) mentions no type variable more often than the lhs, and</span>
<a name="line-22"></a><span class='hs-comment'>--   (3) does not contain any further type family instances.</span>
<a name="line-23"></a><span class='hs-comment'>--</span>
<a name="line-24"></a><span class='hs-definition'>checkFamInstRhs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>                  <span class='hs-comment'>-- lhs</span>
<a name="line-25"></a>             	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TyCon</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>       <span class='hs-comment'>-- type family instances</span>
<a name="line-26"></a>             	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Message</span><span class='hs-keyglyph'>]</span>
<a name="line-27"></a><span class='hs-definition'>checkFamInstRhs</span> <span class='hs-varid'>lhsTys</span> <span class='hs-varid'>famInsts</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapCatMaybes</span> <span class='hs-varid'>check</span> <span class='hs-varid'>famInsts</span>
<a name="line-29"></a>  <span class='hs-keyword'>where</span>
<a name="line-30"></a>   <span class='hs-varid'>size</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sizeTypes</span> <span class='hs-varid'>lhsTys</span>
<a name="line-31"></a>   <span class='hs-varid'>fvs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvTypes</span> <span class='hs-varid'>lhsTys</span>
<a name="line-32"></a>   <span class='hs-varid'>check</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-33"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>all</span> <span class='hs-varid'>isTyFamFree</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-34"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>famInstUndecErr</span> <span class='hs-varid'>famInst</span> <span class='hs-varid'>nestedMsg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>parens</span> <span class='hs-varid'>undecidableMsg</span><span class='hs-layout'>)</span>
<a name="line-35"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>fvTypes</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>\\</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-36"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>famInstUndecErr</span> <span class='hs-varid'>famInst</span> <span class='hs-varid'>nomoreVarMsg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>parens</span> <span class='hs-varid'>undecidableMsg</span><span class='hs-layout'>)</span>
<a name="line-37"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>size</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>sizeTypes</span> <span class='hs-varid'>tys</span>
<a name="line-38"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>famInstUndecErr</span> <span class='hs-varid'>famInst</span> <span class='hs-varid'>smallerAppMsg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>parens</span> <span class='hs-varid'>undecidableMsg</span><span class='hs-layout'>)</span>
<a name="line-39"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-40"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-41"></a>      <span class='hs-keyword'>where</span>
<a name="line-42"></a>        <span class='hs-varid'>famInst</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-43"></a>
<a name="line-44"></a><a name="checkTyFamFreeness"></a><span class='hs-comment'>-- Ensure that no type family instances occur in a type.</span>
<a name="line-45"></a><span class='hs-comment'>--</span>
<a name="line-46"></a><span class='hs-definition'>checkTyFamFreeness</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-47"></a><span class='hs-definition'>checkTyFamFreeness</span> <span class='hs-varid'>ty</span>
<a name="line-48"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTyFamFree</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-49"></a>      <span class='hs-varid'>tyFamInstIllegalErr</span> <span class='hs-varid'>ty</span>
<a name="line-50"></a>
<a name="line-51"></a><a name="isTyFamFree"></a><span class='hs-comment'>-- Check that a type does not contain any type family applications.</span>
<a name="line-52"></a><span class='hs-comment'>--</span>
<a name="line-53"></a><span class='hs-definition'>isTyFamFree</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-54"></a><span class='hs-definition'>isTyFamFree</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>null</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tcTyFamInsts</span>
<a name="line-55"></a>
<a name="line-56"></a><span class='hs-comment'>-- Error messages</span>
<a name="line-57"></a>
<a name="line-58"></a><a name="tyFamInstIllegalErr"></a><span class='hs-definition'>tyFamInstIllegalErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-59"></a><span class='hs-definition'>tyFamInstIllegalErr</span> <span class='hs-varid'>ty</span>
<a name="line-60"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal type synonym family application in instance"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> 
<a name="line-61"></a>         <span class='hs-varid'>colon</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span>
<a name="line-62"></a>      <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span>
<a name="line-63"></a>
<a name="line-64"></a><a name="famInstUndecErr"></a><span class='hs-definition'>famInstUndecErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-65"></a><span class='hs-definition'>famInstUndecErr</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>msg</span> 
<a name="line-66"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>msg</span><span class='hs-layout'>,</span> 
<a name="line-67"></a>         <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"in the type family application:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> 
<a name="line-68"></a>                 <span class='hs-varid'>pprType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-69"></a>
<a name="line-70"></a><a name="nestedMsg"></a><span class='hs-definition'>nestedMsg</span><span class='hs-layout'>,</span> <span class='hs-varid'>nomoreVarMsg</span><span class='hs-layout'>,</span> <span class='hs-varid'>smallerAppMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span>
<a name="line-71"></a><span class='hs-definition'>nestedMsg</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Nested type family application"</span><span class='hs-layout'>)</span>
<a name="line-72"></a><a name="nomoreVarMsg"></a><span class='hs-definition'>nomoreVarMsg</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Variable occurs more often than in instance head"</span><span class='hs-layout'>)</span>
<a name="line-73"></a><a name="smallerAppMsg"></a><span class='hs-definition'>smallerAppMsg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Application is no smaller than the instance head"</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*									*
\subsection{Auxiliary functions}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="fvType"></a><span class='hs-comment'>-- Free variables of a type, retaining repetitions, and expanding synonyms</span>
<a name="line-2"></a><span class='hs-definition'>fvType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-3"></a><span class='hs-definition'>fvType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>exp_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvType</span> <span class='hs-varid'>exp_ty</span>
<a name="line-4"></a><span class='hs-definition'>fvType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tv</span><span class='hs-keyglyph'>]</span>
<a name="line-5"></a><span class='hs-definition'>fvType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvTypes</span> <span class='hs-varid'>tys</span>
<a name="line-6"></a><span class='hs-definition'>fvType</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvType</span> <span class='hs-varid'>arg</span> <span class='hs-varop'>++</span> <span class='hs-varid'>fvType</span> <span class='hs-varid'>res</span>
<a name="line-7"></a><span class='hs-definition'>fvType</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvType</span> <span class='hs-varid'>fun</span> <span class='hs-varop'>++</span> <span class='hs-varid'>fvType</span> <span class='hs-varid'>arg</span>
<a name="line-8"></a><span class='hs-definition'>fvType</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tyvar</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varop'>/=</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>fvType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="fvTypes"></a><span class='hs-definition'>fvTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-11"></a><span class='hs-definition'>fvTypes</span> <span class='hs-varid'>tys</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fvType</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="sizeType"></a><span class='hs-definition'>sizeType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-14"></a><span class='hs-comment'>-- Size of a type: the number of variables and constructors</span>
<a name="line-15"></a><span class='hs-definition'>sizeType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>exp_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sizeType</span> <span class='hs-varid'>exp_ty</span>
<a name="line-16"></a><span class='hs-definition'>sizeType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>
<a name="line-17"></a><span class='hs-definition'>sizeType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sizeTypes</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span>
<a name="line-18"></a><span class='hs-definition'>sizeType</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sizeType</span> <span class='hs-varid'>arg</span> <span class='hs-varop'>+</span> <span class='hs-varid'>sizeType</span> <span class='hs-varid'>res</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span>
<a name="line-19"></a><span class='hs-definition'>sizeType</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sizeType</span> <span class='hs-varid'>fun</span> <span class='hs-varop'>+</span> <span class='hs-varid'>sizeType</span> <span class='hs-varid'>arg</span>
<a name="line-20"></a><span class='hs-definition'>sizeType</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sizeType</span> <span class='hs-varid'>ty</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="sizeTypes"></a><span class='hs-definition'>sizeTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-23"></a><span class='hs-comment'>-- IA0_NOTE: Avoid kinds.</span>
<a name="line-24"></a><span class='hs-definition'>sizeTypes</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sum</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>sizeType</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-25"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isKind</span><span class='hs-layout'>)</span> <span class='hs-varid'>xs</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="sizePred"></a><span class='hs-comment'>-- Size of a predicate</span>
<a name="line-28"></a><span class='hs-comment'>--</span>
<a name="line-29"></a><span class='hs-comment'>-- We are considering whether *class* constraints terminate</span>
<a name="line-30"></a><span class='hs-comment'>-- Once we get into an implicit parameter or equality we</span>
<a name="line-31"></a><span class='hs-comment'>-- can't get back to a class constraint, so it's safe</span>
<a name="line-32"></a><span class='hs-comment'>-- to say "size 0".  See Trac #4200.</span>
<a name="line-33"></a><span class='hs-definition'>sizePred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-34"></a><span class='hs-definition'>sizePred</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>classifyPredType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-35"></a>  <span class='hs-keyword'>where</span>
<a name="line-36"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClassPred</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sizeTypes</span> <span class='hs-varid'>tys'</span>
<a name="line-37"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>IPPred</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-38"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>EqPred</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-39"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TuplePred</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sum</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varop'>.</span> <span class='hs-varid'>classifyPredType</span><span class='hs-layout'>)</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span>
<a name="line-40"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>IrredPred</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sizeType</span> <span class='hs-varid'>ty</span>
</pre>\end{code}

Note [Paterson conditions on PredTypes]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We are considering whether *class* constraints terminate
(see Note [Paterson conditions]). Precisely, the Paterson conditions
would have us check that "the constraint has fewer constructors and variables
(taken together and counting repetitions) than the head.".

However, we can be a bit more refined by looking at which kind of constraint
this actually is. There are two main tricks:

 1. It seems like it should be OK not to count the tuple type constructor
    for a PredType like (Show a, Eq a) :: Constraint, since we don't
    count the "implicit" tuple in the ThetaType itself.

    In fact, the Paterson test just checks *each component* of the top level
    ThetaType against the size bound, one at a time. By analogy, it should be
    OK to return the size of the *largest* tuple component as the size of the
    whole tuple.

 2. Once we get into an implicit parameter or equality we
    can't get back to a class constraint, so it's safe
    to say "size 0".  See Trac #4200.

NB: we don't want to detect PredTypes in sizeType (and then call 
sizePred on them), or we might get an infinite loop if that PredType
is irreducible. See Trac #5581.
</body>
</html>
