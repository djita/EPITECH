<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>codeGen/CodeGen.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%

The Code Generator

This module says how things get going at the top level.

@codeGen@ is the interface to the outside world.  The \tr{cgTop*}
functions drive the mangling of top-level bindings.

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>CodeGen</span> <span class='hs-layout'>(</span> <span class='hs-varid'>codeGen</span> <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-comment'>-- Kludge (??) so that CgExpr is reached via at least one non-SOURCE</span>
<a name="line-13"></a><span class='hs-comment'>-- import.  Before, that wasn't the case, and CM therefore didn't </span>
<a name="line-14"></a><span class='hs-comment'>-- bother to compile it.</span>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgExpr</span>           <span class='hs-layout'>(</span> <span class='hs-comment'>{-NOTHING!-}</span> <span class='hs-layout'>)</span>	<span class='hs-comment'>-- DO NOT DELETE THIS IMPORT</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgProf</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgMonad</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgBindery</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgClosure</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgCon</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgUtils</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgHpc</span>
<a name="line-23"></a>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CLabel</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OldCmm</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OldPprCmm</span>
<a name="line-27"></a>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>StgSyn</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>StaticFlags</span>
<a name="line-32"></a>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HscTypes</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CostCentre</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ErrUtils</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Panic</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="codeGen"></a><span class='hs-definition'>codeGen</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span>
<a name="line-2"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span>
<a name="line-3"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCon</span><span class='hs-keyglyph'>]</span>
<a name="line-4"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CollectedCCs</span>         <span class='hs-comment'>-- (Local/global) cost-centres needing declaring/registering.</span>
<a name="line-5"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>StgBinding</span><span class='hs-layout'>,</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>	<span class='hs-comment'>-- Bindings to convert, with SRTs</span>
<a name="line-6"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HpcInfo</span>
<a name="line-7"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmGroup</span><span class='hs-keyglyph'>]</span>          <span class='hs-comment'>-- Output</span>
<a name="line-8"></a>
<a name="line-9"></a>                <span class='hs-comment'>-- N.B. returning '[Cmm]' and not 'Cmm' here makes it</span>
<a name="line-10"></a>                <span class='hs-comment'>-- possible for object splitting to split up the</span>
<a name="line-11"></a>                <span class='hs-comment'>-- pieces later.</span>
<a name="line-12"></a>
<a name="line-13"></a><span class='hs-definition'>codeGen</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>data_tycons</span> <span class='hs-varid'>cost_centre_info</span> <span class='hs-varid'>stg_binds</span> <span class='hs-varid'>hpc_info</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	
<a name="line-15"></a>  <span class='hs-layout'>{</span> <span class='hs-varid'>showPass</span> <span class='hs-varid'>dflags</span> <span class='hs-str'>"CodeGen"</span>
<a name="line-16"></a>
<a name="line-17"></a><span class='hs-comment'>-- Why?</span>
<a name="line-18"></a><span class='hs-comment'>--   ; mapM_ (\x -&gt; seq x (return ())) data_tycons</span>
<a name="line-19"></a>
<a name="line-20"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>code_stuff</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>initC</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>this_mod</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> 
<a name="line-21"></a>		<span class='hs-layout'>{</span> <span class='hs-varid'>cmm_binds</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>getCmm</span> <span class='hs-varop'>.</span> <span class='hs-varid'>cgTopBinding</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varid'>stg_binds</span>
<a name="line-22"></a>		<span class='hs-layout'>;</span> <span class='hs-varid'>cmm_tycons</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>cgTyCon</span> <span class='hs-varid'>data_tycons</span>
<a name="line-23"></a>		<span class='hs-layout'>;</span> <span class='hs-varid'>cmm_init</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCmm</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkModuleInit</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>cost_centre_info</span> 
<a name="line-24"></a>                                             <span class='hs-varid'>this_mod</span> <span class='hs-varid'>hpc_info</span><span class='hs-layout'>)</span>
<a name="line-25"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmm_init</span> <span class='hs-conop'>:</span> <span class='hs-varid'>cmm_binds</span> <span class='hs-varop'>++</span> <span class='hs-varid'>cmm_tycons</span><span class='hs-layout'>)</span>
<a name="line-26"></a>		<span class='hs-layout'>}</span>
<a name="line-27"></a>		<span class='hs-comment'>-- Put datatype_stuff after code_stuff, because the</span>
<a name="line-28"></a>		<span class='hs-comment'>-- datatype closure table (for enumeration types) to</span>
<a name="line-29"></a>		<span class='hs-comment'>-- (say) PrelBase_True_closure, which is defined in</span>
<a name="line-30"></a>		<span class='hs-comment'>-- code_stuff</span>
<a name="line-31"></a>
<a name="line-32"></a>                <span class='hs-comment'>-- Note [codegen-split-init] the cmm_init block must</span>
<a name="line-33"></a>                <span class='hs-comment'>-- come FIRST.  This is because when -split-objs is on</span>
<a name="line-34"></a>                <span class='hs-comment'>-- we need to combine this block with its</span>
<a name="line-35"></a>                <span class='hs-comment'>-- initialisation routines; see Note</span>
<a name="line-36"></a>                <span class='hs-comment'>-- [pipeline-split-init].</span>
<a name="line-37"></a>
<a name="line-38"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>dumpIfSet_dyn</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Opt_D_dump_cmm</span> <span class='hs-str'>"Cmm"</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprCmms</span> <span class='hs-layout'>(</span><span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varid'>code_stuff</span><span class='hs-layout'>)</span>
<a name="line-39"></a>
<a name="line-40"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>code_stuff</span> <span class='hs-layout'>}</span>
<a name="line-41"></a>
<a name="line-42"></a><a name="mkModuleInit"></a><span class='hs-definition'>mkModuleInit</span>
<a name="line-43"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span>
<a name="line-44"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CollectedCCs</span>         <span class='hs-comment'>-- cost centre info</span>
<a name="line-45"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span>
<a name="line-46"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HpcInfo</span>
<a name="line-47"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-48"></a>
<a name="line-49"></a><span class='hs-definition'>mkModuleInit</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>cost_centre_info</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>hpc_info</span>
<a name="line-50"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-comment'>-- Allocate the static boolean that records if this</span>
<a name="line-51"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>whenC</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_Hpc</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-52"></a>              <span class='hs-varid'>hpcTable</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>hpc_info</span>
<a name="line-53"></a>
<a name="line-54"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>whenC</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_SccProfilingOn</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> 
<a name="line-55"></a>	    <span class='hs-varid'>initCostCentres</span> <span class='hs-varid'>cost_centre_info</span>
<a name="line-56"></a>
<a name="line-57"></a>            <span class='hs-comment'>-- For backwards compatibility: user code may refer to this</span>
<a name="line-58"></a>            <span class='hs-comment'>-- label for calling hs_add_root().</span>
<a name="line-59"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>emitDecl</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmData</span> <span class='hs-conid'>Data</span> <span class='hs-layout'>(</span><span class='hs-conid'>Statics</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPlainModuleInitLabel</span> <span class='hs-varid'>this_mod</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-60"></a>
<a name="line-61"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>whenC</span> <span class='hs-layout'>(</span><span class='hs-varid'>this_mod</span> <span class='hs-varop'>==</span> <span class='hs-varid'>mainModIs</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-62"></a>             <span class='hs-varid'>emitSimpleProc</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPlainModuleInitLabel</span> <span class='hs-varid'>rOOT_MAIN</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-63"></a>    <span class='hs-layout'>}</span>
</pre>\end{code}



Cost-centre profiling: Besides the usual stuff, we must produce
declarations for the cost-centres defined in this module;

(The local cost-centres involved in this are passed into the
code-generator.)

\begin{code}
<pre><a name="line-1"></a><a name="initCostCentres"></a><span class='hs-definition'>initCostCentres</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CollectedCCs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-2"></a><span class='hs-comment'>-- Emit the declarations, and return code to register them</span>
<a name="line-3"></a><span class='hs-definition'>initCostCentres</span> <span class='hs-layout'>(</span><span class='hs-varid'>local_CCs</span><span class='hs-layout'>,</span> <span class='hs-sel'>___extern_CCs</span><span class='hs-layout'>,</span> <span class='hs-varid'>singleton_CCSs</span><span class='hs-layout'>)</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>opt_SccProfilingOn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nopC</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>emitCostCentreDecl</span>  	 <span class='hs-varid'>local_CCs</span>
<a name="line-7"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>emitCostCentreStackDecl</span>  <span class='hs-varid'>singleton_CCSs</span>
<a name="line-8"></a>        <span class='hs-layout'>}</span>
</pre>\end{code}

%************************************************************************
%*									*
\subsection[codegen-top-bindings]{Converting top-level STG bindings}
%*									*
%************************************************************************

@cgTopBinding@ is only used for top-level bindings, since they need
to be allocated statically (not in the heap) and need to be labelled.
No unboxed bindings can happen at top level.

In the code below, the static bindings are accumulated in the
@MkCgState@, and transferred into the ``statics'' slot by @forkStatics@.
This is so that we can write the top level processing in a compositional
style, with the increasing static environment being plumbed as a state
variable.

\begin{code}
<pre><a name="line-1"></a><a name="cgTopBinding"></a><span class='hs-definition'>cgTopBinding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgBinding</span><span class='hs-layout'>,</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-2"></a><span class='hs-definition'>cgTopBinding</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgNonRec</span> <span class='hs-varid'>id</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>,</span> <span class='hs-varid'>srts</span><span class='hs-layout'>)</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>id'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>maybeExternaliseId</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>id</span>
<a name="line-4"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSRT</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>id'</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-varid'>srts</span>
<a name="line-5"></a>	<span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-layout'>,</span><span class='hs-varid'>info</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cgTopRhs</span> <span class='hs-varid'>id'</span> <span class='hs-varid'>rhs</span>
<a name="line-6"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>addBindC</span> <span class='hs-varid'>id</span> <span class='hs-varid'>info</span> 	<span class='hs-comment'>-- Add the *un-externalised* Id to the envt,</span>
<a name="line-7"></a>				<span class='hs-comment'>-- so we find it when we look up occurrences</span>
<a name="line-8"></a>	<span class='hs-layout'>}</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-definition'>cgTopBinding</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgRec</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>,</span> <span class='hs-varid'>srts</span><span class='hs-layout'>)</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip</span> <span class='hs-varid'>pairs</span>
<a name="line-12"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>bndrs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapFCs</span> <span class='hs-layout'>(</span><span class='hs-varid'>maybeExternaliseId</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varid'>bndrs</span>
<a name="line-13"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>pairs'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zip</span> <span class='hs-varid'>bndrs'</span> <span class='hs-varid'>rhss</span>
<a name="line-14"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSRT</span> <span class='hs-varid'>bndrs'</span><span class='hs-layout'>)</span>  <span class='hs-varid'>srts</span>
<a name="line-15"></a>	<span class='hs-layout'>;</span> <span class='hs-sel'>_new_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fixC</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-varid'>new_binds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> 
<a name="line-16"></a>		<span class='hs-layout'>{</span> <span class='hs-varid'>addBindsC</span> <span class='hs-varid'>new_binds</span>
<a name="line-17"></a>		<span class='hs-layout'>;</span> <span class='hs-varid'>mapFCs</span> <span class='hs-layout'>(</span> <span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span><span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>cgTopRhs</span> <span class='hs-varid'>b</span> <span class='hs-varid'>e</span> <span class='hs-layout'>)</span> <span class='hs-varid'>pairs'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-18"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>nopC</span> <span class='hs-layout'>}</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="mkSRT"></a><span class='hs-definition'>mkSRT</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-21"></a><span class='hs-definition'>mkSRT</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nopC</span>
<a name="line-22"></a><span class='hs-definition'>mkSRT</span> <span class='hs-varid'>these</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-layout'>,</span><span class='hs-varid'>ids</span><span class='hs-layout'>)</span>
<a name="line-23"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>ids</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapFCs</span> <span class='hs-varid'>remap</span> <span class='hs-varid'>ids</span>
<a name="line-24"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>id</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>remap</span> <span class='hs-varid'>id</span>
<a name="line-25"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>emitRODataLits</span> <span class='hs-str'>"CodeGen.mkSRT"</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSRTLabel</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>idCafInfo</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-26"></a>	       <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmLabel</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkClosureLabel</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>idCafInfo</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ids</span><span class='hs-layout'>)</span>
<a name="line-27"></a>	<span class='hs-layout'>}</span>
<a name="line-28"></a>  <span class='hs-keyword'>where</span>
<a name="line-29"></a>	<span class='hs-comment'>-- Sigh, better map all the ids against the environment in </span>
<a name="line-30"></a>	<span class='hs-comment'>-- case they've been externalised (see maybeExternaliseId below).</span>
<a name="line-31"></a>    <span class='hs-varid'>remap</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varop'>==</span><span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-varid'>these</span> <span class='hs-keyword'>of</span>
<a name="line-32"></a>		<span class='hs-layout'>(</span><span class='hs-varid'>id'</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>returnFC</span> <span class='hs-varid'>id'</span>
<a name="line-33"></a>		<span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCgIdInfo</span> <span class='hs-varid'>id</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>cgIdInfoId</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-34"></a>
<a name="line-35"></a><span class='hs-comment'>-- Urgh!  I tried moving the forkStatics call from the rhss of cgTopRhs</span>
<a name="line-36"></a><span class='hs-comment'>-- to enclose the listFCs in cgTopBinding, but that tickled the</span>
<a name="line-37"></a><span class='hs-comment'>-- statics "error" call in initC.  I DON'T UNDERSTAND WHY!</span>
<a name="line-38"></a>
<a name="line-39"></a><a name="cgTopRhs"></a><span class='hs-definition'>cgTopRhs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgRhs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>CgIdInfo</span><span class='hs-layout'>)</span>
<a name="line-40"></a>	<span class='hs-comment'>-- The Id is passed along for setting up a binding...</span>
<a name="line-41"></a>	<span class='hs-comment'>-- It's already been externalised if necessary</span>
<a name="line-42"></a>
<a name="line-43"></a><span class='hs-definition'>cgTopRhs</span> <span class='hs-varid'>bndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgRhsCon</span> <span class='hs-sel'>_cc</span> <span class='hs-varid'>con</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-44"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>forkStatics</span> <span class='hs-layout'>(</span><span class='hs-varid'>cgTopRhsCon</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>con</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-45"></a>
<a name="line-46"></a><span class='hs-definition'>cgTopRhs</span> <span class='hs-varid'>bndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgRhsClosure</span> <span class='hs-varid'>cc</span> <span class='hs-varid'>bi</span> <span class='hs-varid'>fvs</span> <span class='hs-varid'>upd_flag</span> <span class='hs-varid'>srt</span> <span class='hs-varid'>args</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-47"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- There should be no free variables</span>
<a name="line-48"></a>    <span class='hs-varid'>setSRTLabel</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSRTLabel</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>idCafInfo</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-49"></a>    <span class='hs-varid'>setSRT</span> <span class='hs-varid'>srt</span> <span class='hs-varop'>$</span>
<a name="line-50"></a>    <span class='hs-varid'>forkStatics</span> <span class='hs-layout'>(</span><span class='hs-varid'>cgTopRhsClosure</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>cc</span> <span class='hs-varid'>bi</span> <span class='hs-varid'>upd_flag</span> <span class='hs-varid'>args</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*									*
\subsection{Stuff to support splitting}
%*									*
%************************************************************************

If we're splitting the object, we need to externalise all the top-level names
(and then make sure we only use the externalised one in any C label we use
which refers to this name).

\begin{code}
<pre><a name="line-1"></a><a name="maybeExternaliseId"></a><span class='hs-definition'>maybeExternaliseId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>Id</span>
<a name="line-2"></a><span class='hs-definition'>maybeExternaliseId</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>id</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_SplitObjs</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>,</span> 	<span class='hs-comment'>-- Externalise the name for -split-objs</span>
<a name="line-4"></a>    <span class='hs-varid'>isInternalName</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModuleName</span>
<a name="line-5"></a>			     <span class='hs-layout'>;</span> <span class='hs-varid'>returnFC</span> <span class='hs-layout'>(</span><span class='hs-varid'>setIdName</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-varid'>externalise</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>		<span class='hs-keyglyph'>=</span> <span class='hs-varid'>returnFC</span> <span class='hs-varid'>id</span>
<a name="line-7"></a>  <span class='hs-keyword'>where</span>
<a name="line-8"></a>    <span class='hs-varid'>externalise</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkExternalName</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>mod</span> <span class='hs-varid'>new_occ</span> <span class='hs-varid'>loc</span>
<a name="line-9"></a>    <span class='hs-varid'>name</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idName</span> <span class='hs-varid'>id</span>
<a name="line-10"></a>    <span class='hs-varid'>uniq</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameUnique</span> <span class='hs-varid'>name</span>
<a name="line-11"></a>    <span class='hs-varid'>new_occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLocalOcc</span> <span class='hs-varid'>uniq</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameOccName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-12"></a>    <span class='hs-varid'>loc</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameSrcSpan</span> <span class='hs-varid'>name</span>
<a name="line-13"></a>	<span class='hs-comment'>-- We want to conjure up a name that can't clash with any</span>
<a name="line-14"></a>	<span class='hs-comment'>-- existing name.  So we generate</span>
<a name="line-15"></a>	<span class='hs-comment'>--	Mod_$L243foo</span>
<a name="line-16"></a>	<span class='hs-comment'>-- where 243 is the unique.</span>
</pre>\end{code}
</body>
</html>
