<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>codeGen/CgBindery.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%
\section[CgBindery]{Utility functions related to doing @CgBindings@}

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>CgBindery</span> <span class='hs-layout'>(</span>
<a name="line-9"></a>	<span class='hs-conid'>CgBindings</span><span class='hs-layout'>,</span> <span class='hs-conid'>CgIdInfo</span><span class='hs-layout'>,</span>
<a name="line-10"></a>	<span class='hs-conid'>StableLoc</span><span class='hs-layout'>,</span> <span class='hs-conid'>VolatileLoc</span><span class='hs-layout'>,</span>
<a name="line-11"></a>
<a name="line-12"></a>	<span class='hs-varid'>cgIdInfoId</span><span class='hs-layout'>,</span> <span class='hs-varid'>cgIdInfoArgRep</span><span class='hs-layout'>,</span> <span class='hs-varid'>cgIdInfoLF</span><span class='hs-layout'>,</span>
<a name="line-13"></a>
<a name="line-14"></a>	<span class='hs-varid'>stableIdInfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>heapIdInfo</span><span class='hs-layout'>,</span>
<a name="line-15"></a>        <span class='hs-varid'>taggedStableIdInfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>taggedHeapIdInfo</span><span class='hs-layout'>,</span>
<a name="line-16"></a>	<span class='hs-varid'>letNoEscapeIdInfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>idInfoToAmode</span><span class='hs-layout'>,</span>
<a name="line-17"></a>
<a name="line-18"></a>	<span class='hs-varid'>addBindC</span><span class='hs-layout'>,</span> <span class='hs-varid'>addBindsC</span><span class='hs-layout'>,</span>
<a name="line-19"></a>
<a name="line-20"></a>	<span class='hs-varid'>nukeVolatileBinds</span><span class='hs-layout'>,</span>
<a name="line-21"></a>	<span class='hs-varid'>nukeDeadBindings</span><span class='hs-layout'>,</span>
<a name="line-22"></a>	<span class='hs-varid'>getLiveStackSlots</span><span class='hs-layout'>,</span>
<a name="line-23"></a>        <span class='hs-varid'>getLiveStackBindings</span><span class='hs-layout'>,</span>
<a name="line-24"></a>
<a name="line-25"></a>	<span class='hs-varid'>bindArgsToStack</span><span class='hs-layout'>,</span>  <span class='hs-varid'>rebindToStack</span><span class='hs-layout'>,</span>
<a name="line-26"></a>	<span class='hs-varid'>bindNewToNode</span><span class='hs-layout'>,</span> <span class='hs-varid'>bindNewToUntagNode</span><span class='hs-layout'>,</span> <span class='hs-varid'>bindNewToReg</span><span class='hs-layout'>,</span> <span class='hs-varid'>bindArgsToRegs</span><span class='hs-layout'>,</span>
<a name="line-27"></a>	<span class='hs-varid'>bindNewToTemp</span><span class='hs-layout'>,</span>
<a name="line-28"></a>	<span class='hs-varid'>getArgAmode</span><span class='hs-layout'>,</span> <span class='hs-varid'>getArgAmodes</span><span class='hs-layout'>,</span> 
<a name="line-29"></a>	<span class='hs-varid'>getCgIdInfo</span><span class='hs-layout'>,</span> 
<a name="line-30"></a>	<span class='hs-varid'>getCAddrModeIfVolatile</span><span class='hs-layout'>,</span> <span class='hs-varid'>getVolatileRegs</span><span class='hs-layout'>,</span>
<a name="line-31"></a>	<span class='hs-varid'>maybeLetNoEscape</span><span class='hs-layout'>,</span> 
<a name="line-32"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-33"></a>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgMonad</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgHeapery</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgStackery</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgUtils</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CLabel</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ClosureInfo</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Constants</span>
<a name="line-41"></a>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OldCmm</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PprCmm</span>		<span class='hs-layout'>(</span> <span class='hs-comment'>{- instance Outputable -}</span> <span class='hs-layout'>)</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SMRep</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Literal</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>StgSyn</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unique</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSet</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-57"></a>
</pre>\end{code}


%************************************************************************
%*									*
\subsection[Bindery-datatypes]{Data types}
%*									*
%************************************************************************

@(CgBinding a b)@ is a type of finite maps from a to b.

The assumption used to be that @lookupCgBind@ must get exactly one
match.  This is {\em completely wrong} in the case of compiling
letrecs (where knot-tying is used).  An initial binding is fed in (and
never evaluated); eventually, a correct binding is put into the
environment.  So there can be two bindings for a given name.

\begin{code}
<pre><a name="line-1"></a><a name="CgBindings"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CgBindings</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IdEnv</span> <span class='hs-conid'>CgIdInfo</span>
<a name="line-2"></a>
<a name="line-3"></a><a name="CgIdInfo"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CgIdInfo</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CgIdInfo</span>	
<a name="line-5"></a>	<span class='hs-layout'>{</span> <span class='hs-varid'>cg_id</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span>	<span class='hs-comment'>-- Id that this is the info for</span>
<a name="line-6"></a>			<span class='hs-comment'>-- Can differ from the Id at occurrence sites by </span>
<a name="line-7"></a>			<span class='hs-comment'>-- virtue of being externalised, for splittable C</span>
<a name="line-8"></a>	<span class='hs-layout'>,</span> <span class='hs-varid'>cg_rep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CgRep</span>
<a name="line-9"></a>	<span class='hs-layout'>,</span> <span class='hs-varid'>cg_vol</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>VolatileLoc</span>
<a name="line-10"></a>	<span class='hs-layout'>,</span> <span class='hs-varid'>cg_stb</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StableLoc</span>
<a name="line-11"></a>	<span class='hs-layout'>,</span> <span class='hs-varid'>cg_lf</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LambdaFormInfo</span> 
<a name="line-12"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>cg_tag</span> <span class='hs-keyglyph'>::</span> <span class='hs-comment'>{-# UNPACK #-}</span> <span class='hs-varop'>!</span><span class='hs-conid'>Int</span>  <span class='hs-comment'>-- tag to be added in idInfoToAmode</span>
<a name="line-13"></a>         <span class='hs-layout'>}</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="mkCgIdInfo"></a><span class='hs-definition'>mkCgIdInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VolatileLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StableLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LambdaFormInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CgIdInfo</span>
<a name="line-16"></a><span class='hs-definition'>mkCgIdInfo</span> <span class='hs-varid'>id</span> <span class='hs-varid'>vol</span> <span class='hs-varid'>stb</span> <span class='hs-varid'>lf</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CgIdInfo</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cg_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>cg_vol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vol</span><span class='hs-layout'>,</span> <span class='hs-varid'>cg_stb</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stb</span><span class='hs-layout'>,</span> 
<a name="line-18"></a>	       <span class='hs-varid'>cg_lf</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lf</span><span class='hs-layout'>,</span> <span class='hs-varid'>cg_rep</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idCgRep</span> <span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>cg_tag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tag</span> <span class='hs-layout'>}</span>
<a name="line-19"></a>  <span class='hs-keyword'>where</span>
<a name="line-20"></a>    <span class='hs-varid'>tag</span>
<a name="line-21"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isDataConWorkId_maybe</span> <span class='hs-varid'>id</span><span class='hs-layout'>,</span>
<a name="line-22"></a>          <span class='hs-comment'>{- Is this an identifier for a static constructor closure? -}</span>
<a name="line-23"></a>        <span class='hs-varid'>isNullaryRepDataCon</span> <span class='hs-varid'>con</span>
<a name="line-24"></a>          <span class='hs-comment'>{- If yes, is this a nullary constructor?
<a name="line-25"></a>             If yes, we assume that the constructor is evaluated and can
<a name="line-26"></a>             be tagged.
<a name="line-27"></a>           -}</span>
<a name="line-28"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tagForCon</span> <span class='hs-varid'>con</span>
<a name="line-29"></a>
<a name="line-30"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-31"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funTagLFInfo</span> <span class='hs-varid'>lf</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="voidIdInfo"></a><span class='hs-definition'>voidIdInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CgIdInfo</span>
<a name="line-34"></a><span class='hs-definition'>voidIdInfo</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CgIdInfo</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cg_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>cg_vol</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoVolatileLoc</span>
<a name="line-35"></a>			 <span class='hs-layout'>,</span> <span class='hs-varid'>cg_stb</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VoidLoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>cg_lf</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLFArgument</span> <span class='hs-varid'>id</span>
<a name="line-36"></a>			 <span class='hs-layout'>,</span> <span class='hs-varid'>cg_rep</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VoidArg</span><span class='hs-layout'>,</span> <span class='hs-varid'>cg_tag</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span> <span class='hs-layout'>}</span>
<a name="line-37"></a>	<span class='hs-comment'>-- Used just for VoidRep things</span>
<a name="line-38"></a>
<a name="line-39"></a><a name="VolatileLoc"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>VolatileLoc</span>	<span class='hs-comment'>-- These locations die across a call</span>
<a name="line-40"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoVolatileLoc</span>
<a name="line-41"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RegLoc</span>	<span class='hs-conid'>CmmReg</span>		   <span class='hs-comment'>-- In one of the registers (global or local)</span>
<a name="line-42"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>VirHpLoc</span>	<span class='hs-conid'>VirtualHpOffset</span>  <span class='hs-comment'>-- Hp+offset (address of closure)</span>
<a name="line-43"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>VirNodeLoc</span>	<span class='hs-conid'>ByteOff</span>            <span class='hs-comment'>-- Cts of offset indirect from Node</span>
<a name="line-44"></a>				   <span class='hs-comment'>-- ie *(Node+offset).</span>
<a name="line-45"></a>                                   <span class='hs-comment'>-- NB. Byte offset, because we subtract R1's</span>
<a name="line-46"></a>                                   <span class='hs-comment'>-- tag from the offset.</span>
<a name="line-47"></a>
<a name="line-48"></a><a name="mkTaggedCgIdInfo"></a><span class='hs-definition'>mkTaggedCgIdInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VolatileLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StableLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LambdaFormInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DataCon</span>
<a name="line-49"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CgIdInfo</span>
<a name="line-50"></a><span class='hs-definition'>mkTaggedCgIdInfo</span> <span class='hs-varid'>id</span> <span class='hs-varid'>vol</span> <span class='hs-varid'>stb</span> <span class='hs-varid'>lf</span> <span class='hs-varid'>con</span>
<a name="line-51"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CgIdInfo</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cg_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>cg_vol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vol</span><span class='hs-layout'>,</span> <span class='hs-varid'>cg_stb</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stb</span><span class='hs-layout'>,</span> 
<a name="line-52"></a>	       <span class='hs-varid'>cg_lf</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lf</span><span class='hs-layout'>,</span> <span class='hs-varid'>cg_rep</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idCgRep</span> <span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>cg_tag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tagForCon</span> <span class='hs-varid'>con</span> <span class='hs-layout'>}</span>
</pre>\end{code}

@StableLoc@ encodes where an Id can be found, used by
the @CgBindings@ environment in @CgBindery@.

\begin{code}
<pre><a name="line-1"></a><a name="StableLoc"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>StableLoc</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoStableLoc</span>
<a name="line-3"></a>
<a name="line-4"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>VirStkLoc</span>	<span class='hs-conid'>VirtualSpOffset</span>		<span class='hs-comment'>-- The thing is held in this</span>
<a name="line-5"></a>					<span class='hs-comment'>-- stack slot</span>
<a name="line-6"></a>
<a name="line-7"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>VirStkLNE</span>	<span class='hs-conid'>VirtualSpOffset</span>		<span class='hs-comment'>-- A let-no-escape thing; the</span>
<a name="line-8"></a>					<span class='hs-comment'>-- value is this stack pointer</span>
<a name="line-9"></a>					<span class='hs-comment'>-- (as opposed to the contents of the slot)</span>
<a name="line-10"></a>
<a name="line-11"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>StableLoc</span>	<span class='hs-conid'>CmmExpr</span>
<a name="line-12"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>VoidLoc</span>	<span class='hs-comment'>-- Used only for VoidRep variables.  They never need to</span>
<a name="line-13"></a>		<span class='hs-comment'>-- be saved, so it makes sense to treat treat them as</span>
<a name="line-14"></a>		<span class='hs-comment'>-- having a stable location</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>PlatformOutputable</span> <span class='hs-conid'>CgIdInfo</span> <span class='hs-keyword'>where</span>
<a name="line-2"></a>  <span class='hs-varid'>pprPlatform</span> <span class='hs-varid'>platform</span> <span class='hs-layout'>(</span><span class='hs-conid'>CgIdInfo</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>vol</span> <span class='hs-varid'>stb</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-3"></a>    <span class='hs-comment'>-- TODO, pretty pring the tag info</span>
<a name="line-4"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"--&gt;"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>vol</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprPlatform</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>stb</span><span class='hs-keyglyph'>]</span>
<a name="line-5"></a>
<a name="line-6"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>VolatileLoc</span> <span class='hs-keyword'>where</span>
<a name="line-7"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>NoVolatileLoc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-8"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>RegLoc</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"reg"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>r</span>
<a name="line-9"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>VirHpLoc</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"vh"</span><span class='hs-layout'>)</span>  <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span>
<a name="line-10"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>VirNodeLoc</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"vn"</span><span class='hs-layout'>)</span>  <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>PlatformOutputable</span> <span class='hs-conid'>StableLoc</span> <span class='hs-keyword'>where</span>
<a name="line-13"></a>  <span class='hs-varid'>pprPlatform</span> <span class='hs-keyword'>_</span>        <span class='hs-conid'>NoStableLoc</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-14"></a>  <span class='hs-varid'>pprPlatform</span> <span class='hs-keyword'>_</span>        <span class='hs-conid'>VoidLoc</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"void"</span><span class='hs-layout'>)</span>
<a name="line-15"></a>  <span class='hs-varid'>pprPlatform</span> <span class='hs-keyword'>_</span>        <span class='hs-layout'>(</span><span class='hs-conid'>VirStkLoc</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"vs"</span><span class='hs-layout'>)</span>    <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span>
<a name="line-16"></a>  <span class='hs-varid'>pprPlatform</span> <span class='hs-keyword'>_</span>        <span class='hs-layout'>(</span><span class='hs-conid'>VirStkLNE</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"lne"</span><span class='hs-layout'>)</span>   <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span>
<a name="line-17"></a>  <span class='hs-varid'>pprPlatform</span> <span class='hs-varid'>platform</span> <span class='hs-layout'>(</span><span class='hs-conid'>StableLoc</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"amode"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprPlatform</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>a</span>
</pre>\end{code}

%************************************************************************
%*									*
\subsection[Bindery-idInfo]{Manipulating IdInfo}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="stableIdInfo"></a><span class='hs-definition'>stableIdInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LambdaFormInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CgIdInfo</span>
<a name="line-2"></a><span class='hs-definition'>stableIdInfo</span> <span class='hs-varid'>id</span> <span class='hs-varid'>amode</span>   <span class='hs-varid'>lf_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCgIdInfo</span> <span class='hs-varid'>id</span> <span class='hs-conid'>NoVolatileLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>StableLoc</span> <span class='hs-varid'>amode</span><span class='hs-layout'>)</span> <span class='hs-varid'>lf_info</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="heapIdInfo"></a><span class='hs-definition'>heapIdInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VirtualHpOffset</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LambdaFormInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CgIdInfo</span>
<a name="line-5"></a><span class='hs-definition'>heapIdInfo</span> <span class='hs-varid'>id</span> <span class='hs-varid'>offset</span>    <span class='hs-varid'>lf_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCgIdInfo</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-conid'>VirHpLoc</span> <span class='hs-varid'>offset</span><span class='hs-layout'>)</span> <span class='hs-conid'>NoStableLoc</span> <span class='hs-varid'>lf_info</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="letNoEscapeIdInfo"></a><span class='hs-definition'>letNoEscapeIdInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VirtualSpOffset</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LambdaFormInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CgIdInfo</span>
<a name="line-8"></a><span class='hs-definition'>letNoEscapeIdInfo</span> <span class='hs-varid'>id</span> <span class='hs-varid'>sp</span> <span class='hs-varid'>lf_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCgIdInfo</span> <span class='hs-varid'>id</span> <span class='hs-conid'>NoVolatileLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>VirStkLNE</span> <span class='hs-varid'>sp</span><span class='hs-layout'>)</span> <span class='hs-varid'>lf_info</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="stackIdInfo"></a><span class='hs-definition'>stackIdInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VirtualSpOffset</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LambdaFormInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CgIdInfo</span>
<a name="line-11"></a><span class='hs-definition'>stackIdInfo</span> <span class='hs-varid'>id</span> <span class='hs-varid'>sp</span>	<span class='hs-varid'>lf_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCgIdInfo</span> <span class='hs-varid'>id</span> <span class='hs-conid'>NoVolatileLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>VirStkLoc</span> <span class='hs-varid'>sp</span><span class='hs-layout'>)</span> <span class='hs-varid'>lf_info</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="nodeIdInfo"></a><span class='hs-definition'>nodeIdInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LambdaFormInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CgIdInfo</span>
<a name="line-14"></a><span class='hs-definition'>nodeIdInfo</span> <span class='hs-varid'>id</span> <span class='hs-varid'>offset</span>    <span class='hs-varid'>lf_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCgIdInfo</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-conid'>VirNodeLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>wORD_SIZE</span><span class='hs-varop'>*</span><span class='hs-varid'>offset</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conid'>NoStableLoc</span> <span class='hs-varid'>lf_info</span>
<a name="line-15"></a>
<a name="line-16"></a><a name="regIdInfo"></a><span class='hs-definition'>regIdInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmReg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LambdaFormInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CgIdInfo</span>
<a name="line-17"></a><span class='hs-definition'>regIdInfo</span> <span class='hs-varid'>id</span> <span class='hs-varid'>reg</span>        <span class='hs-varid'>lf_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCgIdInfo</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-conid'>RegLoc</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span> <span class='hs-conid'>NoStableLoc</span> <span class='hs-varid'>lf_info</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="taggedStableIdInfo"></a><span class='hs-definition'>taggedStableIdInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LambdaFormInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CgIdInfo</span>
<a name="line-20"></a><span class='hs-definition'>taggedStableIdInfo</span> <span class='hs-varid'>id</span> <span class='hs-varid'>amode</span> <span class='hs-varid'>lf_info</span> <span class='hs-varid'>con</span>
<a name="line-21"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTaggedCgIdInfo</span> <span class='hs-varid'>id</span> <span class='hs-conid'>NoVolatileLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>StableLoc</span> <span class='hs-varid'>amode</span><span class='hs-layout'>)</span> <span class='hs-varid'>lf_info</span> <span class='hs-varid'>con</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="taggedHeapIdInfo"></a><span class='hs-definition'>taggedHeapIdInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VirtualHpOffset</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LambdaFormInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DataCon</span>
<a name="line-24"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CgIdInfo</span>
<a name="line-25"></a><span class='hs-definition'>taggedHeapIdInfo</span> <span class='hs-varid'>id</span> <span class='hs-varid'>offset</span> <span class='hs-varid'>lf_info</span> <span class='hs-varid'>con</span>
<a name="line-26"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTaggedCgIdInfo</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-conid'>VirHpLoc</span> <span class='hs-varid'>offset</span><span class='hs-layout'>)</span> <span class='hs-conid'>NoStableLoc</span> <span class='hs-varid'>lf_info</span> <span class='hs-varid'>con</span>
<a name="line-27"></a>
<a name="line-28"></a><a name="untagNodeIdInfo"></a><span class='hs-definition'>untagNodeIdInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LambdaFormInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CgIdInfo</span>
<a name="line-29"></a><span class='hs-definition'>untagNodeIdInfo</span> <span class='hs-varid'>id</span> <span class='hs-varid'>offset</span>    <span class='hs-varid'>lf_info</span> <span class='hs-varid'>tag</span>
<a name="line-30"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCgIdInfo</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-conid'>VirNodeLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>wORD_SIZE</span><span class='hs-varop'>*</span><span class='hs-varid'>offset</span> <span class='hs-comment'>-</span> <span class='hs-varid'>tag</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conid'>NoStableLoc</span> <span class='hs-varid'>lf_info</span>
<a name="line-31"></a>
<a name="line-32"></a>
<a name="line-33"></a><a name="idInfoToAmode"></a><span class='hs-definition'>idInfoToAmode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CgIdInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>CmmExpr</span>
<a name="line-34"></a><span class='hs-definition'>idInfoToAmode</span> <span class='hs-varid'>info</span>
<a name="line-35"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cg_vol</span> <span class='hs-varid'>info</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span>
<a name="line-36"></a>      <span class='hs-conid'>RegLoc</span> <span class='hs-varid'>reg</span> 	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>returnFC</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span>
<a name="line-37"></a>      <span class='hs-conid'>VirNodeLoc</span> <span class='hs-varid'>nd_off</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>returnFC</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLoad</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmmOffsetB</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-varid'>nodeReg</span><span class='hs-layout'>)</span> <span class='hs-varid'>nd_off</span><span class='hs-layout'>)</span>
<a name="line-38"></a>                                             <span class='hs-varid'>mach_rep</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span>
<a name="line-39"></a>      <span class='hs-conid'>VirHpLoc</span> <span class='hs-varid'>hp_off</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>off</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHpRelOffset</span> <span class='hs-varid'>hp_off</span>
<a name="line-40"></a>                              <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>maybeTag</span> <span class='hs-varid'>off</span> <span class='hs-layout'>}</span><span class='hs-layout'>;</span>
<a name="line-41"></a>      <span class='hs-conid'>NoVolatileLoc</span> <span class='hs-keyglyph'>-&gt;</span> 
<a name="line-42"></a>
<a name="line-43"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>cg_stb</span> <span class='hs-varid'>info</span> <span class='hs-keyword'>of</span>
<a name="line-44"></a>      <span class='hs-conid'>StableLoc</span> <span class='hs-varid'>amode</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>returnFC</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>maybeTag</span> <span class='hs-varid'>amode</span>
<a name="line-45"></a>      <span class='hs-conid'>VirStkLoc</span> <span class='hs-varid'>sp_off</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sp_rel</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSpRelOffset</span> <span class='hs-varid'>sp_off</span>
<a name="line-46"></a>			     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLoad</span> <span class='hs-varid'>sp_rel</span> <span class='hs-varid'>mach_rep</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-47"></a>
<a name="line-48"></a>      <span class='hs-conid'>VirStkLNE</span> <span class='hs-varid'>sp_off</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>getSpRelOffset</span> <span class='hs-varid'>sp_off</span>
<a name="line-49"></a>
<a name="line-50"></a>      <span class='hs-conid'>VoidLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"idInfoToAmode: void"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>cg_id</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-51"></a>		<span class='hs-comment'>-- We return a 'bottom' amode, rather than panicing now</span>
<a name="line-52"></a>		<span class='hs-comment'>-- In this way getArgAmode returns a pair of (VoidArg, bottom)</span>
<a name="line-53"></a>		<span class='hs-comment'>-- and that's exactly what we want</span>
<a name="line-54"></a>
<a name="line-55"></a>      <span class='hs-conid'>NoStableLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"idInfoToAmode: no loc"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>cg_id</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-56"></a>    <span class='hs-layout'>}</span>
<a name="line-57"></a>  <span class='hs-keyword'>where</span>
<a name="line-58"></a>    <span class='hs-varid'>mach_rep</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>argMachRep</span> <span class='hs-layout'>(</span><span class='hs-varid'>cg_rep</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span>
<a name="line-59"></a>
<a name="line-60"></a>    <span class='hs-varid'>maybeTag</span> <span class='hs-varid'>amode</span>  <span class='hs-comment'>-- add the tag, if we have one</span>
<a name="line-61"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tag</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>amode</span>
<a name="line-62"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmmOffsetB</span> <span class='hs-varid'>amode</span> <span class='hs-varid'>tag</span>
<a name="line-63"></a>      <span class='hs-keyword'>where</span> <span class='hs-varid'>tag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cg_tag</span> <span class='hs-varid'>info</span>
<a name="line-64"></a>
<a name="line-65"></a><a name="cgIdInfoId"></a><span class='hs-definition'>cgIdInfoId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CgIdInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-66"></a><span class='hs-definition'>cgIdInfoId</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cg_id</span> 
<a name="line-67"></a>
<a name="line-68"></a><a name="cgIdInfoLF"></a><span class='hs-definition'>cgIdInfoLF</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CgIdInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LambdaFormInfo</span>
<a name="line-69"></a><span class='hs-definition'>cgIdInfoLF</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cg_lf</span>
<a name="line-70"></a>
<a name="line-71"></a><a name="cgIdInfoArgRep"></a><span class='hs-definition'>cgIdInfoArgRep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CgIdInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CgRep</span>
<a name="line-72"></a><span class='hs-definition'>cgIdInfoArgRep</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cg_rep</span>
<a name="line-73"></a>
<a name="line-74"></a><a name="maybeLetNoEscape"></a><span class='hs-definition'>maybeLetNoEscape</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CgIdInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>VirtualSpOffset</span>
<a name="line-75"></a><span class='hs-definition'>maybeLetNoEscape</span> <span class='hs-layout'>(</span><span class='hs-conid'>CgIdInfo</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cg_stb</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VirStkLNE</span> <span class='hs-varid'>sp_off</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>sp_off</span>
<a name="line-76"></a><span class='hs-definition'>maybeLetNoEscape</span> <span class='hs-keyword'>_</span>       				  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
</pre>\end{code}

%************************************************************************
%*									*
\subsection[CgMonad-bindery]{Monad things for fiddling with @CgBindings@}
%*									*
%************************************************************************

.There are three basic routines, for adding (@addBindC@), modifying
(@modifyBindC@) and looking up (@getCgIdInfo@) bindings.

A @Id@ is bound to a @(VolatileLoc, StableLoc)@ triple.
The name should not already be bound. (nice ASSERT, eh?)

\begin{code}
<pre><a name="line-1"></a><a name="addBindC"></a><span class='hs-definition'>addBindC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CgIdInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-2"></a><span class='hs-definition'>addBindC</span> <span class='hs-varid'>name</span> <span class='hs-varid'>stuff_to_bind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-3"></a>	<span class='hs-varid'>binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getBinds</span>
<a name="line-4"></a>	<span class='hs-varid'>setBinds</span> <span class='hs-varop'>$</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>name</span> <span class='hs-varid'>stuff_to_bind</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="addBindsC"></a><span class='hs-definition'>addBindsC</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>CgIdInfo</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-7"></a><span class='hs-definition'>addBindsC</span> <span class='hs-varid'>new_bindings</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-8"></a>	<span class='hs-varid'>binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getBinds</span>
<a name="line-9"></a>	<span class='hs-keyword'>let</span> <span class='hs-varid'>new_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-varid'>binds</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span><span class='hs-varid'>info</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>name</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span>
<a name="line-10"></a>			      <span class='hs-varid'>binds</span>
<a name="line-11"></a>			      <span class='hs-varid'>new_bindings</span>
<a name="line-12"></a>	<span class='hs-varid'>setBinds</span> <span class='hs-varid'>new_binds</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="modifyBindC"></a><span class='hs-definition'>modifyBindC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CgIdInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CgIdInfo</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-15"></a><span class='hs-definition'>modifyBindC</span> <span class='hs-varid'>name</span> <span class='hs-varid'>mangle_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-16"></a>	<span class='hs-varid'>binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getBinds</span>
<a name="line-17"></a>	<span class='hs-varid'>setBinds</span> <span class='hs-varop'>$</span> <span class='hs-varid'>modifyVarEnv</span> <span class='hs-varid'>mangle_fn</span> <span class='hs-varid'>binds</span> <span class='hs-varid'>name</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="getCgIdInfo"></a><span class='hs-definition'>getCgIdInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>CgIdInfo</span>
<a name="line-20"></a><span class='hs-definition'>getCgIdInfo</span> <span class='hs-varid'>id</span>
<a name="line-21"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> 	<span class='hs-comment'>-- Try local bindings first</span>
<a name="line-22"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>local_binds</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getBinds</span>
<a name="line-23"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>local_binds</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span>
<a name="line-24"></a>	    <span class='hs-conid'>Just</span> <span class='hs-varid'>info</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>info</span> <span class='hs-layout'>;</span>
<a name="line-25"></a>	    <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-26"></a>
<a name="line-27"></a>	<span class='hs-layout'>{</span> 	<span class='hs-comment'>-- Try top-level bindings</span>
<a name="line-28"></a>	  <span class='hs-varid'>static_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getStaticBinds</span>
<a name="line-29"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>static_binds</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span>
<a name="line-30"></a>	    <span class='hs-conid'>Just</span> <span class='hs-varid'>info</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>info</span> <span class='hs-layout'>;</span>
<a name="line-31"></a>	    <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span>
<a name="line-32"></a>
<a name="line-33"></a>		<span class='hs-comment'>-- Should be imported; make up a CgIdInfo for it</span>
<a name="line-34"></a>	<span class='hs-keyword'>let</span> 
<a name="line-35"></a>	    <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idName</span> <span class='hs-varid'>id</span>
<a name="line-36"></a>	<span class='hs-keyword'>in</span>
<a name="line-37"></a>	<span class='hs-keyword'>if</span> <span class='hs-varid'>isExternalName</span> <span class='hs-varid'>name</span> <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span>
<a name="line-38"></a>	    <span class='hs-keyword'>let</span> <span class='hs-varid'>ext_lbl</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLabel</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkClosureLabel</span> <span class='hs-varid'>name</span> <span class='hs-varop'>$</span> <span class='hs-varid'>idCafInfo</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-39"></a>	    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>stableIdInfo</span> <span class='hs-varid'>id</span> <span class='hs-varid'>ext_lbl</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLFImported</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-40"></a>	<span class='hs-keyword'>else</span>
<a name="line-41"></a>	<span class='hs-keyword'>if</span> <span class='hs-varid'>isVoidArg</span> <span class='hs-layout'>(</span><span class='hs-varid'>idCgRep</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-keyword'>then</span>
<a name="line-42"></a>		<span class='hs-comment'>-- Void things are never in the environment</span>
<a name="line-43"></a>	    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>voidIdInfo</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-44"></a>	<span class='hs-keyword'>else</span>
<a name="line-45"></a>	<span class='hs-comment'>-- Bug	</span>
<a name="line-46"></a>	<span class='hs-varid'>cgLookupPanic</span> <span class='hs-varid'>id</span>
<a name="line-47"></a>	<span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-48"></a>    
<a name="line-49"></a>			
<a name="line-50"></a><a name="cgLookupPanic"></a><span class='hs-definition'>cgLookupPanic</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-varid'>a</span>
<a name="line-51"></a><span class='hs-definition'>cgLookupPanic</span> <span class='hs-varid'>id</span>
<a name="line-52"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-varid'>static_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getStaticBinds</span>
<a name="line-53"></a>	<span class='hs-varid'>local_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getBinds</span>
<a name="line-54"></a><span class='hs-comment'>--      srt &lt;- getSRTLabel</span>
<a name="line-55"></a>        <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"cgLookupPanic (probably invalid Core; try -dcore-lint)"</span>
<a name="line-56"></a>		<span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span><span class='hs-layout'>,</span>
<a name="line-57"></a>		<span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"static binds for:"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-58"></a>		<span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>cg_id</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>varEnvElts</span> <span class='hs-varid'>static_binds</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-59"></a>		<span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"local binds for:"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-60"></a>                <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>cg_id</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>varEnvElts</span> <span class='hs-varid'>local_binds</span> <span class='hs-keyglyph'>]</span>
<a name="line-61"></a><span class='hs-comment'>--              ptext (sLit "SRT label") &lt;+&gt; pprCLabel srt</span>
<a name="line-62"></a>	      <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*									*
\subsection[Bindery-nuke-volatile]{Nuking volatile bindings}
%*									*
%************************************************************************

We sometimes want to nuke all the volatile bindings; we must be sure
we don't leave any (NoVolatile, NoStable) binds around...

\begin{code}
<pre><a name="line-1"></a><a name="nukeVolatileBinds"></a><span class='hs-definition'>nukeVolatileBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CgBindings</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CgBindings</span>
<a name="line-2"></a><span class='hs-definition'>nukeVolatileBinds</span> <span class='hs-varid'>binds</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldr</span> <span class='hs-varid'>keep_if_stable</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>(</span><span class='hs-varid'>varEnvElts</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-4"></a>  <span class='hs-keyword'>where</span>
<a name="line-5"></a>    <span class='hs-varid'>keep_if_stable</span> <span class='hs-layout'>(</span><span class='hs-conid'>CgIdInfo</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cg_stb</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoStableLoc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span>
<a name="line-6"></a>    <span class='hs-varid'>keep_if_stable</span> <span class='hs-varid'>info</span> <span class='hs-varid'>acc</span>
<a name="line-7"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>cg_id</span> <span class='hs-varid'>info</span><span class='hs-layout'>,</span> <span class='hs-varid'>info</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cg_vol</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoVolatileLoc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>acc</span>
</pre>\end{code}


%************************************************************************
%*									*
\subsection[lookup-interface]{Interface functions to looking up bindings}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="getCAddrModeIfVolatile"></a><span class='hs-definition'>getCAddrModeIfVolatile</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>CmmExpr</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-definition'>getCAddrModeIfVolatile</span> <span class='hs-varid'>id</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCgIdInfo</span> <span class='hs-varid'>id</span>
<a name="line-4"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cg_stb</span> <span class='hs-varid'>info</span> <span class='hs-keyword'>of</span>
<a name="line-5"></a>		<span class='hs-conid'>NoStableLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-comment'>-- Aha!  So it is volatile!</span>
<a name="line-6"></a>			<span class='hs-varid'>amode</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>idInfoToAmode</span> <span class='hs-varid'>info</span>
<a name="line-7"></a>			<span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>amode</span>
<a name="line-8"></a>		<span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>}</span>
</pre>\end{code}

@getVolatileRegs@ gets a set of live variables, and returns a list of
all registers on which these variables depend.  These are the regs
which must be saved and restored across any C calls.  If a variable is
both in a volatile location (depending on a register) {\em and} a
stable one (notably, on the stack), we modify the current bindings to
forget the volatile one.

\begin{code}
<pre><a name="line-1"></a><a name="getVolatileRegs"></a><span class='hs-definition'>getVolatileRegs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StgLiveVars</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GlobalReg</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-definition'>getVolatileRegs</span> <span class='hs-varid'>vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-4"></a>  <span class='hs-keyword'>do</span> 	<span class='hs-layout'>{</span> <span class='hs-varid'>stuff</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapFCs</span> <span class='hs-varid'>snaffle_it</span> <span class='hs-layout'>(</span><span class='hs-varid'>varSetElems</span> <span class='hs-varid'>vars</span><span class='hs-layout'>)</span>
<a name="line-5"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>returnFC</span> <span class='hs-varop'>$</span> <span class='hs-varid'>catMaybes</span> <span class='hs-varid'>stuff</span> <span class='hs-layout'>}</span>
<a name="line-6"></a>  <span class='hs-keyword'>where</span>
<a name="line-7"></a>    <span class='hs-varid'>snaffle_it</span> <span class='hs-varid'>var</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-8"></a>	<span class='hs-layout'>{</span> <span class='hs-varid'>info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCgIdInfo</span> <span class='hs-varid'>var</span> 
<a name="line-9"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span>
<a name="line-10"></a>		<span class='hs-comment'>-- commoned-up code...</span>
<a name="line-11"></a>	     <span class='hs-varid'>consider_reg</span> <span class='hs-varid'>reg</span>
<a name="line-12"></a>		<span class='hs-keyglyph'>=</span>	<span class='hs-comment'>-- We assume that all regs can die across C calls</span>
<a name="line-13"></a>			<span class='hs-comment'>-- We leave it to the save-macros to decide which</span>
<a name="line-14"></a>			<span class='hs-comment'>-- regs *really* need to be saved.</span>
<a name="line-15"></a>		  <span class='hs-keyword'>case</span> <span class='hs-varid'>cg_stb</span> <span class='hs-varid'>info</span> <span class='hs-keyword'>of</span>
<a name="line-16"></a>			<span class='hs-conid'>NoStableLoc</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>returnFC</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- got one!</span>
<a name="line-17"></a>			<span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-18"></a>				<span class='hs-layout'>{</span> <span class='hs-comment'>-- has both volatile &amp; stable locations;</span>
<a name="line-19"></a>				  <span class='hs-comment'>-- force it to rely on the stable location</span>
<a name="line-20"></a>				  <span class='hs-varid'>modifyBindC</span> <span class='hs-varid'>var</span> <span class='hs-varid'>nuke_vol_bind</span> 
<a name="line-21"></a>				<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>}</span>
<a name="line-22"></a>
<a name="line-23"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cg_vol</span> <span class='hs-varid'>info</span> <span class='hs-keyword'>of</span>
<a name="line-24"></a>	    <span class='hs-conid'>RegLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmGlobal</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>consider_reg</span> <span class='hs-varid'>reg</span>
<a name="line-25"></a>	    <span class='hs-conid'>VirNodeLoc</span> <span class='hs-keyword'>_</span> 	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>consider_reg</span> <span class='hs-varid'>node</span>
<a name="line-26"></a>	    <span class='hs-keyword'>_</span>         	 	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>returnFC</span> <span class='hs-conid'>Nothing</span>	<span class='hs-comment'>-- Local registers</span>
<a name="line-27"></a>	<span class='hs-layout'>}</span>
<a name="line-28"></a>
<a name="line-29"></a>    <span class='hs-varid'>nuke_vol_bind</span> <span class='hs-varid'>info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>info</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cg_vol</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoVolatileLoc</span> <span class='hs-layout'>}</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="getArgAmode"></a><span class='hs-definition'>getArgAmode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StgArg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-layout'>(</span><span class='hs-conid'>CgRep</span><span class='hs-layout'>,</span> <span class='hs-conid'>CmmExpr</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-definition'>getArgAmode</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgVarArg</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span> 
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCgIdInfo</span> <span class='hs-varid'>var</span>
<a name="line-4"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>amode</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>idInfoToAmode</span> <span class='hs-varid'>info</span>
<a name="line-5"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>cgIdInfoArgRep</span> <span class='hs-varid'>info</span><span class='hs-layout'>,</span> <span class='hs-varid'>amode</span> <span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-definition'>getArgAmode</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgLitArg</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span> 
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>cmm_lit</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cgLit</span> <span class='hs-varid'>lit</span>
<a name="line-9"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeCgRep</span> <span class='hs-layout'>(</span><span class='hs-varid'>literalType</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>CmmLit</span> <span class='hs-varid'>cmm_lit</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-definition'>getArgAmode</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgTypeArg</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"getArgAmode: type arg"</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="getArgAmodes"></a><span class='hs-definition'>getArgAmodes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StgArg</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>CgRep</span><span class='hs-layout'>,</span> <span class='hs-conid'>CmmExpr</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-14"></a><span class='hs-definition'>getArgAmodes</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>returnFC</span> <span class='hs-conid'>[]</span>
<a name="line-15"></a><span class='hs-definition'>getArgAmodes</span> <span class='hs-layout'>(</span><span class='hs-varid'>atom</span><span class='hs-conop'>:</span><span class='hs-varid'>atoms</span><span class='hs-layout'>)</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isStgTypeArg</span> <span class='hs-varid'>atom</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getArgAmodes</span> <span class='hs-varid'>atoms</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> 	      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>amode</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getArgAmode</span>  <span class='hs-varid'>atom</span> 
<a name="line-18"></a>	 		   <span class='hs-layout'>;</span> <span class='hs-varid'>amodes</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getArgAmodes</span> <span class='hs-varid'>atoms</span>
<a name="line-19"></a>	 		   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-varid'>amode</span> <span class='hs-conop'>:</span> <span class='hs-varid'>amodes</span> <span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}

%************************************************************************
%*									*
\subsection[binding-and-rebinding-interface]{Interface functions for binding and re-binding names}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="bindArgsToStack"></a><span class='hs-definition'>bindArgsToStack</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>VirtualSpOffset</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-2"></a><span class='hs-definition'>bindArgsToStack</span> <span class='hs-varid'>args</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapCs</span> <span class='hs-varid'>bind</span> <span class='hs-varid'>args</span>
<a name="line-4"></a>  <span class='hs-keyword'>where</span>
<a name="line-5"></a>    <span class='hs-varid'>bind</span><span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>offset</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addBindC</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-varid'>stackIdInfo</span> <span class='hs-varid'>id</span> <span class='hs-varid'>offset</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLFArgument</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="bindArgsToRegs"></a><span class='hs-definition'>bindArgsToRegs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>GlobalReg</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-8"></a><span class='hs-definition'>bindArgsToRegs</span> <span class='hs-varid'>args</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapCs</span> <span class='hs-varid'>bind</span> <span class='hs-varid'>args</span>
<a name="line-10"></a>  <span class='hs-keyword'>where</span>
<a name="line-11"></a>    <span class='hs-varid'>bind</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindNewToReg</span> <span class='hs-varid'>arg</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmGlobal</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLFArgument</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="bindNewToNode"></a><span class='hs-definition'>bindNewToNode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VirtualHpOffset</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LambdaFormInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-14"></a><span class='hs-definition'>bindNewToNode</span> <span class='hs-varid'>id</span> <span class='hs-varid'>offset</span> <span class='hs-varid'>lf_info</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addBindC</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-varid'>nodeIdInfo</span> <span class='hs-varid'>id</span> <span class='hs-varid'>offset</span> <span class='hs-varid'>lf_info</span><span class='hs-layout'>)</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="bindNewToUntagNode"></a><span class='hs-definition'>bindNewToUntagNode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VirtualHpOffset</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LambdaFormInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-18"></a><span class='hs-definition'>bindNewToUntagNode</span> <span class='hs-varid'>id</span> <span class='hs-varid'>offset</span> <span class='hs-varid'>lf_info</span> <span class='hs-varid'>tag</span>
<a name="line-19"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addBindC</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-varid'>untagNodeIdInfo</span> <span class='hs-varid'>id</span> <span class='hs-varid'>offset</span> <span class='hs-varid'>lf_info</span> <span class='hs-varid'>tag</span><span class='hs-layout'>)</span>
<a name="line-20"></a>
<a name="line-21"></a><a name="bindNewToTemp"></a><span class='hs-comment'>-- Create a new temporary whose unique is that in the id,</span>
<a name="line-22"></a><span class='hs-comment'>-- bind the id to it, and return the addressing mode for the</span>
<a name="line-23"></a><span class='hs-comment'>-- temporary.</span>
<a name="line-24"></a><span class='hs-definition'>bindNewToTemp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>LocalReg</span>
<a name="line-25"></a><span class='hs-definition'>bindNewToTemp</span> <span class='hs-varid'>id</span>
<a name="line-26"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-varid'>addBindC</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-varid'>regIdInfo</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLocal</span> <span class='hs-varid'>temp_reg</span><span class='hs-layout'>)</span> <span class='hs-varid'>lf_info</span><span class='hs-layout'>)</span>
<a name="line-27"></a>	<span class='hs-varid'>return</span> <span class='hs-varid'>temp_reg</span>
<a name="line-28"></a>  <span class='hs-keyword'>where</span>
<a name="line-29"></a>    <span class='hs-varid'>uniq</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getUnique</span> <span class='hs-varid'>id</span>
<a name="line-30"></a>    <span class='hs-varid'>temp_reg</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LocalReg</span> <span class='hs-varid'>uniq</span> <span class='hs-layout'>(</span><span class='hs-varid'>argMachRep</span> <span class='hs-layout'>(</span><span class='hs-varid'>idCgRep</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-31"></a>    <span class='hs-varid'>lf_info</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLFArgument</span> <span class='hs-varid'>id</span>	<span class='hs-comment'>-- Always used of things we</span>
<a name="line-32"></a>				<span class='hs-comment'>-- know nothing about</span>
<a name="line-33"></a>
<a name="line-34"></a><a name="bindNewToReg"></a><span class='hs-definition'>bindNewToReg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmReg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LambdaFormInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-35"></a><span class='hs-definition'>bindNewToReg</span> <span class='hs-varid'>name</span> <span class='hs-varid'>reg</span> <span class='hs-varid'>lf_info</span>
<a name="line-36"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addBindC</span> <span class='hs-varid'>name</span> <span class='hs-varid'>info</span>
<a name="line-37"></a>  <span class='hs-keyword'>where</span>
<a name="line-38"></a>    <span class='hs-varid'>info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCgIdInfo</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-conid'>RegLoc</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span> <span class='hs-conid'>NoStableLoc</span> <span class='hs-varid'>lf_info</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="rebindToStack"></a><span class='hs-definition'>rebindToStack</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VirtualSpOffset</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-2"></a><span class='hs-definition'>rebindToStack</span> <span class='hs-varid'>name</span> <span class='hs-varid'>offset</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyBindC</span> <span class='hs-varid'>name</span> <span class='hs-varid'>replace_stable_fn</span>
<a name="line-4"></a>  <span class='hs-keyword'>where</span>
<a name="line-5"></a>    <span class='hs-varid'>replace_stable_fn</span> <span class='hs-varid'>info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>info</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cg_stb</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VirStkLoc</span> <span class='hs-varid'>offset</span> <span class='hs-layout'>}</span>
</pre>\end{code}

%************************************************************************
%*									*
\subsection[CgMonad-deadslots]{Finding dead stack slots}
%*									*
%************************************************************************

nukeDeadBindings does the following:

      -	Removes all bindings from the environment other than those
	for variables in the argument to nukeDeadBindings.
      -	Collects any stack slots so freed, and returns them to the  stack free
	list.
      -	Moves the virtual stack pointer to point to the topmost used
	stack locations.

You can have multi-word slots on the stack (where a Double# used to
be, for instance); if dead, such a slot will be reported as *several*
offsets (one per word).

Probably *naughty* to look inside monad...

\begin{code}
<pre><a name="line-1"></a><a name="nukeDeadBindings"></a><span class='hs-definition'>nukeDeadBindings</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StgLiveVars</span>  <span class='hs-comment'>-- All the *live* variables</span>
<a name="line-2"></a>		 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-3"></a><span class='hs-definition'>nukeDeadBindings</span> <span class='hs-varid'>live_vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-4"></a>	<span class='hs-varid'>binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getBinds</span>
<a name="line-5"></a>	<span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>dead_stk_slots</span><span class='hs-layout'>,</span> <span class='hs-varid'>bs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-6"></a>		<span class='hs-varid'>dead_slots</span> <span class='hs-varid'>live_vars</span> 
<a name="line-7"></a>			<span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span>
<a name="line-8"></a>			<span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>cg_id</span> <span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>varEnvElts</span> <span class='hs-varid'>binds</span> <span class='hs-keyglyph'>]</span>
<a name="line-9"></a>	<span class='hs-varid'>setBinds</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkVarEnv</span> <span class='hs-varid'>bs'</span>
<a name="line-10"></a>	<span class='hs-varid'>freeStackSlots</span> <span class='hs-varid'>dead_stk_slots</span>
</pre>\end{code}

Several boring auxiliary functions to do the dirty work.

\begin{code}
<pre><a name="line-1"></a><a name="dead_slots"></a><span class='hs-definition'>dead_slots</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StgLiveVars</span>
<a name="line-2"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>CgIdInfo</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-3"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>VirtualSpOffset</span><span class='hs-keyglyph'>]</span>
<a name="line-4"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>CgIdInfo</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-5"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>VirtualSpOffset</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>CgIdInfo</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-comment'>-- dead_slots carries accumulating parameters for</span>
<a name="line-8"></a><span class='hs-comment'>--	filtered bindings, dead slots</span>
<a name="line-9"></a><span class='hs-definition'>dead_slots</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>fbs</span> <span class='hs-varid'>ds</span> <span class='hs-conid'>[]</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>ds</span><span class='hs-layout'>,</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>fbs</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Finished; rm the dups, if any</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-definition'>dead_slots</span> <span class='hs-varid'>live_vars</span> <span class='hs-varid'>fbs</span> <span class='hs-varid'>ds</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span><span class='hs-varid'>i</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`elementOfUniqSet`</span> <span class='hs-varid'>live_vars</span>
<a name="line-14"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dead_slots</span> <span class='hs-varid'>live_vars</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span><span class='hs-varid'>i</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>fbs</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>bs</span>
<a name="line-15"></a>	  <span class='hs-comment'>-- Live, so don't record it in dead slots</span>
<a name="line-16"></a>	  <span class='hs-comment'>-- Instead keep it in the filtered bindings</span>
<a name="line-17"></a>
<a name="line-18"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-19"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cg_stb</span> <span class='hs-varid'>i</span> <span class='hs-keyword'>of</span>
<a name="line-20"></a>	<span class='hs-conid'>VirStkLoc</span> <span class='hs-varid'>offset</span>
<a name="line-21"></a>	 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>size</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span>
<a name="line-22"></a>	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>dead_slots</span> <span class='hs-varid'>live_vars</span> <span class='hs-varid'>fbs</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>offset</span><span class='hs-comment'>-</span><span class='hs-varid'>size</span><span class='hs-varop'>+</span><span class='hs-num'>1</span> <span class='hs-keyglyph'>..</span> <span class='hs-varid'>offset</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>++</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-varid'>bs</span>
<a name="line-23"></a>
<a name="line-24"></a>	<span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>dead_slots</span> <span class='hs-varid'>live_vars</span> <span class='hs-varid'>fbs</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>bs</span>
<a name="line-25"></a>  <span class='hs-keyword'>where</span>
<a name="line-26"></a>    <span class='hs-varid'>size</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WordOff</span>
<a name="line-27"></a>    <span class='hs-varid'>size</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cgRepSizeW</span> <span class='hs-layout'>(</span><span class='hs-varid'>cg_rep</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="getLiveStackSlots"></a><span class='hs-definition'>getLiveStackSlots</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FCode</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>VirtualSpOffset</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-comment'>-- Return the offsets of slots in stack containig live pointers</span>
<a name="line-3"></a><span class='hs-definition'>getLiveStackSlots</span> 
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 	<span class='hs-layout'>{</span> <span class='hs-varid'>binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getBinds</span>
<a name="line-5"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>off</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CgIdInfo</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cg_stb</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VirStkLoc</span> <span class='hs-varid'>off</span><span class='hs-layout'>,</span> 
<a name="line-6"></a>				   <span class='hs-varid'>cg_rep</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rep</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>varEnvElts</span> <span class='hs-varid'>binds</span><span class='hs-layout'>,</span> 
<a name="line-7"></a>		        <span class='hs-varid'>isFollowableArg</span> <span class='hs-varid'>rep</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="getLiveStackBindings"></a><span class='hs-definition'>getLiveStackBindings</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FCode</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>VirtualSpOffset</span><span class='hs-layout'>,</span> <span class='hs-conid'>CgIdInfo</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-definition'>getLiveStackBindings</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getBinds</span>
<a name="line-4"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>off</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span>
<a name="line-5"></a>                 <span class='hs-varid'>bind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>varEnvElts</span> <span class='hs-varid'>binds</span><span class='hs-layout'>,</span>
<a name="line-6"></a>                 <span class='hs-conid'>CgIdInfo</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cg_stb</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VirStkLoc</span> <span class='hs-varid'>off</span><span class='hs-layout'>,</span>
<a name="line-7"></a>                            <span class='hs-varid'>cg_rep</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rep</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>bind</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-8"></a>                 <span class='hs-varid'>isFollowableArg</span> <span class='hs-varid'>rep</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
</pre>\end{code}
</body>
</html>
