<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>stgSyn/CoreToStg.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The GRASP/AQUA Project, Glasgow University, 1993-1998
%
\section[CoreToStg]{Converts Core to STG Syntax}

And, as we have the info in hand, we may convert some lets to
let-no-escapes.

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>CoreToStg</span> <span class='hs-layout'>(</span> <span class='hs-varid'>coreToStg</span><span class='hs-layout'>,</span> <span class='hs-varid'>coreExprToStg</span> <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreSyn</span>
<a name="line-13"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreUtils</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>exprType</span><span class='hs-layout'>,</span> <span class='hs-varid'>findDefault</span> <span class='hs-layout'>)</span>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreArity</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>manifestArity</span> <span class='hs-layout'>)</span>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>StgSyn</span>
<a name="line-16"></a>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MkId</span>		<span class='hs-layout'>(</span> <span class='hs-varid'>coercionTokenId</span> <span class='hs-layout'>)</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>IdInfo</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CostCentre</span>       <span class='hs-layout'>(</span> <span class='hs-varid'>noCCS</span> <span class='hs-layout'>)</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>           <span class='hs-layout'>(</span> <span class='hs-varid'>maybeToBool</span> <span class='hs-layout'>)</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>             <span class='hs-layout'>(</span> <span class='hs-varid'>getOccName</span><span class='hs-layout'>,</span> <span class='hs-varid'>isExternalName</span><span class='hs-layout'>,</span> <span class='hs-varid'>nameOccName</span> <span class='hs-layout'>)</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OccName</span>          <span class='hs-layout'>(</span> <span class='hs-varid'>occNameString</span><span class='hs-layout'>,</span> <span class='hs-varid'>occNameFS</span> <span class='hs-layout'>)</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>       <span class='hs-layout'>(</span> <span class='hs-conid'>Arity</span> <span class='hs-layout'>)</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Literal</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MonadUtils</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ForeignCall</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrimOp</span>           <span class='hs-layout'>(</span> <span class='hs-conid'>PrimCall</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection[live-vs-free-doc]{Documentation}
%*                                                                      *
%************************************************************************

(There is other relevant documentation in codeGen/CgLetNoEscape.)

The actual Stg datatype is decorated with {\em live variable}
information, as well as {\em free variable} information.  The two are
{\em not} the same.  Liveness is an operational property rather than a
semantic one.  A variable is live at a particular execution point if
it can be referred to {\em directly} again.  In particular, a dead
variable's stack slot (if it has one):
\begin{enumerate}
\item
should be stubbed to avoid space leaks, and
\item
may be reused for something else.
\end{enumerate}

There ought to be a better way to say this.  Here are some examples:
\begin{verbatim}
        let v = [q] \[x] -> e
        in
        ...v...  (but no q's)
\end{verbatim}

Just after the `in', v is live, but q is dead.  If the whole of that
let expression was enclosed in a case expression, thus:
\begin{verbatim}
        case (let v = [q] \[x] -> e in ...v...) of
                alts[...q...]
\end{verbatim}
(ie @alts@ mention @q@), then @q@ is live even after the `in'; because
we'll return later to the @alts@ and need it.

Let-no-escapes make this a bit more interesting:
\begin{verbatim}
        let-no-escape v = [q] \ [x] -> e
        in
        ...v...
\end{verbatim}
Here, @q@ is still live at the `in', because @v@ is represented not by
a closure but by the current stack state.  In other words, if @v@ is
live then so is @q@.  Furthermore, if @e@ mentions an enclosing
let-no-escaped variable, then {\em its} free variables are also live
if @v@ is.

%************************************************************************
%*                                                                      *
\subsection[caf-info]{Collecting live CAF info}
%*                                                                      *
%************************************************************************

In this pass we also collect information on which CAFs are live for
constructing SRTs (see SRT.lhs).

A top-level Id has CafInfo, which is

        - MayHaveCafRefs, if it may refer indirectly to
          one or more CAFs, or
        - NoCafRefs if it definitely doesn't

The CafInfo has already been calculated during the CoreTidy pass.

During CoreToStg, we then pin onto each binding and case expression, a
list of Ids which represents the "live" CAFs at that point.  The meaning
of "live" here is the same as for live variables, see above (which is
why it's convenient to collect CAF information here rather than elsewhere).

The later SRT pass takes these lists of Ids and uses them to construct
the actual nested SRTs, and replaces the lists of Ids with (offset,length)
pairs.


Interaction of let-no-escape with SRTs   [Sept 01]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider

        let-no-escape x = ...caf1...caf2...
        in
        ...x...x...x...

where caf1,caf2 are CAFs.  Since x doesn't have a closure, we
build SRTs just as if x's defn was inlined at each call site, and
that means that x's CAF refs get duplicated in the overall SRT.

This is unlike ordinary lets, in which the CAF refs are not duplicated.

We could fix this loss of (static) sharing by making a sort of pseudo-closure
for x, solely to put in the SRTs lower down.


%************************************************************************
%*                                                                      *
\subsection[binds-StgVarInfo]{Setting variable info: top-level, binds, RHSs}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="coreToStg"></a><span class='hs-definition'>coreToStg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StgBinding</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-definition'>coreToStg</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>pgm</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>pgm'</span>
<a name="line-4"></a>  <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>pgm'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coreTopBindsToStg</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>emptyVarEnv</span> <span class='hs-varid'>pgm</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="coreExprToStg"></a><span class='hs-definition'>coreExprToStg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgExpr</span>
<a name="line-7"></a><span class='hs-definition'>coreExprToStg</span> <span class='hs-varid'>expr</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_expr</span> <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_expr</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initLne</span> <span class='hs-varid'>emptyVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>coreToStgExpr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-9"></a>
<a name="line-10"></a>
<a name="line-11"></a><a name="coreTopBindsToStg"></a><span class='hs-definition'>coreTopBindsToStg</span>
<a name="line-12"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span>
<a name="line-13"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IdEnv</span> <span class='hs-conid'>HowBound</span>           <span class='hs-comment'>-- environment for the bindings</span>
<a name="line-14"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span>
<a name="line-15"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>IdEnv</span> <span class='hs-conid'>HowBound</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVarsInfo</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StgBinding</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-16"></a>
<a name="line-17"></a><span class='hs-definition'>coreTopBindsToStg</span> <span class='hs-keyword'>_</span>        <span class='hs-varid'>env</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVInfo</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-18"></a><span class='hs-definition'>coreTopBindsToStg</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-conop'>:</span><span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
<a name="line-19"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>b'</span><span class='hs-conop'>:</span><span class='hs-varid'>bs'</span><span class='hs-layout'>)</span>
<a name="line-20"></a>  <span class='hs-keyword'>where</span>
<a name="line-21"></a>        <span class='hs-comment'>-- Notice the mutually-recursive "knot" here:</span>
<a name="line-22"></a>        <span class='hs-comment'>--   env accumulates down the list of binds,</span>
<a name="line-23"></a>        <span class='hs-comment'>--   fvs accumulates upwards</span>
<a name="line-24"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>b'</span> <span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coreTopBindToStg</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>env</span> <span class='hs-varid'>fvs1</span> <span class='hs-varid'>b</span>
<a name="line-25"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>,</span> <span class='hs-varid'>bs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coreTopBindsToStg</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>bs</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="coreTopBindToStg"></a><span class='hs-definition'>coreTopBindToStg</span>
<a name="line-28"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span>
<a name="line-29"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IdEnv</span> <span class='hs-conid'>HowBound</span>
<a name="line-30"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeVarsInfo</span>         <span class='hs-comment'>-- Info about the body</span>
<a name="line-31"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreBind</span>
<a name="line-32"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>IdEnv</span> <span class='hs-conid'>HowBound</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVarsInfo</span><span class='hs-layout'>,</span> <span class='hs-conid'>StgBinding</span><span class='hs-layout'>)</span>
<a name="line-33"></a>
<a name="line-34"></a><span class='hs-definition'>coreTopBindToStg</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>env</span> <span class='hs-varid'>body_fvs</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>id</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-35"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span>
<a name="line-36"></a>        <span class='hs-varid'>env'</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>id</span> <span class='hs-varid'>how_bound</span>
<a name="line-37"></a>        <span class='hs-varid'>how_bound</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LetBound</span> <span class='hs-conid'>TopLet</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>manifestArity</span> <span class='hs-varid'>rhs</span>
<a name="line-38"></a>
<a name="line-39"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>stg_rhs</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-40"></a>            <span class='hs-varid'>initLne</span> <span class='hs-varid'>env</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-41"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>stg_rhs</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreToTopStgRhs</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>body_fvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-layout'>,</span><span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-42"></a>              <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>stg_rhs</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs'</span><span class='hs-layout'>)</span>
<a name="line-43"></a>
<a name="line-44"></a>        <span class='hs-varid'>bind</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgNonRec</span> <span class='hs-varid'>id</span> <span class='hs-varid'>stg_rhs</span>
<a name="line-45"></a>    <span class='hs-keyword'>in</span>
<a name="line-46"></a>    <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span><span class='hs-varid'>consistentCafInfo</span> <span class='hs-varid'>id</span> <span class='hs-varid'>bind</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span> <span class='hs-layout'>)</span>
<a name="line-47"></a>      <span class='hs-comment'>-- NB: previously the assertion printed 'rhs' and 'bind'</span>
<a name="line-48"></a>      <span class='hs-comment'>--     as well as 'id', but that led to a black hole</span>
<a name="line-49"></a>      <span class='hs-comment'>--     where printing the assertion error tripped the</span>
<a name="line-50"></a>      <span class='hs-comment'>--     assertion again!</span>
<a name="line-51"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs'</span> <span class='hs-varop'>`unionFVInfo`</span> <span class='hs-varid'>body_fvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span>
<a name="line-52"></a>
<a name="line-53"></a><span class='hs-definition'>coreTopBindToStg</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>env</span> <span class='hs-varid'>body_fvs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span>
<a name="line-54"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-55"></a>    <span class='hs-keyword'>let</span>
<a name="line-56"></a>        <span class='hs-varid'>binders</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>pairs</span>
<a name="line-57"></a>
<a name="line-58"></a>        <span class='hs-varid'>extra_env'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-conid'>LetBound</span> <span class='hs-conid'>TopLet</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>manifestArity</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-59"></a>                     <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>pairs</span> <span class='hs-keyglyph'>]</span>
<a name="line-60"></a>        <span class='hs-varid'>env'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnvList</span> <span class='hs-varid'>env</span> <span class='hs-varid'>extra_env'</span>
<a name="line-61"></a>
<a name="line-62"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>stg_rhss</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs'</span><span class='hs-layout'>)</span>
<a name="line-63"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initLne</span> <span class='hs-varid'>env'</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-64"></a>               <span class='hs-layout'>(</span><span class='hs-varid'>stg_rhss</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvss'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndUnzipM</span> <span class='hs-layout'>(</span><span class='hs-varid'>coreToTopStgRhs</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>body_fvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>pairs</span>
<a name="line-65"></a>               <span class='hs-keyword'>let</span> <span class='hs-varid'>fvs'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unionFVInfos</span> <span class='hs-varid'>fvss'</span>
<a name="line-66"></a>               <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>stg_rhss</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs'</span><span class='hs-layout'>)</span>
<a name="line-67"></a>
<a name="line-68"></a>        <span class='hs-varid'>bind</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgRec</span> <span class='hs-layout'>(</span><span class='hs-varid'>zip</span> <span class='hs-varid'>binders</span> <span class='hs-varid'>stg_rhss</span><span class='hs-layout'>)</span>
<a name="line-69"></a>    <span class='hs-keyword'>in</span>
<a name="line-70"></a>    <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span><span class='hs-varid'>consistentCafInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>binders</span><span class='hs-layout'>)</span> <span class='hs-varid'>bind</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>binders</span><span class='hs-layout'>)</span>
<a name="line-71"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs'</span> <span class='hs-varop'>`unionFVInfo`</span> <span class='hs-varid'>body_fvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span>
<a name="line-72"></a>
<a name="line-73"></a>
<a name="line-74"></a><a name="consistentCafInfo"></a><span class='hs-comment'>-- Assertion helper: this checks that the CafInfo on the Id matches</span>
<a name="line-75"></a><span class='hs-comment'>-- what CoreToStg has figured out about the binding's SRT.  The</span>
<a name="line-76"></a><span class='hs-comment'>-- CafInfo will be exact in all cases except when CorePrep has</span>
<a name="line-77"></a><span class='hs-comment'>-- floated out a binding, in which case it will be approximate.</span>
<a name="line-78"></a><span class='hs-definition'>consistentCafInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GenStgBinding</span> <span class='hs-conid'>Var</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-79"></a><span class='hs-definition'>consistentCafInfo</span> <span class='hs-varid'>id</span> <span class='hs-varid'>bind</span>
<a name="line-80"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>exact</span> <span class='hs-varop'>||</span> <span class='hs-varid'>is_sat_thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>id_marked_caffy</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>binding_is_caffy</span> <span class='hs-layout'>)</span>
<a name="line-81"></a>    <span class='hs-keyword'>safe</span>
<a name="line-82"></a>  <span class='hs-keyword'>where</span>
<a name="line-83"></a>    <span class='hs-keyword'>safe</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id_marked_caffy</span> <span class='hs-varop'>||</span> <span class='hs-varid'>not</span> <span class='hs-varid'>binding_is_caffy</span>
<a name="line-84"></a>    <span class='hs-varid'>exact</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id_marked_caffy</span> <span class='hs-varop'>==</span> <span class='hs-varid'>binding_is_caffy</span>
<a name="line-85"></a>    <span class='hs-varid'>id_marked_caffy</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mayHaveCafRefs</span> <span class='hs-layout'>(</span><span class='hs-varid'>idCafInfo</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-86"></a>    <span class='hs-varid'>binding_is_caffy</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stgBindHasCafRefs</span> <span class='hs-varid'>bind</span>
<a name="line-87"></a>    <span class='hs-varid'>is_sat_thing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occNameFS</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameOccName</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>==</span> <span class='hs-varid'>fsLit</span> <span class='hs-str'>"sat"</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="coreToTopStgRhs"></a><span class='hs-definition'>coreToTopStgRhs</span>
<a name="line-2"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span>
<a name="line-3"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeVarsInfo</span>         <span class='hs-comment'>-- Free var info for the scope of the binding</span>
<a name="line-4"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span>
<a name="line-5"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LneM</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgRhs</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVarsInfo</span><span class='hs-layout'>)</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-definition'>coreToTopStgRhs</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>scope_fv_info</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_rhs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_fvs</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreToStgExpr</span> <span class='hs-varid'>rhs</span>
<a name="line-9"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>lv_info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>freeVarsToLiveVars</span> <span class='hs-varid'>rhs_fvs</span>
<a name="line-10"></a>
<a name="line-11"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>stg_rhs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTopStgRhs</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>rhs_fvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSRT</span> <span class='hs-varid'>lv_info</span><span class='hs-layout'>)</span> <span class='hs-varid'>bndr_info</span> <span class='hs-varid'>new_rhs</span>
<a name="line-12"></a>             <span class='hs-varid'>stg_arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stgRhsArity</span> <span class='hs-varid'>stg_rhs</span>
<a name="line-13"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>arity_ok</span> <span class='hs-varid'>stg_arity</span><span class='hs-layout'>,</span> <span class='hs-varid'>mk_arity_msg</span> <span class='hs-varid'>stg_arity</span><span class='hs-layout'>)</span> <span class='hs-varid'>stg_rhs</span><span class='hs-layout'>,</span>
<a name="line-14"></a>                 <span class='hs-varid'>rhs_fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-15"></a>  <span class='hs-keyword'>where</span>
<a name="line-16"></a>    <span class='hs-varid'>bndr_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupFVInfo</span> <span class='hs-varid'>scope_fv_info</span> <span class='hs-varid'>bndr</span>
<a name="line-17"></a>
<a name="line-18"></a>        <span class='hs-comment'>-- It's vital that the arity on a top-level Id matches</span>
<a name="line-19"></a>        <span class='hs-comment'>-- the arity of the generated STG binding, else an importing</span>
<a name="line-20"></a>        <span class='hs-comment'>-- module will use the wrong calling convention</span>
<a name="line-21"></a>        <span class='hs-comment'>--      (Trac #2844 was an example where this happened)</span>
<a name="line-22"></a>        <span class='hs-comment'>-- NB1: we can't move the assertion further out without</span>
<a name="line-23"></a>        <span class='hs-comment'>--      blocking the "knot" tied in coreTopBindsToStg</span>
<a name="line-24"></a>        <span class='hs-comment'>-- NB2: the arity check is only needed for Ids with External</span>
<a name="line-25"></a>        <span class='hs-comment'>--      Names, because they are externally visible.  The CorePrep</span>
<a name="line-26"></a>        <span class='hs-comment'>--      pass introduces "sat" things with Local Names and does</span>
<a name="line-27"></a>        <span class='hs-comment'>--      not bother to set their Arity info, so don't fail for those</span>
<a name="line-28"></a>    <span class='hs-varid'>arity_ok</span> <span class='hs-varid'>stg_arity</span>
<a name="line-29"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isExternalName</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id_arity</span> <span class='hs-varop'>==</span> <span class='hs-varid'>stg_arity</span>
<a name="line-30"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-31"></a>    <span class='hs-varid'>id_arity</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idArity</span> <span class='hs-varid'>bndr</span>
<a name="line-32"></a>    <span class='hs-varid'>mk_arity_msg</span> <span class='hs-varid'>stg_arity</span>
<a name="line-33"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>,</span>
<a name="line-34"></a>                <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Id arity:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>id_arity</span><span class='hs-layout'>,</span>
<a name="line-35"></a>                <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"STG arity:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>stg_arity</span><span class='hs-keyglyph'>]</span>
<a name="line-36"></a>
<a name="line-37"></a><a name="mkTopStgRhs"></a><span class='hs-definition'>mkTopStgRhs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeVarsInfo</span>
<a name="line-38"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SRT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgBinderInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgExpr</span>
<a name="line-39"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgRhs</span>
<a name="line-40"></a>
<a name="line-41"></a><span class='hs-definition'>mkTopStgRhs</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>rhs_fvs</span> <span class='hs-varid'>srt</span> <span class='hs-varid'>binder_info</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgLam</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-42"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgRhsClosure</span> <span class='hs-varid'>noCCS</span> <span class='hs-varid'>binder_info</span>
<a name="line-43"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>getFVs</span> <span class='hs-varid'>rhs_fvs</span><span class='hs-layout'>)</span>
<a name="line-44"></a>                  <span class='hs-conid'>ReEntrant</span>
<a name="line-45"></a>                  <span class='hs-varid'>srt</span>
<a name="line-46"></a>                  <span class='hs-varid'>bndrs</span> <span class='hs-varid'>body</span>
<a name="line-47"></a>
<a name="line-48"></a><span class='hs-definition'>mkTopStgRhs</span> <span class='hs-varid'>dflags</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgConApp</span> <span class='hs-varid'>con</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-49"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isDllConApp</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>con</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Dynamic StgConApps are updatable</span>
<a name="line-50"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgRhsCon</span> <span class='hs-varid'>noCCS</span> <span class='hs-varid'>con</span> <span class='hs-varid'>args</span>
<a name="line-51"></a>
<a name="line-52"></a><span class='hs-definition'>mkTopStgRhs</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>rhs_fvs</span> <span class='hs-varid'>srt</span> <span class='hs-varid'>binder_info</span> <span class='hs-varid'>rhs</span>
<a name="line-53"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgRhsClosure</span> <span class='hs-varid'>noCCS</span> <span class='hs-varid'>binder_info</span>
<a name="line-54"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>getFVs</span> <span class='hs-varid'>rhs_fvs</span><span class='hs-layout'>)</span>
<a name="line-55"></a>                  <span class='hs-conid'>Updatable</span>
<a name="line-56"></a>                  <span class='hs-varid'>srt</span>
<a name="line-57"></a>                  <span class='hs-conid'>[]</span> <span class='hs-varid'>rhs</span>
</pre>\end{code}


-- ---------------------------------------------------------------------------
-- Expressions
-- ---------------------------------------------------------------------------

\begin{code}
<pre><a name="line-1"></a><a name="coreToStgExpr"></a><span class='hs-definition'>coreToStgExpr</span>
<a name="line-2"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-3"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LneM</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgExpr</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- Decorated STG expr</span>
<a name="line-4"></a>                 <span class='hs-conid'>FreeVarsInfo</span><span class='hs-layout'>,</span>  <span class='hs-comment'>-- Its free vars (NB free, not live)</span>
<a name="line-5"></a>                 <span class='hs-conid'>EscVarsSet</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- Its escapees, a subset of its free vars;</span>
<a name="line-6"></a>                                <span class='hs-comment'>-- also a subset of the domain of the envt</span>
<a name="line-7"></a>                                <span class='hs-comment'>-- because we are only interested in the escapees</span>
<a name="line-8"></a>                                <span class='hs-comment'>-- for vars which might be turned into</span>
<a name="line-9"></a>                                <span class='hs-comment'>-- let-no-escaped ones.</span>
</pre>\end{code}

The second and third components can be derived in a simple bottom up pass, not
dependent on any decisions about which variables will be let-no-escaped or
not.  The first component, that is, the decorated expression, may then depend
on these components, but it in turn is not scrutinised as the basis for any
decisions.  Hence no black holes.

\begin{code}
<pre><a name="line-1"></a><a name="coreToStgExpr"></a><span class='hs-comment'>-- No LitInteger's should be left by the time this is called. CorePrep</span>
<a name="line-2"></a><span class='hs-comment'>-- should have converted them all to a real core representation.</span>
<a name="line-3"></a><span class='hs-definition'>coreToStgExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lit</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitInteger</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"coreToStgExpr: LitInteger"</span>
<a name="line-4"></a><span class='hs-definition'>coreToStgExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lit</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgLit</span> <span class='hs-varid'>l</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVInfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyVarSet</span><span class='hs-layout'>)</span>
<a name="line-5"></a><span class='hs-definition'>coreToStgExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coreToStgApp</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>v</span>               <span class='hs-conid'>[]</span>
<a name="line-6"></a><span class='hs-definition'>coreToStgExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coreToStgApp</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>coercionTokenId</span> <span class='hs-conid'>[]</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-definition'>coreToStgExpr</span> <span class='hs-varid'>expr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coreToStgApp</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>f</span> <span class='hs-varid'>args</span>
<a name="line-10"></a>  <span class='hs-keyword'>where</span>
<a name="line-11"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>f</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>myCollectArgs</span> <span class='hs-varid'>expr</span>
<a name="line-12"></a>
<a name="line-13"></a><span class='hs-definition'>coreToStgExpr</span> <span class='hs-varid'>expr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span>
<a name="line-15"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>myCollectBinders</span> <span class='hs-varid'>expr</span>
<a name="line-16"></a>        <span class='hs-varid'>args'</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterStgBinders</span> <span class='hs-varid'>args</span>
<a name="line-17"></a>    <span class='hs-keyword'>in</span>
<a name="line-18"></a>    <span class='hs-varid'>extendVarEnvLne</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>LambdaBound</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>args'</span> <span class='hs-keyglyph'>]</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-19"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>body</span><span class='hs-layout'>,</span> <span class='hs-varid'>body_fvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>body_escs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreToStgExpr</span> <span class='hs-varid'>body</span>
<a name="line-20"></a>    <span class='hs-keyword'>let</span>
<a name="line-21"></a>        <span class='hs-varid'>fvs</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args'</span> <span class='hs-varop'>`minusFVBinders`</span> <span class='hs-varid'>body_fvs</span>
<a name="line-22"></a>        <span class='hs-varid'>escs</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>body_escs</span> <span class='hs-varop'>`delVarSetList`</span> <span class='hs-varid'>args'</span>
<a name="line-23"></a>        <span class='hs-varid'>result_expr</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>args'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>body</span>
<a name="line-24"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgLam</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprType</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span> <span class='hs-varid'>args'</span> <span class='hs-varid'>body</span>
<a name="line-25"></a>
<a name="line-26"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>result_expr</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>escs</span><span class='hs-layout'>)</span>
<a name="line-27"></a>
<a name="line-28"></a><span class='hs-definition'>coreToStgExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-layout'>(</span><span class='hs-conid'>HpcTick</span> <span class='hs-varid'>m</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-29"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr2</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>escs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreToStgExpr</span> <span class='hs-varid'>expr</span>
<a name="line-30"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgTick</span> <span class='hs-varid'>m</span> <span class='hs-varid'>n</span> <span class='hs-varid'>expr2</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>escs</span><span class='hs-layout'>)</span>
<a name="line-31"></a>
<a name="line-32"></a><span class='hs-definition'>coreToStgExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProfNote</span> <span class='hs-varid'>cc</span> <span class='hs-varid'>tick</span> <span class='hs-varid'>push</span><span class='hs-layout'>)</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-33"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr2</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>escs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreToStgExpr</span> <span class='hs-varid'>expr</span>
<a name="line-34"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgSCC</span> <span class='hs-varid'>cc</span> <span class='hs-varid'>tick</span> <span class='hs-varid'>push</span> <span class='hs-varid'>expr2</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>escs</span><span class='hs-layout'>)</span>
<a name="line-35"></a>
<a name="line-36"></a><span class='hs-definition'>coreToStgExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-conid'>Breakpoint</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-sel'>_expr</span><span class='hs-layout'>)</span>
<a name="line-37"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"coreToStgExpr: breakpoint should not happen"</span>
<a name="line-38"></a>
<a name="line-39"></a><span class='hs-definition'>coreToStgExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>expr</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-40"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coreToStgExpr</span> <span class='hs-varid'>expr</span>
<a name="line-41"></a>
<a name="line-42"></a><span class='hs-comment'>-- Cases require a little more real work.</span>
<a name="line-43"></a>
<a name="line-44"></a><span class='hs-definition'>coreToStgExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Case</span> <span class='hs-varid'>scrut</span> <span class='hs-varid'>bndr</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-45"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>alts2</span><span class='hs-layout'>,</span> <span class='hs-varid'>alts_fvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>alts_escs</span><span class='hs-layout'>)</span>
<a name="line-46"></a>       <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>extendVarEnvLne</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>bndr</span><span class='hs-layout'>,</span> <span class='hs-conid'>LambdaBound</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-47"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>alts2</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs_s</span><span class='hs-layout'>,</span> <span class='hs-varid'>escs_s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndUnzip3M</span> <span class='hs-varid'>vars_alt</span> <span class='hs-varid'>alts</span>
<a name="line-48"></a>            <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-varid'>alts2</span><span class='hs-layout'>,</span>
<a name="line-49"></a>                     <span class='hs-varid'>unionFVInfos</span> <span class='hs-varid'>fvs_s</span><span class='hs-layout'>,</span>
<a name="line-50"></a>                     <span class='hs-varid'>unionVarSets</span> <span class='hs-varid'>escs_s</span> <span class='hs-layout'>)</span>
<a name="line-51"></a>    <span class='hs-keyword'>let</span>
<a name="line-52"></a>        <span class='hs-comment'>-- Determine whether the default binder is dead or not</span>
<a name="line-53"></a>        <span class='hs-comment'>-- This helps the code generator to avoid generating an assignment</span>
<a name="line-54"></a>        <span class='hs-comment'>-- for the case binder (is extremely rare cases) ToDo: remove.</span>
<a name="line-55"></a>        <span class='hs-varid'>bndr'</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>bndr</span> <span class='hs-varop'>`elementOfFVInfo`</span> <span class='hs-varid'>alts_fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndr</span>
<a name="line-56"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndr</span> <span class='hs-varop'>`setIdOccInfo`</span> <span class='hs-conid'>IAmDead</span>
<a name="line-57"></a>
<a name="line-58"></a>        <span class='hs-comment'>-- Don't consider the default binder as being 'live in alts',</span>
<a name="line-59"></a>        <span class='hs-comment'>-- since this is from the point of view of the case expr, where</span>
<a name="line-60"></a>        <span class='hs-comment'>-- the default binder is not free.</span>
<a name="line-61"></a>        <span class='hs-varid'>alts_fvs_wo_bndr</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndr</span> <span class='hs-varop'>`minusFVBinder`</span> <span class='hs-varid'>alts_fvs</span>
<a name="line-62"></a>        <span class='hs-varid'>alts_escs_wo_bndr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>alts_escs</span> <span class='hs-varop'>`delVarSet`</span> <span class='hs-varid'>bndr</span>
<a name="line-63"></a>
<a name="line-64"></a>    <span class='hs-varid'>alts_lv_info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>freeVarsToLiveVars</span> <span class='hs-varid'>alts_fvs_wo_bndr</span>
<a name="line-65"></a>
<a name="line-66"></a>        <span class='hs-comment'>-- We tell the scrutinee that everything</span>
<a name="line-67"></a>        <span class='hs-comment'>-- live in the alts is live in it, too.</span>
<a name="line-68"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>scrut2</span><span class='hs-layout'>,</span> <span class='hs-varid'>scrut_fvs</span><span class='hs-layout'>,</span> <span class='hs-sel'>_scrut_escs</span><span class='hs-layout'>,</span> <span class='hs-varid'>scrut_lv_info</span><span class='hs-layout'>)</span>
<a name="line-69"></a>       <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setVarsLiveInCont</span> <span class='hs-varid'>alts_lv_info</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-70"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>scrut2</span><span class='hs-layout'>,</span> <span class='hs-varid'>scrut_fvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>scrut_escs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreToStgExpr</span> <span class='hs-varid'>scrut</span>
<a name="line-71"></a>            <span class='hs-varid'>scrut_lv_info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>freeVarsToLiveVars</span> <span class='hs-varid'>scrut_fvs</span>
<a name="line-72"></a>            <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>scrut2</span><span class='hs-layout'>,</span> <span class='hs-varid'>scrut_fvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>scrut_escs</span><span class='hs-layout'>,</span> <span class='hs-varid'>scrut_lv_info</span><span class='hs-layout'>)</span>
<a name="line-73"></a>
<a name="line-74"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span>
<a name="line-75"></a>      <span class='hs-conid'>StgCase</span> <span class='hs-varid'>scrut2</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLiveVars</span> <span class='hs-varid'>scrut_lv_info</span><span class='hs-layout'>)</span>
<a name="line-76"></a>                     <span class='hs-layout'>(</span><span class='hs-varid'>getLiveVars</span> <span class='hs-varid'>alts_lv_info</span><span class='hs-layout'>)</span>
<a name="line-77"></a>                     <span class='hs-varid'>bndr'</span>
<a name="line-78"></a>                     <span class='hs-layout'>(</span><span class='hs-varid'>mkSRT</span> <span class='hs-varid'>alts_lv_info</span><span class='hs-layout'>)</span>
<a name="line-79"></a>                     <span class='hs-layout'>(</span><span class='hs-varid'>mkStgAltType</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span>
<a name="line-80"></a>                     <span class='hs-varid'>alts2</span><span class='hs-layout'>,</span>
<a name="line-81"></a>      <span class='hs-varid'>scrut_fvs</span> <span class='hs-varop'>`unionFVInfo`</span> <span class='hs-varid'>alts_fvs_wo_bndr</span><span class='hs-layout'>,</span>
<a name="line-82"></a>      <span class='hs-varid'>alts_escs_wo_bndr</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>getFVSet</span> <span class='hs-varid'>scrut_fvs</span>
<a name="line-83"></a>                <span class='hs-comment'>-- You might think we should have scrut_escs, not</span>
<a name="line-84"></a>                <span class='hs-comment'>-- (getFVSet scrut_fvs), but actually we can't call, and</span>
<a name="line-85"></a>                <span class='hs-comment'>-- then return from, a let-no-escape thing.</span>
<a name="line-86"></a>      <span class='hs-layout'>)</span>
<a name="line-87"></a>  <span class='hs-keyword'>where</span>
<a name="line-88"></a>    <span class='hs-varid'>vars_alt</span> <span class='hs-layout'>(</span><span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>binders</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-89"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span>     <span class='hs-comment'>-- Remove type variables</span>
<a name="line-90"></a>            <span class='hs-varid'>binders'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterStgBinders</span> <span class='hs-varid'>binders</span>
<a name="line-91"></a>        <span class='hs-keyword'>in</span>
<a name="line-92"></a>        <span class='hs-varid'>extendVarEnvLne</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-conid'>LambdaBound</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>binders'</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-93"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>rhs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_fvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_escs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreToStgExpr</span> <span class='hs-varid'>rhs</span>
<a name="line-94"></a>        <span class='hs-keyword'>let</span>
<a name="line-95"></a>                <span class='hs-comment'>-- Records whether each param is used in the RHS</span>
<a name="line-96"></a>            <span class='hs-varid'>good_use_mask</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>b</span> <span class='hs-varop'>`elementOfFVInfo`</span> <span class='hs-varid'>rhs_fvs</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>binders'</span> <span class='hs-keyglyph'>]</span>
<a name="line-97"></a>
<a name="line-98"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-layout'>(</span><span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>binders'</span><span class='hs-layout'>,</span> <span class='hs-varid'>good_use_mask</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs2</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-99"></a>                 <span class='hs-varid'>binders'</span> <span class='hs-varop'>`minusFVBinders`</span> <span class='hs-varid'>rhs_fvs</span><span class='hs-layout'>,</span>
<a name="line-100"></a>                 <span class='hs-varid'>rhs_escs</span> <span class='hs-varop'>`delVarSetList`</span> <span class='hs-varid'>binders'</span> <span class='hs-layout'>)</span>
<a name="line-101"></a>                <span class='hs-comment'>-- ToDo: remove the delVarSet;</span>
<a name="line-102"></a>                <span class='hs-comment'>-- since escs won't include any of these binders</span>
</pre>\end{code}

Lets not only take quite a bit of work, but this is where we convert
then to let-no-escapes, if we wish.

(Meanwhile, we don't expect to see let-no-escapes...)
\begin{code}
<pre><a name="line-1"></a><a name="coreToStgExpr"></a><span class='hs-definition'>coreToStgExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Let</span> <span class='hs-varid'>bind</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-2"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>new_let</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>escs</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-3"></a>       <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mfix</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-keyglyph'>~</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>no_binder_escapes</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-4"></a>             <span class='hs-varid'>coreToStgLet</span> <span class='hs-varid'>no_binder_escapes</span> <span class='hs-varid'>bind</span> <span class='hs-varid'>body</span>
<a name="line-5"></a>          <span class='hs-layout'>)</span>
<a name="line-6"></a>
<a name="line-7"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_let</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>escs</span><span class='hs-layout'>)</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-definition'>coreToStgExpr</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"coreToStgExpr"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="mkStgAltType"></a><span class='hs-definition'>mkStgAltType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreAlt</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AltType</span>
<a name="line-2"></a><span class='hs-definition'>mkStgAltType</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>alts</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tyConAppTyCon_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>repType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-4"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isUnboxedTupleTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UbxTupAlt</span> <span class='hs-varid'>tc</span>
<a name="line-5"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isUnLiftedTyCon</span> <span class='hs-varid'>tc</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PrimAlt</span> <span class='hs-varid'>tc</span>
<a name="line-6"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isAbstractTyCon</span> <span class='hs-varid'>tc</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>look_for_better_tycon</span>
<a name="line-7"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isAlgTyCon</span> <span class='hs-varid'>tc</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AlgAlt</span> <span class='hs-varid'>tc</span>
<a name="line-8"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-sel'>_is_poly_alt_tycon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>)</span>
<a name="line-9"></a>                                            <span class='hs-conid'>PolyAlt</span>
<a name="line-10"></a>        <span class='hs-conid'>Nothing</span>                          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PolyAlt</span>
<a name="line-11"></a>
<a name="line-12"></a>  <span class='hs-keyword'>where</span>
<a name="line-13"></a>   <span class='hs-sel'>_is_poly_alt_tycon</span> <span class='hs-varid'>tc</span>
<a name="line-14"></a>        <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>isFunTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-15"></a>        <span class='hs-varop'>||</span> <span class='hs-varid'>isPrimTyCon</span> <span class='hs-varid'>tc</span>   <span class='hs-comment'>-- "Any" is lifted but primitive</span>
<a name="line-16"></a>        <span class='hs-varop'>||</span> <span class='hs-varid'>isFamilyTyCon</span> <span class='hs-varid'>tc</span>   <span class='hs-comment'>-- Type family; e.g. arising from strict</span>
<a name="line-17"></a>                            <span class='hs-comment'>-- function application where argument has a</span>
<a name="line-18"></a>                            <span class='hs-comment'>-- type-family type</span>
<a name="line-19"></a>
<a name="line-20"></a>   <span class='hs-comment'>-- Sometimes, the TyCon is a AbstractTyCon which may not have any</span>
<a name="line-21"></a>   <span class='hs-comment'>-- constructors inside it.  Then we may get a better TyCon by</span>
<a name="line-22"></a>   <span class='hs-comment'>-- grabbing the one from a constructor alternative</span>
<a name="line-23"></a>   <span class='hs-comment'>-- if one exists.</span>
<a name="line-24"></a>   <span class='hs-varid'>look_for_better_tycon</span>
<a name="line-25"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>DataAlt</span> <span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>data_alts</span> <span class='hs-keyglyph'>=</span>
<a name="line-26"></a>                <span class='hs-conid'>AlgAlt</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConTyCon</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span>
<a name="line-27"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span>
<a name="line-28"></a>                <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>data_alts</span><span class='hs-layout'>)</span>
<a name="line-29"></a>                <span class='hs-conid'>PolyAlt</span>
<a name="line-30"></a>        <span class='hs-keyword'>where</span>
<a name="line-31"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>data_alts</span><span class='hs-layout'>,</span> <span class='hs-sel'>_deflt</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findDefault</span> <span class='hs-varid'>alts</span>
</pre>\end{code}


-- ---------------------------------------------------------------------------
-- Applications
-- ---------------------------------------------------------------------------

\begin{code}
<pre><a name="line-1"></a><a name="coreToStgApp"></a><span class='hs-definition'>coreToStgApp</span>
<a name="line-2"></a>         <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>UpdateFlag</span>            <span class='hs-comment'>-- Just upd &lt;=&gt; this application is</span>
<a name="line-3"></a>                                        <span class='hs-comment'>-- the rhs of a thunk binding</span>
<a name="line-4"></a>                                        <span class='hs-comment'>--      x = [...] \upd [] -&gt; the_app</span>
<a name="line-5"></a>                                        <span class='hs-comment'>-- with specified update flag</span>
<a name="line-6"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>                           <span class='hs-comment'>-- Function</span>
<a name="line-7"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreArg</span><span class='hs-keyglyph'>]</span>                    <span class='hs-comment'>-- Arguments</span>
<a name="line-8"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LneM</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgExpr</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVarsInfo</span><span class='hs-layout'>,</span> <span class='hs-conid'>EscVarsSet</span><span class='hs-layout'>)</span>
<a name="line-9"></a>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-definition'>coreToStgApp</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>f</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-12"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>args'</span><span class='hs-layout'>,</span> <span class='hs-varid'>args_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreToStgArgs</span> <span class='hs-varid'>args</span>
<a name="line-13"></a>    <span class='hs-varid'>how_bound</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupVarLne</span> <span class='hs-varid'>f</span>
<a name="line-14"></a>
<a name="line-15"></a>    <span class='hs-keyword'>let</span>
<a name="line-16"></a>        <span class='hs-varid'>n_val_args</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>valArgCount</span> <span class='hs-varid'>args</span>
<a name="line-17"></a>        <span class='hs-varid'>not_letrec_bound</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isLetBound</span> <span class='hs-varid'>how_bound</span><span class='hs-layout'>)</span>
<a name="line-18"></a>        <span class='hs-varid'>fun_fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>singletonFVInfo</span> <span class='hs-varid'>f</span> <span class='hs-varid'>how_bound</span> <span class='hs-varid'>fun_occ</span>
<a name="line-19"></a>            <span class='hs-comment'>-- e.g. (f :: a -&gt; int) (x :: a)</span>
<a name="line-20"></a>            <span class='hs-comment'>-- Here the free variables are "f", "x" AND the type variable "a"</span>
<a name="line-21"></a>            <span class='hs-comment'>-- coreToStgArgs will deal with the arguments recursively</span>
<a name="line-22"></a>
<a name="line-23"></a>        <span class='hs-comment'>-- Mostly, the arity info of a function is in the fn's IdInfo</span>
<a name="line-24"></a>        <span class='hs-comment'>-- But new bindings introduced by CoreSat may not have no</span>
<a name="line-25"></a>        <span class='hs-comment'>-- arity info; it would do us no good anyway.  For example:</span>
<a name="line-26"></a>        <span class='hs-comment'>--      let f = \ab -&gt; e in f</span>
<a name="line-27"></a>        <span class='hs-comment'>-- No point in having correct arity info for f!</span>
<a name="line-28"></a>        <span class='hs-comment'>-- Hence the hasArity stuff below.</span>
<a name="line-29"></a>        <span class='hs-comment'>-- NB: f_arity is only consulted for LetBound things</span>
<a name="line-30"></a>        <span class='hs-varid'>f_arity</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stgArity</span> <span class='hs-varid'>f</span> <span class='hs-varid'>how_bound</span>
<a name="line-31"></a>        <span class='hs-varid'>saturated</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f_arity</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>n_val_args</span>
<a name="line-32"></a>
<a name="line-33"></a>        <span class='hs-varid'>fun_occ</span>
<a name="line-34"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not_letrec_bound</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noBinderInfo</span>      <span class='hs-comment'>-- Uninteresting variable</span>
<a name="line-35"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>f_arity</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>saturated</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stgSatOcc</span> <span class='hs-comment'>-- Saturated or over-saturated function call</span>
<a name="line-36"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stgUnsatOcc</span>       <span class='hs-comment'>-- Unsaturated function or thunk</span>
<a name="line-37"></a>
<a name="line-38"></a>        <span class='hs-varid'>fun_escs</span>
<a name="line-39"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not_letrec_bound</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarSet</span>  <span class='hs-comment'>-- Only letrec-bound escapees are interesting</span>
<a name="line-40"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>f_arity</span> <span class='hs-varop'>==</span> <span class='hs-varid'>n_val_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarSet</span>  <span class='hs-comment'>-- A function *or thunk* with an exactly</span>
<a name="line-41"></a>                                                <span class='hs-comment'>-- saturated call doesn't escape</span>
<a name="line-42"></a>                                                <span class='hs-comment'>-- (let-no-escape applies to 'thunks' too)</span>
<a name="line-43"></a>
<a name="line-44"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitVarSet</span> <span class='hs-varid'>f</span>     <span class='hs-comment'>-- Inexact application; it does escape</span>
<a name="line-45"></a>
<a name="line-46"></a>        <span class='hs-comment'>-- At the moment of the call:</span>
<a name="line-47"></a>
<a name="line-48"></a>        <span class='hs-comment'>--  either the function is *not* let-no-escaped, in which case</span>
<a name="line-49"></a>        <span class='hs-comment'>--         nothing is live except live_in_cont</span>
<a name="line-50"></a>        <span class='hs-comment'>--      or the function *is* let-no-escaped in which case the</span>
<a name="line-51"></a>        <span class='hs-comment'>--         variables it uses are live, but still the function</span>
<a name="line-52"></a>        <span class='hs-comment'>--         itself is not.  PS.  In this case, the function's</span>
<a name="line-53"></a>        <span class='hs-comment'>--         live vars should already include those of the</span>
<a name="line-54"></a>        <span class='hs-comment'>--         continuation, but it does no harm to just union the</span>
<a name="line-55"></a>        <span class='hs-comment'>--         two regardless.</span>
<a name="line-56"></a>
<a name="line-57"></a>        <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprType</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkApps</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-58"></a>        <span class='hs-varid'>app</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>idDetails</span> <span class='hs-varid'>f</span> <span class='hs-keyword'>of</span>
<a name="line-59"></a>                <span class='hs-conid'>DataConWorkId</span> <span class='hs-varid'>dc</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>saturated</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgConApp</span> <span class='hs-varid'>dc</span> <span class='hs-varid'>args'</span>
<a name="line-60"></a>
<a name="line-61"></a>                <span class='hs-comment'>-- Some primitive operator that might be implemented as a library call.</span>
<a name="line-62"></a>                <span class='hs-conid'>PrimOpId</span> <span class='hs-varid'>op</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>saturated</span> <span class='hs-layout'>)</span>
<a name="line-63"></a>                                    <span class='hs-conid'>StgOpApp</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgPrimOp</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span> <span class='hs-varid'>args'</span> <span class='hs-varid'>res_ty</span>
<a name="line-64"></a>
<a name="line-65"></a>                <span class='hs-comment'>-- A call to some primitive Cmm function.</span>
<a name="line-66"></a>                <span class='hs-conid'>FCallId</span> <span class='hs-layout'>(</span><span class='hs-conid'>CCall</span> <span class='hs-layout'>(</span><span class='hs-conid'>CCallSpec</span> <span class='hs-layout'>(</span><span class='hs-conid'>StaticTarget</span> <span class='hs-varid'>lbl</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>pkgId</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conid'>PrimCallConv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-67"></a>                                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>saturated</span> <span class='hs-layout'>)</span>
<a name="line-68"></a>                                    <span class='hs-conid'>StgOpApp</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgPrimCallOp</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimCall</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>pkgId</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>args'</span> <span class='hs-varid'>res_ty</span>
<a name="line-69"></a>
<a name="line-70"></a>                <span class='hs-comment'>-- A regular foreign call.</span>
<a name="line-71"></a>                <span class='hs-conid'>FCallId</span> <span class='hs-varid'>call</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>saturated</span> <span class='hs-layout'>)</span>
<a name="line-72"></a>                                    <span class='hs-conid'>StgOpApp</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgFCallOp</span> <span class='hs-varid'>call</span> <span class='hs-layout'>(</span><span class='hs-varid'>idUnique</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>args'</span> <span class='hs-varid'>res_ty</span>
<a name="line-73"></a>
<a name="line-74"></a>                <span class='hs-conid'>TickBoxOpId</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"coreToStg TickBox"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span><span class='hs-layout'>,</span><span class='hs-varid'>args'</span><span class='hs-layout'>)</span>
<a name="line-75"></a>                <span class='hs-sel'>_other</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgApp</span> <span class='hs-varid'>f</span> <span class='hs-varid'>args'</span>
<a name="line-76"></a>        <span class='hs-varid'>fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fun_fvs</span>  <span class='hs-varop'>`unionFVInfo`</span> <span class='hs-varid'>args_fvs</span>
<a name="line-77"></a>        <span class='hs-varid'>vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fun_escs</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-layout'>(</span><span class='hs-varid'>getFVSet</span> <span class='hs-varid'>args_fvs</span><span class='hs-layout'>)</span>
<a name="line-78"></a>                                <span class='hs-comment'>-- All the free vars of the args are disqualified</span>
<a name="line-79"></a>                                <span class='hs-comment'>-- from being let-no-escaped.</span>
<a name="line-80"></a>
<a name="line-81"></a>    <span class='hs-comment'>-- Forcing these fixes a leak in the code generator, noticed while</span>
<a name="line-82"></a>    <span class='hs-comment'>-- profiling for trac #4367</span>
<a name="line-83"></a>    <span class='hs-varid'>app</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>fvs</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqVarSet</span> <span class='hs-varid'>vars</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span>
<a name="line-84"></a>        <span class='hs-varid'>app</span><span class='hs-layout'>,</span>
<a name="line-85"></a>        <span class='hs-varid'>fvs</span><span class='hs-layout'>,</span>
<a name="line-86"></a>        <span class='hs-varid'>vars</span>
<a name="line-87"></a>     <span class='hs-layout'>)</span>
<a name="line-88"></a>
<a name="line-89"></a>
<a name="line-90"></a>
<a name="line-91"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-92"></a><span class='hs-comment'>-- Argument lists</span>
<a name="line-93"></a><span class='hs-comment'>-- This is the guy that turns applications into A-normal form</span>
<a name="line-94"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-95"></a>
<a name="line-96"></a><a name="coreToStgArgs"></a><span class='hs-definition'>coreToStgArgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreArg</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LneM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>StgArg</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVarsInfo</span><span class='hs-layout'>)</span>
<a name="line-97"></a><span class='hs-definition'>coreToStgArgs</span> <span class='hs-conid'>[]</span>
<a name="line-98"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVInfo</span><span class='hs-layout'>)</span>
<a name="line-99"></a>
<a name="line-100"></a><span class='hs-definition'>coreToStgArgs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span> <span class='hs-keyword'>_</span> <span class='hs-conop'>:</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>     <span class='hs-comment'>-- Type argument</span>
<a name="line-101"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>args'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreToStgArgs</span> <span class='hs-varid'>args</span>
<a name="line-102"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>args'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span>
<a name="line-103"></a>
<a name="line-104"></a><span class='hs-definition'>coreToStgArgs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span> <span class='hs-keyword'>_</span> <span class='hs-conop'>:</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Coercion argument; replace with place holder</span>
<a name="line-105"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>args'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreToStgArgs</span> <span class='hs-varid'>args</span>
<a name="line-106"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgVarArg</span> <span class='hs-varid'>coercionTokenId</span> <span class='hs-conop'>:</span> <span class='hs-varid'>args'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-107"></a>
<a name="line-108"></a><span class='hs-definition'>coreToStgArgs</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span> <span class='hs-conop'>:</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>         <span class='hs-comment'>-- Non-type argument</span>
<a name="line-109"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>stg_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>args_fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreToStgArgs</span> <span class='hs-varid'>args</span>
<a name="line-110"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>arg'</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_fvs</span><span class='hs-layout'>,</span> <span class='hs-sel'>_escs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreToStgExpr</span> <span class='hs-varid'>arg</span>
<a name="line-111"></a>    <span class='hs-keyword'>let</span>
<a name="line-112"></a>        <span class='hs-varid'>fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>args_fvs</span> <span class='hs-varop'>`unionFVInfo`</span> <span class='hs-varid'>arg_fvs</span>
<a name="line-113"></a>        <span class='hs-varid'>stg_arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>arg'</span> <span class='hs-keyword'>of</span>
<a name="line-114"></a>                       <span class='hs-conid'>StgApp</span> <span class='hs-varid'>v</span> <span class='hs-conid'>[]</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgVarArg</span> <span class='hs-varid'>v</span>
<a name="line-115"></a>                       <span class='hs-conid'>StgConApp</span> <span class='hs-varid'>con</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgVarArg</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConWorkId</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span>
<a name="line-116"></a>                       <span class='hs-conid'>StgLit</span> <span class='hs-varid'>lit</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgLitArg</span> <span class='hs-varid'>lit</span>
<a name="line-117"></a>                       <span class='hs-keyword'>_</span>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"coreToStgArgs"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-118"></a>
<a name="line-119"></a>        <span class='hs-comment'>-- WARNING: what if we have an argument like (v `cast` co)</span>
<a name="line-120"></a>        <span class='hs-comment'>--          where 'co' changes the representation type?</span>
<a name="line-121"></a>        <span class='hs-comment'>--          (This really only happens if co is unsafe.)</span>
<a name="line-122"></a>        <span class='hs-comment'>-- Then all the getArgAmode stuff in CgBindery will set the</span>
<a name="line-123"></a>        <span class='hs-comment'>-- cg_rep of the CgIdInfo based on the type of v, rather</span>
<a name="line-124"></a>        <span class='hs-comment'>-- than the type of 'co'.</span>
<a name="line-125"></a>        <span class='hs-comment'>-- This matters particularly when the function is a primop</span>
<a name="line-126"></a>        <span class='hs-comment'>-- or foreign call.</span>
<a name="line-127"></a>        <span class='hs-comment'>-- Wanted: a better solution than this hacky warning</span>
<a name="line-128"></a>    <span class='hs-keyword'>let</span>
<a name="line-129"></a>        <span class='hs-varid'>arg_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exprType</span> <span class='hs-varid'>arg</span>
<a name="line-130"></a>        <span class='hs-varid'>stg_arg_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stgArgType</span> <span class='hs-varid'>stg_arg</span>
<a name="line-131"></a>        <span class='hs-varid'>bad_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>isUnLiftedType</span> <span class='hs-varid'>arg_ty</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isUnLiftedType</span> <span class='hs-varid'>stg_arg_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-132"></a>                <span class='hs-varop'>||</span> <span class='hs-layout'>(</span><span class='hs-varid'>typePrimRep</span> <span class='hs-varid'>arg_ty</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>typePrimRep</span> <span class='hs-varid'>stg_arg_ty</span><span class='hs-layout'>)</span>
<a name="line-133"></a>        <span class='hs-comment'>-- In GHCi we coerce an argument of type BCO# (unlifted) to HValue (lifted),</span>
<a name="line-134"></a>        <span class='hs-comment'>-- and pass it to a function expecting an HValue (arg_ty).  This is ok because</span>
<a name="line-135"></a>        <span class='hs-comment'>-- we can treat an unlifted value as lifted.  But the other way round</span>
<a name="line-136"></a>        <span class='hs-comment'>-- we complain.</span>
<a name="line-137"></a>        <span class='hs-comment'>-- We also want to check if a pointer is cast to a non-ptr etc</span>
<a name="line-138"></a>
<a name="line-139"></a>    <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-varid'>bad_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Dangerous-looking argument. Probable cause: bad unsafeCoerce#"</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>arg</span> <span class='hs-layout'>)</span>
<a name="line-140"></a>     <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>stg_arg</span> <span class='hs-conop'>:</span> <span class='hs-varid'>stg_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span>
<a name="line-141"></a>
<a name="line-142"></a>
<a name="line-143"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-144"></a><span class='hs-comment'>-- The magic for lets:</span>
<a name="line-145"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-146"></a>
<a name="line-147"></a><a name="coreToStgLet"></a><span class='hs-definition'>coreToStgLet</span>
<a name="line-148"></a>         <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>        <span class='hs-comment'>-- True &lt;=&gt; yes, we are let-no-escaping this let</span>
<a name="line-149"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreBind</span>    <span class='hs-comment'>-- bindings</span>
<a name="line-150"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>    <span class='hs-comment'>-- body</span>
<a name="line-151"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LneM</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgExpr</span><span class='hs-layout'>,</span>      <span class='hs-comment'>-- new let</span>
<a name="line-152"></a>                  <span class='hs-conid'>FreeVarsInfo</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- variables free in the whole let</span>
<a name="line-153"></a>                  <span class='hs-conid'>EscVarsSet</span><span class='hs-layout'>,</span>   <span class='hs-comment'>-- variables that escape from the whole let</span>
<a name="line-154"></a>                  <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span>         <span class='hs-comment'>-- True &lt;=&gt; none of the binders in the bindings</span>
<a name="line-155"></a>                                <span class='hs-comment'>-- is among the escaping vars</span>
<a name="line-156"></a>
<a name="line-157"></a><span class='hs-definition'>coreToStgLet</span> <span class='hs-varid'>let_no_escape</span> <span class='hs-varid'>bind</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-158"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>bind2</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind_fvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind_escs</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind_lvs</span><span class='hs-layout'>,</span>
<a name="line-159"></a>     <span class='hs-varid'>body2</span><span class='hs-layout'>,</span> <span class='hs-varid'>body_fvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>body_escs</span><span class='hs-layout'>,</span> <span class='hs-varid'>body_lvs</span><span class='hs-layout'>)</span>
<a name="line-160"></a>       <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mfix</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-keyglyph'>~</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>rec_body_fvs</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-161"></a>
<a name="line-162"></a>          <span class='hs-comment'>-- Do the bindings, setting live_in_cont to empty if</span>
<a name="line-163"></a>          <span class='hs-comment'>-- we ain't in a let-no-escape world</span>
<a name="line-164"></a>          <span class='hs-varid'>live_in_cont</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getVarsLiveInCont</span>
<a name="line-165"></a>          <span class='hs-layout'>(</span> <span class='hs-varid'>bind2</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind_fvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind_escs</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind_lv_info</span><span class='hs-layout'>,</span> <span class='hs-varid'>env_ext</span><span class='hs-layout'>)</span>
<a name="line-166"></a>                <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setVarsLiveInCont</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>let_no_escape</span>
<a name="line-167"></a>                                          <span class='hs-keyword'>then</span> <span class='hs-varid'>live_in_cont</span>
<a name="line-168"></a>                                          <span class='hs-keyword'>else</span> <span class='hs-varid'>emptyLiveInfo</span><span class='hs-layout'>)</span>
<a name="line-169"></a>                                     <span class='hs-layout'>(</span><span class='hs-varid'>vars_bind</span> <span class='hs-varid'>rec_body_fvs</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span>
<a name="line-170"></a>
<a name="line-171"></a>          <span class='hs-comment'>-- Do the body</span>
<a name="line-172"></a>          <span class='hs-varid'>extendVarEnvLne</span> <span class='hs-varid'>env_ext</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-173"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>body2</span><span class='hs-layout'>,</span> <span class='hs-varid'>body_fvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>body_escs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreToStgExpr</span> <span class='hs-varid'>body</span>
<a name="line-174"></a>             <span class='hs-varid'>body_lv_info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>freeVarsToLiveVars</span> <span class='hs-varid'>body_fvs</span>
<a name="line-175"></a>
<a name="line-176"></a>             <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind2</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind_fvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind_escs</span><span class='hs-layout'>,</span> <span class='hs-varid'>getLiveVars</span> <span class='hs-varid'>bind_lv_info</span><span class='hs-layout'>,</span>
<a name="line-177"></a>                     <span class='hs-varid'>body2</span><span class='hs-layout'>,</span> <span class='hs-varid'>body_fvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>body_escs</span><span class='hs-layout'>,</span> <span class='hs-varid'>getLiveVars</span> <span class='hs-varid'>body_lv_info</span><span class='hs-layout'>)</span>
<a name="line-178"></a>
<a name="line-179"></a>
<a name="line-180"></a>        <span class='hs-comment'>-- Compute the new let-expression</span>
<a name="line-181"></a>    <span class='hs-keyword'>let</span>
<a name="line-182"></a>        <span class='hs-varid'>new_let</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>let_no_escape</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgLetNoEscape</span> <span class='hs-varid'>live_in_whole_let</span> <span class='hs-varid'>bind_lvs</span> <span class='hs-varid'>bind2</span> <span class='hs-varid'>body2</span>
<a name="line-183"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgLet</span> <span class='hs-varid'>bind2</span> <span class='hs-varid'>body2</span>
<a name="line-184"></a>
<a name="line-185"></a>        <span class='hs-varid'>free_in_whole_let</span>
<a name="line-186"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binders</span> <span class='hs-varop'>`minusFVBinders`</span> <span class='hs-layout'>(</span><span class='hs-varid'>bind_fvs</span> <span class='hs-varop'>`unionFVInfo`</span> <span class='hs-varid'>body_fvs</span><span class='hs-layout'>)</span>
<a name="line-187"></a>
<a name="line-188"></a>        <span class='hs-varid'>live_in_whole_let</span>
<a name="line-189"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bind_lvs</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-layout'>(</span><span class='hs-varid'>body_lvs</span> <span class='hs-varop'>`delVarSetList`</span> <span class='hs-varid'>binders</span><span class='hs-layout'>)</span>
<a name="line-190"></a>
<a name="line-191"></a>        <span class='hs-varid'>real_bind_escs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>let_no_escape</span> <span class='hs-keyword'>then</span>
<a name="line-192"></a>                            <span class='hs-varid'>bind_escs</span>
<a name="line-193"></a>                         <span class='hs-keyword'>else</span>
<a name="line-194"></a>                            <span class='hs-varid'>getFVSet</span> <span class='hs-varid'>bind_fvs</span>
<a name="line-195"></a>                            <span class='hs-comment'>-- Everything escapes which is free in the bindings</span>
<a name="line-196"></a>
<a name="line-197"></a>        <span class='hs-varid'>let_escs</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>real_bind_escs</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>body_escs</span><span class='hs-layout'>)</span> <span class='hs-varop'>`delVarSetList`</span> <span class='hs-varid'>binders</span>
<a name="line-198"></a>
<a name="line-199"></a>        <span class='hs-varid'>all_escs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bind_escs</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>body_escs</span>    <span class='hs-comment'>-- Still includes binders of</span>
<a name="line-200"></a>                                                        <span class='hs-comment'>-- this let(rec)</span>
<a name="line-201"></a>
<a name="line-202"></a>        <span class='hs-varid'>no_binder_escapes</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEmptyVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>set_of_binders</span> <span class='hs-varop'>`intersectVarSet`</span> <span class='hs-varid'>all_escs</span><span class='hs-layout'>)</span>
<a name="line-203"></a>
<a name="line-204"></a>        <span class='hs-comment'>-- Debugging code as requested by Andrew Kennedy</span>
<a name="line-205"></a>        <span class='hs-varid'>checked_no_binder_escapes</span>
<a name="line-206"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>debugIsOn</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>no_binder_escapes</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>any</span> <span class='hs-varid'>is_join_var</span> <span class='hs-varid'>binders</span>
<a name="line-207"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTrace</span> <span class='hs-str'>"Interesting!  A join var that isn't let-no-escaped"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>binders</span><span class='hs-layout'>)</span>
<a name="line-208"></a>                  <span class='hs-conid'>False</span>
<a name="line-209"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>no_binder_escapes</span>
<a name="line-210"></a>
<a name="line-211"></a>                <span class='hs-comment'>-- Mustn't depend on the passed-in let_no_escape flag, since</span>
<a name="line-212"></a>                <span class='hs-comment'>-- no_binder_escapes is used by the caller to derive the flag!</span>
<a name="line-213"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span>
<a name="line-214"></a>        <span class='hs-varid'>new_let</span><span class='hs-layout'>,</span>
<a name="line-215"></a>        <span class='hs-varid'>free_in_whole_let</span><span class='hs-layout'>,</span>
<a name="line-216"></a>        <span class='hs-varid'>let_escs</span><span class='hs-layout'>,</span>
<a name="line-217"></a>        <span class='hs-varid'>checked_no_binder_escapes</span>
<a name="line-218"></a>      <span class='hs-layout'>)</span>
<a name="line-219"></a>  <span class='hs-keyword'>where</span>
<a name="line-220"></a>    <span class='hs-varid'>set_of_binders</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>binders</span>
<a name="line-221"></a>    <span class='hs-varid'>binders</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindersOf</span> <span class='hs-varid'>bind</span>
<a name="line-222"></a>
<a name="line-223"></a>    <span class='hs-varid'>mk_binding</span> <span class='hs-varid'>bind_lv_info</span> <span class='hs-varid'>binder</span> <span class='hs-varid'>rhs</span>
<a name="line-224"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>binder</span><span class='hs-layout'>,</span> <span class='hs-conid'>LetBound</span> <span class='hs-layout'>(</span><span class='hs-conid'>NestedLet</span> <span class='hs-varid'>live_vars</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>manifestArity</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-225"></a>        <span class='hs-keyword'>where</span>
<a name="line-226"></a>           <span class='hs-varid'>live_vars</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>let_no_escape</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addLiveVar</span> <span class='hs-varid'>bind_lv_info</span> <span class='hs-varid'>binder</span>
<a name="line-227"></a>                     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitLiveVar</span> <span class='hs-varid'>binder</span>
<a name="line-228"></a>                <span class='hs-comment'>-- c.f. the invariant on NestedLet</span>
<a name="line-229"></a>
<a name="line-230"></a>    <span class='hs-varid'>vars_bind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FreeVarsInfo</span>           <span class='hs-comment'>-- Free var info for body of binding</span>
<a name="line-231"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreBind</span>
<a name="line-232"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LneM</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgBinding</span><span class='hs-layout'>,</span>
<a name="line-233"></a>                       <span class='hs-conid'>FreeVarsInfo</span><span class='hs-layout'>,</span>
<a name="line-234"></a>                       <span class='hs-conid'>EscVarsSet</span><span class='hs-layout'>,</span>        <span class='hs-comment'>-- free vars; escapee vars</span>
<a name="line-235"></a>                       <span class='hs-conid'>LiveInfo</span><span class='hs-layout'>,</span>          <span class='hs-comment'>-- Vars and CAFs live in binding</span>
<a name="line-236"></a>                       <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>HowBound</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- extension to environment</span>
<a name="line-237"></a>
<a name="line-238"></a>
<a name="line-239"></a>    <span class='hs-varid'>vars_bind</span> <span class='hs-varid'>body_fvs</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>binder</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-240"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>rhs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind_fvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind_lv_info</span><span class='hs-layout'>,</span> <span class='hs-varid'>escs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreToStgRhs</span> <span class='hs-varid'>body_fvs</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>(</span><span class='hs-varid'>binder</span><span class='hs-layout'>,</span><span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-241"></a>        <span class='hs-keyword'>let</span>
<a name="line-242"></a>            <span class='hs-varid'>env_ext_item</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_binding</span> <span class='hs-varid'>bind_lv_info</span> <span class='hs-varid'>binder</span> <span class='hs-varid'>rhs</span>
<a name="line-243"></a>
<a name="line-244"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgNonRec</span> <span class='hs-varid'>binder</span> <span class='hs-varid'>rhs2</span><span class='hs-layout'>,</span>
<a name="line-245"></a>                <span class='hs-varid'>bind_fvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>escs</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind_lv_info</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>env_ext_item</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-246"></a>
<a name="line-247"></a>
<a name="line-248"></a>    <span class='hs-varid'>vars_bind</span> <span class='hs-varid'>body_fvs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span>
<a name="line-249"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mfix</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-keyglyph'>~</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>rec_rhs_fvs</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind_lv_info</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-250"></a>           <span class='hs-keyword'>let</span>
<a name="line-251"></a>                <span class='hs-varid'>rec_scope_fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unionFVInfo</span> <span class='hs-varid'>body_fvs</span> <span class='hs-varid'>rec_rhs_fvs</span>
<a name="line-252"></a>                <span class='hs-varid'>binders</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>pairs</span>
<a name="line-253"></a>                <span class='hs-varid'>env_ext</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>mk_binding</span> <span class='hs-varid'>bind_lv_info</span> <span class='hs-varid'>b</span> <span class='hs-varid'>rhs</span>
<a name="line-254"></a>                          <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span><span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>pairs</span> <span class='hs-keyglyph'>]</span>
<a name="line-255"></a>           <span class='hs-keyword'>in</span>
<a name="line-256"></a>           <span class='hs-varid'>extendVarEnvLne</span> <span class='hs-varid'>env_ext</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-257"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>rhss2</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvss</span><span class='hs-layout'>,</span> <span class='hs-varid'>lv_infos</span><span class='hs-layout'>,</span> <span class='hs-varid'>escss</span><span class='hs-layout'>)</span>
<a name="line-258"></a>                     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndUnzip4M</span> <span class='hs-layout'>(</span><span class='hs-varid'>coreToStgRhs</span> <span class='hs-varid'>rec_scope_fvs</span> <span class='hs-varid'>binders</span><span class='hs-layout'>)</span> <span class='hs-varid'>pairs</span>
<a name="line-259"></a>              <span class='hs-keyword'>let</span>
<a name="line-260"></a>                        <span class='hs-varid'>bind_fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unionFVInfos</span> <span class='hs-varid'>fvss</span>
<a name="line-261"></a>                        <span class='hs-varid'>bind_lv_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>unionLiveInfo</span> <span class='hs-varid'>emptyLiveInfo</span> <span class='hs-varid'>lv_infos</span>
<a name="line-262"></a>                        <span class='hs-varid'>escs</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unionVarSets</span> <span class='hs-varid'>escss</span>
<a name="line-263"></a>
<a name="line-264"></a>              <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgRec</span> <span class='hs-layout'>(</span><span class='hs-varid'>binders</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>rhss2</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-265"></a>                      <span class='hs-varid'>bind_fvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>escs</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind_lv_info</span><span class='hs-layout'>,</span> <span class='hs-varid'>env_ext</span><span class='hs-layout'>)</span>
<a name="line-266"></a>
<a name="line-267"></a>
<a name="line-268"></a><a name="is_join_var"></a><span class='hs-definition'>is_join_var</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-269"></a><span class='hs-comment'>-- A hack (used only for compiler debuggging) to tell if</span>
<a name="line-270"></a><span class='hs-comment'>-- a variable started life as a join point ($j)</span>
<a name="line-271"></a><span class='hs-definition'>is_join_var</span> <span class='hs-varid'>j</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occNameString</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>j</span><span class='hs-layout'>)</span> <span class='hs-varop'>==</span> <span class='hs-str'>"$j"</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="coreToStgRhs"></a><span class='hs-definition'>coreToStgRhs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FreeVarsInfo</span>            <span class='hs-comment'>-- Free var info for the scope of the binding</span>
<a name="line-2"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>
<a name="line-3"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span>
<a name="line-4"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LneM</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgRhs</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVarsInfo</span><span class='hs-layout'>,</span> <span class='hs-conid'>LiveInfo</span><span class='hs-layout'>,</span> <span class='hs-conid'>EscVarsSet</span><span class='hs-layout'>)</span>
<a name="line-5"></a>
<a name="line-6"></a><span class='hs-definition'>coreToStgRhs</span> <span class='hs-varid'>scope_fv_info</span> <span class='hs-varid'>binders</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-7"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>new_rhs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_fvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_escs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreToStgExpr</span> <span class='hs-varid'>rhs</span>
<a name="line-8"></a>    <span class='hs-varid'>lv_info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>freeVarsToLiveVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>binders</span> <span class='hs-varop'>`minusFVBinders`</span> <span class='hs-varid'>rhs_fvs</span><span class='hs-layout'>)</span>
<a name="line-9"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkStgRhs</span> <span class='hs-varid'>rhs_fvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSRT</span> <span class='hs-varid'>lv_info</span><span class='hs-layout'>)</span> <span class='hs-varid'>bndr_info</span> <span class='hs-varid'>new_rhs</span><span class='hs-layout'>,</span>
<a name="line-10"></a>            <span class='hs-varid'>rhs_fvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>lv_info</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_escs</span><span class='hs-layout'>)</span>
<a name="line-11"></a>  <span class='hs-keyword'>where</span>
<a name="line-12"></a>    <span class='hs-varid'>bndr_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupFVInfo</span> <span class='hs-varid'>scope_fv_info</span> <span class='hs-varid'>bndr</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="mkStgRhs"></a><span class='hs-definition'>mkStgRhs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FreeVarsInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SRT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgBinderInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgRhs</span>
<a name="line-15"></a>
<a name="line-16"></a><span class='hs-definition'>mkStgRhs</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgConApp</span> <span class='hs-varid'>con</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgRhsCon</span> <span class='hs-varid'>noCCS</span> <span class='hs-varid'>con</span> <span class='hs-varid'>args</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-definition'>mkStgRhs</span> <span class='hs-varid'>rhs_fvs</span> <span class='hs-varid'>srt</span> <span class='hs-varid'>binder_info</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgLam</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-19"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgRhsClosure</span> <span class='hs-varid'>noCCS</span> <span class='hs-varid'>binder_info</span>
<a name="line-20"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>getFVs</span> <span class='hs-varid'>rhs_fvs</span><span class='hs-layout'>)</span>
<a name="line-21"></a>                  <span class='hs-conid'>ReEntrant</span>
<a name="line-22"></a>                  <span class='hs-varid'>srt</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>body</span>
<a name="line-23"></a>
<a name="line-24"></a><span class='hs-definition'>mkStgRhs</span> <span class='hs-varid'>rhs_fvs</span> <span class='hs-varid'>srt</span> <span class='hs-varid'>binder_info</span> <span class='hs-varid'>rhs</span>
<a name="line-25"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgRhsClosure</span> <span class='hs-varid'>noCCS</span> <span class='hs-varid'>binder_info</span>
<a name="line-26"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>getFVs</span> <span class='hs-varid'>rhs_fvs</span><span class='hs-layout'>)</span>
<a name="line-27"></a>                  <span class='hs-varid'>upd_flag</span> <span class='hs-varid'>srt</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>rhs</span>
<a name="line-28"></a>  <span class='hs-keyword'>where</span>
<a name="line-29"></a>   <span class='hs-varid'>upd_flag</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Updatable</span>
<a name="line-30"></a>  <span class='hs-comment'>{-
<a name="line-31"></a>    SDM: disabled.  Eval/Apply can't handle functions with arity zero very
<a name="line-32"></a>    well; and making these into simple non-updatable thunks breaks other
<a name="line-33"></a>    assumptions (namely that they will be entered only once).
<a name="line-34"></a>
<a name="line-35"></a>    upd_flag | isPAP env rhs  = ReEntrant
<a name="line-36"></a>	     | otherwise      = Updatable
<a name="line-37"></a>  -}</span>
<a name="line-38"></a>
<a name="line-39"></a><span class='hs-comment'>{- ToDo:
<a name="line-40"></a>          upd = if isOnceDem dem
<a name="line-41"></a>                    then (if isNotTop toplev
<a name="line-42"></a>                            then SingleEntry    -- HA!  Paydirt for "dem"
<a name="line-43"></a>                            else
<a name="line-44"></a>                     (if debugIsOn then trace "WARNING: SE CAFs unsupported, forcing UPD instead" else id) $
<a name="line-45"></a>                     Updatable)
<a name="line-46"></a>                else Updatable
<a name="line-47"></a>        -- For now we forbid SingleEntry CAFs; they tickle the
<a name="line-48"></a>        -- ASSERT in rts/Storage.c line 215 at newCAF() re mut_link,
<a name="line-49"></a>        -- and I don't understand why.  There's only one SE_CAF (well,
<a name="line-50"></a>        -- only one that tickled a great gaping bug in an earlier attempt
<a name="line-51"></a>        -- at ClosureInfo.getEntryConvention) in the whole of nofib,
<a name="line-52"></a>        -- specifically Main.lvl6 in spectral/cryptarithm2.
<a name="line-53"></a>        -- So no great loss.  KSW 2000-07.
<a name="line-54"></a>-}</span>
</pre>\end{code}

Detect thunks which will reduce immediately to PAPs, and make them
non-updatable.  This has several advantages:

        - the non-updatable thunk behaves exactly like the PAP,

        - the thunk is more efficient to enter, because it is
          specialised to the task.

        - we save one update frame, one stg_update_PAP, one update
          and lots of PAP_enters.

        - in the case where the thunk is top-level, we save building
          a black hole and futhermore the thunk isn't considered to
          be a CAF any more, so it doesn't appear in any SRTs.

We do it here, because the arity information is accurate, and we need
to do it before the SRT pass to save the SRT entries associated with
any top-level PAPs.

isPAP env (StgApp f args) = listLengthCmp args arity == LT -- idArity f > length args
                          where
                            arity = stgArity f (lookupBinding env f)
isPAP env _               = False


%************************************************************************
%*                                                                      *
\subsection[LNE-monad]{A little monad for this let-no-escaping pass}
%*                                                                      *
%************************************************************************

There's a lot of stuff to pass around, so we use this @LneM@ monad to
help.  All the stuff here is only passed *down*.

\begin{code}
<pre><a name="line-1"></a><a name="LneM"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>LneM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LneM</span>
<a name="line-2"></a>    <span class='hs-layout'>{</span> <span class='hs-varid'>unLneM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IdEnv</span> <span class='hs-conid'>HowBound</span>
<a name="line-3"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiveInfo</span>                <span class='hs-comment'>-- Vars and CAFs live in continuation</span>
<a name="line-4"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-5"></a>    <span class='hs-layout'>}</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="LiveInfo"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>LiveInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>StgLiveVars</span><span class='hs-layout'>,</span>   <span class='hs-comment'>-- Dynamic live variables;</span>
<a name="line-8"></a>                                <span class='hs-comment'>-- i.e. ones with a nested (non-top-level) binding</span>
<a name="line-9"></a>                 <span class='hs-conid'>CafSet</span><span class='hs-layout'>)</span>        <span class='hs-comment'>-- Static live variables;</span>
<a name="line-10"></a>                                <span class='hs-comment'>-- i.e. top-level variables that are CAFs or refer to them</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="EscVarsSet"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>EscVarsSet</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IdSet</span>
<a name="line-13"></a><a name="CafSet"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CafSet</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IdSet</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="HowBound"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>HowBound</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ImportBound</span>         <span class='hs-comment'>-- Used only as a response to lookupBinding; never</span>
<a name="line-17"></a>                        <span class='hs-comment'>-- exists in the range of the (IdEnv HowBound)</span>
<a name="line-18"></a>
<a name="line-19"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LetBound</span>            <span class='hs-comment'>-- A let(rec) in this module</span>
<a name="line-20"></a>        <span class='hs-conid'>LetInfo</span>         <span class='hs-comment'>-- Whether top level or nested</span>
<a name="line-21"></a>        <span class='hs-conid'>Arity</span>           <span class='hs-comment'>-- Its arity (local Ids don't have arity info at this point)</span>
<a name="line-22"></a>
<a name="line-23"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LambdaBound</span>         <span class='hs-comment'>-- Used for both lambda and case</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="LetInfo"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>LetInfo</span>
<a name="line-26"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TopLet</span>              <span class='hs-comment'>-- top level things</span>
<a name="line-27"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NestedLet</span> <span class='hs-conid'>LiveInfo</span>  <span class='hs-comment'>-- For nested things, what is live if this</span>
<a name="line-28"></a>                        <span class='hs-comment'>-- thing is live?  Invariant: the binder</span>
<a name="line-29"></a>                        <span class='hs-comment'>-- itself is always a member of</span>
<a name="line-30"></a>                        <span class='hs-comment'>-- the dynamic set of its own LiveInfo</span>
<a name="line-31"></a>
<a name="line-32"></a><a name="isLetBound"></a><span class='hs-definition'>isLetBound</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HowBound</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-33"></a><span class='hs-definition'>isLetBound</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetBound</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-34"></a><span class='hs-definition'>isLetBound</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-35"></a>
<a name="line-36"></a><a name="topLevelBound"></a><span class='hs-definition'>topLevelBound</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HowBound</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-37"></a><span class='hs-definition'>topLevelBound</span> <span class='hs-conid'>ImportBound</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-38"></a><span class='hs-definition'>topLevelBound</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetBound</span> <span class='hs-conid'>TopLet</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-39"></a><span class='hs-definition'>topLevelBound</span> <span class='hs-keyword'>_</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
</pre>\end{code}

For a let(rec)-bound variable, x, we record LiveInfo, the set of
variables that are live if x is live.  This LiveInfo comprises
        (a) dynamic live variables (ones with a non-top-level binding)
        (b) static live variabes (CAFs or things that refer to CAFs)

For "normal" variables (a) is just x alone.  If x is a let-no-escaped
variable then x is represented by a code pointer and a stack pointer
(well, one for each stack).  So all of the variables needed in the
execution of x are live if x is, and are therefore recorded in the
LetBound constructor; x itself *is* included.

The set of dynamic live variables is guaranteed ot have no further let-no-escaped
variables in it.

\begin{code}
<pre><a name="line-1"></a><a name="emptyLiveInfo"></a><span class='hs-definition'>emptyLiveInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiveInfo</span>
<a name="line-2"></a><span class='hs-definition'>emptyLiveInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyVarSet</span><span class='hs-layout'>,</span><span class='hs-varid'>emptyVarSet</span><span class='hs-layout'>)</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="unitLiveVar"></a><span class='hs-definition'>unitLiveVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiveInfo</span>
<a name="line-5"></a><span class='hs-definition'>unitLiveVar</span> <span class='hs-varid'>lv</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitVarSet</span> <span class='hs-varid'>lv</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyVarSet</span><span class='hs-layout'>)</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="unitLiveCaf"></a><span class='hs-definition'>unitLiveCaf</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiveInfo</span>
<a name="line-8"></a><span class='hs-definition'>unitLiveCaf</span> <span class='hs-varid'>caf</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyVarSet</span><span class='hs-layout'>,</span> <span class='hs-varid'>unitVarSet</span> <span class='hs-varid'>caf</span><span class='hs-layout'>)</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="addLiveVar"></a><span class='hs-definition'>addLiveVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiveInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiveInfo</span>
<a name="line-11"></a><span class='hs-definition'>addLiveVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>lvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cafs</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>lvs</span> <span class='hs-varop'>`extendVarSet`</span> <span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>cafs</span><span class='hs-layout'>)</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="unionLiveInfo"></a><span class='hs-definition'>unionLiveInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiveInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiveInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiveInfo</span>
<a name="line-14"></a><span class='hs-definition'>unionLiveInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>lv1</span><span class='hs-layout'>,</span><span class='hs-varid'>caf1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>lv2</span><span class='hs-layout'>,</span><span class='hs-varid'>caf2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>lv1</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>lv2</span><span class='hs-layout'>,</span> <span class='hs-varid'>caf1</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>caf2</span><span class='hs-layout'>)</span>
<a name="line-15"></a>
<a name="line-16"></a><a name="mkSRT"></a><span class='hs-definition'>mkSRT</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiveInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SRT</span>
<a name="line-17"></a><span class='hs-definition'>mkSRT</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>cafs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SRTEntries</span> <span class='hs-varid'>cafs</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="getLiveVars"></a><span class='hs-definition'>getLiveVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiveInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgLiveVars</span>
<a name="line-20"></a><span class='hs-definition'>getLiveVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>lvs</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lvs</span>
</pre>\end{code}


The std monad functions:
\begin{code}
<pre><a name="line-1"></a><a name="initLne"></a><span class='hs-definition'>initLne</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IdEnv</span> <span class='hs-conid'>HowBound</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LneM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-2"></a><span class='hs-definition'>initLne</span> <span class='hs-varid'>env</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unLneM</span> <span class='hs-varid'>m</span> <span class='hs-varid'>env</span> <span class='hs-varid'>emptyLiveInfo</span>
<a name="line-3"></a>
<a name="line-4"></a>
<a name="line-5"></a>
<a name="line-6"></a><span class='hs-comment'>{-# INLINE thenLne #-}</span>
<a name="line-7"></a><span class='hs-comment'>{-# INLINE returnLne #-}</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="returnLne"></a><span class='hs-definition'>returnLne</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LneM</span> <span class='hs-varid'>a</span>
<a name="line-10"></a><span class='hs-definition'>returnLne</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LneM</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>e</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="thenLne"></a><span class='hs-definition'>thenLne</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LneM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LneM</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LneM</span> <span class='hs-varid'>b</span>
<a name="line-13"></a><span class='hs-definition'>thenLne</span> <span class='hs-varid'>m</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LneM</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>env</span> <span class='hs-varid'>lvs_cont</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unLneM</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLneM</span> <span class='hs-varid'>m</span> <span class='hs-varid'>env</span> <span class='hs-varid'>lvs_cont</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>env</span> <span class='hs-varid'>lvs_cont</span>
<a name="line-15"></a>
<a name="line-16"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Monad</span> <span class='hs-conid'>LneM</span> <span class='hs-keyword'>where</span>
<a name="line-17"></a>    <span class='hs-varid'>return</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>returnLne</span>
<a name="line-18"></a>    <span class='hs-layout'>(</span><span class='hs-varop'>&gt;&gt;=</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>thenLne</span>
<a name="line-19"></a>
<a name="line-20"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>MonadFix</span> <span class='hs-conid'>LneM</span> <span class='hs-keyword'>where</span>
<a name="line-21"></a>    <span class='hs-varid'>mfix</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LneM</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>env</span> <span class='hs-varid'>lvs_cont</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-22"></a>                       <span class='hs-keyword'>let</span> <span class='hs-varid'>result</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unLneM</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span> <span class='hs-varid'>env</span> <span class='hs-varid'>lvs_cont</span>
<a name="line-23"></a>                       <span class='hs-keyword'>in</span>  <span class='hs-varid'>result</span>
</pre>\end{code}

Functions specific to this monad:

\begin{code}
<pre><a name="line-1"></a><a name="getVarsLiveInCont"></a><span class='hs-definition'>getVarsLiveInCont</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LneM</span> <span class='hs-conid'>LiveInfo</span>
<a name="line-2"></a><span class='hs-definition'>getVarsLiveInCont</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LneM</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-sel'>_env</span> <span class='hs-varid'>lvs_cont</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>lvs_cont</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="setVarsLiveInCont"></a><span class='hs-definition'>setVarsLiveInCont</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiveInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LneM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LneM</span> <span class='hs-varid'>a</span>
<a name="line-5"></a><span class='hs-definition'>setVarsLiveInCont</span> <span class='hs-varid'>new_lvs_cont</span> <span class='hs-varid'>expr</span>
<a name="line-6"></a>   <span class='hs-keyglyph'>=</span>    <span class='hs-conid'>LneM</span> <span class='hs-varop'>$</span>   <span class='hs-keyglyph'>\</span><span class='hs-varid'>env</span> <span class='hs-sel'>_lvs_cont</span>
<a name="line-7"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unLneM</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>new_lvs_cont</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="extendVarEnvLne"></a><span class='hs-definition'>extendVarEnvLne</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>HowBound</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LneM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LneM</span> <span class='hs-varid'>a</span>
<a name="line-10"></a><span class='hs-definition'>extendVarEnvLne</span> <span class='hs-varid'>ids_w_howbound</span> <span class='hs-varid'>expr</span>
<a name="line-11"></a>   <span class='hs-keyglyph'>=</span>    <span class='hs-conid'>LneM</span> <span class='hs-varop'>$</span>   <span class='hs-keyglyph'>\</span><span class='hs-varid'>env</span> <span class='hs-varid'>lvs_cont</span>
<a name="line-12"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unLneM</span> <span class='hs-varid'>expr</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnvList</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ids_w_howbound</span><span class='hs-layout'>)</span> <span class='hs-varid'>lvs_cont</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="lookupVarLne"></a><span class='hs-definition'>lookupVarLne</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LneM</span> <span class='hs-conid'>HowBound</span>
<a name="line-15"></a><span class='hs-definition'>lookupVarLne</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LneM</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>env</span> <span class='hs-sel'>_lvs_cont</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>lookupBinding</span> <span class='hs-varid'>env</span> <span class='hs-varid'>v</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="lookupBinding"></a><span class='hs-definition'>lookupBinding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IdEnv</span> <span class='hs-conid'>HowBound</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HowBound</span>
<a name="line-18"></a><span class='hs-definition'>lookupBinding</span> <span class='hs-varid'>env</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>v</span> <span class='hs-keyword'>of</span>
<a name="line-19"></a>                        <span class='hs-conid'>Just</span> <span class='hs-varid'>xx</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>xx</span>
<a name="line-20"></a>                        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isGlobalId</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span> <span class='hs-layout'>)</span> <span class='hs-conid'>ImportBound</span>
<a name="line-21"></a>
<a name="line-22"></a>
<a name="line-23"></a><span class='hs-comment'>-- The result of lookupLiveVarsForSet, a set of live variables, is</span>
<a name="line-24"></a><span class='hs-comment'>-- only ever tacked onto a decorated expression. It is never used as</span>
<a name="line-25"></a><span class='hs-comment'>-- the basis of a control decision, which might give a black hole.</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="freeVarsToLiveVars"></a><span class='hs-definition'>freeVarsToLiveVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FreeVarsInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LneM</span> <span class='hs-conid'>LiveInfo</span>
<a name="line-28"></a><span class='hs-definition'>freeVarsToLiveVars</span> <span class='hs-varid'>fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LneM</span> <span class='hs-varid'>freeVarsToLiveVars'</span>
<a name="line-29"></a> <span class='hs-keyword'>where</span>
<a name="line-30"></a>  <span class='hs-varid'>freeVarsToLiveVars'</span> <span class='hs-sel'>_env</span> <span class='hs-varid'>live_in_cont</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>live_info</span>
<a name="line-31"></a>   <span class='hs-keyword'>where</span>
<a name="line-32"></a>    <span class='hs-varid'>live_info</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>unionLiveInfo</span> <span class='hs-varid'>live_in_cont</span> <span class='hs-varid'>lvs_from_fvs</span>
<a name="line-33"></a>    <span class='hs-varid'>lvs_from_fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>do_one</span> <span class='hs-layout'>(</span><span class='hs-varid'>allFreeIds</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span>
<a name="line-34"></a>
<a name="line-35"></a>    <span class='hs-varid'>do_one</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-varid'>how_bound</span><span class='hs-layout'>)</span>
<a name="line-36"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>how_bound</span> <span class='hs-keyword'>of</span>
<a name="line-37"></a>          <span class='hs-conid'>ImportBound</span>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unitLiveCaf</span> <span class='hs-varid'>v</span>      <span class='hs-comment'>-- Only CAF imports are</span>
<a name="line-38"></a>                                                                <span class='hs-comment'>-- recorded in fvs</span>
<a name="line-39"></a>          <span class='hs-conid'>LetBound</span> <span class='hs-conid'>TopLet</span> <span class='hs-keyword'>_</span>
<a name="line-40"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>mayHaveCafRefs</span> <span class='hs-layout'>(</span><span class='hs-varid'>idCafInfo</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unitLiveCaf</span> <span class='hs-varid'>v</span>
<a name="line-41"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>emptyLiveInfo</span>
<a name="line-42"></a>
<a name="line-43"></a>          <span class='hs-conid'>LetBound</span> <span class='hs-layout'>(</span><span class='hs-conid'>NestedLet</span> <span class='hs-varid'>lvs</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>lvs</span>        <span class='hs-comment'>-- lvs already contains v</span>
<a name="line-44"></a>                                                        <span class='hs-comment'>-- (see the invariant on NestedLet)</span>
<a name="line-45"></a>
<a name="line-46"></a>          <span class='hs-sel'>_lambda_or_case_binding</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unitLiveVar</span> <span class='hs-varid'>v</span>      <span class='hs-comment'>-- Bound by lambda or case</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
\subsection[Free-var info]{Free variable information}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="FreeVarsInfo"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>FreeVarsInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VarEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span><span class='hs-layout'>,</span> <span class='hs-conid'>HowBound</span><span class='hs-layout'>,</span> <span class='hs-conid'>StgBinderInfo</span><span class='hs-layout'>)</span>
<a name="line-2"></a>        <span class='hs-comment'>-- The Var is so we can gather up the free variables</span>
<a name="line-3"></a>        <span class='hs-comment'>-- as a set.</span>
<a name="line-4"></a>        <span class='hs-comment'>--</span>
<a name="line-5"></a>        <span class='hs-comment'>-- The HowBound info just saves repeated lookups;</span>
<a name="line-6"></a>        <span class='hs-comment'>-- we look up just once when we encounter the occurrence.</span>
<a name="line-7"></a>        <span class='hs-comment'>-- INVARIANT: Any ImportBound Ids are HaveCafRef Ids</span>
<a name="line-8"></a>        <span class='hs-comment'>--            Imported Ids without CAF refs are simply</span>
<a name="line-9"></a>        <span class='hs-comment'>--            not put in the FreeVarsInfo for an expression.</span>
<a name="line-10"></a>        <span class='hs-comment'>--            See singletonFVInfo and freeVarsToLiveVars</span>
<a name="line-11"></a>        <span class='hs-comment'>--</span>
<a name="line-12"></a>        <span class='hs-comment'>-- StgBinderInfo records how it occurs; notably, we</span>
<a name="line-13"></a>        <span class='hs-comment'>-- are interested in whether it only occurs in saturated</span>
<a name="line-14"></a>        <span class='hs-comment'>-- applications, because then we don't need to build a</span>
<a name="line-15"></a>        <span class='hs-comment'>-- curried version.</span>
<a name="line-16"></a>        <span class='hs-comment'>-- If f is mapped to noBinderInfo, that means</span>
<a name="line-17"></a>        <span class='hs-comment'>-- that f *is* mentioned (else it wouldn't be in the</span>
<a name="line-18"></a>        <span class='hs-comment'>-- IdEnv at all), but perhaps in an unsaturated applications.</span>
<a name="line-19"></a>        <span class='hs-comment'>--</span>
<a name="line-20"></a>        <span class='hs-comment'>-- All case/lambda-bound things are also mapped to</span>
<a name="line-21"></a>        <span class='hs-comment'>-- noBinderInfo, since we aren't interested in their</span>
<a name="line-22"></a>        <span class='hs-comment'>-- occurence info.</span>
<a name="line-23"></a>        <span class='hs-comment'>--</span>
<a name="line-24"></a>        <span class='hs-comment'>-- For ILX we track free var info for type variables too;</span>
<a name="line-25"></a>        <span class='hs-comment'>-- hence VarEnv not IdEnv</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="emptyFVInfo"></a><span class='hs-definition'>emptyFVInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FreeVarsInfo</span>
<a name="line-2"></a><span class='hs-definition'>emptyFVInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="singletonFVInfo"></a><span class='hs-definition'>singletonFVInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HowBound</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgBinderInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeVarsInfo</span>
<a name="line-5"></a><span class='hs-comment'>-- Don't record non-CAF imports at all, to keep free-var sets small</span>
<a name="line-6"></a><span class='hs-definition'>singletonFVInfo</span> <span class='hs-varid'>id</span> <span class='hs-conid'>ImportBound</span> <span class='hs-varid'>info</span>
<a name="line-7"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>mayHaveCafRefs</span> <span class='hs-layout'>(</span><span class='hs-varid'>idCafInfo</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitVarEnv</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-conid'>ImportBound</span><span class='hs-layout'>,</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span>
<a name="line-8"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-9"></a><span class='hs-definition'>singletonFVInfo</span> <span class='hs-varid'>id</span> <span class='hs-varid'>how_bound</span> <span class='hs-varid'>info</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitVarEnv</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>how_bound</span><span class='hs-layout'>,</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="unionFVInfo"></a><span class='hs-definition'>unionFVInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FreeVarsInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeVarsInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeVarsInfo</span>
<a name="line-12"></a><span class='hs-definition'>unionFVInfo</span> <span class='hs-varid'>fv1</span> <span class='hs-varid'>fv2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusVarEnv_C</span> <span class='hs-varid'>plusFVInfo</span> <span class='hs-varid'>fv1</span> <span class='hs-varid'>fv2</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="unionFVInfos"></a><span class='hs-definition'>unionFVInfos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FreeVarsInfo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeVarsInfo</span>
<a name="line-15"></a><span class='hs-definition'>unionFVInfos</span> <span class='hs-varid'>fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>unionFVInfo</span> <span class='hs-varid'>emptyFVInfo</span> <span class='hs-varid'>fvs</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="minusFVBinders"></a><span class='hs-definition'>minusFVBinders</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeVarsInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeVarsInfo</span>
<a name="line-18"></a><span class='hs-definition'>minusFVBinders</span> <span class='hs-varid'>vs</span> <span class='hs-varid'>fv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>minusFVBinder</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>vs</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="minusFVBinder"></a><span class='hs-definition'>minusFVBinder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeVarsInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeVarsInfo</span>
<a name="line-21"></a><span class='hs-definition'>minusFVBinder</span> <span class='hs-varid'>v</span> <span class='hs-varid'>fv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fv</span> <span class='hs-varop'>`delVarEnv`</span> <span class='hs-varid'>v</span>
<a name="line-22"></a>        <span class='hs-comment'>-- When removing a binder, remember to add its type variables</span>
<a name="line-23"></a>        <span class='hs-comment'>-- c.f. CoreFVs.delBinderFV</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="elementOfFVInfo"></a><span class='hs-definition'>elementOfFVInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeVarsInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-26"></a><span class='hs-definition'>elementOfFVInfo</span> <span class='hs-varid'>id</span> <span class='hs-varid'>fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeToBool</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>fvs</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-27"></a>
<a name="line-28"></a><a name="lookupFVInfo"></a><span class='hs-definition'>lookupFVInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FreeVarsInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgBinderInfo</span>
<a name="line-29"></a><span class='hs-comment'>-- Find how the given Id is used.</span>
<a name="line-30"></a><span class='hs-comment'>-- Externally visible things may be used any old how</span>
<a name="line-31"></a><span class='hs-definition'>lookupFVInfo</span> <span class='hs-varid'>fvs</span> <span class='hs-varid'>id</span>
<a name="line-32"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isExternalName</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noBinderInfo</span>
<a name="line-33"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>fvs</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>of</span>
<a name="line-34"></a>                        <span class='hs-conid'>Nothing</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>noBinderInfo</span>
<a name="line-35"></a>                        <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>info</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>info</span>
<a name="line-36"></a>
<a name="line-37"></a><a name="allFreeIds"></a><span class='hs-definition'>allFreeIds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FreeVarsInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>HowBound</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>   <span class='hs-comment'>-- Both top level and non-top-level Ids</span>
<a name="line-38"></a><span class='hs-definition'>allFreeIds</span> <span class='hs-varid'>fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>all</span> <span class='hs-layout'>(</span><span class='hs-varid'>isId</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fst</span><span class='hs-layout'>)</span> <span class='hs-varid'>ids</span> <span class='hs-layout'>)</span> <span class='hs-varid'>ids</span>
<a name="line-39"></a>      <span class='hs-keyword'>where</span>
<a name="line-40"></a>        <span class='hs-varid'>ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-layout'>,</span><span class='hs-varid'>how_bound</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-layout'>,</span><span class='hs-varid'>how_bound</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>varEnvElts</span> <span class='hs-varid'>fvs</span><span class='hs-keyglyph'>]</span>
<a name="line-41"></a>
<a name="line-42"></a><a name="getFVs"></a><span class='hs-comment'>-- Non-top-level things only, both type variables and ids</span>
<a name="line-43"></a><span class='hs-definition'>getFVs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FreeVarsInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span>
<a name="line-44"></a><span class='hs-definition'>getFVs</span> <span class='hs-varid'>fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>id</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>how_bound</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>varEnvElts</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>,</span>
<a name="line-45"></a>                    <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>topLevelBound</span> <span class='hs-varid'>how_bound</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-46"></a>
<a name="line-47"></a><a name="getFVSet"></a><span class='hs-definition'>getFVSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FreeVarsInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-48"></a><span class='hs-definition'>getFVSet</span> <span class='hs-varid'>fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>getFVs</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span>
<a name="line-49"></a>
<a name="line-50"></a><a name="plusFVInfo"></a><span class='hs-definition'>plusFVInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span><span class='hs-layout'>,</span> <span class='hs-conid'>HowBound</span><span class='hs-layout'>,</span> <span class='hs-conid'>StgBinderInfo</span><span class='hs-layout'>)</span>
<a name="line-51"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span><span class='hs-layout'>,</span> <span class='hs-conid'>HowBound</span><span class='hs-layout'>,</span> <span class='hs-conid'>StgBinderInfo</span><span class='hs-layout'>)</span>
<a name="line-52"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span><span class='hs-layout'>,</span> <span class='hs-conid'>HowBound</span><span class='hs-layout'>,</span> <span class='hs-conid'>StgBinderInfo</span><span class='hs-layout'>)</span>
<a name="line-53"></a><span class='hs-definition'>plusFVInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>id1</span><span class='hs-layout'>,</span><span class='hs-varid'>hb1</span><span class='hs-layout'>,</span><span class='hs-varid'>info1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>id2</span><span class='hs-layout'>,</span><span class='hs-varid'>hb2</span><span class='hs-layout'>,</span><span class='hs-varid'>info2</span><span class='hs-layout'>)</span>
<a name="line-54"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span> <span class='hs-layout'>(</span><span class='hs-varid'>id1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>id2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>hb1</span> <span class='hs-varop'>`check_eq_how_bound`</span> <span class='hs-varid'>hb2</span><span class='hs-layout'>)</span>
<a name="line-55"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>id1</span><span class='hs-layout'>,</span> <span class='hs-varid'>hb1</span><span class='hs-layout'>,</span> <span class='hs-varid'>combineStgBinderInfo</span> <span class='hs-varid'>info1</span> <span class='hs-varid'>info2</span><span class='hs-layout'>)</span>
<a name="line-56"></a>
<a name="line-57"></a><a name="check_eq_how_bound"></a><span class='hs-comment'>-- The HowBound info for a variable in the FVInfo should be consistent</span>
<a name="line-58"></a><span class='hs-definition'>check_eq_how_bound</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HowBound</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HowBound</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-59"></a><span class='hs-definition'>check_eq_how_bound</span> <span class='hs-conid'>ImportBound</span>        <span class='hs-conid'>ImportBound</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-60"></a><span class='hs-definition'>check_eq_how_bound</span> <span class='hs-conid'>LambdaBound</span>        <span class='hs-conid'>LambdaBound</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-61"></a><span class='hs-definition'>check_eq_how_bound</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetBound</span> <span class='hs-varid'>li1</span> <span class='hs-varid'>ar1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetBound</span> <span class='hs-varid'>li2</span> <span class='hs-varid'>ar2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ar1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>ar2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>check_eq_li</span> <span class='hs-varid'>li1</span> <span class='hs-varid'>li2</span>
<a name="line-62"></a><span class='hs-definition'>check_eq_how_bound</span> <span class='hs-keyword'>_</span>                  <span class='hs-keyword'>_</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-63"></a>
<a name="line-64"></a><a name="check_eq_li"></a><span class='hs-definition'>check_eq_li</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LetInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LetInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-65"></a><span class='hs-definition'>check_eq_li</span> <span class='hs-layout'>(</span><span class='hs-conid'>NestedLet</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>NestedLet</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-66"></a><span class='hs-definition'>check_eq_li</span> <span class='hs-conid'>TopLet</span>        <span class='hs-conid'>TopLet</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-67"></a><span class='hs-definition'>check_eq_li</span> <span class='hs-keyword'>_</span>             <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
</pre>\end{code}

Misc.
\begin{code}
<pre><a name="line-1"></a><a name="filterStgBinders"></a><span class='hs-definition'>filterStgBinders</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-definition'>filterStgBinders</span> <span class='hs-varid'>bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>bndrs</span>
</pre>\end{code}


\begin{code}
<pre><a name="line-1"></a><a name="myCollectBinders"></a><span class='hs-definition'>myCollectBinders</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Expr</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Expr</span> <span class='hs-conid'>Var</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-definition'>myCollectBinders</span> <span class='hs-varid'>expr</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>expr</span>
<a name="line-4"></a>  <span class='hs-keyword'>where</span>
<a name="line-5"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>bs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-varid'>b</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-conop'>:</span><span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span>
<a name="line-6"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>bs</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-varid'>t</span> <span class='hs-varid'>e'</span><span class='hs-layout'>)</span>
<a name="line-7"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tickishIsCode</span> <span class='hs-varid'>t</span>    <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-8"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>bs</span> <span class='hs-varid'>e'</span>
<a name="line-9"></a>        <span class='hs-comment'>-- Ignore only non-code source annotations</span>
<a name="line-10"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>bs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>bs</span> <span class='hs-varid'>e</span>
<a name="line-11"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>bs</span> <span class='hs-varid'>e</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="myCollectArgs"></a><span class='hs-definition'>myCollectArgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoreArg</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-14"></a>        <span class='hs-comment'>-- We assume that we only have variables</span>
<a name="line-15"></a>        <span class='hs-comment'>-- in the function position by now</span>
<a name="line-16"></a><span class='hs-definition'>myCollectArgs</span> <span class='hs-varid'>expr</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>expr</span> <span class='hs-conid'>[]</span>
<a name="line-18"></a>  <span class='hs-keyword'>where</span>
<a name="line-19"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>          <span class='hs-keyword'>as</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-keyword'>as</span><span class='hs-layout'>)</span>
<a name="line-20"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>f</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>as</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-conop'>:</span><span class='hs-keyword'>as</span><span class='hs-layout'>)</span>
<a name="line-21"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>     <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"CoreToStg.myCollectArgs"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
<a name="line-22"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>       <span class='hs-keyword'>as</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>as</span>
<a name="line-23"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-varid'>b</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>        <span class='hs-keyword'>as</span>
<a name="line-24"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>b</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>as</span>  <span class='hs-comment'>-- Note [Collect args]</span>
<a name="line-25"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span>                <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"CoreToStg.myCollectArgs"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span>
</pre>\end{code}

Note [Collect args]
~~~~~~~~~~~~~~~~~~~
This big-lambda case occurred following a rather obscure eta expansion.
It all seems a bit yukky to me.

\begin{code}
<pre><a name="line-1"></a><a name="stgArity"></a><span class='hs-definition'>stgArity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HowBound</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span>
<a name="line-2"></a><span class='hs-definition'>stgArity</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetBound</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>arity</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arity</span>
<a name="line-3"></a><span class='hs-definition'>stgArity</span> <span class='hs-varid'>f</span> <span class='hs-conid'>ImportBound</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idArity</span> <span class='hs-varid'>f</span>
<a name="line-4"></a><span class='hs-definition'>stgArity</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>LambdaBound</span>        <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
</pre>\end{code}
</body>
</html>
