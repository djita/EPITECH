<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>types/FamInstEnv.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
%

FamInstEnv: Type checked family instance declarations

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>FamInstEnv</span> <span class='hs-layout'>(</span>
<a name="line-9"></a>	<span class='hs-conid'>FamInst</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>famInstTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>famInstTyVars</span><span class='hs-layout'>,</span> 
<a name="line-10"></a>	<span class='hs-varid'>pprFamInst</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprFamInstHdr</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprFamInsts</span><span class='hs-layout'>,</span> 
<a name="line-11"></a>	<span class='hs-varid'>famInstHead</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkLocalFamInst</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkImportedFamInst</span><span class='hs-layout'>,</span>
<a name="line-12"></a>
<a name="line-13"></a>	<span class='hs-conid'>FamInstEnvs</span><span class='hs-layout'>,</span> <span class='hs-conid'>FamInstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFamInstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFamInstEnvs</span><span class='hs-layout'>,</span> 
<a name="line-14"></a>	<span class='hs-varid'>extendFamInstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>overwriteFamInstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendFamInstEnvList</span><span class='hs-layout'>,</span> 
<a name="line-15"></a>	<span class='hs-varid'>famInstEnvElts</span><span class='hs-layout'>,</span> <span class='hs-varid'>familyInstances</span><span class='hs-layout'>,</span>
<a name="line-16"></a>
<a name="line-17"></a>	<span class='hs-varid'>lookupFamInstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupFamInstEnvConflicts</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupFamInstEnvConflicts'</span><span class='hs-layout'>,</span>
<a name="line-18"></a>	
<a name="line-19"></a>	<span class='hs-comment'>-- Normalisation</span>
<a name="line-20"></a>	<span class='hs-varid'>topNormaliseType</span><span class='hs-layout'>,</span> <span class='hs-varid'>normaliseType</span><span class='hs-layout'>,</span> <span class='hs-varid'>normaliseTcApp</span>
<a name="line-21"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-22"></a>
<a name="line-23"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-24"></a>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>InstEnv</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unify</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TypeRep</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Coercion</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqFM</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
</pre>\end{code}


%************************************************************************
%*									*
\subsection{Type checked family instance heads}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="FamInst"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>FamInst</span> 
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FamInst</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fi_fam</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span>		<span class='hs-comment'>-- Family name</span>
<a name="line-3"></a>		<span class='hs-comment'>-- INVARIANT: fi_fam = case tyConFamInst_maybe fi_tycon of</span>
<a name="line-4"></a>		<span class='hs-comment'>--			   Just (tc, tys) -&gt; tc</span>
<a name="line-5"></a>
<a name="line-6"></a>		<span class='hs-comment'>-- Used for "rough matching"; same idea as for class instances</span>
<a name="line-7"></a>	    <span class='hs-layout'>,</span> <span class='hs-varid'>fi_tcs</span>   <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>	<span class='hs-comment'>-- Top of type args</span>
<a name="line-8"></a>		<span class='hs-comment'>-- INVARIANT: fi_tcs = roughMatchTcs fi_tys</span>
<a name="line-9"></a>
<a name="line-10"></a>		<span class='hs-comment'>-- Used for "proper matching"; ditto</span>
<a name="line-11"></a>	    <span class='hs-layout'>,</span> <span class='hs-varid'>fi_tvs</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVarSet</span>	<span class='hs-comment'>-- Template tyvars for full match</span>
<a name="line-12"></a>	    <span class='hs-layout'>,</span> <span class='hs-varid'>fi_tys</span>   <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>	<span class='hs-comment'>-- Full arg types</span>
<a name="line-13"></a>		<span class='hs-comment'>-- INVARIANT: fi_tvs = tyConTyVars fi_tycon</span>
<a name="line-14"></a>		<span class='hs-comment'>--	      fi_tys = case tyConFamInst_maybe fi_tycon of</span>
<a name="line-15"></a>		<span class='hs-comment'>--			   Just (_, tys) -&gt; tys</span>
<a name="line-16"></a>
<a name="line-17"></a>	    <span class='hs-layout'>,</span> <span class='hs-varid'>fi_tycon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span>		<span class='hs-comment'>-- Representation tycon</span>
<a name="line-18"></a>	    <span class='hs-layout'>}</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="famInstTyCon"></a><span class='hs-comment'>-- Obtain the representation tycon of a family instance.</span>
<a name="line-21"></a><span class='hs-comment'>--</span>
<a name="line-22"></a><span class='hs-definition'>famInstTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span>
<a name="line-23"></a><span class='hs-definition'>famInstTyCon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fi_tycon</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="famInstTyVars"></a><span class='hs-definition'>famInstTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVarSet</span>
<a name="line-26"></a><span class='hs-definition'>famInstTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fi_tvs</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>NamedThing</span> <span class='hs-conid'>FamInst</span> <span class='hs-keyword'>where</span>
<a name="line-2"></a>   <span class='hs-varid'>getName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getName</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fi_tycon</span>
<a name="line-3"></a>
<a name="line-4"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>FamInst</span> <span class='hs-keyword'>where</span>
<a name="line-5"></a>   <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprFamInst</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="pprFamInst"></a><span class='hs-comment'>-- Prints the FamInst as a family instance declaration</span>
<a name="line-8"></a><span class='hs-definition'>pprFamInst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-9"></a><span class='hs-definition'>pprFamInst</span> <span class='hs-varid'>famInst</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprFamInstHdr</span> <span class='hs-varid'>famInst</span><span class='hs-layout'>)</span>
<a name="line-11"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ifPprDebug</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Coercion axiom:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pp_ax</span><span class='hs-layout'>)</span>
<a name="line-12"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"--"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprDefinedAt</span> <span class='hs-layout'>(</span><span class='hs-varid'>getName</span> <span class='hs-varid'>famInst</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-13"></a>  <span class='hs-keyword'>where</span>
<a name="line-14"></a>    <span class='hs-varid'>pp_ax</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tyConFamilyCoercion_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>fi_tycon</span> <span class='hs-varid'>famInst</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-15"></a>              <span class='hs-conid'>Just</span> <span class='hs-varid'>ax</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ax</span>
<a name="line-16"></a>              <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"&lt;not there!&gt;"</span><span class='hs-layout'>)</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="pprFamInstHdr"></a><span class='hs-definition'>pprFamInstHdr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-19"></a><span class='hs-definition'>pprFamInstHdr</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamInst</span> <span class='hs-layout'>{</span><span class='hs-varid'>fi_tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rep_tc</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTyConSort</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pp_instance</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprHead</span>
<a name="line-21"></a>  <span class='hs-keyword'>where</span>
<a name="line-22"></a>    <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>fam_tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConFamInst_maybe</span> <span class='hs-varid'>rep_tc</span> 
<a name="line-23"></a>    
<a name="line-24"></a>    <span class='hs-comment'>-- For *associated* types, say "type T Int = blah" </span>
<a name="line-25"></a>    <span class='hs-comment'>-- For *top level* type instances, say "type instance T Int = blah"</span>
<a name="line-26"></a>    <span class='hs-varid'>pp_instance</span> 
<a name="line-27"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyConAssoc</span> <span class='hs-varid'>fam_tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-28"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"instance"</span><span class='hs-layout'>)</span>
<a name="line-29"></a>
<a name="line-30"></a>    <span class='hs-varid'>pprHead</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTypeApp</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>tys</span>
<a name="line-31"></a>    <span class='hs-varid'>pprTyConSort</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isDataTyCon</span>     <span class='hs-varid'>rep_tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"data"</span><span class='hs-layout'>)</span>
<a name="line-32"></a>		 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isNewTyCon</span>      <span class='hs-varid'>rep_tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"newtype"</span><span class='hs-layout'>)</span>
<a name="line-33"></a>		 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isSynTyCon</span>      <span class='hs-varid'>rep_tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"type"</span><span class='hs-layout'>)</span>
<a name="line-34"></a>		 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isAbstractTyCon</span> <span class='hs-varid'>rep_tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"data"</span><span class='hs-layout'>)</span>
<a name="line-35"></a>		 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>	          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"FamInstEnv.pprFamInstHdr"</span>
<a name="line-36"></a>
<a name="line-37"></a><a name="pprFamInsts"></a><span class='hs-definition'>pprFamInsts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInst</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-38"></a><span class='hs-definition'>pprFamInsts</span> <span class='hs-varid'>finsts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pprFamInst</span> <span class='hs-varid'>finsts</span><span class='hs-layout'>)</span>
<a name="line-39"></a>
<a name="line-40"></a><a name="famInstHead"></a><span class='hs-definition'>famInstHead</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyCon</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-41"></a><span class='hs-definition'>famInstHead</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamInst</span> <span class='hs-layout'>{</span><span class='hs-varid'>fi_tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-42"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tyConFamInst_maybe</span> <span class='hs-varid'>tycon</span> <span class='hs-keyword'>of</span>
<a name="line-43"></a>      <span class='hs-conid'>Nothing</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"FamInstEnv.famInstHead"</span>
<a name="line-44"></a>      <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>fam</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConTyVars</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>,</span> <span class='hs-varid'>fam</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-45"></a>
<a name="line-46"></a><a name="mkLocalFamInst"></a><span class='hs-comment'>-- Make a family instance representation from a tycon.  This is used for local</span>
<a name="line-47"></a><span class='hs-comment'>-- instances, where we can safely pull on the tycon.</span>
<a name="line-48"></a><span class='hs-comment'>--</span>
<a name="line-49"></a><span class='hs-definition'>mkLocalFamInst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamInst</span>
<a name="line-50"></a><span class='hs-definition'>mkLocalFamInst</span> <span class='hs-varid'>tycon</span>
<a name="line-51"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tyConFamInst_maybe</span> <span class='hs-varid'>tycon</span> <span class='hs-keyword'>of</span>
<a name="line-52"></a>           <span class='hs-conid'>Nothing</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"FamInstEnv.mkLocalFamInst"</span>
<a name="line-53"></a>	   <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>fam</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> 
<a name="line-54"></a>	     <span class='hs-conid'>FamInst</span> <span class='hs-layout'>{</span>
<a name="line-55"></a>	       <span class='hs-varid'>fi_fam</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConName</span> <span class='hs-varid'>fam</span><span class='hs-layout'>,</span>
<a name="line-56"></a>	       <span class='hs-varid'>fi_tcs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>roughMatchTcs</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span>
<a name="line-57"></a>	       <span class='hs-varid'>fi_tvs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarSet</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyConTyVars</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>,</span>
<a name="line-58"></a>	       <span class='hs-varid'>fi_tys</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span>
<a name="line-59"></a>	       <span class='hs-varid'>fi_tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tycon</span>
<a name="line-60"></a>	     <span class='hs-layout'>}</span>
<a name="line-61"></a>
<a name="line-62"></a><a name="mkImportedFamInst"></a><span class='hs-comment'>-- Make a family instance representation from the information found in an</span>
<a name="line-63"></a><span class='hs-comment'>-- unterface file.  In particular, we get the rough match info from the iface</span>
<a name="line-64"></a><span class='hs-comment'>-- (instead of computing it here).</span>
<a name="line-65"></a><span class='hs-comment'>--</span>
<a name="line-66"></a><span class='hs-definition'>mkImportedFamInst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamInst</span>
<a name="line-67"></a><span class='hs-definition'>mkImportedFamInst</span> <span class='hs-varid'>fam</span> <span class='hs-varid'>mb_tcs</span> <span class='hs-varid'>tycon</span>
<a name="line-68"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FamInst</span> <span class='hs-layout'>{</span>
<a name="line-69"></a>      <span class='hs-varid'>fi_fam</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fam</span><span class='hs-layout'>,</span>
<a name="line-70"></a>      <span class='hs-varid'>fi_tcs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mb_tcs</span><span class='hs-layout'>,</span>
<a name="line-71"></a>      <span class='hs-varid'>fi_tvs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarSet</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyConTyVars</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>,</span>
<a name="line-72"></a>      <span class='hs-varid'>fi_tys</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tyConFamInst_maybe</span> <span class='hs-varid'>tycon</span> <span class='hs-keyword'>of</span>
<a name="line-73"></a>		   <span class='hs-conid'>Nothing</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"FamInstEnv.mkImportedFamInst"</span>
<a name="line-74"></a>		   <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span>
<a name="line-75"></a>      <span class='hs-varid'>fi_tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tycon</span>
<a name="line-76"></a>    <span class='hs-layout'>}</span>
</pre>\end{code}


%************************************************************************
%*									*
		FamInstEnv
%*									*
%************************************************************************

Note [FamInstEnv]
~~~~~~~~~~~~~~~~~~~~~
A FamInstEnv maps a family name to the list of known instances for that family.

The same FamInstEnv includes both 'data family' and 'type family' instances.
Type families are reduced during type inference, but not data families;
the user explains when to use a data family instance by using contructors
and pattern matching.

Neverthless it is still useful to have data families in the FamInstEnv:

 - For finding overlaps and conflicts

 - For finding the representation type...see FamInstEnv.topNormaliseType
   and its call site in Simplify

 - In standalone deriving instance Eq (T [Int]) we need to find the 
   representation type for T [Int]

\begin{code}
<pre><a name="line-1"></a><a name="FamInstEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>FamInstEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UniqFM</span> <span class='hs-conid'>FamilyInstEnv</span>	<span class='hs-comment'>-- Maps a family to its instances</span>
<a name="line-2"></a>     <span class='hs-comment'>-- See Note [FamInstEnv]</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="FamInstEnvs"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>FamInstEnvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamInstEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>FamInstEnv</span><span class='hs-layout'>)</span>
<a name="line-5"></a>     <span class='hs-comment'>-- External package inst-env, Home-package inst-env</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="FamilyInstEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>FamilyInstEnv</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FamIE</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInst</span><span class='hs-keyglyph'>]</span>	<span class='hs-comment'>-- The instances for a particular family, in any order</span>
<a name="line-9"></a>  	  <span class='hs-conid'>Bool</span> 		<span class='hs-comment'>-- True &lt;=&gt; there is an instance of form T a b c</span>
<a name="line-10"></a>			<span class='hs-comment'>-- 	If *not* then the common case of looking up</span>
<a name="line-11"></a>			<span class='hs-comment'>--	(T a b c) can fail immediately</span>
<a name="line-12"></a>
<a name="line-13"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>FamilyInstEnv</span> <span class='hs-keyword'>where</span>
<a name="line-14"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamIE</span> <span class='hs-varid'>fs</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"FamIE"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>b</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span>
<a name="line-15"></a>
<a name="line-16"></a><span class='hs-comment'>-- INVARIANTS:</span>
<a name="line-17"></a><span class='hs-comment'>--  * The fs_tvs are distinct in each FamInst</span>
<a name="line-18"></a><span class='hs-comment'>--	of a range value of the map (so we can safely unify them)</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="emptyFamInstEnvs"></a><span class='hs-definition'>emptyFamInstEnvs</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamInstEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>FamInstEnv</span><span class='hs-layout'>)</span>
<a name="line-21"></a><span class='hs-definition'>emptyFamInstEnvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyFamInstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFamInstEnv</span><span class='hs-layout'>)</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="emptyFamInstEnv"></a><span class='hs-definition'>emptyFamInstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInstEnv</span>
<a name="line-24"></a><span class='hs-definition'>emptyFamInstEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyUFM</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="famInstEnvElts"></a><span class='hs-definition'>famInstEnvElts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInst</span><span class='hs-keyglyph'>]</span>
<a name="line-27"></a><span class='hs-definition'>famInstEnvElts</span> <span class='hs-varid'>fi</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>elt</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FamIE</span> <span class='hs-varid'>elts</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>eltsUFM</span> <span class='hs-varid'>fi</span><span class='hs-layout'>,</span> <span class='hs-varid'>elt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>elts</span><span class='hs-keyglyph'>]</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="familyInstances"></a><span class='hs-definition'>familyInstances</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamInstEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>FamInstEnv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInst</span><span class='hs-keyglyph'>]</span>
<a name="line-30"></a><span class='hs-definition'>familyInstances</span> <span class='hs-layout'>(</span><span class='hs-varid'>pkg_fie</span><span class='hs-layout'>,</span> <span class='hs-varid'>home_fie</span><span class='hs-layout'>)</span> <span class='hs-varid'>fam</span>
<a name="line-31"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>get</span> <span class='hs-varid'>home_fie</span> <span class='hs-varop'>++</span> <span class='hs-varid'>get</span> <span class='hs-varid'>pkg_fie</span>
<a name="line-32"></a>  <span class='hs-keyword'>where</span>
<a name="line-33"></a>    <span class='hs-varid'>get</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupUFM</span> <span class='hs-varid'>env</span> <span class='hs-varid'>fam</span> <span class='hs-keyword'>of</span>
<a name="line-34"></a>		<span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamIE</span> <span class='hs-varid'>insts</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>insts</span>
<a name="line-35"></a>		<span class='hs-conid'>Nothing</span>	             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-36"></a>
<a name="line-37"></a><a name="extendFamInstEnvList"></a><span class='hs-definition'>extendFamInstEnvList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInst</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamInstEnv</span>
<a name="line-38"></a><span class='hs-definition'>extendFamInstEnvList</span> <span class='hs-varid'>inst_env</span> <span class='hs-varid'>fis</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-varid'>extendFamInstEnv</span> <span class='hs-varid'>inst_env</span> <span class='hs-varid'>fis</span>
<a name="line-39"></a>
<a name="line-40"></a><a name="extendFamInstEnv"></a><span class='hs-definition'>extendFamInstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamInstEnv</span>
<a name="line-41"></a><span class='hs-definition'>extendFamInstEnv</span> <span class='hs-varid'>inst_env</span> <span class='hs-varid'>ins_item</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FamInst</span> <span class='hs-layout'>{</span><span class='hs-varid'>fi_fam</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls_nm</span><span class='hs-layout'>,</span> <span class='hs-varid'>fi_tcs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mb_tcs</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-42"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addToUFM_C</span> <span class='hs-varid'>add</span> <span class='hs-varid'>inst_env</span> <span class='hs-varid'>cls_nm</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamIE</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ins_item</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>ins_tyvar</span><span class='hs-layout'>)</span>
<a name="line-43"></a>  <span class='hs-keyword'>where</span>
<a name="line-44"></a>    <span class='hs-varid'>add</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamIE</span> <span class='hs-varid'>items</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FamIE</span> <span class='hs-layout'>(</span><span class='hs-varid'>ins_item</span><span class='hs-conop'>:</span><span class='hs-varid'>items</span><span class='hs-layout'>)</span>
<a name="line-45"></a>				      <span class='hs-layout'>(</span><span class='hs-varid'>ins_tyvar</span> <span class='hs-varop'>||</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>)</span>
<a name="line-46"></a>    <span class='hs-varid'>ins_tyvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>any</span> <span class='hs-varid'>isJust</span> <span class='hs-varid'>mb_tcs</span><span class='hs-layout'>)</span>
<a name="line-47"></a>
<a name="line-48"></a><a name="overwriteFamInstEnv"></a><span class='hs-definition'>overwriteFamInstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamInstEnv</span>
<a name="line-49"></a><span class='hs-definition'>overwriteFamInstEnv</span> <span class='hs-varid'>inst_env</span> <span class='hs-varid'>ins_item</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FamInst</span> <span class='hs-layout'>{</span><span class='hs-varid'>fi_fam</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls_nm</span><span class='hs-layout'>,</span> <span class='hs-varid'>fi_tcs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mb_tcs</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-50"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addToUFM_C</span> <span class='hs-varid'>add</span> <span class='hs-varid'>inst_env</span> <span class='hs-varid'>cls_nm</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamIE</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ins_item</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>ins_tyvar</span><span class='hs-layout'>)</span>
<a name="line-51"></a>  <span class='hs-keyword'>where</span>
<a name="line-52"></a>    <span class='hs-varid'>add</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamIE</span> <span class='hs-varid'>items</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FamIE</span> <span class='hs-layout'>(</span><span class='hs-varid'>replaceFInst</span> <span class='hs-varid'>items</span><span class='hs-layout'>)</span>
<a name="line-53"></a>				      <span class='hs-layout'>(</span><span class='hs-varid'>ins_tyvar</span> <span class='hs-varop'>||</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>)</span>
<a name="line-54"></a>    <span class='hs-varid'>ins_tyvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>any</span> <span class='hs-varid'>isJust</span> <span class='hs-varid'>mb_tcs</span><span class='hs-layout'>)</span>
<a name="line-55"></a>    <span class='hs-varid'>match</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tpl_tvs</span> <span class='hs-varid'>tpl_tys</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcMatchTys</span> <span class='hs-varid'>tpl_tvs</span> <span class='hs-varid'>tpl_tys</span> <span class='hs-varid'>tys</span>
<a name="line-56"></a>    
<a name="line-57"></a>    <span class='hs-varid'>inst_tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>famInstTyCon</span> <span class='hs-varid'>ins_item</span>
<a name="line-58"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>fam</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expectJust</span> <span class='hs-str'>"FamInstEnv.lookuFamInstEnvConflicts"</span>
<a name="line-59"></a>    	       	            <span class='hs-layout'>(</span><span class='hs-varid'>tyConFamInst_maybe</span> <span class='hs-varid'>inst_tycon</span><span class='hs-layout'>)</span>
<a name="line-60"></a>    <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>fam</span>
<a name="line-61"></a>    <span class='hs-varid'>n_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span>
<a name="line-62"></a>    <span class='hs-varid'>match_tys</span> 
<a name="line-63"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>arity</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>n_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>take</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>tys</span>
<a name="line-64"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span>
<a name="line-65"></a>    <span class='hs-varid'>rough_tcs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>roughMatchTcs</span> <span class='hs-varid'>match_tys</span>
<a name="line-66"></a>    
<a name="line-67"></a>    <span class='hs-varid'>replaceFInst</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ins_item</span><span class='hs-keyglyph'>]</span>
<a name="line-68"></a>    <span class='hs-varid'>replaceFInst</span> <span class='hs-layout'>(</span><span class='hs-varid'>item</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FamInst</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fi_tcs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mb_tcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>fi_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tpl_tvs</span><span class='hs-layout'>,</span> 
<a name="line-69"></a>                                  <span class='hs-varid'>fi_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tpl_tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span>
<a name="line-70"></a>	<span class='hs-comment'>-- Fast check for no match, uses the "rough match" fields</span>
<a name="line-71"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>instanceCantMatch</span> <span class='hs-varid'>rough_tcs</span> <span class='hs-varid'>mb_tcs</span>
<a name="line-72"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>item</span> <span class='hs-conop'>:</span> <span class='hs-varid'>replaceFInst</span> <span class='hs-varid'>rest</span>
<a name="line-73"></a>
<a name="line-74"></a>        <span class='hs-comment'>-- Proper check</span>
<a name="line-75"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>match</span> <span class='hs-varid'>item</span> <span class='hs-varid'>tpl_tvs</span> <span class='hs-varid'>tpl_tys</span> <span class='hs-varid'>match_tys</span>
<a name="line-76"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ins_item</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rest</span>
<a name="line-77"></a>
<a name="line-78"></a>        <span class='hs-comment'>-- No match =&gt; try next</span>
<a name="line-79"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-80"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>item</span> <span class='hs-conop'>:</span> <span class='hs-varid'>replaceFInst</span> <span class='hs-varid'>rest</span>
<a name="line-81"></a>
<a name="line-82"></a>
<a name="line-83"></a>
</pre>\end{code}

%************************************************************************
%*									*
		Looking up a family instance
%*									*
%************************************************************************

@lookupFamInstEnv@ looks up in a @FamInstEnv@, using a one-way match.
Multiple matches are only possible in case of type families (not data
families), and then, it doesn't matter which match we choose (as the
instances are guaranteed confluent).

We return the matching family instances and the type instance at which it
matches.  For example, if we lookup 'T [Int]' and have a family instance

  data instance T [a] = ..

desugared to

  data :R42T a = ..
  coe :Co:R42T a :: T [a] ~ :R42T a

we return the matching instance '(FamInst{.., fi_tycon = :R42T}, Int)'.

\begin{code}
<pre><a name="line-1"></a><a name="FamInstMatch"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>FamInstMatch</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamInst</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>           <span class='hs-comment'>-- Matching type instance</span>
<a name="line-2"></a>  <span class='hs-comment'>-- See Note [Over-saturated matches]</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="lookupFamInstEnv"></a><span class='hs-definition'>lookupFamInstEnv</span>
<a name="line-5"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInstEnvs</span>
<a name="line-6"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>		<span class='hs-comment'>-- What we are looking for</span>
<a name="line-7"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInstMatch</span><span class='hs-keyglyph'>]</span> 	        <span class='hs-comment'>-- Successful matches</span>
<a name="line-8"></a><span class='hs-comment'>-- Precondition: the tycon is saturated (or over-saturated)</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-definition'>lookupFamInstEnv</span>
<a name="line-11"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookup_fam_inst_env</span> <span class='hs-varid'>match</span> <span class='hs-conid'>True</span>
<a name="line-12"></a>   <span class='hs-keyword'>where</span>
<a name="line-13"></a>     <span class='hs-varid'>match</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tpl_tvs</span> <span class='hs-varid'>tpl_tys</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcMatchTys</span> <span class='hs-varid'>tpl_tvs</span> <span class='hs-varid'>tpl_tys</span> <span class='hs-varid'>tys</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="lookupFamInstEnvConflicts"></a><span class='hs-definition'>lookupFamInstEnvConflicts</span>
<a name="line-16"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInstEnvs</span>
<a name="line-17"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamInst</span>		<span class='hs-comment'>-- Putative new instance</span>
<a name="line-18"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span>		<span class='hs-comment'>-- Unique tyvars, matching arity of FamInst</span>
<a name="line-19"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInstMatch</span><span class='hs-keyglyph'>]</span> 	<span class='hs-comment'>-- Conflicting matches</span>
<a name="line-20"></a><span class='hs-comment'>-- E.g. when we are about to add</span>
<a name="line-21"></a><span class='hs-comment'>--    f : type instance F [a] = a-&gt;a</span>
<a name="line-22"></a><span class='hs-comment'>-- we do (lookupFamInstConflicts f [b])</span>
<a name="line-23"></a><span class='hs-comment'>-- to find conflicting matches</span>
<a name="line-24"></a><span class='hs-comment'>-- The skolem tyvars are needed because we don't have a </span>
<a name="line-25"></a><span class='hs-comment'>-- unique supply to hand</span>
<a name="line-26"></a><span class='hs-comment'>--</span>
<a name="line-27"></a><span class='hs-comment'>-- Precondition: the tycon is saturated (or over-saturated)</span>
<a name="line-28"></a>
<a name="line-29"></a><span class='hs-definition'>lookupFamInstEnvConflicts</span> <span class='hs-varid'>envs</span> <span class='hs-varid'>fam_inst</span> <span class='hs-varid'>skol_tvs</span>
<a name="line-30"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookup_fam_inst_env</span> <span class='hs-varid'>my_unify</span> <span class='hs-conid'>False</span> <span class='hs-varid'>envs</span> <span class='hs-varid'>fam</span> <span class='hs-varid'>tys1</span>
<a name="line-31"></a>  <span class='hs-keyword'>where</span>
<a name="line-32"></a>    <span class='hs-varid'>inst_tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>famInstTyCon</span> <span class='hs-varid'>fam_inst</span>
<a name="line-33"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>fam</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expectJust</span> <span class='hs-str'>"FamInstEnv.lookuFamInstEnvConflicts"</span>
<a name="line-34"></a>    	       	            <span class='hs-layout'>(</span><span class='hs-varid'>tyConFamInst_maybe</span> <span class='hs-varid'>inst_tycon</span><span class='hs-layout'>)</span>
<a name="line-35"></a>    <span class='hs-varid'>skol_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>skol_tvs</span>
<a name="line-36"></a>    <span class='hs-varid'>tys1</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipTopTvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConTyVars</span> <span class='hs-varid'>inst_tycon</span><span class='hs-layout'>)</span> <span class='hs-varid'>skol_tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-37"></a>        <span class='hs-comment'>-- In example above,   fam tys' = F [b]   </span>
<a name="line-38"></a>
<a name="line-39"></a>    <span class='hs-varid'>my_unify</span> <span class='hs-varid'>old_fam_inst</span> <span class='hs-varid'>tpl_tvs</span> <span class='hs-varid'>tpl_tys</span> <span class='hs-varid'>match_tys</span>
<a name="line-40"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>tyVarsOfTypes</span> <span class='hs-varid'>tys1</span> <span class='hs-varop'>`disjointVarSet`</span> <span class='hs-varid'>tpl_tvs</span><span class='hs-layout'>,</span>
<a name="line-41"></a>		  <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>fam</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tys1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span>
<a name="line-42"></a>		  <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tpl_tvs</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tpl_tys</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-43"></a>		<span class='hs-comment'>-- Unification will break badly if the variables overlap</span>
<a name="line-44"></a>		<span class='hs-comment'>-- They shouldn't because we allocate separate uniques for them</span>
<a name="line-45"></a>         <span class='hs-keyword'>case</span> <span class='hs-varid'>tcUnifyTys</span> <span class='hs-varid'>instanceBindFun</span> <span class='hs-varid'>tpl_tys</span> <span class='hs-varid'>match_tys</span> <span class='hs-keyword'>of</span>
<a name="line-46"></a>	      <span class='hs-conid'>Just</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>conflicting</span> <span class='hs-varid'>old_fam_inst</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>subst</span>
<a name="line-47"></a>	      <span class='hs-sel'>_other</span>	   	              	          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-48"></a>
<a name="line-49"></a>      <span class='hs-comment'>-- Note [Family instance overlap conflicts]</span>
<a name="line-50"></a>    <span class='hs-varid'>conflicting</span> <span class='hs-varid'>old_fam_inst</span> <span class='hs-varid'>subst</span> 
<a name="line-51"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isAlgTyCon</span> <span class='hs-varid'>fam</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-52"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>old_rhs</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>new_rhs</span><span class='hs-layout'>)</span>
<a name="line-53"></a>      <span class='hs-keyword'>where</span>
<a name="line-54"></a>        <span class='hs-varid'>old_tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>famInstTyCon</span> <span class='hs-varid'>old_fam_inst</span>
<a name="line-55"></a>        <span class='hs-varid'>old_tvs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConTyVars</span> <span class='hs-varid'>old_tycon</span>
<a name="line-56"></a>        <span class='hs-varid'>old_rhs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>old_tycon</span>  <span class='hs-layout'>(</span><span class='hs-varid'>substTyVars</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>old_tvs</span><span class='hs-layout'>)</span>
<a name="line-57"></a>        <span class='hs-varid'>new_rhs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>inst_tycon</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTyVars</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>skol_tvs</span><span class='hs-layout'>)</span>
<a name="line-58"></a>
<a name="line-59"></a><a name="lookupFamInstEnvConflicts'"></a><span class='hs-comment'>-- This variant is called when we want to check if the conflict is only in the</span>
<a name="line-60"></a><span class='hs-comment'>-- home environment (see FamInst.addLocalFamInst)</span>
<a name="line-61"></a><span class='hs-definition'>lookupFamInstEnvConflicts'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInstMatch</span><span class='hs-keyglyph'>]</span>
<a name="line-62"></a><span class='hs-definition'>lookupFamInstEnvConflicts'</span> <span class='hs-varid'>env</span> <span class='hs-varid'>fam_inst</span> <span class='hs-varid'>skol_tvs</span>
<a name="line-63"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupFamInstEnvConflicts</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyFamInstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>fam_inst</span> <span class='hs-varid'>skol_tvs</span>
</pre>\end{code}

Note [Family instance overlap conflicts]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
- In the case of data family instances, any overlap is fundamentally a
  conflict (as these instances imply injective type mappings).

- In the case of type family instances, overlap is admitted as long as
  the right-hand sides of the overlapping rules coincide under the
  overlap substitution.  eg
       type instance F a Int = a
       type instance F Int b = b
  These two overlap on (F Int Int) but then both RHSs are Int, 
  so all is well. We require that they are syntactically equal;
  anything else would be difficult to test for at this stage.


While @lookupFamInstEnv@ uses a one-way match, the next function
@lookupFamInstEnvConflicts@ uses two-way matching (ie, unification).  This is
needed to check for overlapping instances.

For class instances, these two variants of lookup are combined into one
function (cf, @InstEnv@).  We don't do that for family instances as the
results of matching and unification are used in two different contexts.
Moreover, matching is the wildly more frequently used operation in the case of
indexed synonyms and we don't want to slow that down by needless unification.

\begin{code}
<pre><a name="line-1"></a><a name="MatchFun"></a><span class='hs-comment'>------------------------------------------------------------</span>
<a name="line-2"></a><a name="MatchFun"></a><span class='hs-comment'>-- Might be a one-way match or a unifier</span>
<a name="line-3"></a><a name="MatchFun"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>MatchFun</span> <span class='hs-keyglyph'>=</span>  <span class='hs-conid'>FamInst</span>		<span class='hs-comment'>-- The FamInst template</span>
<a name="line-4"></a>     	      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>	<span class='hs-comment'>--   fi_tvs, fi_tys of that FamInst</span>
<a name="line-5"></a>	      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>			<span class='hs-comment'>-- Target to match against</span>
<a name="line-6"></a>	      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TvSubst</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="OneSidedMatch"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>OneSidedMatch</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Bool</span>     <span class='hs-comment'>-- Are optimisations that are only valid for</span>
<a name="line-9"></a>                              <span class='hs-comment'>-- one sided matches allowed?</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="lookup_fam_inst_env'"></a><span class='hs-definition'>lookup_fam_inst_env'</span> 	      <span class='hs-comment'>-- The worker, local to this module</span>
<a name="line-12"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MatchFun</span>
<a name="line-13"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OneSidedMatch</span>
<a name="line-14"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamInstEnv</span>
<a name="line-15"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>		<span class='hs-comment'>-- What we are looking for</span>
<a name="line-16"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInstMatch</span><span class='hs-keyglyph'>]</span> 	        <span class='hs-comment'>-- Successful matches</span>
<a name="line-17"></a><span class='hs-definition'>lookup_fam_inst_env'</span> <span class='hs-varid'>match_fun</span> <span class='hs-varid'>one_sided</span> <span class='hs-varid'>ie</span> <span class='hs-varid'>fam</span> <span class='hs-varid'>tys</span>
<a name="line-18"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isFamilyTyCon</span> <span class='hs-varid'>fam</span><span class='hs-layout'>)</span> 
<a name="line-19"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-21"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>n_tys</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>arity</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>fam</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span>	<span class='hs-comment'>-- Family type applications must be saturated</span>
<a name="line-22"></a>    <span class='hs-varid'>lookup</span> <span class='hs-varid'>ie</span>
<a name="line-23"></a>  <span class='hs-keyword'>where</span>
<a name="line-24"></a>    <span class='hs-comment'>-- See Note [Over-saturated matches]</span>
<a name="line-25"></a>    <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>fam</span>
<a name="line-26"></a>    <span class='hs-varid'>n_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span>
<a name="line-27"></a>    <span class='hs-varid'>extra_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>drop</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>tys</span>
<a name="line-28"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>match_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>add_extra_tys</span><span class='hs-layout'>)</span> 
<a name="line-29"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>arity</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>n_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>take</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>res_tys</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>res_tys</span> <span class='hs-varop'>++</span> <span class='hs-varid'>extra_tys</span><span class='hs-layout'>)</span>
<a name="line-30"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys</span><span class='hs-layout'>,</span>            <span class='hs-keyglyph'>\</span><span class='hs-varid'>res_tys</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>res_tys</span><span class='hs-layout'>)</span>
<a name="line-31"></a>       	 <span class='hs-comment'>-- The second case is the common one, hence functional representation</span>
<a name="line-32"></a>
<a name="line-33"></a>    <span class='hs-comment'>--------------</span>
<a name="line-34"></a>    <span class='hs-varid'>rough_tcs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>roughMatchTcs</span> <span class='hs-varid'>match_tys</span>
<a name="line-35"></a>    <span class='hs-varid'>all_tvs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isNothing</span> <span class='hs-varid'>rough_tcs</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>one_sided</span>
<a name="line-36"></a>
<a name="line-37"></a>    <span class='hs-comment'>--------------</span>
<a name="line-38"></a>    <span class='hs-varid'>lookup</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupUFM</span> <span class='hs-varid'>env</span> <span class='hs-varid'>fam</span> <span class='hs-keyword'>of</span>
<a name="line-39"></a>		   <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>	<span class='hs-comment'>-- No instances for this class</span>
<a name="line-40"></a>		   <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamIE</span> <span class='hs-varid'>insts</span> <span class='hs-varid'>has_tv_insts</span><span class='hs-layout'>)</span>
<a name="line-41"></a>		       <span class='hs-comment'>-- Short cut for common case:</span>
<a name="line-42"></a>		       <span class='hs-comment'>--   The thing we are looking up is of form (C a</span>
<a name="line-43"></a>		       <span class='hs-comment'>--   b c), and the FamIE has no instances of</span>
<a name="line-44"></a>		       <span class='hs-comment'>--   that form, so don't bother to search </span>
<a name="line-45"></a>		     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>all_tvs</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>has_tv_insts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-46"></a>		     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>find</span> <span class='hs-varid'>insts</span>
<a name="line-47"></a>
<a name="line-48"></a>    <span class='hs-comment'>--------------</span>
<a name="line-49"></a>    <span class='hs-varid'>find</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-50"></a>    <span class='hs-varid'>find</span> <span class='hs-layout'>(</span><span class='hs-varid'>item</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FamInst</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fi_tcs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mb_tcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>fi_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tpl_tvs</span><span class='hs-layout'>,</span> 
<a name="line-51"></a>			  <span class='hs-varid'>fi_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tpl_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>fi_tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tycon</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span>
<a name="line-52"></a>	<span class='hs-comment'>-- Fast check for no match, uses the "rough match" fields</span>
<a name="line-53"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>instanceCantMatch</span> <span class='hs-varid'>rough_tcs</span> <span class='hs-varid'>mb_tcs</span>
<a name="line-54"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>find</span> <span class='hs-varid'>rest</span>
<a name="line-55"></a>
<a name="line-56"></a>        <span class='hs-comment'>-- Proper check</span>
<a name="line-57"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>match_fun</span> <span class='hs-varid'>item</span> <span class='hs-varid'>tpl_tvs</span> <span class='hs-varid'>tpl_tys</span> <span class='hs-varid'>match_tys</span>
<a name="line-58"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>item</span><span class='hs-layout'>,</span> <span class='hs-varid'>add_extra_tys</span> <span class='hs-varop'>$</span> <span class='hs-varid'>substTyVars</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConTyVars</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>find</span> <span class='hs-varid'>rest</span>
<a name="line-59"></a>
<a name="line-60"></a>        <span class='hs-comment'>-- No match =&gt; try next</span>
<a name="line-61"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-62"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>find</span> <span class='hs-varid'>rest</span>
<a name="line-63"></a><span class='hs-comment'>-- Precondition: the tycon is saturated (or over-saturated)</span>
<a name="line-64"></a>
<a name="line-65"></a><a name="lookup_fam_inst_env"></a><span class='hs-definition'>lookup_fam_inst_env</span> 	      <span class='hs-comment'>-- The worker, local to this module</span>
<a name="line-66"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MatchFun</span>
<a name="line-67"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OneSidedMatch</span>
<a name="line-68"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FamInstEnvs</span>
<a name="line-69"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>		<span class='hs-comment'>-- What we are looking for</span>
<a name="line-70"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInstMatch</span><span class='hs-keyglyph'>]</span> 	        <span class='hs-comment'>-- Successful matches</span>
<a name="line-71"></a>
<a name="line-72"></a><span class='hs-comment'>-- Precondition: the tycon is saturated (or over-saturated)</span>
<a name="line-73"></a>
<a name="line-74"></a><span class='hs-definition'>lookup_fam_inst_env</span> <span class='hs-varid'>match_fun</span> <span class='hs-varid'>one_sided</span> <span class='hs-layout'>(</span><span class='hs-varid'>pkg_ie</span><span class='hs-layout'>,</span> <span class='hs-varid'>home_ie</span><span class='hs-layout'>)</span> <span class='hs-varid'>fam</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> 
<a name="line-75"></a>    <span class='hs-varid'>lookup_fam_inst_env'</span> <span class='hs-varid'>match_fun</span> <span class='hs-varid'>one_sided</span> <span class='hs-varid'>home_ie</span> <span class='hs-varid'>fam</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>++</span>
<a name="line-76"></a>    <span class='hs-varid'>lookup_fam_inst_env'</span> <span class='hs-varid'>match_fun</span> <span class='hs-varid'>one_sided</span> <span class='hs-varid'>pkg_ie</span>  <span class='hs-varid'>fam</span> <span class='hs-varid'>tys</span>
<a name="line-77"></a>
</pre>\end{code}

Note [Over-saturated matches]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It's ok to look up an over-saturated type constructor.  E.g.
     type family F a :: * -> *
     type instance F (a,b) = Either (a->b)

The type instance gives rise to a newtype TyCon (at a higher kind
which you can't do in Haskell!):
     newtype FPair a b = FP (Either (a->b))

Then looking up (F (Int,Bool) Char) will return a FamInstMatch 
     (FPair, [Int,Bool,Char])

The "extra" type argument [Char] just stays on the end.




%************************************************************************
%*									*
		Looking up a family instance
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="topNormaliseType"></a><span class='hs-definition'>topNormaliseType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInstEnvs</span>
<a name="line-2"></a>		 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-3"></a>	   	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-comment'>-- Get rid of *outermost* (or toplevel) </span>
<a name="line-6"></a><span class='hs-comment'>--	* type functions </span>
<a name="line-7"></a><span class='hs-comment'>--	* newtypes</span>
<a name="line-8"></a><span class='hs-comment'>-- using appropriate coercions.</span>
<a name="line-9"></a><span class='hs-comment'>-- By "outer" we mean that toplevelNormaliseType guarantees to return</span>
<a name="line-10"></a><span class='hs-comment'>-- a type that does not have a reducible redex (F ty1 .. tyn) as its</span>
<a name="line-11"></a><span class='hs-comment'>-- outermost form.  It *can* return something like (Maybe (F ty)), where</span>
<a name="line-12"></a><span class='hs-comment'>-- (F ty) is a redex.</span>
<a name="line-13"></a>
<a name="line-14"></a><span class='hs-comment'>-- Its a bit like Type.repType, but handles type families too</span>
<a name="line-15"></a>
<a name="line-16"></a><span class='hs-definition'>topNormaliseType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>ty</span>
<a name="line-18"></a>  <span class='hs-keyword'>where</span>
<a name="line-19"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCon</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-20"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> 	<span class='hs-comment'>-- Expand synonyms</span>
<a name="line-21"></a>	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>ty'</span>	
<a name="line-22"></a>
<a name="line-23"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>rec_nts</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-24"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isNewTyCon</span> <span class='hs-varid'>tc</span>		<span class='hs-comment'>-- Expand newtypes</span>
<a name="line-25"></a>	<span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>rec_nts</span> 	<span class='hs-comment'>-- See Note [Expanding newtypes] in Type.lhs</span>
<a name="line-26"></a>	  <span class='hs-keyword'>then</span> <span class='hs-conid'>Nothing</span>
<a name="line-27"></a>          <span class='hs-keyword'>else</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>nt_co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAxInstCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>newTyConCo</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-28"></a>               <span class='hs-keyword'>in</span> <span class='hs-varid'>add_co</span> <span class='hs-varid'>nt_co</span> <span class='hs-varid'>rec_nts'</span> <span class='hs-varid'>nt_rhs</span>
<a name="line-29"></a>
<a name="line-30"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-varid'>isFamilyTyCon</span> <span class='hs-varid'>tc</span>		<span class='hs-comment'>-- Expand open tycons</span>
<a name="line-31"></a>	<span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>normaliseTcApp</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-32"></a>		<span class='hs-comment'>-- Note that normaliseType fully normalises 'tys', </span>
<a name="line-33"></a>		<span class='hs-comment'>-- It has do to so to be sure that nested calls like</span>
<a name="line-34"></a>		<span class='hs-comment'>--    F (G Int)</span>
<a name="line-35"></a>		<span class='hs-comment'>-- are correctly top-normalised</span>
<a name="line-36"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isReflCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-37"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>add_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>ty</span>
<a name="line-38"></a>        <span class='hs-keyword'>where</span>
<a name="line-39"></a>          <span class='hs-varid'>nt_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newTyConInstRhs</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-40"></a>          <span class='hs-varid'>rec_nts'</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isRecursiveTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span><span class='hs-conop'>:</span><span class='hs-varid'>rec_nts</span>
<a name="line-41"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rec_nts</span>
<a name="line-42"></a>
<a name="line-43"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-44"></a>
<a name="line-45"></a>    <span class='hs-varid'>add_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>ty</span> 
<a name="line-46"></a>	<span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>go</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-47"></a>		<span class='hs-conid'>Nothing</span> 	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-48"></a>		<span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>co'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTransCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>co'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span>
<a name="line-49"></a>	 
<a name="line-50"></a>
<a name="line-51"></a><a name="normaliseTcApp"></a><span class='hs-comment'>---------------</span>
<a name="line-52"></a><span class='hs-definition'>normaliseTcApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInstEnvs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-53"></a><span class='hs-definition'>normaliseTcApp</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-54"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isFamilyTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-55"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span>	   <span class='hs-comment'>-- Unsaturated data families are possible</span>
<a name="line-56"></a>  <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>fam_inst</span><span class='hs-layout'>,</span> <span class='hs-varid'>inst_tys</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupFamInstEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>ntys</span> 
<a name="line-57"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span>    <span class='hs-comment'>-- A matching family instance exists</span>
<a name="line-58"></a>	<span class='hs-varid'>rep_tc</span>         	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>famInstTyCon</span> <span class='hs-varid'>fam_inst</span>
<a name="line-59"></a>	<span class='hs-varid'>co_tycon</span>       	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>expectJust</span> <span class='hs-str'>"lookupFamInst"</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConFamilyCoercion_maybe</span> <span class='hs-varid'>rep_tc</span><span class='hs-layout'>)</span>
<a name="line-60"></a>	<span class='hs-varid'>co</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAxInstCo</span> <span class='hs-varid'>co_tycon</span> <span class='hs-varid'>inst_tys</span>
<a name="line-61"></a>	<span class='hs-varid'>first_coi</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTransCo</span> <span class='hs-varid'>tycon_coi</span> <span class='hs-varid'>co</span>
<a name="line-62"></a>	<span class='hs-layout'>(</span><span class='hs-varid'>rest_coi</span><span class='hs-layout'>,</span><span class='hs-varid'>nty</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>normaliseType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>rep_tc</span> <span class='hs-varid'>inst_tys</span><span class='hs-layout'>)</span>
<a name="line-63"></a>	<span class='hs-varid'>fix_coi</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTransCo</span> <span class='hs-varid'>first_coi</span> <span class='hs-varid'>rest_coi</span>
<a name="line-64"></a>    <span class='hs-keyword'>in</span> 
<a name="line-65"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>fix_coi</span><span class='hs-layout'>,</span> <span class='hs-varid'>nty</span><span class='hs-layout'>)</span>
<a name="line-66"></a>
<a name="line-67"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-comment'>-- No unique matching family instance exists;</span>
<a name="line-68"></a>		<span class='hs-comment'>-- we do not do anything</span>
<a name="line-69"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tycon_coi</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>ntys</span><span class='hs-layout'>)</span>
<a name="line-70"></a>
<a name="line-71"></a>  <span class='hs-keyword'>where</span>
<a name="line-72"></a>	<span class='hs-comment'>-- Normalise the arg types so that they'll match </span>
<a name="line-73"></a>	<span class='hs-comment'>-- when we lookup in in the instance envt</span>
<a name="line-74"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>cois</span><span class='hs-layout'>,</span> <span class='hs-varid'>ntys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAndUnzip</span> <span class='hs-layout'>(</span><span class='hs-varid'>normaliseType</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-75"></a>    <span class='hs-varid'>tycon_coi</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConAppCo</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cois</span>
<a name="line-76"></a>
<a name="line-77"></a><a name="normaliseType"></a><span class='hs-comment'>---------------</span>
<a name="line-78"></a><span class='hs-definition'>normaliseType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInstEnvs</span> 		<span class='hs-comment'>-- environment with family instances</span>
<a name="line-79"></a>	      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>  			<span class='hs-comment'>-- old type</span>
<a name="line-80"></a>	      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>	<span class='hs-comment'>-- (coercion,new type), where</span>
<a name="line-81"></a>					<span class='hs-comment'>-- co :: old-type ~ new_type</span>
<a name="line-82"></a><span class='hs-comment'>-- Normalise the input type, by eliminating *all* type-function redexes</span>
<a name="line-83"></a><span class='hs-comment'>-- Returns with Refl if nothing happens</span>
<a name="line-84"></a>
<a name="line-85"></a><span class='hs-definition'>normaliseType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span> 
<a name="line-86"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>normaliseType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty'</span> 
<a name="line-87"></a><span class='hs-definition'>normaliseType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-88"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>normaliseTcApp</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-89"></a><span class='hs-definition'>normaliseType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-90"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>coi1</span><span class='hs-layout'>,</span><span class='hs-varid'>nty1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>normaliseType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty1</span>
<a name="line-91"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>coi2</span><span class='hs-layout'>,</span><span class='hs-varid'>nty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>normaliseType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty2</span>
<a name="line-92"></a>    <span class='hs-keyword'>in</span>  <span class='hs-layout'>(</span><span class='hs-varid'>mkAppCo</span> <span class='hs-varid'>coi1</span> <span class='hs-varid'>coi2</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkAppTy</span> <span class='hs-varid'>nty1</span> <span class='hs-varid'>nty2</span><span class='hs-layout'>)</span>
<a name="line-93"></a><span class='hs-definition'>normaliseType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-94"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>coi1</span><span class='hs-layout'>,</span><span class='hs-varid'>nty1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>normaliseType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty1</span>
<a name="line-95"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>coi2</span><span class='hs-layout'>,</span><span class='hs-varid'>nty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>normaliseType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty2</span>
<a name="line-96"></a>    <span class='hs-keyword'>in</span>  <span class='hs-layout'>(</span><span class='hs-varid'>mkFunCo</span> <span class='hs-varid'>coi1</span> <span class='hs-varid'>coi2</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>nty1</span> <span class='hs-varid'>nty2</span><span class='hs-layout'>)</span>
<a name="line-97"></a><span class='hs-definition'>normaliseType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tyvar</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span>
<a name="line-98"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>coi</span><span class='hs-layout'>,</span><span class='hs-varid'>nty1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>normaliseType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty1</span>
<a name="line-99"></a>    <span class='hs-keyword'>in</span>  <span class='hs-layout'>(</span><span class='hs-varid'>mkForAllCo</span> <span class='hs-varid'>tyvar</span> <span class='hs-varid'>coi</span><span class='hs-layout'>,</span> <span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tyvar</span> <span class='hs-varid'>nty1</span><span class='hs-layout'>)</span>
<a name="line-100"></a><span class='hs-definition'>normaliseType</span> <span class='hs-keyword'>_</span>   <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-101"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
</pre>\end{code}
</body>
</html>
