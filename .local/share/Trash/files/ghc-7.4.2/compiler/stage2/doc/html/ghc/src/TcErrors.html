<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>typecheck/TcErrors.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcErrors</span><span class='hs-layout'>(</span> 
<a name="line-9"></a>       <span class='hs-varid'>reportUnsolved</span><span class='hs-layout'>,</span>
<a name="line-10"></a>       <span class='hs-varid'>warnDefaulting</span><span class='hs-layout'>,</span>
<a name="line-11"></a>       <span class='hs-varid'>unifyCtxt</span><span class='hs-layout'>,</span>
<a name="line-12"></a>
<a name="line-13"></a>       <span class='hs-varid'>flattenForAllErrorTcS</span><span class='hs-layout'>,</span>
<a name="line-14"></a>       <span class='hs-varid'>solverDepthErrorTcS</span>
<a name="line-15"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-16"></a>
<a name="line-17"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-18"></a>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcMType</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcSMonad</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TypeRep</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unify</span> <span class='hs-layout'>(</span> <span class='hs-varid'>tcMatchTys</span> <span class='hs-layout'>)</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Inst</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>InstEnv</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameEnv</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>	<span class='hs-layout'>(</span> <span class='hs-varid'>idType</span> <span class='hs-layout'>)</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span> <span class='hs-layout'>(</span> <span class='hs-conid'>IPName</span> <span class='hs-layout'>)</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ListSetOps</span><span class='hs-layout'>(</span> <span class='hs-varid'>equivClasses</span> <span class='hs-layout'>)</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span><span class='hs-layout'>(</span> <span class='hs-varid'>mapCatMaybes</span> <span class='hs-layout'>)</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span><span class='hs-layout'>(</span> <span class='hs-varid'>partition</span> <span class='hs-layout'>)</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-layout'>(</span> <span class='hs-varid'>when</span><span class='hs-layout'>,</span> <span class='hs-varid'>unless</span><span class='hs-layout'>,</span> <span class='hs-varid'>filterM</span> <span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*									*
\section{Errors and contexts}
%*									*
%************************************************************************

ToDo: for these error messages, should we note the location as coming
from the insts, or just whatever seems to be around in the monad just
now?

\begin{code}
<pre><a name="line-1"></a><a name="reportUnsolved"></a><span class='hs-definition'>reportUnsolved</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-definition'>reportUnsolved</span> <span class='hs-varid'>wanted</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyWC</span> <span class='hs-varid'>wanted</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>   <span class='hs-comment'>-- Zonk to un-flatten any flatten-skols</span>
<a name="line-7"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wanted</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkWC</span> <span class='hs-varid'>wanted</span>
<a name="line-8"></a>
<a name="line-9"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>env0</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInitTidyEnv</span>
<a name="line-10"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tidy_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyFreeTyVars</span> <span class='hs-varid'>env0</span> <span class='hs-varid'>free_tvs</span>
<a name="line-11"></a>             <span class='hs-varid'>free_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarsOfWC</span> <span class='hs-varid'>wanted</span>
<a name="line-12"></a>             <span class='hs-varid'>err_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CEC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cec_encl</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-13"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>cec_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insolubleWC</span> <span class='hs-varid'>wanted</span>
<a name="line-14"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>cec_extra</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-15"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>cec_tidy</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidy_env</span> <span class='hs-layout'>}</span>
<a name="line-16"></a>             <span class='hs-varid'>tidy_wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyWC</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>wanted</span>
<a name="line-17"></a>
<a name="line-18"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"reportUnsolved"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tidy_wanted</span><span class='hs-layout'>)</span>
<a name="line-19"></a>
<a name="line-20"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>reportTidyWanteds</span> <span class='hs-varid'>err_ctxt</span> <span class='hs-varid'>tidy_wanted</span> <span class='hs-layout'>}</span>
<a name="line-21"></a>
<a name="line-22"></a><span class='hs-comment'>--------------------------------------------</span>
<a name="line-23"></a><span class='hs-comment'>--      Internal functions</span>
<a name="line-24"></a><span class='hs-comment'>--------------------------------------------</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="ReportErrCtxt"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ReportErrCtxt</span> 
<a name="line-27"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CEC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cec_encl</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Implication</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- Enclosing implications</span>
<a name="line-28"></a>                	       	       <span class='hs-comment'>--   (innermost first)</span>
<a name="line-29"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>cec_tidy</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span>
<a name="line-30"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>cec_extra</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span>       <span class='hs-comment'>-- Add this to each error message</span>
<a name="line-31"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>cec_insol</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>       <span class='hs-comment'>-- True &lt;=&gt; we are reporting insoluble errors only</span>
<a name="line-32"></a>                                    <span class='hs-comment'>--      Main effect: don't say "Cannot deduce..."</span>
<a name="line-33"></a>                                    <span class='hs-comment'>--      when reporting equality errors; see misMatchOrCND</span>
<a name="line-34"></a>      <span class='hs-layout'>}</span>
<a name="line-35"></a>
<a name="line-36"></a><a name="reportTidyImplic"></a><span class='hs-definition'>reportTidyImplic</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Implication</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-37"></a><span class='hs-definition'>reportTidyImplic</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>implic</span>
<a name="line-38"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>BracketSkol</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ctLocOrigin</span> <span class='hs-layout'>(</span><span class='hs-varid'>ic_loc</span> <span class='hs-varid'>implic</span><span class='hs-layout'>)</span>
<a name="line-39"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-varid'>insoluble</span>  <span class='hs-comment'>-- For Template Haskell brackets report only</span>
<a name="line-40"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>      <span class='hs-comment'>-- definite errors. The whole thing will be re-checked</span>
<a name="line-41"></a>                   <span class='hs-comment'>-- later when we plug it in, and meanwhile there may</span>
<a name="line-42"></a>                   <span class='hs-comment'>-- certainly be un-satisfied constraints</span>
<a name="line-43"></a>
<a name="line-44"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-45"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reportTidyWanteds</span> <span class='hs-varid'>ctxt'</span> <span class='hs-layout'>(</span><span class='hs-varid'>ic_wanted</span> <span class='hs-varid'>implic</span><span class='hs-layout'>)</span>
<a name="line-46"></a>  <span class='hs-keyword'>where</span>
<a name="line-47"></a>    <span class='hs-varid'>insoluble</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic_insol</span> <span class='hs-varid'>implic</span>
<a name="line-48"></a>    <span class='hs-varid'>ctxt'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cec_encl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implic</span> <span class='hs-conop'>:</span> <span class='hs-varid'>cec_encl</span> <span class='hs-varid'>ctxt</span>
<a name="line-49"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>cec_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insoluble</span> <span class='hs-layout'>}</span>
<a name="line-50"></a>
<a name="line-51"></a><a name="reportTidyWanteds"></a><span class='hs-definition'>reportTidyWanteds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-52"></a><span class='hs-definition'>reportTidyWanteds</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_flat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flats</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insols</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implics</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-53"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>cec_insol</span> <span class='hs-varid'>ctxt</span>     <span class='hs-comment'>-- If there are any insolubles, report only them</span>
<a name="line-54"></a>                       <span class='hs-comment'>-- because they are unconditionally wrong</span>
<a name="line-55"></a>                       <span class='hs-comment'>-- Moreover, if any of the insolubles are givens, stop right there</span>
<a name="line-56"></a>                       <span class='hs-comment'>-- ignoring nested errors, because the code is inaccessible</span>
<a name="line-57"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>given</span><span class='hs-layout'>,</span> <span class='hs-varid'>other</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>isGivenOrSolved</span> <span class='hs-varop'>.</span> <span class='hs-varid'>cc_flavor</span><span class='hs-layout'>)</span> <span class='hs-varid'>insols</span>
<a name="line-58"></a>             <span class='hs-varid'>insol_implics</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterBag</span> <span class='hs-varid'>ic_insol</span> <span class='hs-varid'>implics</span>
<a name="line-59"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>given</span>
<a name="line-60"></a>         <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mapBagM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>reportInsoluble</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>other</span>
<a name="line-61"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>mapBagM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>reportTidyImplic</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>insol_implics</span> <span class='hs-layout'>}</span>
<a name="line-62"></a>         <span class='hs-keyword'>else</span> <span class='hs-varid'>mapBagM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>reportInsoluble</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>given</span> <span class='hs-layout'>}</span>
<a name="line-63"></a>
<a name="line-64"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>          <span class='hs-comment'>-- No insoluble ones</span>
<a name="line-65"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>insols</span> <span class='hs-layout'>)</span>
<a name="line-66"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>flat_evs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bagToList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mapBag</span> <span class='hs-varid'>to_wev</span> <span class='hs-varid'>flats</span>
<a name="line-67"></a>             <span class='hs-varid'>to_wev</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Wanted</span> <span class='hs-varid'>wl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cc_flavor</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkEvVarX</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_id</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-varid'>wl</span>
<a name="line-68"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"reportTidyWanteds: unsolved is not wanted!"</span>
<a name="line-69"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>ambigs</span><span class='hs-layout'>,</span> <span class='hs-varid'>non_ambigs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span>     <span class='hs-varid'>is_ambiguous</span> <span class='hs-varid'>flat_evs</span>
<a name="line-70"></a>       	     <span class='hs-layout'>(</span><span class='hs-varid'>tv_eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>others</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionWith</span> <span class='hs-varid'>is_tv_eq</span>     <span class='hs-varid'>non_ambigs</span>
<a name="line-71"></a>
<a name="line-72"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>groupErrs</span> <span class='hs-layout'>(</span><span class='hs-varid'>reportEqErrs</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv_eqs</span>
<a name="line-73"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>tv_eqs</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>groupErrs</span> <span class='hs-layout'>(</span><span class='hs-varid'>reportFlat</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>others</span>
<a name="line-74"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapBagM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>reportTidyImplic</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>implics</span>
<a name="line-75"></a>
<a name="line-76"></a>       	   <span class='hs-comment'>-- Only report ambiguity if no other errors (at all) happened</span>
<a name="line-77"></a>	   <span class='hs-comment'>-- See Note [Avoiding spurious errors] in TcSimplify</span>
<a name="line-78"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ifErrsM</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>reportAmbigErrs</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ambigs</span> <span class='hs-layout'>}</span>
<a name="line-79"></a>  <span class='hs-keyword'>where</span>
<a name="line-80"></a>	<span class='hs-comment'>-- Report equalities of form (a~ty) first.  They are usually</span>
<a name="line-81"></a>	<span class='hs-comment'>-- skolem-equalities, and they cause confusing knock-on </span>
<a name="line-82"></a>	<span class='hs-comment'>-- effects in other errors; see test T4093b.</span>
<a name="line-83"></a>    <span class='hs-varid'>is_tv_eq</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getEqPredTys_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>evVarOfPred</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>
<a name="line-84"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>tcIsTyVarTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>||</span> <span class='hs-varid'>tcIsTyVarTy</span> <span class='hs-varid'>ty2</span>
<a name="line-85"></a>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Left</span> <span class='hs-layout'>(</span><span class='hs-varid'>c</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-86"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-87"></a>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Right</span> <span class='hs-layout'>(</span><span class='hs-varid'>c</span><span class='hs-layout'>,</span> <span class='hs-varid'>evVarOfPred</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>
<a name="line-88"></a>
<a name="line-89"></a>	<span class='hs-comment'>-- Treat it as "ambiguous" if </span>
<a name="line-90"></a>	<span class='hs-comment'>--   (a) it is a class constraint</span>
<a name="line-91"></a>        <span class='hs-comment'>--   (b) it constrains only type variables</span>
<a name="line-92"></a>	<span class='hs-comment'>--       (else we'd prefer to report it as "no instance for...")</span>
<a name="line-93"></a>        <span class='hs-comment'>--   (c) it mentions a (presumably un-filled-in) meta type variable</span>
<a name="line-94"></a>    <span class='hs-varid'>is_ambiguous</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isTyVarClassPred</span> <span class='hs-varid'>pred</span>
<a name="line-95"></a>                  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>any</span> <span class='hs-varid'>isAmbiguousTyVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>varSetElems</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-96"></a>		  <span class='hs-keyword'>where</span>   
<a name="line-97"></a>                     <span class='hs-varid'>pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evVarOfPred</span> <span class='hs-varid'>d</span>
<a name="line-98"></a>
<a name="line-99"></a><a name="reportInsoluble"></a><span class='hs-definition'>reportInsoluble</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-100"></a><span class='hs-comment'>-- Precondition: insolubles are always NonCanonicals! </span>
<a name="line-101"></a><span class='hs-definition'>reportInsoluble</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span>
<a name="line-102"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cc_id</span> <span class='hs-varid'>ct</span>
<a name="line-103"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>flav</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cc_flavor</span> <span class='hs-varid'>ct</span> 
<a name="line-104"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getEqPredTys_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>evVarPred</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-105"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setCtFlavorLoc</span> <span class='hs-varid'>flav</span> <span class='hs-varop'>$</span>
<a name="line-106"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ctxt2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cec_extra</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cec_extra</span> <span class='hs-varid'>ctxt</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>inaccessible_msg</span> <span class='hs-layout'>}</span>
<a name="line-107"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>reportEqErr</span> <span class='hs-varid'>ctxt2</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-layout'>}</span>
<a name="line-108"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-109"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"reportInsoluble"</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprEvVarWithType</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_id</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-110"></a>  <span class='hs-keyword'>where</span>
<a name="line-111"></a>    <span class='hs-varid'>inaccessible_msg</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Given</span> <span class='hs-varid'>loc</span> <span class='hs-conid'>GivenOrig</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_flavor</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-112"></a>                       <span class='hs-comment'>-- If a GivenSolved then we should not report inaccessible code</span>
<a name="line-113"></a>                     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Inaccessible code in"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-114"></a>                          <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLocOrigin</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-115"></a>                     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-116"></a>
<a name="line-117"></a><a name="reportFlat"></a><span class='hs-definition'>reportFlat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PredType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-118"></a><span class='hs-comment'>-- The [PredType] are already tidied</span>
<a name="line-119"></a><span class='hs-definition'>reportFlat</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>flats</span> <span class='hs-varid'>origin</span>
<a name="line-120"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>dicts</span><span class='hs-layout'>)</span>  <span class='hs-varop'>$</span> <span class='hs-varid'>reportDictErrs</span>   <span class='hs-varid'>ctxt</span> <span class='hs-varid'>dicts</span>  <span class='hs-varid'>origin</span>
<a name="line-121"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>)</span>    <span class='hs-varop'>$</span> <span class='hs-varid'>reportEqErrs</span>     <span class='hs-varid'>ctxt</span> <span class='hs-varid'>eqs</span>    <span class='hs-varid'>origin</span>
<a name="line-122"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>ips</span><span class='hs-layout'>)</span>    <span class='hs-varop'>$</span> <span class='hs-varid'>reportIPErrs</span>     <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ips</span>    <span class='hs-varid'>origin</span>
<a name="line-123"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>irreds</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>reportIrredsErrs</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>irreds</span> <span class='hs-varid'>origin</span> <span class='hs-layout'>}</span>
<a name="line-124"></a>  <span class='hs-keyword'>where</span>
<a name="line-125"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>dicts</span><span class='hs-layout'>,</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ips</span><span class='hs-layout'>,</span> <span class='hs-varid'>irreds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_many</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>classifyPredType</span> <span class='hs-varid'>flats</span><span class='hs-layout'>)</span>
<a name="line-126"></a>
<a name="line-127"></a>    <span class='hs-varid'>go_many</span> <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-128"></a>    <span class='hs-varid'>go_many</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span><span class='hs-conop'>:</span><span class='hs-varid'>ts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-keyword'>as</span> <span class='hs-varop'>++</span> <span class='hs-varid'>as'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>bs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>cs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>cs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ds</span> <span class='hs-varop'>++</span> <span class='hs-varid'>ds'</span><span class='hs-layout'>)</span>
<a name="line-129"></a>      <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-keyword'>as</span><span class='hs-layout'>,</span> <span class='hs-varid'>bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>t</span>
<a name="line-130"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>as'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>cs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ds'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_many</span> <span class='hs-varid'>ts</span>
<a name="line-131"></a>
<a name="line-132"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClassPred</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-133"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>EqPred</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-134"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>IPPred</span> <span class='hs-varid'>ip</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>ip</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-135"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>IrredPred</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-136"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TuplePred</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"reportFlat"</span>
<a name="line-137"></a>    <span class='hs-comment'>-- TuplePreds should have been expanded away by the constraint</span>
<a name="line-138"></a>    <span class='hs-comment'>-- simplifier, so they shouldn't show up at this point</span>
<a name="line-139"></a>
<a name="line-140"></a><span class='hs-comment'>--------------------------------------------</span>
<a name="line-141"></a><span class='hs-comment'>--      Support code </span>
<a name="line-142"></a><span class='hs-comment'>--------------------------------------------</span>
<a name="line-143"></a>
<a name="line-144"></a><a name="groupErrs"></a><span class='hs-definition'>groupErrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Deal with one group</span>
<a name="line-145"></a>	  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>WantedEvVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>	                <span class='hs-comment'>-- Unsolved wanteds</span>
<a name="line-146"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-147"></a><span class='hs-comment'>-- Group together insts with the same origin</span>
<a name="line-148"></a><span class='hs-comment'>-- We want to report them together in error messages</span>
<a name="line-149"></a>
<a name="line-150"></a><span class='hs-definition'>groupErrs</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> 
<a name="line-151"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-152"></a><span class='hs-definition'>groupErrs</span> <span class='hs-varid'>report_err</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>wanted</span><span class='hs-layout'>,</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>wanteds</span><span class='hs-layout'>)</span>
<a name="line-153"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>setCtLoc</span> <span class='hs-varid'>the_loc</span> <span class='hs-varop'>$</span>
<a name="line-154"></a>          <span class='hs-varid'>report_err</span> <span class='hs-varid'>the_xs</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLocOrigin</span> <span class='hs-varid'>the_loc</span><span class='hs-layout'>)</span>
<a name="line-155"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>groupErrs</span> <span class='hs-varid'>report_err</span> <span class='hs-varid'>others</span> <span class='hs-layout'>}</span>
<a name="line-156"></a>  <span class='hs-keyword'>where</span>
<a name="line-157"></a>   <span class='hs-varid'>the_loc</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evVarX</span> <span class='hs-varid'>wanted</span>
<a name="line-158"></a>   <span class='hs-varid'>the_key</span>	     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_key</span> <span class='hs-varid'>the_loc</span>
<a name="line-159"></a>   <span class='hs-varid'>the_xs</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>map</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>friends</span>
<a name="line-160"></a>   <span class='hs-layout'>(</span><span class='hs-varid'>friends</span><span class='hs-layout'>,</span> <span class='hs-varid'>others</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_friend</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fst</span><span class='hs-layout'>)</span> <span class='hs-varid'>wanteds</span>
<a name="line-161"></a>   <span class='hs-varid'>is_friend</span> <span class='hs-varid'>friend</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_key</span> <span class='hs-layout'>(</span><span class='hs-varid'>evVarX</span> <span class='hs-varid'>friend</span><span class='hs-layout'>)</span> <span class='hs-varop'>`same_key`</span> <span class='hs-varid'>the_key</span>
<a name="line-162"></a>
<a name="line-163"></a>   <span class='hs-varid'>mk_key</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>SrcSpan</span><span class='hs-layout'>,</span> <span class='hs-conid'>CtOrigin</span><span class='hs-layout'>)</span>
<a name="line-164"></a>   <span class='hs-varid'>mk_key</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLocSpan</span> <span class='hs-varid'>loc</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctLocOrigin</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-165"></a>
<a name="line-166"></a>   <span class='hs-varid'>same_key</span> <span class='hs-layout'>(</span><span class='hs-varid'>s1</span><span class='hs-layout'>,</span> <span class='hs-varid'>o1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>s2</span><span class='hs-layout'>,</span> <span class='hs-varid'>o2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s1</span><span class='hs-varop'>==</span><span class='hs-varid'>s2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>o1</span> <span class='hs-varop'>`same_orig`</span> <span class='hs-varid'>o2</span>
<a name="line-167"></a>   <span class='hs-varid'>same_orig</span> <span class='hs-layout'>(</span><span class='hs-conid'>OccurrenceOf</span> <span class='hs-varid'>n1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>OccurrenceOf</span> <span class='hs-varid'>n2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n1</span><span class='hs-varop'>==</span><span class='hs-varid'>n2</span>
<a name="line-168"></a>   <span class='hs-varid'>same_orig</span> <span class='hs-conid'>ScOrigin</span>          <span class='hs-conid'>ScOrigin</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-169"></a>   <span class='hs-varid'>same_orig</span> <span class='hs-conid'>DerivOrigin</span>       <span class='hs-conid'>DerivOrigin</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-170"></a>   <span class='hs-varid'>same_orig</span> <span class='hs-conid'>DefaultOrigin</span>     <span class='hs-conid'>DefaultOrigin</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-171"></a>   <span class='hs-varid'>same_orig</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-172"></a>
<a name="line-173"></a>
<a name="line-174"></a><a name="addArising"></a><span class='hs-comment'>-- Add the "arising from..." part to a message about bunch of dicts</span>
<a name="line-175"></a><span class='hs-definition'>addArising</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-176"></a><span class='hs-definition'>addArising</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>msg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprArising</span> <span class='hs-varid'>orig</span><span class='hs-layout'>)</span>
<a name="line-177"></a>
<a name="line-178"></a><a name="pprWithArising"></a><span class='hs-definition'>pprWithArising</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>WantedEvVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>WantedLoc</span><span class='hs-layout'>,</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span>
<a name="line-179"></a><span class='hs-comment'>-- Print something like</span>
<a name="line-180"></a><span class='hs-comment'>--    (Eq a) arising from a use of x at y</span>
<a name="line-181"></a><span class='hs-comment'>--    (Show a) arising from a use of p at q</span>
<a name="line-182"></a><span class='hs-comment'>-- Also return a location for the error message</span>
<a name="line-183"></a><span class='hs-definition'>pprWithArising</span> <span class='hs-conid'>[]</span> 
<a name="line-184"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"pprWithArising"</span>
<a name="line-185"></a><span class='hs-definition'>pprWithArising</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVarX</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>loc</span><span class='hs-keyglyph'>]</span>
<a name="line-186"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>loc</span><span class='hs-layout'>,</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprEvVarTheta</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ev</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprArising</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLocOrigin</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-187"></a><span class='hs-definition'>pprWithArising</span> <span class='hs-varid'>ev_vars</span>
<a name="line-188"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>first_loc</span><span class='hs-layout'>,</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr_one</span> <span class='hs-varid'>ev_vars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-189"></a>  <span class='hs-keyword'>where</span>
<a name="line-190"></a>    <span class='hs-varid'>first_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evVarX</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>ev_vars</span><span class='hs-layout'>)</span>
<a name="line-191"></a>    <span class='hs-varid'>ppr_one</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvVarX</span> <span class='hs-varid'>v</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-192"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprType</span> <span class='hs-layout'>(</span><span class='hs-varid'>evVarPred</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprArisingAt</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-193"></a>
<a name="line-194"></a><a name="addErrorReport"></a><span class='hs-definition'>addErrorReport</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-195"></a><span class='hs-definition'>addErrorReport</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrTcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>cec_tidy</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>msg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>cec_extra</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-196"></a>
<a name="line-197"></a><a name="getUserGivens"></a><span class='hs-definition'>getUserGivens</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>GivenLoc</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-198"></a><span class='hs-comment'>-- One item for each enclosing implication</span>
<a name="line-199"></a><span class='hs-definition'>getUserGivens</span> <span class='hs-layout'>(</span><span class='hs-conid'>CEC</span> <span class='hs-layout'>{</span><span class='hs-varid'>cec_encl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-200"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reverse</span> <span class='hs-varop'>$</span>
<a name="line-201"></a>    <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>givens</span><span class='hs-layout'>,</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Implic</span> <span class='hs-layout'>{</span><span class='hs-varid'>ic_given</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>givens</span><span class='hs-layout'>,</span> <span class='hs-varid'>ic_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ctxt</span>
<a name="line-202"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>givens</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
</pre>\end{code}

%************************************************************************
%*                  *
                Irreducible predicate errors
%*                  *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="reportIrredsErrs"></a><span class='hs-definition'>reportIrredsErrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PredType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-definition'>reportIrredsErrs</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>irreds</span> <span class='hs-varid'>orig</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrorReport</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>msg</span>
<a name="line-4"></a>  <span class='hs-keyword'>where</span>
<a name="line-5"></a>    <span class='hs-varid'>givens</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getUserGivens</span> <span class='hs-varid'>ctxt</span>
<a name="line-6"></a>    <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>couldNotDeduce</span> <span class='hs-varid'>givens</span> <span class='hs-layout'>(</span><span class='hs-varid'>irreds</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*									*
                Implicit parameter errors
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="reportIPErrs"></a><span class='hs-definition'>reportIPErrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>IPName</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-definition'>reportIPErrs</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ips</span> <span class='hs-varid'>orig</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrorReport</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>msg</span>
<a name="line-4"></a>  <span class='hs-keyword'>where</span>
<a name="line-5"></a>    <span class='hs-varid'>givens</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getUserGivens</span> <span class='hs-varid'>ctxt</span>
<a name="line-6"></a>    <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>givens</span>
<a name="line-7"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addArising</span> <span class='hs-varid'>orig</span> <span class='hs-varop'>$</span>
<a name="line-8"></a>          <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Unbound implicit parameter"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>plural</span> <span class='hs-varid'>ips</span>
<a name="line-9"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprTheta</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>uncurry</span> <span class='hs-varid'>mkIPPred</span><span class='hs-layout'>)</span> <span class='hs-varid'>ips</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span> 
<a name="line-10"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-11"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>couldNotDeduce</span> <span class='hs-varid'>givens</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>uncurry</span> <span class='hs-varid'>mkIPPred</span><span class='hs-layout'>)</span> <span class='hs-varid'>ips</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*									*
                Equality errors
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="reportEqErrs"></a><span class='hs-definition'>reportEqErrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-comment'>-- The [PredType] are already tidied</span>
<a name="line-3"></a><span class='hs-definition'>reportEqErrs</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>eqs</span> <span class='hs-varid'>orig</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>orig'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTidyOrigin</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>orig</span>
<a name="line-5"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>report_one</span> <span class='hs-varid'>orig'</span><span class='hs-layout'>)</span> <span class='hs-varid'>eqs</span> <span class='hs-layout'>}</span>
<a name="line-6"></a>  <span class='hs-keyword'>where</span>
<a name="line-7"></a>    <span class='hs-varid'>report_one</span> <span class='hs-varid'>orig</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-8"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>extra</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getWantedEqExtra</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-9"></a>                 <span class='hs-varid'>ctxt'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cec_extra</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extra</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>cec_extra</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>}</span>
<a name="line-10"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>reportEqErr</span> <span class='hs-varid'>ctxt'</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-layout'>}</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="getWantedEqExtra"></a><span class='hs-definition'>getWantedEqExtra</span> <span class='hs-keyglyph'>::</span>  <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-13"></a><span class='hs-definition'>getWantedEqExtra</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnifyOrigin</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uo_actual</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>act</span><span class='hs-layout'>,</span> <span class='hs-varid'>uo_expected</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exp</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-14"></a>                 <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-15"></a>  <span class='hs-comment'>-- If the types in the error message are the same as the types we are unifying,</span>
<a name="line-16"></a>  <span class='hs-comment'>-- don't add the extra expected/actual message</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>act</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>exp</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-18"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>exp</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>act</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-19"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkExpectedActualMsg</span> <span class='hs-varid'>act</span> <span class='hs-varid'>exp</span>
<a name="line-20"></a>
<a name="line-21"></a><span class='hs-definition'>getWantedEqExtra</span> <span class='hs-varid'>orig</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprArising</span> <span class='hs-varid'>orig</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="reportEqErr"></a><span class='hs-definition'>reportEqErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-24"></a><span class='hs-comment'>-- ty1 and ty2 are already tidied</span>
<a name="line-25"></a><span class='hs-definition'>reportEqErr</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-26"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tv1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetTyVar_maybe</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reportTyVarEqErr</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span>
<a name="line-27"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tv2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetTyVar_maybe</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reportTyVarEqErr</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>tv2</span> <span class='hs-varid'>ty1</span>
<a name="line-28"></a>
<a name="line-29"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>	<span class='hs-comment'>-- Neither side is a type variable</span>
<a name="line-30"></a>    		<span class='hs-comment'>-- Since the unsolved constraint is canonical, </span>
<a name="line-31"></a>		<span class='hs-comment'>-- it must therefore be of form (F tys ~ ty)</span>
<a name="line-32"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrorReport</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>misMatchOrCND</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>mkTyFunInfoMsg</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-33"></a>
<a name="line-34"></a>
<a name="line-35"></a><a name="reportTyVarEqErr"></a><span class='hs-definition'>reportTyVarEqErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-36"></a><span class='hs-comment'>-- tv1 and ty2 are already tidied</span>
<a name="line-37"></a><span class='hs-definition'>reportTyVarEqErr</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span>
<a name="line-38"></a>  <span class='hs-keyglyph'>|</span>  <span class='hs-varid'>isSkolemTyVar</span> <span class='hs-varid'>tv1</span> 	  <span class='hs-comment'>-- ty2 won't be a meta-tyvar, or else the thing would</span>
<a name="line-39"></a>     		   	  <span class='hs-comment'>-- be oriented the other way round; see TcCanonical.reOrient</span>
<a name="line-40"></a>  <span class='hs-varop'>||</span> <span class='hs-varid'>isSigTyVar</span> <span class='hs-varid'>tv1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTyVarTy</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-41"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrorReport</span> <span class='hs-layout'>(</span><span class='hs-varid'>addExtraInfo</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-42"></a>                   <span class='hs-layout'>(</span><span class='hs-varid'>misMatchOrCND</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-43"></a>
<a name="line-44"></a>  <span class='hs-comment'>-- So tv is a meta tyvar, and presumably it is</span>
<a name="line-45"></a>  <span class='hs-comment'>-- an *untouchable* meta tyvar, else it'd have been unified</span>
<a name="line-46"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>k2</span> <span class='hs-varop'>`isSubKind`</span> <span class='hs-varid'>k1</span><span class='hs-layout'>)</span>   	 <span class='hs-comment'>-- Kind error</span>
<a name="line-47"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrorReport</span> <span class='hs-varid'>ctxt</span> <span class='hs-varop'>$</span> <span class='hs-layout'>(</span><span class='hs-varid'>kindErrorMsg</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-48"></a>
<a name="line-49"></a>  <span class='hs-comment'>-- Occurs check</span>
<a name="line-50"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tv1</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>ty2</span>
<a name="line-51"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>occCheckMsg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Occurs check: cannot construct the infinite type:"</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span>
<a name="line-52"></a>                           <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'='</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-53"></a>    <span class='hs-keyword'>in</span> <span class='hs-varid'>addErrorReport</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>occCheckMsg</span>
<a name="line-54"></a>
<a name="line-55"></a>  <span class='hs-comment'>-- Check for skolem escape</span>
<a name="line-56"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>implic</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cec_encl</span> <span class='hs-varid'>ctxt</span>   <span class='hs-comment'>-- Get the innermost context</span>
<a name="line-57"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>esc_skols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>varSetElems</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>ty2</span> <span class='hs-varop'>`intersectVarSet`</span> <span class='hs-varid'>ic_skols</span> <span class='hs-varid'>implic</span><span class='hs-layout'>)</span>
<a name="line-58"></a>        <span class='hs-varid'>implic_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic_loc</span> <span class='hs-varid'>implic</span>
<a name="line-59"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>esc_skols</span><span class='hs-layout'>)</span>
<a name="line-60"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setCtLoc</span> <span class='hs-varid'>implic_loc</span> <span class='hs-varop'>$</span>	<span class='hs-comment'>-- Override the error message location from the</span>
<a name="line-61"></a>    	     			<span class='hs-comment'>-- place the equality arose to the implication site</span>
<a name="line-62"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>env_sigs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findGlobals</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitVarSet</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span>
<a name="line-63"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>misMatchMsg</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-64"></a>             <span class='hs-varid'>esc_doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"because type variable"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>plural</span> <span class='hs-varid'>esc_skols</span>
<a name="line-65"></a>                             <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprQuotedList</span> <span class='hs-varid'>esc_skols</span>
<a name="line-66"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"would escape"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-67"></a>                             <span class='hs-keyword'>if</span> <span class='hs-varid'>isSingleton</span> <span class='hs-varid'>esc_skols</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"its scope"</span><span class='hs-layout'>)</span>
<a name="line-68"></a>                                                      <span class='hs-keyword'>else</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"their scope"</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-69"></a>             <span class='hs-varid'>extra1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>esc_doc</span>
<a name="line-70"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>isSingleton</span> <span class='hs-varid'>esc_skols</span> 
<a name="line-71"></a>                                    <span class='hs-keyword'>then</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"This (rigid, skolem) type variable is"</span><span class='hs-layout'>)</span>
<a name="line-72"></a>                                    <span class='hs-keyword'>else</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"These (rigid, skolem) type variables are"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-73"></a>                                   <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"bound by"</span><span class='hs-layout'>)</span>
<a name="line-74"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLocOrigin</span> <span class='hs-varid'>implic_loc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span>
<a name="line-75"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>addErrTcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>msg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>extra1</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>mkEnvSigMsg</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span> <span class='hs-varid'>env_sigs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-76"></a>
<a name="line-77"></a>  <span class='hs-comment'>-- Nastiest case: attempt to unify an untouchable variable</span>
<a name="line-78"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>implic</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cec_encl</span> <span class='hs-varid'>ctxt</span>   <span class='hs-comment'>-- Get the innermost context</span>
<a name="line-79"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>implic_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic_loc</span> <span class='hs-varid'>implic</span>
<a name="line-80"></a>        <span class='hs-varid'>given</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic_given</span> <span class='hs-varid'>implic</span>
<a name="line-81"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setCtLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ic_loc</span> <span class='hs-varid'>implic</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-82"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>misMatchMsg</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-83"></a>             <span class='hs-varid'>extra</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span>
<a name="line-84"></a>                 <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is untouchable"</span><span class='hs-layout'>)</span>
<a name="line-85"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"inside the constraints"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprEvVarTheta</span> <span class='hs-varid'>given</span>
<a name="line-86"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"bound at"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLocOrigin</span> <span class='hs-varid'>implic_loc</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-87"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>addErrorReport</span> <span class='hs-layout'>(</span><span class='hs-varid'>addExtraInfo</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>msg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varid'>extra</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-88"></a>
<a name="line-89"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-90"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTrace</span> <span class='hs-str'>"reportTyVarEqErr"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv1</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>cec_encl</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-91"></a>    <span class='hs-varid'>return</span> <span class='hs-conid'>()</span> 
<a name="line-92"></a>    	<span class='hs-comment'>-- I don't think this should happen, and if it does I want to know</span>
<a name="line-93"></a>	<span class='hs-comment'>-- Trac #5130 happened because an actual type error was not</span>
<a name="line-94"></a>	<span class='hs-comment'>-- reported at all!  So not reporting is pretty dangerous.</span>
<a name="line-95"></a>	<span class='hs-comment'>-- </span>
<a name="line-96"></a>	<span class='hs-comment'>-- OLD, OUT OF DATE COMMENT</span>
<a name="line-97"></a>        <span class='hs-comment'>-- This can happen, by a recursive decomposition of frozen</span>
<a name="line-98"></a>        <span class='hs-comment'>-- occurs check constraints</span>
<a name="line-99"></a>        <span class='hs-comment'>-- Example: alpha ~ T Int alpha has frozen.</span>
<a name="line-100"></a>        <span class='hs-comment'>--          Then alpha gets unified to T beta gamma</span>
<a name="line-101"></a>        <span class='hs-comment'>-- So now we have  T beta gamma ~ T Int (T beta gamma)</span>
<a name="line-102"></a>        <span class='hs-comment'>-- Decompose to (beta ~ Int, gamma ~ T beta gamma)</span>
<a name="line-103"></a>        <span class='hs-comment'>-- The (gamma ~ T beta gamma) is the occurs check, but</span>
<a name="line-104"></a>        <span class='hs-comment'>-- the (beta ~ Int) isn't an error at all.  So return ()</span>
<a name="line-105"></a>  <span class='hs-keyword'>where</span>         
<a name="line-106"></a>    <span class='hs-varid'>k1</span> 	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv1</span>
<a name="line-107"></a>    <span class='hs-varid'>k2</span> 	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty2</span>
<a name="line-108"></a>    <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv1</span>
<a name="line-109"></a>
<a name="line-110"></a><a name="mkTyFunInfoMsg"></a><span class='hs-definition'>mkTyFunInfoMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-111"></a><span class='hs-comment'>-- See Note [Non-injective type functions]</span>
<a name="line-112"></a><span class='hs-definition'>mkTyFunInfoMsg</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-113"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc1</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSplitTyConApp_maybe</span> <span class='hs-varid'>ty1</span>
<a name="line-114"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc2</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSplitTyConApp_maybe</span> <span class='hs-varid'>ty2</span>
<a name="line-115"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tc1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tc2</span><span class='hs-layout'>,</span> <span class='hs-varid'>isSynFamilyTyCon</span> <span class='hs-varid'>tc1</span>
<a name="line-116"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"NB:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc1</span><span class='hs-layout'>)</span> 
<a name="line-117"></a>    <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is a type function"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>pp_inj</span> <span class='hs-varid'>tc1</span><span class='hs-layout'>)</span>
<a name="line-118"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-119"></a>  <span class='hs-keyword'>where</span>       
<a name="line-120"></a>    <span class='hs-varid'>pp_inj</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isInjectiveTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-121"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-layout'>(</span><span class='hs-str'>", and may not be injective"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-122"></a>
<a name="line-123"></a><a name="misMatchOrCND"></a><span class='hs-definition'>misMatchOrCND</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-124"></a><span class='hs-definition'>misMatchOrCND</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-125"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>cec_insol</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>misMatchMsg</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>    <span class='hs-comment'>-- If the equality is unconditionally</span>
<a name="line-126"></a>                                            <span class='hs-comment'>-- insoluble, don't report the context</span>
<a name="line-127"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>givens</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>misMatchMsg</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-128"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>couldNotDeduce</span> <span class='hs-varid'>givens</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>mkEqPred</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig</span><span class='hs-layout'>)</span>
<a name="line-129"></a>  <span class='hs-keyword'>where</span>
<a name="line-130"></a>    <span class='hs-varid'>givens</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getUserGivens</span> <span class='hs-varid'>ctxt</span>
<a name="line-131"></a>    <span class='hs-varid'>orig</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnifyOrigin</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-132"></a>
<a name="line-133"></a><a name="couldNotDeduce"></a><span class='hs-definition'>couldNotDeduce</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>GivenLoc</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ThetaType</span><span class='hs-layout'>,</span> <span class='hs-conid'>CtOrigin</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-134"></a><span class='hs-definition'>couldNotDeduce</span> <span class='hs-varid'>givens</span> <span class='hs-layout'>(</span><span class='hs-varid'>wanteds</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig</span><span class='hs-layout'>)</span>
<a name="line-135"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Could not deduce"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprTheta</span> <span class='hs-varid'>wanteds</span><span class='hs-layout'>)</span>
<a name="line-136"></a>              <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprArising</span> <span class='hs-varid'>orig</span><span class='hs-layout'>)</span>
<a name="line-137"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>pp_givens</span> <span class='hs-varid'>givens</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-138"></a>
<a name="line-139"></a><a name="pp_givens"></a><span class='hs-definition'>pp_givens</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>GivenLoc</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SDoc</span><span class='hs-keyglyph'>]</span>
<a name="line-140"></a><span class='hs-definition'>pp_givens</span> <span class='hs-varid'>givens</span> 
<a name="line-141"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>givens</span> <span class='hs-keyword'>of</span>
<a name="line-142"></a>         <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-143"></a>         <span class='hs-layout'>(</span><span class='hs-varid'>g</span><span class='hs-conop'>:</span><span class='hs-varid'>gs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>      <span class='hs-varid'>ppr_given</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"from the context"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>g</span>
<a name="line-144"></a>                 <span class='hs-conop'>:</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr_given</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"or from"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>gs</span>
<a name="line-145"></a>    <span class='hs-keyword'>where</span> <span class='hs-varid'>ppr_given</span> <span class='hs-varid'>herald</span> <span class='hs-layout'>(</span><span class='hs-varid'>gs</span><span class='hs-layout'>,</span><span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-146"></a>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>herald</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprEvVarTheta</span> <span class='hs-varid'>gs</span><span class='hs-layout'>)</span>
<a name="line-147"></a>                <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"bound by"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLocOrigin</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-148"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"at"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLocSpan</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-149"></a>
<a name="line-150"></a><a name="addExtraInfo"></a><span class='hs-definition'>addExtraInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ReportErrCtxt</span>
<a name="line-151"></a><span class='hs-comment'>-- Add on extra info about the types themselves</span>
<a name="line-152"></a><span class='hs-comment'>-- NB: The types themselves are already tidied</span>
<a name="line-153"></a><span class='hs-definition'>addExtraInfo</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-154"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cec_extra</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>extra1</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>extra2</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>cec_extra</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>}</span>
<a name="line-155"></a>  <span class='hs-keyword'>where</span>
<a name="line-156"></a>    <span class='hs-varid'>extra1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeExtraInfoMsg</span> <span class='hs-layout'>(</span><span class='hs-varid'>cec_encl</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty1</span>
<a name="line-157"></a>    <span class='hs-varid'>extra2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeExtraInfoMsg</span> <span class='hs-layout'>(</span><span class='hs-varid'>cec_encl</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span>
<a name="line-158"></a>
<a name="line-159"></a><a name="misMatchMsg"></a><span class='hs-definition'>misMatchMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>	   <span class='hs-comment'>-- Types are already tidy</span>
<a name="line-160"></a><span class='hs-definition'>misMatchMsg</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Couldn't match type"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span>
<a name="line-161"></a>	                  <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>15</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"with"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-162"></a>
<a name="line-163"></a><a name="kindErrorMsg"></a><span class='hs-definition'>kindErrorMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>   <span class='hs-comment'>-- Types are already tidy</span>
<a name="line-164"></a><span class='hs-definition'>kindErrorMsg</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-165"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Kind incompatibility when matching types:"</span><span class='hs-layout'>)</span>
<a name="line-166"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>k1</span>
<a name="line-167"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>k2</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-168"></a>  <span class='hs-keyword'>where</span>
<a name="line-169"></a>    <span class='hs-varid'>k1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty1</span>
<a name="line-170"></a>    <span class='hs-varid'>k2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty2</span>
<a name="line-171"></a>
<a name="line-172"></a><a name="typeExtraInfoMsg"></a><span class='hs-definition'>typeExtraInfoMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Implication</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-173"></a><span class='hs-comment'>-- Shows a bit of extra info about skolem constants</span>
<a name="line-174"></a><span class='hs-definition'>typeExtraInfoMsg</span> <span class='hs-varid'>implics</span> <span class='hs-varid'>ty</span>
<a name="line-175"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetTyVar_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-176"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>isSkolemTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-177"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>pp_tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-178"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-179"></a>    <span class='hs-conid'>SkolemTv</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pp_tv</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_skol</span> <span class='hs-layout'>(</span><span class='hs-varid'>getSkolemInfo</span> <span class='hs-varid'>implics</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>getSrcLoc</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-180"></a>    <span class='hs-conid'>FlatSkol</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pp_tv</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is a flattening type variable"</span><span class='hs-layout'>)</span>
<a name="line-181"></a>    <span class='hs-conid'>RuntimeUnk</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pp_tv</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is an interactive-debugger skolem"</span><span class='hs-layout'>)</span>
<a name="line-182"></a>    <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>empty</span>
<a name="line-183"></a>
<a name="line-184"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-comment'>-- Normal case</span>
<a name="line-185"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-186"></a>
<a name="line-187"></a> <span class='hs-keyword'>where</span>
<a name="line-188"></a>   <span class='hs-varid'>ppr_skol</span> <span class='hs-conid'>UnkSkol</span> <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is an unknown type variable"</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Unhelpful</span>
<a name="line-189"></a>   <span class='hs-varid'>ppr_skol</span> <span class='hs-varid'>info</span>    <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is a rigid type variable bound by"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-190"></a>                               <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>info</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"at"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>loc</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-191"></a> 
<a name="line-192"></a><a name="unifyCtxt"></a><span class='hs-comment'>--------------------</span>
<a name="line-193"></a><span class='hs-definition'>unifyCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EqOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span>
<a name="line-194"></a><span class='hs-definition'>unifyCtxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnifyOrigin</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uo_actual</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>act_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>uo_expected</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exp_ty</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>tidy_env</span>
<a name="line-195"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>act_ty'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTidyTcType</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>act_ty</span>
<a name="line-196"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>exp_ty'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTidyTcType</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>exp_ty</span>
<a name="line-197"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkExpectedActualMsg</span> <span class='hs-varid'>act_ty'</span> <span class='hs-varid'>exp_ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-198"></a>
<a name="line-199"></a><a name="mkExpectedActualMsg"></a><span class='hs-definition'>mkExpectedActualMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-200"></a><span class='hs-definition'>mkExpectedActualMsg</span> <span class='hs-varid'>act_ty</span> <span class='hs-varid'>exp_ty</span>
<a name="line-201"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Expected type"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>exp_ty</span>
<a name="line-202"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"  Actual type"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>act_ty</span> <span class='hs-keyglyph'>]</span>
</pre>\end{code}

Note [Non-injective type functions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It's very confusing to get a message like
     Couldn't match expected type `Depend s'
            against inferred type `Depend s1'
so mkTyFunInfoMsg adds:
       NB: `Depend' is type function, and hence may not be injective

Warn of loopy local equalities that were dropped.


%************************************************************************
%*									*
                 Type-class errors
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="reportDictErrs"></a><span class='hs-definition'>reportDictErrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Class</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>	
<a name="line-2"></a><span class='hs-definition'>reportDictErrs</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>wanteds</span> <span class='hs-varid'>orig</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inst_envs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetInstEnvs</span>
<a name="line-4"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>non_overlaps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>filterM</span> <span class='hs-layout'>(</span><span class='hs-varid'>reportOverlap</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>inst_envs</span> <span class='hs-varid'>orig</span><span class='hs-layout'>)</span> <span class='hs-varid'>wanteds</span>
<a name="line-5"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>non_overlaps</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-6"></a>         <span class='hs-varid'>addErrorReport</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_no_inst_err</span> <span class='hs-varid'>non_overlaps</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-7"></a>  <span class='hs-keyword'>where</span>
<a name="line-8"></a>    <span class='hs-varid'>mk_no_inst_err</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Class</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-9"></a>    <span class='hs-varid'>mk_no_inst_err</span> <span class='hs-varid'>wanteds</span>
<a name="line-10"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>givens</span>     <span class='hs-comment'>-- Top level</span>
<a name="line-11"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>addArising</span> <span class='hs-varid'>orig</span> <span class='hs-varop'>$</span>
<a name="line-12"></a>               <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"No instance"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>plural</span> <span class='hs-varid'>min_wanteds</span>
<a name="line-13"></a>                    <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"for"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprTheta</span> <span class='hs-varid'>min_wanteds</span>
<a name="line-14"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>show_fixes</span> <span class='hs-layout'>(</span><span class='hs-varid'>fixes2</span> <span class='hs-varop'>++</span> <span class='hs-varid'>fixes3</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-15"></a>
<a name="line-16"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-17"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>couldNotDeduce</span> <span class='hs-varid'>givens</span> <span class='hs-layout'>(</span><span class='hs-varid'>min_wanteds</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig</span><span class='hs-layout'>)</span>
<a name="line-18"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>show_fixes</span> <span class='hs-layout'>(</span><span class='hs-varid'>fixes1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>fixes2</span> <span class='hs-varop'>++</span> <span class='hs-varid'>fixes3</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-19"></a>      <span class='hs-keyword'>where</span>
<a name="line-20"></a>        <span class='hs-varid'>givens</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getUserGivens</span> <span class='hs-varid'>ctxt</span>
<a name="line-21"></a>        <span class='hs-varid'>min_wanteds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkMinimalBySCs</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>uncurry</span> <span class='hs-varid'>mkClassPred</span><span class='hs-layout'>)</span> <span class='hs-varid'>wanteds</span><span class='hs-layout'>)</span>
<a name="line-22"></a>
<a name="line-23"></a>        <span class='hs-varid'>fixes2</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>instance_dicts</span> <span class='hs-keyword'>of</span>
<a name="line-24"></a>                   <span class='hs-conid'>[]</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-25"></a>                   <span class='hs-keyglyph'>[</span><span class='hs-keyword'>_</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"add an instance declaration for"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-26"></a>                                <span class='hs-varid'>pprTheta</span> <span class='hs-varid'>instance_dicts</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-27"></a>                   <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"add instance declarations for"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-28"></a>                                <span class='hs-varid'>pprTheta</span> <span class='hs-varid'>instance_dicts</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-29"></a>        <span class='hs-varid'>fixes3</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>orig</span> <span class='hs-keyword'>of</span>
<a name="line-30"></a>                   <span class='hs-conid'>DerivOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>drv_fix</span><span class='hs-keyglyph'>]</span>
<a name="line-31"></a>                   <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-32"></a>
<a name="line-33"></a>        <span class='hs-varid'>instance_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterOut</span> <span class='hs-varid'>isTyVarClassPred</span> <span class='hs-varid'>min_wanteds</span>
<a name="line-34"></a>		<span class='hs-comment'>-- Insts for which it is worth suggesting an adding an </span>
<a name="line-35"></a>		<span class='hs-comment'>-- instance declaration.  Exclude tyvar dicts.</span>
<a name="line-36"></a>
<a name="line-37"></a>        <span class='hs-varid'>drv_fix</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"use a standalone 'deriving instance' declaration,"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-38"></a>                        <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"so you can specify the instance context yourself"</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-39"></a>
<a name="line-40"></a>	<span class='hs-varid'>show_fixes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SDoc</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-41"></a>	<span class='hs-varid'>show_fixes</span> <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-42"></a>	<span class='hs-varid'>show_fixes</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span><span class='hs-conop'>:</span><span class='hs-varid'>fs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Possible fix:"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> 
<a name="line-43"></a>				 <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-conop'>:</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"or"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span><span class='hs-layout'>)</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-44"></a>
<a name="line-45"></a>        <span class='hs-varid'>fixes1</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>orig</span><span class='hs-conop'>:</span><span class='hs-varid'>origs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapCatMaybes</span> <span class='hs-varid'>get_good_orig</span> <span class='hs-layout'>(</span><span class='hs-varid'>cec_encl</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-46"></a>               <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"add"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprTheta</span> <span class='hs-varid'>min_wanteds</span>
<a name="line-47"></a>                        <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"to the context of"</span><span class='hs-layout'>)</span>
<a name="line-48"></a>	              <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr_skol</span> <span class='hs-varid'>orig</span> <span class='hs-varop'>$$</span> 
<a name="line-49"></a>                                 <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"or"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_skol</span> <span class='hs-varid'>orig</span> 
<a name="line-50"></a>                                      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>orig</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>origs</span> <span class='hs-keyglyph'>]</span>
<a name="line-51"></a>                 <span class='hs-keyglyph'>]</span>    <span class='hs-keyglyph'>]</span>
<a name="line-52"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-53"></a>
<a name="line-54"></a>        <span class='hs-varid'>ppr_skol</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSkol</span> <span class='hs-varid'>dc</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the data constructor"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span>
<a name="line-55"></a>        <span class='hs-varid'>ppr_skol</span> <span class='hs-varid'>skol_info</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>skol_info</span>
<a name="line-56"></a>
<a name="line-57"></a>	<span class='hs-comment'>-- Do not suggest adding constraints to an *inferred* type signature!</span>
<a name="line-58"></a>        <span class='hs-varid'>get_good_orig</span> <span class='hs-varid'>ic</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ctLocOrigin</span> <span class='hs-layout'>(</span><span class='hs-varid'>ic_loc</span> <span class='hs-varid'>ic</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> 
<a name="line-59"></a>                             <span class='hs-conid'>SigSkol</span> <span class='hs-layout'>(</span><span class='hs-conid'>InfSigCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-60"></a>                             <span class='hs-varid'>origin</span>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>origin</span>
<a name="line-61"></a>
<a name="line-62"></a><a name="reportOverlap"></a><span class='hs-definition'>reportOverlap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstEnv</span><span class='hs-layout'>,</span><span class='hs-conid'>InstEnv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtOrigin</span>
<a name="line-63"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Class</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Bool</span>
<a name="line-64"></a><span class='hs-comment'>-- Report an overlap error if this class constraint results</span>
<a name="line-65"></a><span class='hs-comment'>-- from an overlap (returning Nothing), otherwise return (Just pred)</span>
<a name="line-66"></a><span class='hs-definition'>reportOverlap</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>inst_envs</span> <span class='hs-varid'>orig</span> <span class='hs-layout'>(</span><span class='hs-varid'>clas</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-67"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tys_flat</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>quickFlattenTy</span> <span class='hs-varid'>tys</span>
<a name="line-68"></a>           <span class='hs-comment'>-- Note [Flattening in error message generation]</span>
<a name="line-69"></a>
<a name="line-70"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupInstEnv</span> <span class='hs-varid'>inst_envs</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tys_flat</span> <span class='hs-keyword'>of</span>
<a name="line-71"></a>                <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>True</span>            <span class='hs-comment'>-- No match</span>
<a name="line-72"></a>                <span class='hs-varid'>res</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>addErrorReport</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_overlap_msg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-73"></a>                                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>False</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-74"></a>  <span class='hs-keyword'>where</span>
<a name="line-75"></a>    <span class='hs-comment'>-- Normal overlap error</span>
<a name="line-76"></a>    <span class='hs-varid'>mk_overlap_msg</span> <span class='hs-layout'>(</span><span class='hs-varid'>matches</span><span class='hs-layout'>,</span> <span class='hs-varid'>unifiers</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-77"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-78"></a>        <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span>	<span class='hs-varid'>addArising</span> <span class='hs-varid'>orig</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Overlapping instances for"</span><span class='hs-layout'>)</span> 
<a name="line-79"></a>				<span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprType</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkClassPred</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-80"></a>    	     <span class='hs-layout'>,</span>	<span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Matching instances"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span><span class='hs-layout'>,</span>
<a name="line-81"></a>    		     <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pprInstances</span> <span class='hs-varid'>ispecs</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprInstances</span> <span class='hs-varid'>unifiers</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-82"></a>
<a name="line-83"></a>             <span class='hs-layout'>,</span>  <span class='hs-keyword'>if</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>matching_givens</span><span class='hs-layout'>)</span> <span class='hs-keyword'>then</span> 
<a name="line-84"></a>                  <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Matching givens (or their superclasses)"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span>
<a name="line-85"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-varid'>matching_givens</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-86"></a>                <span class='hs-keyword'>else</span> <span class='hs-varid'>empty</span>
<a name="line-87"></a>
<a name="line-88"></a>             <span class='hs-layout'>,</span>  <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>matching_givens</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isSingleton</span> <span class='hs-varid'>matches</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>unifiers</span> <span class='hs-keyword'>then</span>
<a name="line-89"></a>                <span class='hs-comment'>-- Intuitively, some given matched the wanted in their</span>
<a name="line-90"></a>                <span class='hs-comment'>-- flattened or rewritten (from given equalities) form</span>
<a name="line-91"></a>                <span class='hs-comment'>-- but the matcher can't figure that out because the</span>
<a name="line-92"></a>                <span class='hs-comment'>-- constraints are non-flat and non-rewritten so we</span>
<a name="line-93"></a>                <span class='hs-comment'>-- simply report back the whole given</span>
<a name="line-94"></a>                <span class='hs-comment'>-- context. Accelerate Smart.hs showed this problem.</span>
<a name="line-95"></a>                  <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"There exists a (perhaps superclass) match"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span>
<a name="line-96"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>pp_givens</span> <span class='hs-varid'>givens</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-97"></a>                <span class='hs-keyword'>else</span> <span class='hs-varid'>empty</span> 
<a name="line-98"></a>
<a name="line-99"></a>	     <span class='hs-layout'>,</span>	<span class='hs-keyword'>if</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isSingleton</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span>
<a name="line-100"></a>    		<span class='hs-keyword'>then</span> 	<span class='hs-comment'>-- Two or more matches</span>
<a name="line-101"></a>		     <span class='hs-varid'>empty</span>
<a name="line-102"></a>    		<span class='hs-keyword'>else</span> 	<span class='hs-comment'>-- One match</span>
<a name="line-103"></a>		<span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The choice depends on the instantiation of"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-104"></a>	    		         <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprWithCommas</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>varSetElems</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfTypes</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-105"></a>			      <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>matching_givens</span><span class='hs-layout'>)</span> <span class='hs-keyword'>then</span>
<a name="line-106"></a>                                   <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"To pick the first instance above, use -XIncoherentInstances"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-107"></a>			                  <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"when compiling the other instance declarations"</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-108"></a>                              <span class='hs-keyword'>else</span> <span class='hs-varid'>empty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-109"></a>        <span class='hs-keyword'>where</span>
<a name="line-110"></a>            <span class='hs-varid'>ispecs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ispec</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>ispec</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matches</span><span class='hs-keyglyph'>]</span>
<a name="line-111"></a>
<a name="line-112"></a>            <span class='hs-varid'>givens</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getUserGivens</span> <span class='hs-varid'>ctxt</span>
<a name="line-113"></a>            <span class='hs-varid'>matching_givens</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapCatMaybes</span> <span class='hs-varid'>matchable</span> <span class='hs-varid'>givens</span>
<a name="line-114"></a>
<a name="line-115"></a>            <span class='hs-varid'>matchable</span> <span class='hs-layout'>(</span><span class='hs-varid'>evvars</span><span class='hs-layout'>,</span><span class='hs-varid'>gloc</span><span class='hs-layout'>)</span> 
<a name="line-116"></a>              <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ev_vars_matching</span> <span class='hs-keyword'>of</span>
<a name="line-117"></a>                     <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-118"></a>                     <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprTheta</span> <span class='hs-varid'>ev_vars_matching</span><span class='hs-layout'>)</span>
<a name="line-119"></a>                                    <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"bound by"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLocOrigin</span> <span class='hs-varid'>gloc</span><span class='hs-layout'>)</span>
<a name="line-120"></a>                                           <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"at"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLocSpan</span> <span class='hs-varid'>gloc</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-121"></a>                <span class='hs-keyword'>where</span> <span class='hs-varid'>ev_vars_matching</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>ev_var_matches</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>evVarPred</span> <span class='hs-varid'>evvars</span><span class='hs-layout'>)</span>
<a name="line-122"></a>                      <span class='hs-varid'>ev_var_matches</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>getClassPredTys_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-123"></a>                         <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>clas'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span>
<a name="line-124"></a>                           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>clas'</span> <span class='hs-varop'>==</span> <span class='hs-varid'>clas</span>
<a name="line-125"></a>                           <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMatchTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfTypes</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>tys'</span>
<a name="line-126"></a>                           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span> 
<a name="line-127"></a>                           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-128"></a>                           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>any</span> <span class='hs-varid'>ev_var_matches</span> <span class='hs-layout'>(</span><span class='hs-varid'>immSuperClasses</span> <span class='hs-varid'>clas'</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span>
<a name="line-129"></a>                         <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-130"></a>
<a name="line-131"></a>    <span class='hs-comment'>-- Overlap error because of Safe Haskell (first match should be the most</span>
<a name="line-132"></a>    <span class='hs-comment'>-- specific match)</span>
<a name="line-133"></a>    <span class='hs-varid'>mk_overlap_msg</span> <span class='hs-layout'>(</span><span class='hs-varid'>matches</span><span class='hs-layout'>,</span> <span class='hs-sel'>_unifiers</span><span class='hs-layout'>,</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span>
<a name="line-134"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>length</span> <span class='hs-varid'>matches</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>1</span> <span class='hs-layout'>)</span>
<a name="line-135"></a>        <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>addArising</span> <span class='hs-varid'>orig</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Unsafe overlapping instances for"</span><span class='hs-layout'>)</span> 
<a name="line-136"></a>                        <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprType</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkClassPred</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-137"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The matching instance is"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span><span class='hs-layout'>,</span>
<a name="line-138"></a>                    <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprInstance</span> <span class='hs-varop'>$</span> <span class='hs-varid'>head</span> <span class='hs-varid'>ispecs</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-139"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sLit</span> <span class='hs-str'>"It is compiled in a Safe module and as such can only"</span>
<a name="line-140"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sLit</span> <span class='hs-str'>"overlap instances from the same module, however it"</span>
<a name="line-141"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sLit</span> <span class='hs-str'>"overlaps the following instances from different modules:"</span>
<a name="line-142"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pprInstances</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tail</span> <span class='hs-varid'>ispecs</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-143"></a>                    <span class='hs-keyglyph'>]</span>
<a name="line-144"></a>             <span class='hs-keyglyph'>]</span>
<a name="line-145"></a>        <span class='hs-keyword'>where</span>
<a name="line-146"></a>            <span class='hs-varid'>ispecs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ispec</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>ispec</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matches</span><span class='hs-keyglyph'>]</span>
<a name="line-147"></a>
<a name="line-148"></a><a name="quickFlattenTy"></a><span class='hs-comment'>----------------------</span>
<a name="line-149"></a><span class='hs-definition'>quickFlattenTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-150"></a><span class='hs-comment'>-- See Note [Flattening in error message generation]</span>
<a name="line-151"></a><span class='hs-definition'>quickFlattenTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quickFlattenTy</span> <span class='hs-varid'>ty'</span>
<a name="line-152"></a><span class='hs-definition'>quickFlattenTy</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span>
<a name="line-153"></a><span class='hs-definition'>quickFlattenTy</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span>     <span class='hs-comment'>-- See</span>
<a name="line-154"></a>  <span class='hs-comment'>-- Don't flatten because of the danger or removing a bound variable</span>
<a name="line-155"></a><span class='hs-definition'>quickFlattenTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fy1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>quickFlattenTy</span> <span class='hs-varid'>ty1</span>
<a name="line-156"></a>                                    <span class='hs-layout'>;</span> <span class='hs-varid'>fy2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>quickFlattenTy</span> <span class='hs-varid'>ty2</span>
<a name="line-157"></a>                                    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fy1</span> <span class='hs-varid'>fy2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-158"></a><span class='hs-definition'>quickFlattenTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fy1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>quickFlattenTy</span> <span class='hs-varid'>ty1</span>
<a name="line-159"></a>                                    <span class='hs-layout'>;</span> <span class='hs-varid'>fy2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>quickFlattenTy</span> <span class='hs-varid'>ty2</span>
<a name="line-160"></a>                                    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>fy1</span> <span class='hs-varid'>fy2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-161"></a><span class='hs-definition'>quickFlattenTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-162"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isSynFamilyTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-163"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>quickFlattenTy</span> <span class='hs-varid'>tys</span> 
<a name="line-164"></a>         <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>fys</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-165"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-166"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>funtys</span><span class='hs-layout'>,</span><span class='hs-varid'>resttys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAt</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-167"></a>                <span class='hs-comment'>-- Ignore the arguments of the type family funtys</span>
<a name="line-168"></a>         <span class='hs-layout'>;</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaTyVar</span> <span class='hs-conid'>TauTv</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>funtys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-169"></a>         <span class='hs-layout'>;</span> <span class='hs-varid'>flat_resttys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>quickFlattenTy</span> <span class='hs-varid'>resttys</span>
<a name="line-170"></a>         <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldl</span> <span class='hs-conid'>AppTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>flat_resttys</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}

Note [Flattening in error message generation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider (C (Maybe (F x))), where F is a type function, and we have
instances
                C (Maybe Int) and C (Maybe a)
Since (F x) might turn into Int, this is an overlap situation, and
indeed (because of flattening) the main solver will have refrained
from solving.  But by the time we get to error message generation, we've
un-flattened the constraint.  So we must *re*-flatten it before looking
up in the instance environment, lest we only report one matching
instance when in fact there are two.

Re-flattening is pretty easy, because we don't need to keep track of
evidence.  We don't re-use the code in TcCanonical because that's in
the TcS monad, and we are in TcM here.

Note [Quick-flatten polytypes]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we see C (Ix a => blah) or C (forall a. blah) we simply refrain from
flattening any further.  After all, there can be no instance declarations
that match such things.  And flattening under a for-all is problematic
anyway; consider C (forall a. F a)

\begin{code}
<pre><a name="line-1"></a><a name="reportAmbigErrs"></a><span class='hs-definition'>reportAmbigErrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>WantedEvVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-definition'>reportAmbigErrs</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ambigs</span> 
<a name="line-3"></a><span class='hs-comment'>-- Divide into groups that share a common set of ambiguous tyvars</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>reportAmbigGroup</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>equivClasses</span> <span class='hs-varid'>cmp</span> <span class='hs-varid'>ambigs_w_tvs</span><span class='hs-layout'>)</span> 
<a name="line-5"></a> <span class='hs-keyword'>where</span>
<a name="line-6"></a>    <span class='hs-varid'>ambigs_w_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>d</span><span class='hs-layout'>,</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>isAmbiguousTyVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>varSetElems</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfEvVarX</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-7"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ambigs</span> <span class='hs-keyglyph'>]</span>
<a name="line-8"></a>    <span class='hs-varid'>cmp</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>tvs1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>tvs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs1</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>tvs2</span>
<a name="line-9"></a>
<a name="line-10"></a>
<a name="line-11"></a><a name="reportAmbigGroup"></a><span class='hs-definition'>reportAmbigGroup</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>WantedEvVar</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-12"></a><span class='hs-comment'>-- The pairs all have the same [TcTyVar]</span>
<a name="line-13"></a><span class='hs-definition'>reportAmbigGroup</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>pairs</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setCtLoc</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-15"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDOpts</span>
<a name="line-16"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>docs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findGlobals</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-17"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>addErrTcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>main_msg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>mk_msg</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>docs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-18"></a>  <span class='hs-keyword'>where</span>
<a name="line-19"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>wev</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pairs</span>
<a name="line-20"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>loc</span><span class='hs-layout'>,</span> <span class='hs-varid'>pp_wanteds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprWithArising</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span>
<a name="line-21"></a>    <span class='hs-varid'>main_msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Ambiguous type variable"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>plural</span> <span class='hs-varid'>tvs</span>
<a name="line-22"></a>	             <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprQuotedList</span> <span class='hs-varid'>tvs</span>
<a name="line-23"></a>                     <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"in the constraint"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>plural</span> <span class='hs-varid'>pairs</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span>
<a name="line-24"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varid'>pp_wanteds</span> <span class='hs-keyglyph'>]</span>
<a name="line-25"></a>
<a name="line-26"></a>    <span class='hs-varid'>mk_msg</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>docs</span> 
<a name="line-27"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>any</span> <span class='hs-varid'>isRuntimeUnkSkol</span> <span class='hs-varid'>tvs</span>  <span class='hs-comment'>-- See Note [Runtime skolems]</span>
<a name="line-28"></a>        <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Cannot resolve unknown runtime types:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-29"></a>                   <span class='hs-layout'>(</span><span class='hs-varid'>pprWithCommas</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-30"></a>                 <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Use :print or :force to determine these types"</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-31"></a>
<a name="line-32"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DerivOrigin</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ctLocOrigin</span> <span class='hs-layout'>(</span><span class='hs-varid'>evVarX</span> <span class='hs-varid'>wev</span><span class='hs-layout'>)</span>
<a name="line-33"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Probable fix: use a 'standalone deriving' declaration instead"</span><span class='hs-layout'>)</span>
<a name="line-34"></a>
<a name="line-35"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>docs</span> 
<a name="line-36"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Probable fix: add a type signature that fixes these type variable(s)"</span><span class='hs-layout'>)</span>
<a name="line-37"></a>			<span class='hs-comment'>-- This happens in things like</span>
<a name="line-38"></a>			<span class='hs-comment'>--	f x = show (read "foo")</span>
<a name="line-39"></a>			<span class='hs-comment'>-- where monomorphism doesn't play any role</span>
<a name="line-40"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-41"></a>	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Possible cause: the monomorphism restriction applied to the following:"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-42"></a>		<span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-varid'>docs</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-43"></a>		<span class='hs-varid'>mono_fix</span> <span class='hs-varid'>dflags</span><span class='hs-keyglyph'>]</span>
<a name="line-44"></a>
<a name="line-45"></a>    <span class='hs-varid'>mono_fix</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-46"></a>    <span class='hs-varid'>mono_fix</span> <span class='hs-varid'>dflags</span>
<a name="line-47"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Probable fix:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span>
<a name="line-48"></a>     	<span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"give these definition(s) an explicit type signature"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-49"></a>     	 <span class='hs-keyword'>if</span> <span class='hs-varid'>xopt</span> <span class='hs-conid'>Opt_MonomorphismRestriction</span> <span class='hs-varid'>dflags</span>
<a name="line-50"></a>         <span class='hs-keyword'>then</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"or use -XNoMonomorphismRestriction"</span><span class='hs-layout'>)</span>
<a name="line-51"></a>         <span class='hs-keyword'>else</span> <span class='hs-varid'>empty</span><span class='hs-keyglyph'>]</span>	<span class='hs-comment'>-- Only suggest adding "-XNoMonomorphismRestriction"</span>
<a name="line-52"></a>     			<span class='hs-comment'>-- if it is not already set!</span>
<a name="line-53"></a>
<a name="line-54"></a><a name="getSkolemInfo"></a><span class='hs-definition'>getSkolemInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Implication</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SkolemInfo</span>
<a name="line-55"></a><span class='hs-definition'>getSkolemInfo</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>tv</span>
<a name="line-56"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"No skolem info:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-57"></a>    <span class='hs-conid'>UnkSkol</span>
<a name="line-58"></a><span class='hs-definition'>getSkolemInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>implic</span><span class='hs-conop'>:</span><span class='hs-varid'>implics</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span>
<a name="line-59"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>ic_skols</span> <span class='hs-varid'>implic</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctLocOrigin</span> <span class='hs-layout'>(</span><span class='hs-varid'>ic_loc</span> <span class='hs-varid'>implic</span><span class='hs-layout'>)</span>
<a name="line-60"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getSkolemInfo</span> <span class='hs-varid'>implics</span> <span class='hs-varid'>tv</span>
<a name="line-61"></a>
<a name="line-62"></a><span class='hs-comment'>-----------------------</span>
<a name="line-63"></a><span class='hs-comment'>-- findGlobals looks at the value environment and finds values whose</span>
<a name="line-64"></a><span class='hs-comment'>-- types mention any of the offending type variables.  It has to be</span>
<a name="line-65"></a><span class='hs-comment'>-- careful to zonk the Id's type first, so it has to be in the monad.</span>
<a name="line-66"></a><span class='hs-comment'>-- We must be careful to pass it a zonked type variable, too.</span>
<a name="line-67"></a>
<a name="line-68"></a><a name="mkEnvSigMsg"></a><span class='hs-definition'>mkEnvSigMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SDoc</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-69"></a><span class='hs-definition'>mkEnvSigMsg</span> <span class='hs-varid'>what</span> <span class='hs-varid'>env_sigs</span>
<a name="line-70"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>env_sigs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-71"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The following variables have types that mention"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>what</span>
<a name="line-72"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-varid'>env_sigs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-73"></a>
<a name="line-74"></a><a name="findGlobals"></a><span class='hs-definition'>findGlobals</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span>
<a name="line-75"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVarSet</span>
<a name="line-76"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SDoc</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-77"></a>
<a name="line-78"></a><span class='hs-definition'>findGlobals</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>tvs</span> 
<a name="line-79"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lcl_ty_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cec_encl</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>of</span> 
<a name="line-80"></a>                        <span class='hs-conid'>[]</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>getLclTypeEnv</span>
<a name="line-81"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ic_env</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>
<a name="line-82"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>cec_tidy</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameEnvElts</span> <span class='hs-varid'>lcl_ty_env</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-83"></a>  <span class='hs-keyword'>where</span>
<a name="line-84"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>acc</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span>
<a name="line-85"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>acc</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing</span> <span class='hs-conop'>:</span> <span class='hs-varid'>things</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-86"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>maybe_doc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>find_thing</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>ignore_it</span> <span class='hs-varid'>thing</span>
<a name="line-87"></a>	<span class='hs-keyword'>case</span> <span class='hs-varid'>maybe_doc</span> <span class='hs-keyword'>of</span>
<a name="line-88"></a>	  <span class='hs-conid'>Just</span> <span class='hs-varid'>d</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tidy_env1</span> <span class='hs-layout'>(</span><span class='hs-varid'>d</span><span class='hs-conop'>:</span><span class='hs-varid'>acc</span><span class='hs-layout'>)</span> <span class='hs-varid'>things</span>
<a name="line-89"></a>	  <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tidy_env1</span> <span class='hs-varid'>acc</span>     <span class='hs-varid'>things</span>
<a name="line-90"></a>
<a name="line-91"></a>    <span class='hs-varid'>ignore_it</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>`disjointVarSet`</span> <span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>ty</span>
<a name="line-92"></a>
<a name="line-93"></a><a name="find_thing"></a><span class='hs-comment'>-----------------------</span>
<a name="line-94"></a><span class='hs-definition'>find_thing</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span>
<a name="line-95"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyThing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span>
<a name="line-96"></a><span class='hs-definition'>find_thing</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>ignore_it</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATcId</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tct_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-97"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidy_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTidyTcType</span> <span class='hs-varid'>tidy_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-98"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>ignore_it</span> <span class='hs-varid'>tidy_ty</span> <span class='hs-keyword'>then</span>
<a name="line-99"></a>	   <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-100"></a>         <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> 
<a name="line-101"></a>       <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tidy_ty</span>
<a name="line-102"></a>		       <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"bound at"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-103"></a>			 	   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>getSrcLoc</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-104"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env'</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-105"></a>
<a name="line-106"></a><span class='hs-definition'>find_thing</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>ignore_it</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyVar</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-107"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidy_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTidyTcType</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>ty</span>
<a name="line-108"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>ignore_it</span> <span class='hs-varid'>tidy_ty</span> <span class='hs-keyword'>then</span>
<a name="line-109"></a>	    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-110"></a>         <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-111"></a>       <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-comment'>-- The name tv is scoped, so we don't need to tidy it</span>
<a name="line-112"></a>            <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Scoped type variable"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>eq_stuff</span>
<a name="line-113"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varid'>bound_at</span><span class='hs-keyglyph'>]</span>
<a name="line-114"></a>
<a name="line-115"></a>            <span class='hs-varid'>eq_stuff</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tv'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetTyVar_maybe</span> <span class='hs-varid'>tidy_ty</span>
<a name="line-116"></a>		     <span class='hs-layout'>,</span> <span class='hs-varid'>getOccName</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>==</span> <span class='hs-varid'>getOccName</span> <span class='hs-varid'>tv'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-117"></a>		     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>equals</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tidy_ty</span>
<a name="line-118"></a>		<span class='hs-comment'>-- It's ok to use Type.getTyVar_maybe because ty is zonked by now</span>
<a name="line-119"></a>	    <span class='hs-varid'>bound_at</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"bound at:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>getSrcLoc</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-120"></a> 
<a name="line-121"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env1</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-122"></a>
<a name="line-123"></a><span class='hs-definition'>find_thing</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"find_thing"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-124"></a>
<a name="line-125"></a><a name="warnDefaulting"></a><span class='hs-definition'>warnDefaulting</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-126"></a><span class='hs-definition'>warnDefaulting</span> <span class='hs-varid'>wanteds</span> <span class='hs-varid'>default_ty</span>
<a name="line-127"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>warn_default</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>woptM</span> <span class='hs-conid'>Opt_WarnTypeDefaults</span>
<a name="line-128"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>env0</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInitTidyEnv</span>
<a name="line-129"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>wanted_bag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>listToBag</span> <span class='hs-varid'>wanteds</span>
<a name="line-130"></a>             <span class='hs-varid'>tidy_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyFreeTyVars</span> <span class='hs-varid'>env0</span> <span class='hs-varop'>$</span>
<a name="line-131"></a>                        <span class='hs-varid'>tyVarsOfCts</span> <span class='hs-varid'>wanted_bag</span>
<a name="line-132"></a>             <span class='hs-varid'>tidy_wanteds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyCt</span> <span class='hs-varid'>tidy_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>wanted_bag</span>
<a name="line-133"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>loc</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr_wanteds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprWithArising</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>mk_wev</span> <span class='hs-layout'>(</span><span class='hs-varid'>bagToList</span> <span class='hs-varid'>tidy_wanteds</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-134"></a>             <span class='hs-varid'>warn_msg</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Defaulting the following constraint(s) to type"</span><span class='hs-layout'>)</span>
<a name="line-135"></a>                                <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>default_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-136"></a>                            <span class='hs-num'>2</span> <span class='hs-varid'>ppr_wanteds</span>
<a name="line-137"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>setCtLoc</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>warnTc</span> <span class='hs-varid'>warn_default</span> <span class='hs-varid'>warn_msg</span> <span class='hs-layout'>}</span>
<a name="line-138"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>mk_wev</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedEvVar</span> 
<a name="line-139"></a>        <span class='hs-varid'>mk_wev</span> <span class='hs-varid'>ct</span> 
<a name="line-140"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cc_id</span> <span class='hs-varid'>ct</span> 
<a name="line-141"></a>           <span class='hs-layout'>,</span> <span class='hs-conid'>Wanted</span> <span class='hs-varid'>wloc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cc_flavor</span> <span class='hs-varid'>ct</span>
<a name="line-142"></a>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvVarX</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>wloc</span> <span class='hs-comment'>-- must return a WantedEvVar </span>
<a name="line-143"></a>        <span class='hs-varid'>mk_wev</span> <span class='hs-sel'>_ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"warnDefaulting: encountered non-wanted for defaulting"</span>
<a name="line-144"></a>
</pre>\end{code}

Note [Runtime skolems]
~~~~~~~~~~~~~~~~~~~~~~
We want to give a reasonably helpful error message for ambiguity
arising from *runtime* skolems in the debugger.  These
are created by in RtClosureInspect.zonkRTTIType.  

%************************************************************************
%*									*
                 Error from the canonicaliser
	 These ones are called *during* constraint simplification
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="solverDepthErrorTcS"></a><span class='hs-definition'>solverDepthErrorTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-2"></a><span class='hs-definition'>solverDepthErrorTcS</span> <span class='hs-varid'>depth</span> <span class='hs-varid'>stack</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>stack</span>	    <span class='hs-comment'>-- Shouldn't happen unless you say -fcontext-stack=0</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapErrTcS</span> <span class='hs-varop'>$</span> <span class='hs-varid'>failWith</span> <span class='hs-varid'>msg</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapErrTcS</span> <span class='hs-varop'>$</span> 
<a name="line-7"></a>    <span class='hs-varid'>setCtFlavorLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_flavor</span> <span class='hs-varid'>top_item</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-8"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev_vars</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonkEvVar</span> <span class='hs-varop'>.</span> <span class='hs-varid'>cc_id</span><span class='hs-layout'>)</span> <span class='hs-varid'>stack</span>
<a name="line-9"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>env0</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInitTidyEnv</span>
<a name="line-10"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tidy_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyFreeTyVars</span> <span class='hs-varid'>env0</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfEvVars</span> <span class='hs-varid'>ev_vars</span><span class='hs-layout'>)</span>
<a name="line-11"></a>             <span class='hs-varid'>tidy_ev_vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyEvVar</span> <span class='hs-varid'>tidy_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>ev_vars</span>
<a name="line-12"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>failWithTcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>hang</span> <span class='hs-varid'>msg</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprEvVars</span> <span class='hs-varid'>tidy_ev_vars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-13"></a>  <span class='hs-keyword'>where</span>
<a name="line-14"></a>    <span class='hs-varid'>top_item</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>head</span> <span class='hs-varid'>stack</span>
<a name="line-15"></a>    <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Context reduction stack overflow; size ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>depth</span>
<a name="line-16"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Use -fcontext-stack=N to increase stack size to N"</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="flattenForAllErrorTcS"></a><span class='hs-definition'>flattenForAllErrorTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-19"></a><span class='hs-definition'>flattenForAllErrorTcS</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>ty</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapErrTcS</span>        <span class='hs-varop'>$</span> 
<a name="line-21"></a>    <span class='hs-varid'>setCtFlavorLoc</span> <span class='hs-varid'>fl</span> <span class='hs-varop'>$</span> 
<a name="line-22"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>env0</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInitTidyEnv</span>
<a name="line-23"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenType</span> <span class='hs-varid'>env0</span> <span class='hs-varid'>ty</span> 
<a name="line-24"></a>             <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Cannot deal with a type function under a forall type:"</span><span class='hs-layout'>)</span>
<a name="line-25"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>]</span>
<a name="line-26"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>failWithTcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}

%************************************************************************
%*									*
                 Setting the context
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="setCtFlavorLoc"></a><span class='hs-definition'>setCtFlavorLoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-2"></a><span class='hs-definition'>setCtFlavorLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Wanted</span>  <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>   <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setCtLoc</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>thing</span>
<a name="line-3"></a><span class='hs-definition'>setCtFlavorLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Derived</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>   <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setCtLoc</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>thing</span>
<a name="line-4"></a><span class='hs-definition'>setCtFlavorLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Given</span> <span class='hs-varid'>loc</span> <span class='hs-sel'>_gk</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setCtLoc</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>thing</span>
</pre>\end{code}

%************************************************************************
%*									*
                 Tidying
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="zonkTidyTcType"></a><span class='hs-definition'>zonkTidyTcType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-definition'>zonkTidyTcType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>ty</span>
<a name="line-3"></a>                           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyOpenType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="zonkTidyOrigin"></a><span class='hs-definition'>zonkTidyOrigin</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>CtOrigin</span>
<a name="line-6"></a><span class='hs-definition'>zonkTidyOrigin</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnifyOrigin</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uo_actual</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>act</span><span class='hs-layout'>,</span> <span class='hs-varid'>uo_expected</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exp</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span>  <span class='hs-varid'>act'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTidyTcType</span> <span class='hs-layout'>(</span><span class='hs-varid'>cec_tidy</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>act</span>
<a name="line-8"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-sel'>_env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>exp'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTidyTcType</span> <span class='hs-varid'>env1</span>            <span class='hs-varid'>exp</span>
<a name="line-9"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnifyOrigin</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uo_actual</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>act'</span><span class='hs-layout'>,</span> <span class='hs-varid'>uo_expected</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exp'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-10"></a>       <span class='hs-comment'>-- Drop the returned env on the floor; we may conceivably thereby get</span>
<a name="line-11"></a>       <span class='hs-comment'>-- inconsistent naming between uses of this function</span>
<a name="line-12"></a><span class='hs-definition'>zonkTidyOrigin</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>orig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>orig</span>
</pre>\end{code}
</body>
</html>
