<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>codeGen/CgMonad.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%
\section[CgMonad]{The code generation monad}

See the beginning of the top-level @CodeGen@ module, to see how this
monadic stuff fits into the Big Picture.

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-comment'>{-# LANGUAGE BangPatterns #-}</span>
<a name="line-9"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>CgMonad</span> <span class='hs-layout'>(</span>
<a name="line-10"></a>	<span class='hs-conid'>Code</span><span class='hs-layout'>,</span>	<span class='hs-comment'>-- type</span>
<a name="line-11"></a>	<span class='hs-conid'>FCode</span><span class='hs-layout'>,</span>	<span class='hs-comment'>-- type</span>
<a name="line-12"></a>
<a name="line-13"></a>	<span class='hs-varid'>initC</span><span class='hs-layout'>,</span> <span class='hs-varid'>thenC</span><span class='hs-layout'>,</span> <span class='hs-varid'>thenFC</span><span class='hs-layout'>,</span> <span class='hs-varid'>listCs</span><span class='hs-layout'>,</span> <span class='hs-varid'>listFCs</span><span class='hs-layout'>,</span> <span class='hs-varid'>mapCs</span><span class='hs-layout'>,</span> <span class='hs-varid'>mapFCs</span><span class='hs-layout'>,</span>
<a name="line-14"></a>	<span class='hs-varid'>returnFC</span><span class='hs-layout'>,</span> <span class='hs-varid'>fixC</span><span class='hs-layout'>,</span> <span class='hs-varid'>fixC_</span><span class='hs-layout'>,</span> <span class='hs-varid'>checkedAbsC</span><span class='hs-layout'>,</span> 
<a name="line-15"></a>	<span class='hs-varid'>stmtC</span><span class='hs-layout'>,</span> <span class='hs-varid'>stmtsC</span><span class='hs-layout'>,</span> <span class='hs-varid'>labelC</span><span class='hs-layout'>,</span> <span class='hs-varid'>emitStmts</span><span class='hs-layout'>,</span> <span class='hs-varid'>nopC</span><span class='hs-layout'>,</span> <span class='hs-varid'>whenC</span><span class='hs-layout'>,</span> <span class='hs-varid'>newLabelC</span><span class='hs-layout'>,</span>
<a name="line-16"></a>	<span class='hs-varid'>newUnique</span><span class='hs-layout'>,</span> <span class='hs-varid'>newUniqSupply</span><span class='hs-layout'>,</span> 
<a name="line-17"></a>
<a name="line-18"></a>	<span class='hs-conid'>CgStmts</span><span class='hs-layout'>,</span> <span class='hs-varid'>emitCgStmts</span><span class='hs-layout'>,</span> <span class='hs-varid'>forkCgStmts</span><span class='hs-layout'>,</span> <span class='hs-varid'>cgStmtsToBlocks</span><span class='hs-layout'>,</span>
<a name="line-19"></a>	<span class='hs-varid'>getCgStmts'</span><span class='hs-layout'>,</span> <span class='hs-varid'>getCgStmts</span><span class='hs-layout'>,</span>
<a name="line-20"></a>	<span class='hs-varid'>noCgStmts</span><span class='hs-layout'>,</span> <span class='hs-varid'>oneCgStmt</span><span class='hs-layout'>,</span> <span class='hs-varid'>consCgStmt</span><span class='hs-layout'>,</span>
<a name="line-21"></a>
<a name="line-22"></a>	<span class='hs-varid'>getCmm</span><span class='hs-layout'>,</span>
<a name="line-23"></a>	<span class='hs-varid'>emitDecl</span><span class='hs-layout'>,</span> <span class='hs-varid'>emitProc</span><span class='hs-layout'>,</span> <span class='hs-varid'>emitSimpleProc</span><span class='hs-layout'>,</span>
<a name="line-24"></a>
<a name="line-25"></a>	<span class='hs-varid'>forkLabelledCode</span><span class='hs-layout'>,</span>
<a name="line-26"></a>	<span class='hs-varid'>forkClosureBody</span><span class='hs-layout'>,</span> <span class='hs-varid'>forkStatics</span><span class='hs-layout'>,</span> <span class='hs-varid'>forkAlts</span><span class='hs-layout'>,</span> <span class='hs-varid'>forkEval</span><span class='hs-layout'>,</span>
<a name="line-27"></a>	<span class='hs-varid'>forkEvalHelp</span><span class='hs-layout'>,</span> <span class='hs-varid'>forkProc</span><span class='hs-layout'>,</span> <span class='hs-varid'>codeOnly</span><span class='hs-layout'>,</span>
<a name="line-28"></a>	<span class='hs-conid'>SemiTaggingStuff</span><span class='hs-layout'>,</span> <span class='hs-conid'>ConTagZ</span><span class='hs-layout'>,</span>
<a name="line-29"></a>
<a name="line-30"></a>	<span class='hs-conid'>EndOfBlockInfo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-31"></a>	<span class='hs-varid'>setEndOfBlockInfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>getEndOfBlockInfo</span><span class='hs-layout'>,</span>
<a name="line-32"></a>
<a name="line-33"></a>	<span class='hs-varid'>setSRT</span><span class='hs-layout'>,</span> <span class='hs-varid'>getSRT</span><span class='hs-layout'>,</span>
<a name="line-34"></a>	<span class='hs-varid'>setSRTLabel</span><span class='hs-layout'>,</span> <span class='hs-varid'>getSRTLabel</span><span class='hs-layout'>,</span> 
<a name="line-35"></a>	<span class='hs-varid'>setTickyCtrLabel</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTickyCtrLabel</span><span class='hs-layout'>,</span>
<a name="line-36"></a>
<a name="line-37"></a>	<span class='hs-conid'>StackUsage</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>HeapUsage</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-38"></a>	<span class='hs-conid'>VirtualSpOffset</span><span class='hs-layout'>,</span> <span class='hs-conid'>VirtualHpOffset</span><span class='hs-layout'>,</span>
<a name="line-39"></a>	<span class='hs-varid'>initStkUsage</span><span class='hs-layout'>,</span> <span class='hs-varid'>initHpUsage</span><span class='hs-layout'>,</span>
<a name="line-40"></a>	<span class='hs-varid'>getHpUsage</span><span class='hs-layout'>,</span>  <span class='hs-varid'>setHpUsage</span><span class='hs-layout'>,</span>
<a name="line-41"></a>	<span class='hs-varid'>heapHWM</span><span class='hs-layout'>,</span>
<a name="line-42"></a>
<a name="line-43"></a>	<span class='hs-varid'>getModuleName</span><span class='hs-layout'>,</span>
<a name="line-44"></a>
<a name="line-45"></a>	<span class='hs-conid'>Sequel</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- ToDo: unabstract?</span>
<a name="line-46"></a>
<a name="line-47"></a>	<span class='hs-comment'>-- ideally we wouldn't export these, but some other modules access internal state</span>
<a name="line-48"></a>	<span class='hs-varid'>getState</span><span class='hs-layout'>,</span> <span class='hs-varid'>setState</span><span class='hs-layout'>,</span> <span class='hs-varid'>getInfoDown</span><span class='hs-layout'>,</span> <span class='hs-varid'>getDynFlags</span><span class='hs-layout'>,</span> <span class='hs-varid'>getThisPackage</span><span class='hs-layout'>,</span> 
<a name="line-49"></a>
<a name="line-50"></a>	<span class='hs-comment'>-- more localised access to monad state	</span>
<a name="line-51"></a>	<span class='hs-varid'>getStkUsage</span><span class='hs-layout'>,</span> <span class='hs-varid'>setStkUsage</span><span class='hs-layout'>,</span>
<a name="line-52"></a>	<span class='hs-varid'>getBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>setBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>getStaticBinds</span><span class='hs-layout'>,</span>
<a name="line-53"></a>
<a name="line-54"></a>	<span class='hs-comment'>-- out of general friendliness, we also export ...</span>
<a name="line-55"></a>	<span class='hs-conid'>CgInfoDownwards</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>CgState</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>	<span class='hs-comment'>-- non-abstract</span>
<a name="line-56"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-57"></a>
<a name="line-58"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-59"></a>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>CgBindery</span> <span class='hs-layout'>(</span> <span class='hs-conid'>CgBindings</span><span class='hs-layout'>,</span> <span class='hs-varid'>nukeVolatileBinds</span> <span class='hs-layout'>)</span>
<a name="line-61"></a>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-63"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BlockId</span>
<a name="line-64"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OldCmm</span>
<a name="line-65"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OldCmmUtils</span>
<a name="line-66"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CLabel</span>
<a name="line-67"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>StgSyn</span> <span class='hs-layout'>(</span><span class='hs-conid'>SRT</span><span class='hs-layout'>)</span>
<a name="line-68"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ClosureInfo</span><span class='hs-layout'>(</span> <span class='hs-conid'>ConTagZ</span> <span class='hs-layout'>)</span>
<a name="line-69"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SMRep</span>
<a name="line-70"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>
<a name="line-71"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-72"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-73"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OrdList</span>
<a name="line-74"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unique</span>
<a name="line-75"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSupply</span>
<a name="line-76"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-77"></a>
<a name="line-78"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-79"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>
<a name="line-80"></a>
<a name="line-81"></a><span class='hs-keyword'>infixr</span> <span class='hs-num'>9</span> <span class='hs-varop'>`thenC`</span>	<span class='hs-comment'>-- Right-associative!</span>
<a name="line-82"></a><span class='hs-keyword'>infixr</span> <span class='hs-num'>9</span> <span class='hs-varop'>`thenFC`</span>
</pre>\end{code}

%************************************************************************
%*									*
\subsection[CgMonad-environment]{Stuff for manipulating environments}
%*									*
%************************************************************************

This monadery has some information that it only passes {\em
downwards}, as well as some ``state'' which is modified as we go
along.

\begin{code}
<pre><a name="line-1"></a><a name="CgInfoDownwards"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CgInfoDownwards</span>	<span class='hs-comment'>-- information only passed *downwards* by the monad</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MkCgInfoDown</span> <span class='hs-layout'>{</span>
<a name="line-3"></a>	<span class='hs-varid'>cgd_dflags</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span><span class='hs-layout'>,</span>
<a name="line-4"></a>	<span class='hs-varid'>cgd_mod</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span><span class='hs-layout'>,</span>		<span class='hs-comment'>-- Module being compiled</span>
<a name="line-5"></a>	<span class='hs-varid'>cgd_statics</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CgBindings</span><span class='hs-layout'>,</span>	<span class='hs-comment'>-- [Id -&gt; info] : static environment</span>
<a name="line-6"></a>	<span class='hs-varid'>cgd_srt_lbl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CLabel</span><span class='hs-layout'>,</span>		<span class='hs-comment'>-- label of the current SRT</span>
<a name="line-7"></a>        <span class='hs-varid'>cgd_srt</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SRT</span><span class='hs-layout'>,</span>		<span class='hs-comment'>-- the current SRT</span>
<a name="line-8"></a>	<span class='hs-varid'>cgd_ticky</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CLabel</span><span class='hs-layout'>,</span>		<span class='hs-comment'>-- current destination for ticky counts</span>
<a name="line-9"></a>	<span class='hs-varid'>cgd_eob</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EndOfBlockInfo</span>	<span class='hs-comment'>-- Info for stuff to do at end of basic block:</span>
<a name="line-10"></a>  <span class='hs-layout'>}</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="initCgInfoDown"></a><span class='hs-definition'>initCgInfoDown</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CgInfoDownwards</span>
<a name="line-13"></a><span class='hs-definition'>initCgInfoDown</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>mod</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MkCgInfoDown</span> <span class='hs-layout'>{</span>	<span class='hs-varid'>cgd_dflags</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>,</span>
<a name="line-15"></a>			<span class='hs-varid'>cgd_mod</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mod</span><span class='hs-layout'>,</span>
<a name="line-16"></a>			<span class='hs-varid'>cgd_statics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarEnv</span><span class='hs-layout'>,</span>
<a name="line-17"></a>			<span class='hs-varid'>cgd_srt_lbl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"initC: srt_lbl"</span><span class='hs-layout'>,</span>
<a name="line-18"></a>			<span class='hs-varid'>cgd_srt</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"initC: srt"</span><span class='hs-layout'>,</span>
<a name="line-19"></a>			<span class='hs-varid'>cgd_ticky</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTopTickyCtrLabel</span><span class='hs-layout'>,</span>
<a name="line-20"></a>			<span class='hs-varid'>cgd_eob</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initEobInfo</span> <span class='hs-layout'>}</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="CgState"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CgState</span>
<a name="line-23"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MkCgState</span> <span class='hs-layout'>{</span>
<a name="line-24"></a>     <span class='hs-varid'>cgs_stmts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OrdList</span> <span class='hs-conid'>CgStmt</span><span class='hs-layout'>,</span>	  <span class='hs-comment'>-- Current proc</span>
<a name="line-25"></a>     <span class='hs-varid'>cgs_tops</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OrdList</span> <span class='hs-conid'>CmmDecl</span><span class='hs-layout'>,</span>
<a name="line-26"></a>	<span class='hs-comment'>-- Other procedures and data blocks in this compilation unit</span>
<a name="line-27"></a>	<span class='hs-comment'>-- Both the latter two are ordered only so that we can </span>
<a name="line-28"></a>	<span class='hs-comment'>-- reduce forward references, when it's easy to do so</span>
<a name="line-29"></a>     
<a name="line-30"></a>     <span class='hs-varid'>cgs_binds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CgBindings</span><span class='hs-layout'>,</span>	<span class='hs-comment'>-- [Id -&gt; info] : *local* bindings environment</span>
<a name="line-31"></a>     				<span class='hs-comment'>-- Bindings for top-level things are given in</span>
<a name="line-32"></a>				<span class='hs-comment'>-- the info-down part</span>
<a name="line-33"></a>     
<a name="line-34"></a>     <span class='hs-varid'>cgs_stk_usg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StackUsage</span><span class='hs-layout'>,</span>
<a name="line-35"></a>     <span class='hs-varid'>cgs_hp_usg</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HeapUsage</span><span class='hs-layout'>,</span>
<a name="line-36"></a>     
<a name="line-37"></a>     <span class='hs-varid'>cgs_uniqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UniqSupply</span> <span class='hs-layout'>}</span>
<a name="line-38"></a>
<a name="line-39"></a><a name="initCgState"></a><span class='hs-definition'>initCgState</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UniqSupply</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CgState</span>
<a name="line-40"></a><span class='hs-definition'>initCgState</span> <span class='hs-varid'>uniqs</span>
<a name="line-41"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MkCgState</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cgs_stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nilOL</span><span class='hs-layout'>,</span> <span class='hs-varid'>cgs_tops</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nilOL</span><span class='hs-layout'>,</span>
<a name="line-42"></a>		<span class='hs-varid'>cgs_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarEnv</span><span class='hs-layout'>,</span> 
<a name="line-43"></a>		<span class='hs-varid'>cgs_stk_usg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initStkUsage</span><span class='hs-layout'>,</span> 
<a name="line-44"></a>		<span class='hs-varid'>cgs_hp_usg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initHpUsage</span><span class='hs-layout'>,</span>
<a name="line-45"></a>		<span class='hs-varid'>cgs_uniqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqs</span> <span class='hs-layout'>}</span>
</pre>\end{code}

@EndOfBlockInfo@ tells what to do at the end of this block of code or,
if the expression is a @case@, what to do at the end of each
alternative.

\begin{code}
<pre><a name="line-1"></a><a name="EndOfBlockInfo"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>EndOfBlockInfo</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EndOfBlockInfo</span>
<a name="line-3"></a>	<span class='hs-conid'>VirtualSpOffset</span>   <span class='hs-comment'>-- Args Sp: trim the stack to this point at a</span>
<a name="line-4"></a>			  <span class='hs-comment'>-- return; push arguments starting just</span>
<a name="line-5"></a>			  <span class='hs-comment'>-- above this point on a tail call.</span>
<a name="line-6"></a>			  
<a name="line-7"></a>			  <span class='hs-comment'>-- This is therefore the stk ptr as seen</span>
<a name="line-8"></a>			  <span class='hs-comment'>-- by a case alternative.</span>
<a name="line-9"></a>	<span class='hs-conid'>Sequel</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="initEobInfo"></a><span class='hs-definition'>initEobInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EndOfBlockInfo</span>
<a name="line-12"></a><span class='hs-definition'>initEobInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EndOfBlockInfo</span> <span class='hs-num'>0</span> <span class='hs-conid'>OnStack</span>
</pre>\end{code}

Any addressing modes inside @Sequel@ must be ``robust,'' in the sense
that it must survive stack pointer adjustments at the end of the
block.

\begin{code}
<pre><a name="line-1"></a><a name="Sequel"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Sequel</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OnStack</span> 		<span class='hs-comment'>-- Continuation is on the stack</span>
<a name="line-3"></a>
<a name="line-4"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CaseAlts</span>
<a name="line-5"></a>	  <span class='hs-conid'>CLabel</span>     <span class='hs-comment'>-- Jump to this; if the continuation is for a vectored</span>
<a name="line-6"></a>		     <span class='hs-comment'>-- case this might be the label of a return vector</span>
<a name="line-7"></a>	  <span class='hs-conid'>SemiTaggingStuff</span>
<a name="line-8"></a>	  <span class='hs-conid'>Id</span>	      <span class='hs-comment'>-- The case binder, only used to see if it's dead</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="SemiTaggingStuff"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>SemiTaggingStuff</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Maybe</span>			<span class='hs-comment'>-- Maybe[1] we don't have any semi-tagging stuff...</span>
<a name="line-12"></a>     <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>ConTagZ</span><span class='hs-layout'>,</span> <span class='hs-conid'>CmmLit</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>	<span class='hs-comment'>-- Alternatives</span>
<a name="line-13"></a>      <span class='hs-conid'>CmmLit</span><span class='hs-layout'>)</span>			<span class='hs-comment'>-- Default (will be a can't happen RTS label if can't happen)</span>
<a name="line-14"></a>
<a name="line-15"></a><span class='hs-comment'>-- The case branch is executed only from a successful semitagging</span>
<a name="line-16"></a><span class='hs-comment'>-- venture, when a case has looked at a variable, found that it's</span>
<a name="line-17"></a><span class='hs-comment'>-- evaluated, and wants to load up the contents and go to the join</span>
<a name="line-18"></a><span class='hs-comment'>-- point.</span>
</pre>\end{code}

%************************************************************************
%*									*
		CgStmt type
%*									*
%************************************************************************

The CgStmts type is what the code generator outputs: it is a tree of
statements, including in-line labels.  The job of flattenCgStmts is to
turn this into a list of basic blocks, each of which ends in a jump
statement (either a local branch or a non-local jump).

\begin{code}
<pre><a name="line-1"></a><a name="CgStmts"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CgStmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OrdList</span> <span class='hs-conid'>CgStmt</span>
<a name="line-2"></a>
<a name="line-3"></a><a name="CgStmt"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CgStmt</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CgStmt</span>  <span class='hs-conid'>CmmStmt</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CgLabel</span> <span class='hs-conid'>BlockId</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CgFork</span>  <span class='hs-conid'>BlockId</span> <span class='hs-conid'>CgStmts</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="flattenCgStmts"></a><span class='hs-definition'>flattenCgStmts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BlockId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CgStmts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmBasicBlock</span><span class='hs-keyglyph'>]</span>
<a name="line-9"></a><span class='hs-definition'>flattenCgStmts</span> <span class='hs-varid'>id</span> <span class='hs-varid'>stmts</span> <span class='hs-keyglyph'>=</span> 
<a name="line-10"></a>	<span class='hs-keyword'>case</span> <span class='hs-varid'>flatten</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromOL</span> <span class='hs-varid'>stmts</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-11"></a>	  <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-varid'>blocks</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>blocks</span>
<a name="line-12"></a>	  <span class='hs-layout'>(</span><span class='hs-varid'>block</span><span class='hs-layout'>,</span><span class='hs-varid'>blocks</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BasicBlock</span> <span class='hs-varid'>id</span> <span class='hs-varid'>block</span> <span class='hs-conop'>:</span> <span class='hs-varid'>blocks</span>
<a name="line-13"></a> <span class='hs-keyword'>where</span>
<a name="line-14"></a>  <span class='hs-varid'>flatten</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-15"></a>
<a name="line-16"></a>  <span class='hs-comment'>-- A label at the end of a function or fork: this label must not be reachable,</span>
<a name="line-17"></a>  <span class='hs-comment'>-- but it might be referred to from another BB that also isn't reachable.</span>
<a name="line-18"></a>  <span class='hs-comment'>-- Eliminating these has to be done with a dead-code analysis.  For now,</span>
<a name="line-19"></a>  <span class='hs-comment'>-- we just make it into a well-formed block by adding a recursive jump.</span>
<a name="line-20"></a>  <span class='hs-varid'>flatten</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CgLabel</span> <span class='hs-varid'>id</span><span class='hs-keyglyph'>]</span>
<a name="line-21"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmBranch</span> <span class='hs-varid'>id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>BasicBlock</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmBranch</span> <span class='hs-varid'>id</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>)</span>
<a name="line-22"></a>
<a name="line-23"></a>  <span class='hs-comment'>-- A jump/branch: throw away all the code up to the next label, because</span>
<a name="line-24"></a>  <span class='hs-comment'>-- it is unreachable.  Be careful to keep forks that we find on the way.</span>
<a name="line-25"></a>  <span class='hs-varid'>flatten</span> <span class='hs-layout'>(</span><span class='hs-conid'>CgStmt</span> <span class='hs-varid'>stmt</span> <span class='hs-conop'>:</span> <span class='hs-varid'>stmts</span><span class='hs-layout'>)</span>
<a name="line-26"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isJump</span> <span class='hs-varid'>stmt</span>
<a name="line-27"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>dropWhile</span> <span class='hs-varid'>isOrdinaryStmt</span> <span class='hs-varid'>stmts</span> <span class='hs-keyword'>of</span>
<a name="line-28"></a>	<span class='hs-conid'>[]</span>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>stmt</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>)</span>
<a name="line-29"></a>	<span class='hs-keyglyph'>[</span><span class='hs-conid'>CgLabel</span> <span class='hs-varid'>id</span><span class='hs-keyglyph'>]</span>	       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>stmt</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>BasicBlock</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmBranch</span> <span class='hs-varid'>id</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-30"></a>	<span class='hs-layout'>(</span><span class='hs-conid'>CgLabel</span> <span class='hs-varid'>id</span> <span class='hs-conop'>:</span> <span class='hs-varid'>stmts</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>stmt</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>BasicBlock</span> <span class='hs-varid'>id</span> <span class='hs-varid'>block</span> <span class='hs-conop'>:</span> <span class='hs-varid'>blocks</span> <span class='hs-layout'>)</span>
<a name="line-31"></a>	    <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-varid'>block</span><span class='hs-layout'>,</span><span class='hs-varid'>blocks</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flatten</span> <span class='hs-varid'>stmts</span>
<a name="line-32"></a>	<span class='hs-layout'>(</span><span class='hs-conid'>CgFork</span> <span class='hs-varid'>fork_id</span> <span class='hs-varid'>stmts</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> 
<a name="line-33"></a>	   <span class='hs-varid'>flatten</span> <span class='hs-layout'>(</span><span class='hs-conid'>CgFork</span> <span class='hs-varid'>fork_id</span> <span class='hs-varid'>stmts</span> <span class='hs-conop'>:</span> <span class='hs-conid'>CgStmt</span> <span class='hs-varid'>stmt</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ss</span><span class='hs-layout'>)</span>
<a name="line-34"></a>        <span class='hs-layout'>(</span><span class='hs-conid'>CgStmt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"CgStmt not seen as ordinary"</span>
<a name="line-35"></a>
<a name="line-36"></a>  <span class='hs-varid'>flatten</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-varid'>ss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> 
<a name="line-37"></a>	<span class='hs-keyword'>case</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>of</span>
<a name="line-38"></a>	  <span class='hs-conid'>CgStmt</span> <span class='hs-varid'>stmt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>stmt</span><span class='hs-conop'>:</span><span class='hs-varid'>block</span><span class='hs-layout'>,</span><span class='hs-varid'>blocks</span><span class='hs-layout'>)</span>
<a name="line-39"></a>	  <span class='hs-conid'>CgLabel</span> <span class='hs-varid'>id</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmBranch</span> <span class='hs-varid'>id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span><span class='hs-conid'>BasicBlock</span> <span class='hs-varid'>id</span> <span class='hs-varid'>block</span><span class='hs-conop'>:</span><span class='hs-varid'>blocks</span><span class='hs-layout'>)</span>
<a name="line-40"></a>	  <span class='hs-conid'>CgFork</span> <span class='hs-varid'>fork_id</span> <span class='hs-varid'>stmts</span> <span class='hs-keyglyph'>-&gt;</span> 
<a name="line-41"></a>		<span class='hs-layout'>(</span><span class='hs-varid'>block</span><span class='hs-layout'>,</span> <span class='hs-conid'>BasicBlock</span> <span class='hs-varid'>fork_id</span> <span class='hs-varid'>fork_block</span> <span class='hs-conop'>:</span> <span class='hs-varid'>fork_blocks</span> <span class='hs-varop'>++</span> <span class='hs-varid'>blocks</span><span class='hs-layout'>)</span>
<a name="line-42"></a>		<span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-varid'>fork_block</span><span class='hs-layout'>,</span> <span class='hs-varid'>fork_blocks</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flatten</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromOL</span> <span class='hs-varid'>stmts</span><span class='hs-layout'>)</span>
<a name="line-43"></a>    <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-varid'>block</span><span class='hs-layout'>,</span><span class='hs-varid'>blocks</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flatten</span> <span class='hs-varid'>ss</span>
<a name="line-44"></a>
<a name="line-45"></a><a name="isJump"></a><span class='hs-definition'>isJump</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmStmt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-46"></a><span class='hs-definition'>isJump</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmJump</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-47"></a><span class='hs-definition'>isJump</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmBranch</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-48"></a><span class='hs-definition'>isJump</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmSwitch</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-49"></a><span class='hs-definition'>isJump</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReturn</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-50"></a><span class='hs-definition'>isJump</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-51"></a>
<a name="line-52"></a><a name="isOrdinaryStmt"></a><span class='hs-definition'>isOrdinaryStmt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CgStmt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-53"></a><span class='hs-definition'>isOrdinaryStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>CgStmt</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-54"></a><span class='hs-definition'>isOrdinaryStmt</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
</pre>\end{code}

%************************************************************************
%*									*
		Stack and heap models
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="VirtualHpOffset"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>VirtualHpOffset</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WordOff</span>	<span class='hs-comment'>-- Both are in</span>
<a name="line-2"></a><a name="VirtualSpOffset"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>VirtualSpOffset</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WordOff</span>	<span class='hs-comment'>-- units of words</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="StackUsage"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>StackUsage</span> 
<a name="line-5"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StackUsage</span> <span class='hs-layout'>{</span>
<a name="line-6"></a>	<span class='hs-varid'>virtSp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>VirtualSpOffset</span><span class='hs-layout'>,</span>
<a name="line-7"></a>		<span class='hs-comment'>-- Virtual offset of topmost allocated slot</span>
<a name="line-8"></a>
<a name="line-9"></a>	<span class='hs-varid'>frameSp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>VirtualSpOffset</span><span class='hs-layout'>,</span>
<a name="line-10"></a>		<span class='hs-comment'>-- Virtual offset of the return address of the enclosing frame.</span>
<a name="line-11"></a>		<span class='hs-comment'>-- This RA describes the liveness/pointedness of</span>
<a name="line-12"></a>		<span class='hs-comment'>-- all the stack from frameSp downwards</span>
<a name="line-13"></a>		<span class='hs-comment'>-- INVARIANT: less than or equal to virtSp</span>
<a name="line-14"></a>
<a name="line-15"></a>	 <span class='hs-varid'>freeStk</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>VirtualSpOffset</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> 
<a name="line-16"></a>		<span class='hs-comment'>-- List of free slots, in *increasing* order</span>
<a name="line-17"></a>		<span class='hs-comment'>-- INVARIANT: all &lt;= virtSp</span>
<a name="line-18"></a>		<span class='hs-comment'>-- All slots &lt;= virtSp are taken except these ones</span>
<a name="line-19"></a>
<a name="line-20"></a>	 <span class='hs-varid'>realSp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>VirtualSpOffset</span><span class='hs-layout'>,</span>	
<a name="line-21"></a>		<span class='hs-comment'>-- Virtual offset of real stack pointer register</span>
<a name="line-22"></a>
<a name="line-23"></a>	 <span class='hs-varid'>hwSp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>VirtualSpOffset</span>
<a name="line-24"></a>  <span class='hs-layout'>}</span>		   <span class='hs-comment'>-- Highest value ever taken by virtSp</span>
<a name="line-25"></a>
<a name="line-26"></a><span class='hs-comment'>-- INVARIANT: The environment contains no Stable references to</span>
<a name="line-27"></a><span class='hs-comment'>-- 	      stack slots below (lower offset) frameSp</span>
<a name="line-28"></a><span class='hs-comment'>--	      It can contain volatile references to this area though.</span>
<a name="line-29"></a>
<a name="line-30"></a><a name="HeapUsage"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>HeapUsage</span> <span class='hs-keyglyph'>=</span>
<a name="line-31"></a>  <span class='hs-conid'>HeapUsage</span> <span class='hs-layout'>{</span>
<a name="line-32"></a>	<span class='hs-varid'>virtHp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>VirtualHpOffset</span><span class='hs-layout'>,</span>	<span class='hs-comment'>-- Virtual offset of highest-allocated word</span>
<a name="line-33"></a>	<span class='hs-varid'>realHp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>VirtualHpOffset</span>	<span class='hs-comment'>-- realHp: Virtual offset of real heap ptr</span>
<a name="line-34"></a>  <span class='hs-layout'>}</span>
</pre>\end{code}

The heap high water mark is the larger of virtHp and hwHp.  The latter is
only records the high water marks of forked-off branches, so to find the
heap high water mark you have to take the max of virtHp and hwHp.  Remember,
virtHp never retreats!

Note Jan 04: ok, so why do we only look at the virtual Hp??

\begin{code}
<pre><a name="line-1"></a><a name="heapHWM"></a><span class='hs-definition'>heapHWM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HeapUsage</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VirtualHpOffset</span>
<a name="line-2"></a><span class='hs-definition'>heapHWM</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>virtHp</span>
</pre>\end{code}

Initialisation.

\begin{code}
<pre><a name="line-1"></a><a name="initStkUsage"></a><span class='hs-definition'>initStkUsage</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StackUsage</span>
<a name="line-2"></a><span class='hs-definition'>initStkUsage</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StackUsage</span> <span class='hs-layout'>{</span>
<a name="line-3"></a>			<span class='hs-varid'>virtSp</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span><span class='hs-layout'>,</span>
<a name="line-4"></a>			<span class='hs-varid'>frameSp</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span><span class='hs-layout'>,</span>
<a name="line-5"></a>			<span class='hs-varid'>freeStk</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-6"></a>			<span class='hs-varid'>realSp</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span><span class='hs-layout'>,</span>
<a name="line-7"></a>			<span class='hs-varid'>hwSp</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-8"></a>	       <span class='hs-layout'>}</span>
<a name="line-9"></a>		
<a name="line-10"></a><a name="initHpUsage"></a><span class='hs-definition'>initHpUsage</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HeapUsage</span> 
<a name="line-11"></a><span class='hs-definition'>initHpUsage</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HeapUsage</span> <span class='hs-layout'>{</span>
<a name="line-12"></a>	      	<span class='hs-varid'>virtHp</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span><span class='hs-layout'>,</span>
<a name="line-13"></a>		<span class='hs-varid'>realHp</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-14"></a>	      <span class='hs-layout'>}</span>
</pre>\end{code}

@stateIncUsage@$~e_1~e_2$ incorporates in $e_1$ the stack and heap high water
marks found in $e_2$.

\begin{code}
<pre><a name="line-1"></a><a name="stateIncUsage"></a><span class='hs-definition'>stateIncUsage</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CgState</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CgState</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CgState</span>
<a name="line-2"></a><span class='hs-definition'>stateIncUsage</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>MkCgState</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cgs_stk_usg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stk_usg</span><span class='hs-layout'>,</span> <span class='hs-varid'>cgs_hp_usg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hp_usg</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-3"></a>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s1</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cgs_hp_usg</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cgs_hp_usg</span>  <span class='hs-varid'>s1</span> <span class='hs-varop'>`maxHpHw`</span>  <span class='hs-varid'>virtHp</span> <span class='hs-varid'>hp_usg</span><span class='hs-layout'>,</span>
<a name="line-4"></a>	    <span class='hs-varid'>cgs_stk_usg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cgs_stk_usg</span> <span class='hs-varid'>s1</span> <span class='hs-varop'>`maxStkHw`</span> <span class='hs-varid'>hwSp</span>   <span class='hs-varid'>stk_usg</span> <span class='hs-layout'>}</span>
<a name="line-5"></a>       <span class='hs-varop'>`addCodeBlocksFrom`</span> <span class='hs-varid'>s2</span>
<a name="line-6"></a>		
<a name="line-7"></a><a name="stateIncUsageEval"></a><span class='hs-definition'>stateIncUsageEval</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CgState</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CgState</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CgState</span>
<a name="line-8"></a><span class='hs-definition'>stateIncUsageEval</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span>
<a name="line-9"></a>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s1</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cgs_stk_usg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cgs_stk_usg</span> <span class='hs-varid'>s1</span> <span class='hs-varop'>`maxStkHw`</span> <span class='hs-varid'>hwSp</span> <span class='hs-layout'>(</span><span class='hs-varid'>cgs_stk_usg</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-10"></a>       <span class='hs-varop'>`addCodeBlocksFrom`</span> <span class='hs-varid'>s2</span>
<a name="line-11"></a>	<span class='hs-comment'>-- We don't max the heap high-watermark because stateIncUsageEval is</span>
<a name="line-12"></a>	<span class='hs-comment'>-- used only in forkEval, which in turn is only used for blocks of code</span>
<a name="line-13"></a>	<span class='hs-comment'>-- which do their own heap-check.</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="addCodeBlocksFrom"></a><span class='hs-definition'>addCodeBlocksFrom</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CgState</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CgState</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CgState</span>
<a name="line-16"></a><a name="addCodeBlocksFrom"></a><span class='hs-comment'>-- Add code blocks from the latter to the former</span>
<a name="line-17"></a><a name="addCodeBlocksFrom"></a><span class='hs-comment'>-- (The cgs_stmts will often be empty, but not always; see codeOnly)</span>
<a name="line-18"></a><a name="addCodeBlocksFrom"></a><span class='hs-definition'>s1</span> <span class='hs-varop'>`addCodeBlocksFrom`</span> <span class='hs-varid'>s2</span>
<a name="line-19"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s1</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cgs_stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cgs_stmts</span> <span class='hs-varid'>s1</span> <span class='hs-varop'>`appOL`</span> <span class='hs-varid'>cgs_stmts</span> <span class='hs-varid'>s2</span><span class='hs-layout'>,</span>
<a name="line-20"></a>	 <span class='hs-varid'>cgs_tops</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cgs_tops</span>  <span class='hs-varid'>s1</span> <span class='hs-varop'>`appOL`</span> <span class='hs-varid'>cgs_tops</span>  <span class='hs-varid'>s2</span> <span class='hs-layout'>}</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="maxHpHw"></a><span class='hs-definition'>maxHpHw</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HeapUsage</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VirtualHpOffset</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HeapUsage</span>
<a name="line-23"></a><a name="maxHpHw"></a><span class='hs-definition'>hp_usg</span> <span class='hs-varop'>`maxHpHw`</span> <span class='hs-varid'>hw</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hp_usg</span> <span class='hs-layout'>{</span> <span class='hs-varid'>virtHp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>virtHp</span> <span class='hs-varid'>hp_usg</span> <span class='hs-varop'>`max`</span> <span class='hs-varid'>hw</span> <span class='hs-layout'>}</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="maxStkHw"></a><span class='hs-definition'>maxStkHw</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StackUsage</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VirtualSpOffset</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StackUsage</span>
<a name="line-26"></a><a name="maxStkHw"></a><span class='hs-definition'>stk_usg</span> <span class='hs-varop'>`maxStkHw`</span> <span class='hs-varid'>hw</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stk_usg</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hwSp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hwSp</span> <span class='hs-varid'>stk_usg</span> <span class='hs-varop'>`max`</span> <span class='hs-varid'>hw</span> <span class='hs-layout'>}</span>
</pre>\end{code}

%************************************************************************
%*									*
		The FCode monad
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="FCode"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>FCode</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FCode</span> <span class='hs-layout'>(</span><span class='hs-conid'>CgInfoDownwards</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CgState</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>CgState</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2"></a><a name="Code"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>Code</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>()</span>
<a name="line-3"></a>
<a name="line-4"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Monad</span> <span class='hs-conid'>FCode</span> <span class='hs-keyword'>where</span>
<a name="line-5"></a>	<span class='hs-layout'>(</span><span class='hs-varop'>&gt;&gt;=</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>thenFC</span>
<a name="line-6"></a>	<span class='hs-varid'>return</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>returnFC</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-comment'>{-# INLINE thenC #-}</span>
<a name="line-9"></a><span class='hs-comment'>{-# INLINE thenFC #-}</span>
<a name="line-10"></a><span class='hs-comment'>{-# INLINE returnFC #-}</span>
</pre>\end{code}
The Abstract~C is not in the environment so as to improve strictness.

\begin{code}
<pre><a name="line-1"></a><a name="initC"></a><span class='hs-definition'>initC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-definition'>initC</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>mod</span> <span class='hs-layout'>(</span><span class='hs-conid'>FCode</span> <span class='hs-varid'>code</span><span class='hs-layout'>)</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>uniqs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkSplitUniqSupply</span> <span class='hs-chr'>'c'</span>
<a name="line-5"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>code</span> <span class='hs-layout'>(</span><span class='hs-varid'>initCgInfoDown</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>initCgState</span> <span class='hs-varid'>uniqs</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-6"></a>	      <span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>res</span>
<a name="line-7"></a>	<span class='hs-layout'>}</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="returnFC"></a><span class='hs-definition'>returnFC</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-varid'>a</span>
<a name="line-10"></a><span class='hs-definition'>returnFC</span> <span class='hs-varid'>val</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FCode</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-varid'>state</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>val</span><span class='hs-layout'>,</span> <span class='hs-varid'>state</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="thenC"></a><span class='hs-definition'>thenC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Code</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-varid'>a</span>
<a name="line-2"></a><span class='hs-definition'>thenC</span> <span class='hs-layout'>(</span><span class='hs-conid'>FCode</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>FCode</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> 
<a name="line-3"></a>  	<span class='hs-conid'>FCode</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>info_down</span> <span class='hs-varid'>state</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>new_state</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m</span> <span class='hs-varid'>info_down</span> <span class='hs-varid'>state</span> <span class='hs-keyword'>in</span> 
<a name="line-4"></a>  		<span class='hs-varid'>k</span> <span class='hs-varid'>info_down</span> <span class='hs-varid'>new_state</span><span class='hs-layout'>)</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="listCs"></a><span class='hs-definition'>listCs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Code</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-7"></a><span class='hs-definition'>listCs</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-8"></a><span class='hs-definition'>listCs</span> <span class='hs-layout'>(</span><span class='hs-varid'>fc</span><span class='hs-conop'>:</span><span class='hs-varid'>fcs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-9"></a>	<span class='hs-varid'>fc</span>
<a name="line-10"></a>	<span class='hs-varid'>listCs</span> <span class='hs-varid'>fcs</span>
<a name="line-11"></a>   	
<a name="line-12"></a><a name="mapCs"></a><span class='hs-definition'>mapCs</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-13"></a><span class='hs-definition'>mapCs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM_</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="thenFC"></a><span class='hs-definition'>thenFC</span>	<span class='hs-keyglyph'>::</span> <span class='hs-conid'>FCode</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-varid'>c</span>
<a name="line-2"></a><span class='hs-definition'>thenFC</span> <span class='hs-layout'>(</span><span class='hs-conid'>FCode</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FCode</span> <span class='hs-layout'>(</span>
<a name="line-3"></a>	<span class='hs-keyglyph'>\</span><span class='hs-varid'>info_down</span> <span class='hs-varid'>state</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-4"></a>		<span class='hs-keyword'>let</span> 
<a name="line-5"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>m_result</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_state</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m</span> <span class='hs-varid'>info_down</span> <span class='hs-varid'>state</span>
<a name="line-6"></a>                        <span class='hs-layout'>(</span><span class='hs-conid'>FCode</span> <span class='hs-varid'>kcode</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>k</span> <span class='hs-varid'>m_result</span>
<a name="line-7"></a>		<span class='hs-keyword'>in</span> 
<a name="line-8"></a>			<span class='hs-varid'>kcode</span> <span class='hs-varid'>info_down</span> <span class='hs-varid'>new_state</span>
<a name="line-9"></a>	<span class='hs-layout'>)</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="listFCs"></a><span class='hs-definition'>listFCs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FCode</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-12"></a><span class='hs-definition'>listFCs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sequence</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="mapFCs"></a><span class='hs-definition'>mapFCs</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span>
<a name="line-15"></a><span class='hs-definition'>mapFCs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span>
</pre>\end{code}

And the knot-tying combinator:
\begin{code}
<pre><a name="line-1"></a><a name="fixC"></a><span class='hs-definition'>fixC</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-varid'>a</span>
<a name="line-2"></a><span class='hs-definition'>fixC</span> <span class='hs-varid'>fcode</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FCode</span> <span class='hs-layout'>(</span>
<a name="line-3"></a>	<span class='hs-keyglyph'>\</span><span class='hs-varid'>info_down</span> <span class='hs-varid'>state</span> <span class='hs-keyglyph'>-&gt;</span> 
<a name="line-4"></a>		<span class='hs-keyword'>let</span>
<a name="line-5"></a>			<span class='hs-conid'>FCode</span> <span class='hs-varid'>fc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fcode</span> <span class='hs-varid'>v</span>
<a name="line-6"></a>			<span class='hs-varid'>result</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fc</span> <span class='hs-varid'>info_down</span> <span class='hs-varid'>state</span>
<a name="line-7"></a>			<span class='hs-comment'>--	    ^--------^</span>
<a name="line-8"></a>		<span class='hs-keyword'>in</span>
<a name="line-9"></a>			<span class='hs-varid'>result</span>
<a name="line-10"></a>	<span class='hs-layout'>)</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="fixC_"></a><span class='hs-definition'>fixC_</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>()</span>
<a name="line-13"></a><span class='hs-definition'>fixC_</span> <span class='hs-varid'>fcode</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fixC</span> <span class='hs-varid'>fcode</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
</pre>\end{code}

%************************************************************************
%*									*
	Operators for getting and setting the state and "info_down".

%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="getState"></a><span class='hs-definition'>getState</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>CgState</span>
<a name="line-2"></a><span class='hs-definition'>getState</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FCode</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-varid'>state</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>state</span><span class='hs-layout'>,</span><span class='hs-varid'>state</span><span class='hs-layout'>)</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="setState"></a><span class='hs-definition'>setState</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CgState</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>()</span>
<a name="line-5"></a><span class='hs-definition'>setState</span> <span class='hs-varid'>state</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FCode</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>()</span><span class='hs-layout'>,</span><span class='hs-varid'>state</span><span class='hs-layout'>)</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="getStkUsage"></a><span class='hs-definition'>getStkUsage</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>StackUsage</span>
<a name="line-8"></a><span class='hs-definition'>getStkUsage</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-9"></a>	<span class='hs-varid'>state</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getState</span>
<a name="line-10"></a>	<span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>cgs_stk_usg</span> <span class='hs-varid'>state</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="setStkUsage"></a><span class='hs-definition'>setStkUsage</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StackUsage</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-13"></a><span class='hs-definition'>setStkUsage</span> <span class='hs-varid'>new_stk_usg</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-14"></a>	<span class='hs-varid'>state</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getState</span>
<a name="line-15"></a>	<span class='hs-varid'>setState</span> <span class='hs-varop'>$</span> <span class='hs-varid'>state</span> <span class='hs-layout'>{</span><span class='hs-varid'>cgs_stk_usg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_stk_usg</span><span class='hs-layout'>}</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="getHpUsage"></a><span class='hs-definition'>getHpUsage</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>HeapUsage</span>
<a name="line-18"></a><span class='hs-definition'>getHpUsage</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-19"></a>	<span class='hs-varid'>state</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getState</span>
<a name="line-20"></a>	<span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>cgs_hp_usg</span> <span class='hs-varid'>state</span>
<a name="line-21"></a>	
<a name="line-22"></a><a name="setHpUsage"></a><span class='hs-definition'>setHpUsage</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HeapUsage</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-23"></a><span class='hs-definition'>setHpUsage</span> <span class='hs-varid'>new_hp_usg</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-24"></a>	<span class='hs-varid'>state</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getState</span>
<a name="line-25"></a>	<span class='hs-varid'>setState</span> <span class='hs-varop'>$</span> <span class='hs-varid'>state</span> <span class='hs-layout'>{</span><span class='hs-varid'>cgs_hp_usg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_hp_usg</span><span class='hs-layout'>}</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="getBinds"></a><span class='hs-definition'>getBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>CgBindings</span>
<a name="line-28"></a><span class='hs-definition'>getBinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-29"></a>	<span class='hs-varid'>state</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getState</span>
<a name="line-30"></a>	<span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>cgs_binds</span> <span class='hs-varid'>state</span>
<a name="line-31"></a>	
<a name="line-32"></a><a name="setBinds"></a><span class='hs-definition'>setBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CgBindings</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>()</span>
<a name="line-33"></a><span class='hs-definition'>setBinds</span> <span class='hs-varid'>new_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-34"></a>	<span class='hs-varid'>state</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getState</span>
<a name="line-35"></a>	<span class='hs-varid'>setState</span> <span class='hs-varop'>$</span> <span class='hs-varid'>state</span> <span class='hs-layout'>{</span><span class='hs-varid'>cgs_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_binds</span><span class='hs-layout'>}</span>
<a name="line-36"></a>
<a name="line-37"></a><a name="getStaticBinds"></a><span class='hs-definition'>getStaticBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>CgBindings</span>
<a name="line-38"></a><span class='hs-definition'>getStaticBinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-39"></a>	<span class='hs-varid'>info</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInfoDown</span>
<a name="line-40"></a>	<span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>cgd_statics</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span>
<a name="line-41"></a>
<a name="line-42"></a><a name="withState"></a><span class='hs-definition'>withState</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FCode</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CgState</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-conid'>CgState</span><span class='hs-layout'>)</span>
<a name="line-43"></a><span class='hs-definition'>withState</span> <span class='hs-layout'>(</span><span class='hs-conid'>FCode</span> <span class='hs-varid'>fcode</span><span class='hs-layout'>)</span> <span class='hs-varid'>newstate</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FCode</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>info_down</span> <span class='hs-varid'>state</span> <span class='hs-keyglyph'>-&gt;</span> 
<a name="line-44"></a>	<span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>retval</span><span class='hs-layout'>,</span> <span class='hs-varid'>state2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fcode</span> <span class='hs-varid'>info_down</span> <span class='hs-varid'>newstate</span> <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>retval</span><span class='hs-layout'>,</span><span class='hs-varid'>state2</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>state</span><span class='hs-layout'>)</span>
<a name="line-45"></a>
<a name="line-46"></a><a name="newUniqSupply"></a><span class='hs-definition'>newUniqSupply</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>UniqSupply</span>
<a name="line-47"></a><span class='hs-definition'>newUniqSupply</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-48"></a>	<span class='hs-varid'>state</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getState</span>
<a name="line-49"></a>	<span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>us1</span><span class='hs-layout'>,</span> <span class='hs-varid'>us2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitUniqSupply</span> <span class='hs-layout'>(</span><span class='hs-varid'>cgs_uniqs</span> <span class='hs-varid'>state</span><span class='hs-layout'>)</span>
<a name="line-50"></a>	<span class='hs-varid'>setState</span> <span class='hs-varop'>$</span> <span class='hs-varid'>state</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cgs_uniqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>us1</span> <span class='hs-layout'>}</span>
<a name="line-51"></a>	<span class='hs-varid'>return</span> <span class='hs-varid'>us2</span>
<a name="line-52"></a>
<a name="line-53"></a><a name="newUnique"></a><span class='hs-definition'>newUnique</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>Unique</span>
<a name="line-54"></a><span class='hs-definition'>newUnique</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-55"></a>	<span class='hs-varid'>us</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUniqSupply</span>
<a name="line-56"></a>	<span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>uniqFromSupply</span> <span class='hs-varid'>us</span><span class='hs-layout'>)</span>
<a name="line-57"></a>
<a name="line-58"></a><a name="getInfoDown"></a><span class='hs-comment'>------------------</span>
<a name="line-59"></a><span class='hs-definition'>getInfoDown</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>CgInfoDownwards</span>
<a name="line-60"></a><span class='hs-definition'>getInfoDown</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FCode</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>info_down</span> <span class='hs-varid'>state</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>info_down</span><span class='hs-layout'>,</span><span class='hs-varid'>state</span><span class='hs-layout'>)</span>
<a name="line-61"></a>
<a name="line-62"></a><a name="getDynFlags"></a><span class='hs-definition'>getDynFlags</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>DynFlags</span>
<a name="line-63"></a><span class='hs-definition'>getDynFlags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM</span> <span class='hs-varid'>cgd_dflags</span> <span class='hs-varid'>getInfoDown</span>
<a name="line-64"></a>
<a name="line-65"></a><a name="getThisPackage"></a><span class='hs-definition'>getThisPackage</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>PackageId</span>
<a name="line-66"></a><span class='hs-definition'>getThisPackage</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM</span> <span class='hs-varid'>thisPackage</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-67"></a>
<a name="line-68"></a><a name="withInfoDown"></a><span class='hs-definition'>withInfoDown</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FCode</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CgInfoDownwards</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-varid'>a</span>
<a name="line-69"></a><span class='hs-definition'>withInfoDown</span> <span class='hs-layout'>(</span><span class='hs-conid'>FCode</span> <span class='hs-varid'>fcode</span><span class='hs-layout'>)</span> <span class='hs-varid'>info_down</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FCode</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-varid'>state</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fcode</span> <span class='hs-varid'>info_down</span> <span class='hs-varid'>state</span> 
<a name="line-70"></a>
<a name="line-71"></a><a name="doFCode"></a><span class='hs-definition'>doFCode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FCode</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CgInfoDownwards</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CgState</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-conid'>CgState</span><span class='hs-layout'>)</span>
<a name="line-72"></a><span class='hs-definition'>doFCode</span> <span class='hs-layout'>(</span><span class='hs-conid'>FCode</span> <span class='hs-varid'>fcode</span><span class='hs-layout'>)</span> <span class='hs-varid'>info_down</span> <span class='hs-varid'>state</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fcode</span> <span class='hs-varid'>info_down</span> <span class='hs-varid'>state</span>
</pre>\end{code}


%************************************************************************
%*									*
		Forking
%*									*
%************************************************************************

@forkClosureBody@ takes a code, $c$, and compiles it in a completely
fresh environment, except that:
	- compilation info and statics are passed in unchanged.
The current environment is passed on completely unaltered, except that
abstract C from the fork is incorporated.

@forkProc@ takes a code and compiles it in the current environment,
returning the basic blocks thus constructed.  The current environment
is passed on completely unchanged.  It is pretty similar to
@getBlocks@, except that the latter does affect the environment.

@forkStatics@ $fc$ compiles $fc$ in an environment whose statics come
from the current bindings, but which is otherwise freshly initialised.
The Abstract~C returned is attached to the current state, but the
bindings and usage information is otherwise unchanged.

\begin{code}
<pre><a name="line-1"></a><a name="forkClosureBody"></a><span class='hs-definition'>forkClosureBody</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Code</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-2"></a><span class='hs-definition'>forkClosureBody</span> <span class='hs-varid'>body_code</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInfoDown</span>
<a name="line-4"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>us</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUniqSupply</span>
<a name="line-5"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>state</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getState</span>
<a name="line-6"></a>   	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span>	<span class='hs-varid'>body_info_down</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>info</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cgd_eob</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initEobInfo</span> <span class='hs-layout'>}</span>
<a name="line-7"></a>		<span class='hs-layout'>(</span><span class='hs-conid'>()</span><span class='hs-layout'>,</span><span class='hs-varid'>fork_state</span><span class='hs-layout'>)</span>	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>doFCode</span> <span class='hs-varid'>body_code</span> <span class='hs-varid'>body_info_down</span> 
<a name="line-8"></a>					  <span class='hs-layout'>(</span><span class='hs-varid'>initCgState</span> <span class='hs-varid'>us</span><span class='hs-layout'>)</span>
<a name="line-9"></a>	<span class='hs-layout'>;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isNilOL</span> <span class='hs-layout'>(</span><span class='hs-varid'>cgs_stmts</span> <span class='hs-varid'>fork_state</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-10"></a>	  <span class='hs-varid'>setState</span> <span class='hs-varop'>$</span> <span class='hs-varid'>state</span> <span class='hs-varop'>`addCodeBlocksFrom`</span> <span class='hs-varid'>fork_state</span> <span class='hs-layout'>}</span>
<a name="line-11"></a>	
<a name="line-12"></a><a name="forkStatics"></a><span class='hs-definition'>forkStatics</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FCode</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-varid'>a</span>
<a name="line-13"></a><span class='hs-definition'>forkStatics</span> <span class='hs-varid'>body_code</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>info</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInfoDown</span>
<a name="line-15"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>us</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUniqSupply</span>
<a name="line-16"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>state</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getState</span>
<a name="line-17"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span>	<span class='hs-varid'>rhs_info_down</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>info</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cgd_statics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cgs_binds</span> <span class='hs-varid'>state</span><span class='hs-layout'>,</span>
<a name="line-18"></a>				       <span class='hs-varid'>cgd_eob</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initEobInfo</span> <span class='hs-layout'>}</span>
<a name="line-19"></a>		<span class='hs-layout'>(</span><span class='hs-varid'>result</span><span class='hs-layout'>,</span> <span class='hs-varid'>fork_state_out</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>doFCode</span> <span class='hs-varid'>body_code</span> <span class='hs-varid'>rhs_info_down</span> 
<a name="line-20"></a>						   <span class='hs-layout'>(</span><span class='hs-varid'>initCgState</span> <span class='hs-varid'>us</span><span class='hs-layout'>)</span>
<a name="line-21"></a>	<span class='hs-layout'>;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isNilOL</span> <span class='hs-layout'>(</span><span class='hs-varid'>cgs_stmts</span> <span class='hs-varid'>fork_state_out</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-22"></a>	  <span class='hs-varid'>setState</span> <span class='hs-layout'>(</span><span class='hs-varid'>state</span> <span class='hs-varop'>`addCodeBlocksFrom`</span> <span class='hs-varid'>fork_state_out</span><span class='hs-layout'>)</span>
<a name="line-23"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>result</span> <span class='hs-layout'>}</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="forkProc"></a><span class='hs-definition'>forkProc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Code</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>CgStmts</span>
<a name="line-26"></a><span class='hs-definition'>forkProc</span> <span class='hs-varid'>body_code</span>
<a name="line-27"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>info_down</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInfoDown</span>
<a name="line-28"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>us</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUniqSupply</span>
<a name="line-29"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>state</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getState</span>
<a name="line-30"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span>	<span class='hs-varid'>fork_state_in</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>initCgState</span> <span class='hs-varid'>us</span><span class='hs-layout'>)</span> 
<a name="line-31"></a>					<span class='hs-layout'>{</span> <span class='hs-varid'>cgs_binds</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cgs_binds</span> <span class='hs-varid'>state</span><span class='hs-layout'>,</span>
<a name="line-32"></a>					  <span class='hs-varid'>cgs_stk_usg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cgs_stk_usg</span> <span class='hs-varid'>state</span><span class='hs-layout'>,</span>
<a name="line-33"></a>					  <span class='hs-varid'>cgs_hp_usg</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cgs_hp_usg</span> <span class='hs-varid'>state</span> <span class='hs-layout'>}</span>
<a name="line-34"></a>			<span class='hs-comment'>-- ToDo: is the hp usage necesary?</span>
<a name="line-35"></a>		<span class='hs-layout'>(</span><span class='hs-varid'>code_blks</span><span class='hs-layout'>,</span> <span class='hs-varid'>fork_state_out</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>doFCode</span> <span class='hs-layout'>(</span><span class='hs-varid'>getCgStmts</span> <span class='hs-varid'>body_code</span><span class='hs-layout'>)</span> 
<a name="line-36"></a>						      <span class='hs-varid'>info_down</span> <span class='hs-varid'>fork_state_in</span>
<a name="line-37"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>setState</span> <span class='hs-varop'>$</span> <span class='hs-varid'>state</span> <span class='hs-varop'>`stateIncUsageEval`</span> <span class='hs-varid'>fork_state_out</span>
<a name="line-38"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>code_blks</span> <span class='hs-layout'>}</span>
<a name="line-39"></a>
<a name="line-40"></a><a name="codeOnly"></a><span class='hs-definition'>codeOnly</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Code</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-41"></a><span class='hs-comment'>-- Emit any code from the inner thing into the outer thing</span>
<a name="line-42"></a><span class='hs-comment'>-- Do not affect anything else in the outer state</span>
<a name="line-43"></a><span class='hs-comment'>-- Used in almost-circular code to prevent false loop dependencies</span>
<a name="line-44"></a><span class='hs-definition'>codeOnly</span> <span class='hs-varid'>body_code</span>
<a name="line-45"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>info_down</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInfoDown</span>
<a name="line-46"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>us</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUniqSupply</span>
<a name="line-47"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>state</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getState</span>
<a name="line-48"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span>	<span class='hs-varid'>fork_state_in</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>initCgState</span> <span class='hs-varid'>us</span><span class='hs-layout'>)</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cgs_binds</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cgs_binds</span> <span class='hs-varid'>state</span><span class='hs-layout'>,</span>
<a name="line-49"></a>					           <span class='hs-varid'>cgs_stk_usg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cgs_stk_usg</span> <span class='hs-varid'>state</span><span class='hs-layout'>,</span>
<a name="line-50"></a>					           <span class='hs-varid'>cgs_hp_usg</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cgs_hp_usg</span> <span class='hs-varid'>state</span> <span class='hs-layout'>}</span>
<a name="line-51"></a>		<span class='hs-layout'>(</span><span class='hs-conid'>()</span><span class='hs-layout'>,</span> <span class='hs-varid'>fork_state_out</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>doFCode</span> <span class='hs-varid'>body_code</span> <span class='hs-varid'>info_down</span> <span class='hs-varid'>fork_state_in</span>
<a name="line-52"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>setState</span> <span class='hs-varop'>$</span> <span class='hs-varid'>state</span> <span class='hs-varop'>`addCodeBlocksFrom`</span> <span class='hs-varid'>fork_state_out</span> <span class='hs-layout'>}</span>
</pre>\end{code}

@forkAlts@ $bs~d$ takes fcodes $bs$ for the branches of a @case@, and
an fcode for the default case $d$, and compiles each in the current
environment.  The current environment is passed on unmodified, except
that
	- the worst stack high-water mark is incorporated
	- the virtual Hp is moved on to the worst virtual Hp for the branches

\begin{code}
<pre><a name="line-1"></a><a name="forkAlts"></a><span class='hs-definition'>forkAlts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FCode</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-definition'>forkAlts</span> <span class='hs-varid'>branch_fcodes</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>info_down</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInfoDown</span>
<a name="line-5"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>us</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUniqSupply</span>
<a name="line-6"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>state</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getState</span>
<a name="line-7"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>compile</span> <span class='hs-varid'>us</span> <span class='hs-varid'>branch</span> 
<a name="line-8"></a>		<span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>us2</span><span class='hs-layout'>,</span> <span class='hs-varid'>doFCode</span> <span class='hs-varid'>branch</span> <span class='hs-varid'>info_down</span> <span class='hs-varid'>branch_state</span><span class='hs-layout'>)</span>
<a name="line-9"></a>		<span class='hs-keyword'>where</span>
<a name="line-10"></a>		  <span class='hs-layout'>(</span><span class='hs-varid'>us1</span><span class='hs-layout'>,</span><span class='hs-varid'>us2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitUniqSupply</span> <span class='hs-varid'>us</span>
<a name="line-11"></a>	          <span class='hs-varid'>branch_state</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>initCgState</span> <span class='hs-varid'>us1</span><span class='hs-layout'>)</span> <span class='hs-layout'>{</span>
<a name="line-12"></a>					<span class='hs-varid'>cgs_binds</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cgs_binds</span> <span class='hs-varid'>state</span><span class='hs-layout'>,</span>
<a name="line-13"></a>					<span class='hs-varid'>cgs_stk_usg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cgs_stk_usg</span> <span class='hs-varid'>state</span><span class='hs-layout'>,</span>
<a name="line-14"></a>					<span class='hs-varid'>cgs_hp_usg</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cgs_hp_usg</span> <span class='hs-varid'>state</span> <span class='hs-layout'>}</span>
<a name="line-15"></a>
<a name="line-16"></a>	      <span class='hs-layout'>(</span><span class='hs-sel'>_us</span><span class='hs-layout'>,</span> <span class='hs-varid'>results</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>compile</span> <span class='hs-varid'>us</span> <span class='hs-varid'>branch_fcodes</span>
<a name="line-17"></a>	      <span class='hs-layout'>(</span><span class='hs-varid'>branch_results</span><span class='hs-layout'>,</span> <span class='hs-varid'>branch_out_states</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip</span> <span class='hs-varid'>results</span>
<a name="line-18"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>setState</span> <span class='hs-varop'>$</span> <span class='hs-varid'>foldl</span> <span class='hs-varid'>stateIncUsage</span> <span class='hs-varid'>state</span> <span class='hs-varid'>branch_out_states</span>
<a name="line-19"></a>		<span class='hs-comment'>-- NB foldl.  state is the *left* argument to stateIncUsage</span>
<a name="line-20"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>branch_results</span> <span class='hs-layout'>}</span>
</pre>\end{code}

@forkEval@ takes two blocks of code.

   -  The first meddles with the environment to set it up as expected by
      the alternatives of a @case@ which does an eval (or gc-possible primop).
   -  The second block is the code for the alternatives.
      (plus info for semi-tagging purposes)

@forkEval@ picks up the virtual stack pointer and returns a suitable
@EndOfBlockInfo@ for the caller to use, together with whatever value
is returned by the second block.

It uses @initEnvForAlternatives@ to initialise the environment, and
@stateIncUsageAlt@ to incorporate usage; the latter ignores the heap
usage.

\begin{code}
<pre><a name="line-1"></a><a name="forkEval"></a><span class='hs-definition'>forkEval</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EndOfBlockInfo</span>              <span class='hs-comment'>-- For the body</span>
<a name="line-2"></a>    	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>			<span class='hs-comment'>-- Code to set environment</span>
<a name="line-3"></a>	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>Sequel</span>		<span class='hs-comment'>-- Semi-tagging info to store</span>
<a name="line-4"></a>	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>EndOfBlockInfo</span>	<span class='hs-comment'>-- The new end of block info</span>
<a name="line-5"></a>
<a name="line-6"></a><span class='hs-definition'>forkEval</span> <span class='hs-varid'>body_eob_info</span> <span class='hs-varid'>env_code</span> <span class='hs-varid'>body_code</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-varid'>sequel</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>forkEvalHelp</span> <span class='hs-varid'>body_eob_info</span> <span class='hs-varid'>env_code</span> <span class='hs-varid'>body_code</span>
<a name="line-8"></a> 	<span class='hs-layout'>;</span> <span class='hs-varid'>returnFC</span> <span class='hs-layout'>(</span><span class='hs-conid'>EndOfBlockInfo</span> <span class='hs-varid'>v</span> <span class='hs-varid'>sequel</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="forkEvalHelp"></a><span class='hs-definition'>forkEvalHelp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EndOfBlockInfo</span>  <span class='hs-comment'>-- For the body</span>
<a name="line-11"></a>    	     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>		<span class='hs-comment'>-- Code to set environment</span>
<a name="line-12"></a>	     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-varid'>a</span>		<span class='hs-comment'>-- The code to do after the eval</span>
<a name="line-13"></a>	     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-layout'>(</span><span class='hs-conid'>VirtualSpOffset</span><span class='hs-layout'>,</span>	<span class='hs-comment'>-- Sp</span>
<a name="line-14"></a>		       <span class='hs-varid'>a</span><span class='hs-layout'>)</span>		<span class='hs-comment'>-- Result of the FCode</span>
<a name="line-15"></a>	<span class='hs-comment'>-- A disturbingly complicated function</span>
<a name="line-16"></a><span class='hs-definition'>forkEvalHelp</span> <span class='hs-varid'>body_eob_info</span> <span class='hs-varid'>env_code</span> <span class='hs-varid'>body_code</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>info_down</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInfoDown</span>
<a name="line-18"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>us</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUniqSupply</span>
<a name="line-19"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>state</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getState</span>
<a name="line-20"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>info_down_for_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>info_down</span> <span class='hs-layout'>{</span><span class='hs-varid'>cgd_eob</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>body_eob_info</span><span class='hs-layout'>}</span>
<a name="line-21"></a>	      <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>env_state</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>doFCode</span> <span class='hs-varid'>env_code</span> <span class='hs-varid'>info_down_for_body</span> 
<a name="line-22"></a>					 <span class='hs-layout'>(</span><span class='hs-varid'>state</span> <span class='hs-layout'>{</span><span class='hs-varid'>cgs_uniqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>us</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-23"></a>	      <span class='hs-layout'>;</span> <span class='hs-varid'>state_for_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>initCgState</span> <span class='hs-layout'>(</span><span class='hs-varid'>cgs_uniqs</span> <span class='hs-varid'>env_state</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-24"></a>					<span class='hs-layout'>{</span> <span class='hs-varid'>cgs_binds</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binds_for_body</span><span class='hs-layout'>,</span>
<a name="line-25"></a>	      				  <span class='hs-varid'>cgs_stk_usg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stk_usg_for_body</span> <span class='hs-layout'>}</span>
<a name="line-26"></a>	      <span class='hs-layout'>;</span> <span class='hs-varid'>binds_for_body</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nukeVolatileBinds</span> <span class='hs-layout'>(</span><span class='hs-varid'>cgs_binds</span> <span class='hs-varid'>env_state</span><span class='hs-layout'>)</span>
<a name="line-27"></a>	      <span class='hs-layout'>;</span> <span class='hs-varid'>stk_usg_from_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cgs_stk_usg</span> <span class='hs-varid'>env_state</span>
<a name="line-28"></a>	      <span class='hs-layout'>;</span> <span class='hs-varid'>virtSp_from_env</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>virtSp</span> <span class='hs-varid'>stk_usg_from_env</span>
<a name="line-29"></a>	      <span class='hs-layout'>;</span> <span class='hs-varid'>stk_usg_for_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stk_usg_from_env</span> <span class='hs-layout'>{</span><span class='hs-varid'>realSp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>virtSp_from_env</span><span class='hs-layout'>,</span>
<a name="line-30"></a>	      					     <span class='hs-varid'>hwSp</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>virtSp_from_env</span><span class='hs-layout'>}</span>
<a name="line-31"></a>	      <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>value_returned</span><span class='hs-layout'>,</span> <span class='hs-varid'>state_at_end_return</span><span class='hs-layout'>)</span>
<a name="line-32"></a>	        	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>doFCode</span> <span class='hs-varid'>body_code</span> <span class='hs-varid'>info_down_for_body</span> <span class='hs-varid'>state_for_body</span>		
<a name="line-33"></a>	  <span class='hs-layout'>}</span> 
<a name="line-34"></a>	<span class='hs-layout'>;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isNilOL</span> <span class='hs-layout'>(</span><span class='hs-varid'>cgs_stmts</span> <span class='hs-varid'>state_at_end_return</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-35"></a>		 <span class='hs-comment'>-- The code coming back should consist only of nested declarations,</span>
<a name="line-36"></a>		 <span class='hs-comment'>-- notably of the return vector!</span>
<a name="line-37"></a>	  <span class='hs-varid'>setState</span> <span class='hs-varop'>$</span> <span class='hs-varid'>state</span> <span class='hs-varop'>`stateIncUsageEval`</span> <span class='hs-varid'>state_at_end_return</span>
<a name="line-38"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>virtSp_from_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>value_returned</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-39"></a>
<a name="line-40"></a>
<a name="line-41"></a><span class='hs-comment'>-- ----------------------------------------------------------------------------</span>
<a name="line-42"></a><span class='hs-comment'>-- Combinators for emitting code</span>
<a name="line-43"></a>
<a name="line-44"></a><a name="nopC"></a><span class='hs-definition'>nopC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Code</span>
<a name="line-45"></a><span class='hs-definition'>nopC</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-46"></a>
<a name="line-47"></a><a name="whenC"></a><span class='hs-definition'>whenC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-48"></a><span class='hs-definition'>whenC</span> <span class='hs-conid'>True</span>  <span class='hs-varid'>code</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>code</span>
<a name="line-49"></a><span class='hs-definition'>whenC</span> <span class='hs-conid'>False</span> <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nopC</span>
<a name="line-50"></a>
<a name="line-51"></a><a name="stmtC"></a><span class='hs-comment'>-- Corresponds to 'emit' in new code generator with a smart constructor</span>
<a name="line-52"></a><span class='hs-comment'>-- from cmm/MkGraph.hs</span>
<a name="line-53"></a><span class='hs-definition'>stmtC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmStmt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-54"></a><span class='hs-definition'>stmtC</span> <span class='hs-varid'>stmt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emitCgStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>CgStmt</span> <span class='hs-varid'>stmt</span><span class='hs-layout'>)</span>
<a name="line-55"></a>
<a name="line-56"></a><a name="labelC"></a><span class='hs-definition'>labelC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BlockId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-57"></a><span class='hs-definition'>labelC</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emitCgStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>CgLabel</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-58"></a>
<a name="line-59"></a><a name="newLabelC"></a><span class='hs-definition'>newLabelC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>BlockId</span>
<a name="line-60"></a><span class='hs-definition'>newLabelC</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>u</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUnique</span>
<a name="line-61"></a>               <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkBlockId</span> <span class='hs-varid'>u</span> <span class='hs-layout'>}</span>
<a name="line-62"></a>
<a name="line-63"></a><a name="checkedAbsC"></a><span class='hs-definition'>checkedAbsC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmStmt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-64"></a><span class='hs-comment'>-- Emit code, eliminating no-ops</span>
<a name="line-65"></a><span class='hs-definition'>checkedAbsC</span> <span class='hs-varid'>stmt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emitStmts</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>isNopStmt</span> <span class='hs-varid'>stmt</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>nilOL</span>
<a name="line-66"></a>	 		      <span class='hs-keyword'>else</span> <span class='hs-varid'>unitOL</span> <span class='hs-varid'>stmt</span><span class='hs-layout'>)</span>
<a name="line-67"></a>
<a name="line-68"></a><a name="stmtsC"></a><span class='hs-definition'>stmtsC</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmStmt</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-69"></a><span class='hs-definition'>stmtsC</span> <span class='hs-varid'>stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emitStmts</span> <span class='hs-layout'>(</span><span class='hs-varid'>toOL</span> <span class='hs-varid'>stmts</span><span class='hs-layout'>)</span>
<a name="line-70"></a>
<a name="line-71"></a><a name="emitStmts"></a><span class='hs-comment'>-- Emit code; no no-op checking</span>
<a name="line-72"></a><span class='hs-definition'>emitStmts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmStmts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-73"></a><span class='hs-definition'>emitStmts</span> <span class='hs-varid'>stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emitCgStmts</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-conid'>CgStmt</span> <span class='hs-varid'>stmts</span><span class='hs-layout'>)</span>
<a name="line-74"></a>
<a name="line-75"></a><a name="forkLabelledCode"></a><span class='hs-comment'>-- forkLabelledCode is for emitting a chunk of code with a label, outside</span>
<a name="line-76"></a><span class='hs-comment'>-- of the current instruction stream.</span>
<a name="line-77"></a><span class='hs-definition'>forkLabelledCode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Code</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>BlockId</span>
<a name="line-78"></a><span class='hs-definition'>forkLabelledCode</span> <span class='hs-varid'>code</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getCgStmts</span> <span class='hs-varid'>code</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>forkCgStmts</span>
<a name="line-79"></a>
<a name="line-80"></a><a name="emitCgStmt"></a><span class='hs-definition'>emitCgStmt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CgStmt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-81"></a><span class='hs-definition'>emitCgStmt</span> <span class='hs-varid'>stmt</span>
<a name="line-82"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>state</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getState</span>
<a name="line-83"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>setState</span> <span class='hs-varop'>$</span> <span class='hs-varid'>state</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cgs_stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cgs_stmts</span> <span class='hs-varid'>state</span> <span class='hs-varop'>`snocOL`</span> <span class='hs-varid'>stmt</span> <span class='hs-layout'>}</span>
<a name="line-84"></a>	<span class='hs-layout'>}</span>
<a name="line-85"></a>
<a name="line-86"></a><a name="emitDecl"></a><span class='hs-definition'>emitDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmDecl</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-87"></a><span class='hs-definition'>emitDecl</span> <span class='hs-varid'>decl</span>
<a name="line-88"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 	<span class='hs-layout'>{</span> <span class='hs-varid'>state</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getState</span>
<a name="line-89"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>setState</span> <span class='hs-varop'>$</span> <span class='hs-varid'>state</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cgs_tops</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cgs_tops</span> <span class='hs-varid'>state</span> <span class='hs-varop'>`snocOL`</span> <span class='hs-varid'>decl</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-90"></a>
<a name="line-91"></a><a name="emitProc"></a><span class='hs-definition'>emitProc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CLabel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmFormal</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmBasicBlock</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-92"></a><span class='hs-definition'>emitProc</span> <span class='hs-varid'>info</span> <span class='hs-varid'>lbl</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>blocks</span>
<a name="line-93"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>proc_block</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmProc</span> <span class='hs-varid'>info</span> <span class='hs-varid'>lbl</span> <span class='hs-layout'>(</span><span class='hs-conid'>ListGraph</span> <span class='hs-varid'>blocks</span><span class='hs-layout'>)</span>
<a name="line-94"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>state</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getState</span>
<a name="line-95"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>setState</span> <span class='hs-varop'>$</span> <span class='hs-varid'>state</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cgs_tops</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cgs_tops</span> <span class='hs-varid'>state</span> <span class='hs-varop'>`snocOL`</span> <span class='hs-varid'>proc_block</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-96"></a><span class='hs-definition'>emitProc</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"emitProc called with nonempty args"</span>
<a name="line-97"></a>
<a name="line-98"></a><a name="emitSimpleProc"></a><span class='hs-definition'>emitSimpleProc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CLabel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-99"></a><span class='hs-comment'>-- Emit a procedure whose body is the specified code; no info table</span>
<a name="line-100"></a><span class='hs-definition'>emitSimpleProc</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>code</span>
<a name="line-101"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>stmts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCgStmts</span> <span class='hs-varid'>code</span>
<a name="line-102"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>blks</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cgStmtsToBlocks</span> <span class='hs-varid'>stmts</span>
<a name="line-103"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>emitProc</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmInfo</span> <span class='hs-conid'>Nothing</span> <span class='hs-conid'>Nothing</span> <span class='hs-conid'>CmmNonInfoTable</span><span class='hs-layout'>)</span> <span class='hs-varid'>lbl</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>blks</span> <span class='hs-layout'>}</span>
<a name="line-104"></a>
<a name="line-105"></a><a name="getCmm"></a><span class='hs-definition'>getCmm</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Code</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>CmmGroup</span>
<a name="line-106"></a><span class='hs-comment'>-- Get all the CmmTops (there should be no stmts)</span>
<a name="line-107"></a><span class='hs-comment'>-- Return a single Cmm which may be split from other Cmms by</span>
<a name="line-108"></a><span class='hs-comment'>-- object splitting (at a later stage)</span>
<a name="line-109"></a><span class='hs-definition'>getCmm</span> <span class='hs-varid'>code</span> 
<a name="line-110"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>state1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getState</span>
<a name="line-111"></a>	<span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-conid'>()</span><span class='hs-layout'>,</span> <span class='hs-varid'>state2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>withState</span> <span class='hs-varid'>code</span> <span class='hs-layout'>(</span><span class='hs-varid'>state1</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cgs_tops</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nilOL</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-112"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>setState</span> <span class='hs-varop'>$</span> <span class='hs-varid'>state2</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cgs_tops</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cgs_tops</span> <span class='hs-varid'>state1</span> <span class='hs-layout'>}</span> 
<a name="line-113"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromOL</span> <span class='hs-layout'>(</span><span class='hs-varid'>cgs_tops</span> <span class='hs-varid'>state2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-114"></a>        <span class='hs-layout'>}</span>
<a name="line-115"></a>
<a name="line-116"></a><span class='hs-comment'>-- ----------------------------------------------------------------------------</span>
<a name="line-117"></a><span class='hs-comment'>-- CgStmts</span>
<a name="line-118"></a>
<a name="line-119"></a><span class='hs-comment'>-- These functions deal in terms of CgStmts, which is an abstract type</span>
<a name="line-120"></a><span class='hs-comment'>-- representing the code in the current proc.</span>
<a name="line-121"></a>
<a name="line-122"></a>
<a name="line-123"></a><a name="emitCgStmts"></a><span class='hs-comment'>-- emit CgStmts into the current instruction stream</span>
<a name="line-124"></a><span class='hs-definition'>emitCgStmts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CgStmts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-125"></a><span class='hs-definition'>emitCgStmts</span> <span class='hs-varid'>stmts</span>
<a name="line-126"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>state</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getState</span>
<a name="line-127"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>setState</span> <span class='hs-varop'>$</span> <span class='hs-varid'>state</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cgs_stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cgs_stmts</span> <span class='hs-varid'>state</span> <span class='hs-varop'>`appOL`</span> <span class='hs-varid'>stmts</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-128"></a>
<a name="line-129"></a><a name="forkCgStmts"></a><span class='hs-comment'>-- emit CgStmts outside the current instruction stream, and return a label</span>
<a name="line-130"></a><span class='hs-definition'>forkCgStmts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CgStmts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>BlockId</span>
<a name="line-131"></a><span class='hs-definition'>forkCgStmts</span> <span class='hs-varid'>stmts</span>
<a name="line-132"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newLabelC</span>
<a name="line-133"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>emitCgStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>CgFork</span> <span class='hs-varid'>id</span> <span class='hs-varid'>stmts</span><span class='hs-layout'>)</span>
<a name="line-134"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>id</span>
<a name="line-135"></a>	<span class='hs-layout'>}</span>
<a name="line-136"></a>
<a name="line-137"></a><a name="cgStmtsToBlocks"></a><span class='hs-comment'>-- turn CgStmts into [CmmBasicBlock], for making a new proc.</span>
<a name="line-138"></a><span class='hs-definition'>cgStmtsToBlocks</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CgStmts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmBasicBlock</span><span class='hs-keyglyph'>]</span>
<a name="line-139"></a><span class='hs-definition'>cgStmtsToBlocks</span> <span class='hs-varid'>stmts</span>
<a name="line-140"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newLabelC</span>
<a name="line-141"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>flattenCgStmts</span> <span class='hs-varid'>id</span> <span class='hs-varid'>stmts</span><span class='hs-layout'>)</span>
<a name="line-142"></a>	<span class='hs-layout'>}</span>	
<a name="line-143"></a>
<a name="line-144"></a><a name="getCgStmts'"></a><span class='hs-comment'>-- collect the code emitted by an FCode computation</span>
<a name="line-145"></a><span class='hs-definition'>getCgStmts'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FCode</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>CgStmts</span><span class='hs-layout'>)</span>
<a name="line-146"></a><span class='hs-definition'>getCgStmts'</span> <span class='hs-varid'>fcode</span>
<a name="line-147"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>state1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getState</span>
<a name="line-148"></a>	<span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>state2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>withState</span> <span class='hs-varid'>fcode</span> <span class='hs-layout'>(</span><span class='hs-varid'>state1</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cgs_stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nilOL</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-149"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>setState</span> <span class='hs-varop'>$</span> <span class='hs-varid'>state2</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cgs_stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cgs_stmts</span> <span class='hs-varid'>state1</span>  <span class='hs-layout'>}</span>
<a name="line-150"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>cgs_stmts</span> <span class='hs-varid'>state2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-151"></a>
<a name="line-152"></a><a name="getCgStmts"></a><span class='hs-definition'>getCgStmts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FCode</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>CgStmts</span>
<a name="line-153"></a><span class='hs-definition'>getCgStmts</span> <span class='hs-varid'>fcode</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>stmts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCgStmts'</span> <span class='hs-varid'>fcode</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>stmts</span> <span class='hs-layout'>}</span>
<a name="line-154"></a>
<a name="line-155"></a><a name="noCgStmts"></a><span class='hs-comment'>-- Simple ways to construct CgStmts:</span>
<a name="line-156"></a><span class='hs-definition'>noCgStmts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CgStmts</span>
<a name="line-157"></a><span class='hs-definition'>noCgStmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nilOL</span>
<a name="line-158"></a>
<a name="line-159"></a><a name="oneCgStmt"></a><span class='hs-definition'>oneCgStmt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmStmt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CgStmts</span>
<a name="line-160"></a><span class='hs-definition'>oneCgStmt</span> <span class='hs-varid'>stmt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitOL</span> <span class='hs-layout'>(</span><span class='hs-conid'>CgStmt</span> <span class='hs-varid'>stmt</span><span class='hs-layout'>)</span>
<a name="line-161"></a>
<a name="line-162"></a><a name="consCgStmt"></a><span class='hs-definition'>consCgStmt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmStmt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CgStmts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CgStmts</span>
<a name="line-163"></a><span class='hs-definition'>consCgStmt</span> <span class='hs-varid'>stmt</span> <span class='hs-varid'>stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CgStmt</span> <span class='hs-varid'>stmt</span> <span class='hs-varop'>`consOL`</span> <span class='hs-varid'>stmts</span>
<a name="line-164"></a>
<a name="line-165"></a><span class='hs-comment'>-- ----------------------------------------------------------------------------</span>
<a name="line-166"></a><span class='hs-comment'>-- Get the current module name</span>
<a name="line-167"></a>
<a name="line-168"></a><a name="getModuleName"></a><span class='hs-definition'>getModuleName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>Module</span>
<a name="line-169"></a><span class='hs-definition'>getModuleName</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInfoDown</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>cgd_mod</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-170"></a>
<a name="line-171"></a><span class='hs-comment'>-- ----------------------------------------------------------------------------</span>
<a name="line-172"></a><span class='hs-comment'>-- Get/set the end-of-block info</span>
<a name="line-173"></a>
<a name="line-174"></a><a name="setEndOfBlockInfo"></a><span class='hs-definition'>setEndOfBlockInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EndOfBlockInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-175"></a><span class='hs-definition'>setEndOfBlockInfo</span> <span class='hs-varid'>eob_info</span> <span class='hs-varid'>code</span>	<span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-176"></a>	<span class='hs-varid'>info</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInfoDown</span>
<a name="line-177"></a>	<span class='hs-varid'>withInfoDown</span> <span class='hs-varid'>code</span> <span class='hs-layout'>(</span><span class='hs-varid'>info</span> <span class='hs-layout'>{</span><span class='hs-varid'>cgd_eob</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eob_info</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-178"></a>
<a name="line-179"></a><a name="getEndOfBlockInfo"></a><span class='hs-definition'>getEndOfBlockInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>EndOfBlockInfo</span>
<a name="line-180"></a><span class='hs-definition'>getEndOfBlockInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-181"></a>	<span class='hs-varid'>info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInfoDown</span>
<a name="line-182"></a>	<span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>cgd_eob</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span>
<a name="line-183"></a>
<a name="line-184"></a><span class='hs-comment'>-- ----------------------------------------------------------------------------</span>
<a name="line-185"></a><span class='hs-comment'>-- Get/set the current SRT label</span>
<a name="line-186"></a>
<a name="line-187"></a><span class='hs-comment'>-- There is just one SRT for each top level binding; all the nested</span>
<a name="line-188"></a><span class='hs-comment'>-- bindings use sub-sections of this SRT.  The label is passed down to</span>
<a name="line-189"></a><span class='hs-comment'>-- the nested bindings via the monad.</span>
<a name="line-190"></a>
<a name="line-191"></a><a name="getSRTLabel"></a><span class='hs-definition'>getSRTLabel</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>CLabel</span>	<span class='hs-comment'>-- Used only by cgPanic</span>
<a name="line-192"></a><span class='hs-definition'>getSRTLabel</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>info</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInfoDown</span>
<a name="line-193"></a>		 <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>cgd_srt_lbl</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span>
<a name="line-194"></a>
<a name="line-195"></a><a name="setSRTLabel"></a><span class='hs-definition'>setSRTLabel</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CLabel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-varid'>a</span>
<a name="line-196"></a><span class='hs-definition'>setSRTLabel</span> <span class='hs-varid'>srt_lbl</span> <span class='hs-varid'>code</span>
<a name="line-197"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-varid'>info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInfoDown</span>
<a name="line-198"></a>	<span class='hs-varid'>withInfoDown</span> <span class='hs-varid'>code</span> <span class='hs-layout'>(</span><span class='hs-varid'>info</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cgd_srt_lbl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>srt_lbl</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-199"></a>
<a name="line-200"></a><a name="getSRT"></a><span class='hs-definition'>getSRT</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>SRT</span>
<a name="line-201"></a><span class='hs-definition'>getSRT</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInfoDown</span>
<a name="line-202"></a>            <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>cgd_srt</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span>
<a name="line-203"></a>
<a name="line-204"></a><a name="setSRT"></a><span class='hs-definition'>setSRT</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SRT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-varid'>a</span>
<a name="line-205"></a><span class='hs-definition'>setSRT</span> <span class='hs-varid'>srt</span> <span class='hs-varid'>code</span>
<a name="line-206"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInfoDown</span>
<a name="line-207"></a>       <span class='hs-varid'>withInfoDown</span> <span class='hs-varid'>code</span> <span class='hs-layout'>(</span><span class='hs-varid'>info</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cgd_srt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>srt</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-208"></a>
<a name="line-209"></a><span class='hs-comment'>-- ----------------------------------------------------------------------------</span>
<a name="line-210"></a><span class='hs-comment'>-- Get/set the current ticky counter label</span>
<a name="line-211"></a>
<a name="line-212"></a><a name="getTickyCtrLabel"></a><span class='hs-definition'>getTickyCtrLabel</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>CLabel</span>
<a name="line-213"></a><span class='hs-definition'>getTickyCtrLabel</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-214"></a>	<span class='hs-varid'>info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInfoDown</span>
<a name="line-215"></a>	<span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>cgd_ticky</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span>
<a name="line-216"></a>
<a name="line-217"></a><a name="setTickyCtrLabel"></a><span class='hs-definition'>setTickyCtrLabel</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CLabel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-218"></a><span class='hs-definition'>setTickyCtrLabel</span> <span class='hs-varid'>ticky</span> <span class='hs-varid'>code</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-219"></a>	<span class='hs-varid'>info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInfoDown</span>
<a name="line-220"></a>	<span class='hs-varid'>withInfoDown</span> <span class='hs-varid'>code</span> <span class='hs-layout'>(</span><span class='hs-varid'>info</span> <span class='hs-layout'>{</span><span class='hs-varid'>cgd_ticky</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ticky</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
</pre>\end{code}
</body>
</html>
