<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>typecheck/TcCanonical.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcCanonical</span><span class='hs-layout'>(</span>
<a name="line-9"></a>    <span class='hs-varid'>canonicalize</span><span class='hs-layout'>,</span>
<a name="line-10"></a>    <span class='hs-varid'>canOccursCheck</span><span class='hs-layout'>,</span> <span class='hs-varid'>canEq</span><span class='hs-layout'>,</span> <span class='hs-varid'>canEvVar</span><span class='hs-layout'>,</span>
<a name="line-11"></a>    <span class='hs-varid'>rewriteWithFunDeps</span><span class='hs-layout'>,</span>
<a name="line-12"></a>    <span class='hs-varid'>emitFDWorkAsWanted</span><span class='hs-layout'>,</span> <span class='hs-varid'>emitFDWorkAsDerived</span><span class='hs-layout'>,</span>
<a name="line-13"></a>    <span class='hs-conid'>StopOrContinue</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-14"></a> <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-15"></a>
<a name="line-16"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span> <span class='hs-layout'>(</span> <span class='hs-conid'>IPName</span> <span class='hs-layout'>)</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcErrors</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnTypes</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FunDeps</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>TcMType</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TcM</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Kind</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TypeRep</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>)</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>    <span class='hs-layout'>(</span> <span class='hs-varid'>when</span><span class='hs-layout'>,</span> <span class='hs-varid'>unless</span><span class='hs-layout'>,</span> <span class='hs-varid'>zipWithM</span><span class='hs-layout'>,</span> <span class='hs-varid'>foldM</span> <span class='hs-layout'>)</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MonadUtils</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Applicative</span> <span class='hs-layout'>(</span> <span class='hs-layout'>(</span><span class='hs-varop'>&lt;|&gt;</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-37"></a>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TrieMap</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcSMonad</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-42"></a>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span> <span class='hs-varid'>isNothing</span> <span class='hs-layout'>)</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Pair</span> <span class='hs-layout'>(</span> <span class='hs-varid'>pSnd</span> <span class='hs-layout'>)</span>
<a name="line-45"></a>
</pre>\end{code}


%************************************************************************
%*                                                                      *
%*                      The Canonicaliser                               *
%*                                                                      *
%************************************************************************

Note [Canonicalization]
~~~~~~~~~~~~~~~~~~~~~~~

Canonicalization converts a flat constraint to a canonical form. It is
unary (i.e. treats individual constraints one at a time), does not do
any zonking, but lives in TcS monad because it needs to create fresh
variables (for flattening) and consult the inerts (for efficiency).

The execution plan for canonicalization is the following:
 
  1) Decomposition of equalities happens as necessary until we reach a 
     variable or type family in one side. There is no decomposition step
     for other forms of constraints. 

  2) If, when we decompose, we discover a variable on the head then we 
     look at inert_eqs from the current inert for a substitution for this 
     variable and contine decomposing. Hence we lazily apply the inert 
     substitution if it is needed. 

  3) If no more decomposition is possible, we deeply apply the substitution
     from the inert_eqs and continue with flattening.

  4) During flattening, we examine whether we have already flattened some 
     function application by looking at all the CTyFunEqs with the same 
     function in the inert set. The reason for deeply applying the inert 
     substitution at step (3) is to maximise our chances of matching an 
     already flattened family application in the inert. 

The net result is that a constraint coming out of the canonicalization 
phase cannot be rewritten any further from the inerts (but maybe /it/ can 
rewrite an inert or still interact with an inert in a further phase in the
simplifier.

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><a name="StopOrContinue"></a><span class='hs-comment'>-- Informative results of canonicalization</span>
<a name="line-3"></a><a name="StopOrContinue"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>StopOrContinue</span> 
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ContinueWith</span> <span class='hs-conid'>Ct</span>   <span class='hs-comment'>-- Either no canonicalization happened, or if some did </span>
<a name="line-5"></a>                      <span class='hs-comment'>-- happen, it is still safe to just keep going with this </span>
<a name="line-6"></a>                      <span class='hs-comment'>-- work item. </span>
<a name="line-7"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Stop</span>              <span class='hs-comment'>-- Some canonicalization happened, extra work is now in </span>
<a name="line-8"></a>                      <span class='hs-comment'>-- the TcS WorkList. </span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>StopOrContinue</span> <span class='hs-keyword'>where</span>
<a name="line-11"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>Stop</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Stop"</span><span class='hs-layout'>)</span>
<a name="line-12"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ContinueWith</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"ContinueWith"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>w</span>
<a name="line-13"></a>
<a name="line-14"></a>
<a name="line-15"></a><a name="continueWith"></a><span class='hs-definition'>continueWith</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>StopOrContinue</span>
<a name="line-16"></a><span class='hs-definition'>continueWith</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-conid'>ContinueWith</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="andWhenContinue"></a><span class='hs-definition'>andWhenContinue</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>StopOrContinue</span> 
<a name="line-19"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>StopOrContinue</span><span class='hs-layout'>)</span> 
<a name="line-20"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>StopOrContinue</span>
<a name="line-21"></a><span class='hs-definition'>andWhenContinue</span> <span class='hs-varid'>tcs1</span> <span class='hs-varid'>tcs2</span>
<a name="line-22"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcs1</span>
<a name="line-23"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>r</span> <span class='hs-keyword'>of</span>
<a name="line-24"></a>           <span class='hs-conid'>Stop</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Stop</span>
<a name="line-25"></a>           <span class='hs-conid'>ContinueWith</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tcs2</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>}</span>
<a name="line-26"></a>
</pre>\end{code}

Note [Caching for canonicals]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
Our plan with pre-canonicalization is to be able to solve a constraint really fast from existing
bindings in TcEvBinds. So one may think that the condition (isCNonCanonical) is not necessary. 
However consider the following setup:

InertSet = { [W] d1 : Num t } 
WorkList = { [W] d2 : Num t, [W] c : t ~ Int} 

Now, we prioritize equalities, but in our concrete example (should_run/mc17.hs) the first (d2) constraint 
is dealt with first, because (t ~ Int) is an equality that only later appears in the worklist since it is
pulled out from a nested implication constraint. So, let's examine what happens:
 
   - We encounter work item (d2 : Num t)

   - Nothing is yet in EvBinds, so we reach the interaction with inerts 
     and set:
              d2 := d1 
    and we discard d2 from the worklist. The inert set remains unaffected.

   - Now the equation ([W] c : t ~ Int) is encountered and kicks-out (d1 : Num t) from the inerts.
     Then that equation gets spontaneously solved, perhaps. We end up with:
        InertSet : { [G] c : t ~ Int }
        WorkList : { [W] d1 : Num t} 

   - Now we examine (d1), we observe that there is a binding for (Num t) in the evidence binds and 
     we set: 
             d1 := d2 
     and end up in a loop!

Now, the constraints that get kicked out from the inert set are always Canonical, so by restricting
the use of the pre-canonicalizer to NonCanonical constraints we eliminate this danger. Moreover, for 
canonical constraints we already have good caching mechanisms (effectively the interaction solver) 
and we are interested in reducing things like superclasses of the same non-canonical constraint being 
generated hence I don't expect us to lose a lot by introducing the (isCNonCanonical) restriction.

A similar situation can arise in TcSimplify, at the end of the solve_wanteds function, where constraints
from the inert set are returned as new work -- our substCt ensures however that if they are not rewritten
by subst, they remain canonical and hence we will not attempt to solve them from the EvBinds. If on the 
other hand they did get rewritten and are now non-canonical they will still not match the EvBinds, so we 
are again good.



\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><span class='hs-comment'>-- Top-level canonicalization</span>
<a name="line-3"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="canonicalize"></a><span class='hs-definition'>canonicalize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>StopOrContinue</span>
<a name="line-6"></a><span class='hs-definition'>canonicalize</span> <span class='hs-varid'>ct</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CNonCanonical</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_flavor</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fl</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_depth</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"canonicalize (non-canonical)"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-8"></a>       <span class='hs-layout'>;</span> <span class='hs-comment'>{-# SCC "canEvVar" #-}</span>
<a name="line-9"></a>         <span class='hs-varid'>canEvVar</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>(</span><span class='hs-varid'>classifyPredType</span> <span class='hs-layout'>(</span><span class='hs-varid'>evVarPred</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-layout'>}</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-definition'>canonicalize</span> <span class='hs-layout'>(</span><span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_depth</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span>
<a name="line-12"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>cc_flavor</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fl</span>
<a name="line-13"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>cc_class</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls</span>
<a name="line-14"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xis</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>{-# SCC "canClass" #-}</span>
<a name="line-16"></a>    <span class='hs-varid'>canClass</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>xis</span> <span class='hs-comment'>-- Do not add any superclasses</span>
<a name="line-17"></a><span class='hs-definition'>canonicalize</span> <span class='hs-layout'>(</span><span class='hs-conid'>CTyEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_depth</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span>
<a name="line-18"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>cc_flavor</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fl</span>
<a name="line-19"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyvar</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv</span>
<a name="line-20"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>cc_rhs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xi</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-21"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>{-# SCC "canEqLeafTyVarLeftRec" #-}</span>
<a name="line-22"></a>    <span class='hs-varid'>canEqLeafTyVarLeftRec</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>xi</span>
<a name="line-23"></a>
<a name="line-24"></a><span class='hs-definition'>canonicalize</span> <span class='hs-layout'>(</span><span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_depth</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span>
<a name="line-25"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>cc_flavor</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fl</span>
<a name="line-26"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>cc_fun</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fn</span>
<a name="line-27"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xis1</span>
<a name="line-28"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>cc_rhs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xi2</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-29"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>{-# SCC "canEqLeafFunEqLeftRec" #-}</span>
<a name="line-30"></a>    <span class='hs-varid'>canEqLeafFunEqLeftRec</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>(</span><span class='hs-varid'>fn</span><span class='hs-layout'>,</span><span class='hs-varid'>xis1</span><span class='hs-layout'>)</span> <span class='hs-varid'>xi2</span>
<a name="line-31"></a>
<a name="line-32"></a><span class='hs-definition'>canonicalize</span> <span class='hs-layout'>(</span><span class='hs-conid'>CIPCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_depth</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span>
<a name="line-33"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>cc_flavor</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fl</span>
<a name="line-34"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>cc_ip_nm</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nm</span>
<a name="line-35"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>cc_ip_ty</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xi</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-36"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>canIP</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>xi</span>
<a name="line-37"></a><span class='hs-definition'>canonicalize</span> <span class='hs-layout'>(</span><span class='hs-conid'>CIrredEvCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_flavor</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fl</span>
<a name="line-38"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>cc_depth</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span>
<a name="line-39"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>cc_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xi</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-40"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>canIrred</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>xi</span>
<a name="line-41"></a>
<a name="line-42"></a>
<a name="line-43"></a><a name="canEvVar"></a><span class='hs-definition'>canEvVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredTree</span> 
<a name="line-44"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>StopOrContinue</span>
<a name="line-45"></a><span class='hs-definition'>canEvVar</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>pred_classifier</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> 
<a name="line-46"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>pred_classifier</span> <span class='hs-keyword'>of</span>
<a name="line-47"></a>      <span class='hs-conid'>ClassPred</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>canClass</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> 
<a name="line-48"></a>                                        <span class='hs-varop'>`andWhenContinue`</span> <span class='hs-varid'>emit_superclasses</span>
<a name="line-49"></a>      <span class='hs-conid'>EqPred</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>canEq</span>    <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-50"></a>      <span class='hs-conid'>IPPred</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>ty</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>canIP</span>    <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>ty</span>
<a name="line-51"></a>      <span class='hs-conid'>IrredPred</span> <span class='hs-varid'>ev_ty</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>canIrred</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>ev_ty</span>
<a name="line-52"></a>      <span class='hs-conid'>TuplePred</span> <span class='hs-varid'>tys</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>canTuple</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>tys</span>
<a name="line-53"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>emit_superclasses</span> <span class='hs-varid'>ct</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span><span class='hs-varid'>cc_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>v_new</span>
<a name="line-54"></a>                                       <span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xis_new</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_class</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-55"></a>            <span class='hs-comment'>-- Add superclasses of this one here, See Note [Adding superclasses]. </span>
<a name="line-56"></a>            <span class='hs-comment'>-- But only if we are not simplifying the LHS of a rule. </span>
<a name="line-57"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sctxt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSContext</span>
<a name="line-58"></a>               <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>simplEqsOnly</span> <span class='hs-varid'>sctxt</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> 
<a name="line-59"></a>                        <span class='hs-varid'>newSCWorkFromFlavored</span> <span class='hs-varid'>d</span> <span class='hs-varid'>v_new</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>xis_new</span>
<a name="line-60"></a>               <span class='hs-layout'>;</span> <span class='hs-varid'>continueWith</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>}</span>
<a name="line-61"></a>        <span class='hs-varid'>emit_superclasses</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"emit_superclasses of non-class!"</span>
<a name="line-62"></a>
<a name="line-63"></a>
<a name="line-64"></a><a name="canTuple"></a><span class='hs-comment'>-- Tuple canonicalisation</span>
<a name="line-65"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-66"></a><span class='hs-definition'>canTuple</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-comment'>-- Depth </span>
<a name="line-67"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PredType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>StopOrContinue</span>
<a name="line-68"></a><span class='hs-definition'>canTuple</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>tys</span>
<a name="line-69"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"can_pred"</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"TuplePred!"</span><span class='hs-layout'>)</span> 
<a name="line-70"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>evs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWithM</span> <span class='hs-varid'>can_pred_tup_one</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>0</span><span class='hs-keyglyph'>..</span><span class='hs-keyglyph'>]</span>
<a name="line-71"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-layout'>(</span><span class='hs-varid'>isWanted</span> <span class='hs-varid'>fl</span><span class='hs-layout'>)</span> <span class='hs-keyword'>then</span> 
<a name="line-72"></a>             <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span><span class='hs-sel'>_unused_fl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setEvBind</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvTupleMk</span> <span class='hs-varid'>evs</span><span class='hs-layout'>)</span> <span class='hs-varid'>fl</span>
<a name="line-73"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Stop</span> <span class='hs-layout'>}</span>
<a name="line-74"></a>         <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Stop</span> <span class='hs-layout'>}</span>
<a name="line-75"></a>  <span class='hs-keyword'>where</span> 
<a name="line-76"></a>     <span class='hs-varid'>can_pred_tup_one</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>n</span>
<a name="line-77"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>evc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEvVar</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>ty</span>
<a name="line-78"></a>               <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ev'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evc_the_evvar</span> <span class='hs-varid'>evc</span>
<a name="line-79"></a>               <span class='hs-layout'>;</span> <span class='hs-varid'>fl'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isGivenOrSolved</span> <span class='hs-varid'>fl</span> <span class='hs-keyword'>then</span> 
<a name="line-80"></a>                            <span class='hs-varid'>setEvBind</span> <span class='hs-varid'>ev'</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvTupleSel</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>fl</span>
<a name="line-81"></a>                        <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-varid'>fl</span>
<a name="line-82"></a>               <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>isNewEvVar</span> <span class='hs-varid'>evc</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-83"></a>                      <span class='hs-varid'>addToWork</span> <span class='hs-layout'>(</span><span class='hs-varid'>canEvVar</span> <span class='hs-varid'>ev'</span> <span class='hs-layout'>(</span><span class='hs-varid'>classifyPredType</span> <span class='hs-layout'>(</span><span class='hs-varid'>evVarPred</span> <span class='hs-varid'>ev'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl'</span><span class='hs-layout'>)</span>
<a name="line-84"></a>               <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ev'</span> <span class='hs-layout'>}</span>
<a name="line-85"></a>
<a name="line-86"></a><a name="canIP"></a><span class='hs-comment'>-- Implicit Parameter Canonicalization</span>
<a name="line-87"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-88"></a><span class='hs-definition'>canIP</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-comment'>-- Depth </span>
<a name="line-89"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvVar</span> 
<a name="line-90"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IPName</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>StopOrContinue</span>
<a name="line-91"></a><span class='hs-comment'>-- Precondition: EvVar is implicit parameter evidence</span>
<a name="line-92"></a><span class='hs-definition'>canIP</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>v</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>ty</span>
<a name="line-93"></a>  <span class='hs-keyglyph'>=</span>    <span class='hs-comment'>-- Note [Canonical implicit parameter constraints] explains why it's </span>
<a name="line-94"></a>       <span class='hs-comment'>-- possible in principle to not flatten, but since flattening applies </span>
<a name="line-95"></a>       <span class='hs-comment'>-- the inert substitution we choose to flatten anyway.</span>
<a name="line-96"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>xi</span><span class='hs-layout'>,</span><span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>flatten</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkIPPred</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-97"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>no_flattening</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isTcReflCo</span> <span class='hs-varid'>co</span> 
<a name="line-98"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>no_flattening</span> <span class='hs-keyword'>then</span>
<a name="line-99"></a>            <span class='hs-keyword'>let</span> <span class='hs-conid'>IPPred</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>xi_in</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>classifyPredType</span> <span class='hs-varid'>xi</span> 
<a name="line-100"></a>            <span class='hs-keyword'>in</span> <span class='hs-varid'>continueWith</span> <span class='hs-varop'>$</span> <span class='hs-conid'>CIPCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_flavor</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fl</span>
<a name="line-101"></a>                                     <span class='hs-layout'>,</span> <span class='hs-varid'>cc_ip_nm</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nm</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_ip_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xi_in</span>
<a name="line-102"></a>                                     <span class='hs-layout'>,</span> <span class='hs-varid'>cc_depth</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span> <span class='hs-layout'>}</span>
<a name="line-103"></a>         <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>evc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEvVar</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>xi</span>
<a name="line-104"></a>                 <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>v_new</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evc_the_evvar</span> <span class='hs-varid'>evc</span>
<a name="line-105"></a>                       <span class='hs-conid'>IPPred</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ip_xi</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>classifyPredType</span> <span class='hs-varid'>xi</span>
<a name="line-106"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>fl_new</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>fl</span> <span class='hs-keyword'>of</span> 
<a name="line-107"></a>                               <span class='hs-conid'>Wanted</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>setEvBind</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCast</span> <span class='hs-varid'>v_new</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>fl</span> 
<a name="line-108"></a>                               <span class='hs-conid'>Given</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>setEvBind</span> <span class='hs-varid'>v_new</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCast</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcSymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>fl</span>
<a name="line-109"></a>                               <span class='hs-conid'>Derived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>fl</span>
<a name="line-110"></a>                 <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isNewEvVar</span> <span class='hs-varid'>evc</span> <span class='hs-keyword'>then</span>
<a name="line-111"></a>                       <span class='hs-varid'>continueWith</span> <span class='hs-varop'>$</span> <span class='hs-conid'>CIPCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_id</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>v_new</span>
<a name="line-112"></a>                                             <span class='hs-layout'>,</span> <span class='hs-varid'>cc_flavor</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fl_new</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_ip_nm</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nm</span>
<a name="line-113"></a>                                             <span class='hs-layout'>,</span> <span class='hs-varid'>cc_ip_ty</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ip_xi</span>
<a name="line-114"></a>                                             <span class='hs-layout'>,</span> <span class='hs-varid'>cc_depth</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span> <span class='hs-layout'>}</span>
<a name="line-115"></a>                   <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Stop</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
</pre>\end{code}

Note [Canonical implicit parameter constraints]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The type in a canonical implicit parameter constraint doesn't need to
be a xi (type-function-free type) since we can defer the flattening
until checking this type for equality with another type.  If we
encounter two IP constraints with the same name, they MUST have the
same type, and at that point we can generate a flattened equality
constraint between the types.  (On the other hand, the types in two
class constraints for the same class MAY be equal, so they need to be
flattened in the first place to facilitate comparing them.)
\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><span class='hs-comment'>-- Class Canonicalization</span>
<a name="line-3"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="canClass"></a><span class='hs-definition'>canClass</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-comment'>-- Depth</span>
<a name="line-6"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvVar</span>  
<a name="line-7"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>StopOrContinue</span>
<a name="line-8"></a><span class='hs-comment'>-- Precondition: EvVar is class evidence </span>
<a name="line-9"></a><span class='hs-comment'>-- Note: Does NOT add superclasses, but the /caller/ is responsible for adding them!</span>
<a name="line-10"></a><span class='hs-definition'>canClass</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>v</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- sctx &lt;- getTcSContext</span>
<a name="line-12"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>xis</span><span class='hs-layout'>,</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>flattenMany</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>tys</span>
<a name="line-13"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcTyConAppCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>classTyCon</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span> <span class='hs-varid'>cos</span> 
<a name="line-14"></a>             <span class='hs-varid'>xi</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkClassPred</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>xis</span>
<a name="line-15"></a>
<a name="line-16"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>no_flattening</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isTcReflCo</span> <span class='hs-varid'>cos</span>
<a name="line-17"></a>                  <span class='hs-comment'>-- No flattening, continue with canonical</span>
<a name="line-18"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>no_flattening</span> <span class='hs-keyword'>then</span> 
<a name="line-19"></a>             <span class='hs-varid'>continueWith</span> <span class='hs-varop'>$</span> <span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_flavor</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fl</span>
<a name="line-20"></a>                                     <span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xis</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_class</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls</span>
<a name="line-21"></a>                                     <span class='hs-layout'>,</span> <span class='hs-varid'>cc_depth</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span> <span class='hs-layout'>}</span>
<a name="line-22"></a>                   <span class='hs-comment'>-- Flattening happened</span>
<a name="line-23"></a>         <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>evc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEvVar</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>xi</span>
<a name="line-24"></a>                 <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>v_new</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evc_the_evvar</span> <span class='hs-varid'>evc</span>
<a name="line-25"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>fl_new</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>fl</span> <span class='hs-keyword'>of</span>
<a name="line-26"></a>                     <span class='hs-conid'>Wanted</span>  <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>setEvBind</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCast</span> <span class='hs-varid'>v_new</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>fl</span>
<a name="line-27"></a>                     <span class='hs-conid'>Given</span>   <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>setEvBind</span> <span class='hs-varid'>v_new</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCast</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcSymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>fl</span>
<a name="line-28"></a>                     <span class='hs-conid'>Derived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>fl</span>
<a name="line-29"></a>                    <span class='hs-comment'>-- Continue only if flat constraint is new</span>
<a name="line-30"></a>                 <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isNewEvVar</span> <span class='hs-varid'>evc</span> <span class='hs-keyword'>then</span>
<a name="line-31"></a>                        <span class='hs-varid'>continueWith</span> <span class='hs-varop'>$</span> <span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>v_new</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_flavor</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fl_new</span>
<a name="line-32"></a>                                                <span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xis</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_class</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls</span>
<a name="line-33"></a>                                                <span class='hs-layout'>,</span> <span class='hs-varid'>cc_depth</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span> <span class='hs-layout'>}</span>
<a name="line-34"></a>                   <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Stop</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
</pre>\end{code}

Note [Adding superclasses]
~~~~~~~~~~~~~~~~~~~~~~~~~~ 
Since dictionaries are canonicalized only once in their lifetime, the
place to add their superclasses is canonicalisation (The alternative
would be to do it during constraint solving, but we'd have to be
extremely careful to not repeatedly introduced the same superclass in
our worklist). Here is what we do:

For Givens: 
       We add all their superclasses as Givens. 

For Wanteds: 
       Generally speaking we want to be able to add superclasses of 
       wanteds for two reasons:

       (1) Oportunities for improvement. Example: 
                  class (a ~ b) => C a b 
           Wanted constraint is: C alpha beta 
           We'd like to simply have C alpha alpha. Similar 
           situations arise in relation to functional dependencies. 
           
       (2) To have minimal constraints to quantify over: 
           For instance, if our wanted constraint is (Eq a, Ord a) 
           we'd only like to quantify over Ord a. 

       To deal with (1) above we only add the superclasses of wanteds
       which may lead to improvement, that is: equality superclasses or 
       superclasses with functional dependencies. 

       We deal with (2) completely independently in TcSimplify. See 
       Note [Minimize by SuperClasses] in TcSimplify. 


       Moreover, in all cases the extra improvement constraints are 
       Derived. Derived constraints have an identity (for now), but 
       we don't do anything with their evidence. For instance they 
       are never used to rewrite other constraints. 

       See also [New Wanted Superclass Work] in TcInteract. 


For Deriveds: 
       We do nothing.

Here's an example that demonstrates why we chose to NOT add
superclasses during simplification: [Comes from ticket #4497]
 
   class Num (RealOf t) => Normed t
   type family RealOf x

Assume the generated wanted constraint is: 
   RealOf e ~ e, Normed e 
If we were to be adding the superclasses during simplification we'd get: 
   Num uf, Normed e, RealOf e ~ e, RealOf e ~ uf 
==> 
   e ~ uf, Num uf, Normed e, RealOf e ~ e 
==> [Spontaneous solve] 
   Num uf, Normed uf, RealOf uf ~ uf 

While looks exactly like our original constraint. If we add the superclass again we'd loop. 
By adding superclasses definitely only once, during canonicalisation, this situation can't 
happen.

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><a name="newSCWorkFromFlavored"></a><span class='hs-definition'>newSCWorkFromFlavored</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-comment'>-- Depth</span>
<a name="line-3"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Xi</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-4"></a><span class='hs-comment'>-- Returns superclasses, see Note [Adding superclasses]</span>
<a name="line-5"></a><span class='hs-definition'>newSCWorkFromFlavored</span> <span class='hs-varid'>d</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>flavor</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>xis</span> 
<a name="line-6"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isDerived</span> <span class='hs-varid'>flavor</span> 
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>  <span class='hs-comment'>-- Deriveds don't yield more superclasses because we will</span>
<a name="line-8"></a>               <span class='hs-comment'>-- add them transitively in the case of wanteds. </span>
<a name="line-9"></a>
<a name="line-10"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>gk</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isGiven_maybe</span> <span class='hs-varid'>flavor</span> 
<a name="line-11"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>gk</span> <span class='hs-keyword'>of</span> 
<a name="line-12"></a>      <span class='hs-conid'>GivenOrig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>sc_theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>immSuperClasses</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>xis</span> 
<a name="line-13"></a>                      <span class='hs-layout'>;</span> <span class='hs-varid'>sc_vars</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>newEvVar</span> <span class='hs-varid'>flavor</span><span class='hs-layout'>)</span> <span class='hs-varid'>sc_theta</span>
<a name="line-14"></a>                      <span class='hs-layout'>;</span> <span class='hs-varid'>sc_cts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWithM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>scv</span> <span class='hs-varid'>ev_trm</span> <span class='hs-keyglyph'>-&gt;</span> 
<a name="line-15"></a>                                                <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>sc_evvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evc_the_evvar</span> <span class='hs-varid'>scv</span>
<a name="line-16"></a>                                                   <span class='hs-layout'>;</span> <span class='hs-sel'>_unused_fl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setEvBind</span> <span class='hs-varid'>sc_evvar</span> <span class='hs-varid'>ev_trm</span> <span class='hs-varid'>flavor</span>
<a name="line-17"></a>                                                      <span class='hs-comment'>-- unused because it's the same</span>
<a name="line-18"></a>                                                   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> 
<a name="line-19"></a>                                                     <span class='hs-conid'>CNonCanonical</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sc_evvar</span>
<a name="line-20"></a>                                                                   <span class='hs-layout'>,</span> <span class='hs-varid'>cc_flavor</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flavor</span>
<a name="line-21"></a>                                                                   <span class='hs-layout'>,</span> <span class='hs-varid'>cc_depth</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> 
<a name="line-22"></a>                                           <span class='hs-varid'>sc_vars</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvSuperClass</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>0</span><span class='hs-keyglyph'>..</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-23"></a>                        <span class='hs-comment'>-- Emit now, canonicalize later in a lazier fashion</span>
<a name="line-24"></a>                      <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"newSCWorkFromFlavored"</span> <span class='hs-varop'>$</span>
<a name="line-25"></a>                                 <span class='hs-varid'>text</span> <span class='hs-str'>"Emitting superclass work:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>sc_cts</span>
<a name="line-26"></a>                      <span class='hs-layout'>;</span> <span class='hs-varid'>updWorkListTcS</span> <span class='hs-varop'>$</span> <span class='hs-varid'>appendWorkListCt</span> <span class='hs-varid'>sc_cts</span> <span class='hs-layout'>}</span>
<a name="line-27"></a>      <span class='hs-conid'>GivenSolved</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-28"></a>      <span class='hs-comment'>-- Seems very dangerous to add the superclasses for dictionaries that may be </span>
<a name="line-29"></a>      <span class='hs-comment'>-- partially solved because we may end up with evidence loops.</span>
<a name="line-30"></a>
<a name="line-31"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfTypes</span> <span class='hs-varid'>xis</span><span class='hs-layout'>)</span>
<a name="line-32"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span> <span class='hs-comment'>-- Wanteds with no variables yield no deriveds.</span>
<a name="line-33"></a>              <span class='hs-comment'>-- See Note [Improvement from Ground Wanteds]</span>
<a name="line-34"></a>
<a name="line-35"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-comment'>-- Wanted case, just add those SC that can lead to improvement. </span>
<a name="line-36"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>sc_rec_theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>transSuperClasses</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>xis</span> 
<a name="line-37"></a>             <span class='hs-varid'>impr_theta</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>is_improvement_pty</span> <span class='hs-varid'>sc_rec_theta</span> 
<a name="line-38"></a>             <span class='hs-conid'>Wanted</span> <span class='hs-varid'>wloc</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flavor</span>
<a name="line-39"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>sc_cts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>pty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>scv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEvVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>Derived</span> <span class='hs-varid'>wloc</span><span class='hs-layout'>)</span> <span class='hs-varid'>pty</span>
<a name="line-40"></a>                                    <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isNewEvVar</span> <span class='hs-varid'>scv</span> <span class='hs-keyword'>then</span> 
<a name="line-41"></a>                                          <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>CNonCanonical</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evc_the_evvar</span> <span class='hs-varid'>scv</span>
<a name="line-42"></a>                                                                 <span class='hs-layout'>,</span> <span class='hs-varid'>cc_flavor</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Derived</span> <span class='hs-varid'>wloc</span>
<a name="line-43"></a>                                                                 <span class='hs-layout'>,</span> <span class='hs-varid'>cc_depth</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>]</span>  
<a name="line-44"></a>                                      <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>}</span>
<a name="line-45"></a>                        <span class='hs-layout'>)</span> <span class='hs-varid'>impr_theta</span>
<a name="line-46"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>sc_cts_flat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concat</span> <span class='hs-varid'>sc_cts</span>
<a name="line-47"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"newSCWorkFromFlavored"</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Emitting superclass work:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>sc_cts_flat</span><span class='hs-layout'>)</span>
<a name="line-48"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>updWorkListTcS</span> <span class='hs-varop'>$</span> <span class='hs-varid'>appendWorkListCt</span> <span class='hs-varid'>sc_cts_flat</span> <span class='hs-layout'>}</span>
<a name="line-49"></a>
<a name="line-50"></a><a name="is_improvement_pty"></a><span class='hs-definition'>is_improvement_pty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> 
<a name="line-51"></a><span class='hs-comment'>-- Either it's an equality, or has some functional dependency</span>
<a name="line-52"></a><span class='hs-definition'>is_improvement_pty</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>classifyPredType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-53"></a>  <span class='hs-keyword'>where</span>
<a name="line-54"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>EqPred</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> 
<a name="line-55"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClassPred</span> <span class='hs-varid'>cls</span> <span class='hs-sel'>_tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-varop'>$</span> <span class='hs-varid'>null</span> <span class='hs-varid'>fundeps</span>
<a name="line-56"></a>      <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>fundeps</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>classTvsFds</span> <span class='hs-varid'>cls</span>
<a name="line-57"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>IPPred</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-58"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TuplePred</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>any</span> <span class='hs-varid'>is_improvement_pty</span> <span class='hs-varid'>ts</span>
<a name="line-59"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>IrredPred</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-comment'>-- Might have equalities after reduction?</span>
</pre>\end{code}



\begin{code}
<pre><a name="line-1"></a><a name="canIrred"></a><span class='hs-comment'>-- Irreducibles canonicalization</span>
<a name="line-2"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-3"></a><span class='hs-definition'>canIrred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-comment'>-- Depth</span>
<a name="line-4"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>StopOrContinue</span>
<a name="line-5"></a><span class='hs-comment'>-- Precondition: ty not a tuple and no other evidence form</span>
<a name="line-6"></a><span class='hs-definition'>canIrred</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>v</span> <span class='hs-varid'>ty</span> 
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"can_pred"</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"IrredPred = "</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> 
<a name="line-8"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>xi</span><span class='hs-layout'>,</span><span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>flatten</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>ty</span> <span class='hs-comment'>-- co :: xi ~ ty</span>
<a name="line-9"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>no_flattening</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xi</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>ty</span> 
<a name="line-10"></a>                             <span class='hs-comment'>-- In this particular case it is not safe to </span>
<a name="line-11"></a>                             <span class='hs-comment'>-- say 'isTcReflCo' because the new constraint may</span>
<a name="line-12"></a>                             <span class='hs-comment'>-- be reducible!</span>
<a name="line-13"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>no_flattening</span> <span class='hs-keyword'>then</span>
<a name="line-14"></a>            <span class='hs-varid'>continueWith</span> <span class='hs-varop'>$</span> <span class='hs-conid'>CIrredEvCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_flavor</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fl</span>
<a name="line-15"></a>                                       <span class='hs-layout'>,</span> <span class='hs-varid'>cc_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xi</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_depth</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span> <span class='hs-layout'>}</span>
<a name="line-16"></a>         <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-17"></a>      <span class='hs-layout'>{</span>   <span class='hs-comment'>-- Flattening consults and applies family equations from the</span>
<a name="line-18"></a>          <span class='hs-comment'>-- inerts, so 'xi' may become reducible. So just recursively</span>
<a name="line-19"></a>          <span class='hs-comment'>-- canonicalise the resulting evidence variable</span>
<a name="line-20"></a>        <span class='hs-varid'>evc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEvVar</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>xi</span>
<a name="line-21"></a>      <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>v'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evc_the_evvar</span> <span class='hs-varid'>evc</span>
<a name="line-22"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>fl'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>fl</span> <span class='hs-keyword'>of</span> 
<a name="line-23"></a>          <span class='hs-conid'>Wanted</span>  <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>setEvBind</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCast</span> <span class='hs-varid'>v'</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>fl</span>
<a name="line-24"></a>          <span class='hs-conid'>Given</span>   <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>setEvBind</span> <span class='hs-varid'>v'</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCast</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcSymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>fl</span>
<a name="line-25"></a>          <span class='hs-conid'>Derived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>fl</span>
<a name="line-26"></a>      
<a name="line-27"></a>      <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isNewEvVar</span> <span class='hs-varid'>evc</span> <span class='hs-keyword'>then</span> 
<a name="line-28"></a>            <span class='hs-varid'>canEvVar</span> <span class='hs-varid'>v'</span> <span class='hs-layout'>(</span><span class='hs-varid'>classifyPredType</span> <span class='hs-layout'>(</span><span class='hs-varid'>evVarPred</span> <span class='hs-varid'>v'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl'</span>
<a name="line-29"></a>        <span class='hs-keyword'>else</span>
<a name="line-30"></a>            <span class='hs-varid'>return</span> <span class='hs-conid'>Stop</span> <span class='hs-layout'>}</span>
<a name="line-31"></a>      <span class='hs-layout'>}</span>
<a name="line-32"></a>
</pre>\end{code}

%************************************************************************
%*                                                                      *
%*        Flattening (eliminating all function symbols)                 *
%*                                                                      *
%************************************************************************

Note [Flattening]
~~~~~~~~~~~~~~~~~~~~
  flatten ty  ==>   (xi, cc)
    where
      xi has no type functions
      cc = Auxiliary given (equality) constraints constraining
           the fresh type variables in xi.  Evidence for these 
           is always the identity coercion, because internally the
           fresh flattening skolem variables are actually identified
           with the types they have been generated to stand in for.

Note that it is flatten's job to flatten *every type function it sees*.
flatten is only called on *arguments* to type functions, by canEqGiven.

Recall that in comments we use alpha[flat = ty] to represent a
flattening skolem variable alpha which has been generated to stand in
for ty.

----- Example of flattening a constraint: ------
  flatten (List (F (G Int)))  ==>  (xi, cc)
    where
      xi  = List alpha
      cc  = { G Int ~ beta[flat = G Int],
              F beta ~ alpha[flat = F beta] }
Here
  * alpha and beta are 'flattening skolem variables'.
  * All the constraints in cc are 'given', and all their coercion terms 
    are the identity.

NB: Flattening Skolems only occur in canonical constraints, which
are never zonked, so we don't need to worry about zonking doing
accidental unflattening.

Note that we prefer to leave type synonyms unexpanded when possible,
so when the flattener encounters one, it first asks whether its
transitive expansion contains any type function applications.  If so,
it expands the synonym and proceeds; if not, it simply returns the
unexpanded synonym.

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><a name="flattenMany"></a><span class='hs-comment'>-- Flatten a bunch of types all at once.</span>
<a name="line-3"></a><span class='hs-definition'>flattenMany</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-comment'>-- Depth</span>
<a name="line-4"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Xi</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcCoercion</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-5"></a><span class='hs-comment'>-- Coercions :: Xi ~ Type </span>
<a name="line-6"></a><span class='hs-comment'>-- Returns True iff (no flattening happened)</span>
<a name="line-7"></a><span class='hs-definition'>flattenMany</span> <span class='hs-varid'>d</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>tys</span> 
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- pprTrace "flattenMany" empty $</span>
<a name="line-9"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>tys</span> 
<a name="line-10"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-11"></a>        <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-conop'>:</span><span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>xi</span><span class='hs-layout'>,</span><span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>flatten</span> <span class='hs-varid'>d</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty</span>
<a name="line-12"></a>                         <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>xis</span><span class='hs-layout'>,</span><span class='hs-varid'>cos</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tys</span>
<a name="line-13"></a>                         <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>xi</span><span class='hs-conop'>:</span><span class='hs-varid'>xis</span><span class='hs-layout'>,</span><span class='hs-varid'>co</span><span class='hs-conop'>:</span><span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="flatten"></a><span class='hs-comment'>-- Flatten a type to get rid of type function applications, returning</span>
<a name="line-16"></a><span class='hs-comment'>-- the new type-function-free type, and a collection of new equality</span>
<a name="line-17"></a><span class='hs-comment'>-- constraints.  See Note [Flattening] for more detail.</span>
<a name="line-18"></a><span class='hs-definition'>flatten</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-comment'>-- Depth</span>
<a name="line-19"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Xi</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcCoercion</span><span class='hs-layout'>)</span>
<a name="line-20"></a><span class='hs-comment'>-- Postcondition: Coercion :: Xi ~ TcType</span>
<a name="line-21"></a><span class='hs-definition'>flatten</span> <span class='hs-varid'>d</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty</span> 
<a name="line-22"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span>
<a name="line-23"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>xi</span><span class='hs-layout'>,</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>flatten</span> <span class='hs-varid'>d</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty'</span>
<a name="line-24"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>xi</span><span class='hs-layout'>,</span><span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-25"></a>	
<a name="line-26"></a>       <span class='hs-comment'>-- DV: The following is tedious to do but maybe we should return to this</span>
<a name="line-27"></a>       <span class='hs-comment'>-- Preserve type synonyms if possible</span>
<a name="line-28"></a>       <span class='hs-comment'>-- ; if no_flattening</span>
<a name="line-29"></a>       <span class='hs-comment'>--   then return (xi, mkTcReflCo xi,no_flattening) -- Importantly, not xi!</span>
<a name="line-30"></a>       <span class='hs-comment'>--   else return (xi,co,no_flattening) </span>
<a name="line-31"></a>       <span class='hs-comment'>-- }</span>
<a name="line-32"></a>
<a name="line-33"></a><span class='hs-definition'>flatten</span> <span class='hs-varid'>d</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>v</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-34"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ieqs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInertEqs</span>
<a name="line-35"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftInertEqsTy</span> <span class='hs-varid'>ieqs</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>v</span>           <span class='hs-comment'>-- co : v ~ ty</span>
<a name="line-36"></a>             <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pSnd</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcCoercionKind</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-37"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>then</span>
<a name="line-38"></a>             <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span><span class='hs-varid'>mkTcReflCo</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-39"></a>         <span class='hs-keyword'>else</span> <span class='hs-comment'>-- NB recursive call. Why? See Note [Non-idempotent inert substitution]</span>
<a name="line-40"></a>              <span class='hs-comment'>-- Actually I believe that applying the substition only *twice* will suffice</span>
<a name="line-41"></a>         
<a name="line-42"></a>             <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty_final</span><span class='hs-layout'>,</span><span class='hs-varid'>co'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>flatten</span> <span class='hs-varid'>d</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty</span>  <span class='hs-comment'>-- co' : ty_final ~ ty</span>
<a name="line-43"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty_final</span><span class='hs-layout'>,</span><span class='hs-varid'>co'</span> <span class='hs-varop'>`mkTcTransCo`</span> <span class='hs-varid'>mkTcSymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-44"></a>
</pre>\end{code}

Note [Non-idempotent inert substitution]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The inert substitution is not idempotent in the broad sense. It is only idempotent in 
that it cannot rewrite the RHS of other inert equalities any further. An example of such 
an inert substitution is:

 [Ś] g1 : ta8 ~ ta4
 [W] g2 : ta4 ~ a5Fj

Observe that the wanted cannot rewrite the solved goal, despite the fact that ta4 appears on
an RHS of an equality. Now, imagine a constraint:

 [W] g3: ta8 ~ Int 

coming in. If we simply apply once the inert substitution we will get: 

 [W] g3_1: ta4 ~ Int 

and because potentially ta4 is untouchable we will try to insert g3_1 in the inert set, 
getting a panic since the inert only allows ONE equation per LHS type variable (as it 
should).

For this reason, when we reach to flatten a type variable, we flatten it recursively, 
so that we can make sure that the inert substitution /is/ fully applied.

This insufficient rewriting was the reason for #5668.

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a>
<a name="line-3"></a><a name="flatten"></a><span class='hs-definition'>flatten</span> <span class='hs-varid'>d</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>xi1</span><span class='hs-layout'>,</span><span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>flatten</span> <span class='hs-varid'>d</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty1</span>
<a name="line-5"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>xi2</span><span class='hs-layout'>,</span><span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>flatten</span> <span class='hs-varid'>d</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty2</span>
<a name="line-6"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppTy</span> <span class='hs-varid'>xi1</span> <span class='hs-varid'>xi2</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcAppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-definition'>flatten</span> <span class='hs-varid'>d</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>xi1</span><span class='hs-layout'>,</span><span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>flatten</span> <span class='hs-varid'>d</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty1</span>
<a name="line-10"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>xi2</span><span class='hs-layout'>,</span><span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>flatten</span> <span class='hs-varid'>d</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty2</span>
<a name="line-11"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>xi1</span> <span class='hs-varid'>xi2</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcFunCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-12"></a>
<a name="line-13"></a><span class='hs-definition'>flatten</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-14"></a>  <span class='hs-comment'>-- For a normal type constructor or data family application, we just</span>
<a name="line-15"></a>  <span class='hs-comment'>-- recursively flatten the arguments.</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isSynFamilyTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-17"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>xis</span><span class='hs-layout'>,</span><span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>flattenMany</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>tys</span>
<a name="line-18"></a>         <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>xis</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcTyConAppCo</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-19"></a>
<a name="line-20"></a>  <span class='hs-comment'>-- Otherwise, it's a type function application, and we have to</span>
<a name="line-21"></a>  <span class='hs-comment'>-- flatten it away as well, and generate a new given equality constraint</span>
<a name="line-22"></a>  <span class='hs-comment'>-- between the application and a newly generated flattening skolem variable.</span>
<a name="line-23"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-24"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span>	<span class='hs-comment'>-- Type functions are saturated</span>
<a name="line-25"></a>      <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>xis</span><span class='hs-layout'>,</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>flattenMany</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>tys</span>
<a name="line-26"></a>         <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>xi_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>xi_rest</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAt</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>xis</span>
<a name="line-27"></a>	       	 <span class='hs-comment'>-- The type function might be *over* saturated</span>
<a name="line-28"></a>		 <span class='hs-comment'>-- in which case the remaining arguments should</span>
<a name="line-29"></a>		 <span class='hs-comment'>-- be dealt with by AppTys</span>
<a name="line-30"></a>               <span class='hs-varid'>fam_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>xi_args</span>
<a name="line-31"></a>         <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ret_co</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_xi</span><span class='hs-layout'>,</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-32"></a>             <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is_cached</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCachedFlatEq</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>xi_args</span> <span class='hs-varid'>fl</span> <span class='hs-conid'>Any</span>
<a name="line-33"></a>                <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>is_cached</span> <span class='hs-keyword'>of</span>
<a name="line-34"></a>                    <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>rhs_xi</span><span class='hs-layout'>,</span><span class='hs-varid'>ret_eq</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> 
<a name="line-35"></a>                        <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"is_cached!"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ret_eq</span>
<a name="line-36"></a>                           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ret_eq</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_xi</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-37"></a>                    <span class='hs-conid'>Nothing</span>
<a name="line-38"></a>                        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isGivenOrSolved</span> <span class='hs-varid'>fl</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-39"></a>                            <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rhs_xi_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlattenSkolemTy</span> <span class='hs-varid'>fam_ty</span>
<a name="line-40"></a>                               <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>fl'</span><span class='hs-layout'>,</span><span class='hs-varid'>eqv</span><span class='hs-layout'>)</span> 
<a name="line-41"></a>                                   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newGivenEqVar</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>fam_ty</span> <span class='hs-varid'>rhs_xi_var</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcReflCo</span> <span class='hs-varid'>fam_ty</span><span class='hs-layout'>)</span>
<a name="line-42"></a>                               <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ct</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_id</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqv</span>
<a name="line-43"></a>                                                     <span class='hs-layout'>,</span> <span class='hs-varid'>cc_flavor</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fl'</span> <span class='hs-comment'>-- Given</span>
<a name="line-44"></a>                                                     <span class='hs-layout'>,</span> <span class='hs-varid'>cc_fun</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span> 
<a name="line-45"></a>                                                     <span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xi_args</span> 
<a name="line-46"></a>                                                     <span class='hs-layout'>,</span> <span class='hs-varid'>cc_rhs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs_xi_var</span> 
<a name="line-47"></a>                                                     <span class='hs-layout'>,</span> <span class='hs-varid'>cc_depth</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span> <span class='hs-layout'>}</span>
<a name="line-48"></a>                                           <span class='hs-comment'>-- Update the flat cache: just an optimisation!</span>
<a name="line-49"></a>                               <span class='hs-layout'>;</span> <span class='hs-varid'>updateFlatCache</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>fl'</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>xi_args</span> <span class='hs-varid'>rhs_xi_var</span> <span class='hs-conid'>WhileFlattening</span>
<a name="line-50"></a>                               <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcCoVarCo</span> <span class='hs-varid'>eqv</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_xi_var</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ct</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-51"></a>                        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-52"></a>                    <span class='hs-comment'>-- Derived or Wanted: make a new /unification/ flatten variable</span>
<a name="line-53"></a>                            <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rhs_xi_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTcSTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>fam_ty</span><span class='hs-layout'>)</span>
<a name="line-54"></a>                               <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>wanted_flavor</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWantedFlavor</span> <span class='hs-varid'>fl</span>
<a name="line-55"></a>                               <span class='hs-layout'>;</span> <span class='hs-varid'>evc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEqVar</span> <span class='hs-varid'>wanted_flavor</span> <span class='hs-varid'>fam_ty</span> <span class='hs-varid'>rhs_xi_var</span>
<a name="line-56"></a>                               <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>eqv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evc_the_evvar</span> <span class='hs-varid'>evc</span> <span class='hs-comment'>-- Not going to be cached</span>
<a name="line-57"></a>                                     <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqv</span>
<a name="line-58"></a>                                                    <span class='hs-layout'>,</span> <span class='hs-varid'>cc_flavor</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wanted_flavor</span>
<a name="line-59"></a>                                                    <span class='hs-comment'>-- Always Wanted, not Derived</span>
<a name="line-60"></a>                                                    <span class='hs-layout'>,</span> <span class='hs-varid'>cc_fun</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span>
<a name="line-61"></a>                                                    <span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xi_args</span>
<a name="line-62"></a>                                                    <span class='hs-layout'>,</span> <span class='hs-varid'>cc_rhs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs_xi_var</span> 
<a name="line-63"></a>                                                    <span class='hs-layout'>,</span> <span class='hs-varid'>cc_depth</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span> <span class='hs-layout'>}</span>
<a name="line-64"></a>                                          <span class='hs-comment'>-- Update the flat cache: just an optimisation!</span>
<a name="line-65"></a>                               <span class='hs-layout'>;</span> <span class='hs-varid'>updateFlatCache</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>xi_args</span> <span class='hs-varid'>rhs_xi_var</span> <span class='hs-conid'>WhileFlattening</span>
<a name="line-66"></a>                               <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcCoVarCo</span> <span class='hs-varid'>eqv</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_xi_var</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ct</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-67"></a>
<a name="line-68"></a>           <span class='hs-comment'>-- Emit the flat constraints</span>
<a name="line-69"></a>         <span class='hs-layout'>;</span> <span class='hs-varid'>updWorkListTcS</span> <span class='hs-varop'>$</span> <span class='hs-varid'>appendWorkListEqs</span> <span class='hs-varid'>ct</span>
<a name="line-70"></a>
<a name="line-71"></a>         <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>cos_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>cos_rest</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAt</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>cos</span>
<a name="line-72"></a>         <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-varid'>mkAppTys</span> <span class='hs-varid'>rhs_xi</span> <span class='hs-varid'>xi_rest</span>    <span class='hs-comment'>-- NB mkAppTys: rhs_xi might not be a type variable</span>
<a name="line-73"></a>	   	    	     	    	       <span class='hs-comment'>--    cf Trac #5655</span>
<a name="line-74"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>mkTcAppCos</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcSymCo</span> <span class='hs-varid'>ret_co</span> <span class='hs-varop'>`mkTcTransCo`</span> <span class='hs-varid'>mkTcTyConAppCo</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos_args</span><span class='hs-layout'>)</span>
<a name="line-75"></a>                               <span class='hs-varid'>cos_rest</span>
<a name="line-76"></a>                  <span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-77"></a>
<a name="line-78"></a>
<a name="line-79"></a><span class='hs-definition'>flatten</span> <span class='hs-varid'>d</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-80"></a><span class='hs-comment'>-- We allow for-alls when, but only when, no type function</span>
<a name="line-81"></a><span class='hs-comment'>-- applications inside the forall involve the bound type variables.</span>
<a name="line-82"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitForAllTys</span> <span class='hs-varid'>ty</span>
<a name="line-83"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>under_families</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>rho</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>flattenForAllErrorTcS</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty</span>
<a name="line-84"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>rho'</span><span class='hs-layout'>,</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>flatten</span> <span class='hs-varid'>d</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rho</span>
<a name="line-85"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkForAllTys</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>rho'</span><span class='hs-layout'>,</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>mkTcForAllCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-86"></a>
<a name="line-87"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>under_families</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>rho</span> 
<a name="line-88"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>rho</span> 
<a name="line-89"></a>            <span class='hs-keyword'>where</span> <span class='hs-varid'>go</span> <span class='hs-sel'>_bound</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-sel'>_tv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-90"></a>                  <span class='hs-varid'>go</span> <span class='hs-varid'>bound</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-91"></a>                      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isSynFamilyTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-92"></a>                      <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>args</span><span class='hs-layout'>,</span><span class='hs-varid'>rest</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitAt</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-93"></a>                      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfTypes</span> <span class='hs-varid'>args</span> <span class='hs-varop'>`intersectsVarSet`</span> <span class='hs-varid'>bound</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>bound</span><span class='hs-layout'>)</span> <span class='hs-varid'>rest</span>
<a name="line-94"></a>                      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>bound</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-95"></a>                  <span class='hs-varid'>go</span> <span class='hs-varid'>bound</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>bound</span> <span class='hs-varid'>arg</span> <span class='hs-varop'>||</span> <span class='hs-varid'>go</span> <span class='hs-varid'>bound</span> <span class='hs-varid'>res</span>
<a name="line-96"></a>                  <span class='hs-varid'>go</span> <span class='hs-varid'>bound</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>bound</span> <span class='hs-varid'>fun</span> <span class='hs-varop'>||</span> <span class='hs-varid'>go</span> <span class='hs-varid'>bound</span> <span class='hs-varid'>arg</span>
<a name="line-97"></a>                  <span class='hs-varid'>go</span> <span class='hs-varid'>bound</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>bound</span> <span class='hs-varop'>`extendVarSet`</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-98"></a>
<a name="line-99"></a>
<a name="line-100"></a><a name="getCachedFlatEq"></a><span class='hs-definition'>getCachedFlatEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Xi</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavor</span> 
<a name="line-101"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FlatEqOrigin</span>
<a name="line-102"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Xi</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcCoercion</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-103"></a><span class='hs-comment'>-- Returns a coercion between (TyConApp tc xi_args ~ xi) if such an inert item exists</span>
<a name="line-104"></a><span class='hs-comment'>-- But also applies the substitution to the item via calling flatten recursively</span>
<a name="line-105"></a><span class='hs-definition'>getCachedFlatEq</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>xi_args</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>feq_origin</span>
<a name="line-106"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>pty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>xi_args</span>
<a name="line-107"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"getCachedFlatEq"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>xi_args</span><span class='hs-layout'>)</span>
<a name="line-108"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>flat_cache</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSEvVarFlatCache</span>
<a name="line-109"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInerts</span>
<a name="line-110"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupFunEq</span> <span class='hs-varid'>pty</span> <span class='hs-varid'>fl</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_funeqs</span> <span class='hs-varid'>inerts</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-111"></a>           <span class='hs-conid'>Nothing</span> 
<a name="line-112"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>lookup_in_flat_cache</span> <span class='hs-varid'>pty</span> <span class='hs-varid'>flat_cache</span>
<a name="line-113"></a>           <span class='hs-varid'>res</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>res</span> <span class='hs-layout'>}</span>
<a name="line-114"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>lookup_in_flat_cache</span> <span class='hs-varid'>pty</span> <span class='hs-varid'>flat_cache</span> 
<a name="line-115"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupTM</span> <span class='hs-varid'>pty</span> <span class='hs-varid'>flat_cache</span> <span class='hs-keyword'>of</span>
<a name="line-116"></a>              <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>co'</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>xi'</span><span class='hs-layout'>,</span><span class='hs-varid'>fl'</span><span class='hs-layout'>,</span><span class='hs-varid'>when_generated</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ev' :: (TyConApp tc xi_args) ~ xi'</span>
<a name="line-117"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>fl'</span> <span class='hs-varop'>`canRewrite`</span> <span class='hs-varid'>fl</span>
<a name="line-118"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>feq_origin</span> <span class='hs-varop'>`origin_matches`</span> <span class='hs-varid'>when_generated</span>
<a name="line-119"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"getCachedFlatEq"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"success!"</span>
<a name="line-120"></a>                     <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>xi''</span><span class='hs-layout'>,</span><span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>flatten</span> <span class='hs-num'>0</span> <span class='hs-varid'>fl'</span> <span class='hs-varid'>xi'</span> <span class='hs-comment'>-- co :: xi'' ~ xi'</span>
<a name="line-121"></a>                                    <span class='hs-comment'>-- The only purpose of this flattening is to apply the</span>
<a name="line-122"></a>                                    <span class='hs-comment'>-- inert substitution (since everything in the flat cache</span>
<a name="line-123"></a>                                    <span class='hs-comment'>-- by construction will have a family-free RHS.</span>
<a name="line-124"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>xi''</span><span class='hs-layout'>,</span> <span class='hs-varid'>co'</span> <span class='hs-varop'>`mkTcTransCo`</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcSymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-125"></a>              <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"getCachedFlatEq"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"failure!"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprEvVarCache</span> <span class='hs-varid'>flat_cache</span>
<a name="line-126"></a>                      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>}</span>
<a name="line-127"></a>
<a name="line-128"></a><a name="addToWork"></a><span class='hs-comment'>-----------------</span>
<a name="line-129"></a><span class='hs-definition'>addToWork</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>StopOrContinue</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-130"></a><span class='hs-definition'>addToWork</span> <span class='hs-varid'>tcs_action</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcs_action</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>stop_or_emit</span>
<a name="line-131"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>stop_or_emit</span> <span class='hs-conid'>Stop</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-132"></a>        <span class='hs-varid'>stop_or_emit</span> <span class='hs-layout'>(</span><span class='hs-conid'>ContinueWith</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updWorkListTcS</span> <span class='hs-varop'>$</span> 
<a name="line-133"></a>                                         <span class='hs-varid'>extendWorkListCt</span> <span class='hs-varid'>ct</span>
<a name="line-134"></a>
<a name="line-135"></a><a name="canEqEvVarsCreated"></a><span class='hs-definition'>canEqEvVarsCreated</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubGoalDepth</span> 
<a name="line-136"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CtFlavor</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVarCreated</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-137"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>StopOrContinue</span>
<a name="line-138"></a><span class='hs-definition'>canEqEvVarsCreated</span> <span class='hs-sel'>_d</span> <span class='hs-sel'>_fl</span> <span class='hs-conid'>[]</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Stop</span>
<a name="line-139"></a><span class='hs-definition'>canEqEvVarsCreated</span> <span class='hs-varid'>d</span> <span class='hs-layout'>(</span><span class='hs-varid'>fl</span><span class='hs-conop'>:</span><span class='hs-varid'>fls</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>evc</span><span class='hs-conop'>:</span><span class='hs-varid'>evcs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-conop'>:</span><span class='hs-varid'>tys1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty2</span><span class='hs-conop'>:</span><span class='hs-varid'>tys2</span><span class='hs-layout'>)</span> 
<a name="line-140"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isNewEvVar</span> <span class='hs-varid'>evc</span> 
<a name="line-141"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>do_one</span> <span class='hs-varid'>evc0</span> <span class='hs-varid'>sy1</span> <span class='hs-varid'>sy2</span>
<a name="line-142"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isNewEvVar</span> <span class='hs-varid'>evc0</span> 
<a name="line-143"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>canEq_</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-layout'>(</span><span class='hs-varid'>evc_the_evvar</span> <span class='hs-varid'>evc0</span><span class='hs-layout'>)</span> <span class='hs-varid'>sy1</span> <span class='hs-varid'>sy2</span>
<a name="line-144"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-145"></a>    <span class='hs-keyword'>in</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-sel'>_unused</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWith3M</span> <span class='hs-varid'>do_one</span> <span class='hs-varid'>evcs</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>tys2</span> 
<a name="line-146"></a>          <span class='hs-layout'>;</span> <span class='hs-varid'>canEq</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-layout'>(</span><span class='hs-varid'>evc_the_evvar</span> <span class='hs-varid'>evc</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-layout'>}</span>
<a name="line-147"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> 
<a name="line-148"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>canEqEvVarsCreated</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fls</span> <span class='hs-varid'>evcs</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>tys2</span>
<a name="line-149"></a><span class='hs-definition'>canEqEvVarsCreated</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Stop</span>
<a name="line-150"></a>
<a name="line-151"></a>
<a name="line-152"></a><a name="canEq_"></a><span class='hs-definition'>canEq_</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubGoalDepth</span> 
<a name="line-153"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EqVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-154"></a><span class='hs-definition'>canEq_</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addToWork</span> <span class='hs-layout'>(</span><span class='hs-varid'>canEq</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-155"></a>
<a name="line-156"></a><a name="canEq"></a><span class='hs-definition'>canEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubGoalDepth</span> 
<a name="line-157"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EqVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>StopOrContinue</span>
<a name="line-158"></a><span class='hs-definition'>canEq</span> <span class='hs-sel'>_d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-159"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>eqType</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>	<span class='hs-comment'>-- Dealing with equality here avoids</span>
<a name="line-160"></a>    	     	 	<span class='hs-comment'>-- later spurious occurs checks for a~a</span>
<a name="line-161"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>isWanted</span> <span class='hs-varid'>fl</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> 
<a name="line-162"></a>              <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setEqBind</span> <span class='hs-varid'>eqv</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcReflCo</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-varid'>fl</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span> <span class='hs-layout'>}</span>
<a name="line-163"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Stop</span> <span class='hs-layout'>}</span>
<a name="line-164"></a>
<a name="line-165"></a><span class='hs-comment'>-- Split up an equality between function types into two equalities.</span>
<a name="line-166"></a><span class='hs-definition'>canEq</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-167"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>argeqv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEqVar</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span>
<a name="line-168"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>reseqv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEqVar</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-169"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>argeqv_v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evc_the_evvar</span> <span class='hs-varid'>argeqv</span>
<a name="line-170"></a>             <span class='hs-varid'>reseqv_v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evc_the_evvar</span> <span class='hs-varid'>reseqv</span>
<a name="line-171"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>fl1</span><span class='hs-layout'>,</span><span class='hs-varid'>fl2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>fl</span> <span class='hs-keyword'>of</span>
<a name="line-172"></a>           <span class='hs-conid'>Wanted</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-173"></a>               <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setEqBind</span> <span class='hs-varid'>eqv</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcFunCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcCoVarCo</span> <span class='hs-varid'>argeqv_v</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcCoVarCo</span> <span class='hs-varid'>reseqv_v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>fl</span>
<a name="line-174"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>fl</span><span class='hs-layout'>,</span><span class='hs-varid'>fl</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-175"></a>           <span class='hs-conid'>Given</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-176"></a>               <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fl1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setEqBind</span> <span class='hs-varid'>argeqv_v</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcNthCo</span> <span class='hs-num'>0</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcCoVarCo</span> <span class='hs-varid'>eqv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>fl</span>
<a name="line-177"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>fl2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setEqBind</span> <span class='hs-varid'>reseqv_v</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcNthCo</span> <span class='hs-num'>1</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcCoVarCo</span> <span class='hs-varid'>eqv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>fl</span> 
<a name="line-178"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>fl1</span><span class='hs-layout'>,</span><span class='hs-varid'>fl2</span><span class='hs-layout'>)</span>
<a name="line-179"></a>                  <span class='hs-layout'>}</span>
<a name="line-180"></a>           <span class='hs-conid'>Derived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-181"></a>               <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>fl</span><span class='hs-layout'>,</span><span class='hs-varid'>fl</span><span class='hs-layout'>)</span>
<a name="line-182"></a>
<a name="line-183"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>canEqEvVarsCreated</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>fl2</span><span class='hs-layout'>,</span><span class='hs-varid'>fl1</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>reseqv</span><span class='hs-layout'>,</span><span class='hs-varid'>argeqv</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>t1</span><span class='hs-layout'>,</span><span class='hs-varid'>s1</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>t2</span><span class='hs-layout'>,</span><span class='hs-varid'>s2</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-184"></a>
<a name="line-185"></a><span class='hs-comment'>-- If one side is a variable, orient and flatten,</span>
<a name="line-186"></a><span class='hs-comment'>-- WITHOUT expanding type synonyms, so that we tend to </span>
<a name="line-187"></a><span class='hs-comment'>-- substitute a ~ Age rather than a ~ Int when @type Age = Int@</span>
<a name="line-188"></a><span class='hs-definition'>canEq</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>ty1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span> 
<a name="line-189"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>canEqLeaf</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-190"></a><span class='hs-definition'>canEq</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-191"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>canEqLeaf</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-192"></a>
<a name="line-193"></a><span class='hs-definition'>canEq</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>ty1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span> 
<a name="line-194"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isSynFamilyTyCon</span> <span class='hs-varid'>fn</span><span class='hs-layout'>,</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>fn</span>
<a name="line-195"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>canEqLeaf</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-196"></a><span class='hs-definition'>canEq</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-197"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isSynFamilyTyCon</span> <span class='hs-varid'>fn</span><span class='hs-layout'>,</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>fn</span>
<a name="line-198"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>canEqLeaf</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-199"></a>
<a name="line-200"></a><span class='hs-definition'>canEq</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc1</span> <span class='hs-varid'>tys1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc2</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span>
<a name="line-201"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isDecomposableTyCon</span> <span class='hs-varid'>tc1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isDecomposableTyCon</span> <span class='hs-varid'>tc2</span>
<a name="line-202"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tc1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tc2</span>
<a name="line-203"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys2</span>
<a name="line-204"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- Generate equalities for each of the corresponding arguments</span>
<a name="line-205"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>kis1</span><span class='hs-layout'>,</span>  <span class='hs-varid'>tys1'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>span</span> <span class='hs-varid'>isKind</span> <span class='hs-varid'>tys1</span>
<a name="line-206"></a>             <span class='hs-layout'>(</span><span class='hs-sel'>_kis2</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys2'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>span</span> <span class='hs-varid'>isKind</span> <span class='hs-varid'>tys2</span>
<a name="line-207"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>kicos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>mkTcReflCo</span> <span class='hs-varid'>kis1</span>
<a name="line-208"></a>
<a name="line-209"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>argeqvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWithM</span> <span class='hs-layout'>(</span><span class='hs-varid'>newEqVar</span> <span class='hs-varid'>fl</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys1'</span> <span class='hs-varid'>tys2'</span>
<a name="line-210"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>fls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>fl</span> <span class='hs-keyword'>of</span> 
<a name="line-211"></a>           <span class='hs-conid'>Wanted</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> 
<a name="line-212"></a>             <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setEqBind</span> <span class='hs-varid'>eqv</span>
<a name="line-213"></a>                         <span class='hs-layout'>(</span><span class='hs-varid'>mkTcTyConAppCo</span> <span class='hs-varid'>tc1</span> <span class='hs-layout'>(</span><span class='hs-varid'>kicos</span> <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcCoVarCo</span> <span class='hs-varop'>.</span> <span class='hs-varid'>evc_the_evvar</span><span class='hs-layout'>)</span> <span class='hs-varid'>argeqvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>fl</span>
<a name="line-214"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fl</span><span class='hs-layout'>)</span> <span class='hs-varid'>argeqvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-215"></a>           <span class='hs-conid'>Given</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-216"></a>             <span class='hs-keyword'>let</span> <span class='hs-varid'>do_one</span> <span class='hs-varid'>argeqv</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setEqBind</span> <span class='hs-layout'>(</span><span class='hs-varid'>evc_the_evvar</span> <span class='hs-varid'>argeqv</span><span class='hs-layout'>)</span> 
<a name="line-217"></a>                                             <span class='hs-layout'>(</span><span class='hs-varid'>mkTcNthCo</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcCoVarCo</span> <span class='hs-varid'>eqv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>fl</span>
<a name="line-218"></a>             <span class='hs-keyword'>in</span> <span class='hs-varid'>zipWithM</span> <span class='hs-varid'>do_one</span> <span class='hs-varid'>argeqvs</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>kicos</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>..</span><span class='hs-keyglyph'>]</span>
<a name="line-219"></a>           <span class='hs-conid'>Derived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fl</span><span class='hs-layout'>)</span> <span class='hs-varid'>argeqvs</span><span class='hs-layout'>)</span>
<a name="line-220"></a>
<a name="line-221"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>canEqEvVarsCreated</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fls</span> <span class='hs-varid'>argeqvs</span> <span class='hs-varid'>tys1'</span> <span class='hs-varid'>tys2'</span> <span class='hs-layout'>}</span>
<a name="line-222"></a>
<a name="line-223"></a><span class='hs-comment'>-- See Note [Equality between type applications]</span>
<a name="line-224"></a><span class='hs-comment'>--     Note [Care with type applications] in TcUnify</span>
<a name="line-225"></a><span class='hs-definition'>canEq</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-226"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty1</span>  <span class='hs-comment'>-- Naked applications ONLY</span>
<a name="line-227"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty2</span>  <span class='hs-comment'>-- See Note [Naked given applications]</span>
<a name="line-228"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>s1</span><span class='hs-layout'>,</span><span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSplitAppTy_maybe</span> <span class='hs-varid'>ty1</span>
<a name="line-229"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>s2</span><span class='hs-layout'>,</span><span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSplitAppTy_maybe</span> <span class='hs-varid'>ty2</span>
<a name="line-230"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isKind</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isKind</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-231"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>isGivenOrSolved</span> <span class='hs-varid'>fl</span> <span class='hs-keyword'>then</span> 
<a name="line-232"></a>        <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"canEq/(app case)"</span> <span class='hs-varop'>$</span>
<a name="line-233"></a>                <span class='hs-varid'>text</span> <span class='hs-str'>"Ommitting decomposition of given equality between: "</span> 
<a name="line-234"></a>                    <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"and"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2</span>
<a name="line-235"></a>                   <span class='hs-comment'>-- We cannot decompose given applications</span>
<a name="line-236"></a>                   <span class='hs-comment'>-- because we no longer have 'left' and 'right'</span>
<a name="line-237"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Stop</span> <span class='hs-layout'>}</span>
<a name="line-238"></a>    <span class='hs-keyword'>else</span>
<a name="line-239"></a>        <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>evc1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEqVar</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span>
<a name="line-240"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>evc2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEqVar</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-241"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>eqv1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evc_the_evvar</span> <span class='hs-varid'>evc1</span>
<a name="line-242"></a>                 <span class='hs-varid'>eqv2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evc_the_evvar</span> <span class='hs-varid'>evc2</span>
<a name="line-243"></a> 
<a name="line-244"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>isWanted</span> <span class='hs-varid'>fl</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-245"></a>                  <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setEqBind</span> <span class='hs-varid'>eqv</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcAppCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcCoVarCo</span> <span class='hs-varid'>eqv1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcCoVarCo</span> <span class='hs-varid'>eqv2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>fl</span>
<a name="line-246"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span> <span class='hs-layout'>}</span>
<a name="line-247"></a>           
<a name="line-248"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>canEqEvVarsCreated</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>fl</span><span class='hs-layout'>,</span><span class='hs-varid'>fl</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>evc1</span><span class='hs-layout'>,</span><span class='hs-varid'>evc2</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>s1</span><span class='hs-layout'>,</span><span class='hs-varid'>t1</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>s2</span><span class='hs-layout'>,</span><span class='hs-varid'>t2</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-249"></a>
<a name="line-250"></a>
<a name="line-251"></a><span class='hs-definition'>canEq</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>s1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>s2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-252"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tcIsForAllTy</span> <span class='hs-varid'>s1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcIsForAllTy</span> <span class='hs-varid'>s2</span><span class='hs-layout'>,</span> 
<a name="line-253"></a>   <span class='hs-conid'>Wanted</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fl</span> 
<a name="line-254"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>canEqFailure</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span>
<a name="line-255"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-256"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"Ommitting decomposition of given polytype equality"</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprEq</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span>
<a name="line-257"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Stop</span> <span class='hs-layout'>}</span>
<a name="line-258"></a>
<a name="line-259"></a><span class='hs-comment'>-- Finally expand any type synonym applications.</span>
<a name="line-260"></a><span class='hs-definition'>canEq</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>canEq</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2</span>
<a name="line-261"></a><span class='hs-definition'>canEq</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>canEq</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2'</span>
<a name="line-262"></a><span class='hs-definition'>canEq</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>                               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>canEqFailure</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span>
<a name="line-263"></a>
<a name="line-264"></a><a name="canEqFailure"></a><span class='hs-definition'>canEqFailure</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubGoalDepth</span> 
<a name="line-265"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>StopOrContinue</span>
<a name="line-266"></a><span class='hs-definition'>canEqFailure</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>emitFrozenError</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>d</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Stop</span> <span class='hs-layout'>}</span>
</pre>\end{code}

Note [Naked given applications]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider: 
   data A a 
   type T a = A a 
and the given equality:  
   [G] A a ~ T Int 
We will reach the case canEq where we do a tcSplitAppTy_maybe, but if
we dont have the guards (Nothing <- tcView ty1) (Nothing <- tcView
ty2) then the given equation is going to fall through and get
completely forgotten!

What we want instead is this clause to apply only when there is no
immediate top-level synonym; if there is one it will be later on
unfolded by the later stages of canEq.

Test-case is in typecheck/should_compile/GivenTypeSynonym.hs


Note [Equality between type applications]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we see an equality of the form s1 t1 ~ s2 t2 we can always split
it up into s1 ~ s2 /\ t1 ~ t2, since s1 and s2 can't be type
functions (type functions use the TyConApp constructor, which never
shows up as the LHS of an AppTy).  Other than type functions, types
in Haskell are always 

  (1) generative: a b ~ c d implies a ~ c, since different type
      constructors always generate distinct types

  (2) injective: a b ~ a d implies b ~ d; we never generate the
      same type from different type arguments.


Note [Canonical ordering for equality constraints]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Implemented as (<+=) below:

  - Type function applications always come before anything else.  
  - Variables always come before non-variables (other than type
      function applications).

Note that we don't need to unfold type synonyms on the RHS to check
the ordering; that is, in the rules above it's OK to consider only
whether something is *syntactically* a type function application or
not.  To illustrate why this is OK, suppose we have an equality of the
form 'tv ~ S a b c', where S is a type synonym which expands to a
top-level application of the type function F, something like

  type S a b c = F d e

Then to canonicalize 'tv ~ S a b c' we flatten the RHS, and since S's
expansion contains type function applications the flattener will do
the expansion and then generate a skolem variable for the type
function application, so we end up with something like this:

  tv ~ x
  F d e ~ x

where x is the skolem variable.  This is one extra equation than
absolutely necessary (we could have gotten away with just 'F d e ~ tv'
if we had noticed that S expanded to a top-level type function
application and flipped it around in the first place) but this way
keeps the code simpler.

Unlike the OutsideIn(X) draft of May 7, 2010, we do not care about the
ordering of tv ~ tv constraints.  There are several reasons why we
might:

  (1) In order to be able to extract a substitution that doesn't
      mention untouchable variables after we are done solving, we might
      prefer to put touchable variables on the left. However, in and
      of itself this isn't necessary; we can always re-orient equality
      constraints at the end if necessary when extracting a substitution.

  (2) To ensure termination we might think it necessary to put
      variables in lexicographic order. However, this isn't actually 
      necessary as outlined below.

While building up an inert set of canonical constraints, we maintain
the invariant that the equality constraints in the inert set form an
acyclic rewrite system when viewed as L-R rewrite rules.  Moreover,
the given constraints form an idempotent substitution (i.e. none of
the variables on the LHS occur in any of the RHS's, and type functions
never show up in the RHS at all), the wanted constraints also form an
idempotent substitution, and finally the LHS of a given constraint
never shows up on the RHS of a wanted constraint.  There may, however,
be a wanted LHS that shows up in a given RHS, since we do not rewrite
given constraints with wanted constraints.

Suppose we have an inert constraint set


  tg_1 ~ xig_1         -- givens
  tg_2 ~ xig_2
  ...
  tw_1 ~ xiw_1         -- wanteds
  tw_2 ~ xiw_2
  ...

where each t_i can be either a type variable or a type function
application. Now suppose we take a new canonical equality constraint,
t' ~ xi' (note among other things this means t' does not occur in xi')
and try to react it with the existing inert set.  We show by induction
on the number of t_i which occur in t' ~ xi' that this process will
terminate.

There are several ways t' ~ xi' could react with an existing constraint:

TODO: finish this proof.  The below was for the case where the entire
inert set is an idempotent subustitution...

(b) We could have t' = t_j for some j.  Then we obtain the new
    equality xi_j ~ xi'; note that neither xi_j or xi' contain t_j.  We
    now canonicalize the new equality, which may involve decomposing it
    into several canonical equalities, and recurse on these.  However,
    none of the new equalities will contain t_j, so they have fewer
    occurrences of the t_i than the original equation.

(a) We could have t_j occurring in xi' for some j, with t' /=
    t_j. Then we substitute xi_j for t_j in xi' and continue.  However,
    since none of the t_i occur in xi_j, we have decreased the
    number of t_i that occur in xi', since we eliminated t_j and did not
    introduce any new ones.

\begin{code}
<pre><a name="line-1"></a><a name="TypeClassifier"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TypeClassifier</span> 
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FskCls</span> <span class='hs-conid'>TcTyVar</span>      <span class='hs-comment'>-- ^ Flatten skolem </span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>VarCls</span> <span class='hs-conid'>TcTyVar</span>      <span class='hs-comment'>-- ^ Non-flatten-skolem variable </span>
<a name="line-4"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FunCls</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- ^ Type function, exactly saturated</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>OtherCls</span> <span class='hs-conid'>TcType</span>     <span class='hs-comment'>-- ^ Neither of the above</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-comment'>{- Useless these days! 
<a name="line-8"></a>unClassify :: TypeClassifier -&gt; TcType
<a name="line-9"></a>unClassify (VarCls tv)      = TyVarTy tv
<a name="line-10"></a>unClassify (FskCls tv) = TyVarTy tv 
<a name="line-11"></a>unClassify (FunCls fn tys)  = TyConApp fn tys
<a name="line-12"></a>unClassify (OtherCls ty)    = ty
<a name="line-13"></a>-}</span> 
<a name="line-14"></a>
<a name="line-15"></a><a name="classify"></a><span class='hs-definition'>classify</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TypeClassifier</span>
<a name="line-16"></a>
<a name="line-17"></a><span class='hs-definition'>classify</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> 
<a name="line-18"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> 
<a name="line-19"></a>    <span class='hs-conid'>FlatSkol</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FskCls</span> <span class='hs-varid'>tv</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VarCls</span> <span class='hs-varid'>tv</span>
<a name="line-21"></a><span class='hs-definition'>classify</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isSynFamilyTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-22"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span>
<a name="line-23"></a>                           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FunCls</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-24"></a><span class='hs-definition'>classify</span> <span class='hs-varid'>ty</span>                <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span>
<a name="line-25"></a>	                   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>classify</span> <span class='hs-varid'>ty'</span> <span class='hs-keyword'>of</span>
<a name="line-26"></a>                               <span class='hs-conid'>OtherCls</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OtherCls</span> <span class='hs-varid'>ty</span>
<a name="line-27"></a>                               <span class='hs-varid'>var_or_fn</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>var_or_fn</span>
<a name="line-28"></a>                           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> 
<a name="line-29"></a>                           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OtherCls</span> <span class='hs-varid'>ty</span>
<a name="line-30"></a>
<a name="line-31"></a><a name="reOrient"></a><span class='hs-comment'>-- See note [Canonical ordering for equality constraints].</span>
<a name="line-32"></a><span class='hs-definition'>reOrient</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TypeClassifier</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TypeClassifier</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>	
<a name="line-33"></a><span class='hs-comment'>-- (t1 `reOrient` t2) responds True </span>
<a name="line-34"></a><span class='hs-comment'>--   iff we should flip to (t2~t1)</span>
<a name="line-35"></a><span class='hs-comment'>-- We try to say False if possible, to minimise evidence generation</span>
<a name="line-36"></a><span class='hs-comment'>--</span>
<a name="line-37"></a><span class='hs-comment'>-- Postcondition: After re-orienting, first arg is not OTherCls</span>
<a name="line-38"></a><span class='hs-definition'>reOrient</span> <span class='hs-sel'>_fl</span> <span class='hs-layout'>(</span><span class='hs-conid'>OtherCls</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCls</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-39"></a><span class='hs-definition'>reOrient</span> <span class='hs-sel'>_fl</span> <span class='hs-layout'>(</span><span class='hs-conid'>OtherCls</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>FskCls</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-40"></a><span class='hs-definition'>reOrient</span> <span class='hs-sel'>_fl</span> <span class='hs-layout'>(</span><span class='hs-conid'>OtherCls</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarCls</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-41"></a><span class='hs-definition'>reOrient</span> <span class='hs-sel'>_fl</span> <span class='hs-layout'>(</span><span class='hs-conid'>OtherCls</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>OtherCls</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"reOrient"</span>  <span class='hs-comment'>-- One must be Var/Fun</span>
<a name="line-42"></a>
<a name="line-43"></a><span class='hs-definition'>reOrient</span> <span class='hs-sel'>_fl</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCls</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-layout'>(</span><span class='hs-conid'>VarCls</span> <span class='hs-sel'>_tv</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>  
<a name="line-44"></a>  <span class='hs-comment'>-- But consider the following variation: isGiven fl &amp;&amp; isMetaTyVar tv</span>
<a name="line-45"></a>
<a name="line-46"></a>  <span class='hs-comment'>-- See Note [No touchables as FunEq RHS] in TcSMonad</span>
<a name="line-47"></a><span class='hs-definition'>reOrient</span> <span class='hs-sel'>_fl</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCls</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>             <span class='hs-comment'>-- Fun/Other on rhs</span>
<a name="line-48"></a>
<a name="line-49"></a><span class='hs-definition'>reOrient</span> <span class='hs-sel'>_fl</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarCls</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCls</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> 
<a name="line-50"></a>
<a name="line-51"></a><span class='hs-definition'>reOrient</span> <span class='hs-sel'>_fl</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarCls</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>FskCls</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-52"></a>
<a name="line-53"></a><span class='hs-definition'>reOrient</span> <span class='hs-sel'>_fl</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarCls</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-layout'>(</span><span class='hs-conid'>OtherCls</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-54"></a><span class='hs-definition'>reOrient</span> <span class='hs-sel'>_fl</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarCls</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span>  <span class='hs-layout'>(</span><span class='hs-conid'>VarCls</span> <span class='hs-varid'>tv2</span><span class='hs-layout'>)</span>  
<a name="line-55"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>tv2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> 
<a name="line-56"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span> 
<a name="line-57"></a>  <span class='hs-comment'>-- Just for efficiency, see CTyEqCan invariants </span>
<a name="line-58"></a>
<a name="line-59"></a><span class='hs-definition'>reOrient</span> <span class='hs-sel'>_fl</span> <span class='hs-layout'>(</span><span class='hs-conid'>FskCls</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarCls</span> <span class='hs-varid'>tv2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>tv2</span> 
<a name="line-60"></a>  <span class='hs-comment'>-- Just for efficiency, see CTyEqCan invariants</span>
<a name="line-61"></a>
<a name="line-62"></a><span class='hs-definition'>reOrient</span> <span class='hs-sel'>_fl</span> <span class='hs-layout'>(</span><span class='hs-conid'>FskCls</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>FskCls</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-63"></a><span class='hs-definition'>reOrient</span> <span class='hs-sel'>_fl</span> <span class='hs-layout'>(</span><span class='hs-conid'>FskCls</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCls</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> 
<a name="line-64"></a><span class='hs-definition'>reOrient</span> <span class='hs-sel'>_fl</span> <span class='hs-layout'>(</span><span class='hs-conid'>FskCls</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>OtherCls</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span> 
<a name="line-65"></a>
<a name="line-66"></a><span class='hs-comment'>------------------</span>
<a name="line-67"></a>
<a name="line-68"></a><a name="canEqLeaf"></a><span class='hs-definition'>canEqLeaf</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-comment'>-- Depth</span>
<a name="line-69"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EqVar</span> 
<a name="line-70"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> 
<a name="line-71"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>StopOrContinue</span>
<a name="line-72"></a><span class='hs-comment'>-- Canonicalizing "leaf" equality constraints which cannot be</span>
<a name="line-73"></a><span class='hs-comment'>-- decomposed further (ie one of the types is a variable or</span>
<a name="line-74"></a><span class='hs-comment'>-- saturated type function application).  </span>
<a name="line-75"></a>
<a name="line-76"></a><span class='hs-comment'>-- Preconditions: </span>
<a name="line-77"></a><span class='hs-comment'>--    * one of the two arguments is variable or family applications</span>
<a name="line-78"></a><span class='hs-comment'>--    * the two types are not equal (looking through synonyms)</span>
<a name="line-79"></a><span class='hs-definition'>canEqLeaf</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span> 
<a name="line-80"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>cls1</span> <span class='hs-varop'>`re_orient`</span> <span class='hs-varid'>cls2</span>
<a name="line-81"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"canEqLeaf (reorienting)"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>eqv</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprEq</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span>
<a name="line-82"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>delCachedEvVar</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>fl</span>
<a name="line-83"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>evc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEqVar</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>s1</span>
<a name="line-84"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>eqv'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evc_the_evvar</span> <span class='hs-varid'>evc</span>
<a name="line-85"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>fl'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>fl</span> <span class='hs-keyword'>of</span> 
<a name="line-86"></a>           <span class='hs-conid'>Wanted</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>setEqBind</span> <span class='hs-varid'>eqv</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcSymCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcCoVarCo</span> <span class='hs-varid'>eqv'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>fl</span> 
<a name="line-87"></a>           <span class='hs-conid'>Given</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>setEqBind</span> <span class='hs-varid'>eqv'</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcSymCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcCoVarCo</span> <span class='hs-varid'>eqv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>fl</span> 
<a name="line-88"></a>           <span class='hs-conid'>Derived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>fl</span> 
<a name="line-89"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isNewEvVar</span> <span class='hs-varid'>evc</span> <span class='hs-keyword'>then</span> 
<a name="line-90"></a>             <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>canEqLeafOriented</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl'</span> <span class='hs-varid'>eqv'</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>s1</span> <span class='hs-layout'>}</span>
<a name="line-91"></a>         <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Stop</span> 
<a name="line-92"></a>       <span class='hs-layout'>}</span>
<a name="line-93"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-94"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"canEqLeaf"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkEqPred</span> <span class='hs-layout'>(</span><span class='hs-varid'>s1</span><span class='hs-layout'>,</span><span class='hs-varid'>s2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-95"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>canEqLeafOriented</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span> <span class='hs-layout'>}</span>
<a name="line-96"></a>  <span class='hs-keyword'>where</span>
<a name="line-97"></a>    <span class='hs-varid'>re_orient</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reOrient</span> <span class='hs-varid'>fl</span> 
<a name="line-98"></a>    <span class='hs-varid'>cls1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>classify</span> <span class='hs-varid'>s1</span>
<a name="line-99"></a>    <span class='hs-varid'>cls2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>classify</span> <span class='hs-varid'>s2</span>
<a name="line-100"></a>
<a name="line-101"></a><a name="canEqLeafOriented"></a><span class='hs-definition'>canEqLeafOriented</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-comment'>-- Depth</span>
<a name="line-102"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EqVar</span> 
<a name="line-103"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>StopOrContinue</span>
<a name="line-104"></a><span class='hs-comment'>-- By now s1 will either be a variable or a type family application</span>
<a name="line-105"></a><span class='hs-definition'>canEqLeafOriented</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span>
<a name="line-106"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>k1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>s1</span>
<a name="line-107"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>k2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>s2</span>
<a name="line-108"></a>  <span class='hs-comment'>-- Establish kind invariants for CFunEqCan and CTyEqCan</span>
<a name="line-109"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>are_compat</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>compatKindTcS</span> <span class='hs-varid'>k1</span> <span class='hs-varid'>k2</span>
<a name="line-110"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>can_unify</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>not</span> <span class='hs-varid'>are_compat</span>
<a name="line-111"></a>                      <span class='hs-keyword'>then</span> <span class='hs-varid'>unifyKindTcS</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span> <span class='hs-varid'>k1</span> <span class='hs-varid'>k2</span>
<a name="line-112"></a>                      <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>
<a name="line-113"></a>         <span class='hs-comment'>-- If the kinds cannot be unified or are not compatible, don't fail</span>
<a name="line-114"></a>         <span class='hs-comment'>-- right away; instead, emit a frozen error</span>
<a name="line-115"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varid'>are_compat</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>can_unify</span><span class='hs-layout'>)</span> <span class='hs-keyword'>then</span>
<a name="line-116"></a>             <span class='hs-varid'>canEqFailure</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span>
<a name="line-117"></a>         <span class='hs-keyword'>else</span> <span class='hs-varid'>can_eq_kinds_ok</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span> <span class='hs-layout'>}</span>
<a name="line-118"></a>
<a name="line-119"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>can_eq_kinds_ok</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span>
<a name="line-120"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>fn</span><span class='hs-layout'>,</span><span class='hs-varid'>tys1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>s1</span>
<a name="line-121"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>canEqLeafFunEqLeftRec</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span> <span class='hs-layout'>(</span><span class='hs-varid'>fn</span><span class='hs-layout'>,</span><span class='hs-varid'>tys1</span><span class='hs-layout'>)</span> <span class='hs-varid'>s2</span>
<a name="line-122"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTyVar_maybe</span> <span class='hs-varid'>s1</span>
<a name="line-123"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>canEqLeafTyVarLeftRec</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>s2</span>
<a name="line-124"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-125"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"canEqLeafOriented"</span> <span class='hs-varop'>$</span>
<a name="line-126"></a>            <span class='hs-varid'>text</span> <span class='hs-str'>"Non-variable or non-family equality LHS"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>eqv</span> <span class='hs-varop'>&lt;+&gt;</span> 
<a name="line-127"></a>                                                       <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>evVarPred</span> <span class='hs-varid'>eqv</span><span class='hs-layout'>)</span>
<a name="line-128"></a><a name="canEqLeafFunEqLeftRec"></a><span class='hs-definition'>canEqLeafFunEqLeftRec</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubGoalDepth</span>
<a name="line-129"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavor</span> 
<a name="line-130"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EqVar</span> 
<a name="line-131"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyCon</span><span class='hs-layout'>,</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>StopOrContinue</span>
<a name="line-132"></a><span class='hs-definition'>canEqLeafFunEqLeftRec</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span> <span class='hs-layout'>(</span><span class='hs-varid'>fn</span><span class='hs-layout'>,</span><span class='hs-varid'>tys1</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span>  <span class='hs-comment'>-- eqv :: F tys1 ~ ty2</span>
<a name="line-133"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"canEqLeafFunEqLeftRec"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>pprEq</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>tys1</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span>
<a name="line-134"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>xis1</span><span class='hs-layout'>,</span><span class='hs-varid'>cos1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> 
<a name="line-135"></a>           <span class='hs-comment'>{-# SCC "flattenMany" #-}</span>
<a name="line-136"></a>           <span class='hs-varid'>flattenMany</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>tys1</span> <span class='hs-comment'>-- Flatten type function arguments</span>
<a name="line-137"></a>                                 <span class='hs-comment'>-- cos1 :: xis1 ~ tys1</span>
<a name="line-138"></a>
<a name="line-139"></a><span class='hs-comment'>--       ; inerts &lt;- getTcSInerts</span>
<a name="line-140"></a><span class='hs-comment'>--        ; let fam_eqs   = inert_funeqs inerts</span>
<a name="line-141"></a>
<a name="line-142"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>flat_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>xis1</span>
<a name="line-143"></a>
<a name="line-144"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>is_cached</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCachedFlatEq</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>xis1</span> <span class='hs-varid'>fl</span> <span class='hs-conid'>WhenSolved</span>
<a name="line-145"></a>                      <span class='hs-comment'>-- Lookup if we have solved this goal already</span>
<a name="line-146"></a><span class='hs-comment'>{-
<a name="line-147"></a>       ; let is_cached = {-# SCC "lookupFunEq" #-} 
<a name="line-148"></a>                         lookupFunEq flat_ty fl fam_eqs
<a name="line-149"></a>-}</span>
<a name="line-150"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>no_flattening</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isTcReflCo</span> <span class='hs-varid'>cos1</span>
<a name="line-151"></a>                      
<a name="line-152"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>no_flattening</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isNothing</span> <span class='hs-varid'>is_cached</span> <span class='hs-keyword'>then</span> 
<a name="line-153"></a>             <span class='hs-varid'>canEqLeafFunEqLeft</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span> <span class='hs-layout'>(</span><span class='hs-varid'>fn</span><span class='hs-layout'>,</span><span class='hs-varid'>xis1</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span>
<a name="line-154"></a>         <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-155"></a>       <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>final_co</span><span class='hs-layout'>,</span> <span class='hs-varid'>final_ty</span><span class='hs-layout'>)</span>
<a name="line-156"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>no_flattening</span>        <span class='hs-comment'>-- Just in inerts</span>
<a name="line-157"></a>                 <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>rhs_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ret_eq</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>is_cached</span>
<a name="line-158"></a>                 <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcSymCo</span> <span class='hs-varid'>ret_eq</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_ty</span><span class='hs-layout'>)</span>
<a name="line-159"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>is_cached</span> <span class='hs-comment'>-- Just flattening</span>
<a name="line-160"></a>                 <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcTyConAppCo</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>cos1</span><span class='hs-layout'>,</span> <span class='hs-varid'>flat_ty</span><span class='hs-layout'>)</span>
<a name="line-161"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>rhs_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ret_eq</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>is_cached</span>  <span class='hs-comment'>-- Both</span>
<a name="line-162"></a>                 <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcSymCo</span> <span class='hs-varid'>ret_eq</span> <span class='hs-varop'>`mkTcTransCo`</span> <span class='hs-varid'>mkTcTyConAppCo</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>cos1</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_ty</span><span class='hs-layout'>)</span>
<a name="line-163"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"No flattening and not cached!"</span>
<a name="line-164"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>delCachedEvVar</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>fl</span>
<a name="line-165"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>evc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEqVar</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>final_ty</span> <span class='hs-varid'>ty2</span>
<a name="line-166"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>new_eqv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evc_the_evvar</span> <span class='hs-varid'>evc</span>
<a name="line-167"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>fl'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>fl</span> <span class='hs-keyword'>of</span>
<a name="line-168"></a>           <span class='hs-conid'>Wanted</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>setEqBind</span> <span class='hs-varid'>eqv</span> 
<a name="line-169"></a>                           <span class='hs-layout'>(</span><span class='hs-varid'>mkTcSymCo</span> <span class='hs-varid'>final_co</span> <span class='hs-varop'>`mkTcTransCo`</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcCoVarCo</span> <span class='hs-varid'>new_eqv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>fl</span>
<a name="line-170"></a>           <span class='hs-conid'>Given</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>setEqBind</span> <span class='hs-varid'>new_eqv</span> <span class='hs-layout'>(</span><span class='hs-varid'>final_co</span> <span class='hs-varop'>`mkTcTransCo`</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcCoVarCo</span> <span class='hs-varid'>eqv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>fl</span>
<a name="line-171"></a>           <span class='hs-conid'>Derived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>fl</span>
<a name="line-172"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isNewEvVar</span> <span class='hs-varid'>evc</span> <span class='hs-keyword'>then</span>
<a name="line-173"></a>             <span class='hs-keyword'>if</span> <span class='hs-varid'>isNothing</span> <span class='hs-varid'>is_cached</span> <span class='hs-keyword'>then</span>
<a name="line-174"></a>                 <span class='hs-comment'>{-# SCC "canEqLeafFunEqLeft" #-}</span>
<a name="line-175"></a>                 <span class='hs-varid'>canEqLeafFunEqLeft</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl'</span> <span class='hs-varid'>new_eqv</span> <span class='hs-layout'>(</span><span class='hs-varid'>fn</span><span class='hs-layout'>,</span><span class='hs-varid'>xis1</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span>
<a name="line-176"></a>             <span class='hs-keyword'>else</span>
<a name="line-177"></a>                 <span class='hs-varid'>canEq</span> <span class='hs-layout'>(</span><span class='hs-varid'>d</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>fl'</span> <span class='hs-varid'>new_eqv</span> <span class='hs-varid'>final_ty</span> <span class='hs-varid'>ty2</span>
<a name="line-178"></a>         <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Stop</span>
<a name="line-179"></a>       <span class='hs-layout'>}</span>
<a name="line-180"></a>       <span class='hs-layout'>}</span>
<a name="line-181"></a>
<a name="line-182"></a><a name="lookupFunEq"></a><span class='hs-definition'>lookupFunEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TypeMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcCoercion</span><span class='hs-layout'>)</span>
<a name="line-183"></a><span class='hs-definition'>lookupFunEq</span> <span class='hs-varid'>pty</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>fam_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookup_funeq</span> <span class='hs-varid'>pty</span> <span class='hs-varid'>fam_eqs</span>
<a name="line-184"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>lookup_funeq</span> <span class='hs-varid'>pty</span> <span class='hs-varid'>fam_eqs</span>
<a name="line-185"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupTM</span> <span class='hs-varid'>pty</span> <span class='hs-varid'>fam_eqs</span>
<a name="line-186"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>cc_flavor</span> <span class='hs-varid'>ct</span> <span class='hs-varop'>`canRewrite`</span> <span class='hs-varid'>fl</span> 
<a name="line-187"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_rhs</span> <span class='hs-varid'>ct</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcCoVarCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_id</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-188"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> 
<a name="line-189"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-190"></a>
<a name="line-191"></a><a name="canEqLeafFunEqLeft"></a><span class='hs-definition'>canEqLeafFunEqLeft</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-comment'>-- Depth</span>
<a name="line-192"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EqVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyCon</span><span class='hs-layout'>,</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Xi</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> 
<a name="line-193"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>StopOrContinue</span>
<a name="line-194"></a><span class='hs-comment'>-- Precondition: No more flattening is needed for the LHS</span>
<a name="line-195"></a><span class='hs-definition'>canEqLeafFunEqLeft</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span> <span class='hs-layout'>(</span><span class='hs-varid'>fn</span><span class='hs-layout'>,</span><span class='hs-varid'>xis1</span><span class='hs-layout'>)</span> <span class='hs-varid'>s2</span>
<a name="line-196"></a> <span class='hs-keyglyph'>=</span> <span class='hs-comment'>{-# SCC "canEqLeafFunEqLeft" #-}</span>
<a name="line-197"></a>   <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"canEqLeafFunEqLeft"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>pprEq</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>xis1</span><span class='hs-layout'>)</span> <span class='hs-varid'>s2</span>
<a name="line-198"></a>      <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>xi2</span><span class='hs-layout'>,</span><span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> 
<a name="line-199"></a>          <span class='hs-comment'>{-# SCC "flatten" #-}</span> 
<a name="line-200"></a>          <span class='hs-varid'>flatten</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>s2</span> <span class='hs-comment'>-- co2 :: xi2 ~ s2</span>
<a name="line-201"></a>      <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>no_flattening_happened</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isTcReflCo</span> <span class='hs-varid'>co2</span>
<a name="line-202"></a>      <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>no_flattening_happened</span> <span class='hs-keyword'>then</span> 
<a name="line-203"></a>            <span class='hs-varid'>continueWith</span> <span class='hs-varop'>$</span> <span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_id</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqv</span>
<a name="line-204"></a>                                     <span class='hs-layout'>,</span> <span class='hs-varid'>cc_flavor</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fl</span>
<a name="line-205"></a>                                     <span class='hs-layout'>,</span> <span class='hs-varid'>cc_fun</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fn</span>
<a name="line-206"></a>                                     <span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xis1</span> 
<a name="line-207"></a>                                     <span class='hs-layout'>,</span> <span class='hs-varid'>cc_rhs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xi2</span> 
<a name="line-208"></a>                                     <span class='hs-layout'>,</span> <span class='hs-varid'>cc_depth</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span> <span class='hs-layout'>}</span>
<a name="line-209"></a>        <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>delCachedEvVar</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>fl</span>
<a name="line-210"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>evc</span> <span class='hs-keyglyph'>&lt;-</span> 
<a name="line-211"></a>                    <span class='hs-comment'>{-# SCC "newEqVar" #-}</span>
<a name="line-212"></a>                    <span class='hs-varid'>newEqVar</span> <span class='hs-varid'>fl</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>xis1</span><span class='hs-layout'>)</span> <span class='hs-varid'>xi2</span>
<a name="line-213"></a>                <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>new_eqv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evc_the_evvar</span> <span class='hs-varid'>evc</span> <span class='hs-comment'>-- F xis1 ~ xi2 </span>
<a name="line-214"></a>                      <span class='hs-varid'>new_cv</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcCoVarCo</span> <span class='hs-varid'>new_eqv</span>
<a name="line-215"></a>                      <span class='hs-varid'>cv</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcCoVarCo</span> <span class='hs-varid'>eqv</span>    <span class='hs-comment'>-- F xis1 ~ s2</span>
<a name="line-216"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>fl'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>fl</span> <span class='hs-keyword'>of</span>
<a name="line-217"></a>                    <span class='hs-conid'>Wanted</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>setEqBind</span> <span class='hs-varid'>eqv</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_cv</span> <span class='hs-varop'>`mkTcTransCo`</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-varid'>fl</span> 
<a name="line-218"></a>                    <span class='hs-conid'>Given</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>setEqBind</span> <span class='hs-varid'>new_eqv</span> <span class='hs-layout'>(</span><span class='hs-varid'>cv</span> <span class='hs-varop'>`mkTcTransCo`</span> <span class='hs-varid'>mkTcSymCo</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-varid'>fl</span>
<a name="line-219"></a>                    <span class='hs-conid'>Derived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>fl</span>
<a name="line-220"></a>                <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isNewEvVar</span> <span class='hs-varid'>evc</span> <span class='hs-keyword'>then</span> 
<a name="line-221"></a>                      <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>continueWith</span> <span class='hs-varop'>$</span>
<a name="line-222"></a>                           <span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_eqv</span>
<a name="line-223"></a>                                     <span class='hs-layout'>,</span> <span class='hs-varid'>cc_flavor</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fl'</span>
<a name="line-224"></a>                                     <span class='hs-layout'>,</span> <span class='hs-varid'>cc_fun</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fn</span>
<a name="line-225"></a>                                     <span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xis1</span> 
<a name="line-226"></a>                                     <span class='hs-layout'>,</span> <span class='hs-varid'>cc_rhs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xi2</span> 
<a name="line-227"></a>                                     <span class='hs-layout'>,</span> <span class='hs-varid'>cc_depth</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-228"></a>                  <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Stop</span> <span class='hs-layout'>}</span>  <span class='hs-layout'>}</span>
<a name="line-229"></a>
<a name="line-230"></a>
<a name="line-231"></a><a name="canEqLeafTyVarLeftRec"></a><span class='hs-definition'>canEqLeafTyVarLeftRec</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubGoalDepth</span>
<a name="line-232"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EqVar</span>
<a name="line-233"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>StopOrContinue</span>
<a name="line-234"></a><span class='hs-definition'>canEqLeafTyVarLeftRec</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>s2</span>              <span class='hs-comment'>-- eqv :: tv ~ s2</span>
<a name="line-235"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>  <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"canEqLeafTyVarLeftRec"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>pprEq</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>s2</span>
<a name="line-236"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>xi1</span><span class='hs-layout'>,</span><span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>flatten</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- co1 :: xi1 ~ tv</span>
<a name="line-237"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>isTcReflCo</span> <span class='hs-varid'>co1</span> <span class='hs-keyword'>of</span> 
<a name="line-238"></a>             <span class='hs-conid'>True</span> <span class='hs-comment'>-- If reflco and variable, just go on</span>
<a name="line-239"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tv'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTyVar_maybe</span> <span class='hs-varid'>xi1</span> 
<a name="line-240"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>canEqLeafTyVarLeft</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>tv'</span> <span class='hs-varid'>s2</span>
<a name="line-241"></a>             <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-comment'>-- If not a variable or not refl co, must rewrite and go on</span>
<a name="line-242"></a>               <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>delCachedEvVar</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>fl</span>
<a name="line-243"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>evc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEqVar</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>xi1</span> <span class='hs-varid'>s2</span>  <span class='hs-comment'>-- new_ev :: xi1 ~ s2</span>
<a name="line-244"></a>                  <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>new_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evc_the_evvar</span> <span class='hs-varid'>evc</span>
<a name="line-245"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>fl'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>fl</span> <span class='hs-keyword'>of</span> 
<a name="line-246"></a>                    <span class='hs-conid'>Wanted</span>  <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>setEqBind</span> <span class='hs-varid'>eqv</span> 
<a name="line-247"></a>                                    <span class='hs-layout'>(</span><span class='hs-varid'>mkTcSymCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`mkTcTransCo`</span> <span class='hs-varid'>mkTcCoVarCo</span> <span class='hs-varid'>new_ev</span><span class='hs-layout'>)</span> <span class='hs-varid'>fl</span>
<a name="line-248"></a>                    <span class='hs-conid'>Given</span>   <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>setEqBind</span> <span class='hs-varid'>new_ev</span>
<a name="line-249"></a>                                    <span class='hs-layout'>(</span><span class='hs-varid'>co1</span> <span class='hs-varop'>`mkTcTransCo`</span> <span class='hs-varid'>mkTcCoVarCo</span> <span class='hs-varid'>eqv</span><span class='hs-layout'>)</span> <span class='hs-varid'>fl</span>
<a name="line-250"></a>                    <span class='hs-conid'>Derived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>fl</span>
<a name="line-251"></a>                  <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isNewEvVar</span> <span class='hs-varid'>evc</span> <span class='hs-keyword'>then</span>
<a name="line-252"></a>                      <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>canEq</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl'</span> <span class='hs-varid'>new_ev</span> <span class='hs-varid'>xi1</span> <span class='hs-varid'>s2</span> <span class='hs-layout'>}</span>
<a name="line-253"></a>                    <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Stop</span>
<a name="line-254"></a>                  <span class='hs-layout'>}</span>
<a name="line-255"></a>       <span class='hs-layout'>}</span>
<a name="line-256"></a>
<a name="line-257"></a><a name="canEqLeafTyVarLeft"></a><span class='hs-definition'>canEqLeafTyVarLeft</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-comment'>-- Depth</span>
<a name="line-258"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EqVar</span>
<a name="line-259"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>StopOrContinue</span>
<a name="line-260"></a><span class='hs-comment'>-- Precondition LHS is fully rewritten from inerts (but not RHS)</span>
<a name="line-261"></a><span class='hs-definition'>canEqLeafTyVarLeft</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>s2</span>       <span class='hs-comment'>-- eqv : tv ~ s2</span>
<a name="line-262"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"canEqLeafTyVarLeft"</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprEq</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>s2</span><span class='hs-layout'>)</span>
<a name="line-263"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>xi2</span><span class='hs-layout'>,</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>flatten</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>s2</span>   <span class='hs-comment'>-- Flatten RHS   co : xi2 ~ s2</span>
<a name="line-264"></a>                                               
<a name="line-265"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>no_flattening_happened</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isTcReflCo</span> <span class='hs-varid'>co</span>
<a name="line-266"></a>             
<a name="line-267"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"canEqLeafTyVarLeft"</span> <span class='hs-layout'>(</span><span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"tv  ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span>
<a name="line-268"></a>                                                     <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"s2  ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>s2</span>
<a name="line-269"></a>                                                     <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"xi2 ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>xi2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-270"></a>
<a name="line-271"></a>                      <span class='hs-comment'>-- Flattening the RHS may reveal an identity coercion, which should</span>
<a name="line-272"></a>                      <span class='hs-comment'>-- not be reported as occurs check error! </span>
<a name="line-273"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>is_same_tv</span>
<a name="line-274"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tv'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTyVar_maybe</span> <span class='hs-varid'>xi2</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tv</span>
<a name="line-275"></a>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-276"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-277"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>is_same_tv</span> <span class='hs-keyword'>then</span>
<a name="line-278"></a>             <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>delCachedEvVar</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>fl</span>
<a name="line-279"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>isWanted</span> <span class='hs-varid'>fl</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> 
<a name="line-280"></a>                       <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setEqBind</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>co</span> <span class='hs-varid'>fl</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span> <span class='hs-layout'>}</span>
<a name="line-281"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Stop</span> <span class='hs-layout'>}</span>
<a name="line-282"></a>         <span class='hs-keyword'>else</span>
<a name="line-283"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- Do an occurs check, and return a possibly</span>
<a name="line-284"></a>         <span class='hs-comment'>-- unfolded version of the RHS, if we had to </span>
<a name="line-285"></a>         <span class='hs-comment'>-- unfold any type synonyms to get rid of tv.</span>
<a name="line-286"></a>         <span class='hs-varid'>occ_check_result</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>canOccursCheck</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>xi2</span>
<a name="line-287"></a>
<a name="line-288"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>xi2'</span>
<a name="line-289"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>xi2_unfolded</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>occ_check_result</span>
<a name="line-290"></a>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xi2_unfolded</span>
<a name="line-291"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xi2</span>
<a name="line-292"></a>
<a name="line-293"></a>
<a name="line-294"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>no_flattening_happened</span> <span class='hs-keyword'>then</span>
<a name="line-295"></a>             <span class='hs-keyword'>if</span> <span class='hs-varid'>isNothing</span> <span class='hs-varid'>occ_check_result</span> <span class='hs-keyword'>then</span> 
<a name="line-296"></a>                 <span class='hs-varid'>canEqFailure</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-layout'>(</span><span class='hs-varid'>setVarType</span> <span class='hs-varid'>eqv</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkEqPred</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>xi2'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-297"></a>             <span class='hs-keyword'>else</span> 
<a name="line-298"></a>                 <span class='hs-varid'>continueWith</span> <span class='hs-varop'>$</span> <span class='hs-conid'>CTyEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_id</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqv</span>
<a name="line-299"></a>                                         <span class='hs-layout'>,</span> <span class='hs-varid'>cc_flavor</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fl</span>
<a name="line-300"></a>                                         <span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyvar</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv</span>
<a name="line-301"></a>                                         <span class='hs-layout'>,</span> <span class='hs-varid'>cc_rhs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xi2'</span>
<a name="line-302"></a>                                         <span class='hs-layout'>,</span> <span class='hs-varid'>cc_depth</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span> <span class='hs-layout'>}</span>
<a name="line-303"></a>         <span class='hs-keyword'>else</span> <span class='hs-comment'>-- Flattening happened, in any case we have to create new variable </span>
<a name="line-304"></a>              <span class='hs-comment'>-- even if we report an occurs check error</span>
<a name="line-305"></a>             <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>delCachedEvVar</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>fl</span>
<a name="line-306"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>evc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEqVar</span> <span class='hs-varid'>fl</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>xi2'</span> 
<a name="line-307"></a>                <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>eqv'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evc_the_evvar</span> <span class='hs-varid'>evc</span> <span class='hs-comment'>-- eqv' : tv ~ xi2'</span>
<a name="line-308"></a>                      <span class='hs-varid'>cv</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcCoVarCo</span> <span class='hs-varid'>eqv</span>    <span class='hs-comment'>-- cv : tv ~ s2</span>
<a name="line-309"></a>                      <span class='hs-varid'>cv'</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcCoVarCo</span> <span class='hs-varid'>eqv'</span>   <span class='hs-comment'>-- cv': tv ~ xi2'</span>
<a name="line-310"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>fl'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>fl</span> <span class='hs-keyword'>of</span> 
<a name="line-311"></a>                     <span class='hs-conid'>Wanted</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>setEqBind</span> <span class='hs-varid'>eqv</span> <span class='hs-layout'>(</span><span class='hs-varid'>cv'</span> <span class='hs-varop'>`mkTcTransCo`</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>fl</span>         <span class='hs-comment'>-- tv ~ xi2' ~ s2</span>
<a name="line-312"></a>                     <span class='hs-conid'>Given</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>setEqBind</span> <span class='hs-varid'>eqv'</span> <span class='hs-layout'>(</span><span class='hs-varid'>cv</span> <span class='hs-varop'>`mkTcTransCo`</span> <span class='hs-varid'>mkTcSymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>fl</span> <span class='hs-comment'>-- tv ~ s2 ~ xi2'</span>
<a name="line-313"></a>                     <span class='hs-conid'>Derived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>fl</span>
<a name="line-314"></a>
<a name="line-315"></a>                 <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isNewEvVar</span> <span class='hs-varid'>evc</span> <span class='hs-keyword'>then</span> 
<a name="line-316"></a>                       <span class='hs-keyword'>if</span> <span class='hs-varid'>isNothing</span> <span class='hs-varid'>occ_check_result</span> <span class='hs-keyword'>then</span> 
<a name="line-317"></a>                           <span class='hs-varid'>canEqFailure</span> <span class='hs-varid'>d</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>eqv'</span>
<a name="line-318"></a>                       <span class='hs-keyword'>else</span> <span class='hs-varid'>continueWith</span> <span class='hs-conid'>CTyEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_id</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqv'</span>
<a name="line-319"></a>                                                  <span class='hs-layout'>,</span> <span class='hs-varid'>cc_flavor</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fl'</span>
<a name="line-320"></a>                                                  <span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyvar</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv</span>
<a name="line-321"></a>                                                  <span class='hs-layout'>,</span> <span class='hs-varid'>cc_rhs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xi2'</span> 
<a name="line-322"></a>                                                  <span class='hs-layout'>,</span> <span class='hs-varid'>cc_depth</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span> <span class='hs-layout'>}</span>
<a name="line-323"></a>                   <span class='hs-keyword'>else</span> 
<a name="line-324"></a>                       <span class='hs-varid'>return</span> <span class='hs-conid'>Stop</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-325"></a>
<a name="line-326"></a>
<a name="line-327"></a><a name="canOccursCheck"></a><span class='hs-comment'>-- See Note [Type synonyms and canonicalization].</span>
<a name="line-328"></a><span class='hs-comment'>-- Check whether the given variable occurs in the given type.  We may</span>
<a name="line-329"></a><span class='hs-comment'>-- have needed to do some type synonym unfolding in order to get rid</span>
<a name="line-330"></a><span class='hs-comment'>-- of the variable, so we also return the unfolded version of the</span>
<a name="line-331"></a><span class='hs-comment'>-- type, which is guaranteed to be syntactically free of the given</span>
<a name="line-332"></a><span class='hs-comment'>-- type variable.  If the type is already syntactically free of the</span>
<a name="line-333"></a><span class='hs-comment'>-- variable, then the same type is returned.</span>
<a name="line-334"></a><span class='hs-comment'>--</span>
<a name="line-335"></a><span class='hs-comment'>-- Precondition: the two types are not equal (looking though synonyms)</span>
<a name="line-336"></a><span class='hs-definition'>canOccursCheck</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Xi</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Xi</span><span class='hs-layout'>)</span>
<a name="line-337"></a><span class='hs-definition'>canOccursCheck</span> <span class='hs-sel'>_gw</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>xi</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>expandAway</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>xi</span><span class='hs-layout'>)</span>
</pre>\end{code}

@expandAway tv xi@ expands synonyms in xi just enough to get rid of
occurrences of tv, if that is possible; otherwise, it returns Nothing.
For example, suppose we have
  type F a b = [a]
Then
  expandAway b (F Int b) = Just [Int]
but
  expandAway a (F a Int) = Nothing

We don't promise to do the absolute minimum amount of expanding
necessary, but we try not to do expansions we don't need to.  We
prefer doing inner expansions first.  For example,
  type F a b = (a, Int, a, [a])
  type G b   = Char
We have
  expandAway b (F (G b)) = F Char
even though we could also expand F to get rid of b.

\begin{code}
<pre><a name="line-1"></a><a name="expandAway"></a><span class='hs-definition'>expandAway</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Xi</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Xi</span>
<a name="line-2"></a><span class='hs-definition'>expandAway</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>t</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tv'</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>t</span>
<a name="line-5"></a><span class='hs-definition'>expandAway</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>xi</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>xi</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>xi</span>
<a name="line-7"></a><span class='hs-definition'>expandAway</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> 
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>expandAway</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty1</span>
<a name="line-9"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>expandAway</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty2</span> 
<a name="line-10"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppTy</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-11"></a><span class='hs-comment'>-- mkAppTy &lt;$&gt; expandAway tv ty1 &lt;*&gt; expandAway tv ty2</span>
<a name="line-12"></a><span class='hs-definition'>expandAway</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>expandAway</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty1</span> 
<a name="line-14"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>expandAway</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty2</span> 
<a name="line-15"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> 
<a name="line-16"></a><span class='hs-comment'>-- mkFunTy &lt;$&gt; expandAway tv ty1 &lt;*&gt; expandAway tv ty2</span>
<a name="line-17"></a><span class='hs-definition'>expandAway</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> 
<a name="line-18"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span><span class='hs-varid'>rho</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitForAllTys</span> <span class='hs-varid'>ty</span>
<a name="line-19"></a>        <span class='hs-varid'>tvs_knds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tvs</span> 
<a name="line-20"></a>    <span class='hs-keyword'>in</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>tyVarsOfTypes</span> <span class='hs-varid'>tvs_knds</span> <span class='hs-keyword'>then</span>
<a name="line-21"></a>       <span class='hs-comment'>-- Can't expand away the kinds unless we create </span>
<a name="line-22"></a>       <span class='hs-comment'>-- fresh variables which we don't want to do at this point.</span>
<a name="line-23"></a>           <span class='hs-conid'>Nothing</span> 
<a name="line-24"></a>       <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rho'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>expandAway</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>rho</span>
<a name="line-25"></a>               <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkForAllTys</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>rho'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-26"></a><span class='hs-comment'>-- For a type constructor application, first try expanding away the</span>
<a name="line-27"></a><span class='hs-comment'>-- offending variable from the arguments.  If that doesn't work, next</span>
<a name="line-28"></a><span class='hs-comment'>-- see if the type constructor is a type synonym, and if so, expand</span>
<a name="line-29"></a><span class='hs-comment'>-- it and try again.</span>
<a name="line-30"></a><span class='hs-definition'>expandAway</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-31"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>expandAway</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;|&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>expandAway</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-32"></a>
</pre>\end{code}

Note [Type synonyms and canonicalization]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

We treat type synonym applications as xi types, that is, they do not
count as type function applications.  However, we do need to be a bit
careful with type synonyms: like type functions they may not be
generative or injective.  However, unlike type functions, they are
parametric, so there is no problem in expanding them whenever we see
them, since we do not need to know anything about their arguments in
order to expand them; this is what justifies not having to treat them
as specially as type function applications.  The thing that causes
some subtleties is that we prefer to leave type synonym applications
*unexpanded* whenever possible, in order to generate better error
messages.

If we encounter an equality constraint with type synonym applications
on both sides, or a type synonym application on one side and some sort
of type application on the other, we simply must expand out the type
synonyms in order to continue decomposing the equality constraint into
primitive equality constraints.  For example, suppose we have

  type F a = [Int]

and we encounter the equality

  F a ~ [b]

In order to continue we must expand F a into [Int], giving us the
equality

  [Int] ~ [b]

which we can then decompose into the more primitive equality
constraint

  Int ~ b.

However, if we encounter an equality constraint with a type synonym
application on one side and a variable on the other side, we should
NOT (necessarily) expand the type synonym, since for the purpose of
good error messages we want to leave type synonyms unexpanded as much
as possible.

However, there is a subtle point with type synonyms and the occurs
check that takes place for equality constraints of the form tv ~ xi.
As an example, suppose we have

  type F a = Int

and we come across the equality constraint

  a ~ F a

This should not actually fail the occurs check, since expanding out
the type synonym results in the legitimate equality constraint a ~
Int.  We must actually do this expansion, because unifying a with F a
will lead the type checker into infinite loops later.  Put another
way, canonical equality constraints should never *syntactically*
contain the LHS variable in the RHS type.  However, we don't always
need to expand type synonyms when doing an occurs check; for example,
the constraint

  a ~ F b

is obviously fine no matter what F expands to. And in this case we
would rather unify a with F b (rather than F b's expansion) in order
to get better error messages later.

So, when doing an occurs check with a type synonym application on the
RHS, we use some heuristics to find an expansion of the RHS which does
not contain the variable from the LHS.  In particular, given

  a ~ F t1 ... tn

we first try expanding each of the ti to types which no longer contain
a.  If this turns out to be impossible, we next try expanding F
itself, and so on.


%************************************************************************
%*                                                                      *
%*          Functional dependencies, instantiation of equations
%*                                                                      *
%************************************************************************

When we spot an equality arising from a functional dependency,
we now use that equality (a "wanted") to rewrite the work-item
constraint right away.  This avoids two dangers

 Danger 1: If we send the original constraint on down the pipeline
           it may react with an instance declaration, and in delicate
	   situations (when a Given overlaps with an instance) that
	   may produce new insoluble goals: see Trac #4952

 Danger 2: If we don't rewrite the constraint, it may re-react
           with the same thing later, and produce the same equality
           again --> termination worries.

To achieve this required some refactoring of FunDeps.lhs (nicer
now!).  

\begin{code}
<pre><a name="line-1"></a><a name="rewriteWithFunDeps"></a><span class='hs-definition'>rewriteWithFunDeps</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Equation</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Xi</span><span class='hs-keyglyph'>]</span> 
<a name="line-3"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedLoc</span> 
<a name="line-4"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Xi</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcCoercion</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>EvVar</span><span class='hs-layout'>,</span><span class='hs-conid'>WantedLoc</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-5"></a>                                           <span class='hs-comment'>-- Not quite a WantedEvVar unfortunately</span>
<a name="line-6"></a>                                           <span class='hs-comment'>-- Because our intention could be to make </span>
<a name="line-7"></a>                                           <span class='hs-comment'>-- it derived at the end of the day</span>
<a name="line-8"></a><span class='hs-comment'>-- NB: The flavor of the returned EvVars will be decided by the caller</span>
<a name="line-9"></a><span class='hs-comment'>-- Post: returns no trivial equalities (identities) and all EvVars returned are fresh</span>
<a name="line-10"></a><span class='hs-definition'>rewriteWithFunDeps</span> <span class='hs-varid'>eqn_pred_locs</span> <span class='hs-varid'>xis</span> <span class='hs-varid'>wloc</span>
<a name="line-11"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fd_ev_poss</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>instFunDepEqn</span> <span class='hs-varid'>wloc</span><span class='hs-layout'>)</span> <span class='hs-varid'>eqn_pred_locs</span>
<a name="line-12"></a>      <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>fd_ev_pos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-conid'>EqVar</span><span class='hs-layout'>,</span><span class='hs-conid'>WantedLoc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-13"></a>            <span class='hs-varid'>fd_ev_pos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concat</span> <span class='hs-varid'>fd_ev_poss</span>
<a name="line-14"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>rewritten_xis</span><span class='hs-layout'>,</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip</span> <span class='hs-layout'>(</span><span class='hs-varid'>rewriteDictParams</span> <span class='hs-varid'>fd_ev_pos</span> <span class='hs-varid'>xis</span><span class='hs-layout'>)</span>
<a name="line-15"></a>      <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>fd_ev_pos</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-16"></a>        <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>rewritten_xis</span><span class='hs-layout'>,</span> <span class='hs-varid'>cos</span><span class='hs-layout'>,</span> <span class='hs-varid'>map</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>fd_ev_pos</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="instFunDepEqn"></a><span class='hs-definition'>instFunDepEqn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Equation</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-conid'>EvVar</span><span class='hs-layout'>,</span><span class='hs-conid'>WantedLoc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-19"></a><span class='hs-comment'>-- Post: Returns the position index as well as the corresponding FunDep equality</span>
<a name="line-20"></a><span class='hs-definition'>instFunDepEqn</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>(</span><span class='hs-conid'>FDEqn</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fd_qtvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>qtvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>fd_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs</span>
<a name="line-21"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>fd_pred1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d1</span><span class='hs-layout'>,</span> <span class='hs-varid'>fd_pred2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d2</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-22"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>varSetElems</span> <span class='hs-varid'>qtvs</span>
<a name="line-23"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tvs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>instFlexiTcS</span> <span class='hs-varid'>tvs</span>  <span class='hs-comment'>-- IA0_TODO: we might need to do kind substitution</span>
<a name="line-24"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipTopTvSubst</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>)</span>
<a name="line-25"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>foldM</span> <span class='hs-layout'>(</span><span class='hs-varid'>do_one</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>eqs</span> <span class='hs-layout'>}</span>
<a name="line-26"></a>  <span class='hs-keyword'>where</span> 
<a name="line-27"></a>    <span class='hs-varid'>do_one</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ievs</span> <span class='hs-layout'>(</span><span class='hs-conid'>FDEq</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fd_pos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>fd_ty_left</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>fd_ty_right</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty2</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-28"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>sty1</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty1</span> 
<a name="line-29"></a>             <span class='hs-varid'>sty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty2</span> 
<a name="line-30"></a>         <span class='hs-keyword'>in</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>eqType</span> <span class='hs-varid'>sty1</span> <span class='hs-varid'>sty2</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ievs</span> <span class='hs-comment'>-- Return no trivial equalities</span>
<a name="line-31"></a>            <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>eqv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEqVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>Derived</span> <span class='hs-varid'>wl</span><span class='hs-layout'>)</span> <span class='hs-varid'>sty1</span> <span class='hs-varid'>sty2</span> <span class='hs-comment'>-- Create derived or cached by deriveds</span>
<a name="line-32"></a>                    <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>wl'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>push_ctx</span> <span class='hs-varid'>wl</span> 
<a name="line-33"></a>                    <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isNewEvVar</span> <span class='hs-varid'>eqv</span> <span class='hs-keyword'>then</span> 
<a name="line-34"></a>                          <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>evc_the_evvar</span> <span class='hs-varid'>eqv</span><span class='hs-layout'>,</span><span class='hs-varid'>wl'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>ievs</span> 
<a name="line-35"></a>                      <span class='hs-keyword'>else</span> <span class='hs-comment'>-- We are eventually going to emit FD work back in the work list so </span>
<a name="line-36"></a>                           <span class='hs-comment'>-- it is important that we only return the /freshly created/ and not </span>
<a name="line-37"></a>                           <span class='hs-comment'>-- some existing equality!</span>
<a name="line-38"></a>                          <span class='hs-varid'>return</span> <span class='hs-varid'>ievs</span> <span class='hs-layout'>}</span>
<a name="line-39"></a>
<a name="line-40"></a>    <span class='hs-varid'>push_ctx</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedLoc</span> 
<a name="line-41"></a>    <span class='hs-varid'>push_ctx</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pushErrCtxt</span> <span class='hs-conid'>FunDepOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkEqnMsg</span> <span class='hs-varid'>d1</span> <span class='hs-varid'>d2</span><span class='hs-layout'>)</span> <span class='hs-varid'>loc</span>
<a name="line-42"></a>
<a name="line-43"></a><a name="mkEqnMsg"></a><span class='hs-definition'>mkEqnMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcPredType</span><span class='hs-layout'>,</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span> 
<a name="line-44"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcPredType</span><span class='hs-layout'>,</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span>
<a name="line-45"></a><span class='hs-definition'>mkEqnMsg</span> <span class='hs-layout'>(</span><span class='hs-varid'>pred1</span><span class='hs-layout'>,</span><span class='hs-varid'>from1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>pred2</span><span class='hs-layout'>,</span><span class='hs-varid'>from2</span><span class='hs-layout'>)</span> <span class='hs-varid'>tidy_env</span>
<a name="line-46"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>zpred1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>zonkTcPredType</span> <span class='hs-varid'>pred1</span>
<a name="line-47"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>zpred2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>zonkTcPredType</span> <span class='hs-varid'>pred2</span>
<a name="line-48"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tpred1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyType</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>zpred1</span>
<a name="line-49"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>tpred2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyType</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>zpred2</span> <span class='hs-layout'>}</span>
<a name="line-50"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"When using functional dependencies to combine"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-51"></a>			  <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tpred1</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span><span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varid'>from1</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> 
<a name="line-52"></a>			  <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tpred2</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span><span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varid'>from2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-53"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-54"></a>
<a name="line-55"></a><a name="rewriteDictParams"></a><span class='hs-definition'>rewriteDictParams</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-conid'>EqVar</span><span class='hs-layout'>,</span><span class='hs-conid'>WantedLoc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- A set of coercions : (pos, ty' ~ ty)</span>
<a name="line-56"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>                    <span class='hs-comment'>-- A sequence of types: tys</span>
<a name="line-57"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcCoercion</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>      <span class='hs-comment'>-- Returns: [(ty', co : ty' ~ ty)]</span>
<a name="line-58"></a><span class='hs-definition'>rewriteDictParams</span> <span class='hs-varid'>param_eqs</span> <span class='hs-varid'>tys</span>
<a name="line-59"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>do_one</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>0</span><span class='hs-keyglyph'>..</span><span class='hs-keyglyph'>]</span>
<a name="line-60"></a>  <span class='hs-keyword'>where</span>
<a name="line-61"></a>    <span class='hs-varid'>do_one</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcCoercion</span><span class='hs-layout'>)</span>
<a name="line-62"></a>    <span class='hs-varid'>do_one</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookup</span> <span class='hs-varid'>n</span> <span class='hs-varid'>param_eqs</span> <span class='hs-keyword'>of</span>
<a name="line-63"></a>                    <span class='hs-conid'>Just</span> <span class='hs-varid'>wev</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>get_fst_ty</span> <span class='hs-varid'>wev</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcCoVarCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>fst</span> <span class='hs-varid'>wev</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-64"></a>                    <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span>             <span class='hs-varid'>mkTcReflCo</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>	<span class='hs-comment'>-- Identity</span>
<a name="line-65"></a>
<a name="line-66"></a>    <span class='hs-varid'>get_fst_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>wev</span><span class='hs-layout'>,</span><span class='hs-sel'>_wloc</span><span class='hs-layout'>)</span> 
<a name="line-67"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getEqPredTys_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>evVarPred</span> <span class='hs-varid'>wev</span> <span class='hs-layout'>)</span>
<a name="line-68"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty1</span>
<a name="line-69"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> 
<a name="line-70"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"rewriteDictParams: non equality fundep!?"</span>
<a name="line-71"></a>
<a name="line-72"></a>        
<a name="line-73"></a><a name="emitFDWork"></a><span class='hs-definition'>emitFDWork</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-74"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>EvVar</span><span class='hs-layout'>,</span><span class='hs-conid'>WantedLoc</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> 
<a name="line-75"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span> 
<a name="line-76"></a><span class='hs-definition'>emitFDWork</span> <span class='hs-varid'>as_wanted</span> <span class='hs-varid'>evlocs</span> <span class='hs-varid'>d</span> 
<a name="line-77"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updWorkListTcS</span> <span class='hs-varop'>$</span> <span class='hs-varid'>appendWorkListEqs</span> <span class='hs-varid'>fd_cts</span>
<a name="line-78"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>fd_cts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>mk_fd_ct</span> <span class='hs-varid'>evlocs</span> 
<a name="line-79"></a>        <span class='hs-varid'>mk_fl</span> <span class='hs-varid'>wl</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>as_wanted</span> <span class='hs-keyword'>then</span> <span class='hs-layout'>(</span><span class='hs-conid'>Wanted</span> <span class='hs-varid'>wl</span><span class='hs-layout'>)</span> <span class='hs-keyword'>else</span> <span class='hs-layout'>(</span><span class='hs-conid'>Derived</span> <span class='hs-varid'>wl</span><span class='hs-layout'>)</span>
<a name="line-80"></a>        <span class='hs-varid'>mk_fd_ct</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span><span class='hs-varid'>wl</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CNonCanonical</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>v</span>
<a name="line-81"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>cc_flavor</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_fl</span> <span class='hs-varid'>wl</span> 
<a name="line-82"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>cc_depth</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span> <span class='hs-layout'>}</span>
<a name="line-83"></a>
<a name="line-84"></a><a name="emitFDWorkAsDerived"></a><span class='hs-definition'>emitFDWorkAsDerived</span><span class='hs-layout'>,</span> <span class='hs-varid'>emitFDWorkAsWanted</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>EvVar</span><span class='hs-layout'>,</span><span class='hs-conid'>WantedLoc</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> 
<a name="line-85"></a>                                        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubGoalDepth</span> 
<a name="line-86"></a>                                        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span> 
<a name="line-87"></a><span class='hs-definition'>emitFDWorkAsDerived</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emitFDWork</span> <span class='hs-conid'>False</span>
<a name="line-88"></a><a name="emitFDWorkAsWanted"></a><span class='hs-definition'>emitFDWorkAsWanted</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emitFDWork</span> <span class='hs-conid'>True</span> 
<a name="line-89"></a>
</pre>\end{code}</body>
</html>
