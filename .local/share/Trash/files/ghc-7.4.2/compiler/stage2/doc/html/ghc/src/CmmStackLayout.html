<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>cmm/CmmStackLayout.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS_GHC -XGADTs -XNoMonoLocalBinds #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- Norman likes local bindings</span>
<a name="line-3"></a><span class='hs-comment'>-- If this module lives on I'd like to get rid of the -XNoMonoLocalBinds</span>
<a name="line-4"></a><span class='hs-comment'>-- flag in due course</span>
<a name="line-5"></a>
<a name="line-6"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-7"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-8"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-9"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-10"></a><span class='hs-comment'>--     <a href="http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-11"></a><span class='hs-comment'>-- for details</span>
<a name="line-12"></a>
<a name="line-13"></a><span class='hs-comment'>-- Todo: remove -fno-warn-warnings-deprecations</span>
<a name="line-14"></a><span class='hs-comment'>{-# OPTIONS_GHC -fno-warn-warnings-deprecations #-}</span>
<a name="line-15"></a>
<a name="line-16"></a><span class='hs-comment'>{-# OPTIONS_GHC -fno-warn-incomplete-patterns #-}</span>
<a name="line-17"></a><span class='hs-cpp'>#if __GLASGOW_HASKELL__ &gt;= 703</span>
<a name="line-18"></a><span class='hs-comment'>-- GHC 7.0.1 improved incomplete pattern warnings with GADTs</span>
<a name="line-19"></a><span class='hs-comment'>{-# OPTIONS_GHC -fwarn-incomplete-patterns #-}</span>
<a name="line-20"></a><span class='hs-cpp'>#endif</span>
<a name="line-21"></a>
<a name="line-22"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>CmmStackLayout</span>
<a name="line-23"></a>    <span class='hs-layout'>(</span> <span class='hs-conid'>SlotEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>liveSlotAnal</span><span class='hs-layout'>,</span> <span class='hs-varid'>liveSlotTransfers</span><span class='hs-layout'>,</span> <span class='hs-varid'>removeLiveSlotDefs</span>
<a name="line-24"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>getSpEntryMap</span><span class='hs-layout'>,</span> <span class='hs-varid'>layout</span><span class='hs-layout'>,</span> <span class='hs-varid'>manifestSP</span><span class='hs-layout'>,</span> <span class='hs-varid'>igraph</span><span class='hs-layout'>,</span> <span class='hs-varid'>areaBuilder</span>
<a name="line-25"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>stubSlotsOnDeath</span> <span class='hs-layout'>)</span> <span class='hs-comment'>-- to help crash early during debugging</span>
<a name="line-26"></a><span class='hs-keyword'>where</span>
<a name="line-27"></a>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Constants</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Prelude</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span><span class='hs-varid'>succ</span><span class='hs-layout'>,</span> <span class='hs-varid'>zip</span><span class='hs-layout'>,</span> <span class='hs-varid'>unzip</span><span class='hs-layout'>,</span> <span class='hs-varid'>last</span><span class='hs-layout'>)</span>
<a name="line-30"></a>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BlockId</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Cmm</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CmmUtils</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CmmProcPoint</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MkGraph</span> <span class='hs-layout'>(</span><span class='hs-varid'>stackStubExpr</span><span class='hs-layout'>)</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OptimizationFuel</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SMRep</span> <span class='hs-layout'>(</span><span class='hs-conid'>ByteOff</span><span class='hs-layout'>)</span>
<a name="line-41"></a>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Compiler</span><span class='hs-varop'>.</span><span class='hs-conid'>Hoopl</span>
<a name="line-43"></a>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-layout'>)</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Map</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>FiniteMap</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Map</span>
<a name="line-47"></a>
<a name="line-48"></a><span class='hs-comment'>------------------------------------------------------------------------</span>
<a name="line-49"></a><span class='hs-comment'>--                    Stack Layout                                    --</span>
<a name="line-50"></a><span class='hs-comment'>------------------------------------------------------------------------</span>
<a name="line-51"></a>
<a name="line-52"></a><span class='hs-comment'>-- | Before we lay out the stack, we need to know something about the</span>
<a name="line-53"></a><span class='hs-comment'>-- liveness of the stack slots. In particular, to decide whether we can</span>
<a name="line-54"></a><span class='hs-comment'>-- reuse a stack location to hold multiple stack slots, we need to know</span>
<a name="line-55"></a><span class='hs-comment'>-- when each of the stack slots is used.</span>
<a name="line-56"></a><span class='hs-comment'>-- Although tempted to use something simpler, we really need a full interference</span>
<a name="line-57"></a><span class='hs-comment'>-- graph. Consider the following case:</span>
<a name="line-58"></a><span class='hs-comment'>--   case &lt;...&gt; of</span>
<a name="line-59"></a><span class='hs-comment'>--     1 -&gt; &lt;spill x&gt;; // y is dead out</span>
<a name="line-60"></a><span class='hs-comment'>--     2 -&gt; &lt;spill y&gt;; // x is dead out</span>
<a name="line-61"></a><span class='hs-comment'>--     3 -&gt; &lt;spill x and y&gt;</span>
<a name="line-62"></a><span class='hs-comment'>-- If we consider the arms in order and we use just the deadness information given by a</span>
<a name="line-63"></a><span class='hs-comment'>-- dataflow analysis, we might decide to allocate the stack slots for x and y</span>
<a name="line-64"></a><span class='hs-comment'>-- to the same stack location, which will lead to incorrect code in the third arm.</span>
<a name="line-65"></a><span class='hs-comment'>-- We won't make this mistake with an interference graph.</span>
<a name="line-66"></a>
<a name="line-67"></a><span class='hs-comment'>-- First, the liveness analysis.</span>
<a name="line-68"></a><span class='hs-comment'>-- We represent a slot with an area, an offset into the area, and a width.</span>
<a name="line-69"></a><span class='hs-comment'>-- Tracking the live slots is a bit tricky because there may be loads and stores</span>
<a name="line-70"></a><span class='hs-comment'>-- into only a part of a stack slot (e.g. loading the low word of a 2-word long),</span>
<a name="line-71"></a><span class='hs-comment'>-- e.g. Slot A 0 8 overlaps with Slot A 4 4.</span>
<a name="line-72"></a><span class='hs-comment'>--</span>
<a name="line-73"></a><span class='hs-comment'>-- The definition of a slot set is intended to reduce the number of overlap</span>
<a name="line-74"></a><span class='hs-comment'>-- checks we have to make. There's no reason to check for overlap between</span>
<a name="line-75"></a><span class='hs-comment'>-- slots in different areas, so we segregate the map by Area's.</span>
<a name="line-76"></a><span class='hs-comment'>-- We expect few slots in each Area, so we collect them in an unordered list.</span>
<a name="line-77"></a><span class='hs-comment'>-- To keep these lists short, any contiguous live slots are coalesced into</span>
<a name="line-78"></a><span class='hs-comment'>-- a single slot, on insertion.</span>
<a name="line-79"></a>
<a name="line-80"></a><a name="slotLattice"></a><span class='hs-definition'>slotLattice</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataflowLattice</span> <span class='hs-conid'>SubAreaSet</span>
<a name="line-81"></a><span class='hs-definition'>slotLattice</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DataflowLattice</span> <span class='hs-str'>"live slots"</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span> <span class='hs-varid'>add</span>
<a name="line-82"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>add</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>OldFact</span> <span class='hs-varid'>old</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>NewFact</span> <span class='hs-varid'>new</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>foldRightWithKey</span> <span class='hs-varid'>addArea</span> <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>old</span><span class='hs-layout'>)</span> <span class='hs-varid'>new</span> <span class='hs-keyword'>of</span>
<a name="line-83"></a>                                              <span class='hs-layout'>(</span><span class='hs-varid'>change</span><span class='hs-layout'>,</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>changeIf</span> <span class='hs-varid'>change</span><span class='hs-layout'>,</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-84"></a>        <span class='hs-varid'>addArea</span> <span class='hs-varid'>a</span> <span class='hs-varid'>newSlots</span> <span class='hs-varid'>z</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>addSlot</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-varid'>z</span> <span class='hs-varid'>newSlots</span>
<a name="line-85"></a>        <span class='hs-varid'>addSlot</span> <span class='hs-varid'>a</span> <span class='hs-varid'>slot</span> <span class='hs-layout'>(</span><span class='hs-varid'>changed</span><span class='hs-layout'>,</span> <span class='hs-varid'>map</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-86"></a>          <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>c</span><span class='hs-layout'>,</span> <span class='hs-varid'>live</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liveGen</span> <span class='hs-varid'>slot</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>findWithDefault</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>a</span> <span class='hs-varid'>map</span>
<a name="line-87"></a>          <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>c</span> <span class='hs-varop'>||</span> <span class='hs-varid'>changed</span><span class='hs-layout'>,</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>insert</span> <span class='hs-varid'>a</span> <span class='hs-varid'>live</span> <span class='hs-varid'>map</span><span class='hs-layout'>)</span>
<a name="line-88"></a>
<a name="line-89"></a><a name="slotLatticeJoin"></a><span class='hs-definition'>slotLatticeJoin</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SubAreaSet</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubAreaSet</span>
<a name="line-90"></a><span class='hs-definition'>slotLatticeJoin</span> <span class='hs-varid'>facts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>extend</span> <span class='hs-layout'>(</span><span class='hs-varid'>fact_bot</span> <span class='hs-varid'>slotLattice</span><span class='hs-layout'>)</span> <span class='hs-varid'>facts</span>
<a name="line-91"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>extend</span> <span class='hs-varid'>fact</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fact_join</span> <span class='hs-varid'>slotLattice</span> <span class='hs-varid'>undefined</span> <span class='hs-layout'>(</span><span class='hs-conid'>OldFact</span> <span class='hs-varid'>fact</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>NewFact</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-92"></a>
<a name="line-93"></a><a name="SlotEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>SlotEnv</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BlockEnv</span> <span class='hs-conid'>SubAreaSet</span>
<a name="line-94"></a>  <span class='hs-comment'>-- The sub-areas live on entry to the block</span>
<a name="line-95"></a>
<a name="line-96"></a><a name="liveSlotAnal"></a><span class='hs-definition'>liveSlotAnal</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FuelUniqSM</span> <span class='hs-conid'>SlotEnv</span>
<a name="line-97"></a><span class='hs-definition'>liveSlotAnal</span> <span class='hs-varid'>g</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>dataflowPassBwd</span> <span class='hs-varid'>g</span> <span class='hs-conid'>[]</span> <span class='hs-varop'>$</span> <span class='hs-varid'>analBwd</span> <span class='hs-varid'>slotLattice</span> <span class='hs-varid'>liveSlotTransfers</span>
<a name="line-98"></a>
<a name="line-99"></a><a name="liveGen"></a><span class='hs-comment'>-- Add the subarea s to the subareas in the list-set (possibly coalescing it with</span>
<a name="line-100"></a><span class='hs-comment'>-- adjacent subareas), and also return whether s was a new addition.</span>
<a name="line-101"></a><span class='hs-definition'>liveGen</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubArea</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SubArea</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SubArea</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-102"></a><span class='hs-definition'>liveGen</span> <span class='hs-varid'>s</span> <span class='hs-varid'>set</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liveGen'</span> <span class='hs-varid'>s</span> <span class='hs-varid'>set</span> <span class='hs-conid'>[]</span>
<a name="line-103"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>liveGen'</span> <span class='hs-varid'>s</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>z</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>s</span> <span class='hs-conop'>:</span> <span class='hs-varid'>z</span><span class='hs-layout'>)</span>
<a name="line-104"></a>        <span class='hs-varid'>liveGen'</span> <span class='hs-varid'>s</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>hi</span><span class='hs-layout'>,</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>s'</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>a'</span><span class='hs-layout'>,</span> <span class='hs-varid'>hi'</span><span class='hs-layout'>,</span> <span class='hs-varid'>w'</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rst</span><span class='hs-layout'>)</span> <span class='hs-varid'>z</span> <span class='hs-keyglyph'>=</span>
<a name="line-105"></a>          <span class='hs-keyword'>if</span> <span class='hs-varid'>a</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>a'</span> <span class='hs-varop'>||</span> <span class='hs-varid'>hi</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>lo'</span> <span class='hs-varop'>||</span> <span class='hs-varid'>lo</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>hi'</span> <span class='hs-keyword'>then</span>    <span class='hs-comment'>-- no overlap</span>
<a name="line-106"></a>            <span class='hs-varid'>liveGen'</span> <span class='hs-varid'>s</span> <span class='hs-varid'>rst</span> <span class='hs-layout'>(</span><span class='hs-varid'>s'</span> <span class='hs-conop'>:</span> <span class='hs-varid'>z</span><span class='hs-layout'>)</span>
<a name="line-107"></a>          <span class='hs-keyword'>else</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>s'</span> <span class='hs-varop'>`contains`</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>then</span>               <span class='hs-comment'>-- old contains new</span>
<a name="line-108"></a>            <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>set</span><span class='hs-layout'>)</span>
<a name="line-109"></a>          <span class='hs-keyword'>else</span>                                       <span class='hs-comment'>-- overlap: coalesce the slots</span>
<a name="line-110"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>new_hi</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>max</span> <span class='hs-varid'>hi</span> <span class='hs-varid'>hi'</span>
<a name="line-111"></a>                <span class='hs-varid'>new_lo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>min</span> <span class='hs-varid'>lo</span> <span class='hs-varid'>lo'</span>
<a name="line-112"></a>            <span class='hs-keyword'>in</span> <span class='hs-varid'>liveGen'</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_hi</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_hi</span> <span class='hs-comment'>-</span> <span class='hs-varid'>new_lo</span><span class='hs-layout'>)</span> <span class='hs-varid'>rst</span> <span class='hs-varid'>z</span>
<a name="line-113"></a>          <span class='hs-keyword'>where</span> <span class='hs-varid'>lo</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hi</span>  <span class='hs-comment'>-</span> <span class='hs-varid'>w</span>  <span class='hs-comment'>-- remember: areas grow down</span>
<a name="line-114"></a>                <span class='hs-varid'>lo'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hi'</span> <span class='hs-comment'>-</span> <span class='hs-varid'>w'</span>
<a name="line-115"></a>        <span class='hs-varid'>contains</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>hi</span><span class='hs-layout'>,</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>a'</span><span class='hs-layout'>,</span> <span class='hs-varid'>hi'</span><span class='hs-layout'>,</span> <span class='hs-varid'>w'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-116"></a>          <span class='hs-varid'>a</span> <span class='hs-varop'>==</span> <span class='hs-varid'>a'</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>hi</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>hi'</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>hi</span> <span class='hs-comment'>-</span> <span class='hs-varid'>w</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>hi'</span> <span class='hs-comment'>-</span> <span class='hs-varid'>w'</span>
<a name="line-117"></a>
<a name="line-118"></a><a name="liveKill"></a><span class='hs-definition'>liveKill</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubArea</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SubArea</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SubArea</span><span class='hs-keyglyph'>]</span>
<a name="line-119"></a><span class='hs-definition'>liveKill</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>hi</span><span class='hs-layout'>,</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-varid'>set</span> <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- pprTrace "killing slots in area" (ppr a) $</span>
<a name="line-120"></a>                          <span class='hs-varid'>liveKill'</span> <span class='hs-varid'>set</span> <span class='hs-conid'>[]</span>
<a name="line-121"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>liveKill'</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>z</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>z</span>
<a name="line-122"></a>        <span class='hs-varid'>liveKill'</span> <span class='hs-layout'>(</span><span class='hs-varid'>s'</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>a'</span><span class='hs-layout'>,</span> <span class='hs-varid'>hi'</span><span class='hs-layout'>,</span> <span class='hs-varid'>w'</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rst</span><span class='hs-layout'>)</span> <span class='hs-varid'>z</span> <span class='hs-keyglyph'>=</span>
<a name="line-123"></a>          <span class='hs-keyword'>if</span> <span class='hs-varid'>a</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>a'</span> <span class='hs-varop'>||</span> <span class='hs-varid'>hi</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>lo'</span> <span class='hs-varop'>||</span> <span class='hs-varid'>lo</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>hi'</span> <span class='hs-keyword'>then</span>    <span class='hs-comment'>-- no overlap</span>
<a name="line-124"></a>            <span class='hs-varid'>liveKill'</span> <span class='hs-varid'>rst</span> <span class='hs-layout'>(</span><span class='hs-varid'>s'</span> <span class='hs-conop'>:</span> <span class='hs-varid'>z</span><span class='hs-layout'>)</span>
<a name="line-125"></a>          <span class='hs-keyword'>else</span>                                       <span class='hs-comment'>-- overlap: split the old slot</span>
<a name="line-126"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>z'</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>hi'</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>hi</span>  <span class='hs-keyword'>then</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>hi'</span><span class='hs-layout'>,</span> <span class='hs-varid'>hi'</span> <span class='hs-comment'>-</span> <span class='hs-varid'>hi</span><span class='hs-layout'>)</span>  <span class='hs-conop'>:</span> <span class='hs-varid'>z</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>z</span>
<a name="line-127"></a>                <span class='hs-varid'>z''</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>lo</span>  <span class='hs-varop'>&gt;</span> <span class='hs-varid'>lo'</span> <span class='hs-keyword'>then</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>lo</span><span class='hs-layout'>,</span>  <span class='hs-varid'>lo</span>  <span class='hs-comment'>-</span> <span class='hs-varid'>lo'</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>z'</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>z'</span>
<a name="line-128"></a>            <span class='hs-keyword'>in</span> <span class='hs-varid'>liveKill'</span> <span class='hs-varid'>rst</span> <span class='hs-varid'>z''</span>
<a name="line-129"></a>          <span class='hs-keyword'>where</span> <span class='hs-varid'>lo</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hi</span>  <span class='hs-comment'>-</span> <span class='hs-varid'>w</span>  <span class='hs-comment'>-- remember: areas grow down</span>
<a name="line-130"></a>                <span class='hs-varid'>lo'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hi'</span> <span class='hs-comment'>-</span> <span class='hs-varid'>w'</span>
<a name="line-131"></a>
<a name="line-132"></a><a name="liveSlotTransfers"></a><span class='hs-comment'>-- Note: the stack slots that hold variables returned on the stack are not</span>
<a name="line-133"></a><span class='hs-comment'>-- considered live in to the block -- we treat the first node as a definition site.</span>
<a name="line-134"></a><span class='hs-comment'>-- BEWARE?: Am I being a little careless here in failing to check for the</span>
<a name="line-135"></a><span class='hs-comment'>-- entry Id (which would use the CallArea Old).</span>
<a name="line-136"></a><span class='hs-definition'>liveSlotTransfers</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BwdTransfer</span> <span class='hs-conid'>CmmNode</span> <span class='hs-conid'>SubAreaSet</span>
<a name="line-137"></a><span class='hs-definition'>liveSlotTransfers</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkBTransfer3</span> <span class='hs-varid'>frt</span> <span class='hs-varid'>mid</span> <span class='hs-varid'>lst</span>
<a name="line-138"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>frt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmNode</span> <span class='hs-conid'>C</span> <span class='hs-conid'>O</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubAreaSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubAreaSet</span>
<a name="line-139"></a>        <span class='hs-varid'>frt</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmEntry</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>delete</span> <span class='hs-layout'>(</span><span class='hs-conid'>CallArea</span> <span class='hs-layout'>(</span><span class='hs-conid'>Young</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>f</span>
<a name="line-140"></a>
<a name="line-141"></a>        <span class='hs-varid'>mid</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmNode</span> <span class='hs-conid'>O</span> <span class='hs-conid'>O</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubAreaSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubAreaSet</span>
<a name="line-142"></a>        <span class='hs-varid'>mid</span> <span class='hs-varid'>n</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldSlotsUsed</span> <span class='hs-varid'>addSlot</span> <span class='hs-layout'>(</span><span class='hs-varid'>removeLiveSlotDefs</span> <span class='hs-varid'>f</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span>
<a name="line-143"></a>        <span class='hs-varid'>lst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmNode</span> <span class='hs-conid'>O</span> <span class='hs-conid'>C</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FactBase</span> <span class='hs-conid'>SubAreaSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubAreaSet</span>
<a name="line-144"></a>        <span class='hs-varid'>lst</span> <span class='hs-varid'>n</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liveInSlots</span> <span class='hs-varid'>n</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>of</span>
<a name="line-145"></a>          <span class='hs-conid'>CmmCall</span> <span class='hs-layout'>{</span><span class='hs-varid'>cml_cont</span><span class='hs-keyglyph'>=</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-varid'>cml_args</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>args</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>add_area</span> <span class='hs-layout'>(</span><span class='hs-conid'>CallArea</span> <span class='hs-conid'>Old</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span> <span class='hs-varid'>out</span>
<a name="line-146"></a>          <span class='hs-conid'>CmmCall</span> <span class='hs-layout'>{</span><span class='hs-varid'>cml_cont</span><span class='hs-keyglyph'>=</span><span class='hs-conid'>Just</span> <span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>cml_args</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>args</span><span class='hs-layout'>}</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>add_area</span> <span class='hs-layout'>(</span><span class='hs-conid'>CallArea</span> <span class='hs-conid'>Old</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span> <span class='hs-layout'>(</span><span class='hs-varid'>add_area</span> <span class='hs-layout'>(</span><span class='hs-conid'>CallArea</span> <span class='hs-layout'>(</span><span class='hs-conid'>Young</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span> <span class='hs-varid'>out</span><span class='hs-layout'>)</span>
<a name="line-147"></a>          <span class='hs-conid'>CmmForeignCall</span> <span class='hs-layout'>{</span><span class='hs-varid'>succ</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>updfr</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>oldend</span><span class='hs-layout'>}</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>add_area</span> <span class='hs-layout'>(</span><span class='hs-conid'>CallArea</span> <span class='hs-conid'>Old</span><span class='hs-layout'>)</span> <span class='hs-varid'>oldend</span> <span class='hs-layout'>(</span><span class='hs-varid'>add_area</span> <span class='hs-layout'>(</span><span class='hs-conid'>CallArea</span> <span class='hs-layout'>(</span><span class='hs-conid'>Young</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>wORD_SIZE</span> <span class='hs-varid'>out</span><span class='hs-layout'>)</span>
<a name="line-148"></a>          <span class='hs-keyword'>_</span>                                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>out</span>
<a name="line-149"></a>         <span class='hs-keyword'>where</span> <span class='hs-varid'>out</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>joinOutFacts</span> <span class='hs-varid'>slotLattice</span> <span class='hs-varid'>n</span> <span class='hs-varid'>f</span>
<a name="line-150"></a>               <span class='hs-varid'>add_area</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>n</span> <span class='hs-varid'>live</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>live</span>
<a name="line-151"></a>               <span class='hs-varid'>add_area</span> <span class='hs-varid'>a</span> <span class='hs-varid'>n</span> <span class='hs-varid'>live</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>insert</span> <span class='hs-varid'>a</span> <span class='hs-layout'>(</span><span class='hs-varid'>snd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>liveGen</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>findWithDefault</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>a</span> <span class='hs-varid'>live</span><span class='hs-layout'>)</span> <span class='hs-varid'>live</span>
<a name="line-152"></a>
<a name="line-153"></a><a name="liftToArea"></a><span class='hs-comment'>-- Slot sets: adding slots, removing slots, and checking for membership.</span>
<a name="line-154"></a><span class='hs-definition'>liftToArea</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Area</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>SubArea</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SubArea</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubAreaSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubAreaSet</span> 
<a name="line-155"></a><a name="addSlot"></a><span class='hs-definition'>addSlot</span><span class='hs-layout'>,</span> <span class='hs-varid'>removeSlot</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubAreaSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubArea</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubAreaSet</span>
<a name="line-156"></a><a name="elemSlot"></a><span class='hs-definition'>elemSlot</span>            <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubAreaSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubArea</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-157"></a><span class='hs-definition'>liftToArea</span> <span class='hs-varid'>a</span> <span class='hs-varid'>f</span> <span class='hs-varid'>map</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>insert</span> <span class='hs-varid'>a</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>findWithDefault</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>a</span> <span class='hs-varid'>map</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>map</span>
<a name="line-158"></a><span class='hs-definition'>addSlot</span>    <span class='hs-varid'>live</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftToArea</span> <span class='hs-varid'>a</span> <span class='hs-layout'>(</span><span class='hs-varid'>snd</span> <span class='hs-varop'>.</span> <span class='hs-varid'>liveGen</span>  <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>live</span>
<a name="line-159"></a><a name="removeSlot"></a><span class='hs-definition'>removeSlot</span> <span class='hs-varid'>live</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftToArea</span> <span class='hs-varid'>a</span>       <span class='hs-layout'>(</span><span class='hs-varid'>liveKill</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>live</span>
<a name="line-160"></a><span class='hs-definition'>elemSlot</span>   <span class='hs-varid'>live</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-161"></a>  <span class='hs-varid'>not</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>liveGen</span>  <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>findWithDefault</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>a</span> <span class='hs-varid'>live</span><span class='hs-layout'>)</span>
<a name="line-162"></a>
<a name="line-163"></a><a name="removeLiveSlotDefs"></a><span class='hs-definition'>removeLiveSlotDefs</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>DefinerOfSlots</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-conid'>UserOfSlots</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>SubAreaSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubAreaSet</span>
<a name="line-164"></a><span class='hs-definition'>removeLiveSlotDefs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldSlotsDefd</span> <span class='hs-varid'>removeSlot</span>
<a name="line-165"></a>
<a name="line-166"></a><a name="liveInSlots"></a><span class='hs-definition'>liveInSlots</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>DefinerOfSlots</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-conid'>UserOfSlots</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubAreaSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubAreaSet</span>
<a name="line-167"></a><span class='hs-definition'>liveInSlots</span> <span class='hs-varid'>x</span> <span class='hs-varid'>live</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldSlotsUsed</span> <span class='hs-varid'>addSlot</span> <span class='hs-layout'>(</span><span class='hs-varid'>removeLiveSlotDefs</span> <span class='hs-varid'>live</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-varid'>x</span>
<a name="line-168"></a>
<a name="line-169"></a><a name="liveLastIn"></a><span class='hs-definition'>liveLastIn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmNode</span> <span class='hs-conid'>O</span> <span class='hs-conid'>C</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>BlockId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubAreaSet</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubAreaSet</span>
<a name="line-170"></a><span class='hs-definition'>liveLastIn</span> <span class='hs-varid'>l</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liveInSlots</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-varid'>liveLastOut</span> <span class='hs-varid'>env</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-171"></a>
<a name="line-172"></a><a name="liveLastOut"></a><span class='hs-comment'>-- Don't forget to keep the outgoing parameters in the CallArea live,</span>
<a name="line-173"></a><span class='hs-comment'>-- as well as the update frame.</span>
<a name="line-174"></a><span class='hs-comment'>-- Note: We have to keep the update frame live at a call because of the</span>
<a name="line-175"></a><span class='hs-comment'>-- case where the function doesn't return -- in that case, there won't</span>
<a name="line-176"></a><span class='hs-comment'>-- be a return to keep the update frame live. We'd still better keep the</span>
<a name="line-177"></a><span class='hs-comment'>-- info pointer in the update frame live at any call site;</span>
<a name="line-178"></a><span class='hs-comment'>-- otherwise we could screw up the garbage collector.</span>
<a name="line-179"></a><span class='hs-definition'>liveLastOut</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>BlockId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubAreaSet</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmNode</span> <span class='hs-conid'>O</span> <span class='hs-conid'>C</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubAreaSet</span>
<a name="line-180"></a><span class='hs-definition'>liveLastOut</span> <span class='hs-varid'>env</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>=</span>
<a name="line-181"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>l</span> <span class='hs-keyword'>of</span>
<a name="line-182"></a>    <span class='hs-conid'>CmmCall</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> 
<a name="line-183"></a>      <span class='hs-varid'>add_area</span> <span class='hs-layout'>(</span><span class='hs-conid'>CallArea</span> <span class='hs-conid'>Old</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span> <span class='hs-varid'>out</span> <span class='hs-comment'>-- add outgoing args (includes upd frame)</span>
<a name="line-184"></a>    <span class='hs-conid'>CmmCall</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-185"></a>      <span class='hs-varid'>add_area</span> <span class='hs-layout'>(</span><span class='hs-conid'>CallArea</span> <span class='hs-conid'>Old</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>add_area</span> <span class='hs-layout'>(</span><span class='hs-conid'>CallArea</span> <span class='hs-layout'>(</span><span class='hs-conid'>Young</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span> <span class='hs-varid'>out</span><span class='hs-layout'>)</span>
<a name="line-186"></a>    <span class='hs-conid'>CmmForeignCall</span> <span class='hs-layout'>{</span> <span class='hs-varid'>succ</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>updfr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>oldend</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-187"></a>      <span class='hs-varid'>add_area</span> <span class='hs-layout'>(</span><span class='hs-conid'>CallArea</span> <span class='hs-conid'>Old</span><span class='hs-layout'>)</span> <span class='hs-varid'>oldend</span> <span class='hs-layout'>(</span><span class='hs-varid'>add_area</span> <span class='hs-layout'>(</span><span class='hs-conid'>CallArea</span> <span class='hs-layout'>(</span><span class='hs-conid'>Young</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>wORD_SIZE</span> <span class='hs-varid'>out</span><span class='hs-layout'>)</span>
<a name="line-188"></a>    <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>out</span>
<a name="line-189"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>out</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>slotLatticeJoin</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>env</span> <span class='hs-varop'>$</span> <span class='hs-varid'>successors</span> <span class='hs-varid'>l</span>
<a name="line-190"></a>        <span class='hs-varid'>add_area</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>n</span> <span class='hs-varid'>live</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>live</span>
<a name="line-191"></a>        <span class='hs-varid'>add_area</span> <span class='hs-varid'>a</span> <span class='hs-varid'>n</span> <span class='hs-varid'>live</span> <span class='hs-keyglyph'>=</span>
<a name="line-192"></a>          <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>insert</span> <span class='hs-varid'>a</span> <span class='hs-layout'>(</span><span class='hs-varid'>snd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>liveGen</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>findWithDefault</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>a</span> <span class='hs-varid'>live</span><span class='hs-layout'>)</span> <span class='hs-varid'>live</span>
<a name="line-193"></a>
<a name="line-194"></a><a name="Set"></a><span class='hs-comment'>-- The liveness analysis must be precise: otherwise, we won't know if a definition</span>
<a name="line-195"></a><a name="Set"></a><span class='hs-comment'>-- should really kill a live-out stack slot.</span>
<a name="line-196"></a><a name="Set"></a><span class='hs-comment'>-- But the interference graph does not have to be precise -- it might decide that</span>
<a name="line-197"></a><a name="Set"></a><span class='hs-comment'>-- any live areas interfere. To maintain both a precise analysis and an imprecise</span>
<a name="line-198"></a><a name="Set"></a><span class='hs-comment'>-- interference graph, we need to convert the live-out stack slots to graph nodes</span>
<a name="line-199"></a><a name="Set"></a><span class='hs-comment'>-- at each and every instruction; rather than reconstruct a new list of nodes</span>
<a name="line-200"></a><a name="Set"></a><span class='hs-comment'>-- every time, I provide a function to fold over the nodes, which should be a</span>
<a name="line-201"></a><a name="Set"></a><span class='hs-comment'>-- reasonably efficient approach for the implementations we envision.</span>
<a name="line-202"></a><a name="Set"></a><span class='hs-comment'>-- Of course, it will probably be much easier to program if we just return a list...</span>
<a name="line-203"></a><a name="Set"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>Set</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span> <span class='hs-varid'>x</span> <span class='hs-conid'>()</span>
<a name="line-204"></a><a name="IGraphBuilder"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>IGraphBuilder</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span>
<a name="line-205"></a>  <span class='hs-conid'>Builder</span> <span class='hs-layout'>{</span> <span class='hs-varid'>foldNodes</span>     <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>z</span><span class='hs-varop'>.</span> <span class='hs-conid'>SubArea</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>z</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>z</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>z</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>z</span>
<a name="line-206"></a>          <span class='hs-layout'>,</span> <span class='hs-sel'>_wordsOccupied</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AreaSizeMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AreaMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Int</span><span class='hs-keyglyph'>]</span>
<a name="line-207"></a>          <span class='hs-layout'>}</span>
<a name="line-208"></a>
<a name="line-209"></a><a name="areaBuilder"></a><span class='hs-definition'>areaBuilder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IGraphBuilder</span> <span class='hs-conid'>Area</span>
<a name="line-210"></a><span class='hs-definition'>areaBuilder</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Builder</span> <span class='hs-varid'>fold</span> <span class='hs-varid'>words</span>
<a name="line-211"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>fold</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>f</span> <span class='hs-varid'>z</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-varid'>a</span> <span class='hs-varid'>z</span>
<a name="line-212"></a>        <span class='hs-varid'>words</span> <span class='hs-varid'>areaSize</span> <span class='hs-varid'>areaMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span>
<a name="line-213"></a>          <span class='hs-keyword'>case</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-varid'>a</span> <span class='hs-varid'>areaMap</span> <span class='hs-keyword'>of</span>
<a name="line-214"></a>            <span class='hs-conid'>Just</span> <span class='hs-varid'>addr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>addr</span> <span class='hs-keyglyph'>..</span> <span class='hs-varid'>addr</span> <span class='hs-varop'>+</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-varid'>a</span> <span class='hs-varid'>areaSize</span> <span class='hs-varop'>`orElse`</span>
<a name="line-215"></a>                                          <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"wordsOccupied: unknown area"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>areaSize</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-216"></a>            <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-217"></a>
<a name="line-218"></a><span class='hs-comment'>--slotBuilder :: IGraphBuilder (Area, Int)</span>
<a name="line-219"></a><span class='hs-comment'>--slotBuilder = undefined</span>
<a name="line-220"></a>
<a name="line-221"></a><a name="IGraph"></a><span class='hs-comment'>-- Now, we can build the interference graph.</span>
<a name="line-222"></a><a name="IGraph"></a><span class='hs-comment'>-- The usual story: a definition interferes with all live outs and all other</span>
<a name="line-223"></a><a name="IGraph"></a><span class='hs-comment'>-- definitions.</span>
<a name="line-224"></a><a name="IGraph"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>IGraph</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span> <span class='hs-varid'>x</span> <span class='hs-layout'>(</span><span class='hs-conid'>Set</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-225"></a><a name="IGPair"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>IGPair</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>IGraph</span> <span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-conid'>IGraphBuilder</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-226"></a><a name="igraph"></a><span class='hs-definition'>igraph</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ord</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>IGraphBuilder</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SlotEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IGraph</span> <span class='hs-varid'>x</span>
<a name="line-227"></a><span class='hs-definition'>igraph</span> <span class='hs-varid'>builder</span> <span class='hs-varid'>env</span> <span class='hs-varid'>g</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>interfere</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span> <span class='hs-layout'>(</span><span class='hs-varid'>postorderDfs</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span>
<a name="line-228"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>foldN</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldNodes</span> <span class='hs-varid'>builder</span>
<a name="line-229"></a>        <span class='hs-varid'>interfere</span> <span class='hs-varid'>block</span> <span class='hs-varid'>igraph</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldBlockNodesB3</span> <span class='hs-layout'>(</span><span class='hs-varid'>first</span><span class='hs-layout'>,</span> <span class='hs-varid'>middle</span><span class='hs-layout'>,</span> <span class='hs-varid'>last</span><span class='hs-layout'>)</span> <span class='hs-varid'>block</span> <span class='hs-varid'>igraph</span>
<a name="line-230"></a>          <span class='hs-keyword'>where</span> <span class='hs-varid'>first</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-varid'>igraph</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>igraph</span>
<a name="line-231"></a>                <span class='hs-varid'>middle</span> <span class='hs-varid'>node</span> <span class='hs-layout'>(</span><span class='hs-varid'>igraph</span><span class='hs-layout'>,</span> <span class='hs-varid'>liveOut</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-232"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>addEdges</span> <span class='hs-varid'>igraph</span> <span class='hs-varid'>node</span> <span class='hs-varid'>liveOut</span><span class='hs-layout'>,</span> <span class='hs-varid'>liveInSlots</span> <span class='hs-varid'>node</span> <span class='hs-varid'>liveOut</span><span class='hs-layout'>)</span>
<a name="line-233"></a>                <span class='hs-varid'>last</span> <span class='hs-varid'>node</span> <span class='hs-varid'>igraph</span> <span class='hs-keyglyph'>=</span>
<a name="line-234"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>addEdges</span> <span class='hs-varid'>igraph</span> <span class='hs-varid'>node</span> <span class='hs-varop'>$</span> <span class='hs-varid'>liveLastOut</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>node</span><span class='hs-layout'>,</span> <span class='hs-varid'>liveLastIn</span> <span class='hs-varid'>node</span> <span class='hs-varid'>env'</span><span class='hs-layout'>)</span>
<a name="line-235"></a>
<a name="line-236"></a>                <span class='hs-comment'>-- add edges between a def and the other defs and liveouts</span>
<a name="line-237"></a>                <span class='hs-varid'>addEdges</span> <span class='hs-varid'>igraph</span> <span class='hs-varid'>i</span> <span class='hs-varid'>out</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>foldSlotsDefd</span> <span class='hs-varid'>addDef</span> <span class='hs-layout'>(</span><span class='hs-varid'>igraph</span><span class='hs-layout'>,</span> <span class='hs-varid'>out</span><span class='hs-layout'>)</span> <span class='hs-varid'>i</span>
<a name="line-238"></a>                <span class='hs-varid'>addDef</span> <span class='hs-layout'>(</span><span class='hs-varid'>igraph</span><span class='hs-layout'>,</span> <span class='hs-varid'>out</span><span class='hs-layout'>)</span> <span class='hs-varid'>def</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-239"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>foldN</span> <span class='hs-varid'>def</span> <span class='hs-layout'>(</span><span class='hs-varid'>addDefN</span> <span class='hs-varid'>out</span><span class='hs-layout'>)</span> <span class='hs-varid'>igraph</span><span class='hs-layout'>,</span>
<a name="line-240"></a>                   <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>insert</span> <span class='hs-varid'>a</span> <span class='hs-layout'>(</span><span class='hs-varid'>snd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>liveGen</span> <span class='hs-varid'>def</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>findWithDefault</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>a</span> <span class='hs-varid'>out</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>out</span><span class='hs-layout'>)</span>
<a name="line-241"></a>                <span class='hs-varid'>addDefN</span> <span class='hs-varid'>out</span> <span class='hs-varid'>n</span> <span class='hs-varid'>igraph</span> <span class='hs-keyglyph'>=</span>
<a name="line-242"></a>                  <span class='hs-keyword'>let</span> <span class='hs-varid'>addEdgeNO</span> <span class='hs-varid'>o</span> <span class='hs-varid'>igraph</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldN</span> <span class='hs-varid'>o</span> <span class='hs-varid'>addEdgeNN</span> <span class='hs-varid'>igraph</span>
<a name="line-243"></a>                      <span class='hs-varid'>addEdgeNN</span> <span class='hs-varid'>n'</span> <span class='hs-varid'>igraph</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addEdgeNN'</span> <span class='hs-varid'>n</span> <span class='hs-varid'>n'</span> <span class='hs-varop'>$</span> <span class='hs-varid'>addEdgeNN'</span> <span class='hs-varid'>n'</span> <span class='hs-varid'>n</span> <span class='hs-varid'>igraph</span>
<a name="line-244"></a>                      <span class='hs-varid'>addEdgeNN'</span> <span class='hs-varid'>n</span> <span class='hs-varid'>n'</span> <span class='hs-varid'>igraph</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>insert</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>insert</span> <span class='hs-varid'>n'</span> <span class='hs-conid'>()</span> <span class='hs-varid'>set</span><span class='hs-layout'>)</span> <span class='hs-varid'>igraph</span>
<a name="line-245"></a>                        <span class='hs-keyword'>where</span> <span class='hs-varid'>set</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>findWithDefault</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span> <span class='hs-varid'>n</span> <span class='hs-varid'>igraph</span>
<a name="line-246"></a>                  <span class='hs-keyword'>in</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>foldRightWithKey</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>os</span> <span class='hs-varid'>igraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>addEdgeNO</span> <span class='hs-varid'>igraph</span> <span class='hs-varid'>os</span><span class='hs-layout'>)</span> <span class='hs-varid'>igraph</span> <span class='hs-varid'>out</span>
<a name="line-247"></a>                <span class='hs-varid'>env'</span> <span class='hs-varid'>bid</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapLookup</span> <span class='hs-varid'>bid</span> <span class='hs-varid'>env</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"unknown blockId in igraph"</span>
<a name="line-248"></a>
<a name="line-249"></a><span class='hs-comment'>-- Before allocating stack slots, we need to collect one more piece of information:</span>
<a name="line-250"></a><span class='hs-comment'>-- what's the highest offset (in bytes) used in each Area?</span>
<a name="line-251"></a><span class='hs-comment'>-- We'll need to allocate that much space for each Area.</span>
<a name="line-252"></a>
<a name="line-253"></a><a name="AreaSizeMap"></a><span class='hs-comment'>-- Mapping of areas to area sizes (not offsets!)</span>
<a name="line-254"></a><a name="AreaSizeMap"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>AreaSizeMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AreaMap</span>
<a name="line-255"></a>
<a name="line-256"></a><a name="getAreaSize"></a><span class='hs-comment'>-- JD: WHY CAN'T THIS COME FROM THE slot-liveness info?</span>
<a name="line-257"></a><span class='hs-definition'>getAreaSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ByteOff</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AreaSizeMap</span>
<a name="line-258"></a>  <span class='hs-comment'>-- The domain of the returned mapping consists only of Areas</span>
<a name="line-259"></a>  <span class='hs-comment'>-- used for (a) variable spill slots, and (b) parameter passing areas for calls</span>
<a name="line-260"></a><span class='hs-definition'>getAreaSize</span> <span class='hs-varid'>entry_off</span> <span class='hs-varid'>g</span> <span class='hs-keyglyph'>=</span>
<a name="line-261"></a>  <span class='hs-varid'>foldGraphBlocks</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldBlockNodesF3</span> <span class='hs-layout'>(</span><span class='hs-varid'>first</span><span class='hs-layout'>,</span> <span class='hs-varid'>add_regslots</span><span class='hs-layout'>,</span> <span class='hs-varid'>last</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-262"></a>              <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>singleton</span> <span class='hs-layout'>(</span><span class='hs-conid'>CallArea</span> <span class='hs-conid'>Old</span><span class='hs-layout'>)</span> <span class='hs-varid'>entry_off</span><span class='hs-layout'>)</span> <span class='hs-varid'>g</span>
<a name="line-263"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>first</span> <span class='hs-keyword'>_</span>  <span class='hs-varid'>z</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>z</span>
<a name="line-264"></a>        <span class='hs-varid'>last</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmNode</span> <span class='hs-conid'>O</span> <span class='hs-conid'>C</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Map</span> <span class='hs-conid'>Area</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Map</span> <span class='hs-conid'>Area</span> <span class='hs-conid'>Int</span>
<a name="line-265"></a>        <span class='hs-varid'>last</span> <span class='hs-varid'>l</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CmmCall</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>args</span> <span class='hs-varid'>res</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>z</span>  <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>add_regslots</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-varid'>add</span> <span class='hs-layout'>(</span><span class='hs-varid'>add</span> <span class='hs-varid'>z</span> <span class='hs-varid'>area</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-varid'>area</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-266"></a>          <span class='hs-keyword'>where</span> <span class='hs-varid'>area</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CallArea</span> <span class='hs-conid'>Old</span>
<a name="line-267"></a>        <span class='hs-varid'>last</span> <span class='hs-varid'>l</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CmmCall</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span> <span class='hs-varid'>res</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>z</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>add_regslots</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-varid'>add</span> <span class='hs-layout'>(</span><span class='hs-varid'>add</span> <span class='hs-varid'>z</span> <span class='hs-varid'>area</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-varid'>area</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-268"></a>          <span class='hs-keyword'>where</span> <span class='hs-varid'>area</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CallArea</span> <span class='hs-layout'>(</span><span class='hs-conid'>Young</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>
<a name="line-269"></a>        <span class='hs-varid'>last</span> <span class='hs-varid'>l</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CmmForeignCall</span> <span class='hs-layout'>{</span><span class='hs-varid'>succ</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>k</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>z</span>     <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>add_regslots</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-varid'>add</span> <span class='hs-varid'>z</span> <span class='hs-varid'>area</span> <span class='hs-varid'>wORD_SIZE</span><span class='hs-layout'>)</span>
<a name="line-270"></a>          <span class='hs-keyword'>where</span> <span class='hs-varid'>area</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CallArea</span> <span class='hs-layout'>(</span><span class='hs-conid'>Young</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>
<a name="line-271"></a>        <span class='hs-varid'>last</span> <span class='hs-varid'>l</span> <span class='hs-varid'>z</span>                                 <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>add_regslots</span> <span class='hs-varid'>l</span> <span class='hs-varid'>z</span>
<a name="line-272"></a>        <span class='hs-varid'>add_regslots</span> <span class='hs-varid'>i</span> <span class='hs-varid'>z</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldSlotsUsed</span> <span class='hs-varid'>addSlot</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldSlotsDefd</span> <span class='hs-varid'>addSlot</span> <span class='hs-varid'>z</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-varid'>i</span>
<a name="line-273"></a>        <span class='hs-varid'>addSlot</span> <span class='hs-varid'>z</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>RegSlot</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocalReg</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-274"></a>          <span class='hs-varid'>add</span> <span class='hs-varid'>z</span> <span class='hs-varid'>a</span> <span class='hs-varop'>$</span> <span class='hs-varid'>widthInBytes</span> <span class='hs-varop'>$</span> <span class='hs-varid'>typeWidth</span> <span class='hs-varid'>ty</span>
<a name="line-275"></a>        <span class='hs-varid'>addSlot</span> <span class='hs-varid'>z</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>z</span>
<a name="line-276"></a>        <span class='hs-varid'>add</span> <span class='hs-varid'>z</span> <span class='hs-varid'>a</span> <span class='hs-varid'>off</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>insert</span> <span class='hs-varid'>a</span> <span class='hs-layout'>(</span><span class='hs-varid'>max</span> <span class='hs-varid'>off</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>findWithDefault</span> <span class='hs-num'>0</span> <span class='hs-varid'>a</span> <span class='hs-varid'>z</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>z</span>
<a name="line-277"></a>	<span class='hs-comment'>-- The 'max' is important.  Two calls, to f and g, might share a common</span>
<a name="line-278"></a>	<span class='hs-comment'>-- continuation (and hence a common CallArea), but their number of overflow</span>
<a name="line-279"></a>	<span class='hs-comment'>-- parameters might differ.</span>
<a name="line-280"></a>        <span class='hs-comment'>-- EZY: Ought to use insert with combining function...</span>
<a name="line-281"></a>
<a name="line-282"></a>
<a name="line-283"></a><a name="conflictSlots"></a><span class='hs-comment'>-- Find the Stack slots occupied by the subarea's conflicts</span>
<a name="line-284"></a><span class='hs-definition'>conflictSlots</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ord</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>IGPair</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AreaSizeMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AreaMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubArea</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Set</span> <span class='hs-conid'>Int</span>
<a name="line-285"></a><span class='hs-definition'>conflictSlots</span> <span class='hs-layout'>(</span><span class='hs-varid'>ig</span><span class='hs-layout'>,</span> <span class='hs-conid'>Builder</span> <span class='hs-varid'>foldNodes</span> <span class='hs-varid'>wordsOccupied</span><span class='hs-layout'>)</span> <span class='hs-varid'>areaSize</span> <span class='hs-varid'>areaMap</span> <span class='hs-varid'>subarea</span> <span class='hs-keyglyph'>=</span>
<a name="line-286"></a>  <span class='hs-varid'>foldNodes</span> <span class='hs-varid'>subarea</span> <span class='hs-varid'>foldNode</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span>
<a name="line-287"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>foldNode</span> <span class='hs-varid'>n</span> <span class='hs-varid'>set</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>foldRightWithKey</span> <span class='hs-varid'>conflict</span> <span class='hs-varid'>set</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>findWithDefault</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ig</span>
<a name="line-288"></a>        <span class='hs-varid'>conflict</span> <span class='hs-varid'>n'</span> <span class='hs-conid'>()</span> <span class='hs-varid'>set</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liveInSlots</span> <span class='hs-varid'>areaMap</span> <span class='hs-varid'>n'</span> <span class='hs-varid'>set</span>
<a name="line-289"></a>        <span class='hs-comment'>-- Add stack slots occupied by igraph node n</span>
<a name="line-290"></a>        <span class='hs-varid'>liveInSlots</span> <span class='hs-varid'>areaMap</span> <span class='hs-varid'>n</span> <span class='hs-varid'>set</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>setAdd</span> <span class='hs-varid'>set</span> <span class='hs-layout'>(</span><span class='hs-varid'>wordsOccupied</span> <span class='hs-varid'>areaSize</span> <span class='hs-varid'>areaMap</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-291"></a>        <span class='hs-varid'>setAdd</span> <span class='hs-varid'>w</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>insert</span> <span class='hs-varid'>w</span> <span class='hs-conid'>()</span> <span class='hs-varid'>s</span>
<a name="line-292"></a>
<a name="line-293"></a><a name="freeSlotFrom"></a><span class='hs-comment'>-- Find any open space for 'area' on the stack, starting from the</span>
<a name="line-294"></a><span class='hs-comment'>-- 'offset'.  If the area is a CallArea or a spill slot for a pointer,</span>
<a name="line-295"></a><span class='hs-comment'>-- then it must be word-aligned.</span>
<a name="line-296"></a><span class='hs-definition'>freeSlotFrom</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ord</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>IGPair</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AreaSizeMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AreaMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Area</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-297"></a><span class='hs-definition'>freeSlotFrom</span> <span class='hs-varid'>ig</span> <span class='hs-varid'>areaSize</span> <span class='hs-varid'>offset</span> <span class='hs-varid'>areaMap</span> <span class='hs-varid'>area</span> <span class='hs-keyglyph'>=</span>
<a name="line-298"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>size</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-varid'>area</span> <span class='hs-varid'>areaSize</span> <span class='hs-varop'>`orElse`</span> <span class='hs-num'>0</span>
<a name="line-299"></a>      <span class='hs-varid'>conflicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>conflictSlots</span> <span class='hs-varid'>ig</span> <span class='hs-varid'>areaSize</span> <span class='hs-varid'>areaMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>area</span><span class='hs-layout'>,</span> <span class='hs-varid'>size</span><span class='hs-layout'>,</span> <span class='hs-varid'>size</span><span class='hs-layout'>)</span>
<a name="line-300"></a>      <span class='hs-comment'>-- CallAreas and Ptrs need to be word-aligned (round up!)</span>
<a name="line-301"></a>      <span class='hs-varid'>align</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>area</span> <span class='hs-keyword'>of</span> <span class='hs-conid'>CallArea</span> <span class='hs-keyword'>_</span>                                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>align'</span>
<a name="line-302"></a>                           <span class='hs-conid'>RegSlot</span>  <span class='hs-varid'>r</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isGcPtrType</span> <span class='hs-layout'>(</span><span class='hs-varid'>localRegType</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>align'</span>
<a name="line-303"></a>                           <span class='hs-conid'>RegSlot</span>  <span class='hs-keyword'>_</span>                                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>id</span>
<a name="line-304"></a>      <span class='hs-varid'>align'</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-varop'>+</span> <span class='hs-layout'>(</span><span class='hs-varid'>wORD_SIZE</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>`div`</span> <span class='hs-varid'>wORD_SIZE</span> <span class='hs-varop'>*</span> <span class='hs-varid'>wORD_SIZE</span>
<a name="line-305"></a>      <span class='hs-comment'>-- Find a space big enough to hold the area</span>
<a name="line-306"></a>      <span class='hs-varid'>findSpace</span> <span class='hs-varid'>curr</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>curr</span>
<a name="line-307"></a>      <span class='hs-varid'>findSpace</span> <span class='hs-varid'>curr</span> <span class='hs-varid'>cnt</span> <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- part of target slot, # of bytes left to check</span>
<a name="line-308"></a>        <span class='hs-keyword'>if</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>member</span> <span class='hs-varid'>curr</span> <span class='hs-varid'>conflicts</span> <span class='hs-keyword'>then</span>
<a name="line-309"></a>          <span class='hs-varid'>findSpace</span> <span class='hs-layout'>(</span><span class='hs-varid'>align</span> <span class='hs-layout'>(</span><span class='hs-varid'>curr</span> <span class='hs-varop'>+</span> <span class='hs-varid'>size</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>size</span> <span class='hs-comment'>-- try the next (possibly) open space</span>
<a name="line-310"></a>        <span class='hs-keyword'>else</span> <span class='hs-varid'>findSpace</span> <span class='hs-layout'>(</span><span class='hs-varid'>curr</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>cnt</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-311"></a>  <span class='hs-keyword'>in</span> <span class='hs-varid'>findSpace</span> <span class='hs-layout'>(</span><span class='hs-varid'>align</span> <span class='hs-layout'>(</span><span class='hs-varid'>offset</span> <span class='hs-varop'>+</span> <span class='hs-varid'>size</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>size</span>
<a name="line-312"></a>
<a name="line-313"></a><a name="allocSlotFrom"></a><span class='hs-comment'>-- Find an open space on the stack, and assign it to the area.</span>
<a name="line-314"></a><span class='hs-definition'>allocSlotFrom</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ord</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>IGPair</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AreaSizeMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AreaMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Area</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AreaMap</span>
<a name="line-315"></a><span class='hs-definition'>allocSlotFrom</span> <span class='hs-varid'>ig</span> <span class='hs-varid'>areaSize</span> <span class='hs-varid'>from</span> <span class='hs-varid'>areaMap</span> <span class='hs-varid'>area</span> <span class='hs-keyglyph'>=</span>
<a name="line-316"></a>  <span class='hs-keyword'>if</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>member</span> <span class='hs-varid'>area</span> <span class='hs-varid'>areaMap</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>areaMap</span>
<a name="line-317"></a>  <span class='hs-keyword'>else</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>insert</span> <span class='hs-varid'>area</span> <span class='hs-layout'>(</span><span class='hs-varid'>freeSlotFrom</span> <span class='hs-varid'>ig</span> <span class='hs-varid'>areaSize</span> <span class='hs-varid'>from</span> <span class='hs-varid'>areaMap</span> <span class='hs-varid'>area</span><span class='hs-layout'>)</span> <span class='hs-varid'>areaMap</span>
<a name="line-318"></a>
<a name="line-319"></a><a name="SpEntryMap"></a><span class='hs-comment'>-- Figure out all of the offsets from the slot location; this will be</span>
<a name="line-320"></a><a name="SpEntryMap"></a><span class='hs-comment'>-- non-zero for procpoints.</span>
<a name="line-321"></a><a name="SpEntryMap"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>SpEntryMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BlockEnv</span> <span class='hs-conid'>Int</span>
<a name="line-322"></a><a name="getSpEntryMap"></a><span class='hs-definition'>getSpEntryMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SpEntryMap</span>
<a name="line-323"></a><span class='hs-definition'>getSpEntryMap</span> <span class='hs-varid'>entry_off</span> <span class='hs-varid'>g</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CmmGraph</span> <span class='hs-layout'>{</span><span class='hs-varid'>g_entry</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>entry</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-324"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldGraphBlocks</span> <span class='hs-varid'>add_sp_off</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapInsert</span> <span class='hs-varid'>entry</span> <span class='hs-varid'>entry_off</span> <span class='hs-varid'>emptyBlockMap</span><span class='hs-layout'>)</span> <span class='hs-varid'>g</span>
<a name="line-325"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>add_sp_off</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmBlock</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BlockEnv</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BlockEnv</span> <span class='hs-conid'>Int</span>
<a name="line-326"></a>        <span class='hs-varid'>add_sp_off</span> <span class='hs-varid'>b</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span>
<a name="line-327"></a>          <span class='hs-keyword'>case</span> <span class='hs-varid'>lastNode</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>of</span>
<a name="line-328"></a>            <span class='hs-conid'>CmmCall</span> <span class='hs-layout'>{</span><span class='hs-varid'>cml_cont</span><span class='hs-keyglyph'>=</span><span class='hs-conid'>Just</span> <span class='hs-varid'>succ</span><span class='hs-layout'>,</span> <span class='hs-varid'>cml_ret_args</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>off</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mapInsert</span> <span class='hs-varid'>succ</span> <span class='hs-varid'>off</span> <span class='hs-varid'>env</span>
<a name="line-329"></a>            <span class='hs-conid'>CmmForeignCall</span> <span class='hs-layout'>{</span><span class='hs-varid'>succ</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>succ</span><span class='hs-layout'>}</span>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mapInsert</span> <span class='hs-varid'>succ</span> <span class='hs-varid'>wORD_SIZE</span> <span class='hs-varid'>env</span>
<a name="line-330"></a>            <span class='hs-keyword'>_</span>                                              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>env</span>
<a name="line-331"></a>
<a name="line-332"></a><span class='hs-comment'>-- | Greedy stack layout.</span>
<a name="line-333"></a><span class='hs-comment'>-- Compute liveness, build the interference graph, and allocate slots for the areas.</span>
<a name="line-334"></a><span class='hs-comment'>-- We visit each basic block in a (generally) forward order.</span>
<a name="line-335"></a>
<a name="line-336"></a><span class='hs-comment'>-- At each instruction that names a register subarea r, we immediately allocate</span>
<a name="line-337"></a><span class='hs-comment'>-- any available slot on the stack by the following procedure:</span>
<a name="line-338"></a><span class='hs-comment'>--  1. Find the sub-areas S that conflict with r</span>
<a name="line-339"></a><span class='hs-comment'>--  2. Find the stack slots used for S</span>
<a name="line-340"></a><span class='hs-comment'>--  3. Choose a contiguous stack space s not in S (s must be large enough to hold r)</span>
<a name="line-341"></a>
<a name="line-342"></a><span class='hs-comment'>-- For a CallArea, we allocate the stack space only when we reach a function</span>
<a name="line-343"></a><span class='hs-comment'>-- call that returns to the CallArea's blockId.</span>
<a name="line-344"></a><span class='hs-comment'>-- Then, we allocate the Area subject to the following constraints:</span>
<a name="line-345"></a><span class='hs-comment'>--   a) It must be younger than all the sub-areas that are live on entry to the block</span>
<a name="line-346"></a><span class='hs-comment'>--         This constraint is only necessary for the successor of a call</span>
<a name="line-347"></a><span class='hs-comment'>--   b) It must not overlap with any already-allocated Area with which it conflicts</span>
<a name="line-348"></a><span class='hs-comment'>--   	   (ie at some point, not necessarily now, is live at the same time)</span>
<a name="line-349"></a><span class='hs-comment'>--   Part (b) is just the 1,2,3 part above</span>
<a name="line-350"></a>
<a name="line-351"></a><span class='hs-comment'>-- Note: The stack pointer only has to be younger than the youngest live stack slot</span>
<a name="line-352"></a><span class='hs-comment'>-- at proc points. Otherwise, the stack pointer can point anywhere.</span>
<a name="line-353"></a>
<a name="line-354"></a><a name="layout"></a><span class='hs-definition'>layout</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ProcPointSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SpEntryMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SlotEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AreaMap</span>
<a name="line-355"></a><span class='hs-comment'>-- The domain of the returned map includes an Area for EVERY block</span>
<a name="line-356"></a><span class='hs-comment'>-- including each block that is not the successor of a call (ie is not a proc-point)</span>
<a name="line-357"></a><span class='hs-comment'>-- That's how we return the info of what the SP should be at the entry of every non</span>
<a name="line-358"></a><span class='hs-comment'>-- procpoint block.  However, note that procpoint blocks have their</span>
<a name="line-359"></a><span class='hs-comment'>-- /slot/ stored, which is not necessarily the value of the SP on entry</span>
<a name="line-360"></a><span class='hs-comment'>-- to the block (in fact, it probably isn't, due to argument passing).</span>
<a name="line-361"></a><span class='hs-comment'>-- See [Procpoint Sp offset]</span>
<a name="line-362"></a>
<a name="line-363"></a><span class='hs-definition'>layout</span> <span class='hs-varid'>procPoints</span> <span class='hs-varid'>spEntryMap</span> <span class='hs-varid'>env</span> <span class='hs-varid'>entry_off</span> <span class='hs-varid'>g</span> <span class='hs-keyglyph'>=</span>
<a name="line-364"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>ig</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>igraph</span> <span class='hs-varid'>areaBuilder</span> <span class='hs-varid'>env</span> <span class='hs-varid'>g</span><span class='hs-layout'>,</span> <span class='hs-varid'>areaBuilder</span><span class='hs-layout'>)</span>
<a name="line-365"></a>      <span class='hs-varid'>env'</span> <span class='hs-varid'>bid</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapLookup</span> <span class='hs-varid'>bid</span> <span class='hs-varid'>env</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"unknown blockId in igraph"</span>
<a name="line-366"></a>      <span class='hs-varid'>areaSize</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getAreaSize</span> <span class='hs-varid'>entry_off</span> <span class='hs-varid'>g</span>
<a name="line-367"></a>
<a name="line-368"></a>      <span class='hs-comment'>-- Find the youngest live stack slot that has already been allocated</span>
<a name="line-369"></a>      <span class='hs-varid'>youngest_live</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AreaMap</span> 	   <span class='hs-comment'>-- Already allocated</span>
<a name="line-370"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubAreaSet</span>  <span class='hs-comment'>-- Sub-areas live here</span>
<a name="line-371"></a>		    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span>     <span class='hs-comment'>-- Offset of the youngest byte of any </span>
<a name="line-372"></a>		       		   <span class='hs-comment'>--    already-allocated, live sub-area</span>
<a name="line-373"></a>      <span class='hs-varid'>youngest_live</span> <span class='hs-varid'>areaMap</span> <span class='hs-varid'>live</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fold_subareas</span> <span class='hs-varid'>young_slot</span> <span class='hs-varid'>live</span> <span class='hs-num'>0</span>
<a name="line-374"></a>        <span class='hs-keyword'>where</span> <span class='hs-varid'>young_slot</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>o</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>z</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-varid'>a</span> <span class='hs-varid'>areaMap</span> <span class='hs-keyword'>of</span>
<a name="line-375"></a>                                         <span class='hs-conid'>Just</span> <span class='hs-varid'>top</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>max</span> <span class='hs-varid'>z</span> <span class='hs-varop'>$</span> <span class='hs-varid'>top</span> <span class='hs-varop'>+</span> <span class='hs-varid'>o</span>
<a name="line-376"></a>                                         <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>z</span>
<a name="line-377"></a>              <span class='hs-varid'>fold_subareas</span> <span class='hs-varid'>f</span> <span class='hs-varid'>m</span> <span class='hs-varid'>z</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>foldRightWithKey</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-varid'>s</span> <span class='hs-varid'>z</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>f</span> <span class='hs-varid'>z</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-varid'>z</span> <span class='hs-varid'>m</span>
<a name="line-378"></a>
<a name="line-379"></a>      <span class='hs-comment'>-- Allocate space for spill slots and call areas</span>
<a name="line-380"></a>      <span class='hs-varid'>allocVarSlot</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>allocSlotFrom</span> <span class='hs-varid'>ig</span> <span class='hs-varid'>areaSize</span> <span class='hs-num'>0</span>
<a name="line-381"></a>
<a name="line-382"></a>      <span class='hs-comment'>-- Update the successor's incoming SP.</span>
<a name="line-383"></a>      <span class='hs-varid'>setSuccSPs</span> <span class='hs-varid'>inSp</span> <span class='hs-varid'>bid</span> <span class='hs-varid'>areaMap</span> <span class='hs-keyglyph'>=</span>
<a name="line-384"></a>        <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-varid'>area</span> <span class='hs-varid'>areaMap</span> <span class='hs-layout'>,</span> <span class='hs-varid'>mapLookup</span> <span class='hs-varid'>bid</span> <span class='hs-layout'>(</span><span class='hs-varid'>toBlockMap</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-385"></a>          <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>areaMap</span> <span class='hs-comment'>-- succ already knows incoming SP</span>
<a name="line-386"></a>          <span class='hs-layout'>(</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-387"></a>            <span class='hs-keyword'>if</span> <span class='hs-varid'>setMember</span> <span class='hs-varid'>bid</span> <span class='hs-varid'>procPoints</span> <span class='hs-keyword'>then</span>
<a name="line-388"></a>              <span class='hs-keyword'>let</span> <span class='hs-varid'>young</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>youngest_live</span> <span class='hs-varid'>areaMap</span> <span class='hs-varop'>$</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>bid</span>
<a name="line-389"></a>                  <span class='hs-comment'>-- start = case returnOff stackInfo of Just b  -&gt; max b young</span>
<a name="line-390"></a>                  <span class='hs-comment'>--                                     Nothing -&gt; young</span>
<a name="line-391"></a>                  <span class='hs-varid'>start</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>young</span> <span class='hs-comment'>-- maybe wrong, but I don't understand</span>
<a name="line-392"></a>                                <span class='hs-comment'>-- why the preceding is necessary...</span>
<a name="line-393"></a>              <span class='hs-keyword'>in</span>  <span class='hs-varid'>allocSlotFrom</span> <span class='hs-varid'>ig</span> <span class='hs-varid'>areaSize</span> <span class='hs-varid'>start</span> <span class='hs-varid'>areaMap</span> <span class='hs-varid'>area</span>
<a name="line-394"></a>            <span class='hs-keyword'>else</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>insert</span> <span class='hs-varid'>area</span> <span class='hs-varid'>inSp</span> <span class='hs-varid'>areaMap</span>
<a name="line-395"></a>          <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"Block not found in cfg"</span>
<a name="line-396"></a>        <span class='hs-keyword'>where</span> <span class='hs-varid'>area</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CallArea</span> <span class='hs-layout'>(</span><span class='hs-conid'>Young</span> <span class='hs-varid'>bid</span><span class='hs-layout'>)</span>
<a name="line-397"></a>
<a name="line-398"></a>      <span class='hs-varid'>layoutAreas</span> <span class='hs-varid'>areaMap</span> <span class='hs-varid'>block</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldBlockNodesF3</span> <span class='hs-layout'>(</span><span class='hs-varid'>flip</span> <span class='hs-varid'>const</span><span class='hs-layout'>,</span> <span class='hs-varid'>allocMid</span><span class='hs-layout'>,</span> <span class='hs-varid'>allocLast</span> <span class='hs-layout'>(</span><span class='hs-varid'>entryLabel</span> <span class='hs-varid'>block</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>block</span> <span class='hs-varid'>areaMap</span>
<a name="line-399"></a>      <span class='hs-varid'>allocMid</span> <span class='hs-varid'>m</span> <span class='hs-varid'>areaMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldSlotsDefd</span> <span class='hs-varid'>alloc'</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldSlotsUsed</span> <span class='hs-varid'>alloc'</span> <span class='hs-varid'>areaMap</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span>
<a name="line-400"></a>      <span class='hs-varid'>allocLast</span> <span class='hs-varid'>bid</span> <span class='hs-varid'>l</span> <span class='hs-varid'>areaMap</span> <span class='hs-keyglyph'>=</span>
<a name="line-401"></a>        <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>setSuccSPs</span> <span class='hs-varid'>inSp</span><span class='hs-layout'>)</span> <span class='hs-varid'>areaMap'</span> <span class='hs-layout'>(</span><span class='hs-varid'>successors</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-402"></a>        <span class='hs-keyword'>where</span> <span class='hs-varid'>inSp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>slot</span> <span class='hs-varop'>+</span> <span class='hs-varid'>spOffset</span> <span class='hs-comment'>-- [Procpoint Sp offset]</span>
<a name="line-403"></a>              <span class='hs-comment'>-- If it's not in the map, we should use our previous</span>
<a name="line-404"></a>              <span class='hs-comment'>-- calculation unchanged.</span>
<a name="line-405"></a>              <span class='hs-varid'>spOffset</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapLookup</span> <span class='hs-varid'>bid</span> <span class='hs-varid'>spEntryMap</span> <span class='hs-varop'>`orElse`</span> <span class='hs-num'>0</span>
<a name="line-406"></a>              <span class='hs-varid'>slot</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expectJust</span> <span class='hs-str'>"slot in"</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-layout'>(</span><span class='hs-conid'>CallArea</span> <span class='hs-layout'>(</span><span class='hs-conid'>Young</span> <span class='hs-varid'>bid</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>areaMap</span>
<a name="line-407"></a>              <span class='hs-varid'>areaMap'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldSlotsDefd</span> <span class='hs-varid'>alloc'</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldSlotsUsed</span> <span class='hs-varid'>alloc'</span> <span class='hs-varid'>areaMap</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-varid'>l</span>
<a name="line-408"></a>      <span class='hs-varid'>alloc'</span> <span class='hs-varid'>areaMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>RegSlot</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>allocVarSlot</span> <span class='hs-varid'>areaMap</span> <span class='hs-varid'>a</span>
<a name="line-409"></a>      <span class='hs-varid'>alloc'</span> <span class='hs-varid'>areaMap</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>areaMap</span>
<a name="line-410"></a>
<a name="line-411"></a>      <span class='hs-varid'>initMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>insert</span> <span class='hs-layout'>(</span><span class='hs-conid'>CallArea</span> <span class='hs-layout'>(</span><span class='hs-conid'>Young</span> <span class='hs-layout'>(</span><span class='hs-varid'>g_entry</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-num'>0</span>
<a name="line-412"></a>              <span class='hs-varop'>.</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>insert</span> <span class='hs-layout'>(</span><span class='hs-conid'>CallArea</span> <span class='hs-conid'>Old</span><span class='hs-layout'>)</span>                 <span class='hs-num'>0</span>
<a name="line-413"></a>              <span class='hs-varop'>$</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span>
<a name="line-414"></a>
<a name="line-415"></a>      <span class='hs-varid'>areaMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-varid'>layoutAreas</span> <span class='hs-varid'>initMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>postorderDfs</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span>
<a name="line-416"></a>  <span class='hs-keyword'>in</span> <span class='hs-comment'>-- pprTrace "ProcPoints" (ppr procPoints) $</span>
<a name="line-417"></a>     <span class='hs-comment'>-- pprTrace "Area SizeMap" (ppr areaSize) $</span>
<a name="line-418"></a>     <span class='hs-comment'>-- pprTrace "Entry offset" (ppr entry_off) $</span>
<a name="line-419"></a>     <span class='hs-comment'>-- pprTrace "Area Map" (ppr areaMap) $</span>
<a name="line-420"></a>     <span class='hs-varid'>areaMap</span>
<a name="line-421"></a>
<a name="line-422"></a><span class='hs-comment'>{- Note [Procpoint Sp offset]
<a name="line-423"></a>
<a name="line-424"></a>The calculation of inSp is a little tricky.  (Un)fortunately, if you get
<a name="line-425"></a>it wrong, you will get inefficient but correct code.  You know you've
<a name="line-426"></a>got it wrong if the generated stack pointer bounces up and down for no
<a name="line-427"></a>good reason.
<a name="line-428"></a>
<a name="line-429"></a>Why can't we just set inSp to the location of the slot?  (This is what
<a name="line-430"></a>the code used to do.)  The trouble is when we actually hit the proc
<a name="line-431"></a>point the start of the slot will not be the same as the actual Sp due
<a name="line-432"></a>to argument passing:
<a name="line-433"></a>
<a name="line-434"></a>  a:
<a name="line-435"></a>      I32[(young&lt;b&gt; + 4)] = cde;
<a name="line-436"></a>      // Stack pointer is moved to young end (bottom) of young&lt;b&gt; for call
<a name="line-437"></a>      // +-------+
<a name="line-438"></a>      // | arg 1 |
<a name="line-439"></a>      // +-------+ &lt;- Sp
<a name="line-440"></a>      call (I32[foobar::I32])(...) returns to Just b (4) (4) with update frame 4;
<a name="line-441"></a>  b:
<a name="line-442"></a>      // After call, stack pointer is above the old end (top) of
<a name="line-443"></a>      // young&lt;b&gt; (the difference is spOffset)
<a name="line-444"></a>      // +-------+ &lt;- Sp
<a name="line-445"></a>      // | arg 1 |
<a name="line-446"></a>      // +-------+
<a name="line-447"></a>
<a name="line-448"></a>If we blithely set the Sp to be the same as the slot (the young end of
<a name="line-449"></a>young&lt;b&gt;), an adjustment will be necessary when we go to the next block.
<a name="line-450"></a>This is wasteful.  So, instead, for the next block after a procpoint,
<a name="line-451"></a>the actual Sp should be set to the same as the true Sp when we just
<a name="line-452"></a>entered the procpoint.  Then manifestSP will automatically do the right
<a name="line-453"></a>thing.
<a name="line-454"></a>
<a name="line-455"></a>Questions you may ask:
<a name="line-456"></a>
<a name="line-457"></a>1. Why don't we need to change the mapping for the procpoint itself?
<a name="line-458"></a>   Because manifestSP does its own calculation of the true stack value,
<a name="line-459"></a>   manifestSP will notice the discrepancy between the actual stack
<a name="line-460"></a>   pointer and the slot start, and adjust all of its memory accesses
<a name="line-461"></a>   accordingly.  So the only problem is when we adjust the Sp in
<a name="line-462"></a>   preparation for the successor block; that's why this code is here and
<a name="line-463"></a>   not in setSuccSPs.
<a name="line-464"></a>
<a name="line-465"></a>2. Why don't we make the procpoint call area and the true offset match
<a name="line-466"></a>   up?  If we did that, we would never use memory above the true value
<a name="line-467"></a>   of the stack pointer, thus wasting all of the stack we used to store
<a name="line-468"></a>   arguments.  You might think that some clever changes to the slot
<a name="line-469"></a>   offsets, using negative offsets, might fix it, but this does not make
<a name="line-470"></a>   semantic sense.
<a name="line-471"></a>
<a name="line-472"></a>3. If manifestSP is already calculating the true stack value, why we can't
<a name="line-473"></a>   do this trick inside manifestSP itself?  The reason is that if two
<a name="line-474"></a>   branches join with inconsistent SPs, one of them has to be fixed: we
<a name="line-475"></a>   can't know what the fix should be without already knowing what the
<a name="line-476"></a>   chosen location of SP is on the next successor.  (This is
<a name="line-477"></a>   the "succ already knows incoming SP" case), This calculation cannot
<a name="line-478"></a>   be easily done in manifestSP, since it processes the nodes
<a name="line-479"></a>   /backwards/.  So we need to have figured this out before we hit
<a name="line-480"></a>   manifestSP.
<a name="line-481"></a>-}</span>
<a name="line-482"></a>
<a name="line-483"></a><a name="manifestSP"></a><span class='hs-comment'>-- After determining the stack layout, we can:</span>
<a name="line-484"></a><span class='hs-comment'>-- 1. Replace references to stack Areas with addresses relative to the stack</span>
<a name="line-485"></a><span class='hs-comment'>--    pointer.</span>
<a name="line-486"></a><span class='hs-comment'>-- 2. Insert adjustments to the stack pointer to ensure that it is at a</span>
<a name="line-487"></a><span class='hs-comment'>--    conventional location at each proc point.</span>
<a name="line-488"></a><span class='hs-comment'>--    Because we don't take interrupts on the execution stack, we only need the</span>
<a name="line-489"></a><span class='hs-comment'>--    stack pointer to be younger than the live values on the stack at proc points.</span>
<a name="line-490"></a><span class='hs-comment'>-- 3. Compute the maximum stack offset used in the procedure and replace</span>
<a name="line-491"></a><span class='hs-comment'>--    the stack high-water mark with that offset.</span>
<a name="line-492"></a><span class='hs-definition'>manifestSP</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SpEntryMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AreaMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteOff</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FuelUniqSM</span> <span class='hs-conid'>CmmGraph</span>
<a name="line-493"></a><span class='hs-definition'>manifestSP</span> <span class='hs-varid'>spEntryMap</span> <span class='hs-varid'>areaMap</span> <span class='hs-varid'>entry_off</span> <span class='hs-varid'>g</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CmmGraph</span> <span class='hs-layout'>{</span><span class='hs-varid'>g_entry</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>entry</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-494"></a>  <span class='hs-varid'>ofBlockMap</span> <span class='hs-varid'>entry</span> <span class='hs-varop'>`liftM`</span> <span class='hs-varid'>foldl</span> <span class='hs-varid'>replB</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varid'>mapEmpty</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>postorderDfs</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span>
<a name="line-495"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>slot</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- pprTrace "slot" (ppr a) $</span>
<a name="line-496"></a>                   <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-varid'>a</span> <span class='hs-varid'>areaMap</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"unallocated Area"</span>
<a name="line-497"></a>        <span class='hs-varid'>slot'</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>slot</span> <span class='hs-varop'>$</span> <span class='hs-conid'>CallArea</span> <span class='hs-layout'>(</span><span class='hs-conid'>Young</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-498"></a>        <span class='hs-varid'>slot'</span> <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>slot</span> <span class='hs-varop'>$</span> <span class='hs-conid'>CallArea</span> <span class='hs-conid'>Old</span>
<a name="line-499"></a>        <span class='hs-varid'>sp_high</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maxSlot</span> <span class='hs-varid'>slot</span> <span class='hs-varid'>g</span>
<a name="line-500"></a>        <span class='hs-varid'>proc_entry_sp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>slot</span> <span class='hs-layout'>(</span><span class='hs-conid'>CallArea</span> <span class='hs-conid'>Old</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span> <span class='hs-varid'>entry_off</span>
<a name="line-501"></a>
<a name="line-502"></a>        <span class='hs-varid'>spOffset</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapLookup</span> <span class='hs-varid'>id</span> <span class='hs-varid'>spEntryMap</span> <span class='hs-varop'>`orElse`</span> <span class='hs-num'>0</span>
<a name="line-503"></a>
<a name="line-504"></a>        <span class='hs-varid'>sp_on_entry</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>id</span> <span class='hs-varop'>==</span> <span class='hs-varid'>entry</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>proc_entry_sp</span>
<a name="line-505"></a>        <span class='hs-varid'>sp_on_entry</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>slot'</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span> <span class='hs-varid'>spOffset</span> <span class='hs-varid'>id</span>
<a name="line-506"></a>
<a name="line-507"></a>        <span class='hs-comment'>-- On entry to procpoints, the stack pointer is conventional;</span>
<a name="line-508"></a>        <span class='hs-comment'>-- otherwise, we check the SP set by predecessors.</span>
<a name="line-509"></a>        <span class='hs-varid'>replB</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FuelUniqSM</span> <span class='hs-layout'>(</span><span class='hs-conid'>BlockEnv</span> <span class='hs-conid'>CmmBlock</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmBlock</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FuelUniqSM</span> <span class='hs-layout'>(</span><span class='hs-conid'>BlockEnv</span> <span class='hs-conid'>CmmBlock</span><span class='hs-layout'>)</span>
<a name="line-510"></a>        <span class='hs-varid'>replB</span> <span class='hs-varid'>blocks</span> <span class='hs-varid'>block</span> <span class='hs-keyglyph'>=</span>
<a name="line-511"></a>          <span class='hs-keyword'>do</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span><span class='hs-layout'>,</span> <span class='hs-varid'>middles</span><span class='hs-layout'>,</span> <span class='hs-conid'>JustC</span> <span class='hs-varid'>tail</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeC</span> <span class='hs-conid'>C</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmNode</span> <span class='hs-conid'>O</span> <span class='hs-conid'>C</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>blockToNodeList</span> <span class='hs-varid'>block</span>
<a name="line-512"></a>                 <span class='hs-varid'>middles'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>middle</span> <span class='hs-varid'>spIn</span><span class='hs-layout'>)</span> <span class='hs-varid'>middles</span>
<a name="line-513"></a>             <span class='hs-varid'>bs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>replLast</span> <span class='hs-varid'>head</span> <span class='hs-varid'>middles'</span> <span class='hs-varid'>tail</span>
<a name="line-514"></a>             <span class='hs-varid'>flip</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldr</span> <span class='hs-varid'>insertBlock</span><span class='hs-layout'>)</span> <span class='hs-varid'>bs</span> <span class='hs-varop'>`liftM`</span> <span class='hs-varid'>blocks</span>
<a name="line-515"></a>          <span class='hs-keyword'>where</span> <span class='hs-varid'>spIn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sp_on_entry</span> <span class='hs-layout'>(</span><span class='hs-varid'>entryLabel</span> <span class='hs-varid'>block</span><span class='hs-layout'>)</span>
<a name="line-516"></a>
<a name="line-517"></a>                <span class='hs-varid'>middle</span> <span class='hs-varid'>spOff</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapExpDeep</span> <span class='hs-layout'>(</span><span class='hs-varid'>replSlot</span> <span class='hs-varid'>spOff</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span>
<a name="line-518"></a>                <span class='hs-comment'>-- XXX there shouldn't be any global registers in the</span>
<a name="line-519"></a>                <span class='hs-comment'>-- CmmCall, so there shouldn't be any slots in</span>
<a name="line-520"></a>                <span class='hs-comment'>-- CmmCall... check that...</span>
<a name="line-521"></a>                <span class='hs-varid'>last</span>   <span class='hs-varid'>spOff</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapExpDeep</span> <span class='hs-layout'>(</span><span class='hs-varid'>replSlot</span> <span class='hs-varid'>spOff</span><span class='hs-layout'>)</span> <span class='hs-varid'>l</span>
<a name="line-522"></a>                <span class='hs-varid'>replSlot</span> <span class='hs-varid'>spOff</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmStackSlot</span> <span class='hs-varid'>a</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmRegOff</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmGlobal</span> <span class='hs-conid'>Sp</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>spOff</span> <span class='hs-comment'>-</span> <span class='hs-layout'>(</span><span class='hs-varid'>slot</span> <span class='hs-varid'>a</span> <span class='hs-varop'>+</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-523"></a>                <span class='hs-varid'>replSlot</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLit</span> <span class='hs-conid'>CmmHighStackMark</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- replacing the high water mark</span>
<a name="line-524"></a>                  <span class='hs-conid'>CmmLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmInt</span> <span class='hs-layout'>(</span><span class='hs-varid'>toInteger</span> <span class='hs-layout'>(</span><span class='hs-varid'>max</span> <span class='hs-num'>0</span> <span class='hs-layout'>(</span><span class='hs-varid'>sp_high</span> <span class='hs-comment'>-</span> <span class='hs-varid'>proc_entry_sp</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeWidth</span> <span class='hs-varid'>bWord</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-525"></a>                <span class='hs-comment'>-- Invariant: Sp is always greater than SpLim.  Thus, if</span>
<a name="line-526"></a>                <span class='hs-comment'>-- the high water mark is zero, we can optimize away the</span>
<a name="line-527"></a>                <span class='hs-comment'>-- conditional branch.  Relies on dead code elimination</span>
<a name="line-528"></a>                <span class='hs-comment'>-- to get rid of the dead GC blocks.</span>
<a name="line-529"></a>                <span class='hs-comment'>-- EZY: Maybe turn this into a guard that checks if a</span>
<a name="line-530"></a>                <span class='hs-comment'>-- statement is stack-check ish?  Maybe we should make</span>
<a name="line-531"></a>                <span class='hs-comment'>-- an actual mach-op for it, so there's no chance of</span>
<a name="line-532"></a>                <span class='hs-comment'>-- mixing this up with something else...</span>
<a name="line-533"></a>                <span class='hs-varid'>replSlot</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmMachOp</span> <span class='hs-layout'>(</span><span class='hs-conid'>MO_U_Lt</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-534"></a>                              <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmMachOp</span> <span class='hs-layout'>(</span><span class='hs-conid'>MO_Sub</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-535"></a>                                         <span class='hs-keyglyph'>[</span> <span class='hs-conid'>CmmReg</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmGlobal</span> <span class='hs-conid'>Sp</span><span class='hs-layout'>)</span>
<a name="line-536"></a>                                         <span class='hs-layout'>,</span> <span class='hs-conid'>CmmLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmInt</span> <span class='hs-num'>0</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-537"></a>                               <span class='hs-conid'>CmmReg</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmGlobal</span> <span class='hs-conid'>SpLim</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmInt</span> <span class='hs-num'>0</span> <span class='hs-varid'>wordWidth</span><span class='hs-layout'>)</span>
<a name="line-538"></a>                <span class='hs-varid'>replSlot</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>e</span>
<a name="line-539"></a>
<a name="line-540"></a>                <span class='hs-varid'>replLast</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeC</span> <span class='hs-conid'>C</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmNode</span> <span class='hs-conid'>C</span> <span class='hs-conid'>O</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmNode</span> <span class='hs-conid'>O</span> <span class='hs-conid'>O</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmNode</span> <span class='hs-conid'>O</span> <span class='hs-conid'>C</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FuelUniqSM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmBlock</span><span class='hs-keyglyph'>]</span>
<a name="line-541"></a>                <span class='hs-varid'>replLast</span> <span class='hs-varid'>h</span> <span class='hs-varid'>m</span> <span class='hs-varid'>l</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CmmCall</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>k</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updSp</span> <span class='hs-layout'>(</span><span class='hs-varid'>slot'</span> <span class='hs-varid'>k</span> <span class='hs-varop'>+</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>h</span> <span class='hs-varid'>m</span> <span class='hs-varid'>l</span>
<a name="line-542"></a>                <span class='hs-comment'>-- JD: LastForeignCall probably ought to have an outgoing</span>
<a name="line-543"></a>                <span class='hs-comment'>--     arg size, just like LastCall</span>
<a name="line-544"></a>                <span class='hs-varid'>replLast</span> <span class='hs-varid'>h</span> <span class='hs-varid'>m</span> <span class='hs-varid'>l</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CmmForeignCall</span> <span class='hs-layout'>{</span><span class='hs-varid'>succ</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>k</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updSp</span> <span class='hs-layout'>(</span><span class='hs-varid'>slot'</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span> <span class='hs-varid'>wORD_SIZE</span><span class='hs-layout'>)</span> <span class='hs-varid'>h</span> <span class='hs-varid'>m</span> <span class='hs-varid'>l</span>
<a name="line-545"></a>                <span class='hs-varid'>replLast</span> <span class='hs-varid'>h</span> <span class='hs-varid'>m</span> <span class='hs-varid'>l</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CmmBranch</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updSp</span> <span class='hs-layout'>(</span><span class='hs-varid'>sp_on_entry</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-varid'>h</span> <span class='hs-varid'>m</span> <span class='hs-varid'>l</span>
<a name="line-546"></a>                <span class='hs-varid'>replLast</span> <span class='hs-varid'>h</span> <span class='hs-varid'>m</span> <span class='hs-varid'>l</span>                           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uncurry</span> <span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-layout'>)</span> <span class='hs-varop'>`liftM`</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>succ</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>successors</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-547"></a>                  <span class='hs-keyword'>where</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmBlock</span>
<a name="line-548"></a>                        <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updSp'</span> <span class='hs-varid'>spIn</span> <span class='hs-varid'>h</span> <span class='hs-varid'>m</span> <span class='hs-varid'>l</span>
<a name="line-549"></a>                        <span class='hs-varid'>succ</span> <span class='hs-varid'>succId</span> <span class='hs-varid'>z</span> <span class='hs-keyglyph'>=</span>
<a name="line-550"></a>                          <span class='hs-keyword'>let</span> <span class='hs-varid'>succSp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sp_on_entry</span> <span class='hs-varid'>succId</span> <span class='hs-keyword'>in</span>
<a name="line-551"></a>                          <span class='hs-keyword'>if</span> <span class='hs-varid'>succSp</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>spIn</span> <span class='hs-keyword'>then</span>
<a name="line-552"></a>                            <span class='hs-keyword'>do</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span>  <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>z</span>
<a name="line-553"></a>                               <span class='hs-layout'>(</span><span class='hs-varid'>b'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>insertBetween</span> <span class='hs-varid'>b</span> <span class='hs-layout'>(</span><span class='hs-varid'>adjustSp</span> <span class='hs-varid'>succSp</span><span class='hs-layout'>)</span> <span class='hs-varid'>succId</span>
<a name="line-554"></a>                               <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>b'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bs'</span> <span class='hs-varop'>++</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
<a name="line-555"></a>                          <span class='hs-keyword'>else</span> <span class='hs-varid'>z</span>
<a name="line-556"></a>
<a name="line-557"></a>                <span class='hs-varid'>updSp</span> <span class='hs-varid'>sp</span> <span class='hs-varid'>h</span> <span class='hs-varid'>m</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>updSp'</span> <span class='hs-varid'>sp</span> <span class='hs-varid'>h</span> <span class='hs-varid'>m</span> <span class='hs-varid'>l</span><span class='hs-keyglyph'>]</span>
<a name="line-558"></a>                <span class='hs-varid'>updSp'</span> <span class='hs-varid'>sp</span> <span class='hs-varid'>h</span> <span class='hs-varid'>m</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>sp</span> <span class='hs-varop'>==</span> <span class='hs-varid'>spIn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>blockOfNodeList</span> <span class='hs-layout'>(</span><span class='hs-varid'>h</span><span class='hs-layout'>,</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>JustC</span> <span class='hs-varop'>$</span> <span class='hs-varid'>last</span> <span class='hs-varid'>sp</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-559"></a>                                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>blockOfNodeList</span> <span class='hs-layout'>(</span><span class='hs-varid'>h</span><span class='hs-layout'>,</span> <span class='hs-varid'>m</span> <span class='hs-varop'>++</span> <span class='hs-varid'>adjustSp</span> <span class='hs-varid'>sp</span><span class='hs-layout'>,</span> <span class='hs-conid'>JustC</span> <span class='hs-varop'>$</span> <span class='hs-varid'>last</span> <span class='hs-varid'>sp</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-560"></a>                <span class='hs-varid'>adjustSp</span> <span class='hs-varid'>sp</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmAssign</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmGlobal</span> <span class='hs-conid'>Sp</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>]</span>
<a name="line-561"></a>                  <span class='hs-keyword'>where</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmMachOp</span> <span class='hs-layout'>(</span><span class='hs-conid'>MO_Add</span> <span class='hs-varid'>wordWidth</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmReg</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmGlobal</span> <span class='hs-conid'>Sp</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>off</span><span class='hs-keyglyph'>]</span>
<a name="line-562"></a>                        <span class='hs-varid'>off</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmLit</span> <span class='hs-varop'>$</span> <span class='hs-conid'>CmmInt</span> <span class='hs-layout'>(</span><span class='hs-varid'>toInteger</span> <span class='hs-varop'>$</span> <span class='hs-varid'>spIn</span> <span class='hs-comment'>-</span> <span class='hs-varid'>sp</span><span class='hs-layout'>)</span> <span class='hs-varid'>wordWidth</span>
<a name="line-563"></a>
<a name="line-564"></a>
<a name="line-565"></a><a name="maxSlot"></a><span class='hs-comment'>-- To compute the stack high-water mark, we fold over the graph and</span>
<a name="line-566"></a><span class='hs-comment'>-- compute the highest slot offset.</span>
<a name="line-567"></a><span class='hs-definition'>maxSlot</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Area</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-568"></a><span class='hs-definition'>maxSlot</span> <span class='hs-varid'>slotOff</span> <span class='hs-varid'>g</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldGraphBlocks</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldBlockNodesF3</span> <span class='hs-layout'>(</span><span class='hs-varid'>flip</span> <span class='hs-varid'>const</span><span class='hs-layout'>,</span> <span class='hs-varid'>highSlot</span><span class='hs-layout'>,</span> <span class='hs-varid'>highSlot</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-num'>0</span> <span class='hs-varid'>g</span>
<a name="line-569"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>highSlot</span> <span class='hs-varid'>i</span> <span class='hs-varid'>z</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldSlotsUsed</span> <span class='hs-varid'>add</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldSlotsDefd</span> <span class='hs-varid'>add</span> <span class='hs-varid'>z</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-varid'>i</span>
<a name="line-570"></a>        <span class='hs-varid'>add</span> <span class='hs-varid'>z</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>max</span> <span class='hs-varid'>z</span> <span class='hs-layout'>(</span><span class='hs-varid'>slotOff</span> <span class='hs-varid'>a</span> <span class='hs-varop'>+</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>
<a name="line-571"></a>
<a name="line-572"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-573"></a><span class='hs-comment'>-- | Sanity check: stub pointers immediately after they die</span>
<a name="line-574"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-575"></a><span class='hs-comment'>-- This will miss stack slots that are last used in a Last node,</span>
<a name="line-576"></a><span class='hs-comment'>-- but it should do pretty well...</span>
<a name="line-577"></a>
<a name="line-578"></a><a name="stubSlotsOnDeath"></a><span class='hs-definition'>stubSlotsOnDeath</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmGraph</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FuelUniqSM</span> <span class='hs-conid'>CmmGraph</span>
<a name="line-579"></a><span class='hs-definition'>stubSlotsOnDeath</span> <span class='hs-varid'>g</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>dataflowPassBwd</span> <span class='hs-varid'>g</span> <span class='hs-conid'>[]</span> <span class='hs-varop'>$</span> <span class='hs-varid'>analRewBwd</span> <span class='hs-varid'>slotLattice</span>
<a name="line-580"></a>                                                                   <span class='hs-varid'>liveSlotTransfers</span>
<a name="line-581"></a>                                                                   <span class='hs-varid'>rewrites</span>
<a name="line-582"></a>    <span class='hs-keyword'>where</span> <span class='hs-varid'>rewrites</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkBRewrite3</span> <span class='hs-varid'>frt</span> <span class='hs-varid'>mid</span> <span class='hs-varid'>lst</span>
<a name="line-583"></a>          <span class='hs-varid'>frt</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-584"></a>          <span class='hs-varid'>mid</span> <span class='hs-varid'>m</span> <span class='hs-varid'>liveSlots</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>foldSlotsUsed</span> <span class='hs-layout'>(</span><span class='hs-varid'>stub</span> <span class='hs-varid'>liveSlots</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>m</span>
<a name="line-585"></a>          <span class='hs-varid'>lst</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-586"></a>          <span class='hs-varid'>stub</span> <span class='hs-varid'>liveSlots</span> <span class='hs-varid'>m</span> <span class='hs-varid'>rst</span> <span class='hs-varid'>subarea</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>off</span><span class='hs-layout'>,</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-587"></a>            <span class='hs-keyword'>if</span> <span class='hs-varid'>elemSlot</span> <span class='hs-varid'>liveSlots</span> <span class='hs-varid'>subarea</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>rst</span>
<a name="line-588"></a>            <span class='hs-keyword'>else</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>store</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkMiddle</span> <span class='hs-varop'>$</span> <span class='hs-conid'>CmmStore</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmStackSlot</span> <span class='hs-varid'>a</span> <span class='hs-varid'>off</span><span class='hs-layout'>)</span>
<a name="line-589"></a>                                                 <span class='hs-layout'>(</span><span class='hs-varid'>stackStubExpr</span> <span class='hs-layout'>(</span><span class='hs-varid'>widthFromBytes</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-590"></a>                 <span class='hs-keyword'>in</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>rst</span> <span class='hs-keyword'>of</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkMiddle</span> <span class='hs-varid'>m</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>store</span><span class='hs-layout'>)</span>
<a name="line-591"></a>                                <span class='hs-conid'>Just</span> <span class='hs-varid'>g</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>g</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>store</span><span class='hs-layout'>)</span>
</pre></body>
</html>
