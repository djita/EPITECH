<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>typecheck/TcSMonad.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-comment'>-- Type definitions for the constraint solver</span>
<a name="line-9"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcSMonad</span> <span class='hs-layout'>(</span> 
<a name="line-10"></a>
<a name="line-11"></a>       <span class='hs-comment'>-- Canonical constraints, definition is now in TcRnTypes</span>
<a name="line-12"></a>
<a name="line-13"></a>    <span class='hs-conid'>WorkList</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>isEmptyWorkList</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyWorkList</span><span class='hs-layout'>,</span>
<a name="line-14"></a>    <span class='hs-varid'>workListFromEq</span><span class='hs-layout'>,</span> <span class='hs-varid'>workListFromNonEq</span><span class='hs-layout'>,</span> <span class='hs-varid'>workListFromCt</span><span class='hs-layout'>,</span> 
<a name="line-15"></a>    <span class='hs-varid'>extendWorkListEq</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendWorkListNonEq</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendWorkListCt</span><span class='hs-layout'>,</span> 
<a name="line-16"></a>    <span class='hs-varid'>appendWorkListCt</span><span class='hs-layout'>,</span> <span class='hs-varid'>appendWorkListEqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>unionWorkList</span><span class='hs-layout'>,</span> <span class='hs-varid'>selectWorkItem</span><span class='hs-layout'>,</span>
<a name="line-17"></a>
<a name="line-18"></a>    <span class='hs-varid'>getTcSWorkList</span><span class='hs-layout'>,</span> <span class='hs-varid'>updWorkListTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>updWorkListTcS_return</span><span class='hs-layout'>,</span> <span class='hs-varid'>keepWanted</span><span class='hs-layout'>,</span>
<a name="line-19"></a>
<a name="line-20"></a>    <span class='hs-conid'>Ct</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Xi</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyVarsOfCt</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyVarsOfCts</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyVarsOfCDicts</span><span class='hs-layout'>,</span> 
<a name="line-21"></a>    <span class='hs-varid'>emitFrozenError</span><span class='hs-layout'>,</span>
<a name="line-22"></a>
<a name="line-23"></a>    <span class='hs-varid'>isWanted</span><span class='hs-layout'>,</span> <span class='hs-varid'>isGivenOrSolved</span><span class='hs-layout'>,</span> <span class='hs-varid'>isDerived</span><span class='hs-layout'>,</span>
<a name="line-24"></a>    <span class='hs-varid'>isGivenOrSolvedCt</span><span class='hs-layout'>,</span> <span class='hs-varid'>isGivenCt_maybe</span><span class='hs-layout'>,</span> 
<a name="line-25"></a>    <span class='hs-varid'>isWantedCt</span><span class='hs-layout'>,</span> <span class='hs-varid'>isDerivedCt</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprFlavorArising</span><span class='hs-layout'>,</span>
<a name="line-26"></a>
<a name="line-27"></a>    <span class='hs-varid'>isFlexiTcsTv</span><span class='hs-layout'>,</span>
<a name="line-28"></a>
<a name="line-29"></a>    <span class='hs-varid'>canRewrite</span><span class='hs-layout'>,</span> <span class='hs-varid'>canSolve</span><span class='hs-layout'>,</span>
<a name="line-30"></a>    <span class='hs-varid'>combineCtLoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkSolvedFlavor</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkGivenFlavor</span><span class='hs-layout'>,</span>
<a name="line-31"></a>    <span class='hs-varid'>mkWantedFlavor</span><span class='hs-layout'>,</span>
<a name="line-32"></a>    <span class='hs-varid'>getWantedLoc</span><span class='hs-layout'>,</span>
<a name="line-33"></a>
<a name="line-34"></a>    <span class='hs-conid'>TcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>runTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>failTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>panicTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>traceTcS</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- Basic functionality </span>
<a name="line-35"></a>    <span class='hs-varid'>traceFireTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>bumpStepCountTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>doWithInert</span><span class='hs-layout'>,</span>
<a name="line-36"></a>    <span class='hs-varid'>tryTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>nestImplicTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>recoverTcS</span><span class='hs-layout'>,</span>
<a name="line-37"></a>    <span class='hs-varid'>wrapErrTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrapWarnTcS</span><span class='hs-layout'>,</span>
<a name="line-38"></a>
<a name="line-39"></a>    <span class='hs-conid'>SimplContext</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>isInteractive</span><span class='hs-layout'>,</span> <span class='hs-varid'>simplEqsOnly</span><span class='hs-layout'>,</span> <span class='hs-varid'>performDefaulting</span><span class='hs-layout'>,</span>
<a name="line-40"></a>
<a name="line-41"></a>       <span class='hs-comment'>-- Creation of evidence variables</span>
<a name="line-42"></a>    <span class='hs-varid'>newEvVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>forceNewEvVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>delCachedEvVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>updateFlatCache</span><span class='hs-layout'>,</span> <span class='hs-varid'>flushFlatCache</span><span class='hs-layout'>,</span>
<a name="line-43"></a>    <span class='hs-varid'>newGivenEqVar</span><span class='hs-layout'>,</span>
<a name="line-44"></a>    <span class='hs-varid'>newEqVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>newKindConstraint</span><span class='hs-layout'>,</span>
<a name="line-45"></a>    <span class='hs-conid'>EvVarCreated</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>isNewEvVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>FlatEqOrigin</span> <span class='hs-layout'>(</span> <span class='hs-keyglyph'>..</span> <span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>origin_matches</span><span class='hs-layout'>,</span>
<a name="line-46"></a>
<a name="line-47"></a>       <span class='hs-comment'>-- Setting evidence variables </span>
<a name="line-48"></a>    <span class='hs-varid'>setEqBind</span><span class='hs-layout'>,</span>
<a name="line-49"></a>    <span class='hs-varid'>setEvBind</span><span class='hs-layout'>,</span>
<a name="line-50"></a>
<a name="line-51"></a>    <span class='hs-varid'>setWantedTyBind</span><span class='hs-layout'>,</span>
<a name="line-52"></a>
<a name="line-53"></a>    <span class='hs-varid'>getInstEnvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>getFamInstEnvs</span><span class='hs-layout'>,</span>                <span class='hs-comment'>-- Getting the environments</span>
<a name="line-54"></a>    <span class='hs-varid'>getTopEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>getGblEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTcEvBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>getUntouchables</span><span class='hs-layout'>,</span>
<a name="line-55"></a>    <span class='hs-varid'>getTcEvBindsMap</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTcSContext</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTcSTyBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTcSTyBindsMap</span><span class='hs-layout'>,</span>
<a name="line-56"></a>    <span class='hs-varid'>getTcSEvVarCacheMap</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTcSEvVarFlatCache</span><span class='hs-layout'>,</span> <span class='hs-varid'>setTcSEvVarCacheMap</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprEvVarCache</span><span class='hs-layout'>,</span>
<a name="line-57"></a>
<a name="line-58"></a>    <span class='hs-varid'>newFlattenSkolemTy</span><span class='hs-layout'>,</span>                         <span class='hs-comment'>-- Flatten skolems </span>
<a name="line-59"></a>
<a name="line-60"></a>        <span class='hs-comment'>-- Inerts </span>
<a name="line-61"></a>    <span class='hs-conid'>InertSet</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> 
<a name="line-62"></a>    <span class='hs-varid'>getInertEqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>liftInertEqsTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>getCtCoercion</span><span class='hs-layout'>,</span>
<a name="line-63"></a>    <span class='hs-varid'>emptyInert</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTcSInerts</span><span class='hs-layout'>,</span> <span class='hs-varid'>updInertSet</span><span class='hs-layout'>,</span> <span class='hs-varid'>extractUnsolved</span><span class='hs-layout'>,</span>
<a name="line-64"></a>    <span class='hs-varid'>extractUnsolvedTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>modifyInertTcS</span><span class='hs-layout'>,</span>
<a name="line-65"></a>    <span class='hs-varid'>updInertSetTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>partitionCCanMap</span><span class='hs-layout'>,</span> <span class='hs-varid'>partitionEqMap</span><span class='hs-layout'>,</span>
<a name="line-66"></a>    <span class='hs-varid'>getRelevantCts</span><span class='hs-layout'>,</span> <span class='hs-varid'>extractRelevantInerts</span><span class='hs-layout'>,</span>
<a name="line-67"></a>    <span class='hs-conid'>CCanMap</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>CtTypeMap</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprCtTypeMap</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkPredKeyForTypeMap</span><span class='hs-layout'>,</span> <span class='hs-varid'>partitionCtTypeMap</span><span class='hs-layout'>,</span>
<a name="line-68"></a>
<a name="line-69"></a>
<a name="line-70"></a>    <span class='hs-varid'>instDFunTypes</span><span class='hs-layout'>,</span>                              <span class='hs-comment'>-- Instantiation</span>
<a name="line-71"></a>    <span class='hs-varid'>instDFunConstraints</span><span class='hs-layout'>,</span>          
<a name="line-72"></a>    <span class='hs-varid'>newFlexiTcSTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>instFlexiTcS</span><span class='hs-layout'>,</span>
<a name="line-73"></a>
<a name="line-74"></a>    <span class='hs-varid'>compatKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>compatKindTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>isSubKindTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>unifyKindTcS</span><span class='hs-layout'>,</span>
<a name="line-75"></a>
<a name="line-76"></a>    <span class='hs-conid'>TcsUntouchables</span><span class='hs-layout'>,</span>
<a name="line-77"></a>    <span class='hs-varid'>isTouchableMetaTyVar</span><span class='hs-layout'>,</span>
<a name="line-78"></a>    <span class='hs-varid'>isTouchableMetaTyVar_InRange</span><span class='hs-layout'>,</span> 
<a name="line-79"></a>
<a name="line-80"></a>    <span class='hs-varid'>getDefaultInfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>getDynFlags</span><span class='hs-layout'>,</span>
<a name="line-81"></a>
<a name="line-82"></a>    <span class='hs-varid'>matchClass</span><span class='hs-layout'>,</span> <span class='hs-varid'>matchFam</span><span class='hs-layout'>,</span> <span class='hs-conid'>MatchInstResult</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> 
<a name="line-83"></a>    <span class='hs-varid'>checkWellStagedDFun</span><span class='hs-layout'>,</span> 
<a name="line-84"></a>    <span class='hs-varid'>warnTcS</span><span class='hs-layout'>,</span>
<a name="line-85"></a>    <span class='hs-varid'>pprEq</span>                                    <span class='hs-comment'>-- Smaller utils, re-exported from TcM</span>
<a name="line-86"></a>                                             <span class='hs-comment'>-- TODO (DV): these are only really used in the </span>
<a name="line-87"></a>                                             <span class='hs-comment'>-- instance matcher in TcSimplify. I am wondering</span>
<a name="line-88"></a>                                             <span class='hs-comment'>-- if the whole instance matcher simply belongs</span>
<a name="line-89"></a>                                             <span class='hs-comment'>-- here </span>
<a name="line-90"></a><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span> 
<a name="line-91"></a>
<a name="line-92"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-93"></a>
<a name="line-94"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HscTypes</span>
<a name="line-95"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span> 
<a name="line-96"></a>
<a name="line-97"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Inst</span>
<a name="line-98"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>InstEnv</span> 
<a name="line-99"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInst</span> 
<a name="line-100"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInstEnv</span>
<a name="line-101"></a>
<a name="line-102"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>TcRnMonad</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TcM</span>
<a name="line-103"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>TcMType</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TcM</span>
<a name="line-104"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>TcEnv</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TcM</span> 
<a name="line-105"></a>       <span class='hs-layout'>(</span> <span class='hs-varid'>checkWellStaged</span><span class='hs-layout'>,</span> <span class='hs-varid'>topIdLvl</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcGetDefaultTys</span> <span class='hs-layout'>)</span>
<a name="line-106"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>TcUnify</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span> <span class='hs-varid'>unifyKindEq</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkKindErrorCtxt</span> <span class='hs-layout'>)</span>
<a name="line-107"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Kind</span>
<a name="line-108"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-109"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-110"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-111"></a>
<a name="line-112"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span>
<a name="line-113"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span>
<a name="line-114"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-115"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TypeRep</span> 
<a name="line-116"></a>
<a name="line-117"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-118"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-119"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-120"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-121"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>
<a name="line-122"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MonadUtils</span>
<a name="line-123"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-124"></a>
<a name="line-125"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-126"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-127"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span> 
<a name="line-128"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnTypes</span>
<a name="line-129"></a>
<a name="line-130"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unique</span> 
<a name="line-131"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqFM</span>
<a name="line-132"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span> <span class='hs-layout'>(</span> <span class='hs-varid'>orElse</span> <span class='hs-layout'>)</span>
<a name="line-133"></a>
<a name="line-134"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-layout'>(</span> <span class='hs-varid'>when</span> <span class='hs-layout'>)</span>
<a name="line-135"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>StaticFlags</span><span class='hs-layout'>(</span> <span class='hs-varid'>opt_PprStyle_Debug</span> <span class='hs-layout'>)</span>
<a name="line-136"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>IORef</span>
<a name="line-137"></a>
<a name="line-138"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TrieMap</span>
<a name="line-139"></a>
</pre>\end{code}


\begin{code}
<pre><a name="line-1"></a><a name="compatKind"></a><span class='hs-definition'>compatKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2"></a><span class='hs-definition'>compatKind</span> <span class='hs-varid'>k1</span> <span class='hs-varid'>k2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>k1</span> <span class='hs-varop'>`isSubKind`</span> <span class='hs-varid'>k2</span> <span class='hs-varop'>||</span> <span class='hs-varid'>k2</span> <span class='hs-varop'>`isSubKind`</span> <span class='hs-varid'>k1</span> 
<a name="line-3"></a>
<a name="line-4"></a><a name="compatKindTcS"></a><span class='hs-definition'>compatKindTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Bool</span>
<a name="line-5"></a><span class='hs-comment'>-- Because kind unification happens during constraint solving, we have</span>
<a name="line-6"></a><span class='hs-comment'>-- to make sure that two kinds are zonked before we compare them.</span>
<a name="line-7"></a><span class='hs-definition'>compatKindTcS</span> <span class='hs-varid'>k1</span> <span class='hs-varid'>k2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>compatKindTcM</span> <span class='hs-varid'>k1</span> <span class='hs-varid'>k2</span><span class='hs-layout'>)</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="isSubKindTcS"></a><span class='hs-definition'>isSubKindTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Bool</span>
<a name="line-10"></a><span class='hs-definition'>isSubKindTcS</span> <span class='hs-varid'>k1</span> <span class='hs-varid'>k2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>isSubKindTcM</span> <span class='hs-varid'>k1</span> <span class='hs-varid'>k2</span><span class='hs-layout'>)</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="unifyKindTcS"></a><span class='hs-definition'>unifyKindTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>     <span class='hs-comment'>-- Context</span>
<a name="line-13"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span>     <span class='hs-comment'>-- Corresponding kinds</span>
<a name="line-14"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Bool</span>
<a name="line-15"></a><span class='hs-definition'>unifyKindTcS</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>ki1</span> <span class='hs-varid'>ki2</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>addErrCtxtM</span> <span class='hs-varid'>ctxt</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-17"></a>      <span class='hs-layout'>(</span><span class='hs-sel'>_errs</span><span class='hs-layout'>,</span> <span class='hs-varid'>mb_r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>tryTc</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>unifyKindEq</span> <span class='hs-varid'>ki1</span> <span class='hs-varid'>ki2</span><span class='hs-layout'>)</span>
<a name="line-18"></a>      <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>maybe</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span> <span class='hs-varid'>mb_r</span><span class='hs-layout'>)</span>
<a name="line-19"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>mkKindErrorCtxt</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ki1</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>ki2</span>
<a name="line-20"></a>
</pre>\end{code}

%************************************************************************
%*									*
%*                            Worklists                                *
%*  Canonical and non-canonical constraints that the simplifier has to  *
%*  work on. Including their simplification depths.                     *
%*                                                                      *
%*									*
%************************************************************************

Note [WorkList]
~~~~~~~~~~~~~~~

A WorkList contains canonical and non-canonical items (of all flavors). 
Notice that each Ct now has a simplification depth. We may 
consider using this depth for prioritization as well in the future. 

As a simple form of priority queue, our worklist separates out
equalities (wl_eqs) from the rest of the canonical constraints, 
so that it's easier to deal with them first, but the separation 
is not strictly necessary. Notice that non-canonical constraints 
are also parts of the worklist. 

Note [NonCanonical Semantics]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Note that canonical constraints involve a CNonCanonical constructor. In the worklist
we use this constructor for constraints that have not yet been canonicalized such as 
   [Int] ~ [a] 
In other words, all constraints start life as NonCanonicals. 

On the other hand, in the Inert Set (see below) the presence of a NonCanonical somewhere
means that we have a ``frozen error''. 

NonCanonical constraints never interact directly with other constraints -- but they can
be rewritten by equalities (for instance if a non canonical exists in the inert, we'd 
better rewrite it as much as possible before reporting it as an error to the user)

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><a name="WorkList"></a><span class='hs-comment'>-- See Note [WorkList]</span>
<a name="line-3"></a><a name="WorkList"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WorkList</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span>  <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-4"></a>
<a name="line-5"></a>
<a name="line-6"></a><a name="unionWorkList"></a><span class='hs-definition'>unionWorkList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-7"></a><span class='hs-definition'>unionWorkList</span> <span class='hs-varid'>new_wl</span> <span class='hs-varid'>orig_wl</span> <span class='hs-keyglyph'>=</span> 
<a name="line-8"></a>   <span class='hs-conid'>WorkList</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-varid'>new_wl</span> <span class='hs-varop'>++</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-varid'>orig_wl</span>
<a name="line-9"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-varid'>new_wl</span> <span class='hs-varop'>++</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-varid'>orig_wl</span>
<a name="line-10"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl_rest</span> <span class='hs-varid'>new_wl</span> <span class='hs-varop'>++</span> <span class='hs-varid'>wl_rest</span> <span class='hs-varid'>orig_wl</span> <span class='hs-layout'>}</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="extendWorkListEq"></a><span class='hs-definition'>extendWorkListEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-13"></a><span class='hs-comment'>-- Extension by equality</span>
<a name="line-14"></a><span class='hs-definition'>extendWorkListEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span> 
<a name="line-15"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isCFunEqCan_Maybe</span> <span class='hs-varid'>ct</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span> <span class='hs-conop'>:</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>}</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-18"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span> <span class='hs-conop'>:</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>}</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="extendWorkListNonEq"></a><span class='hs-definition'>extendWorkListNonEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-21"></a><span class='hs-comment'>-- Extension by non equality</span>
<a name="line-22"></a><span class='hs-definition'>extendWorkListNonEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span> <span class='hs-conop'>:</span> <span class='hs-varid'>wl_rest</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>}</span>
<a name="line-23"></a>
<a name="line-24"></a><a name="extendWorkListCt"></a><span class='hs-definition'>extendWorkListCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-25"></a><span class='hs-comment'>-- Agnostic</span>
<a name="line-26"></a><span class='hs-definition'>extendWorkListCt</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span>
<a name="line-27"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEqVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_id</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendWorkListEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span>
<a name="line-28"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendWorkListNonEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span>
<a name="line-29"></a>
<a name="line-30"></a><a name="appendWorkListCt"></a><span class='hs-definition'>appendWorkListCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-31"></a><span class='hs-comment'>-- Agnostic</span>
<a name="line-32"></a><span class='hs-definition'>appendWorkListCt</span> <span class='hs-varid'>cts</span> <span class='hs-varid'>wl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>extendWorkListCt</span> <span class='hs-varid'>wl</span> <span class='hs-varid'>cts</span>
<a name="line-33"></a>
<a name="line-34"></a><a name="appendWorkListEqs"></a><span class='hs-definition'>appendWorkListEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-35"></a><span class='hs-comment'>-- Append a list of equalities</span>
<a name="line-36"></a><span class='hs-definition'>appendWorkListEqs</span> <span class='hs-varid'>cts</span> <span class='hs-varid'>wl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>extendWorkListEq</span> <span class='hs-varid'>wl</span> <span class='hs-varid'>cts</span>
<a name="line-37"></a>
<a name="line-38"></a><a name="isEmptyWorkList"></a><span class='hs-definition'>isEmptyWorkList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-39"></a><span class='hs-definition'>isEmptyWorkList</span> <span class='hs-varid'>wl</span> 
<a name="line-40"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>wl_eqs</span> <span class='hs-varid'>wl</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span>  <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>wl_rest</span> <span class='hs-varid'>wl</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>wl_funeqs</span> <span class='hs-varid'>wl</span><span class='hs-layout'>)</span>
<a name="line-41"></a>
<a name="line-42"></a><a name="emptyWorkList"></a><span class='hs-definition'>emptyWorkList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WorkList</span>
<a name="line-43"></a><span class='hs-definition'>emptyWorkList</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WorkList</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>}</span>
<a name="line-44"></a>
<a name="line-45"></a><a name="workListFromEq"></a><span class='hs-definition'>workListFromEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-46"></a><span class='hs-definition'>workListFromEq</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendWorkListEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>emptyWorkList</span>
<a name="line-47"></a>
<a name="line-48"></a><a name="workListFromNonEq"></a><span class='hs-definition'>workListFromNonEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-49"></a><span class='hs-definition'>workListFromNonEq</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendWorkListNonEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>emptyWorkList</span>
<a name="line-50"></a>
<a name="line-51"></a><a name="workListFromCt"></a><span class='hs-definition'>workListFromCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-52"></a><span class='hs-comment'>-- Agnostic </span>
<a name="line-53"></a><span class='hs-definition'>workListFromCt</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEqVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_id</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>workListFromEq</span> <span class='hs-varid'>ct</span> 
<a name="line-54"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>workListFromNonEq</span> <span class='hs-varid'>ct</span>
<a name="line-55"></a>
<a name="line-56"></a>
<a name="line-57"></a><a name="selectWorkItem"></a><span class='hs-definition'>selectWorkItem</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>,</span> <span class='hs-conid'>WorkList</span><span class='hs-layout'>)</span>
<a name="line-58"></a><span class='hs-definition'>selectWorkItem</span> <span class='hs-varid'>wl</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>WorkList</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>feqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rest</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-59"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>eqs</span><span class='hs-layout'>,</span><span class='hs-varid'>feqs</span><span class='hs-layout'>,</span><span class='hs-varid'>rest</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-60"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-conop'>:</span><span class='hs-varid'>cts</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>ct</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-61"></a>      <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-conop'>:</span><span class='hs-varid'>cts</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>ct</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-62"></a>      <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-conop'>:</span><span class='hs-varid'>cts</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>ct</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_rest</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-63"></a>      <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span><span class='hs-varid'>wl</span><span class='hs-layout'>)</span>
<a name="line-64"></a>
<a name="line-65"></a><span class='hs-comment'>-- Pretty printing </span>
<a name="line-66"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyword'>where</span> 
<a name="line-67"></a>  <span class='hs-varid'>ppr</span> <span class='hs-varid'>wl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"WorkList (eqs)   = "</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>wl_eqs</span> <span class='hs-varid'>wl</span><span class='hs-layout'>)</span>
<a name="line-68"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"WorkList (funeqs)= "</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>wl_funeqs</span> <span class='hs-varid'>wl</span><span class='hs-layout'>)</span>
<a name="line-69"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"WorkList (rest)  = "</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>wl_rest</span> <span class='hs-varid'>wl</span><span class='hs-layout'>)</span>
<a name="line-70"></a>                <span class='hs-keyglyph'>]</span>
<a name="line-71"></a>
<a name="line-72"></a><a name="keepWanted"></a><span class='hs-definition'>keepWanted</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-73"></a><span class='hs-definition'>keepWanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterBag</span> <span class='hs-varid'>isWantedCt</span>
<a name="line-74"></a>    <span class='hs-comment'>-- DV: there used to be a note here that read: </span>
<a name="line-75"></a>    <span class='hs-comment'>-- ``Important: use fold*r*Bag to preserve the order of the evidence variables'' </span>
<a name="line-76"></a>    <span class='hs-comment'>-- DV: Is this still relevant? </span>
<a name="line-77"></a>
</pre>\end{code}

%************************************************************************
%*									*
%*                            Inert sets                                *
%*                                                                      *
%*									*
%************************************************************************


Note [InertSet invariants]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
An InertSet is a bag of canonical constraints, with the following invariants:

  1 No two constraints react with each other. 
    
    A tricky case is when there exists a given (solved) dictionary 
    constraint and a wanted identical constraint in the inert set, but do 
    not react because reaction would create loopy dictionary evidence for 
    the wanted. See note [Recursive dictionaries]

  2 Given equalities form an idempotent substitution [none of the
    given LHS's occur in any of the given RHS's or reactant parts]

  3 Wanted equalities also form an idempotent substitution

  4 The entire set of equalities is acyclic.

  5 Wanted dictionaries are inert with the top-level axiom set 

  6 Equalities of the form tv1 ~ tv2 always have a touchable variable
    on the left (if possible).

  7 No wanted constraints tv1 ~ tv2 with tv1 touchable. Such constraints
    will be marked as solved right before being pushed into the inert set. 
    See note [Touchables and givens].

  8 No Given constraint mentions a touchable unification variable, but 
    Given/Solved may do so. 

  9 Given constraints will also have their superclasses in the inert set, 
    but Given/Solved will not. 
 
Note that 6 and 7 are /not/ enforced by canonicalization but rather by 
insertion in the inert list, ie by TcInteract. 

During the process of solving, the inert set will contain some
previously given constraints, some wanted constraints, and some given
constraints which have arisen from solving wanted constraints. For
now we do not distinguish between given and solved constraints.

Note that we must switch wanted inert items to given when going under an
implication constraint (when in top-level inference mode).

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><a name="CCanMap"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CCanMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CCanMap</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cts_given</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UniqFM</span> <span class='hs-conid'>Cts</span>
<a name="line-3"></a>                                          <span class='hs-comment'>-- Invariant: all Given</span>
<a name="line-4"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>cts_derived</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UniqFM</span> <span class='hs-conid'>Cts</span> 
<a name="line-5"></a>                                          <span class='hs-comment'>-- Invariant: all Derived</span>
<a name="line-6"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>cts_wanted</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UniqFM</span> <span class='hs-conid'>Cts</span> <span class='hs-layout'>}</span> 
<a name="line-7"></a>                                          <span class='hs-comment'>-- Invariant: all Wanted</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="cCanMapToBag"></a><span class='hs-definition'>cCanMapToBag</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CCanMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span> 
<a name="line-10"></a><span class='hs-definition'>cCanMapToBag</span> <span class='hs-varid'>cmap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldUFM</span> <span class='hs-varid'>unionBags</span> <span class='hs-varid'>rest_wder</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts_given</span> <span class='hs-varid'>cmap</span><span class='hs-layout'>)</span>
<a name="line-11"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>rest_wder</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldUFM</span> <span class='hs-varid'>unionBags</span> <span class='hs-varid'>rest_der</span>  <span class='hs-layout'>(</span><span class='hs-varid'>cts_wanted</span> <span class='hs-varid'>cmap</span><span class='hs-layout'>)</span> 
<a name="line-12"></a>        <span class='hs-varid'>rest_der</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldUFM</span> <span class='hs-varid'>unionBags</span> <span class='hs-varid'>emptyCts</span>  <span class='hs-layout'>(</span><span class='hs-varid'>cts_derived</span> <span class='hs-varid'>cmap</span><span class='hs-layout'>)</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="emptyCCanMap"></a><span class='hs-definition'>emptyCCanMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CCanMap</span> <span class='hs-varid'>a</span> 
<a name="line-15"></a><span class='hs-definition'>emptyCCanMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CCanMap</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cts_given</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyUFM</span><span class='hs-layout'>,</span> <span class='hs-varid'>cts_derived</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyUFM</span><span class='hs-layout'>,</span> <span class='hs-varid'>cts_wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyUFM</span> <span class='hs-layout'>}</span> 
<a name="line-16"></a>
<a name="line-17"></a><a name="updCCanMap"></a><span class='hs-definition'>updCCanMap</span><span class='hs-keyglyph'>::</span> <span class='hs-conid'>Uniquable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-conid'>Ct</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CCanMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CCanMap</span> <span class='hs-varid'>a</span> 
<a name="line-18"></a><span class='hs-definition'>updCCanMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-varid'>cmap</span> 
<a name="line-19"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cc_flavor</span> <span class='hs-varid'>ct</span> <span class='hs-keyword'>of</span> 
<a name="line-20"></a>      <span class='hs-conid'>Wanted</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>cmap</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cts_wanted</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insert_into</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts_wanted</span> <span class='hs-varid'>cmap</span><span class='hs-layout'>)</span>  <span class='hs-layout'>}</span> 
<a name="line-21"></a>      <span class='hs-conid'>Given</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>cmap</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cts_given</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insert_into</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts_given</span> <span class='hs-varid'>cmap</span><span class='hs-layout'>)</span>   <span class='hs-layout'>}</span>
<a name="line-22"></a>      <span class='hs-conid'>Derived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>cmap</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cts_derived</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insert_into</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts_derived</span> <span class='hs-varid'>cmap</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-23"></a>  <span class='hs-keyword'>where</span> 
<a name="line-24"></a>    <span class='hs-varid'>insert_into</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addToUFM_C</span> <span class='hs-varid'>unionBags</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-layout'>(</span><span class='hs-varid'>singleCt</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="getRelevantCts"></a><span class='hs-definition'>getRelevantCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Uniquable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CCanMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cts</span><span class='hs-layout'>,</span> <span class='hs-conid'>CCanMap</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> 
<a name="line-27"></a><span class='hs-comment'>-- Gets the relevant constraints and returns the rest of the CCanMap</span>
<a name="line-28"></a><span class='hs-definition'>getRelevantCts</span> <span class='hs-varid'>a</span> <span class='hs-varid'>cmap</span> 
<a name="line-29"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>relevant</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookup</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts_wanted</span> <span class='hs-varid'>cmap</span><span class='hs-layout'>)</span> <span class='hs-varop'>`unionBags`</span>
<a name="line-30"></a>                     <span class='hs-varid'>lookup</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts_given</span> <span class='hs-varid'>cmap</span><span class='hs-layout'>)</span>  <span class='hs-varop'>`unionBags`</span>
<a name="line-31"></a>                     <span class='hs-varid'>lookup</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts_derived</span> <span class='hs-varid'>cmap</span><span class='hs-layout'>)</span> 
<a name="line-32"></a>          <span class='hs-varid'>residual_map</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmap</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cts_wanted</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delFromUFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts_wanted</span> <span class='hs-varid'>cmap</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span>
<a name="line-33"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>cts_given</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delFromUFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts_given</span> <span class='hs-varid'>cmap</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span>
<a name="line-34"></a>                              <span class='hs-layout'>,</span> <span class='hs-varid'>cts_derived</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delFromUFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts_derived</span> <span class='hs-varid'>cmap</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span> <span class='hs-layout'>}</span>
<a name="line-35"></a>      <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>relevant</span><span class='hs-layout'>,</span> <span class='hs-varid'>residual_map</span><span class='hs-layout'>)</span> 
<a name="line-36"></a>  <span class='hs-keyword'>where</span>
<a name="line-37"></a>    <span class='hs-varid'>lookup</span> <span class='hs-varid'>map</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupUFM</span> <span class='hs-varid'>map</span> <span class='hs-varid'>a</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>emptyCts</span>
<a name="line-38"></a>
<a name="line-39"></a>
<a name="line-40"></a><a name="getCtTypeMapRelevants"></a><span class='hs-definition'>getCtTypeMapRelevants</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TypeMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cts</span><span class='hs-layout'>,</span> <span class='hs-conid'>TypeMap</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>)</span>
<a name="line-41"></a><span class='hs-definition'>getCtTypeMapRelevants</span> <span class='hs-varid'>key_pty</span> <span class='hs-varid'>tmap</span>
<a name="line-42"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionCtTypeMap</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkPredKeyForTypeMap</span> <span class='hs-varid'>ct</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>key_pty</span><span class='hs-layout'>)</span> <span class='hs-varid'>tmap</span>
<a name="line-43"></a>
<a name="line-44"></a>
<a name="line-45"></a><a name="partitionCCanMap"></a><span class='hs-definition'>partitionCCanMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CCanMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cts</span><span class='hs-layout'>,</span><span class='hs-conid'>CCanMap</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> 
<a name="line-46"></a><span class='hs-comment'>-- All constraints that /match/ the predicate go in the bag, the rest remain in the map</span>
<a name="line-47"></a><span class='hs-definition'>partitionCCanMap</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>cmap</span>
<a name="line-48"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>ws_map</span><span class='hs-layout'>,</span><span class='hs-varid'>ws</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldUFM_Directly</span> <span class='hs-varid'>aux</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyUFM</span><span class='hs-layout'>,</span><span class='hs-varid'>emptyCts</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts_wanted</span> <span class='hs-varid'>cmap</span><span class='hs-layout'>)</span> 
<a name="line-49"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>ds_map</span><span class='hs-layout'>,</span><span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldUFM_Directly</span> <span class='hs-varid'>aux</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyUFM</span><span class='hs-layout'>,</span><span class='hs-varid'>emptyCts</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts_derived</span> <span class='hs-varid'>cmap</span><span class='hs-layout'>)</span>
<a name="line-50"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>gs_map</span><span class='hs-layout'>,</span><span class='hs-varid'>gs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldUFM_Directly</span> <span class='hs-varid'>aux</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyUFM</span><span class='hs-layout'>,</span><span class='hs-varid'>emptyCts</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts_given</span> <span class='hs-varid'>cmap</span><span class='hs-layout'>)</span> 
<a name="line-51"></a>    <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>ws</span> <span class='hs-varop'>`andCts`</span> <span class='hs-varid'>ds</span> <span class='hs-varop'>`andCts`</span> <span class='hs-varid'>gs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cmap</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cts_wanted</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ws_map</span>
<a name="line-52"></a>                                         <span class='hs-layout'>,</span> <span class='hs-varid'>cts_given</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gs_map</span>
<a name="line-53"></a>                                         <span class='hs-layout'>,</span> <span class='hs-varid'>cts_derived</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ds_map</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> 
<a name="line-54"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>aux</span> <span class='hs-varid'>k</span> <span class='hs-varid'>this_cts</span> <span class='hs-layout'>(</span><span class='hs-varid'>mp</span><span class='hs-layout'>,</span><span class='hs-varid'>acc_cts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_mp</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_acc_cts</span><span class='hs-layout'>)</span>
<a name="line-55"></a>                                    <span class='hs-keyword'>where</span> <span class='hs-varid'>new_mp</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addToUFM</span> <span class='hs-varid'>mp</span> <span class='hs-varid'>k</span> <span class='hs-varid'>cts_keep</span>
<a name="line-56"></a>                                          <span class='hs-varid'>new_acc_cts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc_cts</span> <span class='hs-varop'>`andCts`</span> <span class='hs-varid'>cts_out</span>
<a name="line-57"></a>                                          <span class='hs-layout'>(</span><span class='hs-varid'>cts_out</span><span class='hs-layout'>,</span> <span class='hs-varid'>cts_keep</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionBag</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>this_cts</span>
<a name="line-58"></a>
<a name="line-59"></a><a name="partitionEqMap"></a><span class='hs-definition'>partitionEqMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVarEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span><span class='hs-layout'>,</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVarEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span><span class='hs-layout'>,</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-60"></a><span class='hs-definition'>partitionEqMap</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>isubst</span> 
<a name="line-61"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>eqs_out</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldVarEnv</span> <span class='hs-varid'>extend_if_pred</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>isubst</span>
<a name="line-62"></a>        <span class='hs-varid'>eqs_in</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterVarEnv_Directly</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>pred</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>isubst</span>
<a name="line-63"></a>    <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>eqs_out</span><span class='hs-layout'>,</span> <span class='hs-varid'>eqs_in</span><span class='hs-layout'>)</span>
<a name="line-64"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>extend_if_pred</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>ct</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>ct</span> <span class='hs-conop'>:</span> <span class='hs-varid'>cts</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>cts</span>
<a name="line-65"></a>
<a name="line-66"></a>
<a name="line-67"></a><a name="extractUnsolvedCMap"></a><span class='hs-definition'>extractUnsolvedCMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CCanMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cts</span><span class='hs-layout'>,</span> <span class='hs-conid'>CCanMap</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-68"></a><span class='hs-comment'>-- Gets the wanted or derived constraints and returns a residual</span>
<a name="line-69"></a><span class='hs-comment'>-- CCanMap with only givens.</span>
<a name="line-70"></a><span class='hs-definition'>extractUnsolvedCMap</span> <span class='hs-varid'>cmap</span> <span class='hs-keyglyph'>=</span>
<a name="line-71"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>wntd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldUFM</span> <span class='hs-varid'>unionBags</span> <span class='hs-varid'>emptyCts</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts_wanted</span> <span class='hs-varid'>cmap</span><span class='hs-layout'>)</span>
<a name="line-72"></a>      <span class='hs-varid'>derd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldUFM</span> <span class='hs-varid'>unionBags</span> <span class='hs-varid'>emptyCts</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts_derived</span> <span class='hs-varid'>cmap</span><span class='hs-layout'>)</span>
<a name="line-73"></a>  <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>wntd</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>derd</span><span class='hs-layout'>,</span> 
<a name="line-74"></a>      <span class='hs-varid'>cmap</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cts_wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyUFM</span><span class='hs-layout'>,</span> <span class='hs-varid'>cts_derived</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyUFM</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-75"></a>
<a name="line-76"></a><a name="InertSet"></a><span class='hs-comment'>-- See Note [InertSet invariants]</span>
<a name="line-77"></a><a name="InertSet"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>InertSet</span> 
<a name="line-78"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVarEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span><span class='hs-layout'>,</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>)</span> 
<a name="line-79"></a>         <span class='hs-comment'>-- Must all be CTyEqCans! If an entry exists of the form: </span>
<a name="line-80"></a>         <span class='hs-comment'>--   a |-&gt; ct,co</span>
<a name="line-81"></a>         <span class='hs-comment'>-- Then ct = CTyEqCan { cc_tyvar = a, cc_rhs = xi } </span>
<a name="line-82"></a>         <span class='hs-comment'>-- And  co : a ~ xi</span>
<a name="line-83"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_eq_tvs</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-comment'>-- Invariant: superset of inert_eqs tvs</span>
<a name="line-84"></a>
<a name="line-85"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_dicts</span>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CCanMap</span> <span class='hs-conid'>Class</span> <span class='hs-comment'>-- Dictionaries only, index is the class</span>
<a name="line-86"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_ips</span>          <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CCanMap</span> <span class='hs-layout'>(</span><span class='hs-conid'>IPName</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>      <span class='hs-comment'>-- Implicit parameters </span>
<a name="line-87"></a>         <span class='hs-comment'>-- NB: We do not want to use TypeMaps here because functional dependencies</span>
<a name="line-88"></a>         <span class='hs-comment'>-- will only match on the class but not the type. Similarly IPs match on the</span>
<a name="line-89"></a>         <span class='hs-comment'>-- name but not on the whole datatype</span>
<a name="line-90"></a>
<a name="line-91"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_funeqs</span>       <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtTypeMap</span> <span class='hs-comment'>-- Map from family heads to CFunEqCan constraints</span>
<a name="line-92"></a>
<a name="line-93"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_irreds</span>       <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span>  <span class='hs-comment'>-- Irreducible predicates</span>
<a name="line-94"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_frozen</span>       <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span>  <span class='hs-comment'>-- All non-canonicals are kept here (as frozen errors)</span>
<a name="line-95"></a>       <span class='hs-layout'>}</span>
<a name="line-96"></a>
<a name="line-97"></a>
<a name="line-98"></a><a name="CtTypeMap"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CtTypeMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TypeMap</span> <span class='hs-conid'>Ct</span>
<a name="line-99"></a>
<a name="line-100"></a><a name="pprCtTypeMap"></a><span class='hs-definition'>pprCtTypeMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TypeMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> 
<a name="line-101"></a><span class='hs-definition'>pprCtTypeMap</span> <span class='hs-varid'>ctmap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldTM</span> <span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-layout'>)</span> <span class='hs-varid'>ctmap</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-102"></a>
<a name="line-103"></a><a name="ctTypeMapCts"></a><span class='hs-definition'>ctTypeMapCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TypeMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-104"></a><span class='hs-definition'>ctTypeMapCts</span> <span class='hs-varid'>ctmap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>ct</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extendCts</span> <span class='hs-varid'>cts</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-varid'>ctmap</span> <span class='hs-varid'>emptyCts</span>
<a name="line-105"></a>
<a name="line-106"></a><a name="mkPredKeyForTypeMap"></a><span class='hs-definition'>mkPredKeyForTypeMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredType</span>
<a name="line-107"></a><span class='hs-comment'>-- Create a key from a constraint to use in the inert CtTypeMap.</span>
<a name="line-108"></a><span class='hs-comment'>-- The only interesting case is for family applications, where the </span>
<a name="line-109"></a><span class='hs-comment'>-- key is not the whole PredType of cc_id, but rather the family </span>
<a name="line-110"></a><span class='hs-comment'>-- equality left hand side (head)</span>
<a name="line-111"></a><span class='hs-definition'>mkPredKeyForTypeMap</span> <span class='hs-layout'>(</span><span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_fun</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fn</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xis</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> 
<a name="line-112"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>xis</span>
<a name="line-113"></a><span class='hs-definition'>mkPredKeyForTypeMap</span> <span class='hs-varid'>ct</span> 
<a name="line-114"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evVarPred</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_id</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-115"></a>
<a name="line-116"></a><a name="partitionCtTypeMap"></a><span class='hs-definition'>partitionCtTypeMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span>
<a name="line-117"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TypeMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cts</span><span class='hs-layout'>,</span> <span class='hs-conid'>TypeMap</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>)</span>
<a name="line-118"></a><span class='hs-comment'>-- Kick out the ones that match the predicate and keep the rest in the typemap</span>
<a name="line-119"></a><span class='hs-definition'>partitionCtTypeMap</span> <span class='hs-varid'>f</span> <span class='hs-varid'>ctmap</span>
<a name="line-120"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTM</span> <span class='hs-varid'>upd_acc</span> <span class='hs-varid'>ctmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyBag</span><span class='hs-layout'>,</span><span class='hs-varid'>ctmap</span><span class='hs-layout'>)</span>
<a name="line-121"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>upd_acc</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts</span><span class='hs-layout'>,</span><span class='hs-varid'>acc_map</span><span class='hs-layout'>)</span>
<a name="line-122"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>f</span> <span class='hs-varid'>ct</span>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendCts</span> <span class='hs-varid'>cts</span> <span class='hs-varid'>ct</span><span class='hs-layout'>,</span> <span class='hs-varid'>alterTM</span> <span class='hs-varid'>ct_key</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-varid'>acc_map</span><span class='hs-layout'>)</span>
<a name="line-123"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts</span><span class='hs-layout'>,</span><span class='hs-varid'>acc_map</span><span class='hs-layout'>)</span>
<a name="line-124"></a>         <span class='hs-keyword'>where</span> <span class='hs-varid'>ct_key</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPredKeyForTypeMap</span> <span class='hs-varid'>ct</span>
<a name="line-125"></a>
<a name="line-126"></a>
<a name="line-127"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>InertSet</span> <span class='hs-keyword'>where</span>
<a name="line-128"></a>  <span class='hs-varid'>ppr</span> <span class='hs-varid'>is</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>varEnvElts</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-129"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span><span class='hs-varop'>.</span><span class='hs-varid'>bagToList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-130"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span><span class='hs-varop'>.</span><span class='hs-varid'>bagToList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>cCanMapToBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_dicts</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-131"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span><span class='hs-varop'>.</span><span class='hs-varid'>bagToList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>cCanMapToBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_ips</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-132"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span><span class='hs-varop'>.</span><span class='hs-varid'>bagToList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ctTypeMapCts</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_funeqs</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-133"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Frozen errors ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-comment'>-- Clearly print frozen errors</span>
<a name="line-134"></a>                    <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span><span class='hs-varop'>.</span><span class='hs-varid'>bagToList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>inert_frozen</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-135"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Warning: Not displaying cached (solved) constraints"</span>
<a name="line-136"></a>                <span class='hs-keyglyph'>]</span>
<a name="line-137"></a>                       
<a name="line-138"></a><a name="emptyInert"></a><span class='hs-definition'>emptyInert</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertSet</span>
<a name="line-139"></a><span class='hs-definition'>emptyInert</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-140"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>inert_eq_tvs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyInScopeSet</span>
<a name="line-141"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>inert_frozen</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyCts</span>
<a name="line-142"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>inert_irreds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyCts</span>
<a name="line-143"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>inert_dicts</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyCCanMap</span>
<a name="line-144"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>inert_ips</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyCCanMap</span>
<a name="line-145"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>inert_funeqs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyTM</span>
<a name="line-146"></a>                <span class='hs-layout'>}</span>
<a name="line-147"></a>
<a name="line-148"></a>
<a name="line-149"></a><a name="AtomicInert"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>AtomicInert</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Ct</span> 
<a name="line-150"></a>
<a name="line-151"></a><a name="updInertSet"></a><span class='hs-definition'>updInertSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AtomicInert</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertSet</span> 
<a name="line-152"></a><span class='hs-comment'>-- Add a new inert element to the inert set. </span>
<a name="line-153"></a><span class='hs-definition'>updInertSet</span> <span class='hs-varid'>is</span> <span class='hs-varid'>item</span> 
<a name="line-154"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isCTyEqCan</span> <span class='hs-varid'>item</span>                     
<a name="line-155"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>upd_err</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"updInertSet"</span> <span class='hs-varop'>$</span>
<a name="line-156"></a>                      <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Multiple inert equalities:"</span>
<a name="line-157"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Old (already inert):"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>a</span>
<a name="line-158"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Trying to insert   :"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>b</span>
<a name="line-159"></a>                           <span class='hs-keyglyph'>]</span>
<a name="line-160"></a>                           
<a name="line-161"></a>        <span class='hs-comment'>-- If evidence is cached, pick it up from the flavor!</span>
<a name="line-162"></a>        <span class='hs-varid'>coercion</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getCtCoercion</span> <span class='hs-varid'>item</span>
<a name="line-163"></a>
<a name="line-164"></a>        <span class='hs-varid'>eqs'</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv_C</span> <span class='hs-varid'>upd_err</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span>
<a name="line-165"></a>                                          <span class='hs-layout'>(</span><span class='hs-varid'>cc_tyvar</span> <span class='hs-varid'>item</span><span class='hs-layout'>)</span>
<a name="line-166"></a>                                          <span class='hs-layout'>(</span><span class='hs-varid'>item</span><span class='hs-layout'>,</span> <span class='hs-varid'>coercion</span><span class='hs-layout'>)</span>
<a name="line-167"></a>        <span class='hs-varid'>inscope'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendInScopeSetSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_eq_tvs</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfCt</span> <span class='hs-varid'>item</span><span class='hs-layout'>)</span>
<a name="line-168"></a>    <span class='hs-keyword'>in</span> <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>inert_eq_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inscope'</span> <span class='hs-layout'>}</span>
<a name="line-169"></a>
<a name="line-170"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>x</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isCIPCan_Maybe</span> <span class='hs-varid'>item</span>      <span class='hs-comment'>-- IP </span>
<a name="line-171"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_ips</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updCCanMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span><span class='hs-varid'>item</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_ips</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>  
<a name="line-172"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isCIrredEvCan</span> <span class='hs-varid'>item</span>                  <span class='hs-comment'>-- Presently-irreducible evidence</span>
<a name="line-173"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-varid'>is</span> <span class='hs-varop'>`</span><span class='hs-conid'>Bag</span><span class='hs-varop'>.</span><span class='hs-varid'>snocBag</span><span class='hs-varop'>`</span> <span class='hs-varid'>item</span> <span class='hs-layout'>}</span>
<a name="line-174"></a>
<a name="line-175"></a>
<a name="line-176"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isCDictCan_Maybe</span> <span class='hs-varid'>item</span>   <span class='hs-comment'>-- Dictionary </span>
<a name="line-177"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updCCanMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>cls</span><span class='hs-layout'>,</span><span class='hs-varid'>item</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_dicts</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-178"></a>
<a name="line-179"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-sel'>_tc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isCFunEqCan_Maybe</span> <span class='hs-varid'>item</span>  <span class='hs-comment'>-- Function equality</span>
<a name="line-180"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>pty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPredKeyForTypeMap</span> <span class='hs-varid'>item</span>
<a name="line-181"></a>        <span class='hs-varid'>upd_funeqs</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>item</span>
<a name="line-182"></a>        <span class='hs-varid'>upd_funeqs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-sel'>_alredy_there</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"updInertSet: item already there!"</span>
<a name="line-183"></a>    <span class='hs-keyword'>in</span> <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>alterTM</span> <span class='hs-varid'>pty</span> <span class='hs-varid'>upd_funeqs</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_funeqs</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-184"></a>     
<a name="line-185"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> 
<a name="line-186"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_frozen</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_frozen</span> <span class='hs-varid'>is</span> <span class='hs-varop'>`</span><span class='hs-conid'>Bag</span><span class='hs-varop'>.</span><span class='hs-varid'>snocBag</span><span class='hs-varop'>`</span> <span class='hs-varid'>item</span> <span class='hs-layout'>}</span>
<a name="line-187"></a>
<a name="line-188"></a><a name="updInertSetTcS"></a><span class='hs-definition'>updInertSetTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AtomicInert</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-189"></a><span class='hs-comment'>-- Add a new item in the inerts of the monad</span>
<a name="line-190"></a><span class='hs-definition'>updInertSetTcS</span> <span class='hs-varid'>item</span>
<a name="line-191"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"updInertSetTcs {"</span> <span class='hs-varop'>$</span> 
<a name="line-192"></a>         <span class='hs-varid'>text</span> <span class='hs-str'>"Trying to insert new inert item:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>item</span>
<a name="line-193"></a>
<a name="line-194"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>modifyInertTcS</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>is</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>()</span><span class='hs-layout'>,</span> <span class='hs-varid'>updInertSet</span> <span class='hs-varid'>is</span> <span class='hs-varid'>item</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-195"></a>                        
<a name="line-196"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"updInertSetTcs }"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>empty</span> <span class='hs-layout'>}</span>
<a name="line-197"></a>
<a name="line-198"></a>
<a name="line-199"></a><a name="modifyInertTcS"></a><span class='hs-definition'>modifyInertTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>InertSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-conid'>InertSet</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> 
<a name="line-200"></a><span class='hs-comment'>-- Modify the inert set with the supplied function</span>
<a name="line-201"></a><span class='hs-definition'>modifyInertTcS</span> <span class='hs-varid'>upd</span> 
<a name="line-202"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInertsRef</span>
<a name="line-203"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>curr_inert</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>is_var</span><span class='hs-layout'>)</span>
<a name="line-204"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_inert</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>upd</span> <span class='hs-varid'>curr_inert</span>
<a name="line-205"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>is_var</span> <span class='hs-varid'>new_inert</span><span class='hs-layout'>)</span>
<a name="line-206"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>a</span> <span class='hs-layout'>}</span>
<a name="line-207"></a>
<a name="line-208"></a><a name="extractUnsolvedTcS"></a><span class='hs-definition'>extractUnsolvedTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cts</span><span class='hs-layout'>,</span><span class='hs-conid'>Cts</span><span class='hs-layout'>)</span> 
<a name="line-209"></a><span class='hs-comment'>-- Extracts frozen errors and remaining unsolved and sets the </span>
<a name="line-210"></a><span class='hs-comment'>-- inert set to be the remaining! </span>
<a name="line-211"></a><span class='hs-definition'>extractUnsolvedTcS</span> <span class='hs-keyglyph'>=</span> 
<a name="line-212"></a>  <span class='hs-varid'>modifyInertTcS</span> <span class='hs-varid'>extractUnsolved</span> 
<a name="line-213"></a>
<a name="line-214"></a><a name="extractUnsolved"></a><span class='hs-definition'>extractUnsolved</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>Cts</span><span class='hs-layout'>,</span><span class='hs-conid'>Cts</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>InertSet</span><span class='hs-layout'>)</span>
<a name="line-215"></a><span class='hs-comment'>-- Postcondition</span>
<a name="line-216"></a><span class='hs-comment'>-- -------------</span>
<a name="line-217"></a><span class='hs-comment'>-- When: </span>
<a name="line-218"></a><span class='hs-comment'>--   ((frozen,cts),is_solved) &lt;- extractUnsolved inert</span>
<a name="line-219"></a><span class='hs-comment'>-- Then: </span>
<a name="line-220"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-221"></a><span class='hs-comment'>--  cts       |  The unsolved (Derived or Wanted only) residual </span>
<a name="line-222"></a><span class='hs-comment'>--            |  canonical constraints, that is, no CNonCanonicals.</span>
<a name="line-223"></a><span class='hs-comment'>-- -----------|-----------------------------------------------------------------</span>
<a name="line-224"></a><span class='hs-comment'>--  frozen    | The CNonCanonicals of the original inert (frozen errors), </span>
<a name="line-225"></a><span class='hs-comment'>--            | of all flavors</span>
<a name="line-226"></a><span class='hs-comment'>-- -----------|-----------------------------------------------------------------</span>
<a name="line-227"></a><span class='hs-comment'>--  is_solved | Whatever remains from the inert after removing the previous two. </span>
<a name="line-228"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-229"></a><span class='hs-definition'>extractUnsolved</span> <span class='hs-varid'>is</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>IS</span> <span class='hs-layout'>{</span><span class='hs-varid'>inert_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>irreds</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> 
<a name="line-230"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>is_solved</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>solved_eqs</span>
<a name="line-231"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>inert_eq_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_eq_tvs</span> <span class='hs-varid'>is</span>
<a name="line-232"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>inert_dicts</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>solved_dicts</span>
<a name="line-233"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>inert_ips</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>solved_ips</span>
<a name="line-234"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>solved_irreds</span>
<a name="line-235"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>inert_frozen</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyCts</span>
<a name="line-236"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>solved_funeqs</span>
<a name="line-237"></a>                        <span class='hs-layout'>}</span>
<a name="line-238"></a>    <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>inert_frozen</span> <span class='hs-varid'>is</span><span class='hs-layout'>,</span> <span class='hs-varid'>unsolved</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>is_solved</span><span class='hs-layout'>)</span>
<a name="line-239"></a>
<a name="line-240"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>solved_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterVarEnv_Directly</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isGivenOrSolvedCt</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-varid'>eqs</span>
<a name="line-241"></a>        <span class='hs-varid'>unsolved_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldVarEnv</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-layout'>,</span><span class='hs-sel'>_co</span><span class='hs-layout'>)</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>cts</span> <span class='hs-varop'>`extendCts`</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyCts</span> <span class='hs-varop'>$</span>
<a name="line-242"></a>                       <span class='hs-varid'>eqs</span> <span class='hs-varop'>`minusVarEnv`</span> <span class='hs-varid'>solved_eqs</span>
<a name="line-243"></a>
<a name="line-244"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>unsolved_irreds</span><span class='hs-layout'>,</span> <span class='hs-varid'>solved_irreds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Bag</span><span class='hs-varop'>.</span><span class='hs-varid'>partitionBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span><span class='hs-varop'>.</span><span class='hs-varid'>isGivenOrSolvedCt</span><span class='hs-layout'>)</span> <span class='hs-varid'>irreds</span>
<a name="line-245"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>unsolved_ips</span><span class='hs-layout'>,</span> <span class='hs-varid'>solved_ips</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extractUnsolvedCMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_ips</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span> 
<a name="line-246"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>unsolved_dicts</span><span class='hs-layout'>,</span> <span class='hs-varid'>solved_dicts</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extractUnsolvedCMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_dicts</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span> 
<a name="line-247"></a>
<a name="line-248"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>unsolved_funeqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>solved_funeqs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extractUnsolvedCtTypeMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_funeqs</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span>
<a name="line-249"></a>
<a name="line-250"></a>        <span class='hs-varid'>unsolved</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsolved_eqs</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>unsolved_irreds</span> <span class='hs-varop'>`unionBags`</span>
<a name="line-251"></a>                   <span class='hs-varid'>unsolved_ips</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>unsolved_dicts</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>unsolved_funeqs</span>
<a name="line-252"></a>
<a name="line-253"></a><a name="extractUnsolvedCtTypeMap"></a><span class='hs-definition'>extractUnsolvedCtTypeMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TypeMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cts</span><span class='hs-layout'>,</span><span class='hs-conid'>TypeMap</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>)</span>
<a name="line-254"></a><span class='hs-definition'>extractUnsolvedCtTypeMap</span>
<a name="line-255"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionCtTypeMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isGivenOrSolved</span> <span class='hs-varop'>.</span> <span class='hs-varid'>cc_flavor</span><span class='hs-layout'>)</span>
<a name="line-256"></a>
<a name="line-257"></a>
<a name="line-258"></a><a name="extractRelevantInerts"></a><span class='hs-definition'>extractRelevantInerts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Cts</span>
<a name="line-259"></a><span class='hs-comment'>-- Returns the constraints from the inert set that are 'relevant' to react with </span>
<a name="line-260"></a><span class='hs-comment'>-- this constraint. The monad is left with the 'thinner' inerts. </span>
<a name="line-261"></a><span class='hs-comment'>-- NB: This function contains logic specific to the constraint solver, maybe move there?</span>
<a name="line-262"></a><span class='hs-definition'>extractRelevantInerts</span> <span class='hs-varid'>wi</span> 
<a name="line-263"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyInertTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>extract_inert_relevants</span> <span class='hs-varid'>wi</span><span class='hs-layout'>)</span>
<a name="line-264"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>extract_inert_relevants</span> <span class='hs-layout'>(</span><span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span><span class='hs-varid'>cc_class</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cl</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>is</span> <span class='hs-keyglyph'>=</span> 
<a name="line-265"></a>            <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts</span><span class='hs-layout'>,</span><span class='hs-varid'>dict_map</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getRelevantCts</span> <span class='hs-varid'>cl</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_dicts</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span> 
<a name="line-266"></a>            <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts</span><span class='hs-layout'>,</span> <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dict_map</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-267"></a>        <span class='hs-varid'>extract_inert_relevants</span> <span class='hs-layout'>(</span><span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span><span class='hs-varid'>cc_fun</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xis</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>is</span> <span class='hs-keyglyph'>=</span> 
<a name="line-268"></a>            <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts</span><span class='hs-layout'>,</span><span class='hs-varid'>feqs_map</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getCtTypeMapRelevants</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>xis</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_funeqs</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span>
<a name="line-269"></a>            <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts</span><span class='hs-layout'>,</span> <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>feqs_map</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-270"></a>        <span class='hs-varid'>extract_inert_relevants</span> <span class='hs-layout'>(</span><span class='hs-conid'>CIPCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ip_nm</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nm</span> <span class='hs-layout'>}</span> <span class='hs-layout'>)</span> <span class='hs-varid'>is</span> <span class='hs-keyglyph'>=</span> 
<a name="line-271"></a>            <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts</span><span class='hs-layout'>,</span> <span class='hs-varid'>ips_map</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getRelevantCts</span> <span class='hs-varid'>nm</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_ips</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span> 
<a name="line-272"></a>            <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts</span><span class='hs-layout'>,</span> <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_ips</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ips_map</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-273"></a>        <span class='hs-varid'>extract_inert_relevants</span> <span class='hs-layout'>(</span><span class='hs-conid'>CIrredEvCan</span> <span class='hs-layout'>{</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>is</span> <span class='hs-keyglyph'>=</span> 
<a name="line-274"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-varid'>is</span> 
<a name="line-275"></a>            <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts</span><span class='hs-layout'>,</span> <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyCts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-276"></a>        <span class='hs-varid'>extract_inert_relevants</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>is</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyCts</span><span class='hs-layout'>,</span><span class='hs-varid'>is</span><span class='hs-layout'>)</span>
</pre>\end{code}




%************************************************************************
%*									*
                    CtFlavor
         The "flavor" of a canonical constraint
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="getWantedLoc"></a><span class='hs-definition'>getWantedLoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedLoc</span>
<a name="line-2"></a><span class='hs-definition'>getWantedLoc</span> <span class='hs-varid'>ct</span> 
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span> <span class='hs-layout'>(</span><span class='hs-varid'>isWanted</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_flavor</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-4"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>cc_flavor</span> <span class='hs-varid'>ct</span> <span class='hs-keyword'>of</span> 
<a name="line-5"></a>      <span class='hs-conid'>Wanted</span> <span class='hs-varid'>wl</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wl</span> 
<a name="line-6"></a>      <span class='hs-keyword'>_</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"Can't get WantedLoc of non-wanted constraint!"</span> <span class='hs-varid'>empty</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="isWantedCt"></a><span class='hs-definition'>isWantedCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-9"></a><span class='hs-definition'>isWantedCt</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isWanted</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_flavor</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-10"></a><a name="isDerivedCt"></a><span class='hs-definition'>isDerivedCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-11"></a><span class='hs-definition'>isDerivedCt</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isDerived</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_flavor</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="isGivenCt_maybe"></a><span class='hs-definition'>isGivenCt_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>GivenKind</span>
<a name="line-14"></a><span class='hs-definition'>isGivenCt_maybe</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isGiven_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_flavor</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-15"></a>
<a name="line-16"></a><a name="isGivenOrSolvedCt"></a><span class='hs-definition'>isGivenOrSolvedCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-17"></a><span class='hs-definition'>isGivenOrSolvedCt</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isGivenOrSolved</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_flavor</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-18"></a>
<a name="line-19"></a>
<a name="line-20"></a><a name="canSolve"></a><span class='hs-definition'>canSolve</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> 
<a name="line-21"></a><span class='hs-comment'>-- canSolve ctid1 ctid2 </span>
<a name="line-22"></a><span class='hs-comment'>-- The constraint ctid1 can be used to solve ctid2 </span>
<a name="line-23"></a><span class='hs-comment'>-- "to solve" means a reaction where the active parts of the two constraints match.</span>
<a name="line-24"></a><span class='hs-comment'>--  active(F xis ~ xi) = F xis </span>
<a name="line-25"></a><span class='hs-comment'>--  active(tv ~ xi)    = tv </span>
<a name="line-26"></a><span class='hs-comment'>--  active(D xis)      = D xis </span>
<a name="line-27"></a><span class='hs-comment'>--  active(IP nm ty)   = nm </span>
<a name="line-28"></a><span class='hs-comment'>--</span>
<a name="line-29"></a><span class='hs-comment'>-- NB:  either (a `canSolve` b) or (b `canSolve` a) must hold</span>
<a name="line-30"></a><span class='hs-comment'>-----------------------------------------</span>
<a name="line-31"></a><span class='hs-definition'>canSolve</span> <span class='hs-layout'>(</span><span class='hs-conid'>Given</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-keyword'>_</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> 
<a name="line-32"></a><span class='hs-definition'>canSolve</span> <span class='hs-layout'>(</span><span class='hs-conid'>Wanted</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-layout'>(</span><span class='hs-conid'>Derived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-33"></a><span class='hs-definition'>canSolve</span> <span class='hs-layout'>(</span><span class='hs-conid'>Wanted</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-layout'>(</span><span class='hs-conid'>Wanted</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-34"></a><span class='hs-definition'>canSolve</span> <span class='hs-layout'>(</span><span class='hs-conid'>Derived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Derived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>  <span class='hs-comment'>-- Important: derived can't solve wanted/given</span>
<a name="line-35"></a><span class='hs-definition'>canSolve</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>  	       	     	   <span class='hs-comment'>-- (There is no *evidence* for a derived.)</span>
<a name="line-36"></a>
<a name="line-37"></a><a name="canRewrite"></a><span class='hs-definition'>canRewrite</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> 
<a name="line-38"></a><span class='hs-comment'>-- canRewrite ctid1 ctid2 </span>
<a name="line-39"></a><span class='hs-comment'>-- The *equality_constraint* ctid1 can be used to rewrite inside ctid2 </span>
<a name="line-40"></a><span class='hs-definition'>canRewrite</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>canSolve</span> 
<a name="line-41"></a>
<a name="line-42"></a><a name="combineCtLoc"></a><span class='hs-definition'>combineCtLoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedLoc</span>
<a name="line-43"></a><span class='hs-comment'>-- Precondition: At least one of them should be wanted </span>
<a name="line-44"></a><span class='hs-definition'>combineCtLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Wanted</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span>
<a name="line-45"></a><span class='hs-definition'>combineCtLoc</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Wanted</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span>
<a name="line-46"></a><span class='hs-definition'>combineCtLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Derived</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span>
<a name="line-47"></a><span class='hs-definition'>combineCtLoc</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Derived</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span>
<a name="line-48"></a><span class='hs-definition'>combineCtLoc</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"combineCtLoc: both given"</span>
<a name="line-49"></a>
<a name="line-50"></a><a name="mkSolvedFlavor"></a><span class='hs-definition'>mkSolvedFlavor</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SkolemInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavor</span>
<a name="line-51"></a><span class='hs-comment'>-- To be called when we actually solve a wanted/derived (perhaps leaving residual goals)</span>
<a name="line-52"></a><span class='hs-definition'>mkSolvedFlavor</span> <span class='hs-layout'>(</span><span class='hs-conid'>Wanted</span>  <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-varid'>sk</span>  <span class='hs-varid'>evterm</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Given</span> <span class='hs-layout'>(</span><span class='hs-varid'>setCtLocOrigin</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>sk</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>GivenSolved</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>evterm</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-53"></a><span class='hs-definition'>mkSolvedFlavor</span> <span class='hs-layout'>(</span><span class='hs-conid'>Derived</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-varid'>sk</span>  <span class='hs-varid'>evterm</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Given</span> <span class='hs-layout'>(</span><span class='hs-varid'>setCtLocOrigin</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>sk</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>GivenSolved</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>evterm</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-54"></a><span class='hs-definition'>mkSolvedFlavor</span> <span class='hs-varid'>fl</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Given</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-sel'>_sk</span> <span class='hs-sel'>_evterm</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"Solving a given constraint!"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>fl</span>
<a name="line-55"></a>
<a name="line-56"></a><a name="mkGivenFlavor"></a><span class='hs-definition'>mkGivenFlavor</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SkolemInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavor</span>
<a name="line-57"></a><span class='hs-definition'>mkGivenFlavor</span> <span class='hs-layout'>(</span><span class='hs-conid'>Wanted</span>  <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-varid'>sk</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Given</span> <span class='hs-layout'>(</span><span class='hs-varid'>setCtLocOrigin</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>sk</span><span class='hs-layout'>)</span> <span class='hs-conid'>GivenOrig</span>
<a name="line-58"></a><span class='hs-definition'>mkGivenFlavor</span> <span class='hs-layout'>(</span><span class='hs-conid'>Derived</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-varid'>sk</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Given</span> <span class='hs-layout'>(</span><span class='hs-varid'>setCtLocOrigin</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>sk</span><span class='hs-layout'>)</span> <span class='hs-conid'>GivenOrig</span>
<a name="line-59"></a><span class='hs-definition'>mkGivenFlavor</span> <span class='hs-varid'>fl</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Given</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-sel'>_sk</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"Solving a given constraint!"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>fl</span>
<a name="line-60"></a>
<a name="line-61"></a><a name="mkWantedFlavor"></a><span class='hs-definition'>mkWantedFlavor</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavor</span>
<a name="line-62"></a><span class='hs-definition'>mkWantedFlavor</span> <span class='hs-layout'>(</span><span class='hs-conid'>Wanted</span>  <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Wanted</span> <span class='hs-varid'>loc</span>
<a name="line-63"></a><span class='hs-definition'>mkWantedFlavor</span> <span class='hs-layout'>(</span><span class='hs-conid'>Derived</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Wanted</span> <span class='hs-varid'>loc</span>
<a name="line-64"></a><span class='hs-definition'>mkWantedFlavor</span> <span class='hs-varid'>fl</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Given</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"mkWantedFlavor"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>fl</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*									*
%*		The TcS solver monad                                    *
%*									*
%************************************************************************

Note [The TcS monad]
~~~~~~~~~~~~~~~~~~~~
The TcS monad is a weak form of the main Tc monad

All you can do is
    * fail
    * allocate new variables
    * fill in evidence variables

Filling in a dictionary evidence variable means to create a binding
for it, so TcS carries a mutable location where the binding can be
added.  This is initialised from the innermost implication constraint.

\begin{code}
<pre><a name="line-1"></a><a name="TcSEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcSEnv</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcSEnv</span> <span class='hs-layout'>{</span> 
<a name="line-3"></a>      <span class='hs-varid'>tcs_ev_binds</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindsVar</span><span class='hs-layout'>,</span>
<a name="line-4"></a>      <span class='hs-varid'>tcs_evvar_cache</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>EvVarCache</span><span class='hs-layout'>,</span>
<a name="line-5"></a>          <span class='hs-comment'>-- Evidence bindings and a cache from predicate types to the created evidence </span>
<a name="line-6"></a>          <span class='hs-comment'>-- variables. The scope of the cache will be the same as the scope of tcs_ev_binds</span>
<a name="line-7"></a>
<a name="line-8"></a>      <span class='hs-varid'>tcs_ty_binds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-9"></a>          <span class='hs-comment'>-- Global type bindings</span>
<a name="line-10"></a>
<a name="line-11"></a>      <span class='hs-varid'>tcs_context</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SimplContext</span><span class='hs-layout'>,</span>
<a name="line-12"></a>                     
<a name="line-13"></a>      <span class='hs-varid'>tcs_untch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcsUntouchables</span><span class='hs-layout'>,</span>
<a name="line-14"></a>
<a name="line-15"></a>      <span class='hs-varid'>tcs_ic_depth</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- Implication nesting depth</span>
<a name="line-16"></a>      <span class='hs-varid'>tcs_count</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- Global step count</span>
<a name="line-17"></a>
<a name="line-18"></a>      <span class='hs-varid'>tcs_inerts</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>InertSet</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- Current inert set</span>
<a name="line-19"></a>      <span class='hs-varid'>tcs_worklist</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>WorkList</span>  <span class='hs-comment'>-- Current worklist</span>
<a name="line-20"></a>
<a name="line-21"></a>
<a name="line-22"></a>    <span class='hs-comment'>-- TcSEnv invariant: the tcs_evvar_cache is a superset of tcs_inerts, tcs_worklist, tcs_ev_binds which must </span>
<a name="line-23"></a>    <span class='hs-comment'>--                   all be disjoint with each other.</span>
<a name="line-24"></a>    <span class='hs-layout'>}</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="EvVarCache"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>EvVarCache</span>
<a name="line-27"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvVarCache</span> <span class='hs-layout'>{</span> <span class='hs-varid'>evc_cache</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TypeMap</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvVar</span><span class='hs-layout'>,</span><span class='hs-conid'>CtFlavor</span><span class='hs-layout'>)</span>    
<a name="line-28"></a>                     <span class='hs-comment'>-- Map from PredTys to Evidence variables</span>
<a name="line-29"></a>                     <span class='hs-comment'>-- used to avoid creating new goals</span>
<a name="line-30"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>evc_flat_cache</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TypeMap</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-conid'>Xi</span><span class='hs-layout'>,</span><span class='hs-conid'>CtFlavor</span><span class='hs-layout'>,</span><span class='hs-conid'>FlatEqOrigin</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-31"></a>                     <span class='hs-comment'>-- Map from family-free heads (F xi) to family-free types.</span>
<a name="line-32"></a>                     <span class='hs-comment'>-- Useful during flattening to share flatten skolem generation</span>
<a name="line-33"></a>                     <span class='hs-comment'>-- The boolean flag:</span>
<a name="line-34"></a>                     <span class='hs-comment'>--   True  &lt;-&gt; This equation was generated originally during flattening</span>
<a name="line-35"></a>                     <span class='hs-comment'>--   False &lt;-&gt; This equation was generated by having solved a goal</span>
<a name="line-36"></a>               <span class='hs-layout'>}</span>
<a name="line-37"></a>
<a name="line-38"></a><a name="FlatEqOrigin"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>FlatEqOrigin</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WhileFlattening</span>  <span class='hs-comment'>-- Was it generated during flattening?</span>
<a name="line-39"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WhenSolved</span>       <span class='hs-comment'>-- Was it generated when a family equation was solved?</span>
<a name="line-40"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Any</span>
<a name="line-41"></a>
<a name="line-42"></a><a name="origin_matches"></a><span class='hs-definition'>origin_matches</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FlatEqOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FlatEqOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-43"></a><span class='hs-definition'>origin_matches</span> <span class='hs-conid'>Any</span> <span class='hs-keyword'>_</span>                           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-44"></a><span class='hs-definition'>origin_matches</span> <span class='hs-conid'>WhenSolved</span> <span class='hs-conid'>WhenSolved</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-45"></a><span class='hs-definition'>origin_matches</span> <span class='hs-conid'>WhileFlattening</span> <span class='hs-conid'>WhileFlattening</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-46"></a><span class='hs-definition'>origin_matches</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-47"></a>
<a name="line-48"></a>
<a name="line-49"></a><a name="TcsUntouchables"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcsUntouchables</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Untouchables</span><span class='hs-layout'>,</span><span class='hs-conid'>TcTyVarSet</span><span class='hs-layout'>)</span>
<a name="line-50"></a><span class='hs-comment'>-- Like the TcM Untouchables, </span>
<a name="line-51"></a><span class='hs-comment'>-- but records extra TcsTv variables generated during simplification</span>
<a name="line-52"></a><span class='hs-comment'>-- See Note [Extra TcsTv untouchables] in TcSimplify</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="SimplContext"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>SimplContext</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SimplInfer</span> <span class='hs-conid'>SDoc</span>	   <span class='hs-comment'>-- Inferring type of a let-bound thing</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SimplRuleLhs</span> <span class='hs-conid'>RuleName</span>  <span class='hs-comment'>-- Inferring type of a RULE lhs</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SimplInteractive</span>	   <span class='hs-comment'>-- Inferring type at GHCi prompt</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SimplCheck</span> <span class='hs-conid'>SDoc</span>	   <span class='hs-comment'>-- Checking a type signature or RULE rhs</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>SimplContext</span> <span class='hs-keyword'>where</span>
<a name="line-8"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SimplInfer</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"SimplInfer"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>d</span>
<a name="line-9"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SimplCheck</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"SimplCheck"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>d</span>
<a name="line-10"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SimplRuleLhs</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"SimplRuleLhs"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>doubleQuotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ftext</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-11"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>SimplInteractive</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"SimplInteractive"</span><span class='hs-layout'>)</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="isInteractive"></a><span class='hs-definition'>isInteractive</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SimplContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-14"></a><span class='hs-definition'>isInteractive</span> <span class='hs-conid'>SimplInteractive</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-15"></a><span class='hs-definition'>isInteractive</span> <span class='hs-keyword'>_</span>                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="simplEqsOnly"></a><span class='hs-definition'>simplEqsOnly</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SimplContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-18"></a><span class='hs-comment'>-- Simplify equalities only, not dictionaries</span>
<a name="line-19"></a><span class='hs-comment'>-- This is used for the LHS of rules; ee</span>
<a name="line-20"></a><span class='hs-comment'>-- Note [Simplifying RULE lhs constraints] in TcSimplify</span>
<a name="line-21"></a><span class='hs-definition'>simplEqsOnly</span> <span class='hs-layout'>(</span><span class='hs-conid'>SimplRuleLhs</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-22"></a><span class='hs-definition'>simplEqsOnly</span> <span class='hs-keyword'>_</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-23"></a>
<a name="line-24"></a><a name="performDefaulting"></a><span class='hs-definition'>performDefaulting</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SimplContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-25"></a><span class='hs-definition'>performDefaulting</span> <span class='hs-layout'>(</span><span class='hs-conid'>SimplInfer</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-26"></a><span class='hs-definition'>performDefaulting</span> <span class='hs-layout'>(</span><span class='hs-conid'>SimplRuleLhs</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-27"></a><span class='hs-definition'>performDefaulting</span> <span class='hs-conid'>SimplInteractive</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-28"></a><span class='hs-definition'>performDefaulting</span> <span class='hs-layout'>(</span><span class='hs-conid'>SimplCheck</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-29"></a>
<a name="line-30"></a><a name="TcS"></a><span class='hs-comment'>---------------</span>
<a name="line-31"></a><a name="TcS"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcSEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-layout'>}</span> 
<a name="line-32"></a>
<a name="line-33"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Functor</span> <span class='hs-conid'>TcS</span> <span class='hs-keyword'>where</span>
<a name="line-34"></a>  <span class='hs-varid'>fmap</span> <span class='hs-varid'>f</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>f</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unTcS</span> <span class='hs-varid'>m</span>
<a name="line-35"></a>
<a name="line-36"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Monad</span> <span class='hs-conid'>TcS</span> <span class='hs-keyword'>where</span> 
<a name="line-37"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>x</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> 
<a name="line-38"></a>  <span class='hs-varid'>fail</span> <span class='hs-varid'>err</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fail</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span> 
<a name="line-39"></a>  <span class='hs-varid'>m</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>k</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>ebs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unTcS</span> <span class='hs-varid'>m</span> <span class='hs-varid'>ebs</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>r</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-varid'>ebs</span><span class='hs-layout'>)</span>
<a name="line-40"></a>
<a name="line-41"></a><a name="wrapTcS"></a><span class='hs-comment'>-- Basic functionality </span>
<a name="line-42"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-43"></a><span class='hs-definition'>wrapTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> 
<a name="line-44"></a><span class='hs-comment'>-- Do not export wrapTcS, because it promotes an arbitrary TcM to TcS,</span>
<a name="line-45"></a><span class='hs-comment'>-- and TcS is supposed to have limited functionality</span>
<a name="line-46"></a><span class='hs-definition'>wrapTcS</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>.</span> <span class='hs-varid'>const</span> <span class='hs-comment'>-- a TcM action will not use the TcEvBinds</span>
<a name="line-47"></a>
<a name="line-48"></a><a name="wrapErrTcS"></a><span class='hs-definition'>wrapErrTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> 
<a name="line-49"></a><span class='hs-comment'>-- The thing wrapped should just fail</span>
<a name="line-50"></a><span class='hs-comment'>-- There's no static check; it's up to the user</span>
<a name="line-51"></a><span class='hs-comment'>-- Having a variant for each error message is too painful</span>
<a name="line-52"></a><span class='hs-definition'>wrapErrTcS</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span>
<a name="line-53"></a>
<a name="line-54"></a><a name="wrapWarnTcS"></a><span class='hs-definition'>wrapWarnTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> 
<a name="line-55"></a><span class='hs-comment'>-- The thing wrapped should just add a warning, or no-op</span>
<a name="line-56"></a><span class='hs-comment'>-- There's no static check; it's up to the user</span>
<a name="line-57"></a><span class='hs-definition'>wrapWarnTcS</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span>
<a name="line-58"></a>
<a name="line-59"></a><a name="failTcS"></a><span class='hs-definition'>failTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>panicTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-60"></a><span class='hs-definition'>failTcS</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>.</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>failWith</span>
<a name="line-61"></a><a name="panicTcS"></a><span class='hs-definition'>panicTcS</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"TcCanonical"</span> <span class='hs-varid'>doc</span>
<a name="line-62"></a>
<a name="line-63"></a><a name="traceTcS"></a><span class='hs-definition'>traceTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-64"></a><span class='hs-definition'>traceTcS</span> <span class='hs-varid'>herald</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>traceTc</span> <span class='hs-varid'>herald</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span>
<a name="line-65"></a>
<a name="line-66"></a><a name="bumpStepCountTcS"></a><span class='hs-definition'>bumpStepCountTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-67"></a><span class='hs-definition'>bumpStepCountTcS</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcs_count</span> <span class='hs-varid'>env</span>
<a name="line-68"></a>                                    <span class='hs-layout'>;</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>ref</span>
<a name="line-69"></a>                                    <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-70"></a>
<a name="line-71"></a><a name="traceFireTcS"></a><span class='hs-definition'>traceFireTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-72"></a><span class='hs-comment'>-- Dump a rule-firing trace</span>
<a name="line-73"></a><span class='hs-definition'>traceFireTcS</span> <span class='hs-varid'>depth</span> <span class='hs-varid'>doc</span> 
<a name="line-74"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span> 
<a name="line-75"></a>    <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>ifDOptM</span> <span class='hs-conid'>Opt_D_dump_cs_trace</span> <span class='hs-varop'>$</span> 
<a name="line-76"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcs_count</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-77"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>int</span> <span class='hs-varid'>n</span> 
<a name="line-78"></a>                <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>replicate</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcs_ic_depth</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-chr'>'&gt;'</span><span class='hs-layout'>)</span>
<a name="line-79"></a>                <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>int</span> <span class='hs-varid'>depth</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>doc</span>
<a name="line-80"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>dumpTcRn</span> <span class='hs-varid'>msg</span> <span class='hs-layout'>}</span>
<a name="line-81"></a>
<a name="line-82"></a><a name="runTcS"></a><span class='hs-definition'>runTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SimplContext</span>
<a name="line-83"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Untouchables</span> 	       <span class='hs-comment'>-- Untouchables</span>
<a name="line-84"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertSet</span>             <span class='hs-comment'>-- Initial inert set</span>
<a name="line-85"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>             <span class='hs-comment'>-- Initial work list</span>
<a name="line-86"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>		       <span class='hs-comment'>-- What to run</span>
<a name="line-87"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>EvBind</span><span class='hs-layout'>)</span>
<a name="line-88"></a><span class='hs-definition'>runTcS</span> <span class='hs-varid'>context</span> <span class='hs-varid'>untouch</span> <span class='hs-varid'>is</span> <span class='hs-varid'>wl</span> <span class='hs-varid'>tcs</span> 
<a name="line-89"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-90"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ev_cache_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-varop'>$</span> 
<a name="line-91"></a>                         <span class='hs-conid'>EvVarCache</span> <span class='hs-layout'>{</span> <span class='hs-varid'>evc_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyTM</span><span class='hs-layout'>,</span> <span class='hs-varid'>evc_flat_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyTM</span> <span class='hs-layout'>}</span>
<a name="line-92"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ev_binds_var</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>EvBindsVar</span> <span class='hs-varid'>evb_ref</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcEvBinds</span>
<a name="line-93"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>step_count</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-num'>0</span>
<a name="line-94"></a>
<a name="line-95"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>inert_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-varid'>is</span> 
<a name="line-96"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wl_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-varid'>wl</span>
<a name="line-97"></a>
<a name="line-98"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcSEnv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_ev_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-99"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_evvar_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_cache_var</span>
<a name="line-100"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_ty_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_binds_var</span>
<a name="line-101"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_context</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>context</span>
<a name="line-102"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_untch</span>    <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>untouch</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyVarSet</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- No Tcs untouchables yet</span>
<a name="line-103"></a>			  <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_count</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>step_count</span>
<a name="line-104"></a>			  <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_ic_depth</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-105"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_inerts</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_var</span>
<a name="line-106"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_worklist</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl_var</span> <span class='hs-layout'>}</span>
<a name="line-107"></a>
<a name="line-108"></a>	     <span class='hs-comment'>-- Run the computation</span>
<a name="line-109"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unTcS</span> <span class='hs-varid'>tcs</span> <span class='hs-varid'>env</span>
<a name="line-110"></a>	     <span class='hs-comment'>-- Perform the type unifications required</span>
<a name="line-111"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>ty_binds_var</span>
<a name="line-112"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>do_unification</span> <span class='hs-layout'>(</span><span class='hs-varid'>varEnvElts</span> <span class='hs-varid'>ty_binds</span><span class='hs-layout'>)</span>
<a name="line-113"></a>
<a name="line-114"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-varid'>debugIsOn</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-115"></a>             <span class='hs-varid'>count</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>step_count</span>
<a name="line-116"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_PprStyle_Debug</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>count</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-117"></a>             <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>debugDumpTcRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Constraint solver steps ="</span><span class='hs-layout'>)</span> 
<a name="line-118"></a>                                <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>count</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>context</span><span class='hs-layout'>)</span>
<a name="line-119"></a>         <span class='hs-layout'>}</span>
<a name="line-120"></a>             <span class='hs-comment'>-- And return</span>
<a name="line-121"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ev_binds</span>      <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>evb_ref</span>
<a name="line-122"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-varid'>evBindMapBinds</span> <span class='hs-varid'>ev_binds</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-123"></a>  <span class='hs-keyword'>where</span>
<a name="line-124"></a>    <span class='hs-varid'>do_unification</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeMetaTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span>
<a name="line-125"></a>
<a name="line-126"></a>
<a name="line-127"></a><a name="doWithInert"></a><span class='hs-definition'>doWithInert</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> 
<a name="line-128"></a><span class='hs-definition'>doWithInert</span> <span class='hs-varid'>inert</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcS</span> <span class='hs-varid'>action</span><span class='hs-layout'>)</span>
<a name="line-129"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new_inert_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-varid'>inert</span>
<a name="line-130"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>orig_cache_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcs_evvar_cache</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-131"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>new_cache_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-varid'>orig_cache_var</span>
<a name="line-132"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>action</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_inerts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_inert_var</span> 
<a name="line-133"></a>                                   <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_evvar_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_cache_var</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-134"></a>
<a name="line-135"></a>
<a name="line-136"></a><a name="nestImplicTcS"></a><span class='hs-definition'>nestImplicTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindsVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcsUntouchables</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> 
<a name="line-137"></a><span class='hs-definition'>nestImplicTcS</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>(</span><span class='hs-varid'>inner_range</span><span class='hs-layout'>,</span> <span class='hs-varid'>inner_tcs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcS</span> <span class='hs-varid'>thing_inside</span><span class='hs-layout'>)</span> 
<a name="line-138"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-conid'>TcSEnv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_ty_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_binds</span>
<a name="line-139"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_evvar_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orig_evvar_cache_var</span>
<a name="line-140"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_untch</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-sel'>_outer_range</span><span class='hs-layout'>,</span> <span class='hs-varid'>outer_tcs</span><span class='hs-layout'>)</span>
<a name="line-141"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_count</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>count</span>
<a name="line-142"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_ic_depth</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idepth</span>
<a name="line-143"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_context</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt</span>
<a name="line-144"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_inerts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_var</span>
<a name="line-145"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_worklist</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl_var</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> 
<a name="line-146"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>inner_untch</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>inner_range</span><span class='hs-layout'>,</span> <span class='hs-varid'>outer_tcs</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>inner_tcs</span><span class='hs-layout'>)</span>
<a name="line-147"></a>       		   <span class='hs-comment'>-- The inner_range should be narrower than the outer one</span>
<a name="line-148"></a>		   <span class='hs-comment'>-- (thus increasing the set of untouchables) but </span>
<a name="line-149"></a>		   <span class='hs-comment'>-- the inner Tcs-untouchables must be unioned with the</span>
<a name="line-150"></a>		   <span class='hs-comment'>-- outer ones!</span>
<a name="line-151"></a>
<a name="line-152"></a>         <span class='hs-comment'>-- Inherit the inerts from the outer scope</span>
<a name="line-153"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>orig_inerts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>inert_var</span>
<a name="line-154"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_inert_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-varid'>orig_inerts</span>
<a name="line-155"></a>                          
<a name="line-156"></a>         <span class='hs-comment'>-- Inherit EvVar cache</span>
<a name="line-157"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>orig_evvar_cache</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>orig_evvar_cache_var</span>
<a name="line-158"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>evvar_cache</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-varid'>orig_evvar_cache</span>
<a name="line-159"></a> 
<a name="line-160"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>nest_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcSEnv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_ev_binds</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ref</span>
<a name="line-161"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_evvar_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evvar_cache</span>
<a name="line-162"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_ty_binds</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_binds</span>
<a name="line-163"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_untch</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inner_untch</span>
<a name="line-164"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_count</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>count</span>
<a name="line-165"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_ic_depth</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idepth</span><span class='hs-varop'>+</span><span class='hs-num'>1</span>
<a name="line-166"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_context</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxtUnderImplic</span> <span class='hs-varid'>ctxt</span> 
<a name="line-167"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_inerts</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_inert_var</span>
<a name="line-168"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_worklist</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl_var</span> 
<a name="line-169"></a>                               <span class='hs-comment'>-- NB: worklist is going to be empty anyway, </span>
<a name="line-170"></a>                               <span class='hs-comment'>-- so reuse the same ref cell</span>
<a name="line-171"></a>                               <span class='hs-layout'>}</span>
<a name="line-172"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>nest_env</span> <span class='hs-layout'>}</span> 
<a name="line-173"></a>
<a name="line-174"></a><a name="recoverTcS"></a><span class='hs-definition'>recoverTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-175"></a><span class='hs-definition'>recoverTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcS</span> <span class='hs-varid'>recovery_code</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcS</span> <span class='hs-varid'>thing_inside</span><span class='hs-layout'>)</span>
<a name="line-176"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-177"></a>    <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>recoverM</span> <span class='hs-layout'>(</span><span class='hs-varid'>recovery_code</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing_inside</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-178"></a>
<a name="line-179"></a><a name="ctxtUnderImplic"></a><span class='hs-definition'>ctxtUnderImplic</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SimplContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SimplContext</span>
<a name="line-180"></a><span class='hs-comment'>-- See Note [Simplifying RULE lhs constraints] in TcSimplify</span>
<a name="line-181"></a><span class='hs-definition'>ctxtUnderImplic</span> <span class='hs-layout'>(</span><span class='hs-conid'>SimplRuleLhs</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SimplCheck</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"lhs of rule"</span><span class='hs-layout'>)</span> 
<a name="line-182"></a>                                               <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>doubleQuotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ftext</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-183"></a><span class='hs-definition'>ctxtUnderImplic</span> <span class='hs-varid'>ctxt</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt</span>
<a name="line-184"></a>
<a name="line-185"></a><a name="tryTcS"></a><span class='hs-definition'>tryTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-186"></a><span class='hs-comment'>-- Like runTcS, but from within the TcS monad </span>
<a name="line-187"></a><span class='hs-comment'>-- Completely afresh inerts and worklist, be careful! </span>
<a name="line-188"></a><span class='hs-comment'>-- Moreover, we will simply throw away all the evidence generated. </span>
<a name="line-189"></a><span class='hs-definition'>tryTcS</span> <span class='hs-varid'>tcs</span>
<a name="line-190"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span> 
<a name="line-191"></a>             <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-varid'>emptyWorkList</span>
<a name="line-192"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>is_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-varid'>emptyInert</span>
<a name="line-193"></a>
<a name="line-194"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>ty_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-195"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcEvBinds</span>
<a name="line-196"></a>
<a name="line-197"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>ev_binds_cache_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvVarCache</span> <span class='hs-varid'>emptyTM</span> <span class='hs-varid'>emptyTM</span><span class='hs-layout'>)</span>
<a name="line-198"></a>                    <span class='hs-comment'>-- Empty cache: Don't inherit cache from above, see </span>
<a name="line-199"></a>                    <span class='hs-comment'>-- Note [tryTcS for defaulting] in TcSimplify</span>
<a name="line-200"></a>
<a name="line-201"></a>                <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>env1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_ev_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-202"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_evvar_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_binds_cache_var</span>
<a name="line-203"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_ty_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_binds_var</span>
<a name="line-204"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_inerts</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_var</span>
<a name="line-205"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_worklist</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl_var</span> <span class='hs-layout'>}</span> 
<a name="line-206"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>unTcS</span> <span class='hs-varid'>tcs</span> <span class='hs-varid'>env1</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-207"></a>
<a name="line-208"></a><span class='hs-comment'>-- Getters and setters of TcEnv fields</span>
<a name="line-209"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-210"></a>
<a name="line-211"></a><a name="getTcSInertsRef"></a><span class='hs-comment'>-- Getter of inerts and worklist</span>
<a name="line-212"></a><span class='hs-definition'>getTcSInertsRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>IORef</span> <span class='hs-conid'>InertSet</span><span class='hs-layout'>)</span>
<a name="line-213"></a><span class='hs-definition'>getTcSInertsRef</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tcs_inerts</span><span class='hs-layout'>)</span>
<a name="line-214"></a>
<a name="line-215"></a><a name="getTcSWorkListRef"></a><span class='hs-definition'>getTcSWorkListRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>IORef</span> <span class='hs-conid'>WorkList</span><span class='hs-layout'>)</span> 
<a name="line-216"></a><span class='hs-definition'>getTcSWorkListRef</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tcs_worklist</span><span class='hs-layout'>)</span> 
<a name="line-217"></a>
<a name="line-218"></a><a name="getTcSInerts"></a><span class='hs-definition'>getTcSInerts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>InertSet</span> 
<a name="line-219"></a><span class='hs-definition'>getTcSInerts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getTcSInertsRef</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span><span class='hs-layout'>)</span> 
<a name="line-220"></a>
<a name="line-221"></a><a name="getTcSWorkList"></a><span class='hs-definition'>getTcSWorkList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>WorkList</span>
<a name="line-222"></a><span class='hs-definition'>getTcSWorkList</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getTcSWorkListRef</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span><span class='hs-layout'>)</span> 
<a name="line-223"></a>
<a name="line-224"></a><a name="updWorkListTcS"></a><span class='hs-definition'>updWorkListTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span> 
<a name="line-225"></a><span class='hs-definition'>updWorkListTcS</span> <span class='hs-varid'>f</span> 
<a name="line-226"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updWorkListTcS_return</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>w</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>()</span><span class='hs-layout'>,</span><span class='hs-varid'>f</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-227"></a>
<a name="line-228"></a><a name="updWorkListTcS_return"></a><span class='hs-definition'>updWorkListTcS_return</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-conid'>WorkList</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-229"></a><span class='hs-definition'>updWorkListTcS_return</span> <span class='hs-varid'>f</span>
<a name="line-230"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSWorkListRef</span>
<a name="line-231"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wl_curr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>wl_var</span><span class='hs-layout'>)</span>
<a name="line-232"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span><span class='hs-varid'>new_work</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-varid'>wl_curr</span>
<a name="line-233"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>wl_var</span> <span class='hs-varid'>new_work</span><span class='hs-layout'>)</span>
<a name="line-234"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>res</span> <span class='hs-layout'>}</span>
<a name="line-235"></a>
<a name="line-236"></a><a name="emitFrozenError"></a><span class='hs-definition'>emitFrozenError</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-237"></a><span class='hs-comment'>-- Emits a non-canonical constraint that will stand for a frozen error in the inerts. </span>
<a name="line-238"></a><span class='hs-definition'>emitFrozenError</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>depth</span> 
<a name="line-239"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"Emit frozen error"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ev</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>evVarPred</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-240"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>inert_ref</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInertsRef</span> 
<a name="line-241"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>inert_ref</span><span class='hs-layout'>)</span>
<a name="line-242"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CNonCanonical</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span>
<a name="line-243"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>cc_flavor</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fl</span>
<a name="line-244"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>cc_depth</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>depth</span> <span class='hs-layout'>}</span> 
<a name="line-245"></a>             <span class='hs-varid'>inerts_new</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inerts</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_frozen</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendCts</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_frozen</span> <span class='hs-varid'>inerts</span><span class='hs-layout'>)</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>}</span> 
<a name="line-246"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>inert_ref</span> <span class='hs-varid'>inerts_new</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-247"></a>
<a name="line-248"></a><a name="getDynFlags"></a><span class='hs-definition'>getDynFlags</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>DynFlags</span>
<a name="line-249"></a><span class='hs-definition'>getDynFlags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getDOpts</span>
<a name="line-250"></a>
<a name="line-251"></a><a name="getTcSContext"></a><span class='hs-definition'>getTcSContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>SimplContext</span>
<a name="line-252"></a><span class='hs-definition'>getTcSContext</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tcs_context</span><span class='hs-layout'>)</span>
<a name="line-253"></a>
<a name="line-254"></a><a name="getTcEvBinds"></a><span class='hs-definition'>getTcEvBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>EvBindsVar</span>
<a name="line-255"></a><span class='hs-definition'>getTcEvBinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tcs_ev_binds</span><span class='hs-layout'>)</span> 
<a name="line-256"></a>
<a name="line-257"></a><a name="getTcSEvVarCache"></a><span class='hs-definition'>getTcSEvVarCache</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>IORef</span> <span class='hs-conid'>EvVarCache</span><span class='hs-layout'>)</span>
<a name="line-258"></a><span class='hs-definition'>getTcSEvVarCache</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tcs_evvar_cache</span><span class='hs-layout'>)</span>
<a name="line-259"></a>
<a name="line-260"></a><a name="flushFlatCache"></a><span class='hs-definition'>flushFlatCache</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-261"></a><span class='hs-definition'>flushFlatCache</span>
<a name="line-262"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cache_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSEvVarCache</span>
<a name="line-263"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>the_cache</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>cache_var</span>
<a name="line-264"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>cache_var</span> <span class='hs-layout'>(</span><span class='hs-varid'>the_cache</span> <span class='hs-layout'>{</span> <span class='hs-varid'>evc_flat_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyTM</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-265"></a>
<a name="line-266"></a>
<a name="line-267"></a><a name="getTcSEvVarCacheMap"></a><span class='hs-definition'>getTcSEvVarCacheMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeMap</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvVar</span><span class='hs-layout'>,</span><span class='hs-conid'>CtFlavor</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-268"></a><span class='hs-definition'>getTcSEvVarCacheMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cache_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSEvVarCache</span> 
<a name="line-269"></a>                         <span class='hs-layout'>;</span> <span class='hs-varid'>the_cache</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>cache_var</span> 
<a name="line-270"></a>                         <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>evc_cache</span> <span class='hs-varid'>the_cache</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-271"></a>
<a name="line-272"></a><a name="getTcSEvVarFlatCache"></a><span class='hs-definition'>getTcSEvVarFlatCache</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeMap</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span><span class='hs-conid'>CtFlavor</span><span class='hs-layout'>,</span><span class='hs-conid'>FlatEqOrigin</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-273"></a><span class='hs-definition'>getTcSEvVarFlatCache</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cache_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSEvVarCache</span> 
<a name="line-274"></a>                          <span class='hs-layout'>;</span> <span class='hs-varid'>the_cache</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>cache_var</span> 
<a name="line-275"></a>                          <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>evc_flat_cache</span> <span class='hs-varid'>the_cache</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-276"></a>
<a name="line-277"></a><a name="setTcSEvVarCacheMap"></a><span class='hs-definition'>setTcSEvVarCacheMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TypeMap</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvVar</span><span class='hs-layout'>,</span><span class='hs-conid'>CtFlavor</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span> 
<a name="line-278"></a><span class='hs-definition'>setTcSEvVarCacheMap</span> <span class='hs-varid'>cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cache_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSEvVarCache</span> 
<a name="line-279"></a>                               <span class='hs-layout'>;</span> <span class='hs-varid'>orig_cache</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>cache_var</span>
<a name="line-280"></a>                               <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>new_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orig_cache</span> <span class='hs-layout'>{</span> <span class='hs-varid'>evc_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cache</span> <span class='hs-layout'>}</span> 
<a name="line-281"></a>                               <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>cache_var</span> <span class='hs-varid'>new_cache</span> <span class='hs-layout'>}</span>
<a name="line-282"></a>
<a name="line-283"></a><a name="getUntouchables"></a><span class='hs-definition'>getUntouchables</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcsUntouchables</span>
<a name="line-284"></a><span class='hs-definition'>getUntouchables</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tcs_untch</span><span class='hs-layout'>)</span>
<a name="line-285"></a>
<a name="line-286"></a><a name="getTcSTyBinds"></a><span class='hs-definition'>getTcSTyBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>IORef</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-287"></a><span class='hs-definition'>getTcSTyBinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tcs_ty_binds</span><span class='hs-layout'>)</span>
<a name="line-288"></a>
<a name="line-289"></a><a name="getTcSTyBindsMap"></a><span class='hs-definition'>getTcSTyBindsMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-290"></a><span class='hs-definition'>getTcSTyBindsMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getTcSTyBinds</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span><span class='hs-layout'>)</span> 
<a name="line-291"></a>
<a name="line-292"></a>
<a name="line-293"></a><a name="getTcEvBindsMap"></a><span class='hs-definition'>getTcEvBindsMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>EvBindMap</span>
<a name="line-294"></a><span class='hs-definition'>getTcEvBindsMap</span>
<a name="line-295"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-conid'>EvBindsVar</span> <span class='hs-varid'>ev_ref</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcEvBinds</span> 
<a name="line-296"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>ev_ref</span> <span class='hs-layout'>}</span>
<a name="line-297"></a>
<a name="line-298"></a>
<a name="line-299"></a><a name="setEqBind"></a><span class='hs-definition'>setEqBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EqVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>CtFlavor</span>
<a name="line-300"></a><span class='hs-definition'>setEqBind</span> <span class='hs-varid'>eqv</span> <span class='hs-varid'>co</span> <span class='hs-varid'>fl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setEvBind</span> <span class='hs-varid'>eqv</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCoercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>fl</span>
<a name="line-301"></a>
<a name="line-302"></a><a name="setWantedTyBind"></a><span class='hs-definition'>setWantedTyBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span> 
<a name="line-303"></a><span class='hs-comment'>-- Add a type binding</span>
<a name="line-304"></a><span class='hs-comment'>-- We never do this twice!</span>
<a name="line-305"></a><span class='hs-definition'>setWantedTyBind</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span> 
<a name="line-306"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSTyBinds</span>
<a name="line-307"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> 
<a name="line-308"></a>         <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>ref</span>
<a name="line-309"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-varid'>debugIsOn</span> <span class='hs-varop'>$</span>
<a name="line-310"></a>                  <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>checkErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span> <span class='hs-varop'>`elemVarEnv`</span> <span class='hs-varid'>ty_binds</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-311"></a>                  <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"TERRIBLE ERROR: double set of meta type variable"</span>
<a name="line-312"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>":="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span>
<a name="line-313"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Old value ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupVarEnv_NF</span> <span class='hs-varid'>ty_binds</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-314"></a>            <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>ty_binds</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-315"></a>
<a name="line-316"></a>
<a name="line-317"></a><a name="setEvBind"></a><span class='hs-definition'>setEvBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>CtFlavor</span>
<a name="line-318"></a><span class='hs-comment'>-- If the flavor is Solved, we cache the new evidence term inside the returned flavor</span>
<a name="line-319"></a><span class='hs-comment'>-- see Note [Optimizing Spontaneously Solved Coercions]</span>
<a name="line-320"></a><span class='hs-definition'>setEvBind</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>t</span> <span class='hs-varid'>fl</span>
<a name="line-321"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tc_evbinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcEvBinds</span>
<a name="line-322"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>addTcEvBind</span> <span class='hs-varid'>tc_evbinds</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>t</span>
<a name="line-323"></a>
<a name="line-324"></a><span class='hs-cpp'>#ifdef DEBUG</span>
<a name="line-325"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcEvBindsMap</span>
<a name="line-326"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>cycle</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>reaches</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>evVarsOfTerm</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-327"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-varid'>cycle</span> <span class='hs-layout'>(</span><span class='hs-varid'>fail_if_co_loop</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span>
<a name="line-328"></a><span class='hs-cpp'>#endif</span>
<a name="line-329"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> 
<a name="line-330"></a>         <span class='hs-keyword'>case</span> <span class='hs-varid'>fl</span> <span class='hs-keyword'>of</span> 
<a name="line-331"></a>           <span class='hs-conid'>Given</span> <span class='hs-varid'>gl</span> <span class='hs-layout'>(</span><span class='hs-conid'>GivenSolved</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> 
<a name="line-332"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Given</span> <span class='hs-varid'>gl</span> <span class='hs-layout'>(</span><span class='hs-conid'>GivenSolved</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-333"></a>           <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fl</span>
<a name="line-334"></a>       <span class='hs-layout'>}</span>
<a name="line-335"></a>
<a name="line-336"></a><span class='hs-cpp'>#ifdef DEBUG</span>
<a name="line-337"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>fail_if_co_loop</span> <span class='hs-varid'>binds</span>
<a name="line-338"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTrace</span> <span class='hs-str'>"setEvBind"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Cycle in evidence binds, evvar ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ev</span>
<a name="line-339"></a>                                       <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>evBindMapBinds</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-340"></a>            <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEqVar</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprPanic</span> <span class='hs-str'>"setEvBind"</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"BUG: Coercion loop!"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-341"></a>
<a name="line-342"></a>        <span class='hs-varid'>reaches</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> 
<a name="line-343"></a>        <span class='hs-comment'>-- Does this evvar reach ev? </span>
<a name="line-344"></a>        <span class='hs-varid'>reaches</span> <span class='hs-varid'>ebm</span> <span class='hs-varid'>ev0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ev0</span>
<a name="line-345"></a>          <span class='hs-keyword'>where</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ev0</span>
<a name="line-346"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ev0</span> <span class='hs-varop'>==</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-347"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>evtrm</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupEvBind</span> <span class='hs-varid'>ebm</span> <span class='hs-varid'>ev0</span>
<a name="line-348"></a>                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>any</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>evVarsOfTerm</span> <span class='hs-varid'>evtrm</span><span class='hs-layout'>)</span>
<a name="line-349"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-350"></a><span class='hs-cpp'>#endif</span>
<a name="line-351"></a>
</pre>\end{code}
Note [Optimizing Spontaneously Solved Coercions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 

Spontaneously solved coercions such as alpha := tau used to be bound as everything else
in the evidence binds. Subsequently they were used for rewriting other wanted or solved
goals. For instance: 

WorkItem = [S] g1 : a ~ tau
Inerts   = [S] g2 : b ~ [a]
           [S] g3 : c ~ [(a,a)]

Would result, eventually, after the workitem rewrites the inerts, in the
following evidence bindings:

        g1 = ReflCo tau
        g2 = ReflCo [a]
        g3 = ReflCo [(a,a)]
        g2' = g2 ; [g1] 
        g3' = g3 ; [(g1,g1)]

This ia annoying because it puts way too much stress to the zonker and
desugarer, since we /know/ at the generation time (spontaneously
solving) that the evidence for a particular evidence variable is the
identity.

For this reason, our solution is to cache inside the GivenSolved
flavor of a constraint the term which is actually solving this
constraint. Whenever we perform a setEvBind, a new flavor is returned
so that if it was a GivenSolved to start with, it remains a
GivenSolved with a new evidence term inside. Then, when we use solved
goals to rewrite other constraints we simply use whatever is in the
GivenSolved flavor and not the constraint cc_id.

In our particular case we'd get the following evidence bindings, eventually: 

       g1 = ReflCo tau
       g2 = ReflCo [a]
       g3 = ReflCo [(a,a)]
       g2'= ReflCo [a]
       g3'= ReflCo [(a,a)]

Since we use smart constructors to get rid of g;ReflCo t ~~> g etc.

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a>
<a name="line-3"></a><a name="warnTcS"></a><span class='hs-definition'>warnTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-varid'>orig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-4"></a><span class='hs-definition'>warnTcS</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>warn_if</span> <span class='hs-varid'>doc</span> 
<a name="line-5"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>warn_if</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>setCtLoc</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>addWarnTc</span> <span class='hs-varid'>doc</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="getDefaultInfo"></a><span class='hs-definition'>getDefaultInfo</span> <span class='hs-keyglyph'>::</span>  <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>SimplContext</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-9"></a><span class='hs-definition'>getDefaultInfo</span> 
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSContext</span>
<a name="line-11"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>flags</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>tcGetDefaultTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>isInteractive</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-12"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>flags</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-13"></a>
<a name="line-14"></a><span class='hs-comment'>-- Just get some environments needed for instance looking up and matching</span>
<a name="line-15"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="getInstEnvs"></a><span class='hs-definition'>getInstEnvs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>InstEnv</span><span class='hs-layout'>)</span> 
<a name="line-18"></a><span class='hs-definition'>getInstEnvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Inst</span><span class='hs-varop'>.</span><span class='hs-varid'>tcGetInstEnvs</span> 
<a name="line-19"></a>
<a name="line-20"></a><a name="getFamInstEnvs"></a><span class='hs-definition'>getFamInstEnvs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamInstEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>FamInstEnv</span><span class='hs-layout'>)</span> 
<a name="line-21"></a><span class='hs-definition'>getFamInstEnvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>FamInst</span><span class='hs-varop'>.</span><span class='hs-varid'>tcGetFamInstEnvs</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="getTopEnv"></a><span class='hs-definition'>getTopEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>HscEnv</span> 
<a name="line-24"></a><span class='hs-definition'>getTopEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getTopEnv</span> 
<a name="line-25"></a>
<a name="line-26"></a><a name="getGblEnv"></a><span class='hs-definition'>getGblEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcGblEnv</span> 
<a name="line-27"></a><span class='hs-definition'>getGblEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getGblEnv</span> 
<a name="line-28"></a>
<a name="line-29"></a><span class='hs-comment'>-- Various smaller utilities [TODO, maybe will be absorbed in the instance matcher]</span>
<a name="line-30"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-31"></a>
<a name="line-32"></a><a name="checkWellStagedDFun"></a><span class='hs-definition'>checkWellStagedDFun</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DFunId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span> 
<a name="line-33"></a><span class='hs-definition'>checkWellStagedDFun</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>dfun_id</span> <span class='hs-varid'>loc</span> 
<a name="line-34"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>setCtLoc</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> 
<a name="line-35"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>use_stage</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getStage</span>
<a name="line-36"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>checkWellStaged</span> <span class='hs-varid'>pp_thing</span> <span class='hs-varid'>bind_lvl</span> <span class='hs-layout'>(</span><span class='hs-varid'>thLevel</span> <span class='hs-varid'>use_stage</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-37"></a>  <span class='hs-keyword'>where</span>
<a name="line-38"></a>    <span class='hs-varid'>pp_thing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"instance for"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span>
<a name="line-39"></a>    <span class='hs-varid'>bind_lvl</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>topIdLvl</span> <span class='hs-varid'>dfun_id</span>
<a name="line-40"></a>
<a name="line-41"></a><a name="pprEq"></a><span class='hs-definition'>pprEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-42"></a><span class='hs-definition'>pprEq</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprType</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkEqPred</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span><span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-43"></a>
<a name="line-44"></a><a name="isTouchableMetaTyVar"></a><span class='hs-definition'>isTouchableMetaTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Bool</span>
<a name="line-45"></a><span class='hs-definition'>isTouchableMetaTyVar</span> <span class='hs-varid'>tv</span> 
<a name="line-46"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>untch</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getUntouchables</span>
<a name="line-47"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>isTouchableMetaTyVar_InRange</span> <span class='hs-varid'>untch</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>}</span> 
<a name="line-48"></a>
<a name="line-49"></a><a name="isTouchableMetaTyVar_InRange"></a><span class='hs-definition'>isTouchableMetaTyVar_InRange</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcsUntouchables</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> 
<a name="line-50"></a><span class='hs-definition'>isTouchableMetaTyVar_InRange</span> <span class='hs-layout'>(</span><span class='hs-varid'>untch</span><span class='hs-layout'>,</span><span class='hs-varid'>untch_tcs</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> 
<a name="line-51"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span> 
<a name="line-52"></a>      <span class='hs-conid'>MetaTv</span> <span class='hs-conid'>TcsTv</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>untch_tcs</span><span class='hs-layout'>)</span>
<a name="line-53"></a>                        <span class='hs-comment'>-- See Note [Touchable meta type variables] </span>
<a name="line-54"></a>      <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>inTouchableRange</span> <span class='hs-varid'>untch</span> <span class='hs-varid'>tv</span> 
<a name="line-55"></a>      <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span> 
<a name="line-56"></a>
<a name="line-57"></a>
</pre>\end{code}


Note [Touchable meta type variables]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Meta type variables allocated *by the constraint solver itself* are always
touchable.  Example: 
   instance C a b => D [a] where...
if we use this instance declaration we "make up" a fresh meta type
variable for 'b', which we must later guess.  (Perhaps C has a
functional dependency.)  But since we aren't in the constraint *generator*
we can't allocate a Unique in the touchable range for this implication
constraint.  Instead, we mark it as a "TcsTv", which makes it always-touchable.


\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>-- Flatten skolems</span>
<a name="line-2"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="newFlattenSkolemTy"></a><span class='hs-definition'>newFlattenSkolemTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcType</span>
<a name="line-5"></a><span class='hs-definition'>newFlattenSkolemTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>newFlattenSkolemTyVar</span> <span class='hs-varid'>ty</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="newFlattenSkolemTyVar"></a><span class='hs-definition'>newFlattenSkolemTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcTyVar</span>
<a name="line-8"></a><span class='hs-definition'>newFlattenSkolemTyVar</span> <span class='hs-varid'>ty</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newUnique</span>
<a name="line-10"></a>                            <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>mkTcTyVarName</span> <span class='hs-varid'>uniq</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"f"</span><span class='hs-layout'>)</span>
<a name="line-11"></a>                            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkTcTyVar</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>FlatSkol</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> 
<a name="line-12"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"New Flatten Skolem Born"</span> <span class='hs-varop'>$</span> 
<a name="line-13"></a>           <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"[:= "</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"]"</span><span class='hs-layout'>)</span>
<a name="line-14"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>}</span>
<a name="line-15"></a>
<a name="line-16"></a><span class='hs-comment'>-- Instantiations </span>
<a name="line-17"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="instDFunTypes"></a><span class='hs-definition'>instDFunTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Either</span> <span class='hs-conid'>TyVar</span> <span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> 
<a name="line-20"></a><span class='hs-definition'>instDFunTypes</span> <span class='hs-varid'>mb_inst_tys</span> 
<a name="line-21"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>inst_tv</span> <span class='hs-varid'>mb_inst_tys</span>
<a name="line-22"></a>  <span class='hs-keyword'>where</span>
<a name="line-23"></a>    <span class='hs-varid'>inst_tv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>TyVar</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Type</span>
<a name="line-24"></a>    <span class='hs-varid'>inst_tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>Left</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>instFlexiTcS</span> <span class='hs-varid'>tv</span>
<a name="line-25"></a>    <span class='hs-varid'>inst_tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>Right</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span> 
<a name="line-26"></a>
<a name="line-27"></a><a name="instDFunConstraints"></a><span class='hs-definition'>instDFunConstraints</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVarCreated</span><span class='hs-keyglyph'>]</span> 
<a name="line-28"></a><span class='hs-definition'>instDFunConstraints</span> <span class='hs-varid'>preds</span> <span class='hs-varid'>fl</span>
<a name="line-29"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>newEvVar</span> <span class='hs-varid'>fl</span><span class='hs-layout'>)</span> <span class='hs-varid'>preds</span>
<a name="line-30"></a>
<a name="line-31"></a><a name="instFlexiTcS"></a><span class='hs-definition'>instFlexiTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcTyVar</span> 
<a name="line-32"></a><span class='hs-comment'>-- Like TcM.instMetaTyVar but the variable that is created is always</span>
<a name="line-33"></a><span class='hs-comment'>-- touchable; we are supposed to guess its instantiation. </span>
<a name="line-34"></a><span class='hs-comment'>-- See Note [Touchable meta type variables] </span>
<a name="line-35"></a><span class='hs-definition'>instFlexiTcS</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>instFlexiTcSHelper</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarName</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> 
<a name="line-36"></a>
<a name="line-37"></a><a name="newFlexiTcSTy"></a><span class='hs-definition'>newFlexiTcSTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcType</span>  
<a name="line-38"></a><span class='hs-definition'>newFlexiTcSTy</span> <span class='hs-varid'>knd</span> 
<a name="line-39"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span>
<a name="line-40"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newUnique</span> 
<a name="line-41"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ref</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newMutVar</span>  <span class='hs-conid'>Flexi</span> 
<a name="line-42"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>mkTcTyVarName</span> <span class='hs-varid'>uniq</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"uf"</span><span class='hs-layout'>)</span>
<a name="line-43"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcTyVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>knd</span> <span class='hs-layout'>(</span><span class='hs-conid'>MetaTv</span> <span class='hs-conid'>TcsTv</span> <span class='hs-varid'>ref</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-44"></a>
<a name="line-45"></a><a name="isFlexiTcsTv"></a><span class='hs-definition'>isFlexiTcsTv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-46"></a><span class='hs-definition'>isFlexiTcsTv</span> <span class='hs-varid'>tv</span>
<a name="line-47"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-48"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>MetaTv</span> <span class='hs-conid'>TcsTv</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-49"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-50"></a>
<a name="line-51"></a><a name="newKindConstraint"></a><span class='hs-definition'>newKindConstraint</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>EvVarCreated</span>
<a name="line-52"></a><span class='hs-comment'>-- Create new wanted CoVar that constrains the type to have the specified kind. </span>
<a name="line-53"></a><span class='hs-definition'>newKindConstraint</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>knd</span> <span class='hs-varid'>fl</span>
<a name="line-54"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tv_k</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>instFlexiTcSHelper</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarName</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>knd</span> 
<a name="line-55"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ty_k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv_k</span>
<a name="line-56"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>eqv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEqVar</span> <span class='hs-varid'>fl</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty_k</span>
<a name="line-57"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>eqv</span> <span class='hs-layout'>}</span>
<a name="line-58"></a>
<a name="line-59"></a><a name="instFlexiTcSHelper"></a><span class='hs-definition'>instFlexiTcSHelper</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcTyVar</span>
<a name="line-60"></a><span class='hs-definition'>instFlexiTcSHelper</span> <span class='hs-varid'>tvname</span> <span class='hs-varid'>tvkind</span>
<a name="line-61"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> 
<a name="line-62"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newUnique</span> 
<a name="line-63"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ref</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newMutVar</span>  <span class='hs-conid'>Flexi</span> 
<a name="line-64"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setNameUnique</span> <span class='hs-varid'>tvname</span> <span class='hs-varid'>uniq</span> 
<a name="line-65"></a>             <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvkind</span> 
<a name="line-66"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcTyVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>MetaTv</span> <span class='hs-conid'>TcsTv</span> <span class='hs-varid'>ref</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-67"></a>
<a name="line-68"></a><span class='hs-comment'>-- Superclasses and recursive dictionaries </span>
<a name="line-69"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-70"></a>
<a name="line-71"></a><a name="EvVarCreated"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>EvVarCreated</span> 
<a name="line-72"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvVarCreated</span> <span class='hs-layout'>{</span> <span class='hs-varid'>evc_is_new</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>    <span class='hs-comment'>-- True iff the variable was just created</span>
<a name="line-73"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>evc_the_evvar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvVar</span> <span class='hs-layout'>}</span> <span class='hs-comment'>-- The actual evidence variable could be cached or new</span>
<a name="line-74"></a>
<a name="line-75"></a><a name="isNewEvVar"></a><span class='hs-definition'>isNewEvVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvVarCreated</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-76"></a><span class='hs-definition'>isNewEvVar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evc_is_new</span>
<a name="line-77"></a>
<a name="line-78"></a><a name="newEvVar"></a><span class='hs-definition'>newEvVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>EvVarCreated</span>
<a name="line-79"></a><span class='hs-comment'>-- Post: If Given then evc_is_new is True</span>
<a name="line-80"></a><span class='hs-comment'>-- Hence it is safe to do a setEvBind right after a newEvVar with a Given flavor</span>
<a name="line-81"></a><span class='hs-comment'>-- NB: newEvVar may temporarily break the TcSEnv invariant but it is expected in </span>
<a name="line-82"></a><span class='hs-comment'>--     the call sites for this invariant to be quickly restored.</span>
<a name="line-83"></a><span class='hs-definition'>newEvVar</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>pty</span>
<a name="line-84"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isGivenOrSolved</span> <span class='hs-varid'>fl</span>    <span class='hs-comment'>-- Create new variable and update the cache</span>
<a name="line-85"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> 
<a name="line-86"></a><span class='hs-comment'>{- We lose a lot of time if we enable this check:
<a name="line-87"></a>         eref &lt;- getTcSEvVarCache
<a name="line-88"></a>       ; ecache &lt;- wrapTcS (TcM.readTcRef eref)
<a name="line-89"></a>       ; case lookupTM pty (evc_cache ecache) of
<a name="line-90"></a>           Just (_,cached_fl) 
<a name="line-91"></a>               | cached_fl `canSolve` fl 
<a name="line-92"></a>               -&gt; pprTrace "Interesting: given newEvVar, missed caching opportunity!" empty $
<a name="line-93"></a>                  return ()
<a name="line-94"></a>           _ -&gt; return ()
<a name="line-95"></a>-}</span>
<a name="line-96"></a>         <span class='hs-varid'>new</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>forceNewEvVar</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>pty</span>
<a name="line-97"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvVarCreated</span> <span class='hs-conid'>True</span> <span class='hs-varid'>new</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-98"></a>
<a name="line-99"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-comment'>-- Otherwise lookup first</span>
<a name="line-100"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>{-# SCC "newEvVarWanted" #-}</span>
<a name="line-101"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>eref</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSEvVarCache</span>
<a name="line-102"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ecache</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>eref</span><span class='hs-layout'>)</span>
<a name="line-103"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupTM</span> <span class='hs-varid'>pty</span> <span class='hs-layout'>(</span><span class='hs-varid'>evc_cache</span> <span class='hs-varid'>ecache</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-104"></a>           <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>cached_evvar</span><span class='hs-layout'>,</span> <span class='hs-varid'>cached_flavor</span><span class='hs-layout'>)</span>
<a name="line-105"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>cached_flavor</span> <span class='hs-varop'>`canSolve`</span> <span class='hs-varid'>fl</span> <span class='hs-comment'>-- NB: </span>
<a name="line-106"></a>                                           <span class='hs-comment'>-- We want to use the cache /only/ if he can solve</span>
<a name="line-107"></a>                                           <span class='hs-comment'>-- the workitem. If cached_flavor is Derived</span>
<a name="line-108"></a>                                           <span class='hs-comment'>-- but we have a real Wanted, we want to create</span>
<a name="line-109"></a>                                           <span class='hs-comment'>-- new evidence, otherwise we are in danger to</span>
<a name="line-110"></a>                                           <span class='hs-comment'>-- have unsolved goals in the end. </span>
<a name="line-111"></a>                                           <span class='hs-comment'>-- (Remember: Derived's are just unification hints</span>
<a name="line-112"></a>                                           <span class='hs-comment'>--            but they don't come with guarantees</span>
<a name="line-113"></a>                                           <span class='hs-comment'>--            that they can be solved and we don't </span>
<a name="line-114"></a>                                           <span class='hs-comment'>--            quantify over them.</span>
<a name="line-115"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"newEvVar: already cached, doing nothing"</span> 
<a name="line-116"></a>                              <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>evc_cache</span> <span class='hs-varid'>ecache</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-117"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvVarCreated</span> <span class='hs-conid'>False</span> <span class='hs-varid'>cached_evvar</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-118"></a>           <span class='hs-keyword'>_</span>   <span class='hs-comment'>-- Not cached or cached with worse flavor</span>
<a name="line-119"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>force_new_ev_var</span> <span class='hs-varid'>eref</span> <span class='hs-varid'>ecache</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>pty</span>
<a name="line-120"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvVarCreated</span> <span class='hs-conid'>True</span> <span class='hs-varid'>new</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-121"></a>
<a name="line-122"></a><a name="forceNewEvVar"></a><span class='hs-definition'>forceNewEvVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>EvVar</span>
<a name="line-123"></a><span class='hs-comment'>-- Create a new EvVar, regardless of whether or not the</span>
<a name="line-124"></a><span class='hs-comment'>-- cache already contains one like it, and update the cache</span>
<a name="line-125"></a><span class='hs-definition'>forceNewEvVar</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>pty</span> 
<a name="line-126"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>eref</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSEvVarCache</span>
<a name="line-127"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ecache</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>eref</span><span class='hs-layout'>)</span>
<a name="line-128"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>force_new_ev_var</span> <span class='hs-varid'>eref</span> <span class='hs-varid'>ecache</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>pty</span> <span class='hs-layout'>}</span>
<a name="line-129"></a>
<a name="line-130"></a><a name="force_new_ev_var"></a><span class='hs-definition'>force_new_ev_var</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>EvVarCache</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvVarCache</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>EvVar</span>
<a name="line-131"></a><span class='hs-comment'>-- Create a new EvVar, and update the cache with it</span>
<a name="line-132"></a><span class='hs-definition'>force_new_ev_var</span> <span class='hs-varid'>eref</span> <span class='hs-varid'>ecache</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>pty</span>
<a name="line-133"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span>
<a name="line-134"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>traceTc</span> <span class='hs-str'>"newEvVar"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"updating cache"</span>
<a name="line-135"></a>
<a name="line-136"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_evvar</span> <span class='hs-keyglyph'>&lt;-</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newEvVar</span> <span class='hs-varid'>pty</span>
<a name="line-137"></a>            <span class='hs-comment'>-- This is THE PLACE where we finally call TcM.newEvVar</span>
<a name="line-138"></a>
<a name="line-139"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>new_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updateCache</span> <span class='hs-varid'>ecache</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_evvar</span><span class='hs-layout'>,</span><span class='hs-varid'>fl</span><span class='hs-layout'>,</span><span class='hs-varid'>pty</span><span class='hs-layout'>)</span>
<a name="line-140"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>eref</span> <span class='hs-varid'>new_cache</span> 
<a name="line-141"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>new_evvar</span> <span class='hs-layout'>}</span>
<a name="line-142"></a>
<a name="line-143"></a><a name="updateCache"></a><span class='hs-definition'>updateCache</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvVarCache</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvVar</span><span class='hs-layout'>,</span><span class='hs-conid'>CtFlavor</span><span class='hs-layout'>,</span><span class='hs-conid'>Type</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvVarCache</span>
<a name="line-144"></a><span class='hs-definition'>updateCache</span> <span class='hs-varid'>ecache</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev</span><span class='hs-layout'>,</span><span class='hs-varid'>fl</span><span class='hs-layout'>,</span><span class='hs-varid'>pty</span><span class='hs-layout'>)</span>
<a name="line-145"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>IPPred</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>classifier</span>
<a name="line-146"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ecache</span>
<a name="line-147"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-148"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ecache</span> <span class='hs-layout'>{</span> <span class='hs-varid'>evc_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ecache'</span> <span class='hs-layout'>}</span>
<a name="line-149"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>classifier</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>classifyPredType</span> <span class='hs-varid'>pty</span>
<a name="line-150"></a>        <span class='hs-varid'>ecache'</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>alterTM</span> <span class='hs-varid'>pty</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev</span><span class='hs-layout'>,</span><span class='hs-varid'>fl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-151"></a>                     <span class='hs-varid'>evc_cache</span> <span class='hs-varid'>ecache</span>
<a name="line-152"></a>
<a name="line-153"></a><a name="delCachedEvVar"></a><span class='hs-definition'>delCachedEvVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-154"></a><span class='hs-definition'>delCachedEvVar</span> <span class='hs-varid'>ev</span> <span class='hs-sel'>_fl</span>
<a name="line-155"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>{-# SCC "delCachedEvVarOther" #-}</span>
<a name="line-156"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>eref</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSEvVarCache</span>
<a name="line-157"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ecache</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>eref</span><span class='hs-layout'>)</span>
<a name="line-158"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>eref</span> <span class='hs-layout'>(</span><span class='hs-varid'>delFromCache</span> <span class='hs-varid'>ecache</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-159"></a>
<a name="line-160"></a><a name="delFromCache"></a><span class='hs-definition'>delFromCache</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvVarCache</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvVarCache</span> 
<a name="line-161"></a><span class='hs-definition'>delFromCache</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvVarCache</span> <span class='hs-layout'>{</span> <span class='hs-varid'>evc_cache</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ecache</span>
<a name="line-162"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>evc_flat_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flat_cache</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>ev</span>
<a name="line-163"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvVarCache</span> <span class='hs-layout'>{</span> <span class='hs-varid'>evc_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ecache'</span><span class='hs-layout'>,</span> <span class='hs-varid'>evc_flat_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flat_cache</span> <span class='hs-layout'>}</span>
<a name="line-164"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>ecache'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>alterTM</span> <span class='hs-varid'>pty</span> <span class='hs-varid'>x_del</span> <span class='hs-varid'>ecache</span>
<a name="line-165"></a>        <span class='hs-varid'>x_del</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-166"></a>        <span class='hs-varid'>x_del</span> <span class='hs-varid'>r</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev0</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-167"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ev0</span> <span class='hs-varop'>==</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-168"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span>
<a name="line-169"></a>        <span class='hs-varid'>pty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evVarPred</span> <span class='hs-varid'>ev</span>
<a name="line-170"></a>
<a name="line-171"></a>
<a name="line-172"></a>
<a name="line-173"></a><a name="updateFlatCache"></a><span class='hs-definition'>updateFlatCache</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavor</span> 
<a name="line-174"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Xi</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> 
<a name="line-175"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FlatEqOrigin</span>
<a name="line-176"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span> 
<a name="line-177"></a><span class='hs-definition'>updateFlatCache</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>xis</span> <span class='hs-varid'>rhs_ty</span> <span class='hs-varid'>feq_origin</span>
<a name="line-178"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>eref</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSEvVarCache</span>
<a name="line-179"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ecache</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>eref</span><span class='hs-layout'>)</span>
<a name="line-180"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>flat_cache</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evc_flat_cache</span> <span class='hs-varid'>ecache</span>
<a name="line-181"></a>             <span class='hs-varid'>new_flat_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>alterTM</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>x_flat_cache</span> <span class='hs-varid'>flat_cache</span>
<a name="line-182"></a>             <span class='hs-varid'>new_evc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ecache</span> <span class='hs-layout'>{</span> <span class='hs-varid'>evc_flat_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_flat_cache</span> <span class='hs-layout'>}</span>
<a name="line-183"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>eref</span> <span class='hs-varid'>new_evc</span> <span class='hs-layout'>}</span>
<a name="line-184"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>x_flat_cache</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcCoVarCo</span> <span class='hs-varid'>ev</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>rhs_ty</span><span class='hs-layout'>,</span><span class='hs-varid'>fl</span><span class='hs-layout'>,</span><span class='hs-varid'>feq_origin</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-185"></a>        <span class='hs-varid'>fun_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>xis</span>
<a name="line-186"></a>
<a name="line-187"></a>
<a name="line-188"></a><a name="pprEvVarCache"></a><span class='hs-definition'>pprEvVarCache</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TypeMap</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>,</span><span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-189"></a><span class='hs-definition'>pprEvVarCache</span> <span class='hs-varid'>tm</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldTM</span> <span class='hs-varid'>mk_pair</span> <span class='hs-varid'>tm</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-190"></a> <span class='hs-keyword'>where</span> <span class='hs-varid'>mk_pair</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcCoercionKind</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>cos</span>
<a name="line-191"></a>
<a name="line-192"></a>
<a name="line-193"></a><a name="newGivenEqVar"></a><span class='hs-definition'>newGivenEqVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtFlavor</span><span class='hs-layout'>,</span><span class='hs-conid'>EvVar</span><span class='hs-layout'>)</span>
<a name="line-194"></a><span class='hs-comment'>-- Pre: fl is Given</span>
<a name="line-195"></a><span class='hs-definition'>newGivenEqVar</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>co</span> 
<a name="line-196"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ecv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEqVar</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-197"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evc_the_evvar</span> <span class='hs-varid'>ecv</span> <span class='hs-comment'>-- Will be a new EvVar by post of newEvVar</span>
<a name="line-198"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>fl'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setEvBind</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCoercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>fl</span>
<a name="line-199"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>fl'</span><span class='hs-layout'>,</span><span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-200"></a>
<a name="line-201"></a><a name="newEqVar"></a><span class='hs-definition'>newEqVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>EvVarCreated</span>
<a name="line-202"></a><span class='hs-definition'>newEqVar</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> 
<a name="line-203"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newEvVar</span> <span class='hs-varid'>fl</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkEqPred</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span><span class='hs-varid'>ty2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-204"></a>
<a name="line-205"></a>
</pre>\end{code} 


\begin{code} 
<pre><a name="line-1"></a><span class='hs-comment'>-- Matching and looking up classes and family instances</span>
<a name="line-2"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="MatchInstResult"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>MatchInstResult</span> <span class='hs-varid'>mi</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MatchInstNo</span>         <span class='hs-comment'>-- No matching instance </span>
<a name="line-6"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>MatchInstSingle</span> <span class='hs-varid'>mi</span>  <span class='hs-comment'>-- Single matching instance</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>MatchInstMany</span>       <span class='hs-comment'>-- Multiple matching instances</span>
<a name="line-8"></a>
<a name="line-9"></a>
<a name="line-10"></a><a name="matchClass"></a><span class='hs-definition'>matchClass</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>MatchInstResult</span> <span class='hs-layout'>(</span><span class='hs-conid'>DFunId</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Either</span> <span class='hs-conid'>TyVar</span> <span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-11"></a><span class='hs-comment'>-- Look up a class constraint in the instance environment</span>
<a name="line-12"></a><span class='hs-definition'>matchClass</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tys</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkClassPred</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tys</span> 
<a name="line-14"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>instEnvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInstEnvs</span>
<a name="line-15"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupInstEnv</span> <span class='hs-varid'>instEnvs</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tys</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span>
<a name="line-16"></a>            <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>unifs</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>               <span class='hs-comment'>-- Nothing matches  </span>
<a name="line-17"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"matchClass not matching"</span>
<a name="line-18"></a>                                 <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"dict"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>pred</span><span class='hs-layout'>,</span> 
<a name="line-19"></a>                                         <span class='hs-varid'>text</span> <span class='hs-str'>"unifs"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>unifs</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> 
<a name="line-20"></a>                      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>MatchInstNo</span>  
<a name="line-21"></a>                      <span class='hs-layout'>}</span> <span class='hs-layout'>;</span>  
<a name="line-22"></a>	    <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>ispec</span><span class='hs-layout'>,</span> <span class='hs-varid'>inst_tys</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- A single match </span>
<a name="line-23"></a>		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>dfun_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_dfun</span> <span class='hs-varid'>ispec</span>
<a name="line-24"></a>			<span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"matchClass success"</span>
<a name="line-25"></a>				   <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"dict"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>pred</span><span class='hs-layout'>,</span> 
<a name="line-26"></a>				          <span class='hs-varid'>text</span> <span class='hs-str'>"witness"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>dfun_id</span>
<a name="line-27"></a>                                           <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>dfun_id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-28"></a>				  <span class='hs-comment'>-- Record that this dfun is needed</span>
<a name="line-29"></a>                        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>MatchInstSingle</span> <span class='hs-layout'>(</span><span class='hs-varid'>dfun_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>inst_tys</span><span class='hs-layout'>)</span>
<a name="line-30"></a>                        <span class='hs-layout'>}</span> <span class='hs-layout'>;</span>
<a name="line-31"></a>     	    <span class='hs-layout'>(</span><span class='hs-varid'>matches</span><span class='hs-layout'>,</span> <span class='hs-varid'>unifs</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>          <span class='hs-comment'>-- More than one matches </span>
<a name="line-32"></a>		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"matchClass multiple matches, deferring choice"</span>
<a name="line-33"></a>			           <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"dict"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>pred</span><span class='hs-layout'>,</span>
<a name="line-34"></a>				   	  <span class='hs-varid'>text</span> <span class='hs-str'>"matches"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>matches</span><span class='hs-layout'>,</span>
<a name="line-35"></a>				   	  <span class='hs-varid'>text</span> <span class='hs-str'>"unifs"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>unifs</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-36"></a>                        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>MatchInstMany</span> 
<a name="line-37"></a>		        <span class='hs-layout'>}</span>
<a name="line-38"></a>	<span class='hs-layout'>}</span>
<a name="line-39"></a>        <span class='hs-layout'>}</span>
<a name="line-40"></a>
<a name="line-41"></a><a name="matchFam"></a><span class='hs-definition'>matchFam</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyCon</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-42"></a><span class='hs-definition'>matchFam</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tcLookupFamInst</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>args</span>
</pre>\end{code}


-- Rewriting with respect to the inert equalities 
-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><a name="getInertEqs"></a><span class='hs-definition'>getInertEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span><span class='hs-layout'>,</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>InScopeSet</span><span class='hs-layout'>)</span>
<a name="line-3"></a><span class='hs-definition'>getInertEqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInerts</span>
<a name="line-4"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>inert</span><span class='hs-layout'>,</span> <span class='hs-varid'>inert_eq_tvs</span> <span class='hs-varid'>inert</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="getCtCoercion"></a><span class='hs-definition'>getCtCoercion</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-7"></a><span class='hs-comment'>-- Precondition: A CTyEqCan.</span>
<a name="line-8"></a><span class='hs-definition'>getCtCoercion</span> <span class='hs-varid'>ct</span> 
<a name="line-9"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>GivenSolved</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCoercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>maybe_given</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-12"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcCoVarCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>setVarType</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_id</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-13"></a>                <span class='hs-comment'>-- NB: The variable could be rewritten by a spontaneously</span>
<a name="line-14"></a>                <span class='hs-comment'>-- solved, so it is not safe to simply do a mkTcCoVarCo (cc_id ct)</span>
<a name="line-15"></a>                <span class='hs-comment'>-- Instead we use the most accurate type, given by ctPred c</span>
<a name="line-16"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>maybe_given</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isGiven_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_flavor</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-17"></a>
<a name="line-18"></a><a name="liftInertEqsTy"></a><span class='hs-comment'>-- See Note [LiftInertEqs]</span>
<a name="line-19"></a><span class='hs-definition'>liftInertEqsTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcCoercion</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-conid'>InScopeSet</span><span class='hs-layout'>)</span>
<a name="line-20"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavor</span>
<a name="line-21"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-22"></a><span class='hs-definition'>liftInertEqsTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst</span><span class='hs-layout'>,</span><span class='hs-varid'>inscope</span><span class='hs-layout'>)</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>pty</span>
<a name="line-23"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_cts_subst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>inscope</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>pty</span>
<a name="line-24"></a>
<a name="line-25"></a>
<a name="line-26"></a><a name="ty_cts_subst"></a><span class='hs-definition'>ty_cts_subst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVarEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcCoercion</span><span class='hs-layout'>)</span>
<a name="line-27"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-28"></a><span class='hs-definition'>ty_cts_subst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>inscope</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>ty</span> 
<a name="line-29"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span> 
<a name="line-30"></a>  <span class='hs-keyword'>where</span> 
<a name="line-31"></a>        <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go'</span> <span class='hs-varid'>ty</span>
<a name="line-32"></a>
<a name="line-33"></a>        <span class='hs-varid'>go'</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyvar_cts_subst</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>mkTcReflCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-34"></a>        <span class='hs-varid'>go'</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcAppCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> 
<a name="line-35"></a>        <span class='hs-varid'>go'</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcTyConAppCo</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>  
<a name="line-36"></a>
<a name="line-37"></a>        <span class='hs-varid'>go'</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>v</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcForAllCo</span> <span class='hs-varid'>v'</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>co</span>
<a name="line-38"></a>                             <span class='hs-keyword'>where</span> 
<a name="line-39"></a>                               <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span><span class='hs-varid'>inscope'</span><span class='hs-layout'>,</span><span class='hs-varid'>v'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>upd_tyvar_bndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>inscope</span> <span class='hs-varid'>v</span>
<a name="line-40"></a>                               <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_cts_subst</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>inscope'</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>ty</span> 
<a name="line-41"></a>
<a name="line-42"></a>        <span class='hs-varid'>go'</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcFunCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-43"></a>
<a name="line-44"></a>
<a name="line-45"></a>        <span class='hs-varid'>tyvar_cts_subst</span> <span class='hs-varid'>tv</span>  
<a name="line-46"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-layout'>,</span><span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_flavor</span> <span class='hs-varid'>ct</span> <span class='hs-varop'>`canRewrite`</span> <span class='hs-varid'>fl</span>  
<a name="line-47"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co</span> <span class='hs-comment'>-- Warn: use cached, not cc_id directly, because of alpha-renamings!</span>
<a name="line-48"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span> 
<a name="line-49"></a>
<a name="line-50"></a>        <span class='hs-varid'>upd_tyvar_bndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>inscope</span> <span class='hs-varid'>v</span> 
<a name="line-51"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_subst</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>inscope</span> <span class='hs-varop'>`extendInScopeSet`</span> <span class='hs-varid'>new_v</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_v</span><span class='hs-layout'>)</span>
<a name="line-52"></a>          <span class='hs-keyword'>where</span> <span class='hs-varid'>new_subst</span> 
<a name="line-53"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>no_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delVarEnv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>v</span>
<a name="line-54"></a>                        <span class='hs-comment'>-- Otherwise we have to extend the environment with /something/. </span>
<a name="line-55"></a>                        <span class='hs-comment'>-- But we do not want to monadically create a new EvVar. So, we</span>
<a name="line-56"></a>                        <span class='hs-comment'>-- create an 'unused_ct' but we cache reflexivity as the </span>
<a name="line-57"></a>                        <span class='hs-comment'>-- associated coercion. </span>
<a name="line-58"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-varid'>unused_ct</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcReflCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>new_v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-59"></a>
<a name="line-60"></a>                <span class='hs-varid'>no_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_v</span> <span class='hs-varop'>==</span> <span class='hs-varid'>v</span> 
<a name="line-61"></a>                <span class='hs-varid'>new_v</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqAway</span> <span class='hs-varid'>inscope</span> <span class='hs-varid'>v</span> 
<a name="line-62"></a>
<a name="line-63"></a>                <span class='hs-varid'>unused_ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CTyEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_id</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unused_evvar</span>
<a name="line-64"></a>                                     <span class='hs-layout'>,</span> <span class='hs-varid'>cc_flavor</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fl</span> <span class='hs-comment'>-- canRewrite is reflexive.</span>
<a name="line-65"></a>                                     <span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyvar</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>v</span> 
<a name="line-66"></a>                                     <span class='hs-layout'>,</span> <span class='hs-varid'>cc_rhs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>new_v</span> 
<a name="line-67"></a>                                     <span class='hs-layout'>,</span> <span class='hs-varid'>cc_depth</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unused_depth</span> <span class='hs-layout'>}</span>
<a name="line-68"></a>                <span class='hs-varid'>unused_depth</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"ty_cts_subst: This depth should not be accessed!"</span>
<a name="line-69"></a>                <span class='hs-varid'>unused_evvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"ty_cts_subst: This var is just an alpha-renaming!"</span>
</pre>\end{code}

Note [LiftInertEqsTy]
~~~~~~~~~~~~~~~~~~~~~~~ 
The function liftInertEqPred behaves almost like liftCoSubst (in
Coercion), but accepts a map TyVarEnv (Ct,Coercion) instead of a
LiftCoSubst. This data structure is more convenient to use since we
must apply the inert substitution /only/ if the inert equality 
`canRewrite` the work item. There's admittedly some duplication of 
functionality but it would be more tedious to cache and maintain 
different flavors of LiftCoSubst structures in the inerts. 

</body>
</html>
