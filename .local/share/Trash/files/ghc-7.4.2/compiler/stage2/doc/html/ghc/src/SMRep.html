<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>cmm/SMRep.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%

Storage manager representation of closures

This is here, rather than in ClosureInfo, just to keep nhc happy.
Other modules should access this info through ClosureInfo.

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>SMRep</span> <span class='hs-layout'>(</span>
<a name="line-9"></a>        <span class='hs-comment'>-- * Words and bytes</span>
<a name="line-10"></a>	<span class='hs-conid'>StgWord</span><span class='hs-layout'>,</span> <span class='hs-conid'>StgHalfWord</span><span class='hs-layout'>,</span> 
<a name="line-11"></a>	<span class='hs-varid'>hALF_WORD_SIZE</span><span class='hs-layout'>,</span> <span class='hs-varid'>hALF_WORD_SIZE_IN_BITS</span><span class='hs-layout'>,</span>
<a name="line-12"></a>	<span class='hs-conid'>WordOff</span><span class='hs-layout'>,</span> <span class='hs-conid'>ByteOff</span><span class='hs-layout'>,</span>
<a name="line-13"></a>
<a name="line-14"></a>        <span class='hs-comment'>-- * Closure repesentation</span>
<a name="line-15"></a>        <span class='hs-conid'>SMRep</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>	<span class='hs-comment'>-- CmmInfo sees the rep; no one else does</span>
<a name="line-16"></a>        <span class='hs-conid'>IsStatic</span><span class='hs-layout'>,</span> 
<a name="line-17"></a>        <span class='hs-conid'>ClosureTypeInfo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>ArgDescr</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Liveness</span><span class='hs-layout'>,</span>
<a name="line-18"></a>        <span class='hs-conid'>ConstrDescription</span><span class='hs-layout'>,</span> 
<a name="line-19"></a>
<a name="line-20"></a>        <span class='hs-comment'>-- ** Construction</span>
<a name="line-21"></a>        <span class='hs-varid'>mkHeapRep</span><span class='hs-layout'>,</span> <span class='hs-varid'>blackHoleRep</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkStackRep</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkRTSRep</span><span class='hs-layout'>,</span>
<a name="line-22"></a>
<a name="line-23"></a>        <span class='hs-comment'>-- ** Predicates</span>
<a name="line-24"></a>        <span class='hs-varid'>isStaticRep</span><span class='hs-layout'>,</span> <span class='hs-varid'>isConRep</span><span class='hs-layout'>,</span> <span class='hs-varid'>isThunkRep</span><span class='hs-layout'>,</span> <span class='hs-varid'>isFunRep</span><span class='hs-layout'>,</span> <span class='hs-varid'>isStaticNoCafCon</span><span class='hs-layout'>,</span>
<a name="line-25"></a>
<a name="line-26"></a>        <span class='hs-comment'>-- ** Size-related things</span>
<a name="line-27"></a>        <span class='hs-varid'>heapClosureSize</span><span class='hs-layout'>,</span>
<a name="line-28"></a>        <span class='hs-varid'>fixedHdrSize</span><span class='hs-layout'>,</span> <span class='hs-varid'>arrWordsHdrSize</span><span class='hs-layout'>,</span> <span class='hs-varid'>arrPtrsHdrSize</span><span class='hs-layout'>,</span>
<a name="line-29"></a>        <span class='hs-varid'>profHdrSize</span><span class='hs-layout'>,</span> <span class='hs-varid'>thunkHdrSize</span><span class='hs-layout'>,</span> <span class='hs-varid'>nonHdrSize</span><span class='hs-layout'>,</span>
<a name="line-30"></a>
<a name="line-31"></a>        <span class='hs-comment'>-- ** RTS closure types</span>
<a name="line-32"></a>        <span class='hs-varid'>rtsClosureType</span><span class='hs-layout'>,</span> <span class='hs-varid'>rET_SMALL</span><span class='hs-layout'>,</span> <span class='hs-varid'>rET_BIG</span><span class='hs-layout'>,</span>
<a name="line-33"></a>        <span class='hs-varid'>aRG_GEN</span><span class='hs-layout'>,</span> <span class='hs-varid'>aRG_GEN_BIG</span><span class='hs-layout'>,</span>
<a name="line-34"></a>
<a name="line-35"></a>        <span class='hs-comment'>-- * Operations over [Word8] strings that don't belong here</span>
<a name="line-36"></a>	<span class='hs-varid'>pprWord8String</span><span class='hs-layout'>,</span> <span class='hs-varid'>stringToWord8s</span>
<a name="line-37"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-38"></a>
<a name="line-39"></a><span class='hs-cpp'>#include "../HsVersions.h"</span>
<a name="line-40"></a><span class='hs-cpp'>#include "../includes/MachDeps.h"</span>
<a name="line-41"></a>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>StaticFlags</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Constants</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-46"></a>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Char</span><span class='hs-layout'>(</span> <span class='hs-varid'>ord</span> <span class='hs-layout'>)</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Word</span>
</pre>\end{code}


%************************************************************************
%*									*
		Words and bytes
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="WordOff"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>WordOff</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Int</span>	<span class='hs-comment'>-- Word offset, or word count</span>
<a name="line-2"></a><a name="ByteOff"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ByteOff</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Int</span>	<span class='hs-comment'>-- Byte offset, or byte count</span>
</pre>\end{code}

StgWord is a type representing an StgWord on the target platform.

\begin{code}
<pre><a name="line-1"></a><span class='hs-cpp'>#</span><span class='hs-keyword'>if</span> <span class='hs-conid'>SIZEOF_HSWORD</span> <span class='hs-varop'>==</span> <span class='hs-num'>4</span>
<a name="line-2"></a><a name="StgWord"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>StgWord</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Word32</span>
<a name="line-3"></a><a name="StgHalfWord"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>StgHalfWord</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Word16</span>
<a name="line-4"></a><a name="hALF_WORD_SIZE"></a><span class='hs-definition'>hALF_WORD_SIZE</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ByteOff</span>
<a name="line-5"></a><span class='hs-definition'>hALF_WORD_SIZE</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>2</span>
<a name="line-6"></a><a name="hALF_WORD_SIZE_IN_BITS"></a><span class='hs-definition'>hALF_WORD_SIZE_IN_BITS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-7"></a><span class='hs-definition'>hALF_WORD_SIZE_IN_BITS</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>16</span>
<a name="line-8"></a><span class='hs-cpp'>#elif SIZEOF_HSWORD == 8</span>
<a name="line-9"></a><a name="StgWord"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>StgWord</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Word64</span>
<a name="line-10"></a><a name="StgHalfWord"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>StgHalfWord</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Word32</span>
<a name="line-11"></a><span class='hs-definition'>hALF_WORD_SIZE</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ByteOff</span>
<a name="line-12"></a><span class='hs-definition'>hALF_WORD_SIZE</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>4</span>
<a name="line-13"></a><span class='hs-definition'>hALF_WORD_SIZE_IN_BITS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-14"></a><span class='hs-definition'>hALF_WORD_SIZE_IN_BITS</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>32</span>
<a name="line-15"></a><span class='hs-cpp'>#else</span>
<a name="line-16"></a><span class='hs-cpp'>#error unknown SIZEOF_HSWORD</span>
<a name="line-17"></a><span class='hs-cpp'>#endif</span>
</pre>\end{code}

%************************************************************************
%*									*
\subsubsection[SMRep-datatype]{@SMRep@---storage manager representation}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="SMRep"></a><span class='hs-comment'>-- | A description of the layout of a closure.  Corresponds directly</span>
<a name="line-2"></a><a name="SMRep"></a><span class='hs-comment'>-- to the closure types in includes/rts/storage/ClosureTypes.h.</span>
<a name="line-3"></a><a name="SMRep"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>SMRep</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HeapRep</span>              <span class='hs-comment'>-- GC routines consult sizes in info tbl</span>
<a name="line-5"></a>        <span class='hs-conid'>IsStatic</span>
<a name="line-6"></a>        <span class='hs-varop'>!</span><span class='hs-conid'>WordOff</span>         <span class='hs-comment'>--  # ptr words</span>
<a name="line-7"></a>        <span class='hs-varop'>!</span><span class='hs-conid'>WordOff</span>         <span class='hs-comment'>--  # non-ptr words INCLUDING SLOP (see mkHeapRep below)</span>
<a name="line-8"></a>        <span class='hs-conid'>ClosureTypeInfo</span>  <span class='hs-comment'>-- type-specific info</span>
<a name="line-9"></a>
<a name="line-10"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>StackRep</span>            <span class='hs-comment'>-- Stack frame (RET_SMALL or RET_BIG)</span>
<a name="line-11"></a>        <span class='hs-conid'>Liveness</span>
<a name="line-12"></a>
<a name="line-13"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RTSRep</span>              <span class='hs-comment'>-- The RTS needs to declare info tables with specific</span>
<a name="line-14"></a>        <span class='hs-conid'>StgHalfWord</span>     <span class='hs-comment'>-- type tags, so this form lets us override the default</span>
<a name="line-15"></a>        <span class='hs-conid'>SMRep</span>           <span class='hs-comment'>-- tag for an SMRep.</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="IsStatic"></a><span class='hs-comment'>-- | True &lt;=&gt; This is a static closure.  Affects how we garbage-collect it.</span>
<a name="line-18"></a><a name="IsStatic"></a><span class='hs-comment'>-- Static closure have an extra static link field at the end.</span>
<a name="line-19"></a><a name="IsStatic"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>IsStatic</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Bool</span>
<a name="line-20"></a>
<a name="line-21"></a><span class='hs-comment'>-- From an SMRep you can get to the closure type defined in</span>
<a name="line-22"></a><span class='hs-comment'>-- includes/rts/storage/ClosureTypes.h. Described by the function</span>
<a name="line-23"></a><span class='hs-comment'>-- rtsClosureType below.</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="ClosureTypeInfo"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ClosureTypeInfo</span>
<a name="line-26"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Constr</span>        <span class='hs-conid'>ConstrTag</span> <span class='hs-conid'>ConstrDescription</span>
<a name="line-27"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Fun</span>           <span class='hs-conid'>FunArity</span> <span class='hs-conid'>ArgDescr</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Thunk</span>
<a name="line-29"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ThunkSelector</span> <span class='hs-conid'>SelectorOffset</span>
<a name="line-30"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>BlackHole</span>
<a name="line-31"></a>
<a name="line-32"></a><a name="ConstrTag"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ConstrTag</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgHalfWord</span>
<a name="line-33"></a><a name="ConstrDescription"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ConstrDescription</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Word8</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- result of dataConIdentity</span>
<a name="line-34"></a><a name="FunArity"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>FunArity</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgHalfWord</span>
<a name="line-35"></a><a name="SelectorOffset"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>SelectorOffset</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StgWord</span>
<a name="line-36"></a>
<a name="line-37"></a><span class='hs-comment'>-------------------------</span>
<a name="line-38"></a><span class='hs-comment'>-- We represent liveness bitmaps as a Bitmap (whose internal</span>
<a name="line-39"></a><span class='hs-comment'>-- representation really is a bitmap).  These are pinned onto case return</span>
<a name="line-40"></a><span class='hs-comment'>-- vectors to indicate the state of the stack for the garbage collector.</span>
<a name="line-41"></a><span class='hs-comment'>-- </span>
<a name="line-42"></a><span class='hs-comment'>-- In the compiled program, liveness bitmaps that fit inside a single</span>
<a name="line-43"></a><span class='hs-comment'>-- word (StgWord) are stored as a single word, while larger bitmaps are</span>
<a name="line-44"></a><span class='hs-comment'>-- stored as a pointer to an array of words. </span>
<a name="line-45"></a>
<a name="line-46"></a><a name="Liveness"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>Liveness</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Bool</span><span class='hs-keyglyph'>]</span>   <span class='hs-comment'>-- One Bool per word; True  &lt;=&gt; non-ptr or dead</span>
<a name="line-47"></a>                         <span class='hs-comment'>--                    False &lt;=&gt; ptr</span>
<a name="line-48"></a>
<a name="line-49"></a><span class='hs-comment'>-------------------------</span>
<a name="line-50"></a><span class='hs-comment'>-- An ArgDescr describes the argument pattern of a function</span>
<a name="line-51"></a>
<a name="line-52"></a><a name="ArgDescr"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ArgDescr</span>
<a name="line-53"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ArgSpec</span>		<span class='hs-comment'>-- Fits one of the standard patterns</span>
<a name="line-54"></a>	<span class='hs-varop'>!</span><span class='hs-conid'>StgHalfWord</span>	<span class='hs-comment'>-- RTS type identifier ARG_P, ARG_N, ...</span>
<a name="line-55"></a>
<a name="line-56"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ArgGen</span>	 	<span class='hs-comment'>-- General case</span>
<a name="line-57"></a>	<span class='hs-conid'>Liveness</span>	<span class='hs-comment'>-- Details about the arguments</span>
<a name="line-58"></a>
<a name="line-59"></a>
<a name="line-60"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-61"></a><span class='hs-comment'>-- Construction</span>
<a name="line-62"></a>
<a name="line-63"></a><a name="mkHeapRep"></a><span class='hs-definition'>mkHeapRep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IsStatic</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WordOff</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WordOff</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ClosureTypeInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SMRep</span>
<a name="line-64"></a><span class='hs-definition'>mkHeapRep</span> <span class='hs-varid'>is_static</span> <span class='hs-varid'>ptr_wds</span> <span class='hs-varid'>nonptr_wds</span> <span class='hs-varid'>cl_type_info</span>
<a name="line-65"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HeapRep</span> <span class='hs-varid'>is_static</span>
<a name="line-66"></a>            <span class='hs-varid'>ptr_wds</span>
<a name="line-67"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>nonptr_wds</span> <span class='hs-varop'>+</span> <span class='hs-varid'>slop_wds</span><span class='hs-layout'>)</span>
<a name="line-68"></a>            <span class='hs-varid'>cl_type_info</span>
<a name="line-69"></a>  <span class='hs-keyword'>where</span>
<a name="line-70"></a>     <span class='hs-varid'>slop_wds</span>
<a name="line-71"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_static</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-72"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>max</span> <span class='hs-num'>0</span> <span class='hs-layout'>(</span><span class='hs-varid'>minClosureSize</span> <span class='hs-comment'>-</span> <span class='hs-layout'>(</span><span class='hs-varid'>hdr_size</span> <span class='hs-varop'>+</span> <span class='hs-varid'>payload_size</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-73"></a>
<a name="line-74"></a>     <span class='hs-varid'>hdr_size</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>closureTypeHdrSize</span> <span class='hs-varid'>cl_type_info</span>
<a name="line-75"></a>     <span class='hs-varid'>payload_size</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptr_wds</span> <span class='hs-varop'>+</span> <span class='hs-varid'>nonptr_wds</span>
<a name="line-76"></a>
<a name="line-77"></a><a name="mkRTSRep"></a><span class='hs-definition'>mkRTSRep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StgHalfWord</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SMRep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SMRep</span>
<a name="line-78"></a><span class='hs-definition'>mkRTSRep</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RTSRep</span>
<a name="line-79"></a>
<a name="line-80"></a><a name="mkStackRep"></a><span class='hs-definition'>mkStackRep</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Bool</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SMRep</span>
<a name="line-81"></a><span class='hs-definition'>mkStackRep</span> <span class='hs-varid'>liveness</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StackRep</span> <span class='hs-varid'>liveness</span>
<a name="line-82"></a>
<a name="line-83"></a><a name="blackHoleRep"></a><span class='hs-definition'>blackHoleRep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SMRep</span>
<a name="line-84"></a><span class='hs-definition'>blackHoleRep</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-num'>0</span> <span class='hs-num'>0</span> <span class='hs-conid'>BlackHole</span>
<a name="line-85"></a>
<a name="line-86"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-87"></a><span class='hs-comment'>-- Predicates</span>
<a name="line-88"></a>
<a name="line-89"></a><a name="isStaticRep"></a><span class='hs-definition'>isStaticRep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SMRep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IsStatic</span>
<a name="line-90"></a><span class='hs-definition'>isStaticRep</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-varid'>is_static</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_static</span>
<a name="line-91"></a><span class='hs-definition'>isStaticRep</span> <span class='hs-layout'>(</span><span class='hs-conid'>StackRep</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-92"></a><span class='hs-definition'>isStaticRep</span> <span class='hs-layout'>(</span><span class='hs-conid'>RTSRep</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>rep</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isStaticRep</span> <span class='hs-varid'>rep</span>
<a name="line-93"></a>
<a name="line-94"></a><a name="isConRep"></a><span class='hs-definition'>isConRep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SMRep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-95"></a><span class='hs-definition'>isConRep</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Constr</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-96"></a><span class='hs-definition'>isConRep</span> <span class='hs-keyword'>_</span>                        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-97"></a>
<a name="line-98"></a><a name="isThunkRep"></a><span class='hs-definition'>isThunkRep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SMRep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-99"></a><span class='hs-definition'>isThunkRep</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Thunk</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-100"></a><span class='hs-definition'>isThunkRep</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>ThunkSelector</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-101"></a><span class='hs-definition'>isThunkRep</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>BlackHole</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-102"></a><span class='hs-definition'>isThunkRep</span> <span class='hs-keyword'>_</span>                               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-103"></a>
<a name="line-104"></a><a name="isFunRep"></a><span class='hs-definition'>isFunRep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SMRep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-105"></a><span class='hs-definition'>isFunRep</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Fun</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-106"></a><span class='hs-definition'>isFunRep</span> <span class='hs-keyword'>_</span>                     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-107"></a>
<a name="line-108"></a><a name="isStaticNoCafCon"></a><span class='hs-definition'>isStaticNoCafCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SMRep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-109"></a><span class='hs-comment'>-- This should line up exactly with CONSTR_NOCAF_STATIC above</span>
<a name="line-110"></a><span class='hs-comment'>-- See Note [Static NoCaf constructors]</span>
<a name="line-111"></a><span class='hs-definition'>isStaticNoCafCon</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-conid'>True</span> <span class='hs-num'>0</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Constr</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-112"></a><span class='hs-definition'>isStaticNoCafCon</span> <span class='hs-keyword'>_</span>                           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-113"></a>
<a name="line-114"></a>
<a name="line-115"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-116"></a><span class='hs-comment'>-- Size-related things</span>
<a name="line-117"></a>
<a name="line-118"></a><a name="fixedHdrSize"></a><span class='hs-comment'>-- | Size of a closure header (StgHeader in includes/rts/storage/Closures.h)</span>
<a name="line-119"></a><span class='hs-definition'>fixedHdrSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WordOff</span>
<a name="line-120"></a><span class='hs-definition'>fixedHdrSize</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sTD_HDR_SIZE</span> <span class='hs-varop'>+</span> <span class='hs-varid'>profHdrSize</span>
<a name="line-121"></a>
<a name="line-122"></a><a name="profHdrSize"></a><span class='hs-comment'>-- | Size of the profiling part of a closure header</span>
<a name="line-123"></a><span class='hs-comment'>-- (StgProfHeader in includes/rts/storage/Closures.h)</span>
<a name="line-124"></a><span class='hs-definition'>profHdrSize</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WordOff</span>
<a name="line-125"></a><span class='hs-definition'>profHdrSize</span>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>opt_SccProfilingOn</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pROF_HDR_SIZE</span>
<a name="line-126"></a>	     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>	    <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-127"></a>
<a name="line-128"></a><a name="minClosureSize"></a><span class='hs-comment'>-- | The garbage collector requires that every closure is at least as big as this.</span>
<a name="line-129"></a><span class='hs-definition'>minClosureSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WordOff</span>
<a name="line-130"></a><span class='hs-definition'>minClosureSize</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fixedHdrSize</span> <span class='hs-varop'>+</span> <span class='hs-varid'>mIN_PAYLOAD_SIZE</span>
<a name="line-131"></a>
<a name="line-132"></a><a name="arrWordsHdrSize"></a><span class='hs-definition'>arrWordsHdrSize</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ByteOff</span>
<a name="line-133"></a><span class='hs-definition'>arrWordsHdrSize</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fixedHdrSize</span><span class='hs-varop'>*</span><span class='hs-varid'>wORD_SIZE</span> <span class='hs-varop'>+</span> <span class='hs-varid'>sIZEOF_StgArrWords_NoHdr</span>
<a name="line-134"></a>
<a name="line-135"></a><a name="arrPtrsHdrSize"></a><span class='hs-definition'>arrPtrsHdrSize</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ByteOff</span>
<a name="line-136"></a><span class='hs-definition'>arrPtrsHdrSize</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fixedHdrSize</span><span class='hs-varop'>*</span><span class='hs-varid'>wORD_SIZE</span> <span class='hs-varop'>+</span> <span class='hs-varid'>sIZEOF_StgMutArrPtrs_NoHdr</span>
<a name="line-137"></a>
<a name="line-138"></a><a name="thunkHdrSize"></a><span class='hs-comment'>-- Thunks have an extra header word on SMP, so the update doesn't </span>
<a name="line-139"></a><span class='hs-comment'>-- splat the payload.</span>
<a name="line-140"></a><span class='hs-definition'>thunkHdrSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WordOff</span>
<a name="line-141"></a><span class='hs-definition'>thunkHdrSize</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fixedHdrSize</span> <span class='hs-varop'>+</span> <span class='hs-varid'>smp_hdr</span>
<a name="line-142"></a>	<span class='hs-keyword'>where</span> <span class='hs-varid'>smp_hdr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sIZEOF_StgSMPThunkHeader</span> <span class='hs-varop'>`quot`</span> <span class='hs-varid'>wORD_SIZE</span>
<a name="line-143"></a>
<a name="line-144"></a>
<a name="line-145"></a><a name="nonHdrSize"></a><span class='hs-definition'>nonHdrSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SMRep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WordOff</span>
<a name="line-146"></a><span class='hs-definition'>nonHdrSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>p</span> <span class='hs-varid'>np</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>p</span> <span class='hs-varop'>+</span> <span class='hs-varid'>np</span>
<a name="line-147"></a><span class='hs-definition'>nonHdrSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>StackRep</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>bs</span>
<a name="line-148"></a><span class='hs-definition'>nonHdrSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>RTSRep</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>rep</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nonHdrSize</span> <span class='hs-varid'>rep</span>
<a name="line-149"></a>
<a name="line-150"></a><a name="heapClosureSize"></a><span class='hs-definition'>heapClosureSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SMRep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WordOff</span>
<a name="line-151"></a><span class='hs-definition'>heapClosureSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>p</span> <span class='hs-varid'>np</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>closureTypeHdrSize</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>+</span> <span class='hs-varid'>p</span> <span class='hs-varop'>+</span> <span class='hs-varid'>np</span>
<a name="line-152"></a><span class='hs-definition'>heapClosureSize</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"SMRep.heapClosureSize"</span>
<a name="line-153"></a>
<a name="line-154"></a><a name="closureTypeHdrSize"></a><span class='hs-definition'>closureTypeHdrSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ClosureTypeInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WordOff</span>
<a name="line-155"></a><span class='hs-definition'>closureTypeHdrSize</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-156"></a>                  <span class='hs-conid'>Thunk</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>thunkHdrSize</span>
<a name="line-157"></a>                  <span class='hs-conid'>ThunkSelector</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>thunkHdrSize</span>
<a name="line-158"></a>                  <span class='hs-conid'>BlackHole</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>thunkHdrSize</span>
<a name="line-159"></a>                  <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fixedHdrSize</span>
<a name="line-160"></a>	<span class='hs-comment'>-- All thunks use thunkHdrSize, even if they are non-updatable.</span>
<a name="line-161"></a>	<span class='hs-comment'>-- this is because we don't have separate closure types for</span>
<a name="line-162"></a>	<span class='hs-comment'>-- updatable vs. non-updatable thunks, so the GC can't tell the</span>
<a name="line-163"></a>	<span class='hs-comment'>-- difference.  If we ever have significant numbers of non-</span>
<a name="line-164"></a>	<span class='hs-comment'>-- updatable thunks, it might be worth fixing this.</span>
<a name="line-165"></a>
<a name="line-166"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-167"></a><span class='hs-comment'>-- deriving the RTS closure type from an SMRep</span>
<a name="line-168"></a>
<a name="line-169"></a><span class='hs-cpp'>#include "../includes/rts/storage/ClosureTypes.h"</span>
<a name="line-170"></a><span class='hs-cpp'>#include "../includes/rts/storage/FunTypes.h"</span>
<a name="line-171"></a><span class='hs-comment'>-- Defines CONSTR, CONSTR_1_0 etc</span>
<a name="line-172"></a>
<a name="line-173"></a><a name="rtsClosureType"></a><span class='hs-comment'>-- | Derives the RTS closure type from an 'SMRep'</span>
<a name="line-174"></a><span class='hs-definition'>rtsClosureType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SMRep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgHalfWord</span>
<a name="line-175"></a><span class='hs-definition'>rtsClosureType</span> <span class='hs-layout'>(</span><span class='hs-conid'>RTSRep</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-176"></a>
<a name="line-177"></a><span class='hs-definition'>rtsClosureType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-num'>1</span> <span class='hs-num'>0</span> <span class='hs-conid'>Constr</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CONSTR_1_0</span>
<a name="line-178"></a><span class='hs-definition'>rtsClosureType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-num'>0</span> <span class='hs-num'>1</span> <span class='hs-conid'>Constr</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CONSTR_0_1</span>
<a name="line-179"></a><span class='hs-definition'>rtsClosureType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-num'>2</span> <span class='hs-num'>0</span> <span class='hs-conid'>Constr</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CONSTR_2_0</span>
<a name="line-180"></a><span class='hs-definition'>rtsClosureType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-num'>1</span> <span class='hs-num'>1</span> <span class='hs-conid'>Constr</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CONSTR_1_1</span>
<a name="line-181"></a><span class='hs-definition'>rtsClosureType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-num'>0</span> <span class='hs-num'>2</span> <span class='hs-conid'>Constr</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CONSTR_0_2</span>
<a name="line-182"></a><span class='hs-definition'>rtsClosureType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Constr</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CONSTR</span>
<a name="line-183"></a>
<a name="line-184"></a><span class='hs-definition'>rtsClosureType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-num'>1</span> <span class='hs-num'>0</span> <span class='hs-conid'>Fun</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FUN_1_0</span>
<a name="line-185"></a><span class='hs-definition'>rtsClosureType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-num'>0</span> <span class='hs-num'>1</span> <span class='hs-conid'>Fun</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FUN_0_1</span>
<a name="line-186"></a><span class='hs-definition'>rtsClosureType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-num'>2</span> <span class='hs-num'>0</span> <span class='hs-conid'>Fun</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FUN_2_0</span>
<a name="line-187"></a><span class='hs-definition'>rtsClosureType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-num'>1</span> <span class='hs-num'>1</span> <span class='hs-conid'>Fun</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FUN_1_1</span>
<a name="line-188"></a><span class='hs-definition'>rtsClosureType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-num'>0</span> <span class='hs-num'>2</span> <span class='hs-conid'>Fun</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FUN_0_2</span>
<a name="line-189"></a><span class='hs-definition'>rtsClosureType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Fun</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FUN</span>
<a name="line-190"></a>
<a name="line-191"></a><span class='hs-definition'>rtsClosureType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-num'>1</span> <span class='hs-num'>0</span> <span class='hs-conid'>Thunk</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>THUNK_1_0</span>
<a name="line-192"></a><span class='hs-definition'>rtsClosureType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-num'>0</span> <span class='hs-num'>1</span> <span class='hs-conid'>Thunk</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>THUNK_0_1</span>
<a name="line-193"></a><span class='hs-definition'>rtsClosureType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-num'>2</span> <span class='hs-num'>0</span> <span class='hs-conid'>Thunk</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>THUNK_2_0</span>
<a name="line-194"></a><span class='hs-definition'>rtsClosureType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-num'>1</span> <span class='hs-num'>1</span> <span class='hs-conid'>Thunk</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>THUNK_1_1</span>
<a name="line-195"></a><span class='hs-definition'>rtsClosureType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-num'>0</span> <span class='hs-num'>2</span> <span class='hs-conid'>Thunk</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>THUNK_0_2</span>
<a name="line-196"></a><span class='hs-definition'>rtsClosureType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Thunk</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>THUNK</span>
<a name="line-197"></a>
<a name="line-198"></a><span class='hs-definition'>rtsClosureType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>ThunkSelector</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>  <span class='hs-conid'>THUNK_SELECTOR</span>
<a name="line-199"></a>
<a name="line-200"></a><span class='hs-comment'>-- Approximation: we use the CONSTR_NOCAF_STATIC type for static constructors</span>
<a name="line-201"></a><span class='hs-comment'>-- that have no pointer words only.</span>
<a name="line-202"></a><span class='hs-definition'>rtsClosureType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-conid'>True</span> <span class='hs-num'>0</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Constr</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CONSTR_NOCAF_STATIC</span>  <span class='hs-comment'>-- See isStaticNoCafCon below</span>
<a name="line-203"></a><span class='hs-definition'>rtsClosureType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-conid'>True</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Constr</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CONSTR_STATIC</span>
<a name="line-204"></a><span class='hs-definition'>rtsClosureType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-conid'>True</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Fun</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FUN_STATIC</span>
<a name="line-205"></a><span class='hs-definition'>rtsClosureType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-conid'>True</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Thunk</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>THUNK_STATIC</span>
<a name="line-206"></a>
<a name="line-207"></a><span class='hs-definition'>rtsClosureType</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-conid'>False</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>BlackHole</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>  <span class='hs-conid'>BLACKHOLE</span>
<a name="line-208"></a>
<a name="line-209"></a><span class='hs-definition'>rtsClosureType</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"rtsClosureType"</span>
<a name="line-210"></a>
<a name="line-211"></a><a name="rET_SMALL"></a><span class='hs-comment'>-- We export these ones</span>
<a name="line-212"></a><span class='hs-definition'>rET_SMALL</span><span class='hs-layout'>,</span> <span class='hs-varid'>rET_BIG</span><span class='hs-layout'>,</span> <span class='hs-varid'>aRG_GEN</span><span class='hs-layout'>,</span> <span class='hs-varid'>aRG_GEN_BIG</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StgHalfWord</span>
<a name="line-213"></a><span class='hs-definition'>rET_SMALL</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RET_SMALL</span>
<a name="line-214"></a><a name="rET_BIG"></a><span class='hs-definition'>rET_BIG</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RET_BIG</span>
<a name="line-215"></a><a name="aRG_GEN"></a><span class='hs-definition'>aRG_GEN</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ARG_GEN</span>
<a name="line-216"></a><a name="aRG_GEN_BIG"></a><span class='hs-definition'>aRG_GEN_BIG</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ARG_GEN_BIG</span>
</pre>\end{code}

Note [Static NoCaf constructors]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we know that a top-level binding 'x' is not Caffy (ie no CAFs are 
reachable from 'x'), then a statically allocated constructor (Just x)
is also not Caffy, and the garbage collector need not follow its
argument fields.  Exploiting this would require two static info tables
for Just, for the two cases where the argument was Caffy or non-Caffy.

Currently we don't do this; instead we treat nullary constructors 
as non-Caffy, and the others as potentially Caffy.


%************************************************************************
%*									*
             Pretty printing of SMRep and friends
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>ClosureTypeInfo</span> <span class='hs-keyword'>where</span>
<a name="line-2"></a>   <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTypeInfo</span>
<a name="line-3"></a>
<a name="line-4"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>SMRep</span> <span class='hs-keyword'>where</span>
<a name="line-5"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HeapRep</span> <span class='hs-varid'>static</span> <span class='hs-varid'>ps</span> <span class='hs-varid'>nps</span> <span class='hs-varid'>tyinfo</span><span class='hs-layout'>)</span>
<a name="line-6"></a>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>header</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>lbrace</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tyinfo</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>rbrace</span><span class='hs-layout'>)</span>
<a name="line-7"></a>     <span class='hs-keyword'>where</span>
<a name="line-8"></a>       <span class='hs-varid'>header</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"HeapRep"</span><span class='hs-layout'>)</span>
<a name="line-9"></a>                <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>static</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"static"</span><span class='hs-layout'>)</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>empty</span>
<a name="line-10"></a>                <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pp_n</span> <span class='hs-str'>"ptrs"</span> <span class='hs-varid'>ps</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pp_n</span> <span class='hs-str'>"nonptrs"</span> <span class='hs-varid'>nps</span>
<a name="line-11"></a>       <span class='hs-varid'>pp_n</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-12"></a>       <span class='hs-varid'>pp_n</span> <span class='hs-keyword'>_</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-13"></a>       <span class='hs-varid'>pp_n</span> <span class='hs-varid'>s</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>int</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-varid'>s</span>
<a name="line-14"></a>
<a name="line-15"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>StackRep</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"StackRep"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>bs</span>
<a name="line-16"></a>
<a name="line-17"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>RTSRep</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>rep</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"tag:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>rep</span>
<a name="line-18"></a>
<a name="line-19"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>ArgDescr</span> <span class='hs-keyword'>where</span>
<a name="line-20"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArgSpec</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"ArgSpec"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>integer</span> <span class='hs-layout'>(</span><span class='hs-varid'>toInteger</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-21"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArgGen</span> <span class='hs-varid'>ls</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"ArgGen"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ls</span>
<a name="line-22"></a>  
<a name="line-23"></a><a name="pprTypeInfo"></a><span class='hs-definition'>pprTypeInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ClosureTypeInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-24"></a><span class='hs-definition'>pprTypeInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Constr</span> <span class='hs-varid'>tag</span> <span class='hs-varid'>descr</span><span class='hs-layout'>)</span>
<a name="line-25"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Con"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> 
<a name="line-26"></a>    <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"tag:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>integer</span> <span class='hs-layout'>(</span><span class='hs-varid'>toInteger</span> <span class='hs-varid'>tag</span><span class='hs-layout'>)</span>
<a name="line-27"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"descr:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>descr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-28"></a>
<a name="line-29"></a><span class='hs-definition'>pprTypeInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fun</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-30"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Fun"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> 
<a name="line-31"></a>    <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"arity:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>integer</span> <span class='hs-layout'>(</span><span class='hs-varid'>toInteger</span> <span class='hs-varid'>arity</span><span class='hs-layout'>)</span>
<a name="line-32"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-layout'>(</span><span class='hs-str'>"fun_type:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-33"></a>
<a name="line-34"></a><span class='hs-definition'>pprTypeInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>ThunkSelector</span> <span class='hs-varid'>offset</span><span class='hs-layout'>)</span> 
<a name="line-35"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"ThunkSel"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>integer</span> <span class='hs-layout'>(</span><span class='hs-varid'>toInteger</span> <span class='hs-varid'>offset</span><span class='hs-layout'>)</span>
<a name="line-36"></a>
<a name="line-37"></a><span class='hs-definition'>pprTypeInfo</span> <span class='hs-conid'>Thunk</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Thunk"</span><span class='hs-layout'>)</span>
<a name="line-38"></a><span class='hs-definition'>pprTypeInfo</span> <span class='hs-conid'>BlackHole</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"BlackHole"</span><span class='hs-layout'>)</span>
<a name="line-39"></a>
<a name="line-40"></a><a name="stringToWord8s"></a><span class='hs-comment'>-- XXX Does not belong here!!</span>
<a name="line-41"></a><span class='hs-definition'>stringToWord8s</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Word8</span><span class='hs-keyglyph'>]</span>
<a name="line-42"></a><span class='hs-definition'>stringToWord8s</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ord</span><span class='hs-layout'>)</span> <span class='hs-varid'>s</span>
<a name="line-43"></a>
<a name="line-44"></a><a name="pprWord8String"></a><span class='hs-definition'>pprWord8String</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Word8</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-45"></a><span class='hs-comment'>-- Debug printing.  Not very clever right now.</span>
<a name="line-46"></a><span class='hs-definition'>pprWord8String</span> <span class='hs-varid'>ws</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>ws</span><span class='hs-layout'>)</span>
</pre>\end{code}
</body>
</html>
