<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>codeGen/CgTailCall.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%
% Code generation for tail calls.

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>CgTailCall</span> <span class='hs-layout'>(</span>
<a name="line-9"></a>	<span class='hs-varid'>cgTailCall</span><span class='hs-layout'>,</span> <span class='hs-varid'>performTailCall</span><span class='hs-layout'>,</span>
<a name="line-10"></a>	<span class='hs-varid'>performReturn</span><span class='hs-layout'>,</span> <span class='hs-varid'>performPrimReturn</span><span class='hs-layout'>,</span>
<a name="line-11"></a>	<span class='hs-varid'>returnUnboxedTuple</span><span class='hs-layout'>,</span> <span class='hs-varid'>ccallReturnUnboxedTuple</span><span class='hs-layout'>,</span>
<a name="line-12"></a>	<span class='hs-varid'>pushUnboxedTuple</span><span class='hs-layout'>,</span>
<a name="line-13"></a>	<span class='hs-varid'>tailCallPrimOp</span><span class='hs-layout'>,</span>
<a name="line-14"></a>        <span class='hs-varid'>tailCallPrimCall</span><span class='hs-layout'>,</span>
<a name="line-15"></a>
<a name="line-16"></a>	<span class='hs-varid'>pushReturnAddress</span>
<a name="line-17"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-18"></a>
<a name="line-19"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-20"></a>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgMonad</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgBindery</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgInfoTbls</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgCallConv</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgStackery</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgHeapery</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgUtils</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgTicky</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ClosureInfo</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OldCmm</span>	
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OldCmmUtils</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CLabel</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>StgSyn</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrimOp</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>StaticFlags</span>
<a name="line-39"></a>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-41"></a>
<a name="line-42"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-43"></a><span class='hs-comment'>-- Tail Calls</span>
<a name="line-44"></a>
<a name="line-45"></a><a name="cgTailCall"></a><span class='hs-definition'>cgTailCall</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StgArg</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-46"></a>
<a name="line-47"></a><span class='hs-comment'>-- Here's the code we generate for a tail call.  (NB there may be no</span>
<a name="line-48"></a><span class='hs-comment'>-- arguments, in which case this boils down to just entering a variable.)</span>
<a name="line-49"></a><span class='hs-comment'>-- </span>
<a name="line-50"></a><span class='hs-comment'>--    *	Put args in the top locations of the stack.</span>
<a name="line-51"></a><span class='hs-comment'>--    *	Adjust the stack ptr</span>
<a name="line-52"></a><span class='hs-comment'>--    *	Make R1 point to the function closure if necessary.</span>
<a name="line-53"></a><span class='hs-comment'>--    *	Perform the call.</span>
<a name="line-54"></a><span class='hs-comment'>--</span>
<a name="line-55"></a><span class='hs-comment'>-- Things to be careful about:</span>
<a name="line-56"></a><span class='hs-comment'>--</span>
<a name="line-57"></a><span class='hs-comment'>--    *	Don't overwrite stack locations before you have finished with</span>
<a name="line-58"></a><span class='hs-comment'>-- 	them (remember you need the function and the as-yet-unmoved</span>
<a name="line-59"></a><span class='hs-comment'>-- 	arguments).</span>
<a name="line-60"></a><span class='hs-comment'>--    *	Preferably, generate no code to replace x by x on the stack (a</span>
<a name="line-61"></a><span class='hs-comment'>-- 	common situation in tail-recursion).</span>
<a name="line-62"></a><span class='hs-comment'>--    *	Adjust the stack high water mark appropriately.</span>
<a name="line-63"></a><span class='hs-comment'>-- </span>
<a name="line-64"></a><span class='hs-comment'>-- Treat unboxed locals exactly like literals (above) except use the addr</span>
<a name="line-65"></a><span class='hs-comment'>-- mode for the local instead of (CLit lit) in the assignment.</span>
<a name="line-66"></a>
<a name="line-67"></a><span class='hs-definition'>cgTailCall</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>args</span>
<a name="line-68"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>fun_info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCgIdInfo</span> <span class='hs-varid'>fun</span>
<a name="line-69"></a>
<a name="line-70"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isUnLiftedType</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span>
<a name="line-71"></a>	  <span class='hs-keyword'>then</span> 	<span class='hs-comment'>-- Primitive return</span>
<a name="line-72"></a>		<span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>null</span> <span class='hs-varid'>args</span> <span class='hs-layout'>)</span>
<a name="line-73"></a>	    <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>fun_amode</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>idInfoToAmode</span> <span class='hs-varid'>fun_info</span>
<a name="line-74"></a>		<span class='hs-layout'>;</span> <span class='hs-varid'>performPrimReturn</span> <span class='hs-layout'>(</span><span class='hs-varid'>cgIdInfoArgRep</span> <span class='hs-varid'>fun_info</span><span class='hs-layout'>)</span> <span class='hs-varid'>fun_amode</span> <span class='hs-layout'>}</span> 
<a name="line-75"></a>
<a name="line-76"></a>	  <span class='hs-keyword'>else</span> <span class='hs-comment'>-- Normal case, fun is boxed</span>
<a name="line-77"></a>	    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>arg_amodes</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getArgAmodes</span> <span class='hs-varid'>args</span>
<a name="line-78"></a>		<span class='hs-layout'>;</span> <span class='hs-varid'>performTailCall</span> <span class='hs-varid'>fun_info</span> <span class='hs-varid'>arg_amodes</span> <span class='hs-varid'>noStmts</span> <span class='hs-layout'>}</span>
<a name="line-79"></a>	<span class='hs-layout'>}</span>
<a name="line-80"></a>		
<a name="line-81"></a>
<a name="line-82"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-83"></a><span class='hs-comment'>-- The guts of a tail-call</span>
<a name="line-84"></a>
<a name="line-85"></a><a name="performTailCall"></a><span class='hs-definition'>performTailCall</span> 
<a name="line-86"></a>	<span class='hs-keyglyph'>::</span> <span class='hs-conid'>CgIdInfo</span>		<span class='hs-comment'>-- The function</span>
<a name="line-87"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>CgRep</span><span class='hs-layout'>,</span><span class='hs-conid'>CmmExpr</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>	<span class='hs-comment'>-- Args</span>
<a name="line-88"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmStmts</span>		<span class='hs-comment'>-- Pending simultaneous assignments</span>
<a name="line-89"></a>				<span class='hs-comment'>--  *** GUARANTEED to contain only stack assignments.</span>
<a name="line-90"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-91"></a>
<a name="line-92"></a><span class='hs-definition'>performTailCall</span> <span class='hs-varid'>fun_info</span> <span class='hs-varid'>arg_amodes</span> <span class='hs-varid'>pending_assts</span>
<a name="line-93"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>join_sp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>maybeLetNoEscape</span> <span class='hs-varid'>fun_info</span>
<a name="line-94"></a>  <span class='hs-keyglyph'>=</span> 	   <span class='hs-comment'>-- A let-no-escape is slightly different, because we</span>
<a name="line-95"></a>	   <span class='hs-comment'>-- arrange the stack arguments into pointers and non-pointers</span>
<a name="line-96"></a>	   <span class='hs-comment'>-- to make the heap check easier.  The tail-call sequence</span>
<a name="line-97"></a>	   <span class='hs-comment'>-- is very similar to returning an unboxed tuple, so we</span>
<a name="line-98"></a>	   <span class='hs-comment'>-- share some code.</span>
<a name="line-99"></a>     <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>final_sp</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_assts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>pushUnboxedTuple</span> <span class='hs-varid'>join_sp</span> <span class='hs-varid'>arg_amodes</span>
<a name="line-100"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>emitSimultaneously</span> <span class='hs-layout'>(</span><span class='hs-varid'>pending_assts</span> <span class='hs-varop'>`plusStmts`</span> <span class='hs-varid'>arg_assts</span><span class='hs-layout'>)</span>
<a name="line-101"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>lbl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>enterReturnPtLabel</span> <span class='hs-layout'>(</span><span class='hs-varid'>idUnique</span> <span class='hs-layout'>(</span><span class='hs-varid'>cgIdInfoId</span> <span class='hs-varid'>fun_info</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-102"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>doFinalJump</span> <span class='hs-varid'>final_sp</span> <span class='hs-conid'>True</span> <span class='hs-comment'>{- Is LNE -}</span> <span class='hs-layout'>(</span><span class='hs-varid'>jumpToLbl</span> <span class='hs-varid'>lbl</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-103"></a>
<a name="line-104"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-105"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 	<span class='hs-layout'>{</span> <span class='hs-varid'>fun_amode</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>idInfoToAmode</span> <span class='hs-varid'>fun_info</span>
<a name="line-106"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>assignSt</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmAssign</span> <span class='hs-varid'>nodeReg</span> <span class='hs-varid'>fun_amode</span>
<a name="line-107"></a>              <span class='hs-varid'>node_asst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>oneStmt</span> <span class='hs-varid'>assignSt</span>
<a name="line-108"></a>	      <span class='hs-varid'>opt_node_asst</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>nodeMustPointToIt</span> <span class='hs-varid'>lf_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>node_asst</span>
<a name="line-109"></a>			    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>		        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noStmts</span>
<a name="line-110"></a>	<span class='hs-layout'>;</span> <span class='hs-conid'>EndOfBlockInfo</span> <span class='hs-varid'>sp</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getEndOfBlockInfo</span>
<a name="line-111"></a>
<a name="line-112"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-113"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>getCallMethod</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>fun_name</span> <span class='hs-varid'>fun_has_cafs</span> <span class='hs-varid'>lf_info</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>arg_amodes</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-114"></a>
<a name="line-115"></a>	    <span class='hs-comment'>-- Node must always point to things we enter</span>
<a name="line-116"></a>	    <span class='hs-conid'>EnterIt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-117"></a>		<span class='hs-layout'>{</span> <span class='hs-varid'>emitSimultaneously</span> <span class='hs-layout'>(</span><span class='hs-varid'>node_asst</span> <span class='hs-varop'>`plusStmts`</span> <span class='hs-varid'>pending_assts</span><span class='hs-layout'>)</span> 
<a name="line-118"></a>		<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>target</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>entryCode</span> <span class='hs-layout'>(</span><span class='hs-varid'>closureInfoPtr</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-varid'>nodeReg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-119"></a>                      <span class='hs-varid'>enterClosure</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stmtC</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmJump</span> <span class='hs-varid'>target</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-120"></a>                      <span class='hs-comment'>-- If this is a scrutinee</span>
<a name="line-121"></a>                      <span class='hs-comment'>-- let's check if the closure is a constructor</span>
<a name="line-122"></a>                      <span class='hs-comment'>-- so we can directly jump to the alternatives switch</span>
<a name="line-123"></a>                      <span class='hs-comment'>-- statement.</span>
<a name="line-124"></a>                      <span class='hs-varid'>jumpInstr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getEndOfBlockInfo</span> <span class='hs-varop'>&gt;&gt;=</span>
<a name="line-125"></a>                                  <span class='hs-varid'>maybeSwitchOnCons</span> <span class='hs-varid'>enterClosure</span>
<a name="line-126"></a>		<span class='hs-layout'>;</span> <span class='hs-varid'>doFinalJump</span> <span class='hs-varid'>sp</span> <span class='hs-conid'>False</span> <span class='hs-varid'>jumpInstr</span> <span class='hs-layout'>}</span>
<a name="line-127"></a>    
<a name="line-128"></a>	    <span class='hs-comment'>-- A function, but we have zero arguments.  It is already in WHNF,</span>
<a name="line-129"></a>	    <span class='hs-comment'>-- so we can just return it.  </span>
<a name="line-130"></a>	    <span class='hs-comment'>-- As with any return, Node must point to it.</span>
<a name="line-131"></a>	    <span class='hs-conid'>ReturnIt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-132"></a>		<span class='hs-layout'>{</span> <span class='hs-varid'>emitSimultaneously</span> <span class='hs-layout'>(</span><span class='hs-varid'>node_asst</span> <span class='hs-varop'>`plusStmts`</span> <span class='hs-varid'>pending_assts</span><span class='hs-layout'>)</span>
<a name="line-133"></a>		<span class='hs-layout'>;</span> <span class='hs-varid'>doFinalJump</span> <span class='hs-varid'>sp</span> <span class='hs-conid'>False</span> <span class='hs-varid'>emitReturnInstr</span> <span class='hs-layout'>}</span>
<a name="line-134"></a>    
<a name="line-135"></a>	    <span class='hs-comment'>-- A real constructor.  Don't bother entering it, </span>
<a name="line-136"></a>	    <span class='hs-comment'>-- just do the right sort of return instead.</span>
<a name="line-137"></a>	    <span class='hs-comment'>-- As with any return, Node must point to it.</span>
<a name="line-138"></a>	    <span class='hs-conid'>ReturnCon</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-139"></a>		<span class='hs-layout'>{</span> <span class='hs-varid'>emitSimultaneously</span> <span class='hs-layout'>(</span><span class='hs-varid'>node_asst</span> <span class='hs-varop'>`plusStmts`</span> <span class='hs-varid'>pending_assts</span><span class='hs-layout'>)</span>
<a name="line-140"></a>		<span class='hs-layout'>;</span> <span class='hs-varid'>doFinalJump</span> <span class='hs-varid'>sp</span> <span class='hs-conid'>False</span> <span class='hs-varid'>emitReturnInstr</span> <span class='hs-layout'>}</span>
<a name="line-141"></a>
<a name="line-142"></a>	    <span class='hs-conid'>JumpToIt</span> <span class='hs-varid'>lbl</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-143"></a>		<span class='hs-layout'>{</span> <span class='hs-varid'>emitSimultaneously</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_node_asst</span> <span class='hs-varop'>`plusStmts`</span> <span class='hs-varid'>pending_assts</span><span class='hs-layout'>)</span>
<a name="line-144"></a>		<span class='hs-layout'>;</span> <span class='hs-varid'>doFinalJump</span> <span class='hs-varid'>sp</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-varid'>jumpToLbl</span> <span class='hs-varid'>lbl</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-145"></a>    
<a name="line-146"></a>	    <span class='hs-comment'>-- A slow function call via the RTS apply routines</span>
<a name="line-147"></a>	    <span class='hs-comment'>-- Node must definitely point to the thing</span>
<a name="line-148"></a>	    <span class='hs-conid'>SlowCall</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> 
<a name="line-149"></a>		<span class='hs-layout'>{</span>  <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>arg_amodes</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-150"></a>		   <span class='hs-layout'>{</span> <span class='hs-keyword'>if</span> <span class='hs-layout'>(</span><span class='hs-varid'>isKnownFun</span> <span class='hs-varid'>lf_info</span><span class='hs-layout'>)</span> 
<a name="line-151"></a>			<span class='hs-keyword'>then</span> <span class='hs-varid'>tickyKnownCallTooFewArgs</span>
<a name="line-152"></a>			<span class='hs-keyword'>else</span> <span class='hs-varid'>tickyUnknownCall</span>
<a name="line-153"></a>		   <span class='hs-layout'>;</span> <span class='hs-varid'>tickySlowCallPat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>arg_amodes</span><span class='hs-layout'>)</span> 
<a name="line-154"></a>		   <span class='hs-layout'>}</span>
<a name="line-155"></a>
<a name="line-156"></a>		<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>apply_lbl</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-varid'>extra_args</span><span class='hs-layout'>)</span> 
<a name="line-157"></a>			<span class='hs-keyglyph'>=</span> <span class='hs-varid'>constructSlowCall</span> <span class='hs-varid'>arg_amodes</span>
<a name="line-158"></a>
<a name="line-159"></a>		<span class='hs-layout'>;</span> <span class='hs-varid'>directCall</span> <span class='hs-varid'>sp</span> <span class='hs-varid'>apply_lbl</span> <span class='hs-varid'>args</span> <span class='hs-varid'>extra_args</span> 
<a name="line-160"></a>			<span class='hs-layout'>(</span><span class='hs-varid'>node_asst</span> <span class='hs-varop'>`plusStmts`</span> <span class='hs-varid'>pending_assts</span><span class='hs-layout'>)</span>
<a name="line-161"></a>
<a name="line-162"></a>		<span class='hs-layout'>}</span>
<a name="line-163"></a>    
<a name="line-164"></a>	    <span class='hs-comment'>-- A direct function call (possibly with some left-over arguments)</span>
<a name="line-165"></a>	    <span class='hs-conid'>DirectEntry</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-166"></a>		<span class='hs-layout'>{</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>arity</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>arg_amodes</span>
<a name="line-167"></a>			<span class='hs-keyword'>then</span> <span class='hs-varid'>tickyKnownCallExact</span>
<a name="line-168"></a>			<span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>tickyKnownCallExtraArgs</span>
<a name="line-169"></a>				<span class='hs-varid'>tickySlowCallPat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-layout'>(</span><span class='hs-varid'>drop</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>arg_amodes</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-170"></a>
<a name="line-171"></a> 		<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span>
<a name="line-172"></a>		     <span class='hs-comment'>-- The args beyond the arity go straight on the stack</span>
<a name="line-173"></a>		     <span class='hs-layout'>(</span><span class='hs-varid'>arity_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>extra_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAt</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>arg_amodes</span>
<a name="line-174"></a>     
<a name="line-175"></a>		<span class='hs-layout'>;</span> <span class='hs-varid'>directCall</span> <span class='hs-varid'>sp</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>arity_args</span> <span class='hs-varid'>extra_args</span>
<a name="line-176"></a>			<span class='hs-layout'>(</span><span class='hs-varid'>opt_node_asst</span> <span class='hs-varop'>`plusStmts`</span> <span class='hs-varid'>pending_assts</span><span class='hs-layout'>)</span>
<a name="line-177"></a>	        <span class='hs-layout'>}</span>
<a name="line-178"></a>	<span class='hs-layout'>}</span>
<a name="line-179"></a>  <span class='hs-keyword'>where</span>
<a name="line-180"></a>    <span class='hs-varid'>fun_id</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cgIdInfoId</span> <span class='hs-varid'>fun_info</span>
<a name="line-181"></a>    <span class='hs-varid'>fun_name</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idName</span> <span class='hs-varid'>fun_id</span>
<a name="line-182"></a>    <span class='hs-varid'>lf_info</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cgIdInfoLF</span> <span class='hs-varid'>fun_info</span>
<a name="line-183"></a>    <span class='hs-varid'>fun_has_cafs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idCafInfo</span> <span class='hs-varid'>fun_id</span>
<a name="line-184"></a>    <span class='hs-varid'>untag_node</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmAssign</span> <span class='hs-varid'>nodeReg</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmmUntag</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-varid'>nodeReg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-185"></a>    <span class='hs-comment'>-- Test if closure is a constructor</span>
<a name="line-186"></a>    <span class='hs-varid'>maybeSwitchOnCons</span> <span class='hs-varid'>enterClosure</span> <span class='hs-varid'>eob</span>
<a name="line-187"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EndOfBlockInfo</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>CaseAlts</span> <span class='hs-varid'>lbl</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>eob</span><span class='hs-layout'>,</span>
<a name="line-188"></a>                <span class='hs-varid'>not</span> <span class='hs-varid'>opt_SccProfilingOn</span>
<a name="line-189"></a>                <span class='hs-comment'>-- we can't shortcut when profiling is on, because we have</span>
<a name="line-190"></a>                <span class='hs-comment'>-- to enter a closure to mark it as "used" for LDV profiling</span>
<a name="line-191"></a>              <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is_constr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newLabelC</span>
<a name="line-192"></a>                   <span class='hs-comment'>-- Is the pointer tagged?</span>
<a name="line-193"></a>                   <span class='hs-comment'>-- Yes, jump to switch statement</span>
<a name="line-194"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>stmtC</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmCondBranch</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmmIsTagged</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-varid'>nodeReg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-195"></a>                                <span class='hs-varid'>is_constr</span><span class='hs-layout'>)</span>
<a name="line-196"></a>                   <span class='hs-comment'>-- No, enter the closure.</span>
<a name="line-197"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>enterClosure</span>
<a name="line-198"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>labelC</span> <span class='hs-varid'>is_constr</span>
<a name="line-199"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>stmtC</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmJump</span> <span class='hs-layout'>(</span><span class='hs-varid'>entryCode</span> <span class='hs-varop'>$</span> <span class='hs-conid'>CmmLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLabel</span> <span class='hs-varid'>lbl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-200"></a>                   <span class='hs-layout'>}</span>
<a name="line-201"></a><span class='hs-comment'>{-
<a name="line-202"></a>              -- This is a scrutinee for a case expression
<a name="line-203"></a>              -- so let's see if we can directly inspect the closure
<a name="line-204"></a>              | EndOfBlockInfo _ (CaseAlts lbl _ _ _) &lt;- eob
<a name="line-205"></a>              = do { no_cons &lt;- newLabelC
<a name="line-206"></a>                   -- Both the NCG and gcc optimize away the temp
<a name="line-207"></a>                   ; z &lt;- newTemp  wordRep
<a name="line-208"></a>                   ; stmtC (CmmAssign z tag_expr)
<a name="line-209"></a>                   ; let tag = CmmReg z
<a name="line-210"></a>                   -- Is the closure a cons?
<a name="line-211"></a>                   ; stmtC (CmmCondBranch (cond1 tag) no_cons)
<a name="line-212"></a>                   ; stmtC (CmmCondBranch (cond2 tag) no_cons)
<a name="line-213"></a>                   -- Yes, jump to switch statement
<a name="line-214"></a>                   ; stmtC (CmmJump (CmmLit (CmmLabel lbl)) [])
<a name="line-215"></a>                   ; labelC no_cons
<a name="line-216"></a>                   -- No, enter the closure.
<a name="line-217"></a>                   ; enterClosure
<a name="line-218"></a>                   }
<a name="line-219"></a>-}</span>
<a name="line-220"></a>              <span class='hs-comment'>-- No case expression involved, enter the closure.</span>
<a name="line-221"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-222"></a>              <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>stmtC</span> <span class='hs-varid'>untag_node</span>
<a name="line-223"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>enterClosure</span>
<a name="line-224"></a>                   <span class='hs-layout'>}</span>
<a name="line-225"></a>        <span class='hs-keyword'>where</span>
<a name="line-226"></a>          <span class='hs-comment'>--cond1 tag  = cmmULtWord tag lowCons</span>
<a name="line-227"></a>          <span class='hs-comment'>-- More efficient than the above?</span>
<a name="line-228"></a><span class='hs-comment'>{-
<a name="line-229"></a>          tag_expr   = cmmGetClosureType (CmmReg nodeReg)
<a name="line-230"></a>          cond1 tag  = cmmEqWord tag (CmmLit (mkIntCLit 0))
<a name="line-231"></a>          cond2 tag  = cmmUGtWord tag highCons
<a name="line-232"></a>          lowCons    = CmmLit (mkIntCLit 1)
<a name="line-233"></a>            -- CONSTR
<a name="line-234"></a>          highCons   = CmmLit (mkIntCLit 8)
<a name="line-235"></a>            -- CONSTR_NOCAF_STATIC (from ClosureType.h)
<a name="line-236"></a>-}</span>
<a name="line-237"></a>
<a name="line-238"></a><a name="directCall"></a><span class='hs-definition'>directCall</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>VirtualSpOffset</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CLabel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>CgRep</span><span class='hs-layout'>,</span> <span class='hs-conid'>CmmExpr</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-239"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>CgRep</span><span class='hs-layout'>,</span> <span class='hs-conid'>CmmExpr</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmStmts</span>
<a name="line-240"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-241"></a><span class='hs-definition'>directCall</span> <span class='hs-varid'>sp</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>args</span> <span class='hs-varid'>extra_args</span> <span class='hs-varid'>assts</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-242"></a>  <span class='hs-keyword'>let</span>
<a name="line-243"></a>	<span class='hs-comment'>-- First chunk of args go in registers</span>
<a name="line-244"></a>	<span class='hs-layout'>(</span><span class='hs-varid'>reg_arg_amodes</span><span class='hs-layout'>,</span> <span class='hs-varid'>stk_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>assignCallRegs</span> <span class='hs-varid'>args</span>
<a name="line-245"></a>     
<a name="line-246"></a>	<span class='hs-comment'>-- Any "extra" arguments are placed in frames on the</span>
<a name="line-247"></a>	<span class='hs-comment'>-- stack after the other arguments.</span>
<a name="line-248"></a>	<span class='hs-varid'>slow_stk_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>slowArgs</span> <span class='hs-varid'>extra_args</span>
<a name="line-249"></a>
<a name="line-250"></a>	<span class='hs-varid'>reg_assts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>assignToRegs</span> <span class='hs-varid'>reg_arg_amodes</span>
<a name="line-251"></a>  <span class='hs-comment'>--</span>
<a name="line-252"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>final_sp</span><span class='hs-layout'>,</span> <span class='hs-varid'>stk_assts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkStkAmodes</span> <span class='hs-varid'>sp</span> <span class='hs-layout'>(</span><span class='hs-varid'>stk_args</span> <span class='hs-varop'>++</span> <span class='hs-varid'>slow_stk_args</span><span class='hs-layout'>)</span>
<a name="line-253"></a>
<a name="line-254"></a>  <span class='hs-varid'>emitSimultaneously</span> <span class='hs-layout'>(</span><span class='hs-varid'>reg_assts</span>     <span class='hs-varop'>`plusStmts`</span>
<a name="line-255"></a>		      <span class='hs-varid'>stk_assts</span>     <span class='hs-varop'>`plusStmts`</span>
<a name="line-256"></a>		      <span class='hs-varid'>assts</span><span class='hs-layout'>)</span>
<a name="line-257"></a>
<a name="line-258"></a>  <span class='hs-varid'>doFinalJump</span> <span class='hs-varid'>final_sp</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-varid'>jumpToLbl</span> <span class='hs-varid'>lbl</span><span class='hs-layout'>)</span>
<a name="line-259"></a>
<a name="line-260"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-261"></a><span class='hs-comment'>-- The final clean-up before we do a jump at the end of a basic block.</span>
<a name="line-262"></a><span class='hs-comment'>-- This code is shared by tail-calls and returns.</span>
<a name="line-263"></a>
<a name="line-264"></a><a name="doFinalJump"></a><span class='hs-definition'>doFinalJump</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>VirtualSpOffset</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span> 
<a name="line-265"></a><span class='hs-definition'>doFinalJump</span> <span class='hs-varid'>final_sp</span> <span class='hs-varid'>is_let_no_escape</span> <span class='hs-varid'>jump_code</span>
<a name="line-266"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-comment'>-- Adjust the high-water mark if necessary</span>
<a name="line-267"></a>	  <span class='hs-varid'>adjustStackHW</span> <span class='hs-varid'>final_sp</span>
<a name="line-268"></a>
<a name="line-269"></a>	<span class='hs-comment'>-- Push a return address if necessary (after the assignments</span>
<a name="line-270"></a>	<span class='hs-comment'>-- above, in case we clobber a live stack location)</span>
<a name="line-271"></a>	<span class='hs-comment'>--</span>
<a name="line-272"></a>	<span class='hs-comment'>-- DONT push the return address when we're about to jump to a</span>
<a name="line-273"></a>	<span class='hs-comment'>-- let-no-escape: the final tail call in the let-no-escape</span>
<a name="line-274"></a>	<span class='hs-comment'>-- will do this.</span>
<a name="line-275"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>eob</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getEndOfBlockInfo</span>
<a name="line-276"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>whenC</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varid'>is_let_no_escape</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>pushReturnAddress</span> <span class='hs-varid'>eob</span><span class='hs-layout'>)</span>
<a name="line-277"></a>
<a name="line-278"></a>	    <span class='hs-comment'>-- Final adjustment of Sp/Hp</span>
<a name="line-279"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>adjustSpAndHp</span> <span class='hs-varid'>final_sp</span>
<a name="line-280"></a>
<a name="line-281"></a>	    <span class='hs-comment'>-- and do the jump</span>
<a name="line-282"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>jump_code</span> <span class='hs-layout'>}</span>
<a name="line-283"></a>
<a name="line-284"></a><span class='hs-comment'>-- ----------------------------------------------------------------------------</span>
<a name="line-285"></a><span class='hs-comment'>-- A general return (just a special case of doFinalJump, above)</span>
<a name="line-286"></a>
<a name="line-287"></a><a name="performReturn"></a><span class='hs-definition'>performReturn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Code</span>	<span class='hs-comment'>-- The code to execute to actually do the return</span>
<a name="line-288"></a>	      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-289"></a>
<a name="line-290"></a><span class='hs-definition'>performReturn</span> <span class='hs-varid'>finish_code</span>
<a name="line-291"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-conid'>EndOfBlockInfo</span> <span class='hs-varid'>args_sp</span> <span class='hs-sel'>_sequel</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getEndOfBlockInfo</span>
<a name="line-292"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>doFinalJump</span> <span class='hs-varid'>args_sp</span> <span class='hs-conid'>False</span><span class='hs-comment'>{-not a LNE-}</span> <span class='hs-varid'>finish_code</span> <span class='hs-layout'>}</span>
<a name="line-293"></a>
<a name="line-294"></a><span class='hs-comment'>-- ----------------------------------------------------------------------------</span>
<a name="line-295"></a><span class='hs-comment'>-- Primitive Returns</span>
<a name="line-296"></a><span class='hs-comment'>-- Just load the return value into the right register, and return.</span>
<a name="line-297"></a>
<a name="line-298"></a><a name="performPrimReturn"></a><span class='hs-definition'>performPrimReturn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CgRep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmExpr</span>	<span class='hs-comment'>-- The thing to return</span>
<a name="line-299"></a>		  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-300"></a><span class='hs-definition'>performPrimReturn</span> <span class='hs-varid'>rep</span> <span class='hs-varid'>amode</span>
<a name="line-301"></a>  <span class='hs-keyglyph'>=</span>  <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>whenC</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isVoidArg</span> <span class='hs-varid'>rep</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-302"></a>		<span class='hs-layout'>(</span><span class='hs-varid'>stmtC</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmAssign</span> <span class='hs-varid'>ret_reg</span> <span class='hs-varid'>amode</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-303"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>performReturn</span> <span class='hs-varid'>emitReturnInstr</span> <span class='hs-layout'>}</span>
<a name="line-304"></a>  <span class='hs-keyword'>where</span>
<a name="line-305"></a>    <span class='hs-varid'>ret_reg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataReturnConvPrim</span> <span class='hs-varid'>rep</span>
<a name="line-306"></a>
<a name="line-307"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-308"></a><span class='hs-comment'>-- Unboxed tuple returns</span>
<a name="line-309"></a>
<a name="line-310"></a><span class='hs-comment'>-- These are a bit like a normal tail call, except that:</span>
<a name="line-311"></a><span class='hs-comment'>--</span>
<a name="line-312"></a><span class='hs-comment'>--   - The tail-call target is an info table on the stack</span>
<a name="line-313"></a><span class='hs-comment'>--</span>
<a name="line-314"></a><span class='hs-comment'>--   - We separate stack arguments into pointers and non-pointers,</span>
<a name="line-315"></a><span class='hs-comment'>--     to make it easier to leave things in a sane state for a heap check.</span>
<a name="line-316"></a><span class='hs-comment'>--     This is OK because we can never partially-apply an unboxed tuple,</span>
<a name="line-317"></a><span class='hs-comment'>--     unlike a function.  The same technique is used when calling</span>
<a name="line-318"></a><span class='hs-comment'>--     let-no-escape functions, because they also can't be partially</span>
<a name="line-319"></a><span class='hs-comment'>--     applied.</span>
<a name="line-320"></a>
<a name="line-321"></a><a name="returnUnboxedTuple"></a><span class='hs-definition'>returnUnboxedTuple</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>CgRep</span><span class='hs-layout'>,</span> <span class='hs-conid'>CmmExpr</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-322"></a><span class='hs-definition'>returnUnboxedTuple</span> <span class='hs-varid'>amodes</span>
<a name="line-323"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 	<span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-conid'>EndOfBlockInfo</span> <span class='hs-varid'>args_sp</span> <span class='hs-sel'>_sequel</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getEndOfBlockInfo</span>
<a name="line-324"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>tickyUnboxedTupleReturn</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>amodes</span><span class='hs-layout'>)</span>
<a name="line-325"></a>	<span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>final_sp</span><span class='hs-layout'>,</span> <span class='hs-varid'>assts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>pushUnboxedTuple</span> <span class='hs-varid'>args_sp</span> <span class='hs-varid'>amodes</span>
<a name="line-326"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>emitSimultaneously</span> <span class='hs-varid'>assts</span>
<a name="line-327"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>doFinalJump</span> <span class='hs-varid'>final_sp</span> <span class='hs-conid'>False</span><span class='hs-comment'>{-not a LNE-}</span> <span class='hs-varid'>emitReturnInstr</span> <span class='hs-layout'>}</span>
<a name="line-328"></a>
<a name="line-329"></a><a name="pushUnboxedTuple"></a><span class='hs-definition'>pushUnboxedTuple</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>VirtualSpOffset</span>		<span class='hs-comment'>-- Sp at which to start pushing</span>
<a name="line-330"></a>		 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>CgRep</span><span class='hs-layout'>,</span> <span class='hs-conid'>CmmExpr</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>		<span class='hs-comment'>-- amodes of the components</span>
<a name="line-331"></a>		 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-layout'>(</span><span class='hs-conid'>VirtualSpOffset</span><span class='hs-layout'>,</span>	<span class='hs-comment'>-- final Sp</span>
<a name="line-332"></a>			   <span class='hs-conid'>CmmStmts</span><span class='hs-layout'>)</span>		<span class='hs-comment'>-- assignments (regs+stack)</span>
<a name="line-333"></a>
<a name="line-334"></a><span class='hs-definition'>pushUnboxedTuple</span> <span class='hs-varid'>sp</span> <span class='hs-conid'>[]</span> 
<a name="line-335"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>sp</span><span class='hs-layout'>,</span> <span class='hs-varid'>noStmts</span><span class='hs-layout'>)</span>
<a name="line-336"></a><span class='hs-definition'>pushUnboxedTuple</span> <span class='hs-varid'>sp</span> <span class='hs-varid'>amodes</span>
<a name="line-337"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-keyword'>let</span>	<span class='hs-layout'>(</span><span class='hs-varid'>reg_arg_amodes</span><span class='hs-layout'>,</span> <span class='hs-varid'>stk_arg_amodes</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>assignReturnRegs</span> <span class='hs-varid'>amodes</span>
<a name="line-338"></a>	
<a name="line-339"></a>		<span class='hs-comment'>-- separate the rest of the args into pointers and non-pointers</span>
<a name="line-340"></a>		<span class='hs-layout'>(</span><span class='hs-varid'>ptr_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>nptr_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>separateByPtrFollowness</span> <span class='hs-varid'>stk_arg_amodes</span>
<a name="line-341"></a>		<span class='hs-varid'>reg_arg_assts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>assignToRegs</span> <span class='hs-varid'>reg_arg_amodes</span>
<a name="line-342"></a>		
<a name="line-343"></a>	    <span class='hs-comment'>-- push ptrs, then nonptrs, on the stack</span>
<a name="line-344"></a>	<span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptr_sp</span><span class='hs-layout'>,</span>   <span class='hs-varid'>ptr_assts</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkStkAmodes</span> <span class='hs-varid'>sp</span> <span class='hs-varid'>ptr_args</span>
<a name="line-345"></a>	<span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>final_sp</span><span class='hs-layout'>,</span> <span class='hs-varid'>nptr_assts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkStkAmodes</span> <span class='hs-varid'>ptr_sp</span> <span class='hs-varid'>nptr_args</span>
<a name="line-346"></a>
<a name="line-347"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>returnFC</span> <span class='hs-layout'>(</span><span class='hs-varid'>final_sp</span><span class='hs-layout'>,</span>
<a name="line-348"></a>	  	    <span class='hs-varid'>reg_arg_assts</span> <span class='hs-varop'>`plusStmts`</span> 
<a name="line-349"></a>		    <span class='hs-varid'>ptr_assts</span> <span class='hs-varop'>`plusStmts`</span> <span class='hs-varid'>nptr_assts</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-350"></a>    
<a name="line-351"></a>		  
<a name="line-352"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-353"></a><span class='hs-comment'>-- Returning unboxed tuples.  This is mainly to support _ccall_GC_, where</span>
<a name="line-354"></a><span class='hs-comment'>-- we want to do things in a slightly different order to normal:</span>
<a name="line-355"></a><span class='hs-comment'>-- </span>
<a name="line-356"></a><span class='hs-comment'>-- 		- push return address</span>
<a name="line-357"></a><span class='hs-comment'>-- 		- adjust stack pointer</span>
<a name="line-358"></a><span class='hs-comment'>-- 		- r = call(args...)</span>
<a name="line-359"></a><span class='hs-comment'>-- 		- assign regs for unboxed tuple (usually just R1 = r)</span>
<a name="line-360"></a><span class='hs-comment'>-- 		- return to continuation</span>
<a name="line-361"></a><span class='hs-comment'>-- </span>
<a name="line-362"></a><span class='hs-comment'>-- The return address (i.e. stack frame) must be on the stack before</span>
<a name="line-363"></a><span class='hs-comment'>-- doing the call in case the call ends up in the garbage collector.</span>
<a name="line-364"></a><span class='hs-comment'>-- </span>
<a name="line-365"></a><span class='hs-comment'>-- Sadly, the information about the continuation is lost after we push it</span>
<a name="line-366"></a><span class='hs-comment'>-- (in order to avoid pushing it again), so we end up doing a needless</span>
<a name="line-367"></a><span class='hs-comment'>-- indirect jump (ToDo).</span>
<a name="line-368"></a>
<a name="line-369"></a><a name="ccallReturnUnboxedTuple"></a><span class='hs-definition'>ccallReturnUnboxedTuple</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>CgRep</span><span class='hs-layout'>,</span> <span class='hs-conid'>CmmExpr</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-370"></a><span class='hs-definition'>ccallReturnUnboxedTuple</span> <span class='hs-varid'>amodes</span> <span class='hs-varid'>before_jump</span>
<a name="line-371"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 	<span class='hs-layout'>{</span> <span class='hs-varid'>eob</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>EndOfBlockInfo</span> <span class='hs-varid'>args_sp</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getEndOfBlockInfo</span>
<a name="line-372"></a>
<a name="line-373"></a>	<span class='hs-comment'>-- Push a return address if necessary</span>
<a name="line-374"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>pushReturnAddress</span> <span class='hs-varid'>eob</span>
<a name="line-375"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>setEndOfBlockInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>EndOfBlockInfo</span> <span class='hs-varid'>args_sp</span> <span class='hs-conid'>OnStack</span><span class='hs-layout'>)</span>
<a name="line-376"></a>	    <span class='hs-layout'>(</span><span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>adjustSpAndHp</span> <span class='hs-varid'>args_sp</span>
<a name="line-377"></a>		<span class='hs-layout'>;</span> <span class='hs-varid'>before_jump</span>
<a name="line-378"></a>  		<span class='hs-layout'>;</span> <span class='hs-varid'>returnUnboxedTuple</span> <span class='hs-varid'>amodes</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-379"></a>    <span class='hs-layout'>}</span>
<a name="line-380"></a>
<a name="line-381"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-382"></a><span class='hs-comment'>-- Calling an out-of-line primop</span>
<a name="line-383"></a>
<a name="line-384"></a><a name="tailCallPrimOp"></a><span class='hs-definition'>tailCallPrimOp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimOp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StgArg</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-385"></a><span class='hs-definition'>tailCallPrimOp</span> <span class='hs-varid'>op</span>
<a name="line-386"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tailCallPrim</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkRtsPrimOpLabel</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span>
<a name="line-387"></a>
<a name="line-388"></a><a name="tailCallPrimCall"></a><span class='hs-definition'>tailCallPrimCall</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimCall</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StgArg</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-389"></a><span class='hs-definition'>tailCallPrimCall</span> <span class='hs-varid'>primcall</span>
<a name="line-390"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tailCallPrim</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPrimCallLabel</span> <span class='hs-varid'>primcall</span><span class='hs-layout'>)</span>
<a name="line-391"></a>
<a name="line-392"></a><a name="tailCallPrim"></a><span class='hs-definition'>tailCallPrim</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CLabel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StgArg</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-393"></a><span class='hs-definition'>tailCallPrim</span> <span class='hs-varid'>lbl</span> <span class='hs-varid'>args</span>
<a name="line-394"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span>	<span class='hs-comment'>-- We're going to perform a normal-looking tail call, </span>
<a name="line-395"></a>		<span class='hs-comment'>-- except that *all* the arguments will be in registers.</span>
<a name="line-396"></a>		<span class='hs-comment'>-- Hence the ASSERT( null leftovers )</span>
<a name="line-397"></a>	  <span class='hs-varid'>arg_amodes</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getArgAmodes</span> <span class='hs-varid'>args</span>
<a name="line-398"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_regs</span><span class='hs-layout'>,</span> <span class='hs-varid'>leftovers</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>assignPrimOpCallRegs</span> <span class='hs-varid'>arg_amodes</span>
<a name="line-399"></a>	      <span class='hs-varid'>jump_to_primop</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>jumpToLbl</span> <span class='hs-varid'>lbl</span>
<a name="line-400"></a>
<a name="line-401"></a>	<span class='hs-layout'>;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>leftovers</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- no stack-resident args</span>
<a name="line-402"></a> 	  <span class='hs-varid'>emitSimultaneously</span> <span class='hs-layout'>(</span><span class='hs-varid'>assignToRegs</span> <span class='hs-varid'>arg_regs</span><span class='hs-layout'>)</span>
<a name="line-403"></a>
<a name="line-404"></a>	<span class='hs-layout'>;</span> <span class='hs-conid'>EndOfBlockInfo</span> <span class='hs-varid'>args_sp</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getEndOfBlockInfo</span>
<a name="line-405"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>doFinalJump</span> <span class='hs-varid'>args_sp</span> <span class='hs-conid'>False</span><span class='hs-comment'>{-not a LNE-}</span> <span class='hs-varid'>jump_to_primop</span> <span class='hs-layout'>}</span>
<a name="line-406"></a>
<a name="line-407"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-408"></a><span class='hs-comment'>-- Return Addresses</span>
<a name="line-409"></a>
<a name="line-410"></a><span class='hs-comment'>-- We always push the return address just before performing a tail call</span>
<a name="line-411"></a><span class='hs-comment'>-- or return.  The reason we leave it until then is because the stack</span>
<a name="line-412"></a><span class='hs-comment'>-- slot that the return address is to go into might contain something</span>
<a name="line-413"></a><span class='hs-comment'>-- useful.</span>
<a name="line-414"></a><span class='hs-comment'>-- </span>
<a name="line-415"></a><span class='hs-comment'>-- If the end of block info is 'CaseAlts', then we're in the scrutinee of a</span>
<a name="line-416"></a><span class='hs-comment'>-- case expression and the return address is still to be pushed.</span>
<a name="line-417"></a><span class='hs-comment'>-- </span>
<a name="line-418"></a><span class='hs-comment'>-- There are cases where it doesn't look necessary to push the return</span>
<a name="line-419"></a><span class='hs-comment'>-- address: for example, just before doing a return to a known</span>
<a name="line-420"></a><span class='hs-comment'>-- continuation.  However, the continuation will expect to find the</span>
<a name="line-421"></a><span class='hs-comment'>-- return address on the stack in case it needs to do a heap check.</span>
<a name="line-422"></a>
<a name="line-423"></a><a name="pushReturnAddress"></a><span class='hs-definition'>pushReturnAddress</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EndOfBlockInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-424"></a>
<a name="line-425"></a><span class='hs-definition'>pushReturnAddress</span> <span class='hs-layout'>(</span><span class='hs-conid'>EndOfBlockInfo</span> <span class='hs-varid'>args_sp</span> <span class='hs-layout'>(</span><span class='hs-conid'>CaseAlts</span> <span class='hs-varid'>lbl</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-426"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>sp_rel</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSpRelOffset</span> <span class='hs-varid'>args_sp</span>
<a name="line-427"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>stmtC</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmStore</span> <span class='hs-varid'>sp_rel</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLblExpr</span> <span class='hs-varid'>lbl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-428"></a>
<a name="line-429"></a><span class='hs-definition'>pushReturnAddress</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nopC</span>
<a name="line-430"></a>
<a name="line-431"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-432"></a><span class='hs-comment'>-- Misc.</span>
<a name="line-433"></a>
<a name="line-434"></a><a name="jumpToLbl"></a><span class='hs-definition'>jumpToLbl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CLabel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-435"></a><span class='hs-comment'>-- Passes no argument to the destination procedure</span>
<a name="line-436"></a><span class='hs-definition'>jumpToLbl</span> <span class='hs-varid'>lbl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stmtC</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmJump</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLabel</span> <span class='hs-varid'>lbl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-comment'>{- No args -}</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-437"></a>
<a name="line-438"></a><a name="assignToRegs"></a><span class='hs-definition'>assignToRegs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>CmmExpr</span><span class='hs-layout'>,</span> <span class='hs-conid'>GlobalReg</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmStmts</span>
<a name="line-439"></a><span class='hs-definition'>assignToRegs</span> <span class='hs-varid'>reg_args</span> 
<a name="line-440"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkStmts</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>CmmAssign</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmGlobal</span> <span class='hs-varid'>reg_id</span><span class='hs-layout'>)</span> <span class='hs-varid'>expr</span>
<a name="line-441"></a>	    <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>expr</span><span class='hs-layout'>,</span> <span class='hs-varid'>reg_id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reg_args</span> <span class='hs-keyglyph'>]</span> 
</pre>\end{code}


%************************************************************************
%*									*
\subsection[CgStackery-adjust]{Adjusting the stack pointers}
%*									*
%************************************************************************

This function adjusts the stack and heap pointers just before a tail
call or return.  The stack pointer is adjusted to its final position
(i.e. to point to the last argument for a tail call, or the activation
record for a return).  The heap pointer may be moved backwards, in
cases where we overallocated at the beginning of the basic block (see
CgCase.lhs for discussion).

These functions {\em do not} deal with high-water-mark adjustment.
That's done by functions which allocate stack space.

\begin{code}
<pre><a name="line-1"></a><a name="adjustSpAndHp"></a><span class='hs-definition'>adjustSpAndHp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>VirtualSpOffset</span> 	<span class='hs-comment'>-- New offset for Arg stack ptr</span>
<a name="line-2"></a>	      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-3"></a><span class='hs-definition'>adjustSpAndHp</span> <span class='hs-varid'>newRealSp</span> 
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-comment'>-- Adjust stack, if necessary.</span>
<a name="line-5"></a>	  <span class='hs-comment'>-- NB: the conditional on the monad-carried realSp</span>
<a name="line-6"></a>	  <span class='hs-comment'>--     is out of line (via codeOnly), to avoid a black hole</span>
<a name="line-7"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>new_sp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSpRelOffset</span> <span class='hs-varid'>newRealSp</span>
<a name="line-8"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>checkedAbsC</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmAssign</span> <span class='hs-varid'>spReg</span> <span class='hs-varid'>new_sp</span><span class='hs-layout'>)</span>	<span class='hs-comment'>-- Will generate no code in the case</span>
<a name="line-9"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>setRealSp</span> <span class='hs-varid'>newRealSp</span>			<span class='hs-comment'>-- where realSp==newRealSp</span>
<a name="line-10"></a>
<a name="line-11"></a>	  <span class='hs-comment'>-- Adjust heap.  The virtual heap pointer may be less than the real Hp</span>
<a name="line-12"></a>	  <span class='hs-comment'>-- because the latter was advanced to deal with the worst-case branch</span>
<a name="line-13"></a>	  <span class='hs-comment'>-- of the code, and we may be in a better-case branch.  In that case,</span>
<a name="line-14"></a> 	  <span class='hs-comment'>-- move the real Hp *back* and retract some ticky allocation count.</span>
<a name="line-15"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>hp_usg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHpUsage</span>
<a name="line-16"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>rHp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>realHp</span> <span class='hs-varid'>hp_usg</span>
<a name="line-17"></a>	      <span class='hs-varid'>vHp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>virtHp</span> <span class='hs-varid'>hp_usg</span>
<a name="line-18"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>new_hp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHpRelOffset</span> <span class='hs-varid'>vHp</span>
<a name="line-19"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>checkedAbsC</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmAssign</span> <span class='hs-varid'>hpReg</span> <span class='hs-varid'>new_hp</span><span class='hs-layout'>)</span>	<span class='hs-comment'>-- Generates nothing when vHp==rHp</span>
<a name="line-20"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>tickyAllocHeap</span> <span class='hs-layout'>(</span><span class='hs-varid'>vHp</span> <span class='hs-comment'>-</span> <span class='hs-varid'>rHp</span><span class='hs-layout'>)</span>		<span class='hs-comment'>-- ...ditto</span>
<a name="line-21"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>setRealHp</span> <span class='hs-varid'>vHp</span>
<a name="line-22"></a>	<span class='hs-layout'>}</span>
</pre>\end{code}

</body>
</html>
