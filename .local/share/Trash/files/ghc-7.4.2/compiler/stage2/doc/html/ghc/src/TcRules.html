<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>typecheck/TcRules.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The AQUA Project, Glasgow University, 1993-1998
%

TcRules: Typechecking transformation rules

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcRules</span> <span class='hs-layout'>(</span> <span class='hs-varid'>tcRules</span> <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>
<a name="line-11"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-12"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcSimplify</span>
<a name="line-13"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcMType</span>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcHsType</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcExpr</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEnv</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span><span class='hs-layout'>(</span> <span class='hs-varid'>partition</span> <span class='hs-layout'>)</span>
</pre>\end{code}

Note [Typechecking rules]
~~~~~~~~~~~~~~~~~~~~~~~~~
We *infer* the typ of the LHS, and use that type to *check* the type of 
the RHS.  That means that higher-rank rules work reasonably well. Here's
an example (test simplCore/should_compile/rule2.hs) produced by Roman:

   foo :: (forall m. m a -> m b) -> m a -> m b
   foo f = ...

   bar :: (forall m. m a -> m a) -> m a -> m a
   bar f = ...

   {-# RULES "foo/bar" foo = bar #-}

He wanted the rule to typecheck.

\begin{code}
<pre><a name="line-1"></a><a name="tcRules"></a><span class='hs-definition'>tcRules</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LRuleDecl</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LRuleDecl</span> <span class='hs-conid'>TcId</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-definition'>tcRules</span> <span class='hs-varid'>decls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapLocM</span> <span class='hs-varid'>tcRule</span><span class='hs-layout'>)</span> <span class='hs-varid'>decls</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="tcRule"></a><span class='hs-definition'>tcRule</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RuleDecl</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>RuleDecl</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>)</span>
<a name="line-5"></a><span class='hs-definition'>tcRule</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRule</span> <span class='hs-varid'>name</span> <span class='hs-varid'>act</span> <span class='hs-varid'>hs_bndrs</span> <span class='hs-varid'>lhs</span> <span class='hs-varid'>fv_lhs</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>fv_rhs</span><span class='hs-layout'>)</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>ruleCtxt</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>	<span class='hs-varop'>$</span>
<a name="line-7"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"---- Rule ------"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-8"></a>
<a name="line-9"></a>    	<span class='hs-comment'>-- Note [Typechecking rules]</span>
<a name="line-10"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>vars</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcRuleBndrs</span> <span class='hs-varid'>hs_bndrs</span>
<a name="line-11"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>id_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv_bndrs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>vars</span>
<a name="line-12"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>lhs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>lhs_lie</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_lie</span><span class='hs-layout'>,</span> <span class='hs-sel'>_rule_ty</span><span class='hs-layout'>)</span>
<a name="line-13"></a>            <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExtendTyVarEnv</span> <span class='hs-varid'>tv_bndrs</span> <span class='hs-varop'>$</span>
<a name="line-14"></a>               <span class='hs-varid'>tcExtendIdEnv</span> <span class='hs-varid'>id_bndrs</span> <span class='hs-varop'>$</span>
<a name="line-15"></a>               <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>lhs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rule_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>lhs_lie</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>captureConstraints</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcInferRho</span> <span class='hs-varid'>lhs</span><span class='hs-layout'>)</span>
<a name="line-16"></a>                  <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>rhs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_lie</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>captureConstraints</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcMonoExpr</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>rule_ty</span><span class='hs-layout'>)</span>
<a name="line-17"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>lhs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>lhs_lie</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_lie</span><span class='hs-layout'>,</span> <span class='hs-varid'>rule_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-18"></a>
<a name="line-19"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>lhs_dicts</span><span class='hs-layout'>,</span> <span class='hs-varid'>lhs_ev_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_ev_binds</span><span class='hs-layout'>)</span> 
<a name="line-20"></a>             <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>simplifyRule</span> <span class='hs-varid'>name</span> <span class='hs-varid'>tv_bndrs</span> <span class='hs-varid'>lhs_lie</span> <span class='hs-varid'>rhs_lie</span>
<a name="line-21"></a>
<a name="line-22"></a>	<span class='hs-comment'>-- IMPORTANT!  We *quantify* over any dicts that appear in the LHS</span>
<a name="line-23"></a>	<span class='hs-comment'>-- Reason: </span>
<a name="line-24"></a>	<span class='hs-comment'>--	(a) The particular dictionary isn't important, because its value</span>
<a name="line-25"></a>	<span class='hs-comment'>--	   depends only on the type</span>
<a name="line-26"></a>	<span class='hs-comment'>--		e.g	gcd Int $fIntegralInt</span>
<a name="line-27"></a>	<span class='hs-comment'>--         Here we'd like to match against (gcd Int any_d) for any 'any_d'</span>
<a name="line-28"></a>	<span class='hs-comment'>--</span>
<a name="line-29"></a>	<span class='hs-comment'>--	(b) We'd like to make available the dictionaries bound </span>
<a name="line-30"></a>	<span class='hs-comment'>--	    on the LHS in the RHS, so quantifying over them is good</span>
<a name="line-31"></a>	<span class='hs-comment'>--	    See the 'lhs_dicts' in tcSimplifyAndCheck for the RHS</span>
<a name="line-32"></a>
<a name="line-33"></a>	<span class='hs-comment'>-- We quantify over any tyvars free in *either* the rule</span>
<a name="line-34"></a>	<span class='hs-comment'>--  *or* the bound variables.  The latter is important.  Consider</span>
<a name="line-35"></a>	<span class='hs-comment'>--	ss (x,(y,z)) = (x,z)</span>
<a name="line-36"></a>	<span class='hs-comment'>--	RULE:  forall v. fst (ss v) = fst v</span>
<a name="line-37"></a>	<span class='hs-comment'>-- The type of the rhs of the rule is just a, but v::(a,(b,c))</span>
<a name="line-38"></a>	<span class='hs-comment'>--</span>
<a name="line-39"></a>	<span class='hs-comment'>-- We also need to get the free tyvars of the LHS; but we do that</span>
<a name="line-40"></a>	<span class='hs-comment'>-- during zonking (see TcHsSyn.zonkRule)</span>
<a name="line-41"></a>
<a name="line-42"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tpl_ids</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs_dicts</span> <span class='hs-varop'>++</span> <span class='hs-varid'>id_bndrs</span>
<a name="line-43"></a><span class='hs-comment'>{-
<a name="line-44"></a>             forall_tvs = tyVarsOfTypes (rule_ty : map idType tpl_ids)
<a name="line-45"></a>
<a name="line-46"></a>	     -- Now figure out what to quantify over
<a name="line-47"></a>	     -- c.f. TcSimplify.simplifyInfer
<a name="line-48"></a>       ; zonked_forall_tvs &lt;- zonkTcTyVarsAndFV forall_tvs
<a name="line-49"></a>       ; gbl_tvs           &lt;- tcGetGlobalTyVars	     -- Already zonked
<a name="line-50"></a>       ; let extra_bound_tvs = zonked_forall_tvs 	     
<a name="line-51"></a>       	     		       `minusVarSet` gbl_tvs
<a name="line-52"></a>       	     		       `delVarSetList` tv_bndrs
<a name="line-53"></a>       ; qtvs &lt;- zonkQuantifiedTyVars (varSetElems extra_bound_tvs)
<a name="line-54"></a>       ; let all_tvs = tv_bndrs ++ qtvs
<a name="line-55"></a>       ; (kvs, _kinds) &lt;- kindGeneralizeKinds $ map tyVarKind all_tvs
<a name="line-56"></a>-}</span>
<a name="line-57"></a>
<a name="line-58"></a>       	      <span class='hs-comment'>-- The tv_bndrs are already skolems, so no need to zonk them</span>
<a name="line-59"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRule</span> <span class='hs-varid'>name</span> <span class='hs-varid'>act</span>
<a name="line-60"></a>		    <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-conid'>RuleBndr</span> <span class='hs-varop'>.</span> <span class='hs-varid'>noLoc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv_bndrs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tpl_ids</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-61"></a>		    <span class='hs-layout'>(</span><span class='hs-varid'>mkHsDictLet</span> <span class='hs-varid'>lhs_ev_binds</span> <span class='hs-varid'>lhs'</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_lhs</span>
<a name="line-62"></a>		    <span class='hs-layout'>(</span><span class='hs-varid'>mkHsDictLet</span> <span class='hs-varid'>rhs_ev_binds</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_rhs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-63"></a>
<a name="line-64"></a><a name="tcRuleBndrs"></a><span class='hs-definition'>tcRuleBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>RuleBndr</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span>
<a name="line-65"></a><span class='hs-definition'>tcRuleBndrs</span> <span class='hs-conid'>[]</span> 
<a name="line-66"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>
<a name="line-67"></a><span class='hs-definition'>tcRuleBndrs</span> <span class='hs-layout'>(</span><span class='hs-conid'>RuleBndr</span> <span class='hs-varid'>var</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rule_bndrs</span><span class='hs-layout'>)</span>
<a name="line-68"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 	<span class='hs-layout'>{</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>openTypeKind</span>
<a name="line-69"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>vars</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcRuleBndrs</span> <span class='hs-varid'>rule_bndrs</span>
<a name="line-70"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLocalId</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span> <span class='hs-conop'>:</span> <span class='hs-varid'>vars</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-71"></a><span class='hs-definition'>tcRuleBndrs</span> <span class='hs-layout'>(</span><span class='hs-conid'>RuleBndrSig</span> <span class='hs-varid'>var</span> <span class='hs-varid'>rn_ty</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rule_bndrs</span><span class='hs-layout'>)</span>
<a name="line-72"></a><span class='hs-comment'>--  e.g 	x :: a-&gt;a</span>
<a name="line-73"></a><span class='hs-comment'>--  The tyvar 'a' is brought into scope first, just as if you'd written</span>
<a name="line-74"></a><span class='hs-comment'>--		a::*, x :: a-&gt;a</span>
<a name="line-75"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FunSigCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span>
<a name="line-76"></a>	<span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsPatSigType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>rn_ty</span>
<a name="line-77"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSuperSkolTyVars</span> <span class='hs-varid'>tyvars</span>
<a name="line-78"></a>	      <span class='hs-varid'>id_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTyWith</span> <span class='hs-varid'>tyvars</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>skol_tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-79"></a>	      <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLocalId</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span> <span class='hs-varid'>id_ty</span>
<a name="line-80"></a>
<a name="line-81"></a>	      <span class='hs-comment'>-- The type variables scope over subsequent bindings; yuk</span>
<a name="line-82"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>vars</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExtendTyVarEnv</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-varop'>$</span> 
<a name="line-83"></a>                  <span class='hs-varid'>tcRuleBndrs</span> <span class='hs-varid'>rule_bndrs</span> 
<a name="line-84"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>skol_tvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>id</span> <span class='hs-conop'>:</span> <span class='hs-varid'>vars</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-85"></a>
<a name="line-86"></a><a name="ruleCtxt"></a><span class='hs-definition'>ruleCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FastString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-87"></a><span class='hs-definition'>ruleCtxt</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"When checking the transformation rule"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> 
<a name="line-88"></a>		<span class='hs-varid'>doubleQuotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ftext</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
</pre>\end{code}
</body>
</html>
