<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>hsSyn/Convert.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%

This module converts Template Haskell syntax into HsSyn

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Convert</span><span class='hs-layout'>(</span> <span class='hs-varid'>convertToHsExpr</span><span class='hs-layout'>,</span> <span class='hs-varid'>convertToPat</span><span class='hs-layout'>,</span> <span class='hs-varid'>convertToHsDecls</span><span class='hs-layout'>,</span>
<a name="line-9"></a>                <span class='hs-varid'>convertToHsType</span><span class='hs-layout'>,</span>
<a name="line-10"></a>                <span class='hs-varid'>thRdrNameGuesses</span> <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Hs</span>
<a name="line-13"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Class</span>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RdrName</span>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Name</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RdrHsSyn</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>OccName</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OccName</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysWiredIn</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Hs</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ForeignCall</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unique</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MonadUtils</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ErrUtils</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-32"></a>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-layout'>(</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>)</span>
<a name="line-34"></a>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Language</span><span class='hs-varop'>.</span><span class='hs-conid'>Haskell</span><span class='hs-varop'>.</span><span class='hs-conid'>TH</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TH</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span><span class='hs-varid'>sigP</span><span class='hs-layout'>)</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Language</span><span class='hs-varop'>.</span><span class='hs-conid'>Haskell</span><span class='hs-varop'>.</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Syntax</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TH</span>
<a name="line-37"></a>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC</span><span class='hs-varop'>.</span><span class='hs-conid'>Exts</span>
<a name="line-39"></a>
<a name="line-40"></a><span class='hs-comment'>-------------------------------------------------------------------</span>
<a name="line-41"></a><span class='hs-comment'>--		The external interface</span>
<a name="line-42"></a>
<a name="line-43"></a><a name="convertToHsDecls"></a><span class='hs-definition'>convertToHsDecls</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Dec</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>Message</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-44"></a><span class='hs-definition'>convertToHsDecls</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>ds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initCvt</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapM</span> <span class='hs-varid'>cvt_dec</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>
<a name="line-45"></a>  <span class='hs-keyword'>where</span>
<a name="line-46"></a>    <span class='hs-varid'>cvt_dec</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapMsg</span> <span class='hs-str'>"declaration"</span> <span class='hs-varid'>d</span> <span class='hs-layout'>(</span><span class='hs-varid'>cvtDec</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span>
<a name="line-47"></a>
<a name="line-48"></a><a name="convertToHsExpr"></a><span class='hs-definition'>convertToHsExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Exp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>Message</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-49"></a><span class='hs-definition'>convertToHsExpr</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>e</span> 
<a name="line-50"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initCvt</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>wrapMsg</span> <span class='hs-str'>"expression"</span> <span class='hs-varid'>e</span> <span class='hs-varop'>$</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>e</span>
<a name="line-51"></a>
<a name="line-52"></a><a name="convertToPat"></a><span class='hs-definition'>convertToPat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Pat</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>Message</span> <span class='hs-layout'>(</span><span class='hs-conid'>LPat</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-53"></a><span class='hs-definition'>convertToPat</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>p</span>
<a name="line-54"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initCvt</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>wrapMsg</span> <span class='hs-str'>"pattern"</span> <span class='hs-varid'>p</span> <span class='hs-varop'>$</span> <span class='hs-varid'>cvtPat</span> <span class='hs-varid'>p</span>
<a name="line-55"></a>
<a name="line-56"></a><a name="convertToHsType"></a><span class='hs-definition'>convertToHsType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>Message</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-57"></a><span class='hs-definition'>convertToHsType</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>t</span>
<a name="line-58"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initCvt</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>wrapMsg</span> <span class='hs-str'>"type"</span> <span class='hs-varid'>t</span> <span class='hs-varop'>$</span> <span class='hs-varid'>cvtType</span> <span class='hs-varid'>t</span>
<a name="line-59"></a>
<a name="line-60"></a><a name="CvtM"></a><span class='hs-comment'>-------------------------------------------------------------------</span>
<a name="line-61"></a><a name="CvtM"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>CvtM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unCvtM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>Message</span> <span class='hs-varid'>a</span> <span class='hs-layout'>}</span>
<a name="line-62"></a>	<span class='hs-comment'>-- Push down the source location;</span>
<a name="line-63"></a>	<span class='hs-comment'>-- Can fail, with a single error message</span>
<a name="line-64"></a>
<a name="line-65"></a><span class='hs-comment'>-- NB: If the conversion succeeds with (Right x), there should </span>
<a name="line-66"></a><span class='hs-comment'>--     be no exception values hiding in x</span>
<a name="line-67"></a><span class='hs-comment'>-- Reason: so a (head []) in TH code doesn't subsequently</span>
<a name="line-68"></a><span class='hs-comment'>-- 	   make GHC crash when it tries to walk the generated tree</span>
<a name="line-69"></a>
<a name="line-70"></a><span class='hs-comment'>-- Use the loc everywhere, for lack of anything better</span>
<a name="line-71"></a><span class='hs-comment'>-- In particular, we want it on binding locations, so that variables bound in</span>
<a name="line-72"></a><span class='hs-comment'>-- the spliced-in declarations get a location that at least relates to the splice point</span>
<a name="line-73"></a>
<a name="line-74"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Monad</span> <span class='hs-conid'>CvtM</span> <span class='hs-keyword'>where</span>
<a name="line-75"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>x</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CvtM</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Right</span> <span class='hs-varid'>x</span>
<a name="line-76"></a>  <span class='hs-layout'>(</span><span class='hs-conid'>CvtM</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CvtM</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>loc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>m</span> <span class='hs-varid'>loc</span> <span class='hs-keyword'>of</span>
<a name="line-77"></a>				    <span class='hs-conid'>Left</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Left</span> <span class='hs-varid'>err</span>
<a name="line-78"></a>				    <span class='hs-conid'>Right</span> <span class='hs-varid'>v</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unCvtM</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>loc</span>
<a name="line-79"></a>
<a name="line-80"></a><a name="initCvt"></a><span class='hs-definition'>initCvt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>Message</span> <span class='hs-varid'>a</span>
<a name="line-81"></a><span class='hs-definition'>initCvt</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvtM</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m</span> <span class='hs-varid'>loc</span>
<a name="line-82"></a>
<a name="line-83"></a><a name="force"></a><span class='hs-definition'>force</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-conid'>()</span>
<a name="line-84"></a><span class='hs-definition'>force</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-85"></a>
<a name="line-86"></a><a name="failWith"></a><span class='hs-definition'>failWith</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Message</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-varid'>a</span>
<a name="line-87"></a><span class='hs-definition'>failWith</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Left</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-88"></a>
<a name="line-89"></a><a name="getL"></a><span class='hs-definition'>getL</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvtM</span> <span class='hs-conid'>SrcSpan</span>
<a name="line-90"></a><span class='hs-definition'>getL</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>loc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Right</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-91"></a>
<a name="line-92"></a><a name="returnL"></a><span class='hs-definition'>returnL</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-93"></a><span class='hs-definition'>returnL</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>loc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Right</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-94"></a>
<a name="line-95"></a><a name="wrapParL"></a><span class='hs-definition'>wrapParL</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-varid'>a</span>
<a name="line-96"></a><span class='hs-definition'>wrapParL</span> <span class='hs-varid'>add_par</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>loc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Right</span> <span class='hs-layout'>(</span><span class='hs-varid'>add_par</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-97"></a>
<a name="line-98"></a><a name="wrapMsg"></a><span class='hs-definition'>wrapMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Show</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Ppr</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-varid'>b</span>
<a name="line-99"></a><span class='hs-comment'>-- E.g  wrapMsg "declaration" dec thing</span>
<a name="line-100"></a><span class='hs-definition'>wrapMsg</span> <span class='hs-varid'>what</span> <span class='hs-varid'>item</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvtM</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-101"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>loc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>m</span> <span class='hs-varid'>loc</span> <span class='hs-keyword'>of</span>
<a name="line-102"></a>                     <span class='hs-conid'>Left</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Left</span> <span class='hs-layout'>(</span><span class='hs-varid'>err</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>getPprStyle</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span>
<a name="line-103"></a>                     <span class='hs-conid'>Right</span> <span class='hs-varid'>v</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Right</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-104"></a>  <span class='hs-keyword'>where</span>
<a name="line-105"></a>	<span class='hs-comment'>-- Show the item in pretty syntax normally, </span>
<a name="line-106"></a>	<span class='hs-comment'>-- but with all its constructors if you say -dppr-debug</span>
<a name="line-107"></a>    <span class='hs-varid'>msg</span> <span class='hs-varid'>sty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"When splicing a TH"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-varid'>what</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span><span class='hs-layout'>)</span>
<a name="line-108"></a>                 <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>debugStyle</span> <span class='hs-varid'>sty</span> 
<a name="line-109"></a>                    <span class='hs-keyword'>then</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>item</span><span class='hs-layout'>)</span>
<a name="line-110"></a>                    <span class='hs-keyword'>else</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprint</span> <span class='hs-varid'>item</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-111"></a>
<a name="line-112"></a><a name="wrapL"></a><span class='hs-definition'>wrapL</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvtM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-113"></a><span class='hs-definition'>wrapL</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvtM</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>loc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>m</span> <span class='hs-varid'>loc</span> <span class='hs-keyword'>of</span>
<a name="line-114"></a>			  <span class='hs-conid'>Left</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Left</span> <span class='hs-varid'>err</span>
<a name="line-115"></a>			  <span class='hs-conid'>Right</span> <span class='hs-varid'>v</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Right</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-116"></a>
<a name="line-117"></a><a name="cvtDec"></a><span class='hs-comment'>-------------------------------------------------------------------</span>
<a name="line-118"></a><span class='hs-definition'>cvtDec</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Dec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-119"></a><span class='hs-definition'>cvtDec</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ValD</span> <span class='hs-varid'>pat</span> <span class='hs-varid'>body</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span> 
<a name="line-120"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>VarP</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>pat</span>
<a name="line-121"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>s'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>vNameL</span> <span class='hs-varid'>s</span>
<a name="line-122"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>cl'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtClause</span> <span class='hs-layout'>(</span><span class='hs-conid'>Clause</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>body</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>
<a name="line-123"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>returnL</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Hs</span><span class='hs-varop'>.</span><span class='hs-conid'>ValD</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkFunBind</span> <span class='hs-varid'>s'</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>cl'</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-124"></a>
<a name="line-125"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-126"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>pat'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtPat</span> <span class='hs-varid'>pat</span>
<a name="line-127"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>body'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtGuard</span> <span class='hs-varid'>body</span>
<a name="line-128"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>ds'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtLocalDecs</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a where clause"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds</span>
<a name="line-129"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>returnL</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Hs</span><span class='hs-varop'>.</span><span class='hs-conid'>ValD</span> <span class='hs-varop'>$</span>
<a name="line-130"></a>          <span class='hs-conid'>PatBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pat_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pat'</span><span class='hs-layout'>,</span> <span class='hs-varid'>pat_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GRHSs</span> <span class='hs-varid'>body'</span> <span class='hs-varid'>ds'</span> 
<a name="line-131"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>pat_rhs_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>void</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind_fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>placeHolderNames</span>
<a name="line-132"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>pat_ticks</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-133"></a>
<a name="line-134"></a><span class='hs-definition'>cvtDec</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>FunD</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span>   
<a name="line-135"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>cls</span>
<a name="line-136"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWith</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Function binding for"</span><span class='hs-layout'>)</span>
<a name="line-137"></a>    	     	    <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>pprint</span> <span class='hs-varid'>nm</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-138"></a>    	     	    <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"has no equations"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-139"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-140"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>nm'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>vNameL</span> <span class='hs-varid'>nm</span>
<a name="line-141"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>cls'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>cvtClause</span> <span class='hs-varid'>cls</span>
<a name="line-142"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>returnL</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Hs</span><span class='hs-varop'>.</span><span class='hs-conid'>ValD</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkFunBind</span> <span class='hs-varid'>nm'</span> <span class='hs-varid'>cls'</span> <span class='hs-layout'>}</span>
<a name="line-143"></a>
<a name="line-144"></a><span class='hs-definition'>cvtDec</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>SigD</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>typ</span><span class='hs-layout'>)</span>  
<a name="line-145"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>nm'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>vNameL</span> <span class='hs-varid'>nm</span>
<a name="line-146"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtType</span> <span class='hs-varid'>typ</span>
<a name="line-147"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>returnL</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Hs</span><span class='hs-varop'>.</span><span class='hs-conid'>SigD</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeSig</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>nm'</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-148"></a>
<a name="line-149"></a><span class='hs-definition'>cvtDec</span> <span class='hs-layout'>(</span><span class='hs-conid'>PragmaD</span> <span class='hs-varid'>prag</span><span class='hs-layout'>)</span>
<a name="line-150"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>prag'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtPragmaD</span> <span class='hs-varid'>prag</span>
<a name="line-151"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>returnL</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Hs</span><span class='hs-varop'>.</span><span class='hs-conid'>SigD</span> <span class='hs-varid'>prag'</span> <span class='hs-layout'>}</span>
<a name="line-152"></a>
<a name="line-153"></a><span class='hs-definition'>cvtDec</span> <span class='hs-layout'>(</span><span class='hs-conid'>TySynD</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-154"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvt_tycl_hdr</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tvs</span>
<a name="line-155"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>rhs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtType</span> <span class='hs-varid'>rhs</span>
<a name="line-156"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>returnL</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TyClD</span> <span class='hs-layout'>(</span><span class='hs-conid'>TySynonym</span> <span class='hs-varid'>tc'</span> <span class='hs-varid'>tvs'</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-157"></a>
<a name="line-158"></a><span class='hs-definition'>cvtDec</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataD</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>constrs</span> <span class='hs-varid'>derivs</span><span class='hs-layout'>)</span>
<a name="line-159"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvt_tycl_hdr</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tvs</span>
<a name="line-160"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>cons'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>cvtConstr</span> <span class='hs-varid'>constrs</span>
<a name="line-161"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>derivs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtDerivs</span> <span class='hs-varid'>derivs</span>
<a name="line-162"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>returnL</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TyClD</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyData</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcdND</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DataType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdLName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdCtxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt'</span>
<a name="line-163"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>tcdTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdTyPats</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdKindSig</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-164"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>tcdCons</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cons'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdDerivs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>derivs'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-165"></a>
<a name="line-166"></a><span class='hs-definition'>cvtDec</span> <span class='hs-layout'>(</span><span class='hs-conid'>NewtypeD</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>constr</span> <span class='hs-varid'>derivs</span><span class='hs-layout'>)</span>
<a name="line-167"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvt_tycl_hdr</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tvs</span>
<a name="line-168"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>con'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtConstr</span> <span class='hs-varid'>constr</span>
<a name="line-169"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>derivs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtDerivs</span> <span class='hs-varid'>derivs</span>
<a name="line-170"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>returnL</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TyClD</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyData</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcdND</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NewType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdLName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdCtxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt'</span>
<a name="line-171"></a>	  	    	  	  <span class='hs-layout'>,</span> <span class='hs-varid'>tcdTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdTyPats</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdKindSig</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-172"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>tcdCons</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>con'</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdDerivs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>derivs'</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-173"></a>
<a name="line-174"></a><span class='hs-definition'>cvtDec</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClassD</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>cl</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>fds</span> <span class='hs-varid'>decs</span><span class='hs-layout'>)</span>
<a name="line-175"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>cxt'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvt_tycl_hdr</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>cl</span> <span class='hs-varid'>tvs</span>
<a name="line-176"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>fds'</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>cvt_fundep</span> <span class='hs-varid'>fds</span>
<a name="line-177"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>binds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>sigs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ats'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvt_ci_decs</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a class declaration"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>decs</span>
<a name="line-178"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>returnL</span> <span class='hs-varop'>$</span> 
<a name="line-179"></a>            <span class='hs-conid'>TyClD</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ClassDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcdCtxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cxt'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdLName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs'</span>
<a name="line-180"></a>	    	              <span class='hs-layout'>,</span> <span class='hs-varid'>tcdFDs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdSigs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sigs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdMeths</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binds'</span>
<a name="line-181"></a>			      <span class='hs-layout'>,</span> <span class='hs-varid'>tcdATs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ats'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdATDefs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdDocs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>}</span>
<a name="line-182"></a>                                        <span class='hs-comment'>-- no docs in TH ^^</span>
<a name="line-183"></a>	<span class='hs-layout'>}</span>
<a name="line-184"></a>	
<a name="line-185"></a><span class='hs-definition'>cvtDec</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstanceD</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>decs</span><span class='hs-layout'>)</span>
<a name="line-186"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 	<span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>binds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>sigs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ats'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvt_ci_decs</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"an instance declaration"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>decs</span>
<a name="line-187"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>ctxt'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtContext</span> <span class='hs-varid'>ctxt</span>
<a name="line-188"></a>	<span class='hs-layout'>;</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtType</span> <span class='hs-varid'>ty</span>
<a name="line-189"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>inst_ty'</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkImplicitHsForAllTy</span> <span class='hs-varid'>ctxt'</span> <span class='hs-varop'>$</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>ty'</span>
<a name="line-190"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>returnL</span> <span class='hs-varop'>$</span> <span class='hs-conid'>InstD</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstDecl</span> <span class='hs-varid'>inst_ty'</span> <span class='hs-varid'>binds'</span> <span class='hs-varid'>sigs'</span> <span class='hs-varid'>ats'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-191"></a>
<a name="line-192"></a><span class='hs-definition'>cvtDec</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForeignD</span> <span class='hs-varid'>ford</span><span class='hs-layout'>)</span> 
<a name="line-193"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ford'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtForD</span> <span class='hs-varid'>ford</span>
<a name="line-194"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>returnL</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ForD</span> <span class='hs-varid'>ford'</span> <span class='hs-layout'>}</span>
<a name="line-195"></a>
<a name="line-196"></a><span class='hs-definition'>cvtDec</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamilyD</span> <span class='hs-varid'>flav</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-197"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvt_tycl_hdr</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tvs</span>
<a name="line-198"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kind'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtMaybeKind</span> <span class='hs-varid'>kind</span>
<a name="line-199"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>returnL</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TyClD</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyFamily</span> <span class='hs-layout'>(</span><span class='hs-varid'>cvtFamFlavour</span> <span class='hs-varid'>flav</span><span class='hs-layout'>)</span> <span class='hs-varid'>tc'</span> <span class='hs-varid'>tvs'</span> <span class='hs-varid'>kind'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-200"></a>  <span class='hs-keyword'>where</span>
<a name="line-201"></a>    <span class='hs-varid'>cvtFamFlavour</span> <span class='hs-conid'>TypeFam</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TypeFamily</span>
<a name="line-202"></a>    <span class='hs-varid'>cvtFamFlavour</span> <span class='hs-conid'>DataFam</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DataFamily</span>
<a name="line-203"></a>
<a name="line-204"></a><span class='hs-definition'>cvtDec</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataInstD</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>constrs</span> <span class='hs-varid'>derivs</span><span class='hs-layout'>)</span>
<a name="line-205"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>typats'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvt_tyinst_hdr</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-206"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>cons'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>cvtConstr</span> <span class='hs-varid'>constrs</span>
<a name="line-207"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>derivs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtDerivs</span> <span class='hs-varid'>derivs</span>
<a name="line-208"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>returnL</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TyClD</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyData</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcdND</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DataType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdLName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdCtxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt'</span>
<a name="line-209"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>tcdTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdTyPats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typats'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdKindSig</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-210"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>tcdCons</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cons'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdDerivs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>derivs'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-211"></a>
<a name="line-212"></a><span class='hs-definition'>cvtDec</span> <span class='hs-layout'>(</span><span class='hs-conid'>NewtypeInstD</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>constr</span> <span class='hs-varid'>derivs</span><span class='hs-layout'>)</span>
<a name="line-213"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>typats'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvt_tyinst_hdr</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-214"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>con'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtConstr</span> <span class='hs-varid'>constr</span>
<a name="line-215"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>derivs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtDerivs</span> <span class='hs-varid'>derivs</span>
<a name="line-216"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>returnL</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TyClD</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyData</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcdND</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NewType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdLName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdCtxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt'</span>
<a name="line-217"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>tcdTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdTyPats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typats'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdKindSig</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-218"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>tcdCons</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>con'</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdDerivs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>derivs'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-219"></a>       <span class='hs-layout'>}</span>
<a name="line-220"></a>
<a name="line-221"></a><span class='hs-definition'>cvtDec</span> <span class='hs-layout'>(</span><span class='hs-conid'>TySynInstD</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-222"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvt_tyinst_hdr</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-223"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>rhs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtType</span> <span class='hs-varid'>rhs</span>
<a name="line-224"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>returnL</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TyClD</span> <span class='hs-layout'>(</span><span class='hs-conid'>TySynonym</span> <span class='hs-varid'>tc'</span> <span class='hs-varid'>tvs'</span> <span class='hs-varid'>tys'</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-225"></a>
<a name="line-226"></a><a name="cvt_ci_decs"></a><span class='hs-comment'>----------------</span>
<a name="line-227"></a><span class='hs-definition'>cvt_ci_decs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Message</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Dec</span><span class='hs-keyglyph'>]</span>
<a name="line-228"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>,</span> 
<a name="line-229"></a>                     <span class='hs-keyglyph'>[</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> 
<a name="line-230"></a>                     <span class='hs-keyglyph'>[</span><span class='hs-conid'>LTyClDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-231"></a><span class='hs-comment'>-- Convert the declarations inside a class or instance decl</span>
<a name="line-232"></a><span class='hs-comment'>-- ie signatures, bindings, and associated types</span>
<a name="line-233"></a><span class='hs-definition'>cvt_ci_decs</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>decs</span>
<a name="line-234"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>decs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>cvtDec</span> <span class='hs-varid'>decs</span>
<a name="line-235"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>ats'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind_sig_decs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionWith</span> <span class='hs-varid'>is_tycl</span> <span class='hs-varid'>decs'</span>
<a name="line-236"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>sigs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>prob_binds'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionWith</span> <span class='hs-varid'>is_sig</span> <span class='hs-varid'>bind_sig_decs'</span>
<a name="line-237"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>binds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bads</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionWith</span> <span class='hs-varid'>is_bind</span> <span class='hs-varid'>prob_binds'</span>
<a name="line-238"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>bads</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>failWith</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkBadDecMsg</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>bads</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-239"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>listToBag</span> <span class='hs-varid'>binds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>sigs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ats'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-240"></a>
<a name="line-241"></a><a name="cvt_tycl_hdr"></a><span class='hs-comment'>----------------</span>
<a name="line-242"></a><span class='hs-definition'>cvt_tycl_hdr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Cxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TyVarBndr</span><span class='hs-keyglyph'>]</span>
<a name="line-243"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span> <span class='hs-conid'>LHsContext</span> <span class='hs-conid'>RdrName</span>
<a name="line-244"></a>                     <span class='hs-layout'>,</span> <span class='hs-conid'>Located</span> <span class='hs-conid'>RdrName</span>
<a name="line-245"></a>                     <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-246"></a><span class='hs-definition'>cvt_tycl_hdr</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tvs</span>
<a name="line-247"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cxt'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtContext</span> <span class='hs-varid'>cxt</span>
<a name="line-248"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tc'</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tconNameL</span> <span class='hs-varid'>tc</span>
<a name="line-249"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tvs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtTvs</span> <span class='hs-varid'>tvs</span>
<a name="line-250"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>cxt'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>)</span> 
<a name="line-251"></a>       <span class='hs-layout'>}</span>
<a name="line-252"></a>
<a name="line-253"></a><a name="cvt_tyinst_hdr"></a><span class='hs-definition'>cvt_tyinst_hdr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Cxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-254"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span> <span class='hs-conid'>LHsContext</span> <span class='hs-conid'>RdrName</span>
<a name="line-255"></a>                       <span class='hs-layout'>,</span> <span class='hs-conid'>Located</span> <span class='hs-conid'>RdrName</span>
<a name="line-256"></a>                       <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-257"></a>                       <span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-258"></a><span class='hs-definition'>cvt_tyinst_hdr</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-259"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cxt'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtContext</span> <span class='hs-varid'>cxt</span>
<a name="line-260"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tc'</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tconNameL</span> <span class='hs-varid'>tc</span>
<a name="line-261"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tvs</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>concatMapM</span> <span class='hs-varid'>collect</span> <span class='hs-varid'>tys</span>
<a name="line-262"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tvs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtTvs</span> <span class='hs-varid'>tvs</span>
<a name="line-263"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>cvtType</span> <span class='hs-varid'>tys</span>
<a name="line-264"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>cxt'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span> 
<a name="line-265"></a>       <span class='hs-layout'>}</span>
<a name="line-266"></a>  <span class='hs-keyword'>where</span>
<a name="line-267"></a>    <span class='hs-varid'>collect</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForallT</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> 
<a name="line-268"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWith</span> <span class='hs-varop'>$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Forall type not allowed as type parameter"</span>
<a name="line-269"></a>    <span class='hs-varid'>collect</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarT</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PlainTV</span> <span class='hs-varid'>tv</span><span class='hs-keyglyph'>]</span>
<a name="line-270"></a>    <span class='hs-varid'>collect</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConT</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>
<a name="line-271"></a>    <span class='hs-varid'>collect</span> <span class='hs-layout'>(</span><span class='hs-conid'>TupleT</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>
<a name="line-272"></a>    <span class='hs-varid'>collect</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnboxedTupleT</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>
<a name="line-273"></a>    <span class='hs-varid'>collect</span> <span class='hs-conid'>ArrowT</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>
<a name="line-274"></a>    <span class='hs-varid'>collect</span> <span class='hs-conid'>ListT</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>
<a name="line-275"></a>    <span class='hs-varid'>collect</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppT</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-276"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tvs1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>collect</span> <span class='hs-varid'>t1</span>
<a name="line-277"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>tvs2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>collect</span> <span class='hs-varid'>t2</span>
<a name="line-278"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tvs1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tvs2</span>
<a name="line-279"></a>           <span class='hs-layout'>}</span>
<a name="line-280"></a>    <span class='hs-varid'>collect</span> <span class='hs-layout'>(</span><span class='hs-conid'>SigT</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarT</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>ki</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>KindedTV</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ki</span><span class='hs-keyglyph'>]</span>
<a name="line-281"></a>    <span class='hs-varid'>collect</span> <span class='hs-layout'>(</span><span class='hs-conid'>SigT</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collect</span> <span class='hs-varid'>ty</span>
<a name="line-282"></a>
<a name="line-283"></a><span class='hs-comment'>-------------------------------------------------------------------</span>
<a name="line-284"></a><span class='hs-comment'>--		Partitioning declarations</span>
<a name="line-285"></a><span class='hs-comment'>-------------------------------------------------------------------</span>
<a name="line-286"></a>
<a name="line-287"></a><a name="is_tycl"></a><span class='hs-definition'>is_tycl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-layout'>(</span><span class='hs-conid'>LTyClDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-288"></a><span class='hs-definition'>is_tycl</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Hs</span><span class='hs-varop'>.</span><span class='hs-conid'>TyClD</span> <span class='hs-varid'>tcd</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Left</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>tcd</span><span class='hs-layout'>)</span>
<a name="line-289"></a><span class='hs-definition'>is_tycl</span> <span class='hs-varid'>decl</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Right</span> <span class='hs-varid'>decl</span>
<a name="line-290"></a>
<a name="line-291"></a><a name="is_sig"></a><span class='hs-definition'>is_sig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-layout'>(</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-292"></a><span class='hs-definition'>is_sig</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Hs</span><span class='hs-varop'>.</span><span class='hs-conid'>SigD</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Left</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span>
<a name="line-293"></a><span class='hs-definition'>is_sig</span> <span class='hs-varid'>decl</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Right</span> <span class='hs-varid'>decl</span>
<a name="line-294"></a>
<a name="line-295"></a><a name="is_bind"></a><span class='hs-definition'>is_bind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsBind</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-296"></a><span class='hs-definition'>is_bind</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Hs</span><span class='hs-varop'>.</span><span class='hs-conid'>ValD</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Left</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>bind</span><span class='hs-layout'>)</span>
<a name="line-297"></a><span class='hs-definition'>is_bind</span> <span class='hs-varid'>decl</span>		       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Right</span> <span class='hs-varid'>decl</span>
<a name="line-298"></a>
<a name="line-299"></a><a name="mkBadDecMsg"></a><span class='hs-definition'>mkBadDecMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Message</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Message</span>
<a name="line-300"></a><span class='hs-definition'>mkBadDecMsg</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>bads</span> 
<a name="line-301"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal declaration(s) in"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>doc</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span>
<a name="line-302"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>Outputable</span><span class='hs-varop'>.</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>bads</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-303"></a>
<a name="line-304"></a><span class='hs-comment'>---------------------------------------------------</span>
<a name="line-305"></a><span class='hs-comment'>-- 	Data types</span>
<a name="line-306"></a><span class='hs-comment'>-- Can't handle GADTs yet</span>
<a name="line-307"></a><span class='hs-comment'>---------------------------------------------------</span>
<a name="line-308"></a>
<a name="line-309"></a><a name="cvtConstr"></a><span class='hs-definition'>cvtConstr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Con</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LConDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-310"></a>
<a name="line-311"></a><span class='hs-definition'>cvtConstr</span> <span class='hs-layout'>(</span><span class='hs-conid'>NormalC</span> <span class='hs-varid'>c</span> <span class='hs-varid'>strtys</span><span class='hs-layout'>)</span>
<a name="line-312"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>c'</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cNameL</span> <span class='hs-varid'>c</span> 
<a name="line-313"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>cxt'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>returnL</span> <span class='hs-conid'>[]</span>
<a name="line-314"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>tys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>cvt_arg</span> <span class='hs-varid'>strtys</span>
<a name="line-315"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>returnL</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkSimpleConDecl</span> <span class='hs-varid'>c'</span> <span class='hs-varid'>noExistentials</span> <span class='hs-varid'>cxt'</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrefixCon</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-316"></a>
<a name="line-317"></a><span class='hs-definition'>cvtConstr</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecC</span> <span class='hs-varid'>c</span> <span class='hs-varid'>varstrtys</span><span class='hs-layout'>)</span>
<a name="line-318"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 	<span class='hs-layout'>{</span> <span class='hs-varid'>c'</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cNameL</span> <span class='hs-varid'>c</span> 
<a name="line-319"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>cxt'</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>returnL</span> <span class='hs-conid'>[]</span>
<a name="line-320"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>args'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>cvt_id_arg</span> <span class='hs-varid'>varstrtys</span>
<a name="line-321"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>returnL</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkSimpleConDecl</span> <span class='hs-varid'>c'</span> <span class='hs-varid'>noExistentials</span> <span class='hs-varid'>cxt'</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecCon</span> <span class='hs-varid'>args'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-322"></a>
<a name="line-323"></a><span class='hs-definition'>cvtConstr</span> <span class='hs-layout'>(</span><span class='hs-conid'>InfixC</span> <span class='hs-varid'>st1</span> <span class='hs-varid'>c</span> <span class='hs-varid'>st2</span><span class='hs-layout'>)</span>
<a name="line-324"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 	<span class='hs-layout'>{</span> <span class='hs-varid'>c'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cNameL</span> <span class='hs-varid'>c</span> 
<a name="line-325"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>cxt'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>returnL</span> <span class='hs-conid'>[]</span>
<a name="line-326"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>st1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvt_arg</span> <span class='hs-varid'>st1</span>
<a name="line-327"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>st2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvt_arg</span> <span class='hs-varid'>st2</span>
<a name="line-328"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>returnL</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkSimpleConDecl</span> <span class='hs-varid'>c'</span> <span class='hs-varid'>noExistentials</span> <span class='hs-varid'>cxt'</span> <span class='hs-layout'>(</span><span class='hs-conid'>InfixCon</span> <span class='hs-varid'>st1'</span> <span class='hs-varid'>st2'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-329"></a>
<a name="line-330"></a><span class='hs-definition'>cvtConstr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForallC</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span>
<a name="line-331"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>tvs'</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtTvs</span> <span class='hs-varid'>tvs</span>
<a name="line-332"></a>	<span class='hs-layout'>;</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>ctxt'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtContext</span> <span class='hs-varid'>ctxt</span>
<a name="line-333"></a>	<span class='hs-layout'>;</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>con'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtConstr</span> <span class='hs-varid'>con</span>
<a name="line-334"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>returnL</span> <span class='hs-varop'>$</span> <span class='hs-varid'>con'</span> <span class='hs-layout'>{</span> <span class='hs-varid'>con_qvars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs'</span> <span class='hs-varop'>++</span> <span class='hs-varid'>con_qvars</span> <span class='hs-varid'>con'</span>
<a name="line-335"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>con_cxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt'</span> <span class='hs-varop'>++</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>con_cxt</span> <span class='hs-varid'>con'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-336"></a>
<a name="line-337"></a><a name="cvt_arg"></a><span class='hs-definition'>cvt_arg</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Strict</span><span class='hs-layout'>,</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-338"></a><span class='hs-definition'>cvt_arg</span> <span class='hs-layout'>(</span><span class='hs-conid'>IsStrict</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>;</span> <span class='hs-varid'>returnL</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsBangTy</span> <span class='hs-conid'>HsStrict</span> <span class='hs-varid'>ty'</span> <span class='hs-layout'>}</span>
<a name="line-339"></a><span class='hs-definition'>cvt_arg</span> <span class='hs-layout'>(</span><span class='hs-conid'>NotStrict</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cvtType</span> <span class='hs-varid'>ty</span>
<a name="line-340"></a><span class='hs-definition'>cvt_arg</span> <span class='hs-layout'>(</span><span class='hs-conid'>Unpacked</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>;</span> <span class='hs-varid'>returnL</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsBangTy</span> <span class='hs-conid'>HsUnpack</span> <span class='hs-varid'>ty'</span> <span class='hs-layout'>}</span>
<a name="line-341"></a>
<a name="line-342"></a><a name="cvt_id_arg"></a><span class='hs-definition'>cvt_id_arg</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Strict</span><span class='hs-layout'>,</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConDeclField</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-343"></a><span class='hs-definition'>cvt_id_arg</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>str</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> 
<a name="line-344"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>i'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>vNameL</span> <span class='hs-varid'>i</span>
<a name="line-345"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvt_arg</span> <span class='hs-layout'>(</span><span class='hs-varid'>str</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-346"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConDeclField</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cd_fld_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>i'</span><span class='hs-layout'>,</span> <span class='hs-varid'>cd_fld_type</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>cd_fld_doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-347"></a>
<a name="line-348"></a><a name="cvtDerivs"></a><span class='hs-definition'>cvtDerivs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-349"></a><span class='hs-definition'>cvtDerivs</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-350"></a><span class='hs-definition'>cvtDerivs</span> <span class='hs-varid'>cs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>cvt_one</span> <span class='hs-varid'>cs</span>
<a name="line-351"></a>		  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>cs'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-352"></a>	<span class='hs-keyword'>where</span>
<a name="line-353"></a>	  <span class='hs-varid'>cvt_one</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>c'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tconName</span> <span class='hs-varid'>c</span>
<a name="line-354"></a>			 <span class='hs-layout'>;</span> <span class='hs-varid'>returnL</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsTyVar</span> <span class='hs-varid'>c'</span> <span class='hs-layout'>}</span>
<a name="line-355"></a>
<a name="line-356"></a><a name="cvt_fundep"></a><span class='hs-definition'>cvt_fundep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FunDep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-conid'>Class</span><span class='hs-varop'>.</span><span class='hs-conid'>FunDep</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-357"></a><span class='hs-definition'>cvt_fundep</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunDep</span> <span class='hs-varid'>xs</span> <span class='hs-varid'>ys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>xs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>tName</span> <span class='hs-varid'>xs</span><span class='hs-layout'>;</span> <span class='hs-varid'>ys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>tName</span> <span class='hs-varid'>ys</span><span class='hs-layout'>;</span> <span class='hs-varid'>returnL</span> <span class='hs-layout'>(</span><span class='hs-varid'>xs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ys'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-358"></a>
<a name="line-359"></a><a name="noExistentials"></a><span class='hs-definition'>noExistentials</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-360"></a><span class='hs-definition'>noExistentials</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-361"></a>
<a name="line-362"></a><span class='hs-comment'>------------------------------------------</span>
<a name="line-363"></a><span class='hs-comment'>-- 	Foreign declarations</span>
<a name="line-364"></a><span class='hs-comment'>------------------------------------------</span>
<a name="line-365"></a>
<a name="line-366"></a><a name="cvtForD"></a><span class='hs-definition'>cvtForD</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Foreign</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForeignDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-367"></a><span class='hs-definition'>cvtForD</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImportF</span> <span class='hs-varid'>callconv</span> <span class='hs-varid'>safety</span> <span class='hs-varid'>from</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-368"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>impspec</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>parseCImport</span> <span class='hs-layout'>(</span><span class='hs-varid'>cvt_conv</span> <span class='hs-varid'>callconv</span><span class='hs-layout'>)</span> <span class='hs-varid'>safety'</span> 
<a name="line-369"></a>                                 <span class='hs-layout'>(</span><span class='hs-varid'>mkFastString</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>nameBase</span> <span class='hs-varid'>nm</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>from</span>
<a name="line-370"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>nm'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>vNameL</span> <span class='hs-varid'>nm</span>
<a name="line-371"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtType</span> <span class='hs-varid'>ty</span>
<a name="line-372"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForeignImport</span> <span class='hs-varid'>nm'</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>noForeignImportCoercionYet</span> <span class='hs-varid'>impspec</span><span class='hs-layout'>)</span>
<a name="line-373"></a>       <span class='hs-layout'>}</span>
<a name="line-374"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-375"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWith</span> <span class='hs-varop'>$</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>from</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is not a valid ccall impent"</span><span class='hs-layout'>)</span>
<a name="line-376"></a>  <span class='hs-keyword'>where</span>
<a name="line-377"></a>    <span class='hs-varid'>safety'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>safety</span> <span class='hs-keyword'>of</span>
<a name="line-378"></a>                     <span class='hs-conid'>Unsafe</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PlayRisky</span>
<a name="line-379"></a>                     <span class='hs-conid'>Safe</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PlaySafe</span>
<a name="line-380"></a>                     <span class='hs-conid'>Interruptible</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PlayInterruptible</span>
<a name="line-381"></a>
<a name="line-382"></a><span class='hs-definition'>cvtForD</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExportF</span> <span class='hs-varid'>callconv</span> <span class='hs-keyword'>as</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-383"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>nm'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>vNameL</span> <span class='hs-varid'>nm</span>
<a name="line-384"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtType</span> <span class='hs-varid'>ty</span>
<a name="line-385"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CExport</span> <span class='hs-layout'>(</span><span class='hs-conid'>CExportStatic</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFastString</span> <span class='hs-keyword'>as</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>cvt_conv</span> <span class='hs-varid'>callconv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-386"></a> 	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ForeignExport</span> <span class='hs-varid'>nm'</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>noForeignExportCoercionYet</span> <span class='hs-varid'>e</span> <span class='hs-layout'>}</span>
<a name="line-387"></a>
<a name="line-388"></a><a name="cvt_conv"></a><span class='hs-definition'>cvt_conv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Callconv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CCallConv</span>
<a name="line-389"></a><span class='hs-definition'>cvt_conv</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>CCall</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CCallConv</span>
<a name="line-390"></a><span class='hs-definition'>cvt_conv</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>StdCall</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StdCallConv</span>
<a name="line-391"></a>
<a name="line-392"></a><span class='hs-comment'>------------------------------------------</span>
<a name="line-393"></a><span class='hs-comment'>--              Pragmas</span>
<a name="line-394"></a><span class='hs-comment'>------------------------------------------</span>
<a name="line-395"></a>
<a name="line-396"></a><a name="cvtPragmaD"></a><span class='hs-definition'>cvtPragmaD</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Pragma</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Sig</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-397"></a><span class='hs-definition'>cvtPragmaD</span> <span class='hs-layout'>(</span><span class='hs-conid'>InlineP</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>ispec</span><span class='hs-layout'>)</span>
<a name="line-398"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>nm'</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>vNameL</span> <span class='hs-varid'>nm</span>
<a name="line-399"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>InlineSig</span> <span class='hs-varid'>nm'</span> <span class='hs-layout'>(</span><span class='hs-varid'>cvtInlineSpec</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>ispec</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-400"></a>
<a name="line-401"></a><span class='hs-definition'>cvtPragmaD</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpecialiseP</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>opt_ispec</span><span class='hs-layout'>)</span>
<a name="line-402"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>nm'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>vNameL</span> <span class='hs-varid'>nm</span>
<a name="line-403"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtType</span> <span class='hs-varid'>ty</span>
<a name="line-404"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>SpecSig</span> <span class='hs-varid'>nm'</span> <span class='hs-varid'>ty'</span> <span class='hs-layout'>(</span><span class='hs-varid'>cvtInlineSpec</span> <span class='hs-varid'>opt_ispec</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-405"></a>
<a name="line-406"></a><a name="cvtInlineSpec"></a><span class='hs-definition'>cvtInlineSpec</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>InlineSpec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Hs</span><span class='hs-varop'>.</span><span class='hs-conid'>InlinePragma</span>
<a name="line-407"></a><span class='hs-definition'>cvtInlineSpec</span> <span class='hs-conid'>Nothing</span> 
<a name="line-408"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defaultInlinePragma</span>
<a name="line-409"></a><span class='hs-definition'>cvtInlineSpec</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>InlineSpec</span> <span class='hs-varid'>inline</span> <span class='hs-varid'>conlike</span> <span class='hs-varid'>opt_activation</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-410"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>InlinePragma</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inl_act</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>opt_activation'</span><span class='hs-layout'>,</span> <span class='hs-varid'>inl_rule</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matchinfo</span>
<a name="line-411"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>inl_inline</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inl_spec</span><span class='hs-layout'>,</span> <span class='hs-varid'>inl_sat</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>}</span>
<a name="line-412"></a>  <span class='hs-keyword'>where</span>
<a name="line-413"></a>    <span class='hs-varid'>matchinfo</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cvtRuleMatchInfo</span> <span class='hs-varid'>conlike</span>
<a name="line-414"></a>    <span class='hs-varid'>opt_activation'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cvtActivation</span> <span class='hs-varid'>opt_activation</span>
<a name="line-415"></a>
<a name="line-416"></a>    <span class='hs-varid'>cvtRuleMatchInfo</span> <span class='hs-conid'>False</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FunLike</span>
<a name="line-417"></a>    <span class='hs-varid'>cvtRuleMatchInfo</span> <span class='hs-conid'>True</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ConLike</span>
<a name="line-418"></a>
<a name="line-419"></a>    <span class='hs-varid'>inl_spec</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>inline</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Inline</span>
<a name="line-420"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoInline</span>
<a name="line-421"></a> 	     <span class='hs-comment'>-- Currently we have no way to say Inlinable</span>
<a name="line-422"></a>
<a name="line-423"></a>    <span class='hs-varid'>cvtActivation</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>inline</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AlwaysActive</span>
<a name="line-424"></a>                          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NeverActive</span>
<a name="line-425"></a>    <span class='hs-varid'>cvtActivation</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>phase</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ActiveBefore</span> <span class='hs-varid'>phase</span>
<a name="line-426"></a>    <span class='hs-varid'>cvtActivation</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>True</span> <span class='hs-layout'>,</span> <span class='hs-varid'>phase</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ActiveAfter</span>  <span class='hs-varid'>phase</span>
<a name="line-427"></a>
<a name="line-428"></a><span class='hs-comment'>---------------------------------------------------</span>
<a name="line-429"></a><span class='hs-comment'>--		Declarations</span>
<a name="line-430"></a><span class='hs-comment'>---------------------------------------------------</span>
<a name="line-431"></a>
<a name="line-432"></a><a name="cvtLocalDecs"></a><span class='hs-definition'>cvtLocalDecs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Message</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Dec</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLocalBinds</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-433"></a><span class='hs-definition'>cvtLocalDecs</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ds</span> 
<a name="line-434"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>ds</span>
<a name="line-435"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>EmptyLocalBinds</span>
<a name="line-436"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-437"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ds'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>cvtDec</span> <span class='hs-varid'>ds</span>
<a name="line-438"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>prob_sigs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionWith</span> <span class='hs-varid'>is_bind</span> <span class='hs-varid'>ds'</span>
<a name="line-439"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>sigs</span><span class='hs-layout'>,</span> <span class='hs-varid'>bads</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionWith</span> <span class='hs-varid'>is_sig</span> <span class='hs-varid'>prob_sigs</span>
<a name="line-440"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>bads</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>failWith</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkBadDecMsg</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>bads</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-441"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>ValBindsIn</span> <span class='hs-layout'>(</span><span class='hs-varid'>listToBag</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-442"></a>
<a name="line-443"></a><a name="cvtClause"></a><span class='hs-definition'>cvtClause</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Clause</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Hs</span><span class='hs-varop'>.</span><span class='hs-conid'>LMatch</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-444"></a><span class='hs-definition'>cvtClause</span> <span class='hs-layout'>(</span><span class='hs-conid'>Clause</span> <span class='hs-varid'>ps</span> <span class='hs-varid'>body</span> <span class='hs-varid'>wheres</span><span class='hs-layout'>)</span>
<a name="line-445"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>ps'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtPats</span> <span class='hs-varid'>ps</span>
<a name="line-446"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>g'</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtGuard</span> <span class='hs-varid'>body</span>
<a name="line-447"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>ds'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtLocalDecs</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a where clause"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>wheres</span>
<a name="line-448"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>returnL</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Hs</span><span class='hs-varop'>.</span><span class='hs-conid'>Match</span> <span class='hs-varid'>ps'</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHSs</span> <span class='hs-varid'>g'</span> <span class='hs-varid'>ds'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-449"></a>
<a name="line-450"></a>
<a name="line-451"></a><span class='hs-comment'>-------------------------------------------------------------------</span>
<a name="line-452"></a><span class='hs-comment'>--		Expressions</span>
<a name="line-453"></a><span class='hs-comment'>-------------------------------------------------------------------</span>
<a name="line-454"></a>
<a name="line-455"></a><a name="cvtl"></a><span class='hs-definition'>cvtl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Exp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-456"></a><span class='hs-definition'>cvtl</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapL</span> <span class='hs-layout'>(</span><span class='hs-varid'>cvt</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-457"></a>  <span class='hs-keyword'>where</span>
<a name="line-458"></a>    <span class='hs-varid'>cvt</span> <span class='hs-layout'>(</span><span class='hs-conid'>VarE</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> 	<span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>s'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>vName</span> <span class='hs-varid'>s</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsVar</span> <span class='hs-varid'>s'</span> <span class='hs-layout'>}</span>
<a name="line-459"></a>    <span class='hs-varid'>cvt</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConE</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> 	<span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>s'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cName</span> <span class='hs-varid'>s</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsVar</span> <span class='hs-varid'>s'</span> <span class='hs-layout'>}</span>
<a name="line-460"></a>    <span class='hs-varid'>cvt</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitE</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> 
<a name="line-461"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>overloadedLit</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>l'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtOverLit</span> <span class='hs-varid'>l</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsOverLit</span> <span class='hs-varid'>l'</span> <span class='hs-layout'>}</span>
<a name="line-462"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>	<span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>l'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtLit</span> <span class='hs-varid'>l</span><span class='hs-layout'>;</span>     <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsLit</span> <span class='hs-varid'>l'</span> <span class='hs-layout'>}</span>
<a name="line-463"></a>
<a name="line-464"></a>    <span class='hs-varid'>cvt</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppE</span> <span class='hs-varid'>x</span> <span class='hs-varid'>y</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>x'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>x</span><span class='hs-layout'>;</span> <span class='hs-varid'>y'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>y</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsApp</span> <span class='hs-varid'>x'</span> <span class='hs-varid'>y'</span> <span class='hs-layout'>}</span>
<a name="line-465"></a>    <span class='hs-varid'>cvt</span> <span class='hs-layout'>(</span><span class='hs-conid'>LamE</span> <span class='hs-varid'>ps</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ps'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtPats</span> <span class='hs-varid'>ps</span><span class='hs-layout'>;</span> <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>e</span> 
<a name="line-466"></a>			    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsLam</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkMatchGroup</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkSimpleMatch</span> <span class='hs-varid'>ps'</span> <span class='hs-varid'>e'</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-467"></a>    <span class='hs-varid'>cvt</span> <span class='hs-layout'>(</span><span class='hs-conid'>TupE</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>e</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>e</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsPar</span> <span class='hs-varid'>e'</span> <span class='hs-layout'>}</span>
<a name="line-468"></a>    	      	       	         <span class='hs-comment'>-- Note [Dropping constructors]</span>
<a name="line-469"></a>                                 <span class='hs-comment'>-- Singleton tuples treated like nothing (just parens)</span>
<a name="line-470"></a>    <span class='hs-varid'>cvt</span> <span class='hs-layout'>(</span><span class='hs-conid'>TupE</span> <span class='hs-varid'>es</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>es'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>es</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ExplicitTuple</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>Present</span> <span class='hs-varid'>es'</span><span class='hs-layout'>)</span> <span class='hs-conid'>Boxed</span> <span class='hs-layout'>}</span>
<a name="line-471"></a>    <span class='hs-varid'>cvt</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnboxedTupE</span> <span class='hs-varid'>es</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>es'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>es</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ExplicitTuple</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>Present</span> <span class='hs-varid'>es'</span><span class='hs-layout'>)</span> <span class='hs-conid'>Unboxed</span> <span class='hs-layout'>}</span>
<a name="line-472"></a>    <span class='hs-varid'>cvt</span> <span class='hs-layout'>(</span><span class='hs-conid'>CondE</span> <span class='hs-varid'>x</span> <span class='hs-varid'>y</span> <span class='hs-varid'>z</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>x'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>x</span><span class='hs-layout'>;</span> <span class='hs-varid'>y'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>y</span><span class='hs-layout'>;</span> <span class='hs-varid'>z'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>z</span><span class='hs-layout'>;</span>
<a name="line-473"></a>			    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsIf</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>noSyntaxExpr</span><span class='hs-layout'>)</span> <span class='hs-varid'>x'</span> <span class='hs-varid'>y'</span> <span class='hs-varid'>z'</span> <span class='hs-layout'>}</span>
<a name="line-474"></a>    <span class='hs-varid'>cvt</span> <span class='hs-layout'>(</span><span class='hs-conid'>LetE</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ds'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtLocalDecs</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a let expression"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds</span>
<a name="line-475"></a>                            <span class='hs-layout'>;</span> <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>e</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsLet</span> <span class='hs-varid'>ds'</span> <span class='hs-varid'>e'</span> <span class='hs-layout'>}</span>
<a name="line-476"></a>    <span class='hs-varid'>cvt</span> <span class='hs-layout'>(</span><span class='hs-conid'>CaseE</span> <span class='hs-varid'>e</span> <span class='hs-varid'>ms</span><span class='hs-layout'>)</span>   
<a name="line-477"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>ms</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWith</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Case expression with no alternatives"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-478"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>e</span><span class='hs-layout'>;</span> <span class='hs-varid'>ms'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>cvtMatch</span> <span class='hs-varid'>ms</span>
<a name="line-479"></a>			    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsCase</span> <span class='hs-varid'>e'</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkMatchGroup</span> <span class='hs-varid'>ms'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-480"></a>    <span class='hs-varid'>cvt</span> <span class='hs-layout'>(</span><span class='hs-conid'>DoE</span> <span class='hs-varid'>ss</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cvtHsDo</span> <span class='hs-conid'>DoExpr</span> <span class='hs-varid'>ss</span>
<a name="line-481"></a>    <span class='hs-varid'>cvt</span> <span class='hs-layout'>(</span><span class='hs-conid'>CompE</span> <span class='hs-varid'>ss</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cvtHsDo</span> <span class='hs-conid'>ListComp</span> <span class='hs-varid'>ss</span>
<a name="line-482"></a>    <span class='hs-varid'>cvt</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArithSeqE</span> <span class='hs-varid'>dd</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dd'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtDD</span> <span class='hs-varid'>dd</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ArithSeq</span> <span class='hs-varid'>noPostTcExpr</span> <span class='hs-varid'>dd'</span> <span class='hs-layout'>}</span>
<a name="line-483"></a>    <span class='hs-varid'>cvt</span> <span class='hs-layout'>(</span><span class='hs-conid'>ListE</span> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span>     
<a name="line-484"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>allCharLs</span> <span class='hs-varid'>xs</span>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>l'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>StringL</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsLit</span> <span class='hs-varid'>l'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-485"></a>      	     <span class='hs-comment'>-- Note [Converting strings]</span>
<a name="line-486"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>xs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>xs</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ExplicitList</span> <span class='hs-varid'>void</span> <span class='hs-varid'>xs'</span> <span class='hs-layout'>}</span>
<a name="line-487"></a>
<a name="line-488"></a>    <span class='hs-comment'>-- Infix expressions</span>
<a name="line-489"></a>    <span class='hs-varid'>cvt</span> <span class='hs-layout'>(</span><span class='hs-conid'>InfixE</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-varid'>s</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>y</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>x'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>x</span><span class='hs-layout'>;</span> <span class='hs-varid'>s'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>s</span><span class='hs-layout'>;</span> <span class='hs-varid'>y'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>y</span>
<a name="line-490"></a>					  <span class='hs-layout'>;</span> <span class='hs-varid'>wrapParL</span> <span class='hs-conid'>HsPar</span> <span class='hs-varop'>$</span> 
<a name="line-491"></a>                                            <span class='hs-conid'>OpApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLHsPar</span> <span class='hs-varid'>x'</span><span class='hs-layout'>)</span> <span class='hs-varid'>s'</span> <span class='hs-varid'>undefined</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLHsPar</span> <span class='hs-varid'>y'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-492"></a>  					    <span class='hs-comment'>-- Parenthesise both arguments and result, </span>
<a name="line-493"></a>					    <span class='hs-comment'>-- to ensure this operator application does</span>
<a name="line-494"></a> 					    <span class='hs-comment'>-- does not get re-associated</span>
<a name="line-495"></a>			    <span class='hs-comment'>-- See Note [Operator association]</span>
<a name="line-496"></a>    <span class='hs-varid'>cvt</span> <span class='hs-layout'>(</span><span class='hs-conid'>InfixE</span> <span class='hs-conid'>Nothing</span>  <span class='hs-varid'>s</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>y</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>s'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>s</span><span class='hs-layout'>;</span> <span class='hs-varid'>y'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>y</span>
<a name="line-497"></a>					  <span class='hs-layout'>;</span> <span class='hs-varid'>wrapParL</span> <span class='hs-conid'>HsPar</span> <span class='hs-varop'>$</span> <span class='hs-conid'>SectionR</span> <span class='hs-varid'>s'</span> <span class='hs-varid'>y'</span> <span class='hs-layout'>}</span>
<a name="line-498"></a>					    <span class='hs-comment'>-- See Note [Sections in HsSyn] in HsExpr</span>
<a name="line-499"></a>    <span class='hs-varid'>cvt</span> <span class='hs-layout'>(</span><span class='hs-conid'>InfixE</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-varid'>s</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>x'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>x</span><span class='hs-layout'>;</span> <span class='hs-varid'>s'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>s</span>
<a name="line-500"></a>					  <span class='hs-layout'>;</span> <span class='hs-varid'>wrapParL</span> <span class='hs-conid'>HsPar</span> <span class='hs-varop'>$</span> <span class='hs-conid'>SectionL</span> <span class='hs-varid'>x'</span> <span class='hs-varid'>s'</span> <span class='hs-layout'>}</span>
<a name="line-501"></a>
<a name="line-502"></a>    <span class='hs-varid'>cvt</span> <span class='hs-layout'>(</span><span class='hs-conid'>InfixE</span> <span class='hs-conid'>Nothing</span>  <span class='hs-varid'>s</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>s'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>s</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsPar</span> <span class='hs-varid'>s'</span> <span class='hs-layout'>}</span>
<a name="line-503"></a>                                       <span class='hs-comment'>-- Can I indicate this is an infix thing?</span>
<a name="line-504"></a>                                       <span class='hs-comment'>-- Note [Dropping constructors]</span>
<a name="line-505"></a>
<a name="line-506"></a>    <span class='hs-varid'>cvt</span> <span class='hs-layout'>(</span><span class='hs-conid'>UInfixE</span> <span class='hs-varid'>x</span> <span class='hs-varid'>s</span> <span class='hs-varid'>y</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>x'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>x</span>
<a name="line-507"></a>                              <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>x''</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>x'</span> <span class='hs-keyword'>of</span> 
<a name="line-508"></a>                                            <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpApp</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>x'</span>
<a name="line-509"></a>                                            <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkLHsPar</span> <span class='hs-varid'>x'</span>
<a name="line-510"></a>                              <span class='hs-layout'>;</span> <span class='hs-varid'>cvtOpApp</span> <span class='hs-varid'>x''</span> <span class='hs-varid'>s</span> <span class='hs-varid'>y</span> <span class='hs-layout'>}</span> <span class='hs-comment'>--  Note [Converting UInfix]</span>
<a name="line-511"></a>
<a name="line-512"></a>    <span class='hs-varid'>cvt</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParensE</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>e</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsPar</span> <span class='hs-varid'>e'</span> <span class='hs-layout'>}</span>
<a name="line-513"></a>    <span class='hs-varid'>cvt</span> <span class='hs-layout'>(</span><span class='hs-conid'>SigE</span> <span class='hs-varid'>e</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>	 <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>e</span><span class='hs-layout'>;</span> <span class='hs-varid'>t'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtType</span> <span class='hs-varid'>t</span>
<a name="line-514"></a>			      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ExprWithTySig</span> <span class='hs-varid'>e'</span> <span class='hs-varid'>t'</span> <span class='hs-layout'>}</span>
<a name="line-515"></a>    <span class='hs-varid'>cvt</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecConE</span> <span class='hs-varid'>c</span> <span class='hs-varid'>flds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>c'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cNameL</span> <span class='hs-varid'>c</span>
<a name="line-516"></a>			      <span class='hs-layout'>;</span> <span class='hs-varid'>flds'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>cvtFld</span> <span class='hs-varid'>flds</span>
<a name="line-517"></a>			      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>RecordCon</span> <span class='hs-varid'>c'</span> <span class='hs-varid'>noPostTcExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecFields</span> <span class='hs-varid'>flds'</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span><span class='hs-layout'>}</span>
<a name="line-518"></a>    <span class='hs-varid'>cvt</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecUpdE</span> <span class='hs-varid'>e</span> <span class='hs-varid'>flds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>e</span>
<a name="line-519"></a>			      <span class='hs-layout'>;</span> <span class='hs-varid'>flds'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>cvtFld</span> <span class='hs-varid'>flds</span>
<a name="line-520"></a>			      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>RecordUpd</span> <span class='hs-varid'>e'</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecFields</span> <span class='hs-varid'>flds'</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>}</span>
<a name="line-521"></a>
<a name="line-522"></a><span class='hs-comment'>{- Note [Dropping constructors]
<a name="line-523"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-524"></a>When we drop constructors from the input (for instance, when we encounter @TupE [e]@)
<a name="line-525"></a>we must insert parentheses around the argument. Otherwise, @UInfix@ constructors in @e@
<a name="line-526"></a>could meet @UInfix@ constructors containing the @TupE [e]@. For example:
<a name="line-527"></a>
<a name="line-528"></a>  UInfixE x * (TupE [UInfixE y + z])
<a name="line-529"></a>
<a name="line-530"></a>If we drop the singleton tuple but don't insert parentheses, the @UInfixE@s would meet
<a name="line-531"></a>and the above expression would be reassociated to
<a name="line-532"></a>
<a name="line-533"></a>  OpApp (OpApp x * y) + z
<a name="line-534"></a>
<a name="line-535"></a>which we don't want.
<a name="line-536"></a>-}</span>
<a name="line-537"></a>
<a name="line-538"></a><a name="cvtFld"></a><span class='hs-definition'>cvtFld</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Exp</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecField</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-539"></a><span class='hs-definition'>cvtFld</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span><span class='hs-varid'>e</span><span class='hs-layout'>)</span> 
<a name="line-540"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>v'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>vNameL</span> <span class='hs-varid'>v</span><span class='hs-layout'>;</span> <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>e</span>
<a name="line-541"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecField</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsRecFieldId</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>v'</span><span class='hs-layout'>,</span> <span class='hs-varid'>hsRecFieldArg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>e'</span><span class='hs-layout'>,</span> <span class='hs-varid'>hsRecPun</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-542"></a>
<a name="line-543"></a><a name="cvtDD"></a><span class='hs-definition'>cvtDD</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Range</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArithSeqInfo</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-544"></a><span class='hs-definition'>cvtDD</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromR</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> 	  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>x'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>x</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>From</span> <span class='hs-varid'>x'</span> <span class='hs-layout'>}</span>
<a name="line-545"></a><span class='hs-definition'>cvtDD</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromThenR</span> <span class='hs-varid'>x</span> <span class='hs-varid'>y</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>x'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>x</span><span class='hs-layout'>;</span> <span class='hs-varid'>y'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>y</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>FromThen</span> <span class='hs-varid'>x'</span> <span class='hs-varid'>y'</span> <span class='hs-layout'>}</span>
<a name="line-546"></a><span class='hs-definition'>cvtDD</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromToR</span> <span class='hs-varid'>x</span> <span class='hs-varid'>y</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>x'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>x</span><span class='hs-layout'>;</span> <span class='hs-varid'>y'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>y</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>FromTo</span> <span class='hs-varid'>x'</span> <span class='hs-varid'>y'</span> <span class='hs-layout'>}</span>
<a name="line-547"></a><span class='hs-definition'>cvtDD</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromThenToR</span> <span class='hs-varid'>x</span> <span class='hs-varid'>y</span> <span class='hs-varid'>z</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>x'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>x</span><span class='hs-layout'>;</span> <span class='hs-varid'>y'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>y</span><span class='hs-layout'>;</span> <span class='hs-varid'>z'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>z</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>FromThenTo</span> <span class='hs-varid'>x'</span> <span class='hs-varid'>y'</span> <span class='hs-varid'>z'</span> <span class='hs-layout'>}</span>
<a name="line-548"></a>
<a name="line-549"></a><span class='hs-comment'>{- Note [Operator assocation]
<a name="line-550"></a>We must be quite careful about adding parens:
<a name="line-551"></a>  * Infix (UInfix ...) op arg      Needs parens round the first arg
<a name="line-552"></a>  * Infix (Infix ...) op arg       Needs parens round the first arg
<a name="line-553"></a>  * UInfix (UInfix ...) op arg     No parens for first arg
<a name="line-554"></a>  * UInfix (Infix ...) op arg      Needs parens round first arg
<a name="line-555"></a>
<a name="line-556"></a>
<a name="line-557"></a>Note [Converting UInfix]
<a name="line-558"></a>~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-559"></a>When converting @UInfixE@ and @UInfixP@ values, we want to readjust
<a name="line-560"></a>the trees to reflect the fixities of the underlying operators:
<a name="line-561"></a>
<a name="line-562"></a>  UInfixE x * (UInfixE y + z) ---&gt; (x * y) + z
<a name="line-563"></a>
<a name="line-564"></a>This is done by the renamer (see @mkOppAppRn@ and @mkConOppPatRn@ in
<a name="line-565"></a>RnTypes), which expects that the input will be completely left-biased.
<a name="line-566"></a>So we left-bias the trees  of @UInfixP@ and @UInfixE@ that we come across.
<a name="line-567"></a>
<a name="line-568"></a>Sample input:
<a name="line-569"></a>
<a name="line-570"></a>  UInfixE
<a name="line-571"></a>   (UInfixE x op1 y)
<a name="line-572"></a>   op2
<a name="line-573"></a>   (UInfixE z op3 w)
<a name="line-574"></a>
<a name="line-575"></a>Sample output:
<a name="line-576"></a>
<a name="line-577"></a>  OpApp
<a name="line-578"></a>    (OpApp
<a name="line-579"></a>      (OpApp x op1 y)
<a name="line-580"></a>      op2
<a name="line-581"></a>      z)
<a name="line-582"></a>    op3
<a name="line-583"></a>    w
<a name="line-584"></a>
<a name="line-585"></a>The functions @cvtOpApp@ and @cvtOpAppP@ are responsible for this
<a name="line-586"></a>left-biasing.
<a name="line-587"></a>-}</span>
<a name="line-588"></a>
<a name="line-589"></a><a name="cvtOpApp"></a><span class='hs-comment'>{- | @cvtOpApp x op y@ converts @op@ and @y@ and produces the operator application @x `op` y@.
<a name="line-590"></a>The produced tree of infix expressions will be left-biased, provided @x@ is.
<a name="line-591"></a>
<a name="line-592"></a>We can see that @cvtOpApp@ is correct as follows. The inductive hypothesis
<a name="line-593"></a>is that @cvtOpApp x op y@ is left-biased, provided @x@ is. It is clear that
<a name="line-594"></a>this holds for both branches (of @cvtOpApp@), provided we assume it holds for
<a name="line-595"></a>the recursive calls to @cvtOpApp@.
<a name="line-596"></a>
<a name="line-597"></a>When we call @cvtOpApp@ from @cvtl@, the first argument will always be left-biased
<a name="line-598"></a>since we have already run @cvtl@ on it.
<a name="line-599"></a>-}</span>
<a name="line-600"></a><span class='hs-definition'>cvtOpApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Exp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Exp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-601"></a><span class='hs-definition'>cvtOpApp</span> <span class='hs-varid'>x</span> <span class='hs-varid'>op1</span> <span class='hs-layout'>(</span><span class='hs-conid'>UInfixE</span> <span class='hs-varid'>y</span> <span class='hs-varid'>op2</span> <span class='hs-varid'>z</span><span class='hs-layout'>)</span>
<a name="line-602"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapL</span> <span class='hs-varop'>$</span> <span class='hs-varid'>cvtOpApp</span> <span class='hs-varid'>x</span> <span class='hs-varid'>op1</span> <span class='hs-varid'>y</span>
<a name="line-603"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>cvtOpApp</span> <span class='hs-varid'>l</span> <span class='hs-varid'>op2</span> <span class='hs-varid'>z</span> <span class='hs-layout'>}</span>
<a name="line-604"></a><span class='hs-definition'>cvtOpApp</span> <span class='hs-varid'>x</span> <span class='hs-varid'>op</span> <span class='hs-varid'>y</span>
<a name="line-605"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>op'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>op</span>
<a name="line-606"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>y'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>y</span>
<a name="line-607"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpApp</span> <span class='hs-varid'>x</span> <span class='hs-varid'>op'</span> <span class='hs-varid'>undefined</span> <span class='hs-varid'>y'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-608"></a>
<a name="line-609"></a><span class='hs-comment'>-------------------------------------</span>
<a name="line-610"></a><span class='hs-comment'>-- 	Do notation and statements</span>
<a name="line-611"></a><span class='hs-comment'>-------------------------------------</span>
<a name="line-612"></a>
<a name="line-613"></a><a name="cvtHsDo"></a><span class='hs-definition'>cvtHsDo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsStmtContext</span> <span class='hs-conid'>Name</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Stmt</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-614"></a><span class='hs-definition'>cvtHsDo</span> <span class='hs-varid'>do_or_lc</span> <span class='hs-varid'>stmts</span>
<a name="line-615"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWith</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Empty stmt list in do-block"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-616"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-617"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>stmts'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtStmts</span> <span class='hs-varid'>stmts</span>
<a name="line-618"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>stmts''</span><span class='hs-layout'>,</span> <span class='hs-varid'>last'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>snocView</span> <span class='hs-varid'>stmts'</span>
<a name="line-619"></a>        
<a name="line-620"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>last''</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>last'</span> <span class='hs-keyword'>of</span>
<a name="line-621"></a>		      <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExprStmt</span> <span class='hs-varid'>body</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLastStmt</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-622"></a>                      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWith</span> <span class='hs-layout'>(</span><span class='hs-varid'>bad_last</span> <span class='hs-varid'>last'</span><span class='hs-layout'>)</span>
<a name="line-623"></a>
<a name="line-624"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsDo</span> <span class='hs-varid'>do_or_lc</span> <span class='hs-layout'>(</span><span class='hs-varid'>stmts''</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>last''</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-varid'>void</span> <span class='hs-layout'>}</span>
<a name="line-625"></a>  <span class='hs-keyword'>where</span>
<a name="line-626"></a>    <span class='hs-varid'>bad_last</span> <span class='hs-varid'>stmt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal last statement of"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprAStmtContext</span> <span class='hs-varid'>do_or_lc</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span>
<a name="line-627"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Outputable</span><span class='hs-varop'>.</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>stmt</span>
<a name="line-628"></a>			 <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"(It should be an expression.)"</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-629"></a>		
<a name="line-630"></a><a name="cvtStmts"></a><span class='hs-definition'>cvtStmts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Stmt</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Hs</span><span class='hs-varop'>.</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-631"></a><span class='hs-definition'>cvtStmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>cvtStmt</span> 
<a name="line-632"></a>
<a name="line-633"></a><a name="cvtStmt"></a><span class='hs-definition'>cvtStmt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Stmt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Hs</span><span class='hs-varop'>.</span><span class='hs-conid'>LStmt</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-634"></a><span class='hs-definition'>cvtStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>NoBindS</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>e</span><span class='hs-layout'>;</span> <span class='hs-varid'>returnL</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkExprStmt</span> <span class='hs-varid'>e'</span> <span class='hs-layout'>}</span>
<a name="line-635"></a><span class='hs-definition'>cvtStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>BindS</span> <span class='hs-varid'>p</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>p'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtPat</span> <span class='hs-varid'>p</span><span class='hs-layout'>;</span> <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>e</span><span class='hs-layout'>;</span> <span class='hs-varid'>returnL</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkBindStmt</span> <span class='hs-varid'>p'</span> <span class='hs-varid'>e'</span> <span class='hs-layout'>}</span>
<a name="line-636"></a><span class='hs-definition'>cvtStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>LetS</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ds'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtLocalDecs</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a let binding"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds</span>
<a name="line-637"></a>                            <span class='hs-layout'>;</span> <span class='hs-varid'>returnL</span> <span class='hs-varop'>$</span> <span class='hs-conid'>LetStmt</span> <span class='hs-varid'>ds'</span> <span class='hs-layout'>}</span>
<a name="line-638"></a><span class='hs-definition'>cvtStmt</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ParS</span> <span class='hs-varid'>dss</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dss'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>cvt_one</span> <span class='hs-varid'>dss</span><span class='hs-layout'>;</span> <span class='hs-varid'>returnL</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ParStmt</span> <span class='hs-varid'>dss'</span> <span class='hs-varid'>noSyntaxExpr</span> <span class='hs-varid'>noSyntaxExpr</span> <span class='hs-varid'>noSyntaxExpr</span> <span class='hs-layout'>}</span>
<a name="line-639"></a>		       <span class='hs-keyword'>where</span>
<a name="line-640"></a>			 <span class='hs-varid'>cvt_one</span> <span class='hs-varid'>ds</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ds'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtStmts</span> <span class='hs-varid'>ds</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>undefined</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-641"></a>
<a name="line-642"></a><a name="cvtMatch"></a><span class='hs-definition'>cvtMatch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Match</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Hs</span><span class='hs-varop'>.</span><span class='hs-conid'>LMatch</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-643"></a><span class='hs-definition'>cvtMatch</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Match</span> <span class='hs-varid'>p</span> <span class='hs-varid'>body</span> <span class='hs-varid'>decs</span><span class='hs-layout'>)</span>
<a name="line-644"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 	<span class='hs-layout'>{</span> <span class='hs-varid'>p'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtPat</span> <span class='hs-varid'>p</span>
<a name="line-645"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>g'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtGuard</span> <span class='hs-varid'>body</span>
<a name="line-646"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>decs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtLocalDecs</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a where clause"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>decs</span>
<a name="line-647"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>returnL</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Hs</span><span class='hs-varop'>.</span><span class='hs-conid'>Match</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p'</span><span class='hs-keyglyph'>]</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRHSs</span> <span class='hs-varid'>g'</span> <span class='hs-varid'>decs'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-648"></a>
<a name="line-649"></a><a name="cvtGuard"></a><span class='hs-definition'>cvtGuard</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Body</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LGRHS</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-650"></a><span class='hs-definition'>cvtGuard</span> <span class='hs-layout'>(</span><span class='hs-conid'>GuardedB</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>cvtpair</span> <span class='hs-varid'>pairs</span>
<a name="line-651"></a><span class='hs-definition'>cvtGuard</span> <span class='hs-layout'>(</span><span class='hs-conid'>NormalB</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>e</span><span class='hs-layout'>;</span> <span class='hs-varid'>g'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>returnL</span> <span class='hs-varop'>$</span> <span class='hs-conid'>GRHS</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>e'</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>g'</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-652"></a>
<a name="line-653"></a><a name="cvtpair"></a><span class='hs-definition'>cvtpair</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Guard</span><span class='hs-layout'>,</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Exp</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LGRHS</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-654"></a><span class='hs-definition'>cvtpair</span> <span class='hs-layout'>(</span><span class='hs-conid'>NormalG</span> <span class='hs-varid'>ge</span><span class='hs-layout'>,</span><span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ge'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>ge</span><span class='hs-layout'>;</span> <span class='hs-varid'>rhs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>rhs</span>
<a name="line-655"></a>			      <span class='hs-layout'>;</span> <span class='hs-varid'>g'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>returnL</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkExprStmt</span> <span class='hs-varid'>ge'</span>
<a name="line-656"></a>			      <span class='hs-layout'>;</span> <span class='hs-varid'>returnL</span> <span class='hs-varop'>$</span> <span class='hs-conid'>GRHS</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>g'</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>rhs'</span> <span class='hs-layout'>}</span>
<a name="line-657"></a><span class='hs-definition'>cvtpair</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatG</span> <span class='hs-varid'>gs</span><span class='hs-layout'>,</span><span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>gs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtStmts</span> <span class='hs-varid'>gs</span><span class='hs-layout'>;</span> <span class='hs-varid'>rhs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>rhs</span>
<a name="line-658"></a>			      <span class='hs-layout'>;</span> <span class='hs-varid'>returnL</span> <span class='hs-varop'>$</span> <span class='hs-conid'>GRHS</span> <span class='hs-varid'>gs'</span> <span class='hs-varid'>rhs'</span> <span class='hs-layout'>}</span>
<a name="line-659"></a>
<a name="line-660"></a><a name="cvtOverLit"></a><span class='hs-definition'>cvtOverLit</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Lit</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOverLit</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-661"></a><span class='hs-definition'>cvtOverLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>IntegerL</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>  
<a name="line-662"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>force</span> <span class='hs-varid'>i</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkHsIntegral</span> <span class='hs-varid'>i</span> <span class='hs-varid'>placeHolderType</span><span class='hs-layout'>}</span>
<a name="line-663"></a><span class='hs-definition'>cvtOverLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>RationalL</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> 
<a name="line-664"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>force</span> <span class='hs-varid'>r</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkHsFractional</span> <span class='hs-layout'>(</span><span class='hs-varid'>cvtFractionalLit</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-varid'>placeHolderType</span><span class='hs-layout'>}</span>
<a name="line-665"></a><span class='hs-definition'>cvtOverLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>StringL</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>   
<a name="line-666"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>s'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFastString</span> <span class='hs-varid'>s</span> <span class='hs-layout'>}</span>
<a name="line-667"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>force</span> <span class='hs-varid'>s'</span>
<a name="line-668"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkHsIsString</span> <span class='hs-varid'>s'</span> <span class='hs-varid'>placeHolderType</span> 
<a name="line-669"></a>       <span class='hs-layout'>}</span>
<a name="line-670"></a><span class='hs-definition'>cvtOverLit</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"Convert.cvtOverLit: Unexpected overloaded literal"</span>
<a name="line-671"></a><span class='hs-comment'>-- An Integer is like an (overloaded) '3' in a Haskell source program</span>
<a name="line-672"></a><span class='hs-comment'>-- Similarly 3.5 for fractionals</span>
<a name="line-673"></a>
<a name="line-674"></a><span class='hs-comment'>{- Note [Converting strings] 
<a name="line-675"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-676"></a>If we get (ListE [CharL 'x', CharL 'y']) we'd like to convert to
<a name="line-677"></a>a string literal for "xy".  Of course, we might hope to get 
<a name="line-678"></a>(LitE (StringL "xy")), but not always, and allCharLs fails quickly
<a name="line-679"></a>if it isn't a literal string
<a name="line-680"></a>-}</span>
<a name="line-681"></a>
<a name="line-682"></a><a name="allCharLs"></a><span class='hs-definition'>allCharLs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Exp</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>String</span>
<a name="line-683"></a><span class='hs-comment'>-- Note [Converting strings]</span>
<a name="line-684"></a><span class='hs-comment'>-- NB: only fire up this setup for a non-empty list, else</span>
<a name="line-685"></a><span class='hs-comment'>--     there's a danger of returning "" for [] :: [Int]!</span>
<a name="line-686"></a><span class='hs-definition'>allCharLs</span> <span class='hs-varid'>xs</span>
<a name="line-687"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>xs</span> <span class='hs-keyword'>of</span> 
<a name="line-688"></a>      <span class='hs-conid'>LitE</span> <span class='hs-layout'>(</span><span class='hs-conid'>CharL</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ys</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>c</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>ys</span>
<a name="line-689"></a>      <span class='hs-keyword'>_</span>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-690"></a>  <span class='hs-keyword'>where</span>
<a name="line-691"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>cs</span> <span class='hs-conid'>[]</span>                    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>
<a name="line-692"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>cs</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitE</span> <span class='hs-layout'>(</span><span class='hs-conid'>CharL</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>c</span><span class='hs-conop'>:</span><span class='hs-varid'>cs</span><span class='hs-layout'>)</span> <span class='hs-varid'>ys</span>
<a name="line-693"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span>  <span class='hs-keyword'>_</span>                     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-694"></a>
<a name="line-695"></a><a name="cvtLit"></a><span class='hs-definition'>cvtLit</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Lit</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-conid'>HsLit</span>
<a name="line-696"></a><span class='hs-definition'>cvtLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>IntPrimL</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>force</span> <span class='hs-varid'>i</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsIntPrim</span> <span class='hs-varid'>i</span> <span class='hs-layout'>}</span>
<a name="line-697"></a><span class='hs-definition'>cvtLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>WordPrimL</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>force</span> <span class='hs-varid'>w</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsWordPrim</span> <span class='hs-varid'>w</span> <span class='hs-layout'>}</span>
<a name="line-698"></a><span class='hs-definition'>cvtLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>FloatPrimL</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>force</span> <span class='hs-varid'>f</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsFloatPrim</span> <span class='hs-layout'>(</span><span class='hs-varid'>cvtFractionalLit</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-699"></a><span class='hs-definition'>cvtLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>DoublePrimL</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>force</span> <span class='hs-varid'>f</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsDoublePrim</span> <span class='hs-layout'>(</span><span class='hs-varid'>cvtFractionalLit</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-700"></a><span class='hs-definition'>cvtLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>CharL</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>force</span> <span class='hs-varid'>c</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsChar</span> <span class='hs-varid'>c</span> <span class='hs-layout'>}</span>
<a name="line-701"></a><span class='hs-definition'>cvtLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>StringL</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>s'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFastString</span> <span class='hs-varid'>s</span> <span class='hs-layout'>}</span>
<a name="line-702"></a>       		       	    <span class='hs-layout'>;</span> <span class='hs-varid'>force</span> <span class='hs-varid'>s'</span>      
<a name="line-703"></a>       		       	    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsString</span> <span class='hs-varid'>s'</span> <span class='hs-layout'>}</span>
<a name="line-704"></a><span class='hs-definition'>cvtLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>StringPrimL</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>s'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFastString</span> <span class='hs-varid'>s</span> <span class='hs-layout'>}</span>
<a name="line-705"></a>       			    <span class='hs-layout'>;</span> <span class='hs-varid'>force</span> <span class='hs-varid'>s'</span>           
<a name="line-706"></a>       			    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsStringPrim</span> <span class='hs-varid'>s'</span> <span class='hs-layout'>}</span>
<a name="line-707"></a><span class='hs-definition'>cvtLit</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"Convert.cvtLit: Unexpected literal"</span>
<a name="line-708"></a>	<span class='hs-comment'>-- cvtLit should not be called on IntegerL, RationalL</span>
<a name="line-709"></a>	<span class='hs-comment'>-- That precondition is established right here in</span>
<a name="line-710"></a>	<span class='hs-comment'>-- Convert.lhs, hence panic</span>
<a name="line-711"></a>
<a name="line-712"></a><a name="cvtPats"></a><span class='hs-definition'>cvtPats</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Pat</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Hs</span><span class='hs-varop'>.</span><span class='hs-conid'>LPat</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-713"></a><span class='hs-definition'>cvtPats</span> <span class='hs-varid'>pats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>cvtPat</span> <span class='hs-varid'>pats</span>
<a name="line-714"></a>
<a name="line-715"></a><a name="cvtPat"></a><span class='hs-definition'>cvtPat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Pat</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Hs</span><span class='hs-varop'>.</span><span class='hs-conid'>LPat</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-716"></a><span class='hs-definition'>cvtPat</span> <span class='hs-varid'>pat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapL</span> <span class='hs-layout'>(</span><span class='hs-varid'>cvtp</span> <span class='hs-varid'>pat</span><span class='hs-layout'>)</span>
<a name="line-717"></a>
<a name="line-718"></a><a name="cvtp"></a><span class='hs-definition'>cvtp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Pat</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Hs</span><span class='hs-varop'>.</span><span class='hs-conid'>Pat</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-719"></a><span class='hs-definition'>cvtp</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>LitP</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-720"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>overloadedLit</span> <span class='hs-varid'>l</span>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>l'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtOverLit</span> <span class='hs-varid'>l</span>
<a name="line-721"></a>		 	    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNPat</span> <span class='hs-varid'>l'</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-722"></a>		 		  <span class='hs-comment'>-- Not right for negative patterns; </span>
<a name="line-723"></a>		 		  <span class='hs-comment'>-- need to think about that!</span>
<a name="line-724"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>	       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>l'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtLit</span> <span class='hs-varid'>l</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Hs</span><span class='hs-varop'>.</span><span class='hs-conid'>LitPat</span> <span class='hs-varid'>l'</span> <span class='hs-layout'>}</span>
<a name="line-725"></a><span class='hs-definition'>cvtp</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>VarP</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>s'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>vName</span> <span class='hs-varid'>s</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Hs</span><span class='hs-varop'>.</span><span class='hs-conid'>VarPat</span> <span class='hs-varid'>s'</span> <span class='hs-layout'>}</span>
<a name="line-726"></a><span class='hs-definition'>cvtp</span> <span class='hs-layout'>(</span><span class='hs-conid'>TupP</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>p'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtPat</span> <span class='hs-varid'>p</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ParPat</span> <span class='hs-varid'>p'</span> <span class='hs-layout'>}</span> <span class='hs-comment'>-- Note [Dropping constructors]</span>
<a name="line-727"></a><span class='hs-definition'>cvtp</span> <span class='hs-layout'>(</span><span class='hs-conid'>TupP</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ps'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtPats</span> <span class='hs-varid'>ps</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TuplePat</span> <span class='hs-varid'>ps'</span> <span class='hs-conid'>Boxed</span> <span class='hs-varid'>void</span> <span class='hs-layout'>}</span>
<a name="line-728"></a><span class='hs-definition'>cvtp</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnboxedTupP</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ps'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtPats</span> <span class='hs-varid'>ps</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TuplePat</span> <span class='hs-varid'>ps'</span> <span class='hs-conid'>Unboxed</span> <span class='hs-varid'>void</span> <span class='hs-layout'>}</span>
<a name="line-729"></a><span class='hs-definition'>cvtp</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConP</span> <span class='hs-varid'>s</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>s'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cNameL</span> <span class='hs-varid'>s</span><span class='hs-layout'>;</span> <span class='hs-varid'>ps'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtPats</span> <span class='hs-varid'>ps</span>
<a name="line-730"></a>                            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ConPatIn</span> <span class='hs-varid'>s'</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrefixCon</span> <span class='hs-varid'>ps'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-731"></a><span class='hs-definition'>cvtp</span> <span class='hs-layout'>(</span><span class='hs-conid'>InfixP</span> <span class='hs-varid'>p1</span> <span class='hs-varid'>s</span> <span class='hs-varid'>p2</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>s'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cNameL</span> <span class='hs-varid'>s</span><span class='hs-layout'>;</span> <span class='hs-varid'>p1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtPat</span> <span class='hs-varid'>p1</span><span class='hs-layout'>;</span> <span class='hs-varid'>p2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtPat</span> <span class='hs-varid'>p2</span>
<a name="line-732"></a>                            <span class='hs-layout'>;</span> <span class='hs-varid'>wrapParL</span> <span class='hs-conid'>ParPat</span> <span class='hs-varop'>$</span> 
<a name="line-733"></a>                              <span class='hs-conid'>ConPatIn</span> <span class='hs-varid'>s'</span> <span class='hs-layout'>(</span><span class='hs-conid'>InfixCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkParPat</span> <span class='hs-varid'>p1'</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkParPat</span> <span class='hs-varid'>p2'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-734"></a>			    <span class='hs-comment'>-- See Note [Operator association]</span>
<a name="line-735"></a><span class='hs-definition'>cvtp</span> <span class='hs-layout'>(</span><span class='hs-conid'>UInfixP</span> <span class='hs-varid'>p1</span> <span class='hs-varid'>s</span> <span class='hs-varid'>p2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>p1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtPat</span> <span class='hs-varid'>p1</span><span class='hs-layout'>;</span> <span class='hs-varid'>cvtOpAppP</span> <span class='hs-varid'>p1'</span> <span class='hs-varid'>s</span> <span class='hs-varid'>p2</span> <span class='hs-layout'>}</span> <span class='hs-comment'>-- Note [Converting UInfix]</span>
<a name="line-736"></a><span class='hs-definition'>cvtp</span> <span class='hs-layout'>(</span><span class='hs-conid'>ParensP</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>p'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtPat</span> <span class='hs-varid'>p</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ParPat</span> <span class='hs-varid'>p'</span> <span class='hs-layout'>}</span>
<a name="line-737"></a><span class='hs-definition'>cvtp</span> <span class='hs-layout'>(</span><span class='hs-conid'>TildeP</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>p'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtPat</span> <span class='hs-varid'>p</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>LazyPat</span> <span class='hs-varid'>p'</span> <span class='hs-layout'>}</span>
<a name="line-738"></a><span class='hs-definition'>cvtp</span> <span class='hs-layout'>(</span><span class='hs-conid'>BangP</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>p'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtPat</span> <span class='hs-varid'>p</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>BangPat</span> <span class='hs-varid'>p'</span> <span class='hs-layout'>}</span>
<a name="line-739"></a><span class='hs-definition'>cvtp</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>AsP</span> <span class='hs-varid'>s</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>s'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>vNameL</span> <span class='hs-varid'>s</span><span class='hs-layout'>;</span> <span class='hs-varid'>p'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtPat</span> <span class='hs-varid'>p</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>AsPat</span> <span class='hs-varid'>s'</span> <span class='hs-varid'>p'</span> <span class='hs-layout'>}</span>
<a name="line-740"></a><span class='hs-definition'>cvtp</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>WildP</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>WildPat</span> <span class='hs-varid'>void</span>
<a name="line-741"></a><span class='hs-definition'>cvtp</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecP</span> <span class='hs-varid'>c</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>c'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cNameL</span> <span class='hs-varid'>c</span><span class='hs-layout'>;</span> <span class='hs-varid'>fs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>cvtPatFld</span> <span class='hs-varid'>fs</span>
<a name="line-742"></a>		       	   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ConPatIn</span> <span class='hs-varid'>c'</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Hs</span><span class='hs-varop'>.</span><span class='hs-conid'>RecCon</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecFields</span> <span class='hs-varid'>fs'</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-743"></a><span class='hs-definition'>cvtp</span> <span class='hs-layout'>(</span><span class='hs-conid'>ListP</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ps'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtPats</span> <span class='hs-varid'>ps</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ListPat</span> <span class='hs-varid'>ps'</span> <span class='hs-varid'>void</span> <span class='hs-layout'>}</span>
<a name="line-744"></a><span class='hs-definition'>cvtp</span> <span class='hs-layout'>(</span><span class='hs-conid'>SigP</span> <span class='hs-varid'>p</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>p'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtPat</span> <span class='hs-varid'>p</span><span class='hs-layout'>;</span> <span class='hs-varid'>t'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtType</span> <span class='hs-varid'>t</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>SigPatIn</span> <span class='hs-varid'>p'</span> <span class='hs-varid'>t'</span> <span class='hs-layout'>}</span>
<a name="line-745"></a><span class='hs-definition'>cvtp</span> <span class='hs-layout'>(</span><span class='hs-conid'>ViewP</span> <span class='hs-varid'>e</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtl</span> <span class='hs-varid'>e</span><span class='hs-layout'>;</span> <span class='hs-varid'>p'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtPat</span> <span class='hs-varid'>p</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ViewPat</span> <span class='hs-varid'>e'</span> <span class='hs-varid'>p'</span> <span class='hs-varid'>void</span> <span class='hs-layout'>}</span>
<a name="line-746"></a>
<a name="line-747"></a><a name="cvtPatFld"></a><span class='hs-definition'>cvtPatFld</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Pat</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecField</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>LPat</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-748"></a><span class='hs-definition'>cvtPatFld</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-layout'>,</span><span class='hs-varid'>p</span><span class='hs-layout'>)</span>
<a name="line-749"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>s'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>vNameL</span> <span class='hs-varid'>s</span><span class='hs-layout'>;</span> <span class='hs-varid'>p'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtPat</span> <span class='hs-varid'>p</span>
<a name="line-750"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecField</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsRecFieldId</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s'</span><span class='hs-layout'>,</span> <span class='hs-varid'>hsRecFieldArg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>p'</span><span class='hs-layout'>,</span> <span class='hs-varid'>hsRecPun</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-751"></a>
<a name="line-752"></a><a name="cvtOpAppP"></a><span class='hs-comment'>{- | @cvtOpAppP x op y@ converts @op@ and @y@ and produces the operator application @x `op` y@.
<a name="line-753"></a>The produced tree of infix patterns will be left-biased, provided @x@ is.
<a name="line-754"></a>
<a name="line-755"></a>See the @cvtOpApp@ documentation for how this function works.
<a name="line-756"></a>-}</span>
<a name="line-757"></a><span class='hs-definition'>cvtOpAppP</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Hs</span><span class='hs-varop'>.</span><span class='hs-conid'>LPat</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Pat</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Hs</span><span class='hs-varop'>.</span><span class='hs-conid'>Pat</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-758"></a><span class='hs-definition'>cvtOpAppP</span> <span class='hs-varid'>x</span> <span class='hs-varid'>op1</span> <span class='hs-layout'>(</span><span class='hs-conid'>UInfixP</span> <span class='hs-varid'>y</span> <span class='hs-varid'>op2</span> <span class='hs-varid'>z</span><span class='hs-layout'>)</span>
<a name="line-759"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapL</span> <span class='hs-varop'>$</span> <span class='hs-varid'>cvtOpAppP</span> <span class='hs-varid'>x</span> <span class='hs-varid'>op1</span> <span class='hs-varid'>y</span>
<a name="line-760"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>cvtOpAppP</span> <span class='hs-varid'>l</span> <span class='hs-varid'>op2</span> <span class='hs-varid'>z</span> <span class='hs-layout'>}</span>
<a name="line-761"></a><span class='hs-definition'>cvtOpAppP</span> <span class='hs-varid'>x</span> <span class='hs-varid'>op</span> <span class='hs-varid'>y</span>
<a name="line-762"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>op'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cNameL</span> <span class='hs-varid'>op</span>
<a name="line-763"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>y'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtPat</span> <span class='hs-varid'>y</span>
<a name="line-764"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConPatIn</span> <span class='hs-varid'>op'</span> <span class='hs-layout'>(</span><span class='hs-conid'>InfixCon</span> <span class='hs-varid'>x</span> <span class='hs-varid'>y'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-765"></a>
<a name="line-766"></a><span class='hs-comment'>-----------------------------------------------------------</span>
<a name="line-767"></a><span class='hs-comment'>--	Types and type variables</span>
<a name="line-768"></a>
<a name="line-769"></a><a name="cvtTvs"></a><span class='hs-definition'>cvtTvs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TyVarBndr</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-770"></a><span class='hs-definition'>cvtTvs</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>cvt_tv</span> <span class='hs-varid'>tvs</span>
<a name="line-771"></a>
<a name="line-772"></a><a name="cvt_tv"></a><span class='hs-definition'>cvt_tv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TyVarBndr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-773"></a><span class='hs-definition'>cvt_tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>PlainTV</span> <span class='hs-varid'>nm</span><span class='hs-layout'>)</span> 
<a name="line-774"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>nm'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tName</span> <span class='hs-varid'>nm</span>
<a name="line-775"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>returnL</span> <span class='hs-varop'>$</span> <span class='hs-conid'>UserTyVar</span> <span class='hs-varid'>nm'</span> <span class='hs-varid'>placeHolderKind</span>
<a name="line-776"></a>       <span class='hs-layout'>}</span>
<a name="line-777"></a><span class='hs-definition'>cvt_tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>KindedTV</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>ki</span><span class='hs-layout'>)</span> 
<a name="line-778"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>nm'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tName</span> <span class='hs-varid'>nm</span>
<a name="line-779"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ki'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtKind</span> <span class='hs-varid'>ki</span>
<a name="line-780"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>returnL</span> <span class='hs-varop'>$</span> <span class='hs-conid'>KindedTyVar</span> <span class='hs-varid'>nm'</span> <span class='hs-varid'>ki'</span> <span class='hs-varid'>placeHolderKind</span>
<a name="line-781"></a>       <span class='hs-layout'>}</span>
<a name="line-782"></a>
<a name="line-783"></a><a name="cvtContext"></a><span class='hs-definition'>cvtContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Cxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsContext</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-784"></a><span class='hs-definition'>cvtContext</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>preds'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>cvtPred</span> <span class='hs-varid'>tys</span><span class='hs-layout'>;</span> <span class='hs-varid'>returnL</span> <span class='hs-varid'>preds'</span> <span class='hs-layout'>}</span>
<a name="line-785"></a>
<a name="line-786"></a><a name="cvtPred"></a><span class='hs-definition'>cvtPred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Pred</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-787"></a><span class='hs-definition'>cvtPred</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ClassP</span> <span class='hs-varid'>cla</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-788"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cla'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isVarName</span> <span class='hs-varid'>cla</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>tName</span> <span class='hs-varid'>cla</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>tconName</span> <span class='hs-varid'>cla</span>
<a name="line-789"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>cvtType</span> <span class='hs-varid'>tys</span>
<a name="line-790"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mk_apps</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-varid'>cla'</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys'</span>
<a name="line-791"></a>       <span class='hs-layout'>}</span>
<a name="line-792"></a><span class='hs-definition'>cvtPred</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>EqualP</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-793"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtType</span> <span class='hs-varid'>ty1</span>
<a name="line-794"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtType</span> <span class='hs-varid'>ty2</span>
<a name="line-795"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>returnL</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsEqTy</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2'</span>
<a name="line-796"></a>       <span class='hs-layout'>}</span>
<a name="line-797"></a>
<a name="line-798"></a><a name="cvtType"></a><span class='hs-definition'>cvtType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-799"></a><span class='hs-definition'>cvtType</span> <span class='hs-varid'>ty</span> 
<a name="line-800"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>head_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>split_ty_app</span> <span class='hs-varid'>ty</span>
<a name="line-801"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>head_ty</span> <span class='hs-keyword'>of</span>
<a name="line-802"></a>           <span class='hs-conid'>TupleT</span> <span class='hs-varid'>n</span> 
<a name="line-803"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys'</span> <span class='hs-varop'>==</span> <span class='hs-varid'>n</span> 	<span class='hs-comment'>-- Saturated</span>
<a name="line-804"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>n</span><span class='hs-varop'>==</span><span class='hs-num'>1</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span>	<span class='hs-comment'>-- Singleton tuples treated </span>
<a name="line-805"></a>                                                <span class='hs-comment'>-- like nothing (ie just parens)</span>
<a name="line-806"></a>                        <span class='hs-keyword'>else</span> <span class='hs-varid'>returnL</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTupleTy</span> <span class='hs-conid'>HsBoxedTuple</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span>
<a name="line-807"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>==</span> <span class='hs-num'>1</span>    
<a name="line-808"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWith</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal 1-tuple type constructor"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-809"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> 
<a name="line-810"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mk_apps</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>getRdrName</span> <span class='hs-layout'>(</span><span class='hs-varid'>tupleTyCon</span> <span class='hs-conid'>BoxedTuple</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys'</span>
<a name="line-811"></a>           <span class='hs-conid'>UnboxedTupleT</span> <span class='hs-varid'>n</span>
<a name="line-812"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys'</span> <span class='hs-varop'>==</span> <span class='hs-varid'>n</span> 	<span class='hs-comment'>-- Saturated</span>
<a name="line-813"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>n</span><span class='hs-varop'>==</span><span class='hs-num'>1</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span>	<span class='hs-comment'>-- Singleton tuples treated</span>
<a name="line-814"></a>                                                <span class='hs-comment'>-- like nothing (ie just parens)</span>
<a name="line-815"></a>                        <span class='hs-keyword'>else</span> <span class='hs-varid'>returnL</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTupleTy</span> <span class='hs-conid'>HsUnboxedTuple</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span>
<a name="line-816"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-817"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mk_apps</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>getRdrName</span> <span class='hs-layout'>(</span><span class='hs-varid'>tupleTyCon</span> <span class='hs-conid'>UnboxedTuple</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys'</span>
<a name="line-818"></a>           <span class='hs-conid'>ArrowT</span> 
<a name="line-819"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>x'</span><span class='hs-layout'>,</span><span class='hs-varid'>y'</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tys'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>returnL</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsFunTy</span> <span class='hs-varid'>x'</span> <span class='hs-varid'>y'</span><span class='hs-layout'>)</span>
<a name="line-820"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mk_apps</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>getRdrName</span> <span class='hs-varid'>funTyCon</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys'</span>
<a name="line-821"></a>           <span class='hs-conid'>ListT</span>  
<a name="line-822"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>x'</span><span class='hs-keyglyph'>]</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tys'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>returnL</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsListTy</span> <span class='hs-varid'>x'</span><span class='hs-layout'>)</span>
<a name="line-823"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mk_apps</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>getRdrName</span> <span class='hs-varid'>listTyCon</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys'</span>
<a name="line-824"></a>           <span class='hs-conid'>VarT</span> <span class='hs-varid'>nm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>nm'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tName</span> <span class='hs-varid'>nm</span><span class='hs-layout'>;</span>    <span class='hs-varid'>mk_apps</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-varid'>nm'</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys'</span> <span class='hs-layout'>}</span>
<a name="line-825"></a>           <span class='hs-conid'>ConT</span> <span class='hs-varid'>nm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>nm'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tconName</span> <span class='hs-varid'>nm</span><span class='hs-layout'>;</span> <span class='hs-varid'>mk_apps</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-varid'>nm'</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys'</span> <span class='hs-layout'>}</span>
<a name="line-826"></a>
<a name="line-827"></a>           <span class='hs-conid'>ForallT</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cxt</span> <span class='hs-varid'>ty</span> 
<a name="line-828"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>tys'</span> 
<a name="line-829"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tvs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtTvs</span> <span class='hs-varid'>tvs</span>
<a name="line-830"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>cxt'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtContext</span> <span class='hs-varid'>cxt</span>
<a name="line-831"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtType</span> <span class='hs-varid'>ty</span>
<a name="line-832"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>returnL</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkExplicitHsForAllTy</span> <span class='hs-varid'>tvs'</span> <span class='hs-varid'>cxt'</span> <span class='hs-varid'>ty'</span> 
<a name="line-833"></a>                   <span class='hs-layout'>}</span>
<a name="line-834"></a>
<a name="line-835"></a>           <span class='hs-conid'>SigT</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ki</span>
<a name="line-836"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtType</span> <span class='hs-varid'>ty</span>
<a name="line-837"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>ki'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtKind</span> <span class='hs-varid'>ki</span>
<a name="line-838"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>mk_apps</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsKindSig</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>ki'</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys'</span>
<a name="line-839"></a>                   <span class='hs-layout'>}</span>
<a name="line-840"></a>
<a name="line-841"></a>           <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWith</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Malformed type"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-842"></a>    <span class='hs-layout'>}</span>
<a name="line-843"></a>
<a name="line-844"></a><a name="mk_apps"></a><span class='hs-definition'>mk_apps</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-845"></a><span class='hs-definition'>mk_apps</span> <span class='hs-varid'>head_ty</span> <span class='hs-conid'>[]</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>returnL</span> <span class='hs-varid'>head_ty</span>
<a name="line-846"></a><span class='hs-definition'>mk_apps</span> <span class='hs-varid'>head_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-conop'>:</span><span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>head_ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>returnL</span> <span class='hs-varid'>head_ty</span>
<a name="line-847"></a>                              <span class='hs-layout'>;</span> <span class='hs-varid'>mk_apps</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsAppTy</span> <span class='hs-varid'>head_ty'</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span>
<a name="line-848"></a>
<a name="line-849"></a><a name="split_ty_app"></a><span class='hs-definition'>split_ty_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-850"></a><span class='hs-definition'>split_ty_app</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>[]</span>
<a name="line-851"></a>  <span class='hs-keyword'>where</span>
<a name="line-852"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppT</span> <span class='hs-varid'>f</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-varid'>as'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>a'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtType</span> <span class='hs-varid'>a</span><span class='hs-layout'>;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>a'</span><span class='hs-conop'>:</span><span class='hs-varid'>as'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-853"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>f</span> <span class='hs-keyword'>as</span> 	      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span><span class='hs-layout'>,</span><span class='hs-keyword'>as</span><span class='hs-layout'>)</span>
<a name="line-854"></a>
<a name="line-855"></a><a name="cvtKind"></a><span class='hs-definition'>cvtKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsKind</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-856"></a><span class='hs-definition'>cvtKind</span> <span class='hs-conid'>StarK</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>returnL</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>getRdrName</span> <span class='hs-varid'>liftedTypeKindTyCon</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-857"></a><span class='hs-definition'>cvtKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArrowK</span> <span class='hs-varid'>k1</span> <span class='hs-varid'>k2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-858"></a>  <span class='hs-varid'>k1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtKind</span> <span class='hs-varid'>k1</span>
<a name="line-859"></a>  <span class='hs-varid'>k2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cvtKind</span> <span class='hs-varid'>k2</span>
<a name="line-860"></a>  <span class='hs-varid'>returnL</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsFunTy</span> <span class='hs-varid'>k1'</span> <span class='hs-varid'>k2'</span><span class='hs-layout'>)</span>
<a name="line-861"></a>
<a name="line-862"></a><a name="cvtMaybeKind"></a><span class='hs-definition'>cvtMaybeKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsKind</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-863"></a><span class='hs-definition'>cvtMaybeKind</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-864"></a><span class='hs-definition'>cvtMaybeKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>ki</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cvtKind</span> <span class='hs-varid'>ki</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-conid'>Just</span>
<a name="line-865"></a>
<a name="line-866"></a><span class='hs-comment'>-----------------------------------------------------------</span>
<a name="line-867"></a>
<a name="line-868"></a>
<a name="line-869"></a><span class='hs-comment'>-----------------------------------------------------------</span>
<a name="line-870"></a><span class='hs-comment'>-- some useful things</span>
<a name="line-871"></a>
<a name="line-872"></a><a name="overloadedLit"></a><span class='hs-definition'>overloadedLit</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Lit</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-873"></a><span class='hs-comment'>-- True for literals that Haskell treats as overloaded</span>
<a name="line-874"></a><span class='hs-definition'>overloadedLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>IntegerL</span>  <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-875"></a><span class='hs-definition'>overloadedLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>RationalL</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-876"></a><span class='hs-definition'>overloadedLit</span> <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-877"></a>
<a name="line-878"></a><a name="void"></a><span class='hs-definition'>void</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span>
<a name="line-879"></a><span class='hs-definition'>void</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>placeHolderType</span>
<a name="line-880"></a>
<a name="line-881"></a><a name="cvtFractionalLit"></a><span class='hs-definition'>cvtFractionalLit</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Rational</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FractionalLit</span>
<a name="line-882"></a><span class='hs-definition'>cvtFractionalLit</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fl_text</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromRational</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Double</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fl_value</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span> <span class='hs-layout'>}</span>
<a name="line-883"></a>
<a name="line-884"></a><span class='hs-comment'>--------------------------------------------------------------------</span>
<a name="line-885"></a><span class='hs-comment'>--	Turning Name back into RdrName</span>
<a name="line-886"></a><span class='hs-comment'>--------------------------------------------------------------------</span>
<a name="line-887"></a>
<a name="line-888"></a><a name="vNameL"></a><span class='hs-comment'>-- variable names</span>
<a name="line-889"></a><span class='hs-definition'>vNameL</span><span class='hs-layout'>,</span> <span class='hs-varid'>cNameL</span><span class='hs-layout'>,</span> <span class='hs-varid'>tconNameL</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Located</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-890"></a><a name="vName"></a><span class='hs-definition'>vName</span><span class='hs-layout'>,</span>  <span class='hs-varid'>cName</span><span class='hs-layout'>,</span>  <span class='hs-varid'>tName</span><span class='hs-layout'>,</span>  <span class='hs-varid'>tconName</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-conid'>RdrName</span>
<a name="line-891"></a>
<a name="line-892"></a><span class='hs-definition'>vNameL</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapL</span> <span class='hs-layout'>(</span><span class='hs-varid'>vName</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-893"></a><span class='hs-definition'>vName</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cvtName</span> <span class='hs-conid'>OccName</span><span class='hs-varop'>.</span><span class='hs-varid'>varName</span> <span class='hs-varid'>n</span>
<a name="line-894"></a>
<a name="line-895"></a><a name="cNameL"></a><span class='hs-comment'>-- Constructor function names; this is Haskell source, hence srcDataName</span>
<a name="line-896"></a><span class='hs-definition'>cNameL</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapL</span> <span class='hs-layout'>(</span><span class='hs-varid'>cName</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-897"></a><a name="cName"></a><span class='hs-definition'>cName</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cvtName</span> <span class='hs-conid'>OccName</span><span class='hs-varop'>.</span><span class='hs-varid'>dataName</span> <span class='hs-varid'>n</span> 
<a name="line-898"></a>
<a name="line-899"></a><a name="tName"></a><span class='hs-comment'>-- Type variable names</span>
<a name="line-900"></a><span class='hs-definition'>tName</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cvtName</span> <span class='hs-conid'>OccName</span><span class='hs-varop'>.</span><span class='hs-varid'>tvName</span> <span class='hs-varid'>n</span>
<a name="line-901"></a>
<a name="line-902"></a><a name="tconNameL"></a><span class='hs-comment'>-- Type Constructor names</span>
<a name="line-903"></a><span class='hs-definition'>tconNameL</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapL</span> <span class='hs-layout'>(</span><span class='hs-varid'>tconName</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-904"></a><a name="tconName"></a><span class='hs-definition'>tconName</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cvtName</span> <span class='hs-conid'>OccName</span><span class='hs-varop'>.</span><span class='hs-varid'>tcClsName</span> <span class='hs-varid'>n</span>
<a name="line-905"></a>
<a name="line-906"></a><a name="cvtName"></a><span class='hs-definition'>cvtName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OccName</span><span class='hs-varop'>.</span><span class='hs-conid'>NameSpace</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvtM</span> <span class='hs-conid'>RdrName</span>
<a name="line-907"></a><span class='hs-definition'>cvtName</span> <span class='hs-varid'>ctxt_ns</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>flavour</span><span class='hs-layout'>)</span>
<a name="line-908"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>okOcc</span> <span class='hs-varid'>ctxt_ns</span> <span class='hs-varid'>occ_str</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWith</span> <span class='hs-layout'>(</span><span class='hs-varid'>badOcc</span> <span class='hs-varid'>ctxt_ns</span> <span class='hs-varid'>occ_str</span><span class='hs-layout'>)</span>
<a name="line-909"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> 		        
<a name="line-910"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getL</span>
<a name="line-911"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>rdr_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>thRdrName</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>ctxt_ns</span> <span class='hs-varid'>occ_str</span> <span class='hs-varid'>flavour</span> 
<a name="line-912"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>force</span> <span class='hs-varid'>rdr_name</span> 
<a name="line-913"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>rdr_name</span> <span class='hs-layout'>}</span>
<a name="line-914"></a>  <span class='hs-keyword'>where</span>
<a name="line-915"></a>    <span class='hs-varid'>occ_str</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>occString</span> <span class='hs-varid'>occ</span>
<a name="line-916"></a>
<a name="line-917"></a><a name="okOcc"></a><span class='hs-definition'>okOcc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OccName</span><span class='hs-varop'>.</span><span class='hs-conid'>NameSpace</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-918"></a><span class='hs-definition'>okOcc</span> <span class='hs-keyword'>_</span>  <span class='hs-conid'>[]</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-919"></a><span class='hs-definition'>okOcc</span> <span class='hs-varid'>ns</span> <span class='hs-varid'>str</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>c</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> 
<a name="line-920"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>OccName</span><span class='hs-varop'>.</span><span class='hs-varid'>isVarNameSpace</span> <span class='hs-varid'>ns</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>startsVarId</span> <span class='hs-varid'>c</span> <span class='hs-varop'>||</span> <span class='hs-varid'>startsVarSym</span> <span class='hs-varid'>c</span>
<a name="line-921"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> 	 	      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>startsConId</span> <span class='hs-varid'>c</span> <span class='hs-varop'>||</span> <span class='hs-varid'>startsConSym</span> <span class='hs-varid'>c</span> <span class='hs-varop'>||</span> <span class='hs-varid'>str</span> <span class='hs-varop'>==</span> <span class='hs-str'>"[]"</span>
<a name="line-922"></a>
<a name="line-923"></a><a name="isVarName"></a><span class='hs-comment'>-- Determine the name space of a name in a type</span>
<a name="line-924"></a><span class='hs-comment'>--</span>
<a name="line-925"></a><span class='hs-definition'>isVarName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-926"></a><span class='hs-definition'>isVarName</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-varid'>occ</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-927"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>occString</span> <span class='hs-varid'>occ</span> <span class='hs-keyword'>of</span>
<a name="line-928"></a>      <span class='hs-str'>""</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-929"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>c</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>startsVarId</span> <span class='hs-varid'>c</span> <span class='hs-varop'>||</span> <span class='hs-varid'>startsVarSym</span> <span class='hs-varid'>c</span>
<a name="line-930"></a>
<a name="line-931"></a><a name="badOcc"></a><span class='hs-definition'>badOcc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OccName</span><span class='hs-varop'>.</span><span class='hs-conid'>NameSpace</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-932"></a><span class='hs-definition'>badOcc</span> <span class='hs-varid'>ctxt_ns</span> <span class='hs-varid'>occ</span> 
<a name="line-933"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprNameSpace</span> <span class='hs-varid'>ctxt_ns</span>
<a name="line-934"></a>	<span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"name:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span>
<a name="line-935"></a>
<a name="line-936"></a><a name="thRdrName"></a><span class='hs-definition'>thRdrName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OccName</span><span class='hs-varop'>.</span><span class='hs-conid'>NameSpace</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>NameFlavour</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RdrName</span>
<a name="line-937"></a><span class='hs-comment'>-- This turns a TH Name into a RdrName; used for both binders and occurrences</span>
<a name="line-938"></a><span class='hs-comment'>-- See Note [Binders in Template Haskell]</span>
<a name="line-939"></a><span class='hs-comment'>-- The passed-in name space tells what the context is expecting;</span>
<a name="line-940"></a><span class='hs-comment'>--	use it unless the TH name knows what name-space it comes</span>
<a name="line-941"></a><span class='hs-comment'>-- 	from, in which case use the latter</span>
<a name="line-942"></a><span class='hs-comment'>--</span>
<a name="line-943"></a><span class='hs-comment'>-- We pass in a SrcSpan (gotten from the monad) because this function</span>
<a name="line-944"></a><span class='hs-comment'>-- is used for *binders* and if we make an Exact Name we want it</span>
<a name="line-945"></a><span class='hs-comment'>-- to have a binding site inside it.  (cf Trac #5434)</span>
<a name="line-946"></a><span class='hs-comment'>--</span>
<a name="line-947"></a><span class='hs-comment'>-- ToDo: we may generate silly RdrNames, by passing a name space</span>
<a name="line-948"></a><span class='hs-comment'>--       that doesn't match the string, like VarName ":+", </span>
<a name="line-949"></a><span class='hs-comment'>-- 	 which will give confusing error messages later</span>
<a name="line-950"></a><span class='hs-comment'>-- </span>
<a name="line-951"></a><span class='hs-comment'>-- The strict applications ensure that any buried exceptions get forced</span>
<a name="line-952"></a><span class='hs-definition'>thRdrName</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>ctxt_ns</span> <span class='hs-varid'>th_occ</span> <span class='hs-varid'>th_name</span>
<a name="line-953"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>th_name</span> <span class='hs-keyword'>of</span>
<a name="line-954"></a>     <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>NameG</span> <span class='hs-varid'>th_ns</span> <span class='hs-varid'>pkg</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>thOrigRdrName</span> <span class='hs-varid'>th_occ</span> <span class='hs-varid'>th_ns</span> <span class='hs-varid'>pkg</span> <span class='hs-varid'>mod</span>
<a name="line-955"></a>     <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>NameQ</span> <span class='hs-varid'>mod</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkRdrQual</span>  <span class='hs-varop'>$!</span> <span class='hs-varid'>mk_mod</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>occ</span>
<a name="line-956"></a>     <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>NameL</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>nameRdrName</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-varop'>.</span><span class='hs-varid'>mkInternalName</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>mk_uniq</span> <span class='hs-varid'>uniq</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-957"></a>     <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>NameU</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>nameRdrName</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-varop'>.</span><span class='hs-varid'>mkSystemNameAt</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>mk_uniq</span> <span class='hs-varid'>uniq</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-958"></a>     <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>NameS</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isBuiltInOcc</span> <span class='hs-varid'>ctxt_ns</span> <span class='hs-varid'>th_occ</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>nameRdrName</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>name</span>
<a name="line-959"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>			         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRdrUnqual</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>occ</span>
<a name="line-960"></a>  <span class='hs-keyword'>where</span>
<a name="line-961"></a>    <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OccName</span><span class='hs-varop'>.</span><span class='hs-conid'>OccName</span>
<a name="line-962"></a>    <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_occ</span> <span class='hs-varid'>ctxt_ns</span> <span class='hs-varid'>th_occ</span>
<a name="line-963"></a>
<a name="line-964"></a><a name="thOrigRdrName"></a><span class='hs-definition'>thOrigRdrName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>NameSpace</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PkgName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RdrName</span>
<a name="line-965"></a><span class='hs-definition'>thOrigRdrName</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>th_ns</span> <span class='hs-varid'>pkg</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkOrig</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkModule</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_pkg</span> <span class='hs-varid'>pkg</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_mod</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_occ</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_ghc_ns</span> <span class='hs-varid'>th_ns</span><span class='hs-layout'>)</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span>
<a name="line-966"></a>
<a name="line-967"></a><a name="thRdrNameGuesses"></a><span class='hs-definition'>thRdrNameGuesses</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-968"></a><span class='hs-definition'>thRdrNameGuesses</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>flavour</span><span class='hs-layout'>)</span>
<a name="line-969"></a>  <span class='hs-comment'>-- This special case for NameG ensures that we don't generate duplicates in the output list</span>
<a name="line-970"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>NameG</span> <span class='hs-varid'>th_ns</span> <span class='hs-varid'>pkg</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>flavour</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>thOrigRdrName</span> <span class='hs-varid'>occ_str</span> <span class='hs-varid'>th_ns</span> <span class='hs-varid'>pkg</span> <span class='hs-varid'>mod</span><span class='hs-keyglyph'>]</span>
<a name="line-971"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                         <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>thRdrName</span> <span class='hs-varid'>noSrcSpan</span> <span class='hs-varid'>gns</span> <span class='hs-varid'>occ_str</span> <span class='hs-varid'>flavour</span>
<a name="line-972"></a>			                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>gns</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>guessed_nss</span><span class='hs-keyglyph'>]</span>
<a name="line-973"></a>  <span class='hs-keyword'>where</span>
<a name="line-974"></a>    <span class='hs-comment'>-- guessed_ns are the name spaces guessed from looking at the TH name</span>
<a name="line-975"></a>    <span class='hs-varid'>guessed_nss</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isLexCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFastString</span> <span class='hs-varid'>occ_str</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>OccName</span><span class='hs-varop'>.</span><span class='hs-varid'>tcName</span><span class='hs-layout'>,</span>  <span class='hs-conid'>OccName</span><span class='hs-varop'>.</span><span class='hs-varid'>dataName</span><span class='hs-keyglyph'>]</span>
<a name="line-976"></a>	        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>			  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>OccName</span><span class='hs-varop'>.</span><span class='hs-varid'>varName</span><span class='hs-layout'>,</span> <span class='hs-conid'>OccName</span><span class='hs-varop'>.</span><span class='hs-varid'>tvName</span><span class='hs-keyglyph'>]</span>
<a name="line-977"></a>    <span class='hs-varid'>occ_str</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>occString</span> <span class='hs-varid'>occ</span>
<a name="line-978"></a>
<a name="line-979"></a><a name="isBuiltInOcc"></a><span class='hs-definition'>isBuiltInOcc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OccName</span><span class='hs-varop'>.</span><span class='hs-conid'>NameSpace</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Name</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span>
<a name="line-980"></a><span class='hs-comment'>-- Built in syntax isn't "in scope" so an Unqual RdrName won't do</span>
<a name="line-981"></a><span class='hs-comment'>-- We must generate an Exact name, just as the parser does</span>
<a name="line-982"></a><span class='hs-definition'>isBuiltInOcc</span> <span class='hs-varid'>ctxt_ns</span> <span class='hs-varid'>occ</span>
<a name="line-983"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>occ</span> <span class='hs-keyword'>of</span>
<a name="line-984"></a>	<span class='hs-str'>":"</span> 		 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-varop'>.</span><span class='hs-varid'>getName</span> <span class='hs-varid'>consDataCon</span><span class='hs-layout'>)</span>
<a name="line-985"></a>	<span class='hs-str'>"[]"</span>		 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-varop'>.</span><span class='hs-varid'>getName</span> <span class='hs-varid'>nilDataCon</span><span class='hs-layout'>)</span>
<a name="line-986"></a>	<span class='hs-str'>"()"</span>		 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tup_name</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span>
<a name="line-987"></a>	<span class='hs-chr'>'('</span> <span class='hs-conop'>:</span> <span class='hs-chr'>','</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rest</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go_tuple</span> <span class='hs-num'>2</span> <span class='hs-varid'>rest</span>
<a name="line-988"></a>	<span class='hs-keyword'>_</span>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-989"></a>  <span class='hs-keyword'>where</span>
<a name="line-990"></a>    <span class='hs-varid'>go_tuple</span> <span class='hs-varid'>n</span> <span class='hs-str'>")"</span> 	    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tup_name</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-991"></a>    <span class='hs-varid'>go_tuple</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-chr'>','</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_tuple</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>rest</span>
<a name="line-992"></a>    <span class='hs-varid'>go_tuple</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-993"></a>
<a name="line-994"></a>    <span class='hs-varid'>tup_name</span> <span class='hs-varid'>n</span> 
<a name="line-995"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-conid'>OccName</span><span class='hs-varop'>.</span><span class='hs-varid'>isTcClsNameSpace</span> <span class='hs-varid'>ctxt_ns</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Name</span><span class='hs-varop'>.</span><span class='hs-varid'>getName</span> <span class='hs-layout'>(</span><span class='hs-varid'>tupleTyCon</span> <span class='hs-conid'>BoxedTuple</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-996"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> 		           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Name</span><span class='hs-varop'>.</span><span class='hs-varid'>getName</span> <span class='hs-layout'>(</span><span class='hs-varid'>tupleCon</span> <span class='hs-conid'>BoxedTuple</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-997"></a>
<a name="line-998"></a><a name="mk_occ"></a><span class='hs-comment'>-- The packing and unpacking is rather turgid :-(</span>
<a name="line-999"></a><span class='hs-definition'>mk_occ</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OccName</span><span class='hs-varop'>.</span><span class='hs-conid'>NameSpace</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OccName</span><span class='hs-varop'>.</span><span class='hs-conid'>OccName</span>
<a name="line-1000"></a><span class='hs-definition'>mk_occ</span> <span class='hs-varid'>ns</span> <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OccName</span><span class='hs-varop'>.</span><span class='hs-varid'>mkOccName</span> <span class='hs-varid'>ns</span> <span class='hs-varid'>occ</span>
<a name="line-1001"></a>
<a name="line-1002"></a><a name="mk_ghc_ns"></a><span class='hs-definition'>mk_ghc_ns</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>NameSpace</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OccName</span><span class='hs-varop'>.</span><span class='hs-conid'>NameSpace</span>
<a name="line-1003"></a><span class='hs-definition'>mk_ghc_ns</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>DataName</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OccName</span><span class='hs-varop'>.</span><span class='hs-varid'>dataName</span>
<a name="line-1004"></a><span class='hs-definition'>mk_ghc_ns</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>TcClsName</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OccName</span><span class='hs-varop'>.</span><span class='hs-varid'>tcClsName</span>
<a name="line-1005"></a><span class='hs-definition'>mk_ghc_ns</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>VarName</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OccName</span><span class='hs-varop'>.</span><span class='hs-varid'>varName</span>
<a name="line-1006"></a>
<a name="line-1007"></a><a name="mk_mod"></a><span class='hs-definition'>mk_mod</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>ModName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModuleName</span>
<a name="line-1008"></a><span class='hs-definition'>mk_mod</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkModuleName</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>modString</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span>
<a name="line-1009"></a>
<a name="line-1010"></a><a name="mk_pkg"></a><span class='hs-definition'>mk_pkg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>PkgName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PackageId</span>
<a name="line-1011"></a><span class='hs-definition'>mk_pkg</span> <span class='hs-varid'>pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stringToPackageId</span> <span class='hs-layout'>(</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-varid'>pkgString</span> <span class='hs-varid'>pkg</span><span class='hs-layout'>)</span>
<a name="line-1012"></a>
<a name="line-1013"></a><a name="mk_uniq"></a><span class='hs-definition'>mk_uniq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span><span class='hs-cpp'>#</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span>
<a name="line-1014"></a><span class='hs-definition'>mk_uniq</span> <span class='hs-varid'>u</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUniqueGrimily</span> <span class='hs-layout'>(</span><span class='hs-conid'>I</span><span class='hs-cpp'>#</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span>
</pre>\end{code}

Note [Binders in Template Haskell]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this TH term construction:
  do { x1 <- TH.newName "x"   -- newName :: String -> Q TH.Name
     ; x2 <- TH.newName "x"   -- Builds a NameU
     ; x3 <- TH.newName "x"

     ; let x = mkName "x"     -- mkName :: String -> TH.Name
       	       	      	      -- Builds a NameL

     ; return (LamE (..pattern [x1,x2]..) $
               LamE (VarPat x3) $
               ..tuple (x1,x2,x3,x)) }

It represents the term   \[x1,x2]. \x3. (x1,x2,x3,x)

a) We don't want to complain about "x" being bound twice in 
   the pattern [x1,x2]
b) We don't want x3 to shadow the x1,x2
c) We *do* want 'x' (dynamically bound with mkName) to bind 
   to the innermost binding of "x", namely x3.
d) When pretty printing, we want to print a unique with x1,x2 
   etc, else they'll all print as "x" which isn't very helpful

When we convert all this to HsSyn, the TH.Names are converted with
thRdrName.  To achieve (b) we want the binders to be Exact RdrNames.
Achieving (a) is a bit awkward, because
   - We must check for duplicate and shadowed names on Names, 
     not RdrNames, *after* renaming.   
     See Note [Collect binders only after renaming] in HsUtils

   - But to achieve (a) we must distinguish between the Exact
     RdrNames arising from TH and the Unqual RdrNames that would
     come from a user writing \[x,x] -> blah

So in Convert.thRdrName we translate
   TH Name		            RdrName
   --------------------------------------------------------
   NameU (arising from newName) --> Exact (Name{ System })
   NameS (arising from mkName)  --> Unqual

Notice that the NameUs generate *System* Names.  Then, when
figuring out shadowing and duplicates, we can filter out
System Names.

This use of System Names fits with other uses of System Names, eg for
temporary variables "a". Since there are lots of things called "a" we
usually want to print the name with the unique, and that is indeed
the way System Names are printed.

There's a small complication of course; see Note [Looking up Exact
RdrNames] in RnEnv.
</body>
</html>
