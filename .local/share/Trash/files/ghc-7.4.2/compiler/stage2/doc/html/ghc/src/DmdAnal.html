<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>stranal/DmdAnal.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The GRASP/AQUA Project, Glasgow University, 1993-1998
%

			-----------------
			A demand analysis
			-----------------

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>DmdAnal</span> <span class='hs-layout'>(</span> <span class='hs-varid'>dmdAnalPgm</span><span class='hs-layout'>,</span> <span class='hs-varid'>dmdAnalTopRhs</span><span class='hs-layout'>,</span> 
<a name="line-9"></a>		 <span class='hs-varid'>both</span> <span class='hs-comment'>{- needed by WwLib -}</span>
<a name="line-10"></a>   <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-13"></a>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>		<span class='hs-layout'>(</span> <span class='hs-conid'>DynFlags</span> <span class='hs-layout'>)</span>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>StaticFlags</span>	<span class='hs-layout'>(</span> <span class='hs-varid'>opt_MaxWorkerArgs</span> <span class='hs-layout'>)</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Demand</span>	<span class='hs-comment'>-- All of it</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreSyn</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PprCore</span>	
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Coercion</span>		<span class='hs-layout'>(</span> <span class='hs-varid'>isCoVarType</span> <span class='hs-layout'>)</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreUtils</span>	<span class='hs-layout'>(</span> <span class='hs-varid'>exprIsHNF</span><span class='hs-layout'>,</span> <span class='hs-varid'>exprIsTrivial</span> <span class='hs-layout'>)</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreArity</span>	<span class='hs-layout'>(</span> <span class='hs-varid'>exprArity</span> <span class='hs-layout'>)</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>		<span class='hs-layout'>(</span> <span class='hs-varid'>dataConTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConRepStrictness</span> <span class='hs-layout'>)</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>		<span class='hs-layout'>(</span> <span class='hs-varid'>isProductTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>isRecursiveTyCon</span> <span class='hs-layout'>)</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>		<span class='hs-layout'>(</span> <span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-varid'>idType</span><span class='hs-layout'>,</span> <span class='hs-varid'>idInlineActivation</span><span class='hs-layout'>,</span>
<a name="line-25"></a>			  <span class='hs-varid'>isDataConWorkId</span><span class='hs-layout'>,</span> <span class='hs-varid'>isGlobalId</span><span class='hs-layout'>,</span> <span class='hs-varid'>idArity</span><span class='hs-layout'>,</span>
<a name="line-26"></a>			  <span class='hs-varid'>idStrictness</span><span class='hs-layout'>,</span> 
<a name="line-27"></a>			  <span class='hs-varid'>setIdStrictness</span><span class='hs-layout'>,</span> <span class='hs-varid'>idDemandInfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>idUnfolding</span><span class='hs-layout'>,</span>
<a name="line-28"></a>			  <span class='hs-varid'>idDemandInfo_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>setIdDemandInfo</span>
<a name="line-29"></a>			<span class='hs-layout'>)</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>		<span class='hs-layout'>(</span> <span class='hs-conid'>Var</span><span class='hs-layout'>,</span> <span class='hs-varid'>isTyVar</span> <span class='hs-layout'>)</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysWiredIn</span>	<span class='hs-layout'>(</span> <span class='hs-varid'>unboxedPairDataCon</span> <span class='hs-layout'>)</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysPrim</span>		<span class='hs-layout'>(</span> <span class='hs-varid'>realWorldStatePrimTy</span> <span class='hs-layout'>)</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqFM</span>		<span class='hs-layout'>(</span> <span class='hs-varid'>addToUFM_Directly</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupUFM_Directly</span><span class='hs-layout'>,</span>
<a name="line-35"></a>			  <span class='hs-varid'>minusUFM</span><span class='hs-layout'>,</span> <span class='hs-varid'>filterUFM</span> <span class='hs-layout'>)</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>		<span class='hs-layout'>(</span> <span class='hs-varid'>isUnLiftedType</span><span class='hs-layout'>,</span> <span class='hs-varid'>eqType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyConAppTyCon_maybe</span> <span class='hs-layout'>)</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Coercion</span>         <span class='hs-layout'>(</span> <span class='hs-varid'>coercionKind</span> <span class='hs-layout'>)</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>		<span class='hs-layout'>(</span> <span class='hs-varid'>mapAndUnzip</span><span class='hs-layout'>,</span> <span class='hs-varid'>lengthIs</span><span class='hs-layout'>,</span> <span class='hs-varid'>zipEqual</span> <span class='hs-layout'>)</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>	<span class='hs-layout'>(</span> <span class='hs-conid'>Arity</span><span class='hs-layout'>,</span> <span class='hs-conid'>TopLevelFlag</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>isTopLevel</span><span class='hs-layout'>,</span> <span class='hs-varid'>isNeverActive</span><span class='hs-layout'>,</span>
<a name="line-40"></a>			  <span class='hs-conid'>RecFlag</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>isRec</span><span class='hs-layout'>,</span> <span class='hs-varid'>isMarkedStrict</span> <span class='hs-layout'>)</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>		<span class='hs-layout'>(</span> <span class='hs-varid'>orElse</span><span class='hs-layout'>,</span> <span class='hs-varid'>expectJust</span> <span class='hs-layout'>)</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Pair</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
</pre>\end{code}

To think about

* set a noinline pragma on bottoming Ids

* Consider f x = x+1 `fatbar` error (show x)
  We'd like to unbox x, even if that means reboxing it in the error case.


%************************************************************************
%*									*
\subsection{Top level stuff}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="dmdAnalPgm"></a><span class='hs-definition'>dmdAnalPgm</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CoreProgram</span>
<a name="line-2"></a><span class='hs-definition'>dmdAnalPgm</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>binds</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-4"></a>	<span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>binds_plus_dmds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>do_prog</span> <span class='hs-varid'>binds</span> <span class='hs-layout'>}</span> <span class='hs-layout'>;</span>
<a name="line-5"></a>	<span class='hs-varid'>return</span> <span class='hs-varid'>binds_plus_dmds</span>
<a name="line-6"></a>    <span class='hs-layout'>}</span>
<a name="line-7"></a>  <span class='hs-keyword'>where</span>
<a name="line-8"></a>    <span class='hs-varid'>do_prog</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreProgram</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span>
<a name="line-9"></a>    <span class='hs-varid'>do_prog</span> <span class='hs-varid'>binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>dmdAnalTopBind</span> <span class='hs-varid'>emptySigEnv</span> <span class='hs-varid'>binds</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="dmdAnalTopBind"></a><span class='hs-definition'>dmdAnalTopBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SigEnv</span>
<a name="line-12"></a>	       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreBind</span> 
<a name="line-13"></a>	       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>SigEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreBind</span><span class='hs-layout'>)</span>
<a name="line-14"></a><span class='hs-definition'>dmdAnalTopBind</span> <span class='hs-varid'>sigs</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>id</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>sigs2</span><span class='hs-layout'>,</span> <span class='hs-conid'>NonRec</span> <span class='hs-varid'>id2</span> <span class='hs-varid'>rhs2</span><span class='hs-layout'>)</span>
<a name="line-16"></a>  <span class='hs-keyword'>where</span>
<a name="line-17"></a>    <span class='hs-layout'>(</span>    <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span>   <span class='hs-varid'>rhs1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmdAnalRhs</span> <span class='hs-conid'>TopLevel</span> <span class='hs-conid'>NonRecursive</span> <span class='hs-layout'>(</span><span class='hs-varid'>virgin</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>)</span>    <span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-18"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>sigs2</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>id2</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmdAnalRhs</span> <span class='hs-conid'>TopLevel</span> <span class='hs-conid'>NonRecursive</span> <span class='hs-layout'>(</span><span class='hs-varid'>nonVirgin</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs1</span><span class='hs-layout'>)</span>
<a name="line-19"></a>    	<span class='hs-comment'>-- Do two passes to improve CPR information</span>
<a name="line-20"></a>    	<span class='hs-comment'>-- See comments with ignore_cpr_info in mk_sig_ty</span>
<a name="line-21"></a>    	<span class='hs-comment'>-- and with extendSigsWithLam</span>
<a name="line-22"></a>
<a name="line-23"></a><span class='hs-definition'>dmdAnalTopBind</span> <span class='hs-varid'>sigs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span>
<a name="line-24"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>sigs'</span><span class='hs-layout'>,</span> <span class='hs-conid'>Rec</span> <span class='hs-varid'>pairs'</span><span class='hs-layout'>)</span>
<a name="line-25"></a>  <span class='hs-keyword'>where</span>
<a name="line-26"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>sigs'</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>pairs'</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmdFix</span> <span class='hs-conid'>TopLevel</span> <span class='hs-layout'>(</span><span class='hs-varid'>virgin</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>)</span> <span class='hs-varid'>pairs</span>
<a name="line-27"></a>		<span class='hs-comment'>-- We get two iterations automatically</span>
<a name="line-28"></a>		<span class='hs-comment'>-- c.f. the NonRec case above</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="dmdAnalTopRhs"></a><span class='hs-definition'>dmdAnalTopRhs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-comment'>-- Analyse the RHS and return</span>
<a name="line-3"></a><span class='hs-comment'>--	a) appropriate strictness info</span>
<a name="line-4"></a><span class='hs-comment'>--	b) the unfolding (decorated with strictness info)</span>
<a name="line-5"></a><span class='hs-definition'>dmdAnalTopRhs</span> <span class='hs-varid'>rhs</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs2</span><span class='hs-layout'>)</span>
<a name="line-7"></a>  <span class='hs-keyword'>where</span>
<a name="line-8"></a>    <span class='hs-varid'>call_dmd</span>	   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vanillaCall</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprArity</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-9"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span>      <span class='hs-varid'>rhs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmdAnal</span> <span class='hs-layout'>(</span><span class='hs-varid'>virgin</span> <span class='hs-varid'>emptySigEnv</span><span class='hs-layout'>)</span>    <span class='hs-varid'>call_dmd</span> <span class='hs-varid'>rhs</span>
<a name="line-10"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>rhs_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmdAnal</span> <span class='hs-layout'>(</span><span class='hs-varid'>nonVirgin</span> <span class='hs-varid'>emptySigEnv</span><span class='hs-layout'>)</span> <span class='hs-varid'>call_dmd</span> <span class='hs-varid'>rhs1</span>
<a name="line-11"></a>    <span class='hs-varid'>sig</span>		   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTopSigTy</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>rhs_ty</span>
<a name="line-12"></a>	<span class='hs-comment'>-- Do two passes; see notes with extendSigsWithLam</span>
<a name="line-13"></a>	<span class='hs-comment'>-- Otherwise we get bogus CPR info for constructors like</span>
<a name="line-14"></a>	<span class='hs-comment'>-- 	newtype T a = MkT a</span>
<a name="line-15"></a>	<span class='hs-comment'>-- The constructor looks like (\x::T a -&gt; x), modulo the coerce</span>
<a name="line-16"></a>	<span class='hs-comment'>-- extendSigsWithLam will optimistically give x a CPR tag the </span>
<a name="line-17"></a>	<span class='hs-comment'>-- first time, which is wrong in the end.</span>
</pre>\end{code}

%************************************************************************
%*									*
\subsection{The analyser itself}	
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="dmdAnal"></a><span class='hs-definition'>dmdAnal</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AnalEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-definition'>dmdAnal</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Abs</span>  <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>topDmdType</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-definition'>dmdAnal</span> <span class='hs-varid'>env</span> <span class='hs-varid'>dmd</span> <span class='hs-varid'>e</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isStrictDmd</span> <span class='hs-varid'>dmd</span><span class='hs-layout'>)</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> 
<a name="line-8"></a>	<span class='hs-layout'>(</span><span class='hs-varid'>res_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>e'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmdAnal</span> <span class='hs-varid'>env</span> <span class='hs-varid'>evalDmd</span> <span class='hs-varid'>e</span>
<a name="line-9"></a>    <span class='hs-keyword'>in</span>
<a name="line-10"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>deferType</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>e'</span><span class='hs-layout'>)</span>
<a name="line-11"></a>	<span class='hs-comment'>-- It's important not to analyse e with a lazy demand because</span>
<a name="line-12"></a>	<span class='hs-comment'>-- a) When we encounter   case s of (a,b) -&gt; </span>
<a name="line-13"></a>	<span class='hs-comment'>--	we demand s with U(d1d2)... but if the overall demand is lazy</span>
<a name="line-14"></a>	<span class='hs-comment'>--	that is wrong, and we'd need to reduce the demand on s,</span>
<a name="line-15"></a>	<span class='hs-comment'>--	which is inconvenient</span>
<a name="line-16"></a>	<span class='hs-comment'>-- b) More important, consider</span>
<a name="line-17"></a>	<span class='hs-comment'>--	f (let x = R in x+x), where f is lazy</span>
<a name="line-18"></a>	<span class='hs-comment'>--    We still want to mark x as demanded, because it will be when we</span>
<a name="line-19"></a>	<span class='hs-comment'>--    enter the let.  If we analyse f's arg with a Lazy demand, we'll</span>
<a name="line-20"></a>	<span class='hs-comment'>--    just mark x as Lazy</span>
<a name="line-21"></a>	<span class='hs-comment'>-- c) The application rule wouldn't be right either</span>
<a name="line-22"></a>	<span class='hs-comment'>--    Evaluating (f x) in a L demand does *not* cause</span>
<a name="line-23"></a>	<span class='hs-comment'>--    evaluation of f in a C(L) demand!</span>
<a name="line-24"></a>
<a name="line-25"></a>
<a name="line-26"></a><span class='hs-definition'>dmdAnal</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lit</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>topDmdType</span><span class='hs-layout'>,</span> <span class='hs-conid'>Lit</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span>
<a name="line-27"></a><span class='hs-definition'>dmdAnal</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>topDmdType</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>	<span class='hs-comment'>-- Doesn't happen, in fact</span>
<a name="line-28"></a><span class='hs-definition'>dmdAnal</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>topDmdType</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-29"></a>
<a name="line-30"></a><span class='hs-definition'>dmdAnal</span> <span class='hs-varid'>env</span> <span class='hs-varid'>dmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>Var</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span>
<a name="line-31"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>dmdTransform</span> <span class='hs-varid'>env</span> <span class='hs-varid'>var</span> <span class='hs-varid'>dmd</span><span class='hs-layout'>,</span> <span class='hs-conid'>Var</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span>
<a name="line-32"></a>
<a name="line-33"></a><span class='hs-definition'>dmdAnal</span> <span class='hs-varid'>env</span> <span class='hs-varid'>dmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cast</span> <span class='hs-varid'>e</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-34"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>dmd_ty</span><span class='hs-layout'>,</span> <span class='hs-conid'>Cast</span> <span class='hs-varid'>e'</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-35"></a>  <span class='hs-keyword'>where</span>
<a name="line-36"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>dmd_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>e'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmdAnal</span> <span class='hs-varid'>env</span> <span class='hs-varid'>dmd'</span> <span class='hs-varid'>e</span>
<a name="line-37"></a>    <span class='hs-varid'>to_co</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pSnd</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-38"></a>    <span class='hs-varid'>dmd'</span>
<a name="line-39"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConAppTyCon_maybe</span> <span class='hs-varid'>to_co</span>
<a name="line-40"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>isRecursiveTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evalDmd</span>
<a name="line-41"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmd</span>
<a name="line-42"></a>	<span class='hs-comment'>-- This coerce usually arises from a recursive</span>
<a name="line-43"></a>        <span class='hs-comment'>-- newtype, and we don't want to look inside them</span>
<a name="line-44"></a>	<span class='hs-comment'>-- for exactly the same reason that we don't look</span>
<a name="line-45"></a>	<span class='hs-comment'>-- inside recursive products -- we might not reach</span>
<a name="line-46"></a>	<span class='hs-comment'>-- a fixpoint.  So revert to a vanilla Eval demand</span>
<a name="line-47"></a>
<a name="line-48"></a><span class='hs-definition'>dmdAnal</span> <span class='hs-varid'>env</span> <span class='hs-varid'>dmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>Tick</span> <span class='hs-varid'>t</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-49"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>dmd_ty</span><span class='hs-layout'>,</span> <span class='hs-conid'>Tick</span> <span class='hs-varid'>t</span> <span class='hs-varid'>e'</span><span class='hs-layout'>)</span>
<a name="line-50"></a>  <span class='hs-keyword'>where</span>
<a name="line-51"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>dmd_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>e'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmdAnal</span> <span class='hs-varid'>env</span> <span class='hs-varid'>dmd</span> <span class='hs-varid'>e</span>
<a name="line-52"></a>
<a name="line-53"></a><span class='hs-definition'>dmdAnal</span> <span class='hs-varid'>env</span> <span class='hs-varid'>dmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>fun</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-54"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun_ty</span><span class='hs-layout'>,</span> <span class='hs-conid'>App</span> <span class='hs-varid'>fun'</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-55"></a>  <span class='hs-keyword'>where</span>
<a name="line-56"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>fun_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmdAnal</span> <span class='hs-varid'>env</span> <span class='hs-varid'>dmd</span> <span class='hs-varid'>fun</span>
<a name="line-57"></a>
<a name="line-58"></a><span class='hs-definition'>dmdAnal</span> <span class='hs-varid'>sigs</span> <span class='hs-varid'>dmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>fun</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-59"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun_ty</span><span class='hs-layout'>,</span> <span class='hs-conid'>App</span> <span class='hs-varid'>fun'</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-60"></a>  <span class='hs-keyword'>where</span>
<a name="line-61"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>fun_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmdAnal</span> <span class='hs-varid'>sigs</span> <span class='hs-varid'>dmd</span> <span class='hs-varid'>fun</span>
<a name="line-62"></a>
<a name="line-63"></a><span class='hs-comment'>-- Lots of the other code is there to make this</span>
<a name="line-64"></a><span class='hs-comment'>-- beautiful, compositional, application rule :-)</span>
<a name="line-65"></a><span class='hs-definition'>dmdAnal</span> <span class='hs-varid'>env</span> <span class='hs-varid'>dmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>App</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>	<span class='hs-comment'>-- Non-type arguments</span>
<a name="line-66"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span>				<span class='hs-comment'>-- [Type arg handled above]</span>
<a name="line-67"></a>	<span class='hs-layout'>(</span><span class='hs-varid'>fun_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun'</span><span class='hs-layout'>)</span> 	  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmdAnal</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Call</span> <span class='hs-varid'>dmd</span><span class='hs-layout'>)</span> <span class='hs-varid'>fun</span>
<a name="line-68"></a>	<span class='hs-layout'>(</span><span class='hs-varid'>arg_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>)</span> 	  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmdAnal</span> <span class='hs-varid'>env</span> <span class='hs-varid'>arg_dmd</span> <span class='hs-varid'>arg</span>
<a name="line-69"></a>	<span class='hs-layout'>(</span><span class='hs-varid'>arg_dmd</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitDmdTy</span> <span class='hs-varid'>fun_ty</span>
<a name="line-70"></a>    <span class='hs-keyword'>in</span>
<a name="line-71"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>res_ty</span> <span class='hs-varop'>`bothType`</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>,</span> <span class='hs-conid'>App</span> <span class='hs-varid'>fun'</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>)</span>
<a name="line-72"></a>
<a name="line-73"></a><span class='hs-definition'>dmdAnal</span> <span class='hs-varid'>env</span> <span class='hs-varid'>dmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lam</span> <span class='hs-varid'>var</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-74"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>var</span>
<a name="line-75"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span>   
<a name="line-76"></a>	<span class='hs-layout'>(</span><span class='hs-varid'>body_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>body'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmdAnal</span> <span class='hs-varid'>env</span> <span class='hs-varid'>dmd</span> <span class='hs-varid'>body</span>
<a name="line-77"></a>    <span class='hs-keyword'>in</span>
<a name="line-78"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>body_ty</span><span class='hs-layout'>,</span> <span class='hs-conid'>Lam</span> <span class='hs-varid'>var</span> <span class='hs-varid'>body'</span><span class='hs-layout'>)</span>
<a name="line-79"></a>
<a name="line-80"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Call</span> <span class='hs-varid'>body_dmd</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dmd</span>	<span class='hs-comment'>-- A call demand: good!</span>
<a name="line-81"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span>	
<a name="line-82"></a>	<span class='hs-varid'>env'</span>		 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendSigsWithLam</span> <span class='hs-varid'>env</span> <span class='hs-varid'>var</span>
<a name="line-83"></a>	<span class='hs-layout'>(</span><span class='hs-varid'>body_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>body'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmdAnal</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>body_dmd</span> <span class='hs-varid'>body</span>
<a name="line-84"></a>	<span class='hs-layout'>(</span><span class='hs-varid'>lam_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>var'</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>annotateLamIdBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>body_ty</span> <span class='hs-varid'>var</span>
<a name="line-85"></a>    <span class='hs-keyword'>in</span>
<a name="line-86"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>lam_ty</span><span class='hs-layout'>,</span> <span class='hs-conid'>Lam</span> <span class='hs-varid'>var'</span> <span class='hs-varid'>body'</span><span class='hs-layout'>)</span>
<a name="line-87"></a>
<a name="line-88"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>	<span class='hs-comment'>-- Not enough demand on the lambda; but do the body</span>
<a name="line-89"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span>		<span class='hs-comment'>-- anyway to annotate it and gather free var info</span>
<a name="line-90"></a>	<span class='hs-layout'>(</span><span class='hs-varid'>body_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>body'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmdAnal</span> <span class='hs-varid'>env</span> <span class='hs-varid'>evalDmd</span> <span class='hs-varid'>body</span>
<a name="line-91"></a>	<span class='hs-layout'>(</span><span class='hs-varid'>lam_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>var'</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>annotateLamIdBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>body_ty</span> <span class='hs-varid'>var</span>
<a name="line-92"></a>    <span class='hs-keyword'>in</span>
<a name="line-93"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>deferType</span> <span class='hs-varid'>lam_ty</span><span class='hs-layout'>,</span> <span class='hs-conid'>Lam</span> <span class='hs-varid'>var'</span> <span class='hs-varid'>body'</span><span class='hs-layout'>)</span>
<a name="line-94"></a>
<a name="line-95"></a><span class='hs-definition'>dmdAnal</span> <span class='hs-varid'>env</span> <span class='hs-varid'>dmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>Case</span> <span class='hs-varid'>scrut</span> <span class='hs-varid'>case_bndr</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>alt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>DataAlt</span> <span class='hs-varid'>dc</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-96"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConTyCon</span> <span class='hs-varid'>dc</span>
<a name="line-97"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>isProductTyCon</span> <span class='hs-varid'>tycon</span>
<a name="line-98"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isRecursiveTyCon</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span>
<a name="line-99"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span>
<a name="line-100"></a>	<span class='hs-varid'>env_alt</span>	      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendAnalEnv</span> <span class='hs-conid'>NotTopLevel</span> <span class='hs-varid'>env</span> <span class='hs-varid'>case_bndr</span> <span class='hs-varid'>case_bndr_sig</span>
<a name="line-101"></a>	<span class='hs-layout'>(</span><span class='hs-varid'>alt_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>alt'</span><span class='hs-layout'>)</span>	      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmdAnalAlt</span> <span class='hs-varid'>env_alt</span> <span class='hs-varid'>dmd</span> <span class='hs-varid'>alt</span>
<a name="line-102"></a>	<span class='hs-layout'>(</span><span class='hs-varid'>alt_ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>case_bndr'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>annotateBndr</span> <span class='hs-varid'>alt_ty</span> <span class='hs-varid'>case_bndr</span>
<a name="line-103"></a>	<span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs'</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>	      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>alt'</span>
<a name="line-104"></a>	<span class='hs-varid'>case_bndr_sig</span>	      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cprSig</span>
<a name="line-105"></a>		<span class='hs-comment'>-- Inside the alternative, the case binder has the CPR property.</span>
<a name="line-106"></a>		<span class='hs-comment'>-- Meaning that a case on it will successfully cancel.</span>
<a name="line-107"></a>		<span class='hs-comment'>-- Example:</span>
<a name="line-108"></a>		<span class='hs-comment'>--	f True  x = case x of y { I# x' -&gt; if x' ==# 3 then y else I# 8 }</span>
<a name="line-109"></a>		<span class='hs-comment'>--	f False x = I# 3</span>
<a name="line-110"></a>		<span class='hs-comment'>--	</span>
<a name="line-111"></a>		<span class='hs-comment'>-- We want f to have the CPR property:</span>
<a name="line-112"></a>		<span class='hs-comment'>--	f b x = case fw b x of { r -&gt; I# r }</span>
<a name="line-113"></a>		<span class='hs-comment'>--	fw True  x = case x of y { I# x' -&gt; if x' ==# 3 then x' else 8 }</span>
<a name="line-114"></a>		<span class='hs-comment'>--	fw False x = 3</span>
<a name="line-115"></a>
<a name="line-116"></a>	<span class='hs-comment'>-- Figure out whether the demand on the case binder is used, and use</span>
<a name="line-117"></a>	<span class='hs-comment'>-- that to set the scrut_dmd.  This is utterly essential.</span>
<a name="line-118"></a>	<span class='hs-comment'>-- Consider	f x = case x of y { (a,b) -&gt; k y a }</span>
<a name="line-119"></a>	<span class='hs-comment'>-- If we just take scrut_demand = U(L,A), then we won't pass x to the</span>
<a name="line-120"></a>	<span class='hs-comment'>-- worker, so the worker will rebuild </span>
<a name="line-121"></a>	<span class='hs-comment'>--	x = (a, absent-error)</span>
<a name="line-122"></a>	<span class='hs-comment'>-- and that'll crash.</span>
<a name="line-123"></a>	<span class='hs-comment'>-- So at one stage I had:</span>
<a name="line-124"></a>	<span class='hs-comment'>--	dead_case_bndr		 = isAbsentDmd (idDemandInfo case_bndr')</span>
<a name="line-125"></a>	<span class='hs-comment'>--	keepity | dead_case_bndr = Drop</span>
<a name="line-126"></a>	<span class='hs-comment'>--		| otherwise	 = Keep		</span>
<a name="line-127"></a>	<span class='hs-comment'>--</span>
<a name="line-128"></a>	<span class='hs-comment'>-- But then consider</span>
<a name="line-129"></a>	<span class='hs-comment'>--	case x of y { (a,b) -&gt; h y + a }</span>
<a name="line-130"></a>	<span class='hs-comment'>-- where h : U(LL) -&gt; T</span>
<a name="line-131"></a>	<span class='hs-comment'>-- The above code would compute a Keep for x, since y is not Abs, which is silly</span>
<a name="line-132"></a>	<span class='hs-comment'>-- The insight is, of course, that a demand on y is a demand on the</span>
<a name="line-133"></a>	<span class='hs-comment'>-- scrutinee, so we need to `both` it with the scrut demand</span>
<a name="line-134"></a>
<a name="line-135"></a>	<span class='hs-varid'>alt_dmd</span> 	   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Eval</span> <span class='hs-layout'>(</span><span class='hs-conid'>Prod</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>idDemandInfo</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bndrs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-136"></a>        <span class='hs-varid'>scrut_dmd</span> 	   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>alt_dmd</span> <span class='hs-varop'>`both`</span>
<a name="line-137"></a>			     <span class='hs-varid'>idDemandInfo</span> <span class='hs-varid'>case_bndr'</span>
<a name="line-138"></a>
<a name="line-139"></a>	<span class='hs-layout'>(</span><span class='hs-varid'>scrut_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>scrut'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmdAnal</span> <span class='hs-varid'>env</span> <span class='hs-varid'>scrut_dmd</span> <span class='hs-varid'>scrut</span>
<a name="line-140"></a>    <span class='hs-keyword'>in</span>
<a name="line-141"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>alt_ty1</span> <span class='hs-varop'>`bothType`</span> <span class='hs-varid'>scrut_ty</span><span class='hs-layout'>,</span> <span class='hs-conid'>Case</span> <span class='hs-varid'>scrut'</span> <span class='hs-varid'>case_bndr'</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>alt'</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-142"></a>
<a name="line-143"></a><span class='hs-definition'>dmdAnal</span> <span class='hs-varid'>env</span> <span class='hs-varid'>dmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>Case</span> <span class='hs-varid'>scrut</span> <span class='hs-varid'>case_bndr</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span>
<a name="line-144"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span>
<a name="line-145"></a>	<span class='hs-layout'>(</span><span class='hs-varid'>alt_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>alts'</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAndUnzip</span> <span class='hs-layout'>(</span><span class='hs-varid'>dmdAnalAlt</span> <span class='hs-varid'>env</span> <span class='hs-varid'>dmd</span><span class='hs-layout'>)</span> <span class='hs-varid'>alts</span>
<a name="line-146"></a>	<span class='hs-layout'>(</span><span class='hs-varid'>scrut_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>scrut'</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmdAnal</span> <span class='hs-varid'>env</span> <span class='hs-varid'>evalDmd</span> <span class='hs-varid'>scrut</span>
<a name="line-147"></a>	<span class='hs-layout'>(</span><span class='hs-varid'>alt_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>case_bndr'</span><span class='hs-layout'>)</span>	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>annotateBndr</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldr1</span> <span class='hs-varid'>lubType</span> <span class='hs-varid'>alt_tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>case_bndr</span>
<a name="line-148"></a>    <span class='hs-keyword'>in</span>
<a name="line-149"></a><span class='hs-comment'>--    pprTrace "dmdAnal:Case" (ppr alts $$ ppr alt_tys)</span>
<a name="line-150"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>alt_ty</span> <span class='hs-varop'>`bothType`</span> <span class='hs-varid'>scrut_ty</span><span class='hs-layout'>,</span> <span class='hs-conid'>Case</span> <span class='hs-varid'>scrut'</span> <span class='hs-varid'>case_bndr'</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>alts'</span><span class='hs-layout'>)</span>
<a name="line-151"></a>
<a name="line-152"></a><span class='hs-definition'>dmdAnal</span> <span class='hs-varid'>env</span> <span class='hs-varid'>dmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>Let</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>id</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-153"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span>
<a name="line-154"></a>	<span class='hs-layout'>(</span><span class='hs-varid'>sigs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>lazy_fv</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>id1</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmdAnalRhs</span> <span class='hs-conid'>NotTopLevel</span> <span class='hs-conid'>NonRecursive</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-155"></a>	<span class='hs-layout'>(</span><span class='hs-varid'>body_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>body'</span><span class='hs-layout'>)</span> 	      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmdAnal</span> <span class='hs-layout'>(</span><span class='hs-varid'>updSigEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sigs'</span><span class='hs-layout'>)</span> <span class='hs-varid'>dmd</span> <span class='hs-varid'>body</span>
<a name="line-156"></a>	<span class='hs-layout'>(</span><span class='hs-varid'>body_ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>id2</span><span class='hs-layout'>)</span>    	      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>annotateBndr</span> <span class='hs-varid'>body_ty</span> <span class='hs-varid'>id1</span>
<a name="line-157"></a>	<span class='hs-varid'>body_ty2</span>		      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addLazyFVs</span> <span class='hs-varid'>body_ty1</span> <span class='hs-varid'>lazy_fv</span>
<a name="line-158"></a>    <span class='hs-keyword'>in</span>
<a name="line-159"></a>	<span class='hs-comment'>-- If the actual demand is better than the vanilla call</span>
<a name="line-160"></a>	<span class='hs-comment'>-- demand, you might think that we might do better to re-analyse </span>
<a name="line-161"></a>	<span class='hs-comment'>-- the RHS with the stronger demand.</span>
<a name="line-162"></a>	<span class='hs-comment'>-- But (a) That seldom happens, because it means that *every* path in </span>
<a name="line-163"></a>	<span class='hs-comment'>-- 	   the body of the let has to use that stronger demand</span>
<a name="line-164"></a>	<span class='hs-comment'>-- (b) It often happens temporarily in when fixpointing, because</span>
<a name="line-165"></a>	<span class='hs-comment'>--     the recursive function at first seems to place a massive demand.</span>
<a name="line-166"></a>	<span class='hs-comment'>--     But we don't want to go to extra work when the function will</span>
<a name="line-167"></a>	<span class='hs-comment'>--     probably iterate to something less demanding.  </span>
<a name="line-168"></a>	<span class='hs-comment'>-- In practice, all the times the actual demand on id2 is more than</span>
<a name="line-169"></a>	<span class='hs-comment'>-- the vanilla call demand seem to be due to (b).  So we don't</span>
<a name="line-170"></a>	<span class='hs-comment'>-- bother to re-analyse the RHS.</span>
<a name="line-171"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>body_ty2</span><span class='hs-layout'>,</span> <span class='hs-conid'>Let</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>id2</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span> <span class='hs-varid'>body'</span><span class='hs-layout'>)</span>    
<a name="line-172"></a>
<a name="line-173"></a><span class='hs-definition'>dmdAnal</span> <span class='hs-varid'>env</span> <span class='hs-varid'>dmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>Let</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-174"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span>
<a name="line-175"></a>	<span class='hs-varid'>bndrs</span>			 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>pairs</span>
<a name="line-176"></a>	<span class='hs-layout'>(</span><span class='hs-varid'>sigs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>lazy_fv</span><span class='hs-layout'>,</span> <span class='hs-varid'>pairs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmdFix</span> <span class='hs-conid'>NotTopLevel</span> <span class='hs-varid'>env</span> <span class='hs-varid'>pairs</span>
<a name="line-177"></a>	<span class='hs-layout'>(</span><span class='hs-varid'>body_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>body'</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmdAnal</span> <span class='hs-layout'>(</span><span class='hs-varid'>updSigEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sigs'</span><span class='hs-layout'>)</span> <span class='hs-varid'>dmd</span> <span class='hs-varid'>body</span>
<a name="line-178"></a>	<span class='hs-varid'>body_ty1</span>		 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addLazyFVs</span> <span class='hs-varid'>body_ty</span> <span class='hs-varid'>lazy_fv</span>
<a name="line-179"></a>    <span class='hs-keyword'>in</span>
<a name="line-180"></a>    <span class='hs-varid'>sigs'</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>body_ty</span> <span class='hs-varop'>`seq`</span>
<a name="line-181"></a>    <span class='hs-keyword'>let</span>
<a name="line-182"></a>	<span class='hs-layout'>(</span><span class='hs-varid'>body_ty2</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>annotateBndrs</span> <span class='hs-varid'>body_ty1</span> <span class='hs-varid'>bndrs</span>
<a name="line-183"></a>		<span class='hs-comment'>-- Don't bother to add demand info to recursive</span>
<a name="line-184"></a>		<span class='hs-comment'>-- binders as annotateBndr does; </span>
<a name="line-185"></a>		<span class='hs-comment'>-- being recursive, we can't treat them strictly.</span>
<a name="line-186"></a>		<span class='hs-comment'>-- But we do need to remove the binders from the result demand env</span>
<a name="line-187"></a>    <span class='hs-keyword'>in</span>
<a name="line-188"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>body_ty2</span><span class='hs-layout'>,</span>  <span class='hs-conid'>Let</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>pairs'</span><span class='hs-layout'>)</span> <span class='hs-varid'>body'</span><span class='hs-layout'>)</span>
<a name="line-189"></a>
<a name="line-190"></a>
<a name="line-191"></a><a name="dmdAnalAlt"></a><span class='hs-definition'>dmdAnalAlt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AnalEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Alt</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span><span class='hs-layout'>,</span> <span class='hs-conid'>Alt</span> <span class='hs-conid'>Var</span><span class='hs-layout'>)</span>
<a name="line-192"></a><span class='hs-definition'>dmdAnalAlt</span> <span class='hs-varid'>env</span> <span class='hs-varid'>dmd</span> <span class='hs-layout'>(</span><span class='hs-varid'>con</span><span class='hs-layout'>,</span><span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span><span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-193"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> 
<a name="line-194"></a>	<span class='hs-layout'>(</span><span class='hs-varid'>rhs_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmdAnal</span> <span class='hs-varid'>env</span> <span class='hs-varid'>dmd</span> <span class='hs-varid'>rhs</span>
<a name="line-195"></a>        <span class='hs-varid'>rhs_ty'</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addDataConPatDmds</span> <span class='hs-varid'>con</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>rhs_ty</span>
<a name="line-196"></a>	<span class='hs-layout'>(</span><span class='hs-varid'>alt_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>annotateBndrs</span> <span class='hs-varid'>rhs_ty'</span> <span class='hs-varid'>bndrs</span>
<a name="line-197"></a>	<span class='hs-varid'>final_alt_ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>io_hack_reqd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>alt_ty</span> <span class='hs-varop'>`lubType`</span> <span class='hs-varid'>topDmdType</span>
<a name="line-198"></a>		     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>alt_ty</span>
<a name="line-199"></a>
<a name="line-200"></a>	<span class='hs-comment'>-- There's a hack here for I/O operations.  Consider</span>
<a name="line-201"></a>	<span class='hs-comment'>-- 	case foo x s of { (# s, r #) -&gt; y }</span>
<a name="line-202"></a>	<span class='hs-comment'>-- Is this strict in 'y'.  Normally yes, but what if 'foo' is an I/O</span>
<a name="line-203"></a>	<span class='hs-comment'>-- operation that simply terminates the program (not in an erroneous way)?</span>
<a name="line-204"></a>	<span class='hs-comment'>-- In that case we should not evaluate y before the call to 'foo'.</span>
<a name="line-205"></a>	<span class='hs-comment'>-- Hackish solution: spot the IO-like situation and add a virtual branch,</span>
<a name="line-206"></a>	<span class='hs-comment'>-- as if we had</span>
<a name="line-207"></a>	<span class='hs-comment'>-- 	case foo x s of </span>
<a name="line-208"></a>	<span class='hs-comment'>--	   (# s, r #) -&gt; y </span>
<a name="line-209"></a>	<span class='hs-comment'>--	   other      -&gt; return ()</span>
<a name="line-210"></a>	<span class='hs-comment'>-- So the 'y' isn't necessarily going to be evaluated</span>
<a name="line-211"></a>	<span class='hs-comment'>--</span>
<a name="line-212"></a>	<span class='hs-comment'>-- A more complete example where this shows up is:</span>
<a name="line-213"></a>	<span class='hs-comment'>--	do { let len = &lt;expensive&gt; ;</span>
<a name="line-214"></a>	<span class='hs-comment'>--	   ; when (...) (exitWith ExitSuccess)</span>
<a name="line-215"></a>	<span class='hs-comment'>--	   ; print len }</span>
<a name="line-216"></a>
<a name="line-217"></a>	<span class='hs-varid'>io_hack_reqd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>con</span> <span class='hs-varop'>==</span> <span class='hs-conid'>DataAlt</span> <span class='hs-varid'>unboxedPairDataCon</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-218"></a>		       <span class='hs-varid'>idType</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>)</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>realWorldStatePrimTy</span>
<a name="line-219"></a>    <span class='hs-keyword'>in</span>	
<a name="line-220"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>final_alt_ty</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>con</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-221"></a>
<a name="line-222"></a><a name="addDataConPatDmds"></a><span class='hs-definition'>addDataConPatDmds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AltCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-223"></a><span class='hs-comment'>-- See Note [Add demands for strict constructors]</span>
<a name="line-224"></a><span class='hs-definition'>addDataConPatDmds</span> <span class='hs-conid'>DEFAULT</span>    <span class='hs-keyword'>_</span> <span class='hs-varid'>dmd_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmd_ty</span>
<a name="line-225"></a><span class='hs-definition'>addDataConPatDmds</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitAlt</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>dmd_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmd_ty</span>
<a name="line-226"></a><span class='hs-definition'>addDataConPatDmds</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataAlt</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>dmd_ty</span>
<a name="line-227"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>add</span> <span class='hs-varid'>dmd_ty</span> <span class='hs-varid'>str_bndrs</span> 
<a name="line-228"></a>  <span class='hs-keyword'>where</span>
<a name="line-229"></a>    <span class='hs-varid'>add</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>dmd_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addVarDmd</span> <span class='hs-varid'>dmd_ty</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>seqDmd</span>
<a name="line-230"></a>    <span class='hs-varid'>str_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span><span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipEqual</span> <span class='hs-str'>"addDataConPatBndrs"</span>
<a name="line-231"></a>                                   <span class='hs-layout'>(</span><span class='hs-varid'>filter</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>)</span>
<a name="line-232"></a>                                   <span class='hs-layout'>(</span><span class='hs-varid'>dataConRepStrictness</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span>
<a name="line-233"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>isMarkedStrict</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>]</span>
</pre>\end{code}

Note [Add demands for strict constructors]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this program (due to Roman):

    data X a = X !a

    foo :: X Int -> Int -> Int
    foo (X a) n = go 0
     where
       go i | i < n     = a + go (i+1)
            | otherwise = 0

We want the worker for 'foo' too look like this:

    $wfoo :: Int# -> Int# -> Int#

with the first argument unboxed, so that it is not eval'd each time
around the loop (which would otherwise happen, since 'foo' is not
strict in 'a'.  It is sound for the wrapper to pass an unboxed arg
because X is strict, so its argument must be evaluated.  And if we
*don't* pass an unboxed argument, we can't even repair it by adding a
`seq` thus:

    foo (X a) n = a `seq` go 0

because the seq is discarded (very early) since X is strict!

There is the usual danger of reboxing, which as usual we ignore. But 
if X is monomorphic, and has an UNPACK pragma, then this optimisation
is even more important.  We don't want the wrapper to rebox an unboxed
argument, and pass an Int to $wfoo!


%************************************************************************
%*									*
                    Demand transformer
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="dmdTransform"></a><span class='hs-definition'>dmdTransform</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AnalEnv</span>		<span class='hs-comment'>-- The strictness environment</span>
<a name="line-2"></a>	     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>		<span class='hs-comment'>-- The function</span>
<a name="line-3"></a>	     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span>		<span class='hs-comment'>-- The demand on the function</span>
<a name="line-4"></a>	     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>		<span class='hs-comment'>-- The demand type of the function in this context</span>
<a name="line-5"></a>	<span class='hs-comment'>-- Returned DmdEnv includes the demand on </span>
<a name="line-6"></a>	<span class='hs-comment'>-- this function plus demand on its free variables</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-definition'>dmdTransform</span> <span class='hs-varid'>env</span> <span class='hs-varid'>var</span> <span class='hs-varid'>dmd</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-comment'>------ 	DATA CONSTRUCTOR</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isDataConWorkId</span> <span class='hs-varid'>var</span>		<span class='hs-comment'>-- Data constructor</span>
<a name="line-12"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> 
<a name="line-13"></a>	<span class='hs-conid'>StrictSig</span> <span class='hs-varid'>dmd_ty</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idStrictness</span> <span class='hs-varid'>var</span>	<span class='hs-comment'>-- It must have a strictness sig</span>
<a name="line-14"></a>	<span class='hs-conid'>DmdType</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>con_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmd_ty</span>
<a name="line-15"></a>	<span class='hs-varid'>arity</span>		    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idArity</span> <span class='hs-varid'>var</span>
<a name="line-16"></a>    <span class='hs-keyword'>in</span>
<a name="line-17"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>arity</span> <span class='hs-varop'>==</span> <span class='hs-varid'>call_depth</span> <span class='hs-keyword'>then</span>		<span class='hs-comment'>-- Saturated, so unleash the demand</span>
<a name="line-18"></a>	<span class='hs-keyword'>let</span> 
<a name="line-19"></a>		<span class='hs-comment'>-- Important!  If we Keep the constructor application, then</span>
<a name="line-20"></a>		<span class='hs-comment'>-- we need the demands the constructor places (always lazy)</span>
<a name="line-21"></a>		<span class='hs-comment'>-- If not, we don't need to.  For example:</span>
<a name="line-22"></a>		<span class='hs-comment'>--	f p@(x,y) = (p,y)	-- S(AL)</span>
<a name="line-23"></a>		<span class='hs-comment'>--	g a b     = f (a,b)</span>
<a name="line-24"></a>		<span class='hs-comment'>-- It's vital that we don't calculate Absent for a!</span>
<a name="line-25"></a>	   <span class='hs-varid'>dmd_ds</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>res_dmd</span> <span class='hs-keyword'>of</span>
<a name="line-26"></a>			<span class='hs-conid'>Box</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eval</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mapDmds</span> <span class='hs-varid'>box</span> <span class='hs-varid'>ds</span>
<a name="line-27"></a>			<span class='hs-conid'>Eval</span> <span class='hs-varid'>ds</span>	      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ds</span>
<a name="line-28"></a>			<span class='hs-keyword'>_</span>	      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Poly</span> <span class='hs-conid'>Top</span>
<a name="line-29"></a>
<a name="line-30"></a>		<span class='hs-comment'>-- ds can be empty, when we are just seq'ing the thing</span>
<a name="line-31"></a>		<span class='hs-comment'>-- If so we must make up a suitable bunch of demands</span>
<a name="line-32"></a>	   <span class='hs-varid'>arg_ds</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>dmd_ds</span> <span class='hs-keyword'>of</span>
<a name="line-33"></a>		      <span class='hs-conid'>Poly</span> <span class='hs-varid'>d</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>replicate</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>d</span>
<a name="line-34"></a>		      <span class='hs-conid'>Prod</span> <span class='hs-varid'>ds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>ds</span> <span class='hs-varop'>`lengthIs`</span> <span class='hs-varid'>arity</span> <span class='hs-layout'>)</span> <span class='hs-varid'>ds</span>
<a name="line-35"></a>
<a name="line-36"></a>	<span class='hs-keyword'>in</span>
<a name="line-37"></a>	<span class='hs-varid'>mkDmdType</span> <span class='hs-varid'>emptyDmdEnv</span> <span class='hs-varid'>arg_ds</span> <span class='hs-varid'>con_res</span>
<a name="line-38"></a>		<span class='hs-comment'>-- Must remember whether it's a product, hence con_res, not TopRes</span>
<a name="line-39"></a>    <span class='hs-keyword'>else</span>
<a name="line-40"></a>	<span class='hs-varid'>topDmdType</span>
<a name="line-41"></a>
<a name="line-42"></a><span class='hs-comment'>------ 	IMPORTED FUNCTION</span>
<a name="line-43"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isGlobalId</span> <span class='hs-varid'>var</span><span class='hs-layout'>,</span>		<span class='hs-comment'>-- Imported function</span>
<a name="line-44"></a>    <span class='hs-keyword'>let</span> <span class='hs-conid'>StrictSig</span> <span class='hs-varid'>dmd_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idStrictness</span> <span class='hs-varid'>var</span>
<a name="line-45"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- pprTrace "strict-sig" (ppr var $$ ppr dmd_ty) $</span>
<a name="line-46"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>dmdTypeDepth</span> <span class='hs-varid'>dmd_ty</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>call_depth</span> <span class='hs-keyword'>then</span>	<span class='hs-comment'>-- Saturated, so unleash the demand</span>
<a name="line-47"></a>	<span class='hs-varid'>dmd_ty</span>
<a name="line-48"></a>    <span class='hs-keyword'>else</span>
<a name="line-49"></a>	<span class='hs-varid'>topDmdType</span>
<a name="line-50"></a>
<a name="line-51"></a><span class='hs-comment'>------ 	LOCAL LET/REC BOUND THING</span>
<a name="line-52"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span> <span class='hs-varid'>dmd_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>top_lvl</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupSigEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>var</span>
<a name="line-53"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span>
<a name="line-54"></a>	<span class='hs-varid'>fn_ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>dmdTypeDepth</span> <span class='hs-varid'>dmd_ty</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>call_depth</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmd_ty</span> 
<a name="line-55"></a>	      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   		          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deferType</span> <span class='hs-varid'>dmd_ty</span>
<a name="line-56"></a>	<span class='hs-comment'>-- NB: it's important to use deferType, and not just return topDmdType</span>
<a name="line-57"></a>	<span class='hs-comment'>-- Consider	let { f x y = p + x } in f 1</span>
<a name="line-58"></a>	<span class='hs-comment'>-- The application isn't saturated, but we must nevertheless propagate </span>
<a name="line-59"></a>	<span class='hs-comment'>--	a lazy demand for p!  </span>
<a name="line-60"></a>    <span class='hs-keyword'>in</span>
<a name="line-61"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>isTopLevel</span> <span class='hs-varid'>top_lvl</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>fn_ty</span>	<span class='hs-comment'>-- Don't record top level things</span>
<a name="line-62"></a>    <span class='hs-keyword'>else</span> <span class='hs-varid'>addVarDmd</span> <span class='hs-varid'>fn_ty</span> <span class='hs-varid'>var</span> <span class='hs-varid'>dmd</span>
<a name="line-63"></a>
<a name="line-64"></a><span class='hs-comment'>------ 	LOCAL NON-LET/REC BOUND THING</span>
<a name="line-65"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>	 		<span class='hs-comment'>-- Default case</span>
<a name="line-66"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitVarDmd</span> <span class='hs-varid'>var</span> <span class='hs-varid'>dmd</span>
<a name="line-67"></a>
<a name="line-68"></a>  <span class='hs-keyword'>where</span>
<a name="line-69"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>call_depth</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_dmd</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitCallDmd</span> <span class='hs-varid'>dmd</span>
</pre>\end{code}

%************************************************************************
%*									*
\subsection{Bindings}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="dmdFix"></a><span class='hs-definition'>dmdFix</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TopLevelFlag</span>
<a name="line-2"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AnalEnv</span> 		<span class='hs-comment'>-- Does not include bindings for this binding</span>
<a name="line-3"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-4"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>SigEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>DmdEnv</span><span class='hs-layout'>,</span>
<a name="line-5"></a>	   <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>	<span class='hs-comment'>-- Binders annotated with stricness info</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-definition'>dmdFix</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>env</span> <span class='hs-varid'>orig_pairs</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loop</span> <span class='hs-num'>1</span> <span class='hs-varid'>initial_env</span> <span class='hs-varid'>orig_pairs</span>
<a name="line-9"></a>  <span class='hs-keyword'>where</span>
<a name="line-10"></a>    <span class='hs-varid'>bndrs</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>orig_pairs</span>
<a name="line-11"></a>    <span class='hs-varid'>initial_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addInitialSigs</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bndrs</span>
<a name="line-12"></a>    
<a name="line-13"></a>    <span class='hs-varid'>loop</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-14"></a>	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AnalEnv</span>			<span class='hs-comment'>-- Already contains the current sigs</span>
<a name="line-15"></a>	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> 		
<a name="line-16"></a>	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>SigEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>DmdEnv</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-17"></a>    <span class='hs-varid'>loop</span> <span class='hs-varid'>n</span> <span class='hs-varid'>env</span> <span class='hs-varid'>pairs</span>
<a name="line-18"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- pprTrace "dmd loop" (ppr n &lt;+&gt; ppr bndrs $$ ppr env) $</span>
<a name="line-19"></a>        <span class='hs-varid'>loop'</span> <span class='hs-varid'>n</span> <span class='hs-varid'>env</span> <span class='hs-varid'>pairs</span>
<a name="line-20"></a>
<a name="line-21"></a>    <span class='hs-varid'>loop'</span> <span class='hs-varid'>n</span> <span class='hs-varid'>env</span> <span class='hs-varid'>pairs</span>
<a name="line-22"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>found_fixpoint</span>
<a name="line-23"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>sigs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>lazy_fv</span><span class='hs-layout'>,</span> <span class='hs-varid'>pairs'</span><span class='hs-layout'>)</span>
<a name="line-24"></a>		<span class='hs-comment'>-- Note: return pairs', not pairs.   pairs' is the result of </span>
<a name="line-25"></a>		<span class='hs-comment'>-- processing the RHSs with sigs (= sigs'), whereas pairs </span>
<a name="line-26"></a>		<span class='hs-comment'>-- is the result of processing the RHSs with the *previous* </span>
<a name="line-27"></a>		<span class='hs-comment'>-- iteration of sigs.</span>
<a name="line-28"></a>
<a name="line-29"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&gt;=</span> <span class='hs-num'>10</span>  
<a name="line-30"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTrace</span> <span class='hs-str'>"dmdFix loop"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> 
<a name="line-31"></a>			<span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Sigs:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-layout'>,</span><span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>sigs</span> <span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>sigs'</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> 
<a name="line-32"></a>                                               <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>pairs</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-33"></a>			  <span class='hs-varid'>text</span> <span class='hs-str'>"env:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>env</span><span class='hs-layout'>,</span>
<a name="line-34"></a>			  <span class='hs-varid'>text</span> <span class='hs-str'>"binds:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprCoreBinding</span> <span class='hs-layout'>(</span><span class='hs-conid'>Rec</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-35"></a>	<span class='hs-layout'>(</span><span class='hs-varid'>sigEnv</span> <span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-varid'>lazy_fv</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig_pairs</span><span class='hs-layout'>)</span>	<span class='hs-comment'>-- Safe output</span>
<a name="line-36"></a>		<span class='hs-comment'>-- The lazy_fv part is really important!  orig_pairs has no strictness</span>
<a name="line-37"></a>		<span class='hs-comment'>-- info, including nothing about free vars.  But if we have</span>
<a name="line-38"></a>		<span class='hs-comment'>--	letrec f = ....y..... in ...f...</span>
<a name="line-39"></a>		<span class='hs-comment'>-- where 'y' is free in f, we must record that y is mentioned, </span>
<a name="line-40"></a>		<span class='hs-comment'>-- otherwise y will get recorded as absent altogether</span>
<a name="line-41"></a>
<a name="line-42"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-43"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loop</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>nonVirgin</span> <span class='hs-varid'>sigs'</span><span class='hs-layout'>)</span> <span class='hs-varid'>pairs'</span>
<a name="line-44"></a>      <span class='hs-keyword'>where</span>
<a name="line-45"></a>        <span class='hs-varid'>sigs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sigEnv</span> <span class='hs-varid'>env</span>
<a name="line-46"></a>	<span class='hs-varid'>found_fixpoint</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-layout'>(</span><span class='hs-varid'>same_sig</span> <span class='hs-varid'>sigs</span> <span class='hs-varid'>sigs'</span><span class='hs-layout'>)</span> <span class='hs-varid'>bndrs</span> 
<a name="line-47"></a>
<a name="line-48"></a>	<span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>sigs'</span><span class='hs-layout'>,</span><span class='hs-varid'>lazy_fv</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>pairs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>my_downRhs</span> <span class='hs-layout'>(</span><span class='hs-varid'>sigs</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyDmdEnv</span><span class='hs-layout'>)</span> <span class='hs-varid'>pairs</span>
<a name="line-49"></a>		<span class='hs-comment'>-- mapAccumL: Use the new signature to do the next pair</span>
<a name="line-50"></a>		<span class='hs-comment'>-- The occurrence analyser has arranged them in a good order</span>
<a name="line-51"></a>		<span class='hs-comment'>-- so this can significantly reduce the number of iterations needed</span>
<a name="line-52"></a>	
<a name="line-53"></a>        <span class='hs-varid'>my_downRhs</span> <span class='hs-layout'>(</span><span class='hs-varid'>sigs</span><span class='hs-layout'>,</span><span class='hs-varid'>lazy_fv</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-layout'>,</span><span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-54"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>sigs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>lazy_fv'</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>pair'</span><span class='hs-layout'>)</span>
<a name="line-55"></a>          <span class='hs-keyword'>where</span>
<a name="line-56"></a>	    <span class='hs-layout'>(</span><span class='hs-varid'>sigs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>lazy_fv1</span><span class='hs-layout'>,</span> <span class='hs-varid'>pair'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmdAnalRhs</span> <span class='hs-varid'>top_lvl</span> <span class='hs-conid'>Recursive</span> <span class='hs-layout'>(</span><span class='hs-varid'>updSigEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-layout'>,</span><span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-57"></a>	    <span class='hs-varid'>lazy_fv'</span>		     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusVarEnv_C</span> <span class='hs-varid'>both</span> <span class='hs-varid'>lazy_fv</span> <span class='hs-varid'>lazy_fv1</span>
<a name="line-58"></a>	   
<a name="line-59"></a>    <span class='hs-varid'>same_sig</span> <span class='hs-varid'>sigs</span> <span class='hs-varid'>sigs'</span> <span class='hs-varid'>var</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookup</span> <span class='hs-varid'>sigs</span> <span class='hs-varid'>var</span> <span class='hs-varop'>==</span> <span class='hs-varid'>lookup</span> <span class='hs-varid'>sigs'</span> <span class='hs-varid'>var</span>
<a name="line-60"></a>    <span class='hs-varid'>lookup</span> <span class='hs-varid'>sigs</span> <span class='hs-varid'>var</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>sigs</span> <span class='hs-varid'>var</span> <span class='hs-keyword'>of</span>
<a name="line-61"></a>			<span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>sig</span>
<a name="line-62"></a>                        <span class='hs-conid'>Nothing</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"dmdFix"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span>
<a name="line-63"></a>
<a name="line-64"></a><a name="dmdAnalRhs"></a><span class='hs-definition'>dmdAnalRhs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TopLevelFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RecFlag</span>
<a name="line-65"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AnalEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span>
<a name="line-66"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>SigEnv</span><span class='hs-layout'>,</span>  <span class='hs-conid'>DmdEnv</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-67"></a><span class='hs-comment'>-- Process the RHS of the binding, add the strictness signature</span>
<a name="line-68"></a><span class='hs-comment'>-- to the Id, and augment the environment with the signature as well.</span>
<a name="line-69"></a>
<a name="line-70"></a><span class='hs-definition'>dmdAnalRhs</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>rec_flag</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-71"></a> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>sigs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>lazy_fv</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>id'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-72"></a> <span class='hs-keyword'>where</span>
<a name="line-73"></a>  <span class='hs-varid'>arity</span>		     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idArity</span> <span class='hs-varid'>id</span>   <span class='hs-comment'>-- The idArity should be up to date</span>
<a name="line-74"></a>				    <span class='hs-comment'>-- The simplifier was run just beforehand</span>
<a name="line-75"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>rhs_dmd_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmdAnal</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>vanillaCall</span> <span class='hs-varid'>arity</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhs</span>
<a name="line-76"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>lazy_fv</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-varid'>arity</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>dmdTypeDepth</span> <span class='hs-varid'>rhs_dmd_ty</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprIsTrivial</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span> <span class='hs-layout'>)</span>
<a name="line-77"></a>				<span class='hs-comment'>-- The RHS can be eta-reduced to just a variable, </span>
<a name="line-78"></a>				<span class='hs-comment'>-- in which case we should not complain. </span>
<a name="line-79"></a>		       <span class='hs-varid'>mkSigTy</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>rec_flag</span> <span class='hs-varid'>id</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>rhs_dmd_ty</span>
<a name="line-80"></a>  <span class='hs-varid'>id'</span>		     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span> <span class='hs-varop'>`setIdStrictness`</span> <span class='hs-varid'>sig_ty</span>
<a name="line-81"></a>  <span class='hs-varid'>sigs'</span>		     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendSigEnv</span> <span class='hs-varid'>top_lvl</span> <span class='hs-layout'>(</span><span class='hs-varid'>sigEnv</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span> <span class='hs-varid'>sig_ty</span>
</pre>\end{code}


%************************************************************************
%*									*
\subsection{Strictness signatures and types}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="mkTopSigTy"></a><span class='hs-definition'>mkTopSigTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrictSig</span>
<a name="line-2"></a>	<span class='hs-comment'>-- Take a DmdType and turn it into a StrictSig</span>
<a name="line-3"></a>	<span class='hs-comment'>-- NB: not used for never-inline things; hence False</span>
<a name="line-4"></a><span class='hs-definition'>mkTopSigTy</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>dmd_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>snd</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_sig_ty</span> <span class='hs-conid'>False</span> <span class='hs-conid'>False</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>dmd_ty</span><span class='hs-layout'>)</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="mkSigTy"></a><span class='hs-definition'>mkSigTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TopLevelFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RecFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>StrictSig</span><span class='hs-layout'>)</span>
<a name="line-7"></a><span class='hs-definition'>mkSigTy</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>rec_flag</span> <span class='hs-varid'>id</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>dmd_ty</span> 
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_sig_ty</span> <span class='hs-varid'>never_inline</span> <span class='hs-varid'>thunk_cpr_ok</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>dmd_ty</span>
<a name="line-9"></a>  <span class='hs-keyword'>where</span>
<a name="line-10"></a>    <span class='hs-varid'>never_inline</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isNeverActive</span> <span class='hs-layout'>(</span><span class='hs-varid'>idInlineActivation</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-11"></a>    <span class='hs-varid'>maybe_id_dmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idDemandInfo_maybe</span> <span class='hs-varid'>id</span>
<a name="line-12"></a>	<span class='hs-comment'>-- Is Nothing the first time round</span>
<a name="line-13"></a>
<a name="line-14"></a>    <span class='hs-varid'>thunk_cpr_ok</span>   <span class='hs-comment'>-- See Note [CPR for thunks]</span>
<a name="line-15"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTopLevel</span> <span class='hs-varid'>top_lvl</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>	<span class='hs-comment'>-- Top level things don't get</span>
<a name="line-16"></a>						<span class='hs-comment'>-- their demandInfo set at all</span>
<a name="line-17"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-varid'>isRec</span> <span class='hs-varid'>rec_flag</span>	   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>	<span class='hs-comment'>-- Ditto recursive things</span>
<a name="line-18"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>dmd</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>maybe_id_dmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isStrictDmd</span> <span class='hs-varid'>dmd</span>
<a name="line-19"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> 		   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>	<span class='hs-comment'>-- Optimistic, first time round</span>
<a name="line-20"></a>						<span class='hs-comment'>-- See notes below</span>
</pre>\end{code}

Note [CPR for thunks]
~~~~~~~~~~~~~~~~~~~~~
If the rhs is a thunk, we usually forget the CPR info, because
it is presumably shared (else it would have been inlined, and 
so we'd lose sharing if w/w'd it into a function).  E.g.

	let r = case expensive of
		  (a,b) -> (b,a)
	in ...

If we marked r as having the CPR property, then we'd w/w into

	let $wr = \() -> case expensive of
			    (a,b) -> (# b, a #)
	    r = case $wr () of
		  (# b,a #) -> (b,a)
	in ...

But now r is a thunk, which won't be inlined, so we are no further ahead.
But consider

	f x = let r = case expensive of (a,b) -> (b,a)
	      in if foo r then r else (x,x)

Does f have the CPR property?  Well, no.

However, if the strictness analyser has figured out (in a previous 
iteration) that it's strict, then we DON'T need to forget the CPR info.
Instead we can retain the CPR info and do the thunk-splitting transform 
(see WorkWrap.splitThunk).

This made a big difference to PrelBase.modInt, which had something like
	modInt = \ x -> let r = ... -> I# v in
			...body strict in r...
r's RHS isn't a value yet; but modInt returns r in various branches, so
if r doesn't have the CPR property then neither does modInt
Another case I found in practice (in Complex.magnitude), looks like this:
		let k = if ... then I# a else I# b
		in ... body strict in k ....
(For this example, it doesn't matter whether k is returned as part of
the overall result; but it does matter that k's RHS has the CPR property.)  
Left to itself, the simplifier will make a join point thus:
		let $j k = ...body strict in k...
		if ... then $j (I# a) else $j (I# b)
With thunk-splitting, we get instead
		let $j x = let k = I#x in ...body strict in k...
		in if ... then $j a else $j b
This is much better; there's a good chance the I# won't get allocated.

The difficulty with this is that we need the strictness type to
look at the body... but we now need the body to calculate the demand
on the variable, so we can decide whether its strictness type should
have a CPR in it or not.  Simple solution: 
	a) use strictness info from the previous iteration
	b) make sure we do at least 2 iterations, by doing a second
	   round for top-level non-recs.  Top level recs will get at
	   least 2 iterations except for totally-bottom functions
	   which aren't very interesting anyway.

NB: strictly_demanded is never true of a top-level Id, or of a recursive Id.

Note [Optimistic in the Nothing case]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Demand info now has a 'Nothing' state, just like strictness info.
The analysis works from 'dangerous' towards a 'safe' state; so we 
start with botSig for 'Nothing' strictness infos, and we start with
"yes, it's demanded" for 'Nothing' in the demand info.  The
fixpoint iteration will sort it all out.

We can't start with 'not-demanded' because then consider
	f x = let 
		  t = ... I# x
	      in
	      if ... then t else I# y else f x'

In the first iteration we'd have no demand info for x, so assume
not-demanded; then we'd get TopRes for f's CPR info.  Next iteration
we'd see that t was demanded, and so give it the CPR property, but by
now f has TopRes, so it will stay TopRes.  Instead, with the Nothing
setting the first time round, we say 'yes t is demanded' the first
time.

However, this does mean that for non-recursive bindings we must
iterate twice to be sure of not getting over-optimistic CPR info,
in the case where t turns out to be not-demanded.  This is handled
by dmdAnalTopBind.


Note [NOINLINE and strictness]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The strictness analyser used to have a HACK which ensured that NOINLNE
things were not strictness-analysed.  The reason was unsafePerformIO. 
Left to itself, the strictness analyser would discover this strictness 
for unsafePerformIO:
	unsafePerformIO:  C(U(AV))
But then consider this sub-expression
	unsafePerformIO (\s -> let r = f x in 
			       case writeIORef v r s of (# s1, _ #) ->
			       (# s1, r #)
The strictness analyser will now find that r is sure to be eval'd,
and may then hoist it out.  This makes tests/lib/should_run/memo002
deadlock.

Solving this by making all NOINLINE things have no strictness info is overkill.
In particular, it's overkill for runST, which is perfectly respectable.
Consider
	f x = runST (return x)
This should be strict in x.

So the new plan is to define unsafePerformIO using the 'lazy' combinator:

	unsafePerformIO (IO m) = lazy (case m realWorld# of (# _, r #) -> r)

Remember, 'lazy' is a wired-in identity-function Id, of type a->a, which is 
magically NON-STRICT, and is inlined after strictness analysis.  So
unsafePerformIO will look non-strict, and that's what we want.

Now we don't need the hack in the strictness analyser.  HOWEVER, this
decision does mean that even a NOINLINE function is not entirely
opaque: some aspect of its implementation leaks out, notably its
strictness.  For example, if you have a function implemented by an
error stub, but which has RULES, you may want it not to be eliminated
in favour of error!


\begin{code}
<pre><a name="line-1"></a><a name="mk_sig_ty"></a><span class='hs-definition'>mk_sig_ty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-2"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>StrictSig</span><span class='hs-layout'>)</span>
<a name="line-3"></a><span class='hs-definition'>mk_sig_ty</span> <span class='hs-sel'>_never_inline</span> <span class='hs-varid'>thunk_cpr_ok</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>dmds</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> 
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>lazy_fv</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkStrictSig</span> <span class='hs-varid'>dmd_ty</span><span class='hs-layout'>)</span>
<a name="line-5"></a>	<span class='hs-comment'>-- Re unused never_inline, see Note [NOINLINE and strictness]</span>
<a name="line-6"></a>  <span class='hs-keyword'>where</span>
<a name="line-7"></a>    <span class='hs-varid'>dmd_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-varid'>strict_fv</span> <span class='hs-varid'>final_dmds</span> <span class='hs-varid'>res'</span>
<a name="line-8"></a>
<a name="line-9"></a>    <span class='hs-varid'>lazy_fv</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterUFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isStrictDmd</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv</span>
<a name="line-10"></a>    <span class='hs-varid'>strict_fv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterUFM</span> <span class='hs-varid'>isStrictDmd</span>         <span class='hs-varid'>fv</span>
<a name="line-11"></a>	<span class='hs-comment'>-- We put the strict FVs in the DmdType of the Id, so </span>
<a name="line-12"></a>	<span class='hs-comment'>-- that at its call sites we unleash demands on its strict fvs.</span>
<a name="line-13"></a>	<span class='hs-comment'>-- An example is 'roll' in imaginary/wheel-sieve2</span>
<a name="line-14"></a>	<span class='hs-comment'>-- Something like this:</span>
<a name="line-15"></a>	<span class='hs-comment'>--	roll x = letrec </span>
<a name="line-16"></a>	<span class='hs-comment'>--		     go y = if ... then roll (x-1) else x+1</span>
<a name="line-17"></a>	<span class='hs-comment'>--		 in </span>
<a name="line-18"></a>	<span class='hs-comment'>--		 go ms</span>
<a name="line-19"></a>	<span class='hs-comment'>-- We want to see that roll is strict in x, which is because</span>
<a name="line-20"></a>	<span class='hs-comment'>-- go is called.   So we put the DmdEnv for x in go's DmdType.</span>
<a name="line-21"></a>	<span class='hs-comment'>--</span>
<a name="line-22"></a>	<span class='hs-comment'>-- Another example:</span>
<a name="line-23"></a>	<span class='hs-comment'>--	f :: Int -&gt; Int -&gt; Int</span>
<a name="line-24"></a>	<span class='hs-comment'>--	f x y = let t = x+1</span>
<a name="line-25"></a>	<span class='hs-comment'>--	    h z = if z==0 then t else </span>
<a name="line-26"></a>	<span class='hs-comment'>--		  if z==1 then x+1 else</span>
<a name="line-27"></a>	<span class='hs-comment'>--		  x + h (z-1)</span>
<a name="line-28"></a>	<span class='hs-comment'>--	in</span>
<a name="line-29"></a>	<span class='hs-comment'>--	h y</span>
<a name="line-30"></a>	<span class='hs-comment'>-- Calling h does indeed evaluate x, but we can only see</span>
<a name="line-31"></a>	<span class='hs-comment'>-- that if we unleash a demand on x at the call site for t.</span>
<a name="line-32"></a>	<span class='hs-comment'>--</span>
<a name="line-33"></a>	<span class='hs-comment'>-- Incidentally, here's a place where lambda-lifting h would</span>
<a name="line-34"></a>	<span class='hs-comment'>-- lose the cigar --- we couldn't see the joint strictness in t/x</span>
<a name="line-35"></a>	<span class='hs-comment'>--</span>
<a name="line-36"></a>	<span class='hs-comment'>--	ON THE OTHER HAND</span>
<a name="line-37"></a>	<span class='hs-comment'>-- We don't want to put *all* the fv's from the RHS into the</span>
<a name="line-38"></a>	<span class='hs-comment'>-- DmdType, because that makes fixpointing very slow --- the </span>
<a name="line-39"></a>	<span class='hs-comment'>-- DmdType gets full of lazy demands that are slow to converge.</span>
<a name="line-40"></a>
<a name="line-41"></a>    <span class='hs-varid'>final_dmds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setUnpackStrategy</span> <span class='hs-varid'>dmds</span>
<a name="line-42"></a>	<span class='hs-comment'>-- Set the unpacking strategy</span>
<a name="line-43"></a>	
<a name="line-44"></a>    <span class='hs-varid'>res'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>res</span> <span class='hs-keyword'>of</span>
<a name="line-45"></a>		<span class='hs-conid'>RetCPR</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ignore_cpr_info</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TopRes</span>
<a name="line-46"></a>		<span class='hs-keyword'>_</span>	 		 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>res</span>
<a name="line-47"></a>    <span class='hs-varid'>ignore_cpr_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>exprIsHNF</span> <span class='hs-varid'>rhs</span> <span class='hs-varop'>||</span> <span class='hs-varid'>thunk_cpr_ok</span><span class='hs-layout'>)</span>
</pre>\end{code}

The unpack strategy determines whether we'll *really* unpack the argument,
or whether we'll just remember its strictness.  If unpacking would give
rise to a *lot* of worker args, we may decide not to unpack after all.

\begin{code}
<pre><a name="line-1"></a><a name="setUnpackStrategy"></a><span class='hs-definition'>setUnpackStrategy</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Demand</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Demand</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-definition'>setUnpackStrategy</span> <span class='hs-varid'>ds</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>snd</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>opt_MaxWorkerArgs</span> <span class='hs-comment'>-</span> <span class='hs-varid'>nonAbsentArgs</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>
<a name="line-4"></a>  <span class='hs-keyword'>where</span>
<a name="line-5"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> 			<span class='hs-comment'>-- Max number of args available for sub-components of [Demand]</span>
<a name="line-6"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Demand</span><span class='hs-keyglyph'>]</span>
<a name="line-7"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Demand</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>	<span class='hs-comment'>-- Args remaining after subcomponents of [Demand] are unpacked</span>
<a name="line-8"></a>
<a name="line-9"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eval</span> <span class='hs-layout'>(</span><span class='hs-conid'>Prod</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span> 
<a name="line-10"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-varid'>n'</span> <span class='hs-varop'>&gt;=</span> <span class='hs-num'>0</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Eval</span> <span class='hs-layout'>(</span><span class='hs-conid'>Prod</span> <span class='hs-varid'>cs'</span><span class='hs-layout'>)</span> <span class='hs-varop'>`cons`</span> <span class='hs-varid'>go</span> <span class='hs-varid'>n''</span> <span class='hs-varid'>ds</span>
<a name="line-11"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Box</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eval</span> <span class='hs-layout'>(</span><span class='hs-conid'>Prod</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>`cons`</span> <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ds</span>
<a name="line-12"></a>	<span class='hs-keyword'>where</span>
<a name="line-13"></a>	  <span class='hs-layout'>(</span><span class='hs-varid'>n''</span><span class='hs-layout'>,</span><span class='hs-varid'>cs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>n'</span> <span class='hs-varid'>cs</span>
<a name="line-14"></a>	  <span class='hs-varid'>n'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span> <span class='hs-comment'>-</span> <span class='hs-varid'>non_abs_args</span>
<a name="line-15"></a>		<span class='hs-comment'>-- Add one to the budget 'cos we drop the top-level arg</span>
<a name="line-16"></a>	  <span class='hs-varid'>non_abs_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nonAbsentArgs</span> <span class='hs-varid'>cs</span>
<a name="line-17"></a>		<span class='hs-comment'>-- Delete # of non-absent args to which we'll now be committed</span>
<a name="line-18"></a>				
<a name="line-19"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>d</span><span class='hs-conop'>:</span><span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span> <span class='hs-varop'>`cons`</span> <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ds</span>
<a name="line-20"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-21"></a>
<a name="line-22"></a>    <span class='hs-varid'>cons</span> <span class='hs-varid'>d</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span><span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>d</span><span class='hs-conop'>:</span><span class='hs-varid'>ds</span><span class='hs-layout'>)</span>
<a name="line-23"></a>
<a name="line-24"></a><a name="nonAbsentArgs"></a><span class='hs-definition'>nonAbsentArgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Demand</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-25"></a><span class='hs-definition'>nonAbsentArgs</span> <span class='hs-conid'>[]</span>	 <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-26"></a><span class='hs-definition'>nonAbsentArgs</span> <span class='hs-layout'>(</span><span class='hs-conid'>Abs</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nonAbsentArgs</span> <span class='hs-varid'>ds</span>
<a name="line-27"></a><span class='hs-definition'>nonAbsentArgs</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span>   <span class='hs-conop'>:</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>nonAbsentArgs</span> <span class='hs-varid'>ds</span>
</pre>\end{code}


%************************************************************************
%*									*
\subsection{Strictness signatures and types}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="unitVarDmd"></a><span class='hs-definition'>unitVarDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-2"></a><span class='hs-definition'>unitVarDmd</span> <span class='hs-varid'>var</span> <span class='hs-varid'>dmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitVarEnv</span> <span class='hs-varid'>var</span> <span class='hs-varid'>dmd</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>TopRes</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="addVarDmd"></a><span class='hs-definition'>addVarDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-5"></a><span class='hs-definition'>addVarDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-varid'>var</span> <span class='hs-varid'>dmd</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv_C</span> <span class='hs-varid'>both</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>var</span> <span class='hs-varid'>dmd</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="addLazyFVs"></a><span class='hs-definition'>addLazyFVs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-9"></a><span class='hs-definition'>addLazyFVs</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-varid'>lazy_fvs</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-varid'>both_fv1</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res</span>
<a name="line-11"></a>  <span class='hs-keyword'>where</span>
<a name="line-12"></a>    <span class='hs-varid'>both_fv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusVarEnv_C</span> <span class='hs-varid'>both</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>lazy_fvs</span>
<a name="line-13"></a>    <span class='hs-varid'>both_fv1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>isBotRes</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varop'>`both`</span> <span class='hs-conid'>Bot</span><span class='hs-layout'>)</span> <span class='hs-varid'>lazy_fvs</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>both_fv</span>
<a name="line-14"></a>	<span class='hs-comment'>-- This modifyEnv is vital.  Consider</span>
<a name="line-15"></a>	<span class='hs-comment'>--	let f = \x -&gt; (x,y)</span>
<a name="line-16"></a>	<span class='hs-comment'>--	in  error (f 3)</span>
<a name="line-17"></a>	<span class='hs-comment'>-- Here, y is treated as a lazy-fv of f, but we must `both` that L</span>
<a name="line-18"></a>	<span class='hs-comment'>-- demand with the bottom coming up from 'error'</span>
<a name="line-19"></a>	<span class='hs-comment'>-- </span>
<a name="line-20"></a>	<span class='hs-comment'>-- I got a loop in the fixpointer without this, due to an interaction</span>
<a name="line-21"></a>	<span class='hs-comment'>-- with the lazy_fv filtering in mkSigTy.  Roughly, it was</span>
<a name="line-22"></a>	<span class='hs-comment'>--	letrec f n x </span>
<a name="line-23"></a>	<span class='hs-comment'>--	    = letrec g y = x `fatbar` </span>
<a name="line-24"></a>	<span class='hs-comment'>--			   letrec h z = z + ...g...</span>
<a name="line-25"></a>	<span class='hs-comment'>--			   in h (f (n-1) x)</span>
<a name="line-26"></a>	<span class='hs-comment'>-- 	in ...</span>
<a name="line-27"></a>	<span class='hs-comment'>-- In the initial iteration for f, f=Bot</span>
<a name="line-28"></a>	<span class='hs-comment'>-- Suppose h is found to be strict in z, but the occurrence of g in its RHS</span>
<a name="line-29"></a>	<span class='hs-comment'>-- is lazy.  Now consider the fixpoint iteration for g, esp the demands it</span>
<a name="line-30"></a>	<span class='hs-comment'>-- places on its free variables.  Suppose it places none.  Then the</span>
<a name="line-31"></a>	<span class='hs-comment'>-- 	x `fatbar` ...call to h...</span>
<a name="line-32"></a>	<span class='hs-comment'>-- will give a x-&gt;V demand for x.  That turns into a L demand for x,</span>
<a name="line-33"></a>	<span class='hs-comment'>-- which floats out of the defn for h.  Without the modifyEnv, that</span>
<a name="line-34"></a>	<span class='hs-comment'>-- L demand doesn't get both'd with the Bot coming up from the inner</span>
<a name="line-35"></a>	<span class='hs-comment'>-- call to f.  So we just get an L demand for x for g.</span>
<a name="line-36"></a>	<span class='hs-comment'>--</span>
<a name="line-37"></a>	<span class='hs-comment'>-- A better way to say this is that the lazy-fv filtering should give the</span>
<a name="line-38"></a>	<span class='hs-comment'>-- same answer as putting the lazy fv demands in the function's type.</span>
<a name="line-39"></a>
<a name="line-40"></a><a name="annotateBndr"></a><span class='hs-definition'>annotateBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span><span class='hs-layout'>,</span> <span class='hs-conid'>Var</span><span class='hs-layout'>)</span>
<a name="line-41"></a><span class='hs-comment'>-- The returned env has the var deleted</span>
<a name="line-42"></a><span class='hs-comment'>-- The returned var is annotated with demand info</span>
<a name="line-43"></a><span class='hs-comment'>-- No effect on the argument demands</span>
<a name="line-44"></a><span class='hs-definition'>annotateBndr</span> <span class='hs-varid'>dmd_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-varid'>var</span>
<a name="line-45"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>var</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>dmd_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span>
<a name="line-46"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv'</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-varid'>setIdDemandInfo</span> <span class='hs-varid'>var</span> <span class='hs-varid'>dmd</span><span class='hs-layout'>)</span>
<a name="line-47"></a>  <span class='hs-keyword'>where</span>
<a name="line-48"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>fv'</span><span class='hs-layout'>,</span> <span class='hs-varid'>dmd</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>removeFV</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>var</span> <span class='hs-varid'>res</span>
<a name="line-49"></a>
<a name="line-50"></a><a name="annotateBndrs"></a><span class='hs-definition'>annotateBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-51"></a><span class='hs-definition'>annotateBndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumR</span> <span class='hs-varid'>annotateBndr</span>
<a name="line-52"></a>
<a name="line-53"></a><a name="annotateLamIdBndr"></a><span class='hs-definition'>annotateLamIdBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AnalEnv</span>
<a name="line-54"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span> 	<span class='hs-comment'>-- Demand type of body</span>
<a name="line-55"></a>		  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> 	<span class='hs-comment'>-- Lambda binder</span>
<a name="line-56"></a>		  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span><span class='hs-layout'>,</span> 	<span class='hs-comment'>-- Demand type of lambda</span>
<a name="line-57"></a>		      <span class='hs-conid'>Id</span><span class='hs-layout'>)</span>	<span class='hs-comment'>-- and binder annotated with demand	</span>
<a name="line-58"></a>
<a name="line-59"></a><span class='hs-definition'>annotateLamIdBndr</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span>
<a name="line-60"></a><span class='hs-comment'>-- For lambdas we add the demand to the argument demands</span>
<a name="line-61"></a><span class='hs-comment'>-- Only called for Ids</span>
<a name="line-62"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isId</span> <span class='hs-varid'>id</span> <span class='hs-layout'>)</span>
<a name="line-63"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>final_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>setIdDemandInfo</span> <span class='hs-varid'>id</span> <span class='hs-varid'>hacked_dmd</span><span class='hs-layout'>)</span>
<a name="line-64"></a>  <span class='hs-keyword'>where</span>
<a name="line-65"></a>      <span class='hs-comment'>-- Watch out!  See note [Lambda-bound unfoldings]</span>
<a name="line-66"></a>    <span class='hs-varid'>final_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>maybeUnfoldingTemplate</span> <span class='hs-layout'>(</span><span class='hs-varid'>idUnfolding</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-67"></a>                 <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>main_ty</span>
<a name="line-68"></a>                 <span class='hs-conid'>Just</span> <span class='hs-varid'>unf</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>main_ty</span> <span class='hs-varop'>`bothType`</span> <span class='hs-varid'>unf_ty</span>
<a name="line-69"></a>                          <span class='hs-keyword'>where</span>
<a name="line-70"></a>                             <span class='hs-layout'>(</span><span class='hs-varid'>unf_ty</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmdAnal</span> <span class='hs-varid'>env</span> <span class='hs-varid'>dmd</span> <span class='hs-varid'>unf</span>
<a name="line-71"></a>    
<a name="line-72"></a>    <span class='hs-varid'>main_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv'</span> <span class='hs-layout'>(</span><span class='hs-varid'>hacked_dmd</span><span class='hs-conop'>:</span><span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-varid'>res</span>
<a name="line-73"></a>
<a name="line-74"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>fv'</span><span class='hs-layout'>,</span> <span class='hs-varid'>dmd</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>removeFV</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>id</span> <span class='hs-varid'>res</span>
<a name="line-75"></a>    <span class='hs-varid'>hacked_dmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>argDemand</span> <span class='hs-varid'>dmd</span>
<a name="line-76"></a>	<span class='hs-comment'>-- This call to argDemand is vital, because otherwise we label</span>
<a name="line-77"></a>	<span class='hs-comment'>-- a lambda binder with demand 'B'.  But in terms of calling</span>
<a name="line-78"></a>	<span class='hs-comment'>-- conventions that's Abs, because we don't pass it.  But</span>
<a name="line-79"></a>	<span class='hs-comment'>-- when we do a w/w split we get</span>
<a name="line-80"></a>	<span class='hs-comment'>--	fw x = (\x y:B -&gt; ...) x (error "oops")</span>
<a name="line-81"></a>	<span class='hs-comment'>-- And then the simplifier things the 'B' is a strict demand</span>
<a name="line-82"></a>	<span class='hs-comment'>-- and evaluates the (error "oops").  Sigh</span>
<a name="line-83"></a>
<a name="line-84"></a><a name="removeFV"></a><span class='hs-definition'>removeFV</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>Demand</span><span class='hs-layout'>)</span>
<a name="line-85"></a><span class='hs-definition'>removeFV</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>id</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>fv'</span><span class='hs-layout'>,</span> <span class='hs-varid'>zapUnlifted</span> <span class='hs-varid'>id</span> <span class='hs-varid'>dmd</span><span class='hs-layout'>)</span>
<a name="line-86"></a>		<span class='hs-keyword'>where</span>
<a name="line-87"></a>		  <span class='hs-varid'>fv'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fv</span> <span class='hs-varop'>`delVarEnv`</span> <span class='hs-varid'>id</span>
<a name="line-88"></a>		  <span class='hs-varid'>dmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>id</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>deflt</span>
<a name="line-89"></a>	 	  <span class='hs-varid'>deflt</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isBotRes</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Bot</span>
<a name="line-90"></a>		        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Abs</span>
<a name="line-91"></a>
<a name="line-92"></a><a name="zapUnlifted"></a><span class='hs-definition'>zapUnlifted</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span>
<a name="line-93"></a><span class='hs-comment'>-- For unlifted-type variables, we are only </span>
<a name="line-94"></a><span class='hs-comment'>-- interested in Bot/Abs/Box Abs</span>
<a name="line-95"></a><span class='hs-definition'>zapUnlifted</span> <span class='hs-varid'>id</span> <span class='hs-varid'>dmd</span>
<a name="line-96"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>dmd</span> <span class='hs-keyword'>of</span>
<a name="line-97"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isCoVarType</span> <span class='hs-varid'>ty</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>lazyDmd</span>	<span class='hs-comment'>-- For coercions, ignore str/abs totally</span>
<a name="line-98"></a>      <span class='hs-conid'>Bot</span>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bot</span>
<a name="line-99"></a>      <span class='hs-conid'>Abs</span>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Abs</span>
<a name="line-100"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isUnLiftedType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>lazyDmd</span>	<span class='hs-comment'>-- For unlifted types, ignore strictness</span>
<a name="line-101"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>	    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>dmd</span>
<a name="line-102"></a>  <span class='hs-keyword'>where</span>
<a name="line-103"></a>    <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idType</span> <span class='hs-varid'>id</span>
</pre>\end{code}

Note [Lamba-bound unfoldings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We allow a lambda-bound variable to carry an unfolding, a facility that is used
exclusively for join points; see Note [Case binders and join points].  If so,
we must be careful to demand-analyse the RHS of the unfolding!  Example
   \x. \y{=Just x}. <body>
Then if <body> uses 'y', then transitively it uses 'x', and we must not
forget that fact, otherwise we might make 'x' absent when it isn't.


%************************************************************************
%*									*
\subsection{Strictness signatures}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="AnalEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>AnalEnv</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ae_sigs</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SigEnv</span>
<a name="line-3"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>ae_virgin</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-layout'>}</span>  <span class='hs-comment'>-- True on first iteration only</span>
<a name="line-4"></a>		              <span class='hs-comment'>-- See Note [Initialising strictness]</span>
<a name="line-5"></a>	<span class='hs-comment'>-- We use the se_env to tell us whether to</span>
<a name="line-6"></a>	<span class='hs-comment'>-- record info about a variable in the DmdEnv</span>
<a name="line-7"></a>	<span class='hs-comment'>-- We do so if it's a LocalId, but not top-level</span>
<a name="line-8"></a>	<span class='hs-comment'>--</span>
<a name="line-9"></a>	<span class='hs-comment'>-- The DmdEnv gives the demand on the free vars of the function</span>
<a name="line-10"></a>	<span class='hs-comment'>-- when it is given enough args to satisfy the strictness signature</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="SigEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>SigEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VarEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span><span class='hs-layout'>,</span> <span class='hs-conid'>TopLevelFlag</span><span class='hs-layout'>)</span>
<a name="line-13"></a>
<a name="line-14"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>AnalEnv</span> <span class='hs-keyword'>where</span>
<a name="line-15"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>AE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ae_sigs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-varid'>ae_virgin</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>virgin</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-16"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"AE"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span>
<a name="line-17"></a>         <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"ae_virgin ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>virgin</span>
<a name="line-18"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"ae_sigs ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="emptySigEnv"></a><span class='hs-definition'>emptySigEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SigEnv</span>
<a name="line-21"></a><span class='hs-definition'>emptySigEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="sigEnv"></a><span class='hs-definition'>sigEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AnalEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SigEnv</span>
<a name="line-24"></a><span class='hs-definition'>sigEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ae_sigs</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="updSigEnv"></a><span class='hs-definition'>updSigEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AnalEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SigEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AnalEnv</span>
<a name="line-27"></a><span class='hs-definition'>updSigEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>sigs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ae_sigs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sigs</span> <span class='hs-layout'>}</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="extendAnalEnv"></a><span class='hs-definition'>extendAnalEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TopLevelFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AnalEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AnalEnv</span>
<a name="line-30"></a><span class='hs-definition'>extendAnalEnv</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>env</span> <span class='hs-varid'>var</span> <span class='hs-varid'>sig</span>
<a name="line-31"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ae_sigs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendSigEnv</span> <span class='hs-varid'>top_lvl</span> <span class='hs-layout'>(</span><span class='hs-varid'>ae_sigs</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>var</span> <span class='hs-varid'>sig</span> <span class='hs-layout'>}</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="extendSigEnv"></a><span class='hs-definition'>extendSigEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TopLevelFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SigEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrictSig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SigEnv</span>
<a name="line-34"></a><span class='hs-definition'>extendSigEnv</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>sigs</span> <span class='hs-varid'>var</span> <span class='hs-varid'>sig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>sigs</span> <span class='hs-varid'>var</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig</span><span class='hs-layout'>,</span> <span class='hs-varid'>top_lvl</span><span class='hs-layout'>)</span>
<a name="line-35"></a>
<a name="line-36"></a><a name="lookupSigEnv"></a><span class='hs-definition'>lookupSigEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AnalEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>StrictSig</span><span class='hs-layout'>,</span> <span class='hs-conid'>TopLevelFlag</span><span class='hs-layout'>)</span>
<a name="line-37"></a><span class='hs-definition'>lookupSigEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>ae_sigs</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span>
<a name="line-38"></a>
<a name="line-39"></a><a name="addInitialSigs"></a><span class='hs-definition'>addInitialSigs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TopLevelFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AnalEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AnalEnv</span>
<a name="line-40"></a><span class='hs-comment'>-- See Note [Initialising strictness]</span>
<a name="line-41"></a><span class='hs-definition'>addInitialSigs</span> <span class='hs-varid'>top_lvl</span> <span class='hs-varid'>env</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>AE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ae_sigs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ae_virgin</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>virgin</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>ids</span>
<a name="line-42"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ae_sigs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnvList</span> <span class='hs-varid'>sigs</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>init_sig</span> <span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>top_lvl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-43"></a>                                          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ids</span> <span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-44"></a>  <span class='hs-keyword'>where</span>
<a name="line-45"></a>    <span class='hs-varid'>init_sig</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>virgin</span>    <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>botSig</span>
<a name="line-46"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idStrictness</span>
<a name="line-47"></a>
<a name="line-48"></a><a name="virgin"></a><span class='hs-definition'>virgin</span><span class='hs-layout'>,</span> <span class='hs-varid'>nonVirgin</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SigEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AnalEnv</span>
<a name="line-49"></a><span class='hs-definition'>virgin</span>    <span class='hs-varid'>sigs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ae_sigs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ae_virgin</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span>
<a name="line-50"></a><a name="nonVirgin"></a><span class='hs-definition'>nonVirgin</span> <span class='hs-varid'>sigs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AE</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ae_sigs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ae_virgin</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span> <span class='hs-layout'>}</span>
<a name="line-51"></a>
<a name="line-52"></a><a name="extendSigsWithLam"></a><span class='hs-definition'>extendSigsWithLam</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AnalEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AnalEnv</span>
<a name="line-53"></a><span class='hs-comment'>-- Extend the AnalEnv when we meet a lambda binder</span>
<a name="line-54"></a><span class='hs-comment'>-- If the binder is marked demanded with a product demand, then give it a CPR </span>
<a name="line-55"></a><span class='hs-comment'>-- signature, because in the likely event that this is a lambda on a fn defn </span>
<a name="line-56"></a><span class='hs-comment'>-- [we only use this when the lambda is being consumed with a call demand],</span>
<a name="line-57"></a><span class='hs-comment'>-- it'll be w/w'd and so it will be CPR-ish.  E.g.</span>
<a name="line-58"></a><span class='hs-comment'>--	f = \x::(Int,Int).  if ...strict in x... then</span>
<a name="line-59"></a><span class='hs-comment'>--				x</span>
<a name="line-60"></a><span class='hs-comment'>--			    else</span>
<a name="line-61"></a><span class='hs-comment'>--				(a,b)</span>
<a name="line-62"></a><span class='hs-comment'>-- We want f to have the CPR property because x does, by the time f has been w/w'd</span>
<a name="line-63"></a><span class='hs-comment'>--</span>
<a name="line-64"></a><span class='hs-comment'>-- Also note that we only want to do this for something that</span>
<a name="line-65"></a><span class='hs-comment'>-- definitely has product type, else we may get over-optimistic </span>
<a name="line-66"></a><span class='hs-comment'>-- CPR results (e.g. from \x -&gt; x!).</span>
<a name="line-67"></a>
<a name="line-68"></a><span class='hs-definition'>extendSigsWithLam</span> <span class='hs-varid'>env</span> <span class='hs-varid'>id</span>
<a name="line-69"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>idDemandInfo_maybe</span> <span class='hs-varid'>id</span> <span class='hs-keyword'>of</span>
<a name="line-70"></a>	<span class='hs-conid'>Nothing</span>	             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extendAnalEnv</span> <span class='hs-conid'>NotTopLevel</span> <span class='hs-varid'>env</span> <span class='hs-varid'>id</span> <span class='hs-varid'>cprSig</span>
<a name="line-71"></a>		<span class='hs-comment'>-- See Note [Optimistic in the Nothing case]</span>
<a name="line-72"></a>	<span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eval</span> <span class='hs-layout'>(</span><span class='hs-conid'>Prod</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extendAnalEnv</span> <span class='hs-conid'>NotTopLevel</span> <span class='hs-varid'>env</span> <span class='hs-varid'>id</span> <span class='hs-varid'>cprSig</span>
<a name="line-73"></a>	<span class='hs-keyword'>_</span>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>env</span>
</pre>\end{code}

Note [Initialising strictness]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Our basic plan is to initialise the strictness of each Id in 
a recursive group to "bottom", and find a fixpoint from there.
However, this group A might be inside an *enclosing* recursive
group B, in which case we'll do the entire fixpoint shebang on A
for each iteration of B.

To speed things up, we initialise each iteration of B from the result
of the last one, which is neatly recorded in each binder.  That way we
make use of earlier iterations of the fixpoint algorithm.  (Cunning
plan.)  

But on the *first* iteration we want to *ignore* the current strictness
of the Id, and start from "bottom".  Nowadays the Id can have a current
strictness, because interface files record strictness for nested bindings.
To know when we are in the first iteration, we look at the ae_virgin
field of the AnalEnv.


%************************************************************************
%*									*
                   Demands
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="splitDmdTy"></a><span class='hs-definition'>splitDmdTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Demand</span><span class='hs-layout'>,</span> <span class='hs-conid'>DmdType</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-comment'>-- Split off one function argument</span>
<a name="line-3"></a><span class='hs-comment'>-- We already have a suitable demand on all</span>
<a name="line-4"></a><span class='hs-comment'>-- free vars, so no need to add more!</span>
<a name="line-5"></a><span class='hs-definition'>splitDmdTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-layout'>(</span><span class='hs-varid'>dmd</span><span class='hs-conop'>:</span><span class='hs-varid'>dmds</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>dmd</span><span class='hs-layout'>,</span> <span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-varid'>dmds</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-6"></a><span class='hs-definition'>splitDmdTy</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>resTypeArgDmd</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="splitCallDmd"></a><span class='hs-definition'>splitCallDmd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>Demand</span><span class='hs-layout'>)</span>
<a name="line-9"></a><span class='hs-definition'>splitCallDmd</span> <span class='hs-layout'>(</span><span class='hs-conid'>Call</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>splitCallDmd</span> <span class='hs-varid'>d</span> <span class='hs-keyword'>of</span>
<a name="line-10"></a>			  <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-11"></a><span class='hs-definition'>splitCallDmd</span> <span class='hs-varid'>d</span>	      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-num'>0</span><span class='hs-layout'>,</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="vanillaCall"></a><span class='hs-definition'>vanillaCall</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span>
<a name="line-14"></a><span class='hs-definition'>vanillaCall</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evalDmd</span>
<a name="line-15"></a><span class='hs-definition'>vanillaCall</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Call</span> <span class='hs-layout'>(</span><span class='hs-varid'>vanillaCall</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="deferType"></a><span class='hs-definition'>deferType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-18"></a><span class='hs-definition'>deferType</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-layout'>(</span><span class='hs-varid'>deferEnv</span> <span class='hs-varid'>fv</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>TopRes</span>
<a name="line-19"></a>	<span class='hs-comment'>-- Notice that we throw away info about both arguments and results</span>
<a name="line-20"></a>	<span class='hs-comment'>-- For example,   f = let ... in \x -&gt; x</span>
<a name="line-21"></a>	<span class='hs-comment'>-- We don't want to get a stricness type V-&gt;T for f.</span>
<a name="line-22"></a>
<a name="line-23"></a><a name="deferEnv"></a><span class='hs-definition'>deferEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdEnv</span>
<a name="line-24"></a><span class='hs-definition'>deferEnv</span> <span class='hs-varid'>fv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapVarEnv</span> <span class='hs-varid'>defer</span> <span class='hs-varid'>fv</span>
<a name="line-25"></a>
<a name="line-26"></a>
<a name="line-27"></a><a name="argDemand"></a><span class='hs-comment'>----------------</span>
<a name="line-28"></a><span class='hs-definition'>argDemand</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span>
<a name="line-29"></a><span class='hs-comment'>-- The 'Defer' demands are just Lazy at function boundaries</span>
<a name="line-30"></a><span class='hs-comment'>-- Ugly!  Ask John how to improve it.</span>
<a name="line-31"></a><span class='hs-definition'>argDemand</span> <span class='hs-conid'>Top</span> 	    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lazyDmd</span>
<a name="line-32"></a><span class='hs-definition'>argDemand</span> <span class='hs-layout'>(</span><span class='hs-conid'>Defer</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lazyDmd</span>
<a name="line-33"></a><span class='hs-definition'>argDemand</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eval</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Eval</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapDmds</span> <span class='hs-varid'>argDemand</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>
<a name="line-34"></a><span class='hs-definition'>argDemand</span> <span class='hs-layout'>(</span><span class='hs-conid'>Box</span> <span class='hs-conid'>Bot</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evalDmd</span>
<a name="line-35"></a><span class='hs-definition'>argDemand</span> <span class='hs-layout'>(</span><span class='hs-conid'>Box</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>box</span> <span class='hs-layout'>(</span><span class='hs-varid'>argDemand</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span>
<a name="line-36"></a><span class='hs-definition'>argDemand</span> <span class='hs-conid'>Bot</span>	    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Abs</span>	<span class='hs-comment'>-- Don't pass args that are consumed (only) by bottom</span>
<a name="line-37"></a><span class='hs-definition'>argDemand</span> <span class='hs-varid'>d</span>	    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="lubType"></a><span class='hs-comment'>-------------------------</span>
<a name="line-2"></a><span class='hs-definition'>lubType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-3"></a><span class='hs-comment'>-- Consider (if x then y else []) with demand V</span>
<a name="line-4"></a><span class='hs-comment'>-- Then the first branch gives {y-&gt;V} and the second</span>
<a name="line-5"></a><span class='hs-comment'>--  *implicitly* has {y-&gt;A}.  So we must put {y-&gt;(V `lub` A)}</span>
<a name="line-6"></a><span class='hs-comment'>-- in the result env.</span>
<a name="line-7"></a><span class='hs-definition'>lubType</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv1</span> <span class='hs-varid'>ds1</span> <span class='hs-varid'>r1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv2</span> <span class='hs-varid'>ds2</span> <span class='hs-varid'>r2</span><span class='hs-layout'>)</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-varid'>lub_fv2</span> <span class='hs-layout'>(</span><span class='hs-varid'>lub_ds</span> <span class='hs-varid'>ds1</span> <span class='hs-varid'>ds2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>r1</span> <span class='hs-varop'>`lubRes`</span> <span class='hs-varid'>r2</span><span class='hs-layout'>)</span>
<a name="line-9"></a>  <span class='hs-keyword'>where</span>
<a name="line-10"></a>    <span class='hs-varid'>lub_fv</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusVarEnv_C</span> <span class='hs-varid'>lub</span> <span class='hs-varid'>fv1</span> <span class='hs-varid'>fv2</span>
<a name="line-11"></a>    <span class='hs-varid'>lub_fv1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isBotRes</span> <span class='hs-varid'>r1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>absLub</span> <span class='hs-varid'>fv2</span> <span class='hs-varid'>fv1</span> <span class='hs-varid'>lub_fv</span>
<a name="line-12"></a>    <span class='hs-varid'>lub_fv2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isBotRes</span> <span class='hs-varid'>r2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>absLub</span> <span class='hs-varid'>fv1</span> <span class='hs-varid'>fv2</span> <span class='hs-varid'>lub_fv1</span>
<a name="line-13"></a>	<span class='hs-comment'>-- lub is the identity for Bot</span>
<a name="line-14"></a>
<a name="line-15"></a>	<span class='hs-comment'>-- Extend the shorter argument list to match the longer</span>
<a name="line-16"></a>    <span class='hs-varid'>lub_ds</span> <span class='hs-layout'>(</span><span class='hs-varid'>d1</span><span class='hs-conop'>:</span><span class='hs-varid'>ds1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>d2</span><span class='hs-conop'>:</span><span class='hs-varid'>ds2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lub</span> <span class='hs-varid'>d1</span> <span class='hs-varid'>d2</span> <span class='hs-conop'>:</span> <span class='hs-varid'>lub_ds</span> <span class='hs-varid'>ds1</span> <span class='hs-varid'>ds2</span>
<a name="line-17"></a>    <span class='hs-varid'>lub_ds</span> <span class='hs-conid'>[]</span>	    <span class='hs-conid'>[]</span>	     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-18"></a>    <span class='hs-varid'>lub_ds</span> <span class='hs-varid'>ds1</span>	    <span class='hs-conid'>[]</span>	     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varop'>`lub`</span> <span class='hs-varid'>resTypeArgDmd</span> <span class='hs-varid'>r2</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds1</span>
<a name="line-19"></a>    <span class='hs-varid'>lub_ds</span> <span class='hs-conid'>[]</span>	    <span class='hs-varid'>ds2</span>	     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>resTypeArgDmd</span> <span class='hs-varid'>r1</span> <span class='hs-varop'>`lub`</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds2</span>
<a name="line-20"></a>
<a name="line-21"></a><a name="bothType"></a><span class='hs-comment'>-----------------------------------</span>
<a name="line-22"></a><span class='hs-definition'>bothType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdType</span>
<a name="line-23"></a><span class='hs-comment'>-- (t1 `bothType` t2) takes the argument/result info from t1,</span>
<a name="line-24"></a><span class='hs-comment'>-- using t2 just for its free-var info</span>
<a name="line-25"></a><span class='hs-comment'>-- NB: Don't forget about r2!  It might be BotRes, which is</span>
<a name="line-26"></a><span class='hs-comment'>--     a bottom demand on all the in-scope variables.</span>
<a name="line-27"></a><span class='hs-comment'>-- Peter: can this be done more neatly?</span>
<a name="line-28"></a><span class='hs-definition'>bothType</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv1</span> <span class='hs-varid'>ds1</span> <span class='hs-varid'>r1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>DmdType</span> <span class='hs-varid'>fv2</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>r2</span><span class='hs-layout'>)</span>
<a name="line-29"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DmdType</span> <span class='hs-varid'>both_fv2</span> <span class='hs-varid'>ds1</span> <span class='hs-layout'>(</span><span class='hs-varid'>r1</span> <span class='hs-varop'>`bothRes`</span> <span class='hs-varid'>r2</span><span class='hs-layout'>)</span>
<a name="line-30"></a>  <span class='hs-keyword'>where</span>
<a name="line-31"></a>    <span class='hs-varid'>both_fv</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusVarEnv_C</span> <span class='hs-varid'>both</span> <span class='hs-varid'>fv1</span> <span class='hs-varid'>fv2</span>
<a name="line-32"></a>    <span class='hs-varid'>both_fv1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>isBotRes</span> <span class='hs-varid'>r1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varop'>`both`</span> <span class='hs-conid'>Bot</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv2</span> <span class='hs-varid'>fv1</span> <span class='hs-varid'>both_fv</span>
<a name="line-33"></a>    <span class='hs-varid'>both_fv2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>isBotRes</span> <span class='hs-varid'>r2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varop'>`both`</span> <span class='hs-conid'>Bot</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv1</span> <span class='hs-varid'>fv2</span> <span class='hs-varid'>both_fv1</span>
<a name="line-34"></a>	<span class='hs-comment'>-- both is the identity for Abs</span>
</pre>\end{code}


\begin{code}
<pre><a name="line-1"></a><a name="lubRes"></a><span class='hs-definition'>lubRes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdResult</span>
<a name="line-2"></a><span class='hs-definition'>lubRes</span> <span class='hs-conid'>BotRes</span> <span class='hs-varid'>r</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span>
<a name="line-3"></a><span class='hs-definition'>lubRes</span> <span class='hs-varid'>r</span>      <span class='hs-conid'>BotRes</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span>
<a name="line-4"></a><span class='hs-definition'>lubRes</span> <span class='hs-conid'>RetCPR</span> <span class='hs-conid'>RetCPR</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RetCPR</span>
<a name="line-5"></a><span class='hs-definition'>lubRes</span> <span class='hs-keyword'>_</span>      <span class='hs-keyword'>_</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TopRes</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="bothRes"></a><span class='hs-definition'>bothRes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DmdResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdResult</span>
<a name="line-8"></a><span class='hs-comment'>-- If either diverges, the whole thing does</span>
<a name="line-9"></a><span class='hs-comment'>-- Otherwise take CPR info from the first</span>
<a name="line-10"></a><span class='hs-definition'>bothRes</span> <span class='hs-keyword'>_</span>  <span class='hs-conid'>BotRes</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BotRes</span>
<a name="line-11"></a><span class='hs-definition'>bothRes</span> <span class='hs-varid'>r1</span> <span class='hs-keyword'>_</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r1</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="modifyEnv"></a><span class='hs-definition'>modifyEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>			<span class='hs-comment'>-- No-op if False</span>
<a name="line-2"></a>	  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span><span class='hs-layout'>)</span>		<span class='hs-comment'>-- The zapper</span>
<a name="line-3"></a>	  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdEnv</span>		<span class='hs-comment'>-- Env1 and Env2</span>
<a name="line-4"></a>	  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DmdEnv</span>		<span class='hs-comment'>-- Transform this env</span>
<a name="line-5"></a>	<span class='hs-comment'>-- Zap anything in Env1 but not in Env2</span>
<a name="line-6"></a>	<span class='hs-comment'>-- Assume: dom(env) includes dom(Env1) and dom(Env2)</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-definition'>modifyEnv</span> <span class='hs-varid'>need_to_modify</span> <span class='hs-varid'>zapper</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>env2</span> <span class='hs-varid'>env</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>need_to_modify</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>zap</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>varEnvKeys</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span> <span class='hs-varop'>`minusUFM`</span> <span class='hs-varid'>env2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>	   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span>
<a name="line-11"></a>  <span class='hs-keyword'>where</span>
<a name="line-12"></a>    <span class='hs-varid'>zap</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addToUFM_Directly</span> <span class='hs-varid'>env</span> <span class='hs-varid'>uniq</span> <span class='hs-layout'>(</span><span class='hs-varid'>zapper</span> <span class='hs-varid'>current_val</span><span class='hs-layout'>)</span>
<a name="line-13"></a>		 <span class='hs-keyword'>where</span>
<a name="line-14"></a>		   <span class='hs-varid'>current_val</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expectJust</span> <span class='hs-str'>"modifyEnv"</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupUFM_Directly</span> <span class='hs-varid'>env</span> <span class='hs-varid'>uniq</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*									*
\subsection{LUB and BOTH}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="lub"></a><span class='hs-definition'>lub</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-definition'>lub</span> <span class='hs-conid'>Bot</span>  	<span class='hs-varid'>d2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d2</span>
<a name="line-4"></a><span class='hs-definition'>lub</span> <span class='hs-conid'>Abs</span>  	<span class='hs-varid'>d2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>absLub</span> <span class='hs-varid'>d2</span>
<a name="line-5"></a><span class='hs-definition'>lub</span> <span class='hs-conid'>Top</span> 	<span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Top</span>
<a name="line-6"></a><span class='hs-definition'>lub</span> <span class='hs-layout'>(</span><span class='hs-conid'>Defer</span> <span class='hs-varid'>ds1</span><span class='hs-layout'>)</span> <span class='hs-varid'>d2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defer</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eval</span> <span class='hs-varid'>ds1</span> <span class='hs-varop'>`lub`</span> <span class='hs-varid'>d2</span><span class='hs-layout'>)</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-definition'>lub</span> <span class='hs-layout'>(</span><span class='hs-conid'>Call</span> <span class='hs-varid'>d1</span><span class='hs-layout'>)</span>   <span class='hs-layout'>(</span><span class='hs-conid'>Call</span> <span class='hs-varid'>d2</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Call</span> <span class='hs-layout'>(</span><span class='hs-varid'>d1</span> <span class='hs-varop'>`lub`</span> <span class='hs-varid'>d2</span><span class='hs-layout'>)</span>
<a name="line-9"></a><span class='hs-definition'>lub</span> <span class='hs-varid'>d1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Call</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Box</span> <span class='hs-varid'>d2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d1</span> <span class='hs-varop'>`lub`</span> <span class='hs-varid'>d2</span>	<span class='hs-comment'>-- Just strip the box</span>
<a name="line-10"></a><span class='hs-definition'>lub</span>    <span class='hs-layout'>(</span><span class='hs-conid'>Call</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>d2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Eval</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d2</span>		<span class='hs-comment'>-- Presumably seq or vanilla eval</span>
<a name="line-11"></a><span class='hs-definition'>lub</span> <span class='hs-varid'>d1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Call</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>d2</span>	     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d2</span> <span class='hs-varop'>`lub`</span> <span class='hs-varid'>d1</span>	<span class='hs-comment'>-- Bot, Abs, Top</span>
<a name="line-12"></a>
<a name="line-13"></a><span class='hs-comment'>-- For the Eval case, we use these approximation rules</span>
<a name="line-14"></a><span class='hs-comment'>-- Box Bot	 &lt;= Eval (Box Bot ...)</span>
<a name="line-15"></a><span class='hs-comment'>-- Box Top	 &lt;= Defer (Box Bot ...)</span>
<a name="line-16"></a><span class='hs-comment'>-- Box (Eval ds) &lt;= Eval (map Box ds)</span>
<a name="line-17"></a><span class='hs-definition'>lub</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eval</span> <span class='hs-varid'>ds1</span><span class='hs-layout'>)</span>  <span class='hs-layout'>(</span><span class='hs-conid'>Eval</span> <span class='hs-varid'>ds2</span><span class='hs-layout'>)</span>  	  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Eval</span> <span class='hs-layout'>(</span><span class='hs-varid'>ds1</span> <span class='hs-varop'>`lubs`</span> <span class='hs-varid'>ds2</span><span class='hs-layout'>)</span>
<a name="line-18"></a><span class='hs-definition'>lub</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eval</span> <span class='hs-varid'>ds1</span><span class='hs-layout'>)</span>  <span class='hs-layout'>(</span><span class='hs-conid'>Box</span> <span class='hs-conid'>Bot</span><span class='hs-layout'>)</span>   	  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Eval</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapDmds</span> <span class='hs-layout'>(</span><span class='hs-varop'>`lub`</span> <span class='hs-conid'>Box</span> <span class='hs-conid'>Bot</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds1</span><span class='hs-layout'>)</span>
<a name="line-19"></a><span class='hs-definition'>lub</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eval</span> <span class='hs-varid'>ds1</span><span class='hs-layout'>)</span>  <span class='hs-layout'>(</span><span class='hs-conid'>Box</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eval</span> <span class='hs-varid'>ds2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Eval</span> <span class='hs-layout'>(</span><span class='hs-varid'>ds1</span> <span class='hs-varop'>`lubs`</span> <span class='hs-varid'>mapDmds</span> <span class='hs-varid'>box</span> <span class='hs-varid'>ds2</span><span class='hs-layout'>)</span>
<a name="line-20"></a><span class='hs-definition'>lub</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eval</span> <span class='hs-varid'>ds1</span><span class='hs-layout'>)</span>  <span class='hs-layout'>(</span><span class='hs-conid'>Box</span> <span class='hs-conid'>Abs</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deferEval</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapDmds</span> <span class='hs-layout'>(</span><span class='hs-varop'>`lub`</span> <span class='hs-conid'>Box</span> <span class='hs-conid'>Bot</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds1</span><span class='hs-layout'>)</span>
<a name="line-21"></a><span class='hs-definition'>lub</span> <span class='hs-varid'>d1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Eval</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>d2</span>	          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d2</span> <span class='hs-varop'>`lub`</span> <span class='hs-varid'>d1</span>	<span class='hs-comment'>-- Bot,Abs,Top,Call,Defer</span>
<a name="line-22"></a>
<a name="line-23"></a><span class='hs-definition'>lub</span> <span class='hs-layout'>(</span><span class='hs-conid'>Box</span> <span class='hs-varid'>d1</span><span class='hs-layout'>)</span>   <span class='hs-layout'>(</span><span class='hs-conid'>Box</span> <span class='hs-varid'>d2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>box</span> <span class='hs-layout'>(</span><span class='hs-varid'>d1</span> <span class='hs-varop'>`lub`</span> <span class='hs-varid'>d2</span><span class='hs-layout'>)</span>
<a name="line-24"></a><span class='hs-definition'>lub</span> <span class='hs-varid'>d1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Box</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-varid'>d2</span>	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>d2</span> <span class='hs-varop'>`lub`</span> <span class='hs-varid'>d1</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="lubs"></a><span class='hs-definition'>lubs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demands</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demands</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demands</span>
<a name="line-27"></a><span class='hs-definition'>lubs</span> <span class='hs-varid'>ds1</span> <span class='hs-varid'>ds2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWithDmds</span> <span class='hs-varid'>lub</span> <span class='hs-varid'>ds1</span> <span class='hs-varid'>ds2</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="box"></a><span class='hs-comment'>---------------------</span>
<a name="line-30"></a><span class='hs-definition'>box</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span>
<a name="line-31"></a><span class='hs-comment'>-- box is the smart constructor for Box</span>
<a name="line-32"></a><span class='hs-comment'>-- It computes &lt;B,bot&gt; &amp; d</span>
<a name="line-33"></a><span class='hs-comment'>-- INVARIANT: (Box d) =&gt; d = Bot, Abs, Eval</span>
<a name="line-34"></a><span class='hs-comment'>-- Seems to be no point in allowing (Box (Call d))</span>
<a name="line-35"></a><span class='hs-definition'>box</span> <span class='hs-layout'>(</span><span class='hs-conid'>Call</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Call</span> <span class='hs-varid'>d</span>	<span class='hs-comment'>-- The odd man out.  Why?</span>
<a name="line-36"></a><span class='hs-definition'>box</span> <span class='hs-layout'>(</span><span class='hs-conid'>Box</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Box</span> <span class='hs-varid'>d</span>
<a name="line-37"></a><span class='hs-definition'>box</span> <span class='hs-layout'>(</span><span class='hs-conid'>Defer</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lazyDmd</span>
<a name="line-38"></a><span class='hs-definition'>box</span> <span class='hs-conid'>Top</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lazyDmd</span>	<span class='hs-comment'>-- Box Abs and Box Top</span>
<a name="line-39"></a><span class='hs-definition'>box</span> <span class='hs-conid'>Abs</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lazyDmd</span>	<span class='hs-comment'>-- are the same &lt;B,L&gt;</span>
<a name="line-40"></a><span class='hs-definition'>box</span> <span class='hs-varid'>d</span> 	      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Box</span> <span class='hs-varid'>d</span>	<span class='hs-comment'>-- Bot, Eval</span>
<a name="line-41"></a>
<a name="line-42"></a><a name="defer"></a><span class='hs-comment'>---------------</span>
<a name="line-43"></a><span class='hs-definition'>defer</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span>
<a name="line-44"></a>
<a name="line-45"></a><span class='hs-comment'>-- defer is the smart constructor for Defer</span>
<a name="line-46"></a><span class='hs-comment'>-- The idea is that (Defer ds) = &lt;U(ds), L&gt;</span>
<a name="line-47"></a><span class='hs-comment'>--</span>
<a name="line-48"></a><span class='hs-comment'>-- It specifies what happens at a lazy function argument</span>
<a name="line-49"></a><span class='hs-comment'>-- or a lambda; the L* operator</span>
<a name="line-50"></a><span class='hs-comment'>-- Set the strictness part to L, but leave</span>
<a name="line-51"></a><span class='hs-comment'>-- the boxity side unaffected</span>
<a name="line-52"></a><span class='hs-comment'>-- It also ensures that Defer (Eval [LLLL]) = L</span>
<a name="line-53"></a>
<a name="line-54"></a><span class='hs-definition'>defer</span> <span class='hs-conid'>Bot</span>	 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Abs</span>
<a name="line-55"></a><span class='hs-definition'>defer</span> <span class='hs-conid'>Abs</span>	 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Abs</span>
<a name="line-56"></a><span class='hs-definition'>defer</span> <span class='hs-conid'>Top</span>	 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Top</span>
<a name="line-57"></a><span class='hs-definition'>defer</span> <span class='hs-layout'>(</span><span class='hs-conid'>Call</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>	 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lazyDmd</span>	<span class='hs-comment'>-- Approximation here?</span>
<a name="line-58"></a><span class='hs-definition'>defer</span> <span class='hs-layout'>(</span><span class='hs-conid'>Box</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>	 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lazyDmd</span>
<a name="line-59"></a><span class='hs-definition'>defer</span> <span class='hs-layout'>(</span><span class='hs-conid'>Defer</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Defer</span> <span class='hs-varid'>ds</span>
<a name="line-60"></a><span class='hs-definition'>defer</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eval</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deferEval</span> <span class='hs-varid'>ds</span>
<a name="line-61"></a>
<a name="line-62"></a><a name="deferEval"></a><span class='hs-definition'>deferEval</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demands</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span>
<a name="line-63"></a><span class='hs-comment'>-- deferEval ds = defer (Eval ds)</span>
<a name="line-64"></a><span class='hs-definition'>deferEval</span> <span class='hs-varid'>ds</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>allTop</span> <span class='hs-varid'>ds</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Top</span>
<a name="line-65"></a>	     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Defer</span> <span class='hs-varid'>ds</span>
<a name="line-66"></a>
<a name="line-67"></a><a name="absLub"></a><span class='hs-comment'>---------------------</span>
<a name="line-68"></a><span class='hs-definition'>absLub</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span>
<a name="line-69"></a><span class='hs-comment'>-- Computes (Abs `lub` d)</span>
<a name="line-70"></a><span class='hs-comment'>-- For the Bot case consider</span>
<a name="line-71"></a><span class='hs-comment'>--	f x y = if ... then x else error x</span>
<a name="line-72"></a><span class='hs-comment'>--   Then for y we get Abs `lub` Bot, and we really</span>
<a name="line-73"></a><span class='hs-comment'>--   want Abs overall</span>
<a name="line-74"></a><span class='hs-definition'>absLub</span> <span class='hs-conid'>Bot</span>  	  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Abs</span>
<a name="line-75"></a><span class='hs-definition'>absLub</span> <span class='hs-conid'>Abs</span>  	  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Abs</span>
<a name="line-76"></a><span class='hs-definition'>absLub</span> <span class='hs-conid'>Top</span> 	  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Top</span>
<a name="line-77"></a><span class='hs-definition'>absLub</span> <span class='hs-layout'>(</span><span class='hs-conid'>Call</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Top</span>
<a name="line-78"></a><span class='hs-definition'>absLub</span> <span class='hs-layout'>(</span><span class='hs-conid'>Box</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Top</span>
<a name="line-79"></a><span class='hs-definition'>absLub</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eval</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Defer</span> <span class='hs-layout'>(</span><span class='hs-varid'>absLubs</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>	<span class='hs-comment'>-- Or (Defer ds)?</span>
<a name="line-80"></a><span class='hs-definition'>absLub</span> <span class='hs-layout'>(</span><span class='hs-conid'>Defer</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Defer</span> <span class='hs-layout'>(</span><span class='hs-varid'>absLubs</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>	<span class='hs-comment'>-- Or (Defer ds)?</span>
<a name="line-81"></a>
<a name="line-82"></a><a name="absLubs"></a><span class='hs-definition'>absLubs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demands</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demands</span>
<a name="line-83"></a><span class='hs-definition'>absLubs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapDmds</span> <span class='hs-varid'>absLub</span>
<a name="line-84"></a>
<a name="line-85"></a><a name="both"></a><span class='hs-comment'>---------------</span>
<a name="line-86"></a><span class='hs-definition'>both</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demand</span>
<a name="line-87"></a>
<a name="line-88"></a><span class='hs-definition'>both</span> <span class='hs-conid'>Abs</span> <span class='hs-varid'>d2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d2</span>
<a name="line-89"></a>
<a name="line-90"></a><span class='hs-comment'>-- Note [Bottom demands]</span>
<a name="line-91"></a><span class='hs-definition'>both</span> <span class='hs-conid'>Bot</span> <span class='hs-conid'>Bot</span> 	    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Bot</span>
<a name="line-92"></a><span class='hs-definition'>both</span> <span class='hs-conid'>Bot</span> <span class='hs-conid'>Abs</span> 	    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Bot</span> 
<a name="line-93"></a><span class='hs-definition'>both</span> <span class='hs-conid'>Bot</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eval</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Eval</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapDmds</span> <span class='hs-layout'>(</span><span class='hs-varop'>`both`</span> <span class='hs-conid'>Bot</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>
<a name="line-94"></a><span class='hs-definition'>both</span> <span class='hs-conid'>Bot</span> <span class='hs-layout'>(</span><span class='hs-conid'>Defer</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Eval</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapDmds</span> <span class='hs-layout'>(</span><span class='hs-varop'>`both`</span> <span class='hs-conid'>Bot</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>
<a name="line-95"></a><span class='hs-definition'>both</span> <span class='hs-conid'>Bot</span> <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>errDmd</span>
<a name="line-96"></a>
<a name="line-97"></a><span class='hs-definition'>both</span> <span class='hs-conid'>Top</span> <span class='hs-conid'>Bot</span> 	    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>errDmd</span>
<a name="line-98"></a><span class='hs-definition'>both</span> <span class='hs-conid'>Top</span> <span class='hs-conid'>Abs</span> 	    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Top</span>
<a name="line-99"></a><span class='hs-definition'>both</span> <span class='hs-conid'>Top</span> <span class='hs-conid'>Top</span> 	    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Top</span>
<a name="line-100"></a><span class='hs-definition'>both</span> <span class='hs-conid'>Top</span> <span class='hs-layout'>(</span><span class='hs-conid'>Box</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Box</span> <span class='hs-varid'>d</span>
<a name="line-101"></a><span class='hs-definition'>both</span> <span class='hs-conid'>Top</span> <span class='hs-layout'>(</span><span class='hs-conid'>Call</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Call</span> <span class='hs-varid'>d</span>
<a name="line-102"></a><span class='hs-definition'>both</span> <span class='hs-conid'>Top</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eval</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Eval</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapDmds</span> <span class='hs-layout'>(</span><span class='hs-varop'>`both`</span> <span class='hs-conid'>Top</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>
<a name="line-103"></a><span class='hs-definition'>both</span> <span class='hs-conid'>Top</span> <span class='hs-layout'>(</span><span class='hs-conid'>Defer</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span> 	<span class='hs-comment'>-- = defer (Top `both` Eval ds)</span>
<a name="line-104"></a>			<span class='hs-comment'>-- = defer (Eval (mapDmds (`both` Top) ds))</span>
<a name="line-105"></a>		     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deferEval</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapDmds</span> <span class='hs-layout'>(</span><span class='hs-varop'>`both`</span> <span class='hs-conid'>Top</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>
<a name="line-106"></a>
<a name="line-107"></a>
<a name="line-108"></a><span class='hs-definition'>both</span> <span class='hs-layout'>(</span><span class='hs-conid'>Box</span> <span class='hs-varid'>d1</span><span class='hs-layout'>)</span> 	<span class='hs-layout'>(</span><span class='hs-conid'>Box</span> <span class='hs-varid'>d2</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>box</span> <span class='hs-layout'>(</span><span class='hs-varid'>d1</span> <span class='hs-varop'>`both`</span> <span class='hs-varid'>d2</span><span class='hs-layout'>)</span>
<a name="line-109"></a><span class='hs-definition'>both</span> <span class='hs-layout'>(</span><span class='hs-conid'>Box</span> <span class='hs-varid'>d1</span><span class='hs-layout'>)</span> 	<span class='hs-varid'>d2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Call</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>box</span> <span class='hs-layout'>(</span><span class='hs-varid'>d1</span> <span class='hs-varop'>`both`</span> <span class='hs-varid'>d2</span><span class='hs-layout'>)</span>
<a name="line-110"></a><span class='hs-definition'>both</span> <span class='hs-layout'>(</span><span class='hs-conid'>Box</span> <span class='hs-varid'>d1</span><span class='hs-layout'>)</span> 	<span class='hs-varid'>d2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Eval</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>box</span> <span class='hs-layout'>(</span><span class='hs-varid'>d1</span> <span class='hs-varop'>`both`</span> <span class='hs-varid'>d2</span><span class='hs-layout'>)</span>
<a name="line-111"></a><span class='hs-definition'>both</span> <span class='hs-layout'>(</span><span class='hs-conid'>Box</span> <span class='hs-varid'>d1</span><span class='hs-layout'>)</span> 	<span class='hs-layout'>(</span><span class='hs-conid'>Defer</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Box</span> <span class='hs-varid'>d1</span>
<a name="line-112"></a><span class='hs-definition'>both</span> <span class='hs-varid'>d1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Box</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>d2</span>	    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d2</span> <span class='hs-varop'>`both`</span> <span class='hs-varid'>d1</span>
<a name="line-113"></a>
<a name="line-114"></a><span class='hs-definition'>both</span> <span class='hs-layout'>(</span><span class='hs-conid'>Call</span> <span class='hs-varid'>d1</span><span class='hs-layout'>)</span> 	 <span class='hs-layout'>(</span><span class='hs-conid'>Call</span> <span class='hs-varid'>d2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Call</span> <span class='hs-layout'>(</span><span class='hs-varid'>d1</span> <span class='hs-varop'>`both`</span> <span class='hs-varid'>d2</span><span class='hs-layout'>)</span>
<a name="line-115"></a><span class='hs-definition'>both</span> <span class='hs-layout'>(</span><span class='hs-conid'>Call</span> <span class='hs-varid'>d1</span><span class='hs-layout'>)</span> 	 <span class='hs-layout'>(</span><span class='hs-conid'>Eval</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Call</span> <span class='hs-varid'>d1</span>	<span class='hs-comment'>-- Could do better for (Poly Bot)?</span>
<a name="line-116"></a><span class='hs-definition'>both</span> <span class='hs-layout'>(</span><span class='hs-conid'>Call</span> <span class='hs-varid'>d1</span><span class='hs-layout'>)</span> 	 <span class='hs-layout'>(</span><span class='hs-conid'>Defer</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Call</span> <span class='hs-varid'>d1</span>	<span class='hs-comment'>-- Ditto</span>
<a name="line-117"></a><span class='hs-definition'>both</span> <span class='hs-varid'>d1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Call</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>d2</span>	     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d2</span> <span class='hs-varop'>`both`</span> <span class='hs-varid'>d1</span>
<a name="line-118"></a>
<a name="line-119"></a><span class='hs-definition'>both</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eval</span> <span class='hs-varid'>ds1</span><span class='hs-layout'>)</span>  <span class='hs-layout'>(</span><span class='hs-conid'>Eval</span>  <span class='hs-varid'>ds2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Eval</span> <span class='hs-layout'>(</span><span class='hs-varid'>ds1</span> <span class='hs-varop'>`boths`</span> <span class='hs-varid'>ds2</span><span class='hs-layout'>)</span>
<a name="line-120"></a><span class='hs-definition'>both</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eval</span> <span class='hs-varid'>ds1</span><span class='hs-layout'>)</span>  <span class='hs-layout'>(</span><span class='hs-conid'>Defer</span> <span class='hs-varid'>ds2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Eval</span> <span class='hs-layout'>(</span><span class='hs-varid'>ds1</span> <span class='hs-varop'>`boths`</span> <span class='hs-varid'>mapDmds</span> <span class='hs-varid'>defer</span> <span class='hs-varid'>ds2</span><span class='hs-layout'>)</span>
<a name="line-121"></a><span class='hs-definition'>both</span> <span class='hs-varid'>d1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Eval</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>d2</span>	     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d2</span> <span class='hs-varop'>`both`</span> <span class='hs-varid'>d1</span>
<a name="line-122"></a>
<a name="line-123"></a><span class='hs-definition'>both</span> <span class='hs-layout'>(</span><span class='hs-conid'>Defer</span> <span class='hs-varid'>ds1</span><span class='hs-layout'>)</span>  <span class='hs-layout'>(</span><span class='hs-conid'>Defer</span> <span class='hs-varid'>ds2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deferEval</span> <span class='hs-layout'>(</span><span class='hs-varid'>ds1</span> <span class='hs-varop'>`boths`</span> <span class='hs-varid'>ds2</span><span class='hs-layout'>)</span>
<a name="line-124"></a><span class='hs-definition'>both</span> <span class='hs-varid'>d1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Defer</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>d2</span>	      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d2</span> <span class='hs-varop'>`both`</span> <span class='hs-varid'>d1</span>
<a name="line-125"></a> 
<a name="line-126"></a><a name="boths"></a><span class='hs-definition'>boths</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Demands</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demands</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Demands</span>
<a name="line-127"></a><span class='hs-definition'>boths</span> <span class='hs-varid'>ds1</span> <span class='hs-varid'>ds2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWithDmds</span> <span class='hs-varid'>both</span> <span class='hs-varid'>ds1</span> <span class='hs-varid'>ds2</span>
</pre>\end{code}

Note [Bottom demands]
~~~~~~~~~~~~~~~~~~~~~
Consider
	f x = error x
From 'error' itself we get demand Bot on x
From the arg demand on x we get 
	x :-> evalDmd = Box (Eval (Poly Abs))
So we get  Bot `both` Box (Eval (Poly Abs))
	    = Seq Keep (Poly Bot)

Consider also
	f x = if ... then error (fst x) else fst x
Then we get (Eval (Box Bot, Bot) `lub` Eval (SA))
	= Eval (SA)
which is what we want.

Consider also
  f x = error [fst x]
Then we get 
     x :-> Bot `both` Defer [SA]
and we want the Bot demand to cancel out the Defer
so that we get Eval [SA].  Otherwise we'd have the odd
situation that
  f x = error (fst x)      -- Strictness U(SA)b
  g x = error ('y':fst x)  -- Strictness Tb

</body>
</html>
