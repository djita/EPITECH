<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>typecheck/TcTyClsDecls.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The AQUA Project, Glasgow University, 1996-1998
%

TcTyClsDecls: Typecheck type and class declarations

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcTyClsDecls</span> <span class='hs-layout'>(</span>
<a name="line-9"></a>	<span class='hs-varid'>tcTyAndClassDecls</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcAddImplicits</span><span class='hs-layout'>,</span>
<a name="line-10"></a>
<a name="line-11"></a>	<span class='hs-comment'>-- Functions used by TcInstDcls to check </span>
<a name="line-12"></a>	<span class='hs-comment'>-- data/type family instance declarations</span>
<a name="line-13"></a>        <span class='hs-varid'>kcDataDecl</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcConDecls</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataDeclChecks</span><span class='hs-layout'>,</span> <span class='hs-varid'>checkValidTyCon</span><span class='hs-layout'>,</span>
<a name="line-14"></a>        <span class='hs-varid'>tcSynFamInstDecl</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcFamTyPats</span><span class='hs-layout'>,</span> 
<a name="line-15"></a>        <span class='hs-varid'>wrongKindOfFamily</span><span class='hs-layout'>,</span> <span class='hs-varid'>badATErr</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrongATArgErr</span>
<a name="line-16"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-19"></a>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HscTypes</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BuildTyCl</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcUnify</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEnv</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcBinds</span><span class='hs-layout'>(</span> <span class='hs-varid'>tcRecSelBinds</span> <span class='hs-layout'>)</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcTyDecls</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcClassDcl</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcHsType</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcMType</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysWiredIn</span><span class='hs-layout'>(</span> <span class='hs-varid'>unitTy</span> <span class='hs-layout'>)</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Kind</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MkCore</span>		<span class='hs-layout'>(</span> <span class='hs-varid'>rEC_SEL_ERROR_ID</span> <span class='hs-layout'>)</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>IdInfo</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameSet</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameEnv</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unify</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ListSetOps</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Digraph</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unique</span>		<span class='hs-layout'>(</span> <span class='hs-varid'>mkBuiltinUnique</span> <span class='hs-layout'>)</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-57"></a>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>
</pre>\end{code}


%************************************************************************
%*									*
\subsection{Type checking for type and class declarations}
%*									*
%************************************************************************

Note [Grouping of type and class declarations]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

tcTyAndClassDecls is called on a list of `TyClGroup`s. Each group is a strongly
connected component of mutually dependent types and classes. We kind check and
type check each group separately to enhance kind polymorphism. Take the
following example:

  type Id a = a
  data X = X (Id Int)

If we were to kind check the two declarations together, we would give Id the
kind * -> *, since we apply it to an Int in the definition of X. But we can do
better than that, since Id really is kind polymorphic, and should get kind
forall (k::BOX). k -> k. Since it does not depend on anything else, it can be
kind-checked by itself, hence getting the most general kind. We then kind check
X, which works fine because we then know the polymorphic kind of Id, and simply
instantiate k to *.

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><a name="tcTyAndClassDecls"></a><span class='hs-definition'>tcTyAndClassDecls</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModDetails</span>
<a name="line-3"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyClGroup</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>   <span class='hs-comment'>-- Mutually-recursive groups in dependency order</span>
<a name="line-4"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcGblEnv</span>       <span class='hs-comment'>-- Input env extended by types and classes</span>
<a name="line-5"></a>                                        <span class='hs-comment'>-- and their implicit Ids,DataCons</span>
<a name="line-6"></a><span class='hs-comment'>-- Fails if there are any errors</span>
<a name="line-7"></a><span class='hs-definition'>tcTyAndClassDecls</span> <span class='hs-varid'>boot_details</span> <span class='hs-varid'>decls_s</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkNoErrs</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>    <span class='hs-comment'>-- The code recovers internally, but if anything gave rise to</span>
<a name="line-9"></a>                        <span class='hs-comment'>-- an error we'd better stop now, to avoid a cascade</span>
<a name="line-10"></a>  <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tyclds_s</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>filterOut</span> <span class='hs-layout'>(</span><span class='hs-varid'>isFamInstDecl</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>decls_s</span>
<a name="line-11"></a>                   <span class='hs-comment'>-- Remove family instance decls altogether</span>
<a name="line-12"></a>                   <span class='hs-comment'>-- They are dealt with by TcInstDcls</span>
<a name="line-13"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>fold_env</span> <span class='hs-varid'>tyclds_s</span> <span class='hs-layout'>}</span>  <span class='hs-comment'>-- type check each group in dependency order folding the global env</span>
<a name="line-14"></a>  <span class='hs-keyword'>where</span>
<a name="line-15"></a>    <span class='hs-varid'>fold_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyClGroup</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcGblEnv</span>
<a name="line-16"></a>    <span class='hs-varid'>fold_env</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-17"></a>    <span class='hs-varid'>fold_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyclds</span><span class='hs-conop'>:</span><span class='hs-varid'>tyclds_s</span><span class='hs-layout'>)</span>
<a name="line-18"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcg_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTyClGroup</span> <span class='hs-varid'>boot_details</span> <span class='hs-varid'>tyclds</span>
<a name="line-19"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>setGblEnv</span> <span class='hs-varid'>tcg_env</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fold_env</span> <span class='hs-varid'>tyclds_s</span> <span class='hs-layout'>}</span>
<a name="line-20"></a>             <span class='hs-comment'>-- remaining groups are typecheck in the extended global env</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="tcTyClGroup"></a><span class='hs-definition'>tcTyClGroup</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModDetails</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyClGroup</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcGblEnv</span>
<a name="line-23"></a><span class='hs-comment'>-- Typecheck one strongly-connected component of type and class decls</span>
<a name="line-24"></a><span class='hs-definition'>tcTyClGroup</span> <span class='hs-varid'>boot_details</span> <span class='hs-varid'>tyclds</span>
<a name="line-25"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>    <span class='hs-comment'>-- Step 1: kind-check this group and returns the final</span>
<a name="line-26"></a>            <span class='hs-comment'>-- (possibly-polymorphic) kind of each TyCon and Class</span>
<a name="line-27"></a>            <span class='hs-comment'>-- See Note [Kind checking for type and class decls]</span>
<a name="line-28"></a>         <span class='hs-varid'>names_w_poly_kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kcTyClGroup</span> <span class='hs-varid'>tyclds</span>
<a name="line-29"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcTyAndCl generalized kinds"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>names_w_poly_kinds</span><span class='hs-layout'>)</span>
<a name="line-30"></a>
<a name="line-31"></a>	    <span class='hs-comment'>-- Step 2: type-check all groups together, returning </span>
<a name="line-32"></a>	    <span class='hs-comment'>-- the final TyCons and Classes</span>
<a name="line-33"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tyclss</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fixM</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>rec_tyclss</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-34"></a>           <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>rec_flags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>calcRecFlags</span> <span class='hs-varid'>boot_details</span> <span class='hs-varid'>rec_tyclss</span>
<a name="line-35"></a>
<a name="line-36"></a>                 <span class='hs-comment'>-- Populate environment with knot-tied ATyCon for TyCons</span>
<a name="line-37"></a>                 <span class='hs-comment'>-- NB: if the decls mention any ill-staged data cons</span>
<a name="line-38"></a>                 <span class='hs-comment'>-- (see Note [ANothing] in typecheck/TcRnTypes.lhs) we</span>
<a name="line-39"></a>                 <span class='hs-comment'>-- will have failed already in kcTyClGroup, so no worries here</span>
<a name="line-40"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>tcExtendRecEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipRecTyClss</span> <span class='hs-varid'>tyclds</span> <span class='hs-varid'>rec_tyclss</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-41"></a>
<a name="line-42"></a>                 <span class='hs-comment'>-- Also extend the local type envt with bindings giving</span>
<a name="line-43"></a>                 <span class='hs-comment'>-- the (polymorphic) kind of each knot-tied TyCon or Class</span>
<a name="line-44"></a>		 <span class='hs-comment'>-- See Note [Type checking recursive type and class declarations]</span>
<a name="line-45"></a>	     <span class='hs-varid'>tcExtendKindEnv</span> <span class='hs-varid'>names_w_poly_kinds</span>              <span class='hs-varop'>$</span>
<a name="line-46"></a>
<a name="line-47"></a>                 <span class='hs-comment'>-- Kind and type check declarations for this group</span>
<a name="line-48"></a>             <span class='hs-varid'>concatMapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcTyClDecl</span> <span class='hs-varid'>rec_flags</span><span class='hs-layout'>)</span> <span class='hs-varid'>tyclds</span> <span class='hs-layout'>}</span>
<a name="line-49"></a>
<a name="line-50"></a>           <span class='hs-comment'>-- Step 3: Perform the validity chebck</span>
<a name="line-51"></a>           <span class='hs-comment'>-- We can do this now because we are done with the recursive knot</span>
<a name="line-52"></a>           <span class='hs-comment'>-- Do it before Step 4 (adding implicit things) because the latter</span>
<a name="line-53"></a>           <span class='hs-comment'>-- expects well-formed TyCons</span>
<a name="line-54"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcExtendGlobalEnv</span> <span class='hs-varid'>tyclss</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-55"></a>       <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Starting validity check"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tyclss</span><span class='hs-layout'>)</span>
<a name="line-56"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>addLocM</span> <span class='hs-varid'>checkValidTyCl</span><span class='hs-layout'>)</span> <span class='hs-varid'>tyclds</span>
<a name="line-57"></a>
<a name="line-58"></a>           <span class='hs-comment'>-- Step 4: Add the implicit things;</span>
<a name="line-59"></a>           <span class='hs-comment'>-- we want them in the environment because</span>
<a name="line-60"></a>           <span class='hs-comment'>-- they may be mentioned in interface files</span>
<a name="line-61"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcExtendGlobalValEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkDefaultMethodIds</span> <span class='hs-varid'>tyclss</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-62"></a>         <span class='hs-varid'>tcAddImplicits</span> <span class='hs-varid'>tyclss</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-63"></a>
<a name="line-64"></a><a name="tcAddImplicits"></a><span class='hs-definition'>tcAddImplicits</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyThing</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcGblEnv</span>
<a name="line-65"></a><span class='hs-definition'>tcAddImplicits</span> <span class='hs-varid'>tyclss</span>
<a name="line-66"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcExtendGlobalEnvImplicit</span> <span class='hs-varid'>implicit_things</span> <span class='hs-varop'>$</span> 
<a name="line-67"></a>   <span class='hs-varid'>tcRecSelBinds</span> <span class='hs-varid'>rec_sel_binds</span>
<a name="line-68"></a> <span class='hs-keyword'>where</span>
<a name="line-69"></a>   <span class='hs-varid'>implicit_things</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>implicitTyThings</span> <span class='hs-varid'>tyclss</span>
<a name="line-70"></a>   <span class='hs-varid'>rec_sel_binds</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRecSelBinds</span> <span class='hs-varid'>tyclss</span>
<a name="line-71"></a>
<a name="line-72"></a><a name="zipRecTyClss"></a><span class='hs-definition'>zipRecTyClss</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyClGroup</span> <span class='hs-conid'>Name</span>
<a name="line-73"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyThing</span><span class='hs-keyglyph'>]</span>           <span class='hs-comment'>-- Knot-tied</span>
<a name="line-74"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span><span class='hs-conid'>TyThing</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-75"></a><span class='hs-comment'>-- Build a name-TyThing mapping for the things bound by decls</span>
<a name="line-76"></a><span class='hs-comment'>-- being careful not to look at the [TyThing]</span>
<a name="line-77"></a><span class='hs-comment'>-- The TyThings in the result list must have a visible ATyCon,</span>
<a name="line-78"></a><span class='hs-comment'>-- because typechecking types (in, say, tcTyClDecl) looks at this outer constructor</span>
<a name="line-79"></a><span class='hs-definition'>zipRecTyClss</span> <span class='hs-varid'>decls</span> <span class='hs-varid'>rec_things</span>
<a name="line-80"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-conid'>ATyCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>get</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-81"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyClsBinders</span> <span class='hs-varid'>decls</span> <span class='hs-keyglyph'>]</span>
<a name="line-82"></a>  <span class='hs-keyword'>where</span>
<a name="line-83"></a>    <span class='hs-varid'>rec_type_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TypeEnv</span>
<a name="line-84"></a>    <span class='hs-varid'>rec_type_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTypeEnv</span> <span class='hs-varid'>rec_things</span>
<a name="line-85"></a>
<a name="line-86"></a>    <span class='hs-varid'>get</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupTypeEnv</span> <span class='hs-varid'>rec_type_env</span> <span class='hs-varid'>name</span> <span class='hs-keyword'>of</span>
<a name="line-87"></a>                 <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tc</span>
<a name="line-88"></a>                 <span class='hs-varid'>other</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"zipRecTyClss"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>other</span><span class='hs-layout'>)</span>
<a name="line-89"></a>
<a name="line-90"></a><a name="tyClsBinders"></a><span class='hs-definition'>tyClsBinders</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyClGroup</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-91"></a><span class='hs-comment'>-- Just the tycon and class binders of a group (not the data constructors)</span>
<a name="line-92"></a><span class='hs-definition'>tyClsBinders</span> <span class='hs-varid'>decls</span>
<a name="line-93"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>get</span> <span class='hs-varid'>decls</span>
<a name="line-94"></a>  <span class='hs-keyword'>where</span>
<a name="line-95"></a>    <span class='hs-varid'>get</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClassDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcdLName</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdATs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ats</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span> <span class='hs-conop'>:</span> <span class='hs-varid'>tyClsBinders</span> <span class='hs-varid'>ats</span>
<a name="line-96"></a>    <span class='hs-varid'>get</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span>                                              <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tcdName</span> <span class='hs-varid'>d</span><span class='hs-keyglyph'>]</span>
</pre>\end{code}


%************************************************************************
%*									*
		Kind checking
%*									*
%************************************************************************

Note [Kind checking for type and class decls]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Kind checking is done thus:

   1. Make up a kind variable for each parameter of the *data* type, 
      and class, decls, and extend the kind environment (which is in
      the TcLclEnv)

   2. Dependency-analyse the type *synonyms* (which must be non-recursive),
      and kind-check them in dependency order.  Extend the kind envt.

   3. Kind check the data type and class decls

Synonyms are treated differently to data type and classes,
because a type synonym can be an unboxed type
	type Foo = Int#
and a kind variable can't unify with UnboxedTypeKind
So we infer their kinds in dependency order

We need to kind check all types in the mutually recursive group
before we know the kind of the type variables.  For example:

class C a where
   op :: D b => a -> b -> b

class D c where
   bop :: (Monad c) => ...

Here, the kind of the locally-polymorphic type variable "b"
depends on *all the uses of class D*.  For example, the use of
Monad c in bop's type signature means that D must have kind Type->Type.

However type synonyms work differently.  They can have kinds which don't
just involve (->) and *:
	type R = Int#		-- Kind #
	type S a = Array# a	-- Kind * -> #
	type T a b = (# a,b #)	-- Kind * -> * -> (# a,b #)
So we must infer their kinds from their right-hand sides *first* and then
use them, whereas for the mutually recursive data types D we bring into
scope kind bindings D -> k, where k is a kind variable, and do inference.

Type families
~~~~~~~~~~~~~
This treatment of type synonyms only applies to Haskell 98-style synonyms.
General type functions can be recursive, and hence, appear in `alg_decls'.

The kind of a type family is solely determinded by its kind signature;
hence, only kind signatures participate in the construction of the initial
kind environment (as constructed by `getInitialKind').  In fact, we ignore
instances of families altogether in the following.  However, we need to
include the kinds of *associated* families into the construction of the
initial kind environment.  (This is handled by `allDecls').


\begin{code}
<pre><a name="line-1"></a><a name="kcTyClGroup"></a><span class='hs-definition'>kcTyClGroup</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyClGroup</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span><span class='hs-conid'>Kind</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-comment'>-- Kind check this group, kind generalize, and return the resulting local env</span>
<a name="line-3"></a><span class='hs-comment'>-- See Note [Kind checking for type and class decls]</span>
<a name="line-4"></a><span class='hs-definition'>kcTyClGroup</span> <span class='hs-varid'>decls</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModule</span>
<a name="line-6"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"kcTyClGroup"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"module"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>mod</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>decls</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-7"></a>
<a name="line-8"></a>          <span class='hs-comment'>-- Kind checking; </span>
<a name="line-9"></a>	  <span class='hs-comment'>--    1. Bind kind variables for non-synonyms</span>
<a name="line-10"></a>          <span class='hs-comment'>--    2. Kind-check synonyms, and bind kinds of those synonyms</span>
<a name="line-11"></a>          <span class='hs-comment'>--    3. Kind-check non-synonyms</span>
<a name="line-12"></a>	  <span class='hs-comment'>--    4. Generalise the inferred kinds</span>
<a name="line-13"></a>          <span class='hs-comment'>-- See Note [Kind checking for type and class decls]</span>
<a name="line-14"></a>
<a name="line-15"></a>	  <span class='hs-comment'>-- Step 1: Bind kind variables for non-synonyms</span>
<a name="line-16"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>syn_decls</span><span class='hs-layout'>,</span> <span class='hs-varid'>non_syn_decls</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-layout'>(</span><span class='hs-varid'>isSynDecl</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>decls</span>
<a name="line-17"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>initial_kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>concatMapM</span> <span class='hs-varid'>getInitialKinds</span> <span class='hs-varid'>non_syn_decls</span>
<a name="line-18"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>tcExtendTcTyThingEnv</span> <span class='hs-varid'>initial_kinds</span> <span class='hs-varop'>$</span>  <span class='hs-keyword'>do</span>
<a name="line-19"></a>
<a name="line-20"></a>	   <span class='hs-comment'>-- Step 2: kind-check the synonyms, and extend envt</span>
<a name="line-21"></a>        <span class='hs-layout'>{</span> <span class='hs-varid'>tcl_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kcSynDecls</span> <span class='hs-layout'>(</span><span class='hs-varid'>calcSynCycles</span> <span class='hs-varid'>syn_decls</span><span class='hs-layout'>)</span>
<a name="line-22"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>setLclEnv</span> <span class='hs-varid'>tcl_env</span> <span class='hs-varop'>$</span>  <span class='hs-keyword'>do</span>
<a name="line-23"></a>
<a name="line-24"></a>	   <span class='hs-comment'>-- Step 3: kind-check the synonyms</span>
<a name="line-25"></a>        <span class='hs-layout'>{</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapLocM</span> <span class='hs-varid'>kcTyClDecl</span><span class='hs-layout'>)</span> <span class='hs-varid'>non_syn_decls</span>
<a name="line-26"></a>
<a name="line-27"></a>	     <span class='hs-comment'>-- Step 4: generalisation</span>
<a name="line-28"></a>	     <span class='hs-comment'>-- Kind checking done for this group</span>
<a name="line-29"></a>             <span class='hs-comment'>-- Now we have to kind generalize the flexis</span>
<a name="line-30"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>generalise</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyClsBinders</span> <span class='hs-varid'>decls</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-31"></a>
<a name="line-32"></a>  <span class='hs-keyword'>where</span>
<a name="line-33"></a>    <span class='hs-varid'>generalise</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>Kind</span><span class='hs-layout'>)</span>
<a name="line-34"></a>    <span class='hs-varid'>generalise</span> <span class='hs-varid'>name</span>
<a name="line-35"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Generalise type of"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-36"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookup</span> <span class='hs-varid'>name</span>
<a name="line-37"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>kc_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>thing</span> <span class='hs-keyword'>of</span>
<a name="line-38"></a>                               <span class='hs-conid'>AThing</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>k</span>
<a name="line-39"></a>                               <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"kcTyClGroup"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-40"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>kc_kind'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kindGeneralizeKind</span> <span class='hs-varid'>kc_kind</span>
<a name="line-41"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkForAllTys</span> <span class='hs-varid'>kvs</span> <span class='hs-varid'>kc_kind'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-42"></a>
<a name="line-43"></a><a name="getInitialKinds"></a><span class='hs-definition'>getInitialKinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LTyClDecl</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyThing</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-44"></a><span class='hs-comment'>-- Allocate a fresh kind variable for each TyCon and Class</span>
<a name="line-45"></a><span class='hs-comment'>-- For each tycon, return   (tc, AThing k)</span>
<a name="line-46"></a><span class='hs-comment'>--                 where k is the kind of tc, derived from the LHS</span>
<a name="line-47"></a><span class='hs-comment'>--                       of the definition (and probably including</span>
<a name="line-48"></a><span class='hs-comment'>--                       kind unification variables)</span>
<a name="line-49"></a><span class='hs-comment'>--      Example: data T a b = ...</span>
<a name="line-50"></a><span class='hs-comment'>--      return (T, kv1 -&gt; kv2 -&gt; *)</span>
<a name="line-51"></a><span class='hs-comment'>--</span>
<a name="line-52"></a><span class='hs-comment'>-- ALSO for each datacon, return (dc, ANothing)</span>
<a name="line-53"></a><span class='hs-comment'>--      See Note [ANothing] in TcRnTypes</span>
<a name="line-54"></a>
<a name="line-55"></a><span class='hs-definition'>getInitialKinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span>
<a name="line-56"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 	<span class='hs-layout'>{</span> <span class='hs-varid'>arg_kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_arg_kind</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyClDeclTyVars</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span>
<a name="line-57"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>res_kind</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mk_res_kind</span> <span class='hs-varid'>decl</span>
<a name="line-58"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>main_pair</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcdName</span> <span class='hs-varid'>decl</span><span class='hs-layout'>,</span> <span class='hs-conid'>AThing</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkArrowKinds</span> <span class='hs-varid'>arg_kinds</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-59"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>inner_pairs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get_inner_kinds</span> <span class='hs-varid'>decl</span>
<a name="line-60"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>main_pair</span> <span class='hs-conop'>:</span> <span class='hs-varid'>inner_pairs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-61"></a>  <span class='hs-keyword'>where</span>
<a name="line-62"></a>    <span class='hs-varid'>mk_arg_kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>UserTyVar</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-63"></a>    <span class='hs-varid'>mk_arg_kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindedTyVar</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>kind</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>scDsLHsKind</span> <span class='hs-varid'>kind</span>
<a name="line-64"></a>
<a name="line-65"></a>    <span class='hs-varid'>mk_res_kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyFamily</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcdKind</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>scDsLHsKind</span> <span class='hs-varid'>kind</span>
<a name="line-66"></a>    <span class='hs-varid'>mk_res_kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyData</span>   <span class='hs-layout'>{</span> <span class='hs-varid'>tcdKindSig</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>scDsLHsKind</span> <span class='hs-varid'>kind</span>
<a name="line-67"></a>	<span class='hs-comment'>-- On GADT-style declarations we allow a kind signature</span>
<a name="line-68"></a>	<span class='hs-comment'>--	data T :: *-&gt;* where { ... }</span>
<a name="line-69"></a>    <span class='hs-varid'>mk_res_kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClassDecl</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>constraintKind</span>
<a name="line-70"></a>    <span class='hs-varid'>mk_res_kind</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-71"></a>
<a name="line-72"></a>    <span class='hs-varid'>get_inner_kinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyClDecl</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span><span class='hs-conid'>TcTyThing</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-73"></a>    <span class='hs-varid'>get_inner_kinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyData</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcdCons</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cons</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-74"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>con_name</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>ANothing</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cons</span> <span class='hs-keyglyph'>]</span>
<a name="line-75"></a>    <span class='hs-varid'>get_inner_kinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClassDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcdATs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ats</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-76"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMapM</span> <span class='hs-varid'>getInitialKinds</span> <span class='hs-varid'>ats</span>
<a name="line-77"></a>    <span class='hs-varid'>get_inner_kinds</span> <span class='hs-keyword'>_</span>
<a name="line-78"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>
<a name="line-79"></a>
<a name="line-80"></a><a name="kcLookupKind"></a><span class='hs-definition'>kcLookupKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Located</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Kind</span>
<a name="line-81"></a><span class='hs-definition'>kcLookupKind</span> <span class='hs-varid'>nm</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-82"></a>    <span class='hs-varid'>tc_ty_thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupLocated</span> <span class='hs-varid'>nm</span>
<a name="line-83"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>tc_ty_thing</span> <span class='hs-keyword'>of</span>
<a name="line-84"></a>        <span class='hs-conid'>AThing</span> <span class='hs-varid'>k</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>k</span>
<a name="line-85"></a>        <span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-86"></a>        <span class='hs-keyword'>_</span>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"kcLookupKind"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc_ty_thing</span><span class='hs-layout'>)</span>
<a name="line-87"></a>
<a name="line-88"></a>
<a name="line-89"></a><a name="kcSynDecls"></a><span class='hs-comment'>----------------</span>
<a name="line-90"></a><span class='hs-definition'>kcSynDecls</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SCC</span> <span class='hs-layout'>(</span><span class='hs-conid'>LTyClDecl</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcLclEnv</span><span class='hs-layout'>)</span>	<span class='hs-comment'>-- Kind bindings</span>
<a name="line-91"></a><span class='hs-definition'>kcSynDecls</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getLclEnv</span>
<a name="line-92"></a><span class='hs-definition'>kcSynDecls</span> <span class='hs-layout'>(</span><span class='hs-varid'>group</span> <span class='hs-conop'>:</span> <span class='hs-varid'>groups</span><span class='hs-layout'>)</span>
<a name="line-93"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>nk</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kcSynDecl1</span> <span class='hs-varid'>group</span>
<a name="line-94"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>tcExtendKindEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>nk</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>(</span><span class='hs-varid'>kcSynDecls</span> <span class='hs-varid'>groups</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-95"></a>
<a name="line-96"></a><a name="kcSynDecl1"></a><span class='hs-comment'>----------------</span>
<a name="line-97"></a><span class='hs-definition'>kcSynDecl1</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SCC</span> <span class='hs-layout'>(</span><span class='hs-conid'>LTyClDecl</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-98"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span><span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Kind bindings</span>
<a name="line-99"></a><span class='hs-definition'>kcSynDecl1</span> <span class='hs-layout'>(</span><span class='hs-conid'>AcyclicSCC</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kcSynDecl</span> <span class='hs-varid'>decl</span>
<a name="line-100"></a><span class='hs-definition'>kcSynDecl1</span> <span class='hs-layout'>(</span><span class='hs-conid'>CyclicSCC</span> <span class='hs-varid'>decls</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>recSynErr</span> <span class='hs-varid'>decls</span><span class='hs-layout'>;</span> <span class='hs-varid'>failM</span> <span class='hs-layout'>}</span>
<a name="line-101"></a>	   	      		     <span class='hs-comment'>-- Fail here to avoid error cascade</span>
<a name="line-102"></a>				     <span class='hs-comment'>-- of out-of-scope tycons</span>
<a name="line-103"></a>
<a name="line-104"></a><a name="kcSynDecl"></a><span class='hs-definition'>kcSynDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyClDecl</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-105"></a><span class='hs-definition'>kcSynDecl</span> <span class='hs-varid'>decl</span>	      <span class='hs-comment'>-- Vanilla type synonyoms only, not family instances</span>
<a name="line-106"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcAddDeclCtxt</span> <span class='hs-varid'>decl</span> <span class='hs-varop'>$</span>
<a name="line-107"></a>    <span class='hs-varid'>kcHsTyVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcdTyVars</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>k_tvs</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-108"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"kcd1"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcdLName</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcdTyVars</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-109"></a>			<span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>k_tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-110"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kcLHsType</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcdSynRhs</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span>
<a name="line-111"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"kcd2"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcdName</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-112"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tc_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkArrowKind</span> <span class='hs-varop'>.</span> <span class='hs-varid'>hsTyVarKind</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhs_kind</span> <span class='hs-varid'>k_tvs</span>
<a name="line-113"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcdName</span> <span class='hs-varid'>decl</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc_kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-114"></a>
<a name="line-115"></a><a name="kcTyClDecl"></a><span class='hs-comment'>------------------------------------------------------------------------</span>
<a name="line-116"></a><span class='hs-definition'>kcTyClDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyClDecl</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-117"></a><span class='hs-comment'>-- This function is used solely for its side effect on kind variables</span>
<a name="line-118"></a>
<a name="line-119"></a><span class='hs-definition'>kcTyClDecl</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForeignType</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   
<a name="line-120"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-121"></a><span class='hs-definition'>kcTyClDecl</span> <span class='hs-varid'>decl</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyFamily</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> 
<a name="line-122"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kcFamilyDecl</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>decl</span>      <span class='hs-comment'>-- the empty list signals a toplevel decl</span>
<a name="line-123"></a>
<a name="line-124"></a><span class='hs-definition'>kcTyClDecl</span> <span class='hs-varid'>decl</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyData</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-125"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isFamInstDecl</span> <span class='hs-varop'>$</span> <span class='hs-varid'>decl</span> <span class='hs-layout'>)</span>   <span class='hs-comment'>-- must not be a family instance</span>
<a name="line-126"></a>    <span class='hs-varid'>kcTyClDeclBody</span> <span class='hs-varid'>decl</span>	<span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>kcDataDecl</span> <span class='hs-varid'>decl</span>
<a name="line-127"></a>
<a name="line-128"></a><span class='hs-definition'>kcTyClDecl</span> <span class='hs-varid'>decl</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ClassDecl</span> <span class='hs-layout'>{</span><span class='hs-varid'>tcdCtxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdSigs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdATs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ats</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-129"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kcTyClDeclBody</span> <span class='hs-varid'>decl</span>	<span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>tvs'</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-130"></a>    <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>discardResult</span> <span class='hs-layout'>(</span><span class='hs-varid'>kcHsContext</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-131"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapLocM</span> <span class='hs-layout'>(</span><span class='hs-varid'>kcFamilyDecl</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ats</span>
<a name="line-132"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapLocM</span> <span class='hs-varid'>kc_sig</span><span class='hs-layout'>)</span> <span class='hs-varid'>sigs</span> <span class='hs-layout'>}</span>
<a name="line-133"></a>  <span class='hs-keyword'>where</span>
<a name="line-134"></a>    <span class='hs-varid'>kc_sig</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeSig</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>op_ty</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>discardResult</span> <span class='hs-layout'>(</span><span class='hs-varid'>kcHsLiftedSigType</span> <span class='hs-varid'>op_ty</span><span class='hs-layout'>)</span>
<a name="line-135"></a>    <span class='hs-varid'>kc_sig</span> <span class='hs-layout'>(</span><span class='hs-conid'>GenericSig</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>op_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>discardResult</span> <span class='hs-layout'>(</span><span class='hs-varid'>kcHsLiftedSigType</span> <span class='hs-varid'>op_ty</span><span class='hs-layout'>)</span>
<a name="line-136"></a>    <span class='hs-varid'>kc_sig</span> <span class='hs-keyword'>_</span>                    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-137"></a>
<a name="line-138"></a><span class='hs-definition'>kcTyClDecl</span> <span class='hs-layout'>(</span><span class='hs-conid'>TySynonym</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>     <span class='hs-comment'>-- Type synonyms are never passed to kcTyClDecl</span>
<a name="line-139"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"kcTyClDecl TySynonym"</span>
<a name="line-140"></a>
<a name="line-141"></a><a name="kcTyClDeclBody"></a><span class='hs-comment'>--------------------</span>
<a name="line-142"></a><span class='hs-definition'>kcTyClDeclBody</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyClDecl</span> <span class='hs-conid'>Name</span>
<a name="line-143"></a>	       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-144"></a>	       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-145"></a><span class='hs-comment'>-- getInitialKind has made a suitably-shaped kind for the type or class</span>
<a name="line-146"></a><span class='hs-comment'>-- Unpack it, and attribute those kinds to the type variables</span>
<a name="line-147"></a><span class='hs-comment'>-- Extend the env with bindings for the tyvars, taken from</span>
<a name="line-148"></a><span class='hs-comment'>-- the kind of the tycon/class.  Give it to the thing inside, and </span>
<a name="line-149"></a><span class='hs-comment'>-- check the result kind matches</span>
<a name="line-150"></a><span class='hs-definition'>kcTyClDeclBody</span> <span class='hs-varid'>decl</span> <span class='hs-varid'>thing_inside</span>
<a name="line-151"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcAddDeclCtxt</span> <span class='hs-varid'>decl</span>		<span class='hs-varop'>$</span>
<a name="line-152"></a>    <span class='hs-keyword'>do</span> 	<span class='hs-layout'>{</span> <span class='hs-varid'>tc_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kcLookupKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcdLName</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span>
<a name="line-153"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>kinds</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitKindFunTys</span> <span class='hs-varid'>tc_kind</span>
<a name="line-154"></a>	      <span class='hs-varid'>hs_tvs</span> 	 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcdTyVars</span> <span class='hs-varid'>decl</span>
<a name="line-155"></a>	      <span class='hs-varid'>kinded_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>length</span> <span class='hs-varid'>kinds</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-layout'>)</span>
<a name="line-156"></a>			   <span class='hs-varid'>zipWith</span> <span class='hs-varid'>add_kind</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-varid'>kinds</span>
<a name="line-157"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>tcExtendKindEnvTvs</span> <span class='hs-varid'>kinded_tvs</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>}</span>
<a name="line-158"></a>  <span class='hs-keyword'>where</span>
<a name="line-159"></a>    <span class='hs-varid'>add_kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>UserTyVar</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>       <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>UserTyVar</span> <span class='hs-varid'>n</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>
<a name="line-160"></a>    <span class='hs-varid'>add_kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindedTyVar</span> <span class='hs-varid'>n</span> <span class='hs-varid'>hsk</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindedTyVar</span> <span class='hs-varid'>n</span> <span class='hs-varid'>hsk</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>
<a name="line-161"></a>
<a name="line-162"></a><a name="kcDataDecl"></a><span class='hs-comment'>-------------------</span>
<a name="line-163"></a><span class='hs-comment'>-- Kind check a data declaration, assuming that we already extended the</span>
<a name="line-164"></a><span class='hs-comment'>-- kind environment with the type variables of the left-hand side (these</span>
<a name="line-165"></a><span class='hs-comment'>-- kinded type variables are also passed as the second parameter).</span>
<a name="line-166"></a><span class='hs-comment'>--</span>
<a name="line-167"></a><span class='hs-definition'>kcDataDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyClDecl</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-168"></a><span class='hs-definition'>kcDataDecl</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyData</span> <span class='hs-layout'>{</span><span class='hs-varid'>tcdND</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_or_data</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdCtxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdCons</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cons</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-169"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kcHsContext</span> <span class='hs-varid'>ctxt</span>
<a name="line-170"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapLocM</span> <span class='hs-layout'>(</span><span class='hs-varid'>kcConDecl</span> <span class='hs-varid'>new_or_data</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>cons</span>
<a name="line-171"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span> <span class='hs-layout'>}</span>
<a name="line-172"></a><span class='hs-definition'>kcDataDecl</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"kcDataDecl"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span>
<a name="line-173"></a>
<a name="line-174"></a><a name="kcConDecl"></a><span class='hs-comment'>-------------------</span>
<a name="line-175"></a><span class='hs-definition'>kcConDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NewOrData</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ConDecl</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConDecl</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-176"></a>    <span class='hs-comment'>-- doc comments are typechecked to Nothing here</span>
<a name="line-177"></a><span class='hs-definition'>kcConDecl</span> <span class='hs-varid'>new_or_data</span> <span class='hs-varid'>con_decl</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ConDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>con_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_qvars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ex_tvs</span>
<a name="line-178"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>con_cxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ex_ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_details</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>details</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-179"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConCtxt</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-180"></a>    <span class='hs-varid'>kcHsTyVars</span> <span class='hs-varid'>ex_tvs</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>ex_tvs'</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-181"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ex_ctxt'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kcHsContext</span> <span class='hs-varid'>ex_ctxt</span>
<a name="line-182"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>details'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kc_con_details</span> <span class='hs-varid'>details</span>
<a name="line-183"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res'</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>res</span> <span class='hs-keyword'>of</span>
<a name="line-184"></a>            <span class='hs-conid'>ResTyH98</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>ResTyH98</span>
<a name="line-185"></a>            <span class='hs-conid'>ResTyGADT</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kcHsSigType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ResTyGADT</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-186"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>con_decl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>con_qvars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ex_tvs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_cxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ex_ctxt'</span>
<a name="line-187"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>con_details</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>details'</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-188"></a>  <span class='hs-keyword'>where</span>
<a name="line-189"></a>    <span class='hs-varid'>kc_con_details</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrefixCon</span> <span class='hs-varid'>btys</span><span class='hs-layout'>)</span>
<a name="line-190"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>btys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>kc_larg_ty</span> <span class='hs-varid'>btys</span>
<a name="line-191"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrefixCon</span> <span class='hs-varid'>btys'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-192"></a>    <span class='hs-varid'>kc_con_details</span> <span class='hs-layout'>(</span><span class='hs-conid'>InfixCon</span> <span class='hs-varid'>bty1</span> <span class='hs-varid'>bty2</span><span class='hs-layout'>)</span>
<a name="line-193"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>bty1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kc_larg_ty</span> <span class='hs-varid'>bty1</span>
<a name="line-194"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>bty2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kc_larg_ty</span> <span class='hs-varid'>bty2</span>
<a name="line-195"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>InfixCon</span> <span class='hs-varid'>bty1'</span> <span class='hs-varid'>bty2'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-196"></a>    <span class='hs-varid'>kc_con_details</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecCon</span> <span class='hs-varid'>fields</span><span class='hs-layout'>)</span>
<a name="line-197"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fields'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>kc_field</span> <span class='hs-varid'>fields</span>
<a name="line-198"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecCon</span> <span class='hs-varid'>fields'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-199"></a>
<a name="line-200"></a>    <span class='hs-varid'>kc_field</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConDeclField</span> <span class='hs-varid'>fld</span> <span class='hs-varid'>bty</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>bty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kc_larg_ty</span> <span class='hs-varid'>bty</span>
<a name="line-201"></a>                                           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConDeclField</span> <span class='hs-varid'>fld</span> <span class='hs-varid'>bty'</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-202"></a>
<a name="line-203"></a>    <span class='hs-varid'>kc_larg_ty</span> <span class='hs-varid'>bty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>new_or_data</span> <span class='hs-keyword'>of</span>
<a name="line-204"></a>                        <span class='hs-conid'>DataType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>kcHsSigType</span> <span class='hs-varid'>bty</span>
<a name="line-205"></a>                        <span class='hs-conid'>NewType</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>kcHsLiftedSigType</span> <span class='hs-varid'>bty</span>
<a name="line-206"></a>        <span class='hs-comment'>-- Can't allow an unlifted type for newtypes, because we're effectively</span>
<a name="line-207"></a>        <span class='hs-comment'>-- going to remove the constructor while coercing it to a lifted type.</span>
<a name="line-208"></a>        <span class='hs-comment'>-- And newtypes can't be bang'd</span>
<a name="line-209"></a>
<a name="line-210"></a><a name="kcFamilyDecl"></a><span class='hs-comment'>-------------------</span>
<a name="line-211"></a><span class='hs-comment'>-- Kind check a family declaration or type family default declaration.</span>
<a name="line-212"></a><span class='hs-comment'>--</span>
<a name="line-213"></a><span class='hs-definition'>kcFamilyDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- tyvars of enclosing class decl if any</span>
<a name="line-214"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyClDecl</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-215"></a><span class='hs-definition'>kcFamilyDecl</span> <span class='hs-varid'>classTvs</span> <span class='hs-varid'>decl</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyFamily</span> <span class='hs-layout'>{</span><span class='hs-varid'>tcdKind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kind</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-216"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kcTyClDeclBody</span> <span class='hs-varid'>decl</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>tvs'</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-217"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>unifyClassParmKinds</span> <span class='hs-varid'>tvs'</span>
<a name="line-218"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>discardResult</span> <span class='hs-layout'>(</span><span class='hs-varid'>scDsLHsMaybeKind</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-219"></a>  <span class='hs-keyword'>where</span>
<a name="line-220"></a>    <span class='hs-varid'>unifyClassParmKinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> 
<a name="line-221"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span><span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hsTyVarNameKind</span> <span class='hs-varid'>tv</span>
<a name="line-222"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>classParmKind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookup</span> <span class='hs-varid'>n</span> <span class='hs-varid'>classTyKinds</span> 
<a name="line-223"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span>    <span class='hs-varid'>sLit</span> <span class='hs-str'>"When kind checking family declaration"</span><span class='hs-layout'>)</span>
<a name="line-224"></a>                          <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcdLName</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span>
<a name="line-225"></a>        <span class='hs-keyword'>in</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unifyKind</span> <span class='hs-varid'>k</span> <span class='hs-varid'>classParmKind</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-226"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-227"></a>    <span class='hs-varid'>classTyKinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>hsTyVarNameKind</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>classTvs</span><span class='hs-keyglyph'>]</span>
<a name="line-228"></a>
<a name="line-229"></a><span class='hs-definition'>kcFamilyDecl</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TySynonym</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-230"></a>   <span class='hs-comment'>-- We don't have to do anything here for type family defaults:</span>
<a name="line-231"></a>   <span class='hs-comment'>-- tcClassATs will use tcAssocDecl to check them</span>
<a name="line-232"></a><span class='hs-definition'>kcFamilyDecl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"kcFamilyDecl"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span>
<a name="line-233"></a>
<a name="line-234"></a><a name="discardResult"></a><span class='hs-comment'>-------------------</span>
<a name="line-235"></a><span class='hs-definition'>discardResult</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-236"></a><span class='hs-definition'>discardResult</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
</pre>\end{code}


%************************************************************************
%*									*
\subsection{Type checking}
%*									*
%************************************************************************

Note [Type checking recursive type and class declarations]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
At this point we have completed *kind-checking* of a mutually
recursive group of type/class decls (done in kcTyClGroup). However,
we discarded the kind-checked types (eg RHSs of data type decls); 
note that kcTyClDecl returns ().  There are two reasons:

  * It's convenient, because we don't have to rebuild a
    kinded HsDecl (a fairly elaborate type)

  * It's necessary, because after kind-generalisation, the
    TyCons/Classes may now be kind-polymorphic, and hence need
    to be given kind arguments.  

Example:
       data T f a = MkT (f a) (T f a)
During kind-checking, we give T the kind T :: k1 -> k2 -> *
and figure out constraints on k1, k2 etc. Then we generalise
to get   T :: forall k. (k->*) -> k -> *
So now the (T f a) in the RHS must be elaborated to (T k f a).
    
However, during tcTyClDecl of T (above) we will be in a recursive
"knot". So we aren't allowed to look at the TyCon T itself; we are only
allowed to put it (lazily) in the returned structures.  But when
kind-checking the RHS of T's decl, we *do* need to know T's kind (so
that we can correctly elaboarate (T k f a).  How can we get T's kind
without looking at T?  Delicate answer: during tcTyClDecl, we extend

  *Global* env with T -> ATyCon (the (not yet built) TyCon for T)
  *Local*  env with T -> AThing (polymorphic kind of T)

Then:

  * During TcHsType.kcTyVar we look in the *local* env, to get the
    known kind for T.

  * But in TcHsType.ds_type (and ds_var_app in particular) we look in
    the *global* env to get the TyCon. But we must be careful not to
    force the TyCon or we'll get a loop.

This fancy footwork (with two bindings for T) is only necesary for the
TyCons or Classes of this recursive group.  Earlier, finished groups,
live in the global env only.

\begin{code}
<pre><a name="line-1"></a><a name="tcTyClDecl"></a><span class='hs-definition'>tcTyClDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RecFlag</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LTyClDecl</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyThing</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-definition'>tcTyClDecl</span> <span class='hs-varid'>calc_isrec</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tcAddDeclCtxt</span> <span class='hs-varid'>decl</span> <span class='hs-varop'>$</span>
<a name="line-4"></a>    <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcTyAndCl-x"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;&gt;</span>
<a name="line-5"></a>    <span class='hs-varid'>tcTyClDecl1</span> <span class='hs-conid'>NoParentTyCon</span> <span class='hs-varid'>calc_isrec</span> <span class='hs-varid'>decl</span>
<a name="line-6"></a>
<a name="line-7"></a>  <span class='hs-comment'>-- "type family" declarations</span>
<a name="line-8"></a><a name="tcTyClDecl1"></a><span class='hs-definition'>tcTyClDecl1</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyConParent</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RecFlag</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyClDecl</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyThing</span><span class='hs-keyglyph'>]</span>
<a name="line-9"></a><span class='hs-definition'>tcTyClDecl1</span> <span class='hs-varid'>parent</span> <span class='hs-sel'>_calc_isrec</span>
<a name="line-10"></a>              <span class='hs-layout'>(</span><span class='hs-conid'>TyFamily</span> <span class='hs-layout'>{</span><span class='hs-varid'>tcdFlavour</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TypeFamily</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdLName</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tc_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcTyClTyVars</span> <span class='hs-varid'>tc_name</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>tvs'</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-12"></a>  <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"type family:"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc_name</span><span class='hs-layout'>)</span>
<a name="line-13"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>checkFamFlag</span> <span class='hs-varid'>tc_name</span>
<a name="line-14"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>buildSynTyCon</span> <span class='hs-varid'>tc_name</span> <span class='hs-varid'>tvs'</span> <span class='hs-conid'>SynFamilyTyCon</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>parent</span> <span class='hs-conid'>Nothing</span>
<a name="line-15"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tycon</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-16"></a>
<a name="line-17"></a>  <span class='hs-comment'>-- "data family" declaration</span>
<a name="line-18"></a><span class='hs-definition'>tcTyClDecl1</span> <span class='hs-varid'>parent</span> <span class='hs-sel'>_calc_isrec</span>
<a name="line-19"></a>              <span class='hs-layout'>(</span><span class='hs-conid'>TyFamily</span> <span class='hs-layout'>{</span><span class='hs-varid'>tcdFlavour</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DataFamily</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdLName</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tc_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcTyClTyVars</span> <span class='hs-varid'>tc_name</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>tvs'</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-21"></a>  <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"data family:"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc_name</span><span class='hs-layout'>)</span>
<a name="line-22"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>checkFamFlag</span> <span class='hs-varid'>tc_name</span>
<a name="line-23"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>extra_tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcDataKindSig</span> <span class='hs-varid'>kind</span>
<a name="line-24"></a>  <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>final_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs'</span> <span class='hs-varop'>++</span> <span class='hs-varid'>extra_tvs</span>    <span class='hs-comment'>-- we may not need these</span>
<a name="line-25"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>buildAlgTyCon</span> <span class='hs-varid'>tc_name</span> <span class='hs-varid'>final_tvs</span> <span class='hs-conid'>[]</span>
<a name="line-26"></a>               <span class='hs-conid'>DataFamilyTyCon</span> <span class='hs-conid'>Recursive</span> <span class='hs-conid'>True</span> <span class='hs-varid'>parent</span> <span class='hs-conid'>Nothing</span>
<a name="line-27"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tycon</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-28"></a>
<a name="line-29"></a>  <span class='hs-comment'>-- "type" synonym declaration</span>
<a name="line-30"></a><span class='hs-definition'>tcTyClDecl1</span> <span class='hs-sel'>_parent</span> <span class='hs-sel'>_calc_isrec</span>
<a name="line-31"></a>            <span class='hs-layout'>(</span><span class='hs-conid'>TySynonym</span> <span class='hs-layout'>{</span><span class='hs-varid'>tcdLName</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tc_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdSynRhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs_ty</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-32"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isNoParent</span> <span class='hs-sel'>_parent</span> <span class='hs-layout'>)</span>
<a name="line-33"></a>    <span class='hs-varid'>tcTyClTyVars</span> <span class='hs-varid'>tc_name</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>tvs'</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-34"></a>    <span class='hs-layout'>{</span> <span class='hs-varid'>rhs_ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcCheckHsType</span> <span class='hs-varid'>rhs_ty</span> <span class='hs-varid'>kind</span>
<a name="line-35"></a>    <span class='hs-layout'>;</span> <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>buildSynTyCon</span> <span class='hs-varid'>tc_name</span> <span class='hs-varid'>tvs'</span> <span class='hs-layout'>(</span><span class='hs-conid'>SynonymTyCon</span> <span class='hs-varid'>rhs_ty'</span><span class='hs-layout'>)</span>
<a name="line-36"></a>      	       		     <span class='hs-varid'>kind</span> <span class='hs-conid'>NoParentTyCon</span> <span class='hs-conid'>Nothing</span>
<a name="line-37"></a>    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tycon</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-38"></a>
<a name="line-39"></a>  <span class='hs-comment'>-- "newtype" and "data"</span>
<a name="line-40"></a>  <span class='hs-comment'>-- NB: not used for newtype/data instances (whether associated or not)</span>
<a name="line-41"></a><span class='hs-definition'>tcTyClDecl1</span> <span class='hs-sel'>_parent</span> <span class='hs-varid'>calc_isrec</span>
<a name="line-42"></a>              <span class='hs-layout'>(</span><span class='hs-conid'>TyData</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcdND</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_or_data</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdCtxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span>
<a name="line-43"></a>	              <span class='hs-layout'>,</span> <span class='hs-varid'>tcdLName</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tc_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdKindSig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mb_ksig</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdCons</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cons</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-44"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isNoParent</span> <span class='hs-sel'>_parent</span> <span class='hs-layout'>)</span>
<a name="line-45"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>is_rec</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>calc_isrec</span> <span class='hs-varid'>tc_name</span>
<a name="line-46"></a>        <span class='hs-varid'>h98_syntax</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>consUseH98Syntax</span> <span class='hs-varid'>cons</span> <span class='hs-keyword'>in</span>
<a name="line-47"></a>    <span class='hs-varid'>tcTyClTyVars</span> <span class='hs-varid'>tc_name</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>tvs'</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-48"></a>  <span class='hs-layout'>{</span> <span class='hs-varid'>extra_tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcDataKindSig</span> <span class='hs-varid'>kind</span>
<a name="line-49"></a>  <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>final_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs'</span> <span class='hs-varop'>++</span> <span class='hs-varid'>extra_tvs</span>
<a name="line-50"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>stupid_theta</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsKindedContext</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>kcHsContext</span> <span class='hs-varid'>ctxt</span>
<a name="line-51"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>kind_signatures</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_KindSignatures</span>
<a name="line-52"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>existential_ok</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_ExistentialQuantification</span>
<a name="line-53"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>gadt_ok</span>      <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_GADTs</span>
<a name="line-54"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>is_boot</span>	 <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcIsHsBoot</span>	<span class='hs-comment'>-- Are we compiling an hs-boot file?</span>
<a name="line-55"></a>  <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ex_ok</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>existential_ok</span> <span class='hs-varop'>||</span> <span class='hs-varid'>gadt_ok</span>	<span class='hs-comment'>-- Data cons can have existential context</span>
<a name="line-56"></a>
<a name="line-57"></a>	<span class='hs-comment'>-- Check that we don't use kind signatures without Glasgow extensions</span>
<a name="line-58"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>kind_signatures</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isNothing</span> <span class='hs-varid'>mb_ksig</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>badSigTyDecl</span> <span class='hs-varid'>tc_name</span><span class='hs-layout'>)</span>
<a name="line-59"></a>
<a name="line-60"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>dataDeclChecks</span> <span class='hs-varid'>tc_name</span> <span class='hs-varid'>new_or_data</span> <span class='hs-varid'>stupid_theta</span> <span class='hs-varid'>cons</span>
<a name="line-61"></a>
<a name="line-62"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fixM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-63"></a>	<span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>final_tvs</span><span class='hs-layout'>)</span>
<a name="line-64"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>data_cons</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcConDecls</span> <span class='hs-varid'>new_or_data</span> <span class='hs-varid'>ex_ok</span> <span class='hs-varid'>tycon</span> <span class='hs-layout'>(</span><span class='hs-varid'>final_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>cons</span>
<a name="line-65"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>tc_rhs</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-66"></a>	    <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>cons</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>is_boot</span> 	      <span class='hs-comment'>-- In a hs-boot file, empty cons means</span>
<a name="line-67"></a>	    <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varid'>totallyAbstractTyConRhs</span>  <span class='hs-comment'>-- "don't know"; hence totally Abstract</span>
<a name="line-68"></a>	    <span class='hs-keyword'>else</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>new_or_data</span> <span class='hs-keyword'>of</span>
<a name="line-69"></a>		   <span class='hs-conid'>DataType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkDataTyConRhs</span> <span class='hs-varid'>data_cons</span><span class='hs-layout'>)</span>
<a name="line-70"></a>		   <span class='hs-conid'>NewType</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>data_cons</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-71"></a>                               <span class='hs-varid'>mkNewTyConRhs</span> <span class='hs-varid'>tc_name</span> <span class='hs-varid'>tycon</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>data_cons</span><span class='hs-layout'>)</span>
<a name="line-72"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>buildAlgTyCon</span> <span class='hs-varid'>tc_name</span> <span class='hs-varid'>final_tvs</span> <span class='hs-varid'>stupid_theta</span> <span class='hs-varid'>tc_rhs</span> <span class='hs-varid'>is_rec</span>
<a name="line-73"></a>	    <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varid'>h98_syntax</span><span class='hs-layout'>)</span> <span class='hs-conid'>NoParentTyCon</span> <span class='hs-conid'>Nothing</span>
<a name="line-74"></a>	<span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-75"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tycon</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-76"></a>
<a name="line-77"></a><span class='hs-definition'>tcTyClDecl1</span> <span class='hs-sel'>_parent</span> <span class='hs-varid'>calc_isrec</span>
<a name="line-78"></a>            <span class='hs-layout'>(</span><span class='hs-conid'>ClassDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcdLName</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>class_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span>
<a name="line-79"></a>	      <span class='hs-layout'>,</span> <span class='hs-varid'>tcdCtxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdMeths</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>meths</span>
<a name="line-80"></a>	      <span class='hs-layout'>,</span> <span class='hs-varid'>tcdFDs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fundeps</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdSigs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdATs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ats</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdATDefs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>at_defs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-81"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isNoParent</span> <span class='hs-sel'>_parent</span> <span class='hs-layout'>)</span>
<a name="line-82"></a>    <span class='hs-keyword'>do</span> 
<a name="line-83"></a>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctxt'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_stuff</span><span class='hs-layout'>,</span> <span class='hs-varid'>gen_dm_env</span><span class='hs-layout'>)</span>
<a name="line-84"></a>       <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTyClTyVars</span> <span class='hs-varid'>class_name</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>tvs'</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-85"></a>          <span class='hs-layout'>{</span> <span class='hs-conid'>MASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isConstraintKind</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>)</span>
<a name="line-86"></a>          <span class='hs-layout'>;</span> <span class='hs-varid'>ctxt'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsKindedContext</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>kcHsContext</span> <span class='hs-varid'>ctxt</span>
<a name="line-87"></a>          <span class='hs-layout'>;</span> <span class='hs-varid'>fds'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>addLocM</span> <span class='hs-varid'>tc_fundep</span><span class='hs-layout'>)</span> <span class='hs-varid'>fundeps</span>
<a name="line-88"></a>          <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig_stuff</span><span class='hs-layout'>,</span> <span class='hs-varid'>gen_dm_env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcClassSigs</span> <span class='hs-varid'>class_name</span> <span class='hs-varid'>sigs</span> <span class='hs-varid'>meths</span>
<a name="line-89"></a>          <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctxt'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_stuff</span><span class='hs-layout'>,</span> <span class='hs-varid'>gen_dm_env</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-90"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>clas</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fixM</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>clas</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-91"></a>	    <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> 	<span class='hs-comment'>-- This little knot is just so we can get</span>
<a name="line-92"></a>			<span class='hs-comment'>-- hold of the name of the class TyCon, which we</span>
<a name="line-93"></a>			<span class='hs-comment'>-- need to look up its recursiveness</span>
<a name="line-94"></a>		    <span class='hs-varid'>tycon_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConName</span> <span class='hs-layout'>(</span><span class='hs-varid'>classTyCon</span> <span class='hs-varid'>clas</span><span class='hs-layout'>)</span>
<a name="line-95"></a>		    <span class='hs-varid'>tc_isrec</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>calc_isrec</span> <span class='hs-varid'>tycon_name</span>
<a name="line-96"></a>
<a name="line-97"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>at_stuff</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcClassATs</span> <span class='hs-varid'>class_name</span> <span class='hs-layout'>(</span><span class='hs-conid'>AssocFamilyTyCon</span> <span class='hs-varid'>clas</span><span class='hs-layout'>)</span> <span class='hs-varid'>ats</span> <span class='hs-varid'>at_defs</span>
<a name="line-98"></a>            <span class='hs-comment'>-- NB: 'ats' only contains "type family" and "data family" declarations</span>
<a name="line-99"></a>            <span class='hs-comment'>-- and 'at_defs' only contains associated-type defaults</span>
<a name="line-100"></a>
<a name="line-101"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>buildClass</span> <span class='hs-conid'>False</span> <span class='hs-comment'>{- Must include unfoldings for selectors -}</span>
<a name="line-102"></a>			 <span class='hs-varid'>class_name</span> <span class='hs-varid'>tvs'</span> <span class='hs-varid'>ctxt'</span> <span class='hs-varid'>fds'</span> <span class='hs-varid'>at_stuff</span>
<a name="line-103"></a>			 <span class='hs-varid'>sig_stuff</span> <span class='hs-varid'>tc_isrec</span> <span class='hs-layout'>}</span>
<a name="line-104"></a>
<a name="line-105"></a>  <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>gen_dm_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>AnId</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkExportedLocalId</span> <span class='hs-varid'>gen_dm_name</span> <span class='hs-varid'>gen_dm_ty</span><span class='hs-layout'>)</span>
<a name="line-106"></a>                     <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>sel_id</span><span class='hs-layout'>,</span> <span class='hs-conid'>GenDefMeth</span> <span class='hs-varid'>gen_dm_name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>classOpItems</span> <span class='hs-varid'>clas</span>
<a name="line-107"></a>                     <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>gen_dm_tau</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expectJust</span> <span class='hs-str'>"tcTyClDecl1"</span> <span class='hs-varop'>$</span>
<a name="line-108"></a>                                        <span class='hs-varid'>lookupNameEnv</span> <span class='hs-varid'>gen_dm_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>sel_id</span><span class='hs-layout'>)</span>
<a name="line-109"></a>		     <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>gen_dm_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSigmaTy</span> <span class='hs-varid'>tvs'</span> 
<a name="line-110"></a>                                                 <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkClassPred</span> <span class='hs-varid'>clas</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> 
<a name="line-111"></a>                                                 <span class='hs-varid'>gen_dm_tau</span>
<a name="line-112"></a>                     <span class='hs-keyglyph'>]</span>
<a name="line-113"></a>        <span class='hs-varid'>class_ats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>ATyCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>classATs</span> <span class='hs-varid'>clas</span><span class='hs-layout'>)</span>
<a name="line-114"></a>
<a name="line-115"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>classTyCon</span> <span class='hs-varid'>clas</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>gen_dm_ids</span> <span class='hs-varop'>++</span> <span class='hs-varid'>class_ats</span> <span class='hs-layout'>)</span>
<a name="line-116"></a>      <span class='hs-comment'>-- NB: Order is important due to the call to `mkGlobalThings' when</span>
<a name="line-117"></a>      <span class='hs-comment'>--     tying the the type and class declaration type checking knot.</span>
<a name="line-118"></a>  <span class='hs-layout'>}</span>
<a name="line-119"></a>  <span class='hs-keyword'>where</span>
<a name="line-120"></a>    <span class='hs-varid'>tc_fundep</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tvs1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>tcLookupTyVar</span> <span class='hs-varid'>tvs1</span> <span class='hs-layout'>;</span>
<a name="line-121"></a>				<span class='hs-layout'>;</span> <span class='hs-varid'>tvs2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>tcLookupTyVar</span> <span class='hs-varid'>tvs2</span> <span class='hs-layout'>;</span>
<a name="line-122"></a>				<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs2'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-123"></a>
<a name="line-124"></a><span class='hs-definition'>tcTyClDecl1</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>
<a name="line-125"></a>  <span class='hs-layout'>(</span><span class='hs-conid'>ForeignType</span> <span class='hs-layout'>{</span><span class='hs-varid'>tcdLName</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tc_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdExtName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_ext_name</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-126"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ATyCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkForeignTyCon</span> <span class='hs-varid'>tc_name</span> <span class='hs-varid'>tc_ext_name</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
</pre>\end{code}

%************************************************************************
%*									*
               Typechecking associated types (in class decls)
	       (including the associated-type defaults)
%*									*
%************************************************************************

Note [Associated type defaults]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The following is an example of associated type defaults:
             class C a where
               data D a 

               type F a b :: *
               type F a Z = [a]        -- Default
               type F a (S n) = F a n  -- Default

Note that:
  - We can have more than one default definition for a single associated type,
    as long as they do not overlap (same rules as for instances)
  - We can get default definitions only for type families, not data families

\begin{code}
<pre><a name="line-1"></a><a name="tcClassATs"></a><span class='hs-definition'>tcClassATs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span>             <span class='hs-comment'>-- The class name (not knot-tied)</span>
<a name="line-2"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyConParent</span>      <span class='hs-comment'>-- The class parent of this associated type</span>
<a name="line-3"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LTyClDecl</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- Associated types. All FamTyCon</span>
<a name="line-4"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LTyClDecl</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- Associated type defaults. All SynTyCon</span>
<a name="line-5"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ClassATItem</span><span class='hs-keyglyph'>]</span>
<a name="line-6"></a><span class='hs-definition'>tcClassATs</span> <span class='hs-varid'>class_name</span> <span class='hs-varid'>parent</span> <span class='hs-varid'>ats</span> <span class='hs-varid'>at_defs</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>  <span class='hs-comment'>-- Complain about associated type defaults for non associated-types</span>
<a name="line-8"></a>         <span class='hs-varid'>sequence_</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>badATErr</span> <span class='hs-varid'>class_name</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-9"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcdName</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>at_defs</span>
<a name="line-10"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-varop'>`elemNameSet`</span> <span class='hs-varid'>at_names</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-11"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>tc_at</span> <span class='hs-varid'>ats</span> <span class='hs-layout'>}</span>
<a name="line-12"></a>  <span class='hs-keyword'>where</span>
<a name="line-13"></a>    <span class='hs-varid'>at_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNameSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcdName</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>ats</span><span class='hs-layout'>)</span>
<a name="line-14"></a>
<a name="line-15"></a>    <span class='hs-varid'>at_defs_map</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LTyClDecl</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-16"></a>    <span class='hs-comment'>-- Maps an AT in 'ats' to a list of all its default defs in 'at_defs'</span>
<a name="line-17"></a>    <span class='hs-varid'>at_defs_map</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>at_def</span> <span class='hs-varid'>nenv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extendNameEnv_C</span> <span class='hs-layout'>(</span><span class='hs-varop'>++</span><span class='hs-layout'>)</span> <span class='hs-varid'>nenv</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcdName</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>at_def</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>at_def</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> 
<a name="line-18"></a>                        <span class='hs-varid'>emptyNameEnv</span> <span class='hs-varid'>at_defs</span>
<a name="line-19"></a>
<a name="line-20"></a>    <span class='hs-varid'>tc_at</span> <span class='hs-varid'>at</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>fam_tc</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addLocM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcTyClDecl1</span> <span class='hs-varid'>parent</span>
<a name="line-21"></a>                                                           <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-conid'>Recursive</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>at</span>
<a name="line-22"></a>                  <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>at_defs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupNameEnv</span> <span class='hs-varid'>at_defs_map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcdName</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>at</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-23"></a>                                        <span class='hs-varop'>`orElse`</span> <span class='hs-conid'>[]</span>
<a name="line-24"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>atd</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcDefaultAssocDecl</span> <span class='hs-varid'>fam_tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>at_defs</span>
<a name="line-25"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>fam_tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>atd</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-26"></a>
<a name="line-27"></a>
<a name="line-28"></a><a name="tcDefaultAssocDecl"></a><span class='hs-comment'>-------------------------</span>
<a name="line-29"></a><span class='hs-definition'>tcDefaultAssocDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span>              <span class='hs-comment'>-- ^ Family TyCon</span>
<a name="line-30"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LTyClDecl</span> <span class='hs-conid'>Name</span>     <span class='hs-comment'>-- ^ RHS</span>
<a name="line-31"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>ATDefault</span>      <span class='hs-comment'>-- ^ Type checked RHS and free TyVars</span>
<a name="line-32"></a><span class='hs-definition'>tcDefaultAssocDecl</span> <span class='hs-varid'>fam_tc</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span>
<a name="line-33"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-34"></a>    <span class='hs-varid'>tcAddDefaultAssocDeclCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcdName</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-35"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcDefaultAssocDecl"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span>
<a name="line-36"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>at_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>at_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>at_rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSynFamInstDecl</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>decl</span>
<a name="line-37"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATD</span> <span class='hs-varid'>at_tvs</span> <span class='hs-varid'>at_tys</span> <span class='hs-varid'>at_rhs</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-38"></a><span class='hs-comment'>-- We check for well-formedness and validity later, in checkValidClass</span>
<a name="line-39"></a><span class='hs-comment'>-------------------------</span>
<a name="line-40"></a>
<a name="line-41"></a><a name="tcSynFamInstDecl"></a><span class='hs-definition'>tcSynFamInstDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyClDecl</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-42"></a><span class='hs-definition'>tcSynFamInstDecl</span> <span class='hs-varid'>fam_tc</span> <span class='hs-layout'>(</span><span class='hs-conid'>TySynonym</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcdTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcdTyPats</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>pats</span>
<a name="line-43"></a>                                   <span class='hs-layout'>,</span> <span class='hs-varid'>tcdSynRhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-44"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>isSynTyCon</span> <span class='hs-varid'>fam_tc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrongKindOfFamily</span> <span class='hs-varid'>fam_tc</span><span class='hs-layout'>)</span>
<a name="line-45"></a>
<a name="line-46"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>kc_rhs</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kcCheckLHsType</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>(</span><span class='hs-conid'>EK</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Expected"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-47"></a>
<a name="line-48"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcFamTyPats</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>pats</span> <span class='hs-layout'>(</span><span class='hs-varid'>kc_rhs</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-49"></a>                <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>tvs'</span> <span class='hs-varid'>pats'</span> <span class='hs-varid'>res_kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-50"></a>
<a name="line-51"></a>       <span class='hs-layout'>{</span> <span class='hs-varid'>rhs'</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kc_rhs</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>res_kind</span>
<a name="line-52"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>rhs''</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsKindedType</span> <span class='hs-varid'>rhs'</span>
<a name="line-53"></a>
<a name="line-54"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>pats'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs''</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-55"></a>
<a name="line-56"></a><span class='hs-definition'>tcSynFamInstDecl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>decl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tcSynFamInstDecl"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span>
<a name="line-57"></a>
<a name="line-58"></a><span class='hs-comment'>-------------------------</span>
<a name="line-59"></a><span class='hs-comment'>-- Kind check type patterns and kind annotate the embedded type variables.</span>
<a name="line-60"></a><span class='hs-comment'>--</span>
<a name="line-61"></a><span class='hs-comment'>-- * Here we check that a type instance matches its kind signature, but we do</span>
<a name="line-62"></a><span class='hs-comment'>--   not check whether there is a pattern for each type index; the latter</span>
<a name="line-63"></a><span class='hs-comment'>--   check is only required for type synonym instances.</span>
<a name="line-64"></a>
<a name="line-65"></a><a name="tcFamTyPats"></a><span class='hs-comment'>-----------------</span>
<a name="line-66"></a><span class='hs-definition'>tcFamTyPats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span>
<a name="line-67"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-68"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>any</span><span class='hs-layout'>)</span>      <span class='hs-comment'>-- Kind checker for RHS</span>
<a name="line-69"></a>                                        <span class='hs-comment'>-- result is ignored</span>
<a name="line-70"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>KindVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcKind</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-71"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-72"></a><span class='hs-comment'>-- Check the type patterns of a type or data family instance</span>
<a name="line-73"></a><span class='hs-comment'>--     type instance F &lt;pat1&gt; &lt;pat2&gt; = &lt;type&gt;</span>
<a name="line-74"></a><span class='hs-comment'>-- The 'tyvars' are the free type variables of pats</span>
<a name="line-75"></a><span class='hs-comment'>-- </span>
<a name="line-76"></a><span class='hs-comment'>-- NB: The family instance declaration may be an associated one,</span>
<a name="line-77"></a><span class='hs-comment'>-- nested inside an instance decl, thus</span>
<a name="line-78"></a><span class='hs-comment'>--	  instance C [a] where</span>
<a name="line-79"></a><span class='hs-comment'>--	    type F [a] = ...</span>
<a name="line-80"></a><span class='hs-comment'>-- In that case, the type variable 'a' will *already be in scope*</span>
<a name="line-81"></a><span class='hs-comment'>-- (and, if C is poly-kinded, so will its kind parameter).</span>
<a name="line-82"></a>
<a name="line-83"></a><span class='hs-definition'>tcFamTyPats</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>pats</span> <span class='hs-varid'>kind_checker</span> <span class='hs-varid'>thing_inside</span>
<a name="line-84"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kcHsTyVars</span> <span class='hs-varid'>tyvars</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-85"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>fam_kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitForAllTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConKind</span> <span class='hs-varid'>fam_tc</span><span class='hs-layout'>)</span>
<a name="line-86"></a>
<a name="line-87"></a>         <span class='hs-comment'>-- A family instance must have exactly the same number of type</span>
<a name="line-88"></a>         <span class='hs-comment'>-- parameters as the family declaration.  You can't write</span>
<a name="line-89"></a>         <span class='hs-comment'>--     type family F a :: * -&gt; *</span>
<a name="line-90"></a>         <span class='hs-comment'>--     type instance F Int y = y</span>
<a name="line-91"></a>         <span class='hs-comment'>-- because then the type (F Int) would be like (\y.y)</span>
<a name="line-92"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>fam_arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>fam_tc</span> <span class='hs-comment'>-</span> <span class='hs-varid'>length</span> <span class='hs-varid'>fam_kvs</span>
<a name="line-93"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>pats</span> <span class='hs-varop'>==</span> <span class='hs-varid'>fam_arity</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-94"></a>                 <span class='hs-varid'>wrongNumberOfParmsErr</span> <span class='hs-varid'>fam_arity</span>
<a name="line-95"></a>
<a name="line-96"></a>         <span class='hs-comment'>-- Instantiate with meta kind vars</span>
<a name="line-97"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>fam_arg_kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varid'>newMetaKindVar</span><span class='hs-layout'>)</span> <span class='hs-varid'>fam_kvs</span>
<a name="line-98"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>body'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substKiWith</span> <span class='hs-varid'>fam_kvs</span> <span class='hs-varid'>fam_arg_kinds</span> <span class='hs-varid'>body</span>
<a name="line-99"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>kinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>resKind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitKindFunTysN</span> <span class='hs-varid'>fam_arity</span> <span class='hs-varid'>body'</span>
<a name="line-100"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>typats</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWithM</span> <span class='hs-varid'>kcCheckLHsType</span> <span class='hs-varid'>pats</span>
<a name="line-101"></a>                            <span class='hs-keyglyph'>[</span> <span class='hs-varid'>expArgKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>fam_tc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>n</span>
<a name="line-102"></a>                            <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>kind</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kinds</span> <span class='hs-varop'>`zip`</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span><span class='hs-keyglyph'>..</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-103"></a>
<a name="line-104"></a>        <span class='hs-comment'>-- Kind check the "thing inside"; this just works by </span>
<a name="line-105"></a>        <span class='hs-comment'>-- side-effecting any kind unification variables</span>
<a name="line-106"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kind_checker</span> <span class='hs-varid'>resKind</span>
<a name="line-107"></a>
<a name="line-108"></a>         <span class='hs-comment'>-- Type check indexed data type declaration</span>
<a name="line-109"></a>         <span class='hs-comment'>-- We kind generalize the kind patterns since they contain</span>
<a name="line-110"></a>         <span class='hs-comment'>-- all the meta kind variables</span>
<a name="line-111"></a>         <span class='hs-comment'>-- See Note [Quantifying over family patterns]</span>
<a name="line-112"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcTyVarBndrsKindGen</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>tvs'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-113"></a>
<a name="line-114"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>t_kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>fam_arg_kinds'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kindGeneralizeKinds</span> <span class='hs-varid'>fam_arg_kinds</span>
<a name="line-115"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>k_typats</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>tcHsKindedType</span> <span class='hs-varid'>typats</span>
<a name="line-116"></a>
<a name="line-117"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-varid'>t_kvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>fam_arg_kinds'</span> <span class='hs-varop'>++</span> <span class='hs-varid'>k_typats</span><span class='hs-layout'>)</span> <span class='hs-varid'>resKind</span> <span class='hs-layout'>}</span>
<a name="line-118"></a>       <span class='hs-layout'>}</span>
</pre>\end{code}

Note [Quantifying over family patterns]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We need to quantify over two different lots of kind variables:

First, the ones that come from tcTyVarBndrsKindGen, as usual
  data family Dist a 

  -- Proxy :: forall k. k -> *
  data instance Dist (Proxy a) = DP
  -- Generates  data DistProxy = DP
  --            ax8 k (a::k) :: Dist * (Proxy k a) ~ DistProxy k a
  -- The 'k' comes from the tcTyVarBndrsKindGen (a::k)

Second, the ones that come from the kind argument of the type family
which we pick up using kindGeneralizeKinds:
  -- Any :: forall k. k
  data instance Dist Any = DA
  -- Generates  data DistAny k = DA
  --            ax7 k :: Dist k (Any k) ~ DistAny k 
  -- The 'k' comes from kindGeneralizeKinds (Any k)

Note [Associated type instances]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We allow this:
  class C a where
    type T x a
  instance C Int where
    type T (S y) Int = y
    type T Z     Int = Char

Note that 
  a) The variable 'x' is not bound by the class decl
  b) 'x' is instantiated to a non-type-variable in the instance
  c) There are several type instance decls for T in the instance

All this is fine.  Of course, you can't give any *more* instances
for (T ty Int) elsewhere, becuase it's an *associated* type.

Note [Checking consistent instantiation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  class C a b where
    type T a x b

  instance C [p] Int
    type T [p] y Int = (p,y,y)  -- Induces the family instance TyCon
                                --    type TR p y = (p,y,y)

So we 
  * Form the mini-envt from the class type variables a,b
    to the instance decl types [p],Int:   [a->[p], b->Int]

  * Look at the tyvars a,x,b of the type family constructor T
    (it shares tyvars with the class C)

  * Apply the mini-evnt to them, and check that the result is
    consistent with the instance types [p] y Int


%************************************************************************
%*                                                                      *
               Data types
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="dataDeclChecks"></a><span class='hs-definition'>dataDeclChecks</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NewOrData</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LConDecl</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-definition'>dataDeclChecks</span> <span class='hs-varid'>tc_name</span> <span class='hs-varid'>new_or_data</span> <span class='hs-varid'>stupid_theta</span> <span class='hs-varid'>cons</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>   <span class='hs-comment'>-- Check that we don't use GADT syntax in H98 world</span>
<a name="line-4"></a>         <span class='hs-varid'>gadtSyntax_ok</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_GADTSyntax</span>
<a name="line-5"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>h98_syntax</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>consUseH98Syntax</span> <span class='hs-varid'>cons</span>
<a name="line-6"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>gadtSyntax_ok</span> <span class='hs-varop'>||</span> <span class='hs-varid'>h98_syntax</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>badGadtDecl</span> <span class='hs-varid'>tc_name</span><span class='hs-layout'>)</span>
<a name="line-7"></a>
<a name="line-8"></a>	   <span class='hs-comment'>-- Check that the stupid theta is empty for a GADT-style declaration</span>
<a name="line-9"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>stupid_theta</span> <span class='hs-varop'>||</span> <span class='hs-varid'>h98_syntax</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>badStupidTheta</span> <span class='hs-varid'>tc_name</span><span class='hs-layout'>)</span>
<a name="line-10"></a>
<a name="line-11"></a>	<span class='hs-comment'>-- Check that a newtype has exactly one constructor</span>
<a name="line-12"></a>	<span class='hs-comment'>-- Do this before checking for empty data decls, so that</span>
<a name="line-13"></a>	<span class='hs-comment'>-- we don't suggest -XEmptyDataDecls for newtypes</span>
<a name="line-14"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_or_data</span> <span class='hs-varop'>==</span> <span class='hs-conid'>DataType</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isSingleton</span> <span class='hs-varid'>cons</span><span class='hs-layout'>)</span> 
<a name="line-15"></a>	        <span class='hs-layout'>(</span><span class='hs-varid'>newtypeConError</span> <span class='hs-varid'>tc_name</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>cons</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-16"></a>
<a name="line-17"></a> 	<span class='hs-comment'>-- Check that there's at least one condecl,</span>
<a name="line-18"></a>	<span class='hs-comment'>-- or else we're reading an hs-boot file, or -XEmptyDataDecls</span>
<a name="line-19"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>empty_data_decls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_EmptyDataDecls</span>
<a name="line-20"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>is_boot</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcIsHsBoot</span>	<span class='hs-comment'>-- Are we compiling an hs-boot file?</span>
<a name="line-21"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>cons</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span> <span class='hs-varid'>empty_data_decls</span> <span class='hs-varop'>||</span> <span class='hs-varid'>is_boot</span><span class='hs-layout'>)</span>
<a name="line-22"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>emptyConDeclsErr</span> <span class='hs-varid'>tc_name</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-23"></a>    
<a name="line-24"></a><a name="tcConDecls"></a><span class='hs-comment'>-----------------------------------</span>
<a name="line-25"></a><span class='hs-definition'>tcConDecls</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NewOrData</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-26"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LConDecl</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>DataCon</span><span class='hs-keyglyph'>]</span>
<a name="line-27"></a><span class='hs-definition'>tcConDecls</span> <span class='hs-varid'>new_or_data</span> <span class='hs-varid'>ex_ok</span> <span class='hs-varid'>rep_tycon</span> <span class='hs-varid'>res_tmpl</span> <span class='hs-varid'>cons</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>addLocM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcConDecl</span> <span class='hs-varid'>new_or_data</span> <span class='hs-varid'>ex_ok</span> <span class='hs-varid'>rep_tycon</span> <span class='hs-varid'>res_tmpl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>cons</span>
<a name="line-29"></a>
<a name="line-30"></a><a name="tcConDecl"></a><span class='hs-definition'>tcConDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NewOrData</span>
<a name="line-31"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>		<span class='hs-comment'>-- True &lt;=&gt; -XExistentialQuantificaton or -XGADTs</span>
<a name="line-32"></a>	  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> 		<span class='hs-comment'>-- Representation tycon</span>
<a name="line-33"></a>	  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>	<span class='hs-comment'>-- Return type template (with its template tyvars)</span>
<a name="line-34"></a>	  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ConDecl</span> <span class='hs-conid'>Name</span> 
<a name="line-35"></a>	  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>DataCon</span>
<a name="line-36"></a>
<a name="line-37"></a><span class='hs-definition'>tcConDecl</span> <span class='hs-varid'>new_or_data</span> <span class='hs-varid'>existential_ok</span> <span class='hs-varid'>rep_tycon</span> <span class='hs-varid'>res_tmpl</span> 	<span class='hs-comment'>-- Data types</span>
<a name="line-38"></a>	  <span class='hs-varid'>con</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ConDecl</span> <span class='hs-layout'>{</span><span class='hs-varid'>con_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-39"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-40"></a>    <span class='hs-layout'>{</span> <span class='hs-conid'>ConDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>con_qvars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_cxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt</span>
<a name="line-41"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>con_details</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>details</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res_ty</span> <span class='hs-layout'>}</span>
<a name="line-42"></a>        <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kcConDecl</span> <span class='hs-varid'>new_or_data</span> <span class='hs-varid'>con</span>
<a name="line-43"></a>    <span class='hs-layout'>;</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConCtxt</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-44"></a>    <span class='hs-varid'>tcTyVarBndrsKindGen</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>tvs'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-45"></a>    <span class='hs-layout'>{</span> <span class='hs-varid'>ctxt'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsKindedContext</span> <span class='hs-varid'>ctxt</span>
<a name="line-46"></a>    <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>existential_ok</span> <span class='hs-varop'>||</span> <span class='hs-varid'>conRepresentibleWithH98Syntax</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span>
<a name="line-47"></a>	      <span class='hs-layout'>(</span><span class='hs-varid'>badExistential</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-48"></a>    <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcConDecl 1"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span>
<a name="line-49"></a>    <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>univ_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ex_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>eq_preds</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcResultType</span> <span class='hs-varid'>res_tmpl</span> <span class='hs-varid'>tvs'</span> <span class='hs-varid'>res_ty</span>
<a name="line-50"></a>    <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span>
<a name="line-51"></a>	<span class='hs-varid'>tc_datacon</span> <span class='hs-varid'>is_infix</span> <span class='hs-varid'>field_lbls</span> <span class='hs-varid'>btys</span>
<a name="line-52"></a>	  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>stricts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndUnzipM</span> <span class='hs-varid'>tcConArg</span> <span class='hs-varid'>btys</span>
<a name="line-53"></a>	       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcConDecl 3"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-54"></a>
<a name="line-55"></a>    	       <span class='hs-layout'>;</span> <span class='hs-varid'>buildDataCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varid'>is_infix</span>
<a name="line-56"></a>    		    <span class='hs-varid'>stricts</span> <span class='hs-varid'>field_lbls</span>
<a name="line-57"></a>    		    <span class='hs-varid'>univ_tvs</span> <span class='hs-varid'>ex_tvs</span> <span class='hs-varid'>eq_preds</span> <span class='hs-varid'>ctxt'</span> <span class='hs-varid'>arg_tys</span>
<a name="line-58"></a>		    <span class='hs-varid'>res_ty'</span> <span class='hs-varid'>rep_tycon</span> <span class='hs-layout'>}</span>
<a name="line-59"></a>		<span class='hs-comment'>-- NB:	we put data_tc, the type constructor gotten from the</span>
<a name="line-60"></a>		<span class='hs-comment'>--	constructor type signature into the data constructor;</span>
<a name="line-61"></a>		<span class='hs-comment'>--	that way checkValidDataCon can complain if it's wrong.</span>
<a name="line-62"></a>
<a name="line-63"></a>    <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcConDecl 2"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-64"></a>    <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>details</span> <span class='hs-keyword'>of</span>
<a name="line-65"></a>	<span class='hs-conid'>PrefixCon</span> <span class='hs-varid'>btys</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tc_datacon</span> <span class='hs-conid'>False</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>btys</span>
<a name="line-66"></a>	<span class='hs-conid'>InfixCon</span> <span class='hs-varid'>bty1</span> <span class='hs-varid'>bty2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tc_datacon</span> <span class='hs-conid'>True</span>  <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>bty1</span><span class='hs-layout'>,</span><span class='hs-varid'>bty2</span><span class='hs-keyglyph'>]</span>
<a name="line-67"></a>	<span class='hs-conid'>RecCon</span> <span class='hs-varid'>fields</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tc_datacon</span> <span class='hs-conid'>False</span> <span class='hs-varid'>field_names</span> <span class='hs-varid'>btys</span>
<a name="line-68"></a>			   <span class='hs-keyword'>where</span>
<a name="line-69"></a>			      <span class='hs-varid'>field_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varop'>.</span> <span class='hs-varid'>cd_fld_name</span><span class='hs-layout'>)</span> <span class='hs-varid'>fields</span>
<a name="line-70"></a>			      <span class='hs-varid'>btys</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>cd_fld_type</span> <span class='hs-varid'>fields</span>
<a name="line-71"></a>    <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-72"></a>
<a name="line-73"></a><span class='hs-comment'>-- Example</span>
<a name="line-74"></a><span class='hs-comment'>--   data instance T (b,c) where </span>
<a name="line-75"></a><span class='hs-comment'>--	TI :: forall e. e -&gt; T (e,e)</span>
<a name="line-76"></a><span class='hs-comment'>--</span>
<a name="line-77"></a><span class='hs-comment'>-- The representation tycon looks like this:</span>
<a name="line-78"></a><span class='hs-comment'>--   data :R7T b c where </span>
<a name="line-79"></a><span class='hs-comment'>--	TI :: forall b1 c1. (b1 ~ c1) =&gt; b1 -&gt; :R7T b1 c1</span>
<a name="line-80"></a><span class='hs-comment'>-- In this case orig_res_ty = T (e,e)</span>
<a name="line-81"></a>
<a name="line-82"></a><a name="tcResultType"></a><span class='hs-definition'>tcResultType</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>	<span class='hs-comment'>-- Template for result type; e.g.</span>
<a name="line-83"></a>				<span class='hs-comment'>-- data instance T [a] b c = ...  </span>
<a name="line-84"></a>				<span class='hs-comment'>--      gives template ([a,b,c], T [a] b c)</span>
<a name="line-85"></a>	     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> 	<span class='hs-comment'>-- where MkT :: forall x y z. ...</span>
<a name="line-86"></a>	     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ResType</span> <span class='hs-conid'>Name</span>
<a name="line-87"></a>	     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>	 	<span class='hs-comment'>-- Universal</span>
<a name="line-88"></a>		     <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>		<span class='hs-comment'>-- Existential (distinct OccNames from univs)</span>
<a name="line-89"></a>		     <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span><span class='hs-conid'>Type</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>	<span class='hs-comment'>-- Equality predicates</span>
<a name="line-90"></a>		     <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>		<span class='hs-comment'>-- Typechecked return type</span>
<a name="line-91"></a>	<span class='hs-comment'>-- We don't check that the TyCon given in the ResTy is</span>
<a name="line-92"></a>	<span class='hs-comment'>-- the same as the parent tycon, because we are in the middle</span>
<a name="line-93"></a>	<span class='hs-comment'>-- of a recursive knot; so it's postponed until checkValidDataCon</span>
<a name="line-94"></a>
<a name="line-95"></a><span class='hs-definition'>tcResultType</span> <span class='hs-layout'>(</span><span class='hs-varid'>tmpl_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>dc_tvs</span> <span class='hs-conid'>ResTyH98</span>
<a name="line-96"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tmpl_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>dc_tvs</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-97"></a>	<span class='hs-comment'>-- In H98 syntax the dc_tvs are the existential ones</span>
<a name="line-98"></a>	<span class='hs-comment'>--	data T a b c = forall d e. MkT ...</span>
<a name="line-99"></a>	<span class='hs-comment'>-- The {a,b,c} are tc_tvs, and {d,e} are dc_tvs</span>
<a name="line-100"></a>
<a name="line-101"></a><span class='hs-definition'>tcResultType</span> <span class='hs-layout'>(</span><span class='hs-varid'>tmpl_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_tmpl</span><span class='hs-layout'>)</span> <span class='hs-varid'>dc_tvs</span> <span class='hs-layout'>(</span><span class='hs-conid'>ResTyGADT</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-102"></a>	<span class='hs-comment'>-- E.g.  data T [a] b c where</span>
<a name="line-103"></a>	<span class='hs-comment'>--	   MkT :: forall x y z. T [(x,y)] z z</span>
<a name="line-104"></a>	<span class='hs-comment'>-- Then we generate</span>
<a name="line-105"></a>	<span class='hs-comment'>--	Univ tyvars	Eq-spec</span>
<a name="line-106"></a>	<span class='hs-comment'>--	    a              a~(x,y)</span>
<a name="line-107"></a>	<span class='hs-comment'>--	    b		   b~z</span>
<a name="line-108"></a>	<span class='hs-comment'>--	    z		   </span>
<a name="line-109"></a>	<span class='hs-comment'>-- Existentials are the leftover type vars: [x,y]</span>
<a name="line-110"></a>	<span class='hs-comment'>-- So we return ([a,b,z], [x,y], [a~(x,y),b~z], T [(x,y)] z z)</span>
<a name="line-111"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>res_ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsKindedType</span> <span class='hs-varid'>res_ty</span>
<a name="line-112"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcMatchTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>tmpl_tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_tmpl</span> <span class='hs-varid'>res_ty'</span>
<a name="line-113"></a>                <span class='hs-comment'>-- This 'Just' pattern is sure to match, because if not</span>
<a name="line-114"></a>                <span class='hs-comment'>-- checkValidDataCon will complain first. The 'subst'</span>
<a name="line-115"></a>                <span class='hs-comment'>-- should not be looked at until after checkValidDataCon</span>
<a name="line-116"></a>                <span class='hs-comment'>-- We can't check eagerly because we are in a "knot" in </span>
<a name="line-117"></a>                <span class='hs-comment'>-- which 'tycon' is not yet fully defined</span>
<a name="line-118"></a>
<a name="line-119"></a>		<span class='hs-comment'>-- /Lazily/ figure out the univ_tvs etc</span>
<a name="line-120"></a>		<span class='hs-comment'>-- Each univ_tv is either a dc_tv or a tmpl_tv</span>
<a name="line-121"></a>	      <span class='hs-layout'>(</span><span class='hs-varid'>univ_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>eq_spec</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>choose</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-varid'>tidy_tmpl_tvs</span>
<a name="line-122"></a>	      <span class='hs-varid'>choose</span> <span class='hs-varid'>tmpl</span> <span class='hs-layout'>(</span><span class='hs-varid'>univs</span><span class='hs-layout'>,</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>)</span>
<a name="line-123"></a>		<span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupTyVar</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tmpl</span> 
<a name="line-124"></a>		<span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcGetTyVar_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-125"></a>		    <span class='hs-conid'>Just</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>univs</span><span class='hs-layout'>)</span>
<a name="line-126"></a>			    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-conop'>:</span><span class='hs-varid'>univs</span><span class='hs-layout'>,</span>   <span class='hs-varid'>eqs</span><span class='hs-layout'>)</span>
<a name="line-127"></a>		    <span class='hs-sel'>_other</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_tmpl</span><span class='hs-conop'>:</span><span class='hs-varid'>univs</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_tmpl</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>eqs</span><span class='hs-layout'>)</span>
<a name="line-128"></a>                               <span class='hs-keyword'>where</span>  <span class='hs-comment'>-- see Note [Substitution in template variables kinds]</span>
<a name="line-129"></a>                                 <span class='hs-varid'>new_tmpl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updateTyVarKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>tmpl</span>
<a name="line-130"></a>		<span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tcResultType"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span>
<a name="line-131"></a>	      <span class='hs-varid'>ex_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dc_tvs</span> <span class='hs-varop'>`minusList`</span> <span class='hs-varid'>univ_tvs</span>
<a name="line-132"></a>
<a name="line-133"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>univ_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ex_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>eq_spec</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-134"></a>  <span class='hs-keyword'>where</span>
<a name="line-135"></a>	<span class='hs-comment'>-- NB: tmpl_tvs and dc_tvs are distinct, but</span>
<a name="line-136"></a>	<span class='hs-comment'>-- we want them to be *visibly* distinct, both for</span>
<a name="line-137"></a>	<span class='hs-comment'>-- interface files and general confusion.  So rename</span>
<a name="line-138"></a>	<span class='hs-comment'>-- the tc_tvs, since they are not used yet (no </span>
<a name="line-139"></a>	<span class='hs-comment'>-- consequential renaming needed)</span>
<a name="line-140"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidy_tmpl_tvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>tidy_one</span> <span class='hs-varid'>init_occ_env</span> <span class='hs-varid'>tmpl_tvs</span>
<a name="line-141"></a>    <span class='hs-varid'>init_occ_env</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initTidyOccEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>getOccName</span> <span class='hs-varid'>dc_tvs</span><span class='hs-layout'>)</span>
<a name="line-142"></a>    <span class='hs-varid'>tidy_one</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv</span>    <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>setTyVarName</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyNameOcc</span> <span class='hs-varid'>name</span> <span class='hs-varid'>occ'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-143"></a>	      <span class='hs-keyword'>where</span>
<a name="line-144"></a>		 <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarName</span> <span class='hs-varid'>tv</span>
<a name="line-145"></a>		 <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>occ'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOccName</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> 
<a name="line-146"></a>
<a name="line-147"></a><span class='hs-comment'>{-
<a name="line-148"></a>Note [Substitution in template variables kinds]
<a name="line-149"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-150"></a>
<a name="line-151"></a>data List a = Nil | Cons a (List a)
<a name="line-152"></a>data SList s as where
<a name="line-153"></a>  SNil :: SList s Nil
<a name="line-154"></a>
<a name="line-155"></a>We call tcResultType with
<a name="line-156"></a>  tmpl_tvs = [(k :: BOX), (s :: k -&gt; *), (as :: List k)]
<a name="line-157"></a>  res_tmpl = SList k s as
<a name="line-158"></a>  res_ty = ResTyGADT (SList k1 (s1 :: k1 -&gt; *) (Nil k1))
<a name="line-159"></a>
<a name="line-160"></a>We get subst:
<a name="line-161"></a>  k -&gt; k1
<a name="line-162"></a>  s -&gt; s1
<a name="line-163"></a>  as -&gt; Nil k1
<a name="line-164"></a>
<a name="line-165"></a>Now we want to find out the universal variables and the equivalences
<a name="line-166"></a>between some of them and types (GADT).
<a name="line-167"></a>
<a name="line-168"></a>In this example, k and s are mapped to exactly variables which are not
<a name="line-169"></a>already present in the universal set, so we just add them without any
<a name="line-170"></a>coercion.
<a name="line-171"></a>
<a name="line-172"></a>But 'as' is mapped to 'Nil k1', so we add 'as' to the universal set,
<a name="line-173"></a>and add the equivalence with 'Nil k1' in 'eqs'.
<a name="line-174"></a>
<a name="line-175"></a>The problem is that with kind polymorphism, as's kind may now contain
<a name="line-176"></a>kind variables, and we have to apply the template substitution to it,
<a name="line-177"></a>which is why we create new_tmpl.
<a name="line-178"></a>
<a name="line-179"></a>The template substitution only maps kind variables to kind variables,
<a name="line-180"></a>since GADTs are not kind indexed.
<a name="line-181"></a>
<a name="line-182"></a>-}</span>
<a name="line-183"></a>
<a name="line-184"></a>
<a name="line-185"></a><a name="consUseH98Syntax"></a><span class='hs-definition'>consUseH98Syntax</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LConDecl</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-186"></a><span class='hs-definition'>consUseH98Syntax</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>con_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ResTyGADT</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-187"></a><span class='hs-definition'>consUseH98Syntax</span> <span class='hs-keyword'>_</span>                                             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-188"></a>		 <span class='hs-comment'>-- All constructors have same shape</span>
<a name="line-189"></a>
<a name="line-190"></a><a name="conRepresentibleWithH98Syntax"></a><span class='hs-definition'>conRepresentibleWithH98Syntax</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ConDecl</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-191"></a><span class='hs-definition'>conRepresentibleWithH98Syntax</span>
<a name="line-192"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>ConDecl</span> <span class='hs-layout'>{</span><span class='hs-varid'>con_qvars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_cxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ResTyH98</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-193"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>null</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-194"></a><span class='hs-definition'>conRepresentibleWithH98Syntax</span>
<a name="line-195"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>ConDecl</span> <span class='hs-layout'>{</span><span class='hs-varid'>con_qvars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_cxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ResTyGADT</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-196"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>f</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsTyVarName</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-197"></a>    <span class='hs-keyword'>where</span> <span class='hs-comment'>-- Each type variable should be used exactly once in the</span>
<a name="line-198"></a>          <span class='hs-comment'>-- result type, and the result type must just be the type</span>
<a name="line-199"></a>          <span class='hs-comment'>-- constructor applied to type variables</span>
<a name="line-200"></a>          <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsAppTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-varid'>v2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>vs</span>
<a name="line-201"></a>              <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>v2</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>f</span> <span class='hs-varid'>t1</span> <span class='hs-layout'>(</span><span class='hs-varid'>delete</span> <span class='hs-varid'>v2</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span>
<a name="line-202"></a>          <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-203"></a>          <span class='hs-varid'>f</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-204"></a>
<a name="line-205"></a><a name="tcConArg"></a><span class='hs-comment'>-------------------</span>
<a name="line-206"></a><span class='hs-definition'>tcConArg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>HsBang</span><span class='hs-layout'>)</span>
<a name="line-207"></a><span class='hs-definition'>tcConArg</span> <span class='hs-varid'>bty</span>
<a name="line-208"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcConArg 1"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>bty</span><span class='hs-layout'>)</span>
<a name="line-209"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>arg_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsBangType</span> <span class='hs-varid'>bty</span>
<a name="line-210"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcConArg 2"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>bty</span><span class='hs-layout'>)</span>
<a name="line-211"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>strict_mark</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>chooseBoxingStrategy</span> <span class='hs-varid'>arg_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>getBangStrictness</span> <span class='hs-varid'>bty</span><span class='hs-layout'>)</span>
<a name="line-212"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>strict_mark</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-213"></a>
<a name="line-214"></a><a name="chooseBoxingStrategy"></a><span class='hs-comment'>-- We attempt to unbox/unpack a strict field when either:</span>
<a name="line-215"></a><span class='hs-comment'>--   (i)  The field is marked '!!', or</span>
<a name="line-216"></a><span class='hs-comment'>--   (ii) The field is marked '!', and the -funbox-strict-fields flag is on.</span>
<a name="line-217"></a><span class='hs-comment'>--</span>
<a name="line-218"></a><span class='hs-comment'>-- We have turned off unboxing of newtypes because coercions make unboxing </span>
<a name="line-219"></a><span class='hs-comment'>-- and reboxing more complicated</span>
<a name="line-220"></a><span class='hs-definition'>chooseBoxingStrategy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsBang</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>HsBang</span>
<a name="line-221"></a><span class='hs-definition'>chooseBoxingStrategy</span> <span class='hs-varid'>arg_ty</span> <span class='hs-varid'>bang</span>
<a name="line-222"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>bang</span> <span class='hs-keyword'>of</span>
<a name="line-223"></a>	<span class='hs-conid'>HsNoBang</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>HsNoBang</span>
<a name="line-224"></a>	<span class='hs-conid'>HsStrict</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unbox_strict</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>doptM</span> <span class='hs-conid'>Opt_UnboxStrictFields</span>
<a name="line-225"></a>                       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>unbox_strict</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>can_unbox</span> <span class='hs-conid'>HsStrict</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span>
<a name="line-226"></a>                                         <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-conid'>HsStrict</span> <span class='hs-layout'>}</span>
<a name="line-227"></a>	<span class='hs-conid'>HsNoUnpack</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>HsStrict</span>
<a name="line-228"></a>	<span class='hs-conid'>HsUnpack</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>omit_prags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>doptM</span> <span class='hs-conid'>Opt_OmitInterfacePragmas</span>
<a name="line-229"></a>            <span class='hs-comment'>-- Do not respect UNPACK pragmas if OmitInterfacePragmas is on</span>
<a name="line-230"></a>	    <span class='hs-comment'>-- See Trac #5252: unpacking means we must not conceal the</span>
<a name="line-231"></a>	    <span class='hs-comment'>--                 representation of the argument type</span>
<a name="line-232"></a>                       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>omit_prags</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-conid'>HsStrict</span>
<a name="line-233"></a>                                       <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>can_unbox</span> <span class='hs-conid'>HsUnpackFailed</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-234"></a>	<span class='hs-conid'>HsUnpackFailed</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"chooseBoxingStrategy"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span>
<a name="line-235"></a>		       	  <span class='hs-comment'>-- Source code never has shtes</span>
<a name="line-236"></a>  <span class='hs-keyword'>where</span>
<a name="line-237"></a>    <span class='hs-varid'>can_unbox</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsBang</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsBang</span>
<a name="line-238"></a>    <span class='hs-comment'>-- Returns   HsUnpack  if we can unpack arg_ty</span>
<a name="line-239"></a>    <span class='hs-comment'>-- 		 fail_bang if we know what arg_ty is but we can't unpack it</span>
<a name="line-240"></a>    <span class='hs-comment'>-- 		 HsStrict  if it's abstract, so we don't know whether or not we can unbox it</span>
<a name="line-241"></a>    <span class='hs-varid'>can_unbox</span> <span class='hs-varid'>fail_bang</span> <span class='hs-varid'>arg_ty</span> 
<a name="line-242"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>arg_ty</span> <span class='hs-keyword'>of</span>
<a name="line-243"></a>	    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fail_bang</span>
<a name="line-244"></a>
<a name="line-245"></a>	    <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_tycon</span><span class='hs-layout'>,</span> <span class='hs-varid'>tycon_args</span><span class='hs-layout'>)</span> 
<a name="line-246"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isAbstractTyCon</span> <span class='hs-varid'>arg_tycon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsStrict</span>	
<a name="line-247"></a>                      <span class='hs-comment'>-- See Note [Don't complain about UNPACK on abstract TyCons]</span>
<a name="line-248"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isRecursiveTyCon</span> <span class='hs-varid'>arg_tycon</span><span class='hs-layout'>)</span> 	<span class='hs-comment'>-- Note [Recusive unboxing]</span>
<a name="line-249"></a>	      <span class='hs-layout'>,</span> <span class='hs-varid'>isProductTyCon</span> <span class='hs-varid'>arg_tycon</span> 
<a name="line-250"></a>	      	    <span class='hs-comment'>-- We can unbox if the type is a chain of newtypes </span>
<a name="line-251"></a>		    <span class='hs-comment'>-- with a product tycon at the end</span>
<a name="line-252"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isNewTyCon</span> <span class='hs-varid'>arg_tycon</span> 
<a name="line-253"></a>                 <span class='hs-keyword'>then</span> <span class='hs-varid'>can_unbox</span> <span class='hs-varid'>fail_bang</span> <span class='hs-layout'>(</span><span class='hs-varid'>newTyConInstRhs</span> <span class='hs-varid'>arg_tycon</span> <span class='hs-varid'>tycon_args</span><span class='hs-layout'>)</span>
<a name="line-254"></a>                 <span class='hs-keyword'>else</span> <span class='hs-conid'>HsUnpack</span>
<a name="line-255"></a>
<a name="line-256"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fail_bang</span>
</pre>\end{code}

Note [Don't complain about UNPACK on abstract TyCons]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We are going to complain about UnpackFailed, but if we say
   data T = MkT {-# UNPACK #-} !Wobble
and Wobble is a newtype imported from a module that was compiled 
without optimisation, we don't want to complain. Because it might
be fine when optimsation is on.  I think this happens when Haddock
is working over (say) GHC souce files.

Note [Recursive unboxing]
~~~~~~~~~~~~~~~~~~~~~~~~~
Be careful not to try to unbox this!
	data T = MkT {-# UNPACK #-} !T Int
Reason: consider
  data R = MkR {-# UNPACK #-} !S Int
  data S = MkS {-# UNPACK #-} !Int
The representation arguments of MkR are the *representation* arguments
of S (plus Int); the rep args of MkS are Int#.  This is obviously no
good for T, because then we'd get an infinite number of arguments.

But it's the *argument* type that matters. This is fine:
	data S = MkS S !Int
because Int is non-recursive.


%************************************************************************
%*									*
		Validity checking
%*									*
%************************************************************************

Validity checking is done once the mutually-recursive knot has been
tied, so we can look at things freely.

\begin{code}
<pre><a name="line-1"></a><a name="checkClassCycleErrs"></a><span class='hs-definition'>checkClassCycleErrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-2"></a><span class='hs-definition'>checkClassCycleErrs</span> <span class='hs-varid'>cls</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>cls_cycles</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>recClsErr</span> <span class='hs-varid'>cls_cycles</span>
<a name="line-4"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>cls_cycles</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>calcClassCycles</span> <span class='hs-varid'>cls</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="checkValidTyCl"></a><span class='hs-definition'>checkValidTyCl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyClDecl</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-7"></a><span class='hs-comment'>-- We do the validity check over declarations, rather than TyThings</span>
<a name="line-8"></a><span class='hs-comment'>-- only so that we can add a nice context with tcAddDeclCtxt</span>
<a name="line-9"></a><span class='hs-definition'>checkValidTyCl</span> <span class='hs-varid'>decl</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcAddDeclCtxt</span> <span class='hs-varid'>decl</span> <span class='hs-varop'>$</span>
<a name="line-11"></a>    <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Validity of 1"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span>
<a name="line-12"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-13"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Validity of 1a"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_type_env</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-14"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupLocatedGlobal</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcdLName</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span>
<a name="line-15"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Validity of 2"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span>
<a name="line-16"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Validity of"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-17"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>thing</span> <span class='hs-keyword'>of</span>
<a name="line-18"></a>	    <span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-19"></a>                <span class='hs-varid'>traceTc</span> <span class='hs-str'>"  of kind"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-20"></a>                <span class='hs-varid'>checkValidTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-21"></a>                <span class='hs-keyword'>case</span> <span class='hs-varid'>decl</span> <span class='hs-keyword'>of</span>
<a name="line-22"></a>                  <span class='hs-conid'>ClassDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcdATs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ats</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>addLocM</span> <span class='hs-varid'>checkValidTyCl</span><span class='hs-layout'>)</span> <span class='hs-varid'>ats</span>
<a name="line-23"></a>                  <span class='hs-keyword'>_</span>                          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-24"></a>            <span class='hs-conid'>AnId</span> <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>  <span class='hs-comment'>-- Generic default methods are checked</span>
<a name="line-25"></a>	    	      	 	    <span class='hs-comment'>-- with their parent class</span>
<a name="line-26"></a>            <span class='hs-keyword'>_</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"checkValidTyCl"</span>
<a name="line-27"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Done validity of"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>	
<a name="line-28"></a>	<span class='hs-layout'>}</span>
<a name="line-29"></a>
<a name="line-30"></a><span class='hs-comment'>-------------------------</span>
<a name="line-31"></a><span class='hs-comment'>-- For data types declared with record syntax, we require</span>
<a name="line-32"></a><span class='hs-comment'>-- that each constructor that has a field 'f' </span>
<a name="line-33"></a><span class='hs-comment'>--	(a) has the same result type</span>
<a name="line-34"></a><span class='hs-comment'>--	(b) has the same type for 'f'</span>
<a name="line-35"></a><span class='hs-comment'>-- module alpha conversion of the quantified type variables</span>
<a name="line-36"></a><span class='hs-comment'>-- of the constructor.</span>
<a name="line-37"></a><span class='hs-comment'>--</span>
<a name="line-38"></a><span class='hs-comment'>-- Note that we allow existentials to match becuase the</span>
<a name="line-39"></a><span class='hs-comment'>-- fields can never meet. E.g</span>
<a name="line-40"></a><span class='hs-comment'>--	data T where</span>
<a name="line-41"></a><span class='hs-comment'>--	  T1 { f1 :: b, f2 :: a, f3 ::Int } :: T</span>
<a name="line-42"></a><span class='hs-comment'>--	  T2 { f1 :: c, f2 :: c, f3 ::Int } :: T  </span>
<a name="line-43"></a><span class='hs-comment'>-- Here we do not complain about f1,f2 because they are existential</span>
<a name="line-44"></a>
<a name="line-45"></a><a name="checkValidTyCon"></a><span class='hs-definition'>checkValidTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-46"></a><span class='hs-definition'>checkValidTyCon</span> <span class='hs-varid'>tc</span> 
<a name="line-47"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConClass_maybe</span> <span class='hs-varid'>tc</span>
<a name="line-48"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkValidClass</span> <span class='hs-varid'>cl</span>
<a name="line-49"></a>
<a name="line-50"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isSynTyCon</span> <span class='hs-varid'>tc</span> 
<a name="line-51"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>synTyConRhs</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>of</span>
<a name="line-52"></a>      <span class='hs-conid'>SynFamilyTyCon</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-53"></a>      <span class='hs-conid'>SynonymTyCon</span> <span class='hs-varid'>ty</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>checkValidType</span> <span class='hs-varid'>syn_ctxt</span> <span class='hs-varid'>ty</span>
<a name="line-54"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-55"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- Check the context on the data decl</span>
<a name="line-56"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"cvtc1"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-57"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkValidTheta</span> <span class='hs-layout'>(</span><span class='hs-conid'>DataTyCtxt</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConStupidTheta</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-58"></a>	
<a name="line-59"></a>	<span class='hs-comment'>-- Check arg types of data constructors</span>
<a name="line-60"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"cvtc2"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-61"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>checkValidDataCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>data_cons</span>
<a name="line-62"></a>
<a name="line-63"></a>	<span class='hs-comment'>-- Check that fields with the same name share a type</span>
<a name="line-64"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>check_fields</span> <span class='hs-varid'>groups</span> <span class='hs-layout'>}</span>
<a name="line-65"></a>
<a name="line-66"></a>  <span class='hs-keyword'>where</span>
<a name="line-67"></a>    <span class='hs-varid'>syn_ctxt</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TySynCtxt</span> <span class='hs-varid'>name</span>
<a name="line-68"></a>    <span class='hs-varid'>name</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConName</span> <span class='hs-varid'>tc</span>
<a name="line-69"></a>    <span class='hs-varid'>data_cons</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConDataCons</span> <span class='hs-varid'>tc</span>
<a name="line-70"></a>
<a name="line-71"></a>    <span class='hs-varid'>groups</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>equivClasses</span> <span class='hs-varid'>cmp_fld</span> <span class='hs-layout'>(</span><span class='hs-varid'>concatMap</span> <span class='hs-varid'>get_fields</span> <span class='hs-varid'>data_cons</span><span class='hs-layout'>)</span>
<a name="line-72"></a>    <span class='hs-varid'>cmp_fld</span> <span class='hs-layout'>(</span><span class='hs-varid'>f1</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>f2</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f1</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>f2</span>
<a name="line-73"></a>    <span class='hs-varid'>get_fields</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConFieldLabels</span> <span class='hs-varid'>con</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>repeat</span> <span class='hs-varid'>con</span>
<a name="line-74"></a>	<span class='hs-comment'>-- dataConFieldLabels may return the empty list, which is fine</span>
<a name="line-75"></a>
<a name="line-76"></a>    <span class='hs-comment'>-- See Note [GADT record selectors] in MkId.lhs</span>
<a name="line-77"></a>    <span class='hs-comment'>-- We must check (a) that the named field has the same </span>
<a name="line-78"></a>    <span class='hs-comment'>--                   type in each constructor</span>
<a name="line-79"></a>    <span class='hs-comment'>--               (b) that those constructors have the same result type</span>
<a name="line-80"></a>    <span class='hs-comment'>--</span>
<a name="line-81"></a>    <span class='hs-comment'>-- However, the constructors may have differently named type variable</span>
<a name="line-82"></a>    <span class='hs-comment'>-- and (worse) we don't know how the correspond to each other.  E.g.</span>
<a name="line-83"></a>    <span class='hs-comment'>--     C1 :: forall a b. { f :: a, g :: b } -&gt; T a b</span>
<a name="line-84"></a>    <span class='hs-comment'>--     C2 :: forall d c. { f :: c, g :: c } -&gt; T c d</span>
<a name="line-85"></a>    <span class='hs-comment'>-- </span>
<a name="line-86"></a>    <span class='hs-comment'>-- So what we do is to ust Unify.tcMatchTys to compare the first candidate's</span>
<a name="line-87"></a>    <span class='hs-comment'>-- result type against other candidates' types BOTH WAYS ROUND.</span>
<a name="line-88"></a>    <span class='hs-comment'>-- If they magically agrees, take the substitution and</span>
<a name="line-89"></a>    <span class='hs-comment'>-- apply them to the latter ones, and see if they match perfectly.</span>
<a name="line-90"></a>    <span class='hs-varid'>check_fields</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>label</span><span class='hs-layout'>,</span> <span class='hs-varid'>con1</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>other_fields</span><span class='hs-layout'>)</span>
<a name="line-91"></a>	<span class='hs-comment'>-- These fields all have the same name, but are from</span>
<a name="line-92"></a>	<span class='hs-comment'>-- different constructors in the data type</span>
<a name="line-93"></a>	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>recoverM</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>checkOne</span> <span class='hs-varid'>other_fields</span>
<a name="line-94"></a>                <span class='hs-comment'>-- Check that all the fields in the group have the same type</span>
<a name="line-95"></a>		<span class='hs-comment'>-- NB: this check assumes that all the constructors of a given</span>
<a name="line-96"></a>		<span class='hs-comment'>-- data type use the same type variables</span>
<a name="line-97"></a>        <span class='hs-keyword'>where</span>
<a name="line-98"></a>	<span class='hs-layout'>(</span><span class='hs-varid'>tvs1</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>res1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConSig</span> <span class='hs-varid'>con1</span>
<a name="line-99"></a>        <span class='hs-varid'>ts1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>tvs1</span>
<a name="line-100"></a>        <span class='hs-varid'>fty1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConFieldType</span> <span class='hs-varid'>con1</span> <span class='hs-varid'>label</span>
<a name="line-101"></a>
<a name="line-102"></a>        <span class='hs-varid'>checkOne</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>con2</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- Do it bothways to ensure they are structurally identical</span>
<a name="line-103"></a>	    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkFieldCompat</span> <span class='hs-varid'>label</span> <span class='hs-varid'>con1</span> <span class='hs-varid'>con2</span> <span class='hs-varid'>ts1</span> <span class='hs-varid'>res1</span> <span class='hs-varid'>res2</span> <span class='hs-varid'>fty1</span> <span class='hs-varid'>fty2</span>
<a name="line-104"></a>		 <span class='hs-layout'>;</span> <span class='hs-varid'>checkFieldCompat</span> <span class='hs-varid'>label</span> <span class='hs-varid'>con2</span> <span class='hs-varid'>con1</span> <span class='hs-varid'>ts2</span> <span class='hs-varid'>res2</span> <span class='hs-varid'>res1</span> <span class='hs-varid'>fty2</span> <span class='hs-varid'>fty1</span> <span class='hs-layout'>}</span>
<a name="line-105"></a>	    <span class='hs-keyword'>where</span>        
<a name="line-106"></a>		<span class='hs-layout'>(</span><span class='hs-varid'>tvs2</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>res2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConSig</span> <span class='hs-varid'>con2</span>
<a name="line-107"></a>	   	<span class='hs-varid'>ts2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>tvs2</span>
<a name="line-108"></a>                <span class='hs-varid'>fty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConFieldType</span> <span class='hs-varid'>con2</span> <span class='hs-varid'>label</span>
<a name="line-109"></a>    <span class='hs-varid'>check_fields</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"checkValidTyCon/check_fields []"</span>
<a name="line-110"></a>
<a name="line-111"></a><a name="checkFieldCompat"></a><span class='hs-definition'>checkFieldCompat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVarSet</span>
<a name="line-112"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-113"></a><span class='hs-definition'>checkFieldCompat</span> <span class='hs-varid'>fld</span> <span class='hs-varid'>con1</span> <span class='hs-varid'>con2</span> <span class='hs-varid'>tvs1</span> <span class='hs-varid'>res1</span> <span class='hs-varid'>res2</span> <span class='hs-varid'>fty1</span> <span class='hs-varid'>fty2</span>
<a name="line-114"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>isJust</span> <span class='hs-varid'>mb_subst1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>resultTypeMisMatch</span> <span class='hs-varid'>fld</span> <span class='hs-varid'>con1</span> <span class='hs-varid'>con2</span><span class='hs-layout'>)</span>
<a name="line-115"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>isJust</span> <span class='hs-varid'>mb_subst2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>fieldTypeMisMatch</span> <span class='hs-varid'>fld</span> <span class='hs-varid'>con1</span> <span class='hs-varid'>con2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-116"></a>  <span class='hs-keyword'>where</span>
<a name="line-117"></a>    <span class='hs-varid'>mb_subst1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcMatchTy</span> <span class='hs-varid'>tvs1</span> <span class='hs-varid'>res1</span> <span class='hs-varid'>res2</span>
<a name="line-118"></a>    <span class='hs-varid'>mb_subst2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcMatchTyX</span> <span class='hs-varid'>tvs1</span> <span class='hs-layout'>(</span><span class='hs-varid'>expectJust</span> <span class='hs-str'>"checkFieldCompat"</span> <span class='hs-varid'>mb_subst1</span><span class='hs-layout'>)</span> <span class='hs-varid'>fty1</span> <span class='hs-varid'>fty2</span>
<a name="line-119"></a>
<a name="line-120"></a><a name="checkValidDataCon"></a><span class='hs-comment'>-------------------------------</span>
<a name="line-121"></a><span class='hs-definition'>checkValidDataCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-122"></a><span class='hs-definition'>checkValidDataCon</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>con</span>
<a name="line-123"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-layout'>(</span><span class='hs-varid'>srcLocSpan</span> <span class='hs-layout'>(</span><span class='hs-varid'>getSrcLoc</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>	<span class='hs-varop'>$</span>
<a name="line-124"></a>    <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConCtxt</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span>		<span class='hs-varop'>$</span> 
<a name="line-125"></a>    <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Validity of data con"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span>
<a name="line-126"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tc_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConTyVars</span> <span class='hs-varid'>tc</span>
<a name="line-127"></a>	      <span class='hs-varid'>res_ty_tmpl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFamilyTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>tc_tvs</span><span class='hs-layout'>)</span>
<a name="line-128"></a>	      <span class='hs-varid'>actual_res_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConOrigResTy</span> <span class='hs-varid'>con</span>
<a name="line-129"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>isJust</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcMatchTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>tc_tvs</span><span class='hs-layout'>)</span>
<a name="line-130"></a>				<span class='hs-varid'>res_ty_tmpl</span>
<a name="line-131"></a>				<span class='hs-varid'>actual_res_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-132"></a>		  <span class='hs-layout'>(</span><span class='hs-varid'>badDataConTyCon</span> <span class='hs-varid'>con</span> <span class='hs-varid'>res_ty_tmpl</span> <span class='hs-varid'>actual_res_ty</span><span class='hs-layout'>)</span>
<a name="line-133"></a>             <span class='hs-comment'>-- IA0_TODO: we should also check that kind variables</span>
<a name="line-134"></a>             <span class='hs-comment'>-- are only instantiated with kind variables</span>
<a name="line-135"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>checkValidMonoType</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConOrigResTy</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span>
<a name="line-136"></a>		<span class='hs-comment'>-- Disallow MkT :: T (forall a. a-&gt;a)</span>
<a name="line-137"></a>		<span class='hs-comment'>-- Reason: it's really the argument of an equality constraint</span>
<a name="line-138"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>checkValidType</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConUserType</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span>
<a name="line-139"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>isNewTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>checkNewDataCon</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span>
<a name="line-140"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>check_bang</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConStrictMarks</span> <span class='hs-varid'>con</span> <span class='hs-varop'>`zip`</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span><span class='hs-keyglyph'>..</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-141"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"Done validity of data con"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>con</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConRepType</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-142"></a>    <span class='hs-layout'>}</span>
<a name="line-143"></a>  <span class='hs-keyword'>where</span>
<a name="line-144"></a>    <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ConArgCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConName</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> 
<a name="line-145"></a>    <span class='hs-varid'>check_bang</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsUnpackFailed</span><span class='hs-layout'>,</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addWarnTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>cant_unbox_msg</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-146"></a>    <span class='hs-varid'>check_bang</span> <span class='hs-keyword'>_</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-147"></a>
<a name="line-148"></a>    <span class='hs-varid'>cant_unbox_msg</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Ignoring unusable UNPACK pragma on the"</span><span class='hs-layout'>)</span>
<a name="line-149"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>speakNth</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"argument of"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-150"></a>
<a name="line-151"></a><a name="checkNewDataCon"></a><span class='hs-comment'>-------------------------------</span>
<a name="line-152"></a><span class='hs-definition'>checkNewDataCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-153"></a><span class='hs-comment'>-- Checks for the data constructor of a newtype</span>
<a name="line-154"></a><span class='hs-definition'>checkNewDataCon</span> <span class='hs-varid'>con</span>
<a name="line-155"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>isSingleton</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>newtypeFieldErr</span> <span class='hs-varid'>con</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-156"></a>		<span class='hs-comment'>-- One argument</span>
<a name="line-157"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>eq_spec</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>newtypePredError</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span>
<a name="line-158"></a>		<span class='hs-comment'>-- Return type is (T a b c)</span>
<a name="line-159"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>ex_tvs</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>theta</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>newtypeExError</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span>
<a name="line-160"></a>		<span class='hs-comment'>-- No existentials</span>
<a name="line-161"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>any</span> <span class='hs-varid'>isBanged</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConStrictMarks</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-162"></a>		  <span class='hs-layout'>(</span><span class='hs-varid'>newtypeStrictError</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span>
<a name="line-163"></a>		<span class='hs-comment'>-- No strictness</span>
<a name="line-164"></a>    <span class='hs-layout'>}</span>
<a name="line-165"></a>  <span class='hs-keyword'>where</span>
<a name="line-166"></a>    <span class='hs-layout'>(</span><span class='hs-sel'>_univ_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ex_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>eq_spec</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-sel'>_res_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConFullSig</span> <span class='hs-varid'>con</span>
<a name="line-167"></a>
<a name="line-168"></a><a name="checkValidClass"></a><span class='hs-comment'>-------------------------------</span>
<a name="line-169"></a><span class='hs-definition'>checkValidClass</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-170"></a><span class='hs-definition'>checkValidClass</span> <span class='hs-varid'>cls</span>
<a name="line-171"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>constrained_class_methods</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_ConstrainedClassMethods</span>
<a name="line-172"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>multi_param_type_classes</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_MultiParamTypeClasses</span>
<a name="line-173"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>fundep_classes</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_FunctionalDependencies</span>
<a name="line-174"></a>
<a name="line-175"></a>    	<span class='hs-comment'>-- Check that the class is unary, unless GlaExs</span>
<a name="line-176"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>notNull</span> <span class='hs-varid'>tyvars</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>nullaryClassErr</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span>
<a name="line-177"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>multi_param_type_classes</span> <span class='hs-varop'>||</span> <span class='hs-varid'>unary</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>classArityErr</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span>
<a name="line-178"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>fundep_classes</span> <span class='hs-varop'>||</span> <span class='hs-varid'>null</span> <span class='hs-varid'>fundeps</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>classFunDepsErr</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span>
<a name="line-179"></a>
<a name="line-180"></a>   	<span class='hs-comment'>-- Check the super-classes</span>
<a name="line-181"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>checkValidTheta</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClassSCCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>className</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>theta</span>
<a name="line-182"></a>
<a name="line-183"></a>          <span class='hs-comment'>-- Now check for cyclic superclasses</span>
<a name="line-184"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkClassCycleErrs</span> <span class='hs-varid'>cls</span>
<a name="line-185"></a>
<a name="line-186"></a>	<span class='hs-comment'>-- Check the class operations</span>
<a name="line-187"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>check_op</span> <span class='hs-varid'>constrained_class_methods</span><span class='hs-layout'>)</span> <span class='hs-varid'>op_stuff</span>
<a name="line-188"></a>
<a name="line-189"></a>        <span class='hs-comment'>-- Check the associated type defaults are well-formed and instantiated</span>
<a name="line-190"></a>        <span class='hs-comment'>-- See Note [Checking consistent instantiation]</span>
<a name="line-191"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>check_at_defs</span> <span class='hs-varid'>at_stuff</span>	<span class='hs-layout'>}</span>
<a name="line-192"></a>  <span class='hs-keyword'>where</span>
<a name="line-193"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tyvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>fundeps</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>at_stuff</span><span class='hs-layout'>,</span> <span class='hs-varid'>op_stuff</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>classExtraBigSig</span> <span class='hs-varid'>cls</span>
<a name="line-194"></a>    <span class='hs-varid'>unary</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isSingleton</span> <span class='hs-layout'>(</span><span class='hs-varid'>snd</span> <span class='hs-layout'>(</span><span class='hs-varid'>splitKiTyVars</span> <span class='hs-varid'>tyvars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- IA0_NOTE: only count type arguments</span>
<a name="line-195"></a>
<a name="line-196"></a>    <span class='hs-varid'>check_op</span> <span class='hs-varid'>constrained_class_methods</span> <span class='hs-layout'>(</span><span class='hs-varid'>sel_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>dm</span><span class='hs-layout'>)</span> 
<a name="line-197"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>classOpCtxt</span> <span class='hs-varid'>sel_id</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-198"></a>	<span class='hs-layout'>{</span> <span class='hs-varid'>checkValidTheta</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>tail</span> <span class='hs-varid'>theta</span><span class='hs-layout'>)</span>
<a name="line-199"></a>		<span class='hs-comment'>-- The 'tail' removes the initial (C a) from the</span>
<a name="line-200"></a>		<span class='hs-comment'>-- class itself, leaving just the method type</span>
<a name="line-201"></a>
<a name="line-202"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"class op type"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>op_ty</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span>
<a name="line-203"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>checkValidType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>tau</span>
<a name="line-204"></a>
<a name="line-205"></a>		<span class='hs-comment'>-- Check that the type mentions at least one of</span>
<a name="line-206"></a>		<span class='hs-comment'>-- the class type variables...or at least one reachable</span>
<a name="line-207"></a>		<span class='hs-comment'>-- from one of the class variables.  Example: tc223</span>
<a name="line-208"></a>		<span class='hs-comment'>--   class Error e =&gt; Game b mv e | b -&gt; mv e where</span>
<a name="line-209"></a>		<span class='hs-comment'>--      newBoard :: MonadState b m =&gt; m ()</span>
<a name="line-210"></a>		<span class='hs-comment'>-- Here, MonadState has a fundep m-&gt;b, so newBoard is fine</span>
<a name="line-211"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>grown_tyvars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>growThetaTyVars</span> <span class='hs-varid'>theta</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>tyvars</span><span class='hs-layout'>)</span>
<a name="line-212"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>tau</span> <span class='hs-varop'>`intersectsVarSet`</span> <span class='hs-varid'>grown_tyvars</span><span class='hs-layout'>)</span>
<a name="line-213"></a>	          <span class='hs-layout'>(</span><span class='hs-varid'>noClassTyVarErr</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>sel_id</span><span class='hs-layout'>)</span>
<a name="line-214"></a>
<a name="line-215"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>dm</span> <span class='hs-keyword'>of</span>
<a name="line-216"></a>            <span class='hs-conid'>GenDefMeth</span> <span class='hs-varid'>dm_name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dm_id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupId</span> <span class='hs-varid'>dm_name</span>
<a name="line-217"></a>                                     <span class='hs-layout'>;</span> <span class='hs-varid'>checkValidType</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunSigCtxt</span> <span class='hs-varid'>op_name</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>dm_id</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-218"></a>            <span class='hs-keyword'>_</span>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-219"></a>	<span class='hs-layout'>}</span>
<a name="line-220"></a>	<span class='hs-keyword'>where</span>
<a name="line-221"></a>          <span class='hs-varid'>ctxt</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FunSigCtxt</span> <span class='hs-varid'>op_name</span>
<a name="line-222"></a>	  <span class='hs-varid'>op_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idName</span> <span class='hs-varid'>sel_id</span>
<a name="line-223"></a>	  <span class='hs-varid'>op_ty</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idType</span> <span class='hs-varid'>sel_id</span>
<a name="line-224"></a>	  <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>theta1</span><span class='hs-layout'>,</span><span class='hs-varid'>tau1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitSigmaTy</span> <span class='hs-varid'>op_ty</span>
<a name="line-225"></a>	  <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>theta2</span><span class='hs-layout'>,</span><span class='hs-varid'>tau2</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitSigmaTy</span> <span class='hs-varid'>tau1</span>
<a name="line-226"></a>	  <span class='hs-layout'>(</span><span class='hs-varid'>theta</span><span class='hs-layout'>,</span><span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>constrained_class_methods</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>theta1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>theta2</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau2</span><span class='hs-layout'>)</span>
<a name="line-227"></a>		      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>theta1</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkPhiTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>tail</span> <span class='hs-varid'>theta1</span><span class='hs-layout'>)</span> <span class='hs-varid'>tau1</span><span class='hs-layout'>)</span>
<a name="line-228"></a>		<span class='hs-comment'>-- Ugh!  The function might have a type like</span>
<a name="line-229"></a>		<span class='hs-comment'>-- 	op :: forall a. C a =&gt; forall b. (Eq b, Eq a) =&gt; tau2</span>
<a name="line-230"></a>		<span class='hs-comment'>-- With -XConstrainedClassMethods, we want to allow this, even though the inner </span>
<a name="line-231"></a>		<span class='hs-comment'>-- forall has an (Eq a) constraint.  Whereas in general, each constraint </span>
<a name="line-232"></a>		<span class='hs-comment'>-- in the context of a for-all must mention at least one quantified</span>
<a name="line-233"></a>		<span class='hs-comment'>-- type variable.  What a mess!</span>
<a name="line-234"></a>
<a name="line-235"></a>    <span class='hs-varid'>check_at_defs</span> <span class='hs-layout'>(</span><span class='hs-varid'>fam_tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>defs</span><span class='hs-layout'>)</span>
<a name="line-236"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-conid'>ATD</span> <span class='hs-sel'>_tvs</span> <span class='hs-varid'>pats</span> <span class='hs-varid'>rhs</span> <span class='hs-sel'>_loc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>checkValidFamInst</span> <span class='hs-varid'>pats</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-varid'>defs</span>
<a name="line-237"></a>           <span class='hs-varid'>tcAddDefaultAssocDeclCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConName</span> <span class='hs-varid'>fam_tc</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> 
<a name="line-238"></a>             <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>check_loc_at_def</span> <span class='hs-varid'>fam_tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>defs</span>
<a name="line-239"></a>
<a name="line-240"></a>    <span class='hs-varid'>check_loc_at_def</span> <span class='hs-varid'>fam_tc</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATD</span> <span class='hs-sel'>_tvs</span> <span class='hs-varid'>pats</span> <span class='hs-sel'>_rhs</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-241"></a>      <span class='hs-comment'>-- Set the location for each of the default declarations</span>
<a name="line-242"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>zipWithM_</span> <span class='hs-varid'>check_arg</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConTyVars</span> <span class='hs-varid'>fam_tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>pats</span>
<a name="line-243"></a>
<a name="line-244"></a>    <span class='hs-comment'>-- We only want to check this on the *class* TyVars,</span>
<a name="line-245"></a>    <span class='hs-comment'>-- not the *family* TyVars (there may be more of these)</span>
<a name="line-246"></a>    <span class='hs-varid'>check_arg</span> <span class='hs-varid'>fam_tc_tv</span> <span class='hs-varid'>at_ty</span>
<a name="line-247"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span>   <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>fam_tc_tv</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>tyvars</span><span class='hs-layout'>)</span>
<a name="line-248"></a>                 <span class='hs-varop'>||</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>fam_tc_tv</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>at_ty</span><span class='hs-layout'>)</span> 
<a name="line-249"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>wrongATArgErr</span> <span class='hs-varid'>at_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>fam_tc_tv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-250"></a>
<a name="line-251"></a><a name="checkFamFlag"></a><span class='hs-definition'>checkFamFlag</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-252"></a><span class='hs-comment'>-- Check that we don't use families without -XTypeFamilies</span>
<a name="line-253"></a><span class='hs-comment'>-- The parser won't even parse them, but I suppose a GHC API</span>
<a name="line-254"></a><span class='hs-comment'>-- client might have a go!</span>
<a name="line-255"></a><span class='hs-definition'>checkFamFlag</span> <span class='hs-varid'>tc_name</span>
<a name="line-256"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>idx_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_TypeFamilies</span>
<a name="line-257"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-varid'>idx_tys</span> <span class='hs-varid'>err_msg</span> <span class='hs-layout'>}</span>
<a name="line-258"></a>  <span class='hs-keyword'>where</span>
<a name="line-259"></a>    <span class='hs-varid'>err_msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal family declaraion for"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc_name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-260"></a>	         <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Use -XTypeFamilies to allow indexed type families"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*									*
		Building record selectors
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="mkDefaultMethodIds"></a><span class='hs-definition'>mkDefaultMethodIds</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyThing</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>
<a name="line-2"></a><span class='hs-comment'>-- See Note [Default method Ids and Template Haskell]</span>
<a name="line-3"></a><span class='hs-definition'>mkDefaultMethodIds</span> <span class='hs-varid'>things</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>mkExportedLocalId</span> <span class='hs-varid'>dm_name</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>sel_id</span><span class='hs-layout'>)</span>
<a name="line-5"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>things</span>
<a name="line-6"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tyConClass_maybe</span> <span class='hs-varid'>tc</span><span class='hs-keyglyph'>]</span>
<a name="line-7"></a>    <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>sel_id</span><span class='hs-layout'>,</span> <span class='hs-conid'>DefMeth</span> <span class='hs-varid'>dm_name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>classOpItems</span> <span class='hs-varid'>cls</span> <span class='hs-keyglyph'>]</span>
</pre>\end{code}

Note [Default method Ids and Template Haskell]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this (Trac #4169):
   class Numeric a where
     fromIntegerNum :: a
     fromIntegerNum = ...

   ast :: Q [Dec]
   ast = [d| instance Numeric Int |]

When we typecheck 'ast' we have done the first pass over the class decl
(in tcTyClDecls), but we have not yet typechecked the default-method
declarations (becuase they can mention value declarations).  So we 
must bring the default method Ids into scope first (so they can be seen
when typechecking the [d| .. |] quote, and typecheck them later.

\begin{code}
<pre><a name="line-1"></a><a name="mkRecSelBinds"></a><span class='hs-definition'>mkRecSelBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyThing</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsValBinds</span> <span class='hs-conid'>Name</span>
<a name="line-2"></a><span class='hs-comment'>-- NB We produce *un-typechecked* bindings, rather like 'deriving'</span>
<a name="line-3"></a><span class='hs-comment'>--    This makes life easier, because the later type checking will add</span>
<a name="line-4"></a><span class='hs-comment'>--    all necessary type abstractions and applications</span>
<a name="line-5"></a><span class='hs-definition'>mkRecSelBinds</span> <span class='hs-varid'>tycons</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ValBindsOut</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>NonRecursive</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>binds</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>sigs</span>
<a name="line-7"></a>  <span class='hs-keyword'>where</span>
<a name="line-8"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>sigs</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip</span> <span class='hs-varid'>rec_sels</span>
<a name="line-9"></a>    <span class='hs-varid'>rec_sels</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>mkRecSelBind</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span><span class='hs-varid'>fld</span><span class='hs-layout'>)</span> 
<a name="line-10"></a>       	 	     	        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tycons</span>
<a name="line-11"></a>				<span class='hs-layout'>,</span> <span class='hs-varid'>fld</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConFields</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>]</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="mkRecSelBind"></a><span class='hs-definition'>mkRecSelBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyCon</span><span class='hs-layout'>,</span> <span class='hs-conid'>FieldLabel</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>LSig</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-14"></a><span class='hs-definition'>mkRecSelBind</span> <span class='hs-layout'>(</span><span class='hs-varid'>tycon</span><span class='hs-layout'>,</span> <span class='hs-varid'>sel_name</span><span class='hs-layout'>)</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>sel_loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>IdSig</span> <span class='hs-varid'>sel_id</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>unitBag</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>sel_loc</span> <span class='hs-varid'>sel_bind</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-16"></a>  <span class='hs-keyword'>where</span>
<a name="line-17"></a>    <span class='hs-varid'>sel_loc</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getSrcSpan</span> <span class='hs-varid'>tycon</span>
<a name="line-18"></a>    <span class='hs-varid'>sel_id</span> 	<span class='hs-keyglyph'>=</span> <span class='hs-conid'>Var</span><span class='hs-varop'>.</span><span class='hs-varid'>mkExportedLocalVar</span> <span class='hs-varid'>rec_details</span> <span class='hs-varid'>sel_name</span> 
<a name="line-19"></a>                                         <span class='hs-varid'>sel_ty</span> <span class='hs-varid'>vanillaIdInfo</span>
<a name="line-20"></a>    <span class='hs-varid'>rec_details</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RecSelId</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sel_tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>,</span> <span class='hs-varid'>sel_naughty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_naughty</span> <span class='hs-layout'>}</span>
<a name="line-21"></a>
<a name="line-22"></a>    <span class='hs-comment'>-- Find a representative constructor, con1</span>
<a name="line-23"></a>    <span class='hs-varid'>all_cons</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConDataCons</span> <span class='hs-varid'>tycon</span> 
<a name="line-24"></a>    <span class='hs-varid'>cons_w_field</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>all_cons</span>
<a name="line-25"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>sel_name</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>dataConFieldLabels</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>]</span> 
<a name="line-26"></a>    <span class='hs-varid'>con1</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>cons_w_field</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span> <span class='hs-varid'>head</span> <span class='hs-varid'>cons_w_field</span>
<a name="line-27"></a>
<a name="line-28"></a>    <span class='hs-comment'>-- Selector type; Note [Polymorphic selectors]</span>
<a name="line-29"></a>    <span class='hs-varid'>field_ty</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConFieldType</span> <span class='hs-varid'>con1</span> <span class='hs-varid'>sel_name</span>
<a name="line-30"></a>    <span class='hs-varid'>data_ty</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConOrigResTy</span> <span class='hs-varid'>con1</span>
<a name="line-31"></a>    <span class='hs-varid'>data_tvs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>data_ty</span>
<a name="line-32"></a>    <span class='hs-varid'>is_naughty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>field_ty</span> <span class='hs-varop'>`subVarSet`</span> <span class='hs-varid'>data_tvs</span><span class='hs-layout'>)</span>  
<a name="line-33"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>field_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>field_theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>field_tau</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitSigmaTy</span> <span class='hs-varid'>field_ty</span>
<a name="line-34"></a>    <span class='hs-varid'>sel_ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_naughty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitTy</span>  <span class='hs-comment'>-- See Note [Naughty record selectors]</span>
<a name="line-35"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkForAllTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>varSetElemsKvsFirst</span> <span class='hs-varop'>$</span>
<a name="line-36"></a>                                       <span class='hs-varid'>data_tvs</span> <span class='hs-varop'>`extendVarSetList`</span> <span class='hs-varid'>field_tvs</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-37"></a>    	     	          <span class='hs-varid'>mkPhiTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConStupidTheta</span> <span class='hs-varid'>con1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>	<span class='hs-comment'>-- Urgh!</span>
<a name="line-38"></a>    	     	          <span class='hs-varid'>mkPhiTy</span> <span class='hs-varid'>field_theta</span>               <span class='hs-varop'>$</span>	<span class='hs-comment'>-- Urgh!</span>
<a name="line-39"></a>             	          <span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>data_ty</span> <span class='hs-varid'>field_tau</span>
<a name="line-40"></a>
<a name="line-41"></a>    <span class='hs-comment'>-- Make the binding: sel (C2 { fld = x }) = x</span>
<a name="line-42"></a>    <span class='hs-comment'>--                   sel (C7 { fld = x }) = x</span>
<a name="line-43"></a>    <span class='hs-comment'>--    where cons_w_field = [C2,C7]</span>
<a name="line-44"></a>    <span class='hs-varid'>sel_bind</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_naughty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTopFunBind</span> <span class='hs-varid'>sel_lname</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkSimpleMatch</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>unit_rhs</span><span class='hs-keyglyph'>]</span>
<a name="line-45"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTopFunBind</span> <span class='hs-varid'>sel_lname</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>mk_match</span> <span class='hs-varid'>cons_w_field</span> <span class='hs-varop'>++</span> <span class='hs-varid'>deflt</span><span class='hs-layout'>)</span>
<a name="line-46"></a>    <span class='hs-varid'>mk_match</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSimpleMatch</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>noLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_sel_pat</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-47"></a>                                 <span class='hs-layout'>(</span><span class='hs-varid'>noLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>field_var</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-48"></a>    <span class='hs-varid'>mk_sel_pat</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ConPatIn</span> <span class='hs-layout'>(</span><span class='hs-varid'>noLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>getName</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecCon</span> <span class='hs-varid'>rec_fields</span><span class='hs-layout'>)</span>
<a name="line-49"></a>    <span class='hs-varid'>rec_fields</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HsRecFields</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rec_flds</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>rec_field</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>rec_dotdot</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>}</span>
<a name="line-50"></a>    <span class='hs-varid'>rec_field</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HsRecField</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsRecFieldId</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sel_lname</span>
<a name="line-51"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>hsRecFieldArg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nlVarPat</span> <span class='hs-varid'>field_var</span>
<a name="line-52"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>hsRecPun</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span> <span class='hs-layout'>}</span>
<a name="line-53"></a>    <span class='hs-varid'>sel_lname</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>sel_loc</span> <span class='hs-varid'>sel_name</span>
<a name="line-54"></a>    <span class='hs-varid'>field_var</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInternalName</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkBuiltinUnique</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>sel_name</span><span class='hs-layout'>)</span> <span class='hs-varid'>sel_loc</span>
<a name="line-55"></a>
<a name="line-56"></a>    <span class='hs-comment'>-- Add catch-all default case unless the case is exhaustive</span>
<a name="line-57"></a>    <span class='hs-comment'>-- We do this explicitly so that we get a nice error message that</span>
<a name="line-58"></a>    <span class='hs-comment'>-- mentions this particular record selector</span>
<a name="line-59"></a>    <span class='hs-varid'>deflt</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>any</span> <span class='hs-varid'>is_unused</span> <span class='hs-varid'>all_cons</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-60"></a>	  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkSimpleMatch</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>nlWildPat</span><span class='hs-keyglyph'>]</span> 
<a name="line-61"></a>	    	      	    <span class='hs-layout'>(</span><span class='hs-varid'>nlHsApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>nlHsVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>getName</span> <span class='hs-varid'>rEC_SEL_ERROR_ID</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-62"></a>    	      		    	     <span class='hs-layout'>(</span><span class='hs-varid'>nlHsLit</span> <span class='hs-varid'>msg_lit</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-63"></a>
<a name="line-64"></a>	<span class='hs-comment'>-- Do not add a default case unless there are unmatched</span>
<a name="line-65"></a>	<span class='hs-comment'>-- constructors.  We must take account of GADTs, else we</span>
<a name="line-66"></a>	<span class='hs-comment'>-- get overlap warning messages from the pattern-match checker</span>
<a name="line-67"></a>    <span class='hs-varid'>is_unused</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>con</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>cons_w_field</span> 
<a name="line-68"></a>			 <span class='hs-varop'>||</span> <span class='hs-varid'>dataConCannotMatch</span> <span class='hs-varid'>inst_tys</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span>
<a name="line-69"></a>    <span class='hs-varid'>inst_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConAppArgs</span> <span class='hs-varid'>data_ty</span>
<a name="line-70"></a>
<a name="line-71"></a>    <span class='hs-varid'>unit_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLHsTupleExpr</span> <span class='hs-conid'>[]</span>
<a name="line-72"></a>    <span class='hs-varid'>msg_lit</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HsStringPrim</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkFastString</span> <span class='hs-varop'>$</span> 
<a name="line-73"></a>              <span class='hs-varid'>occNameString</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>sel_name</span><span class='hs-layout'>)</span>
<a name="line-74"></a>
<a name="line-75"></a><a name="tyConFields"></a><span class='hs-comment'>---------------</span>
<a name="line-76"></a><span class='hs-definition'>tyConFields</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FieldLabel</span><span class='hs-keyglyph'>]</span>
<a name="line-77"></a><span class='hs-definition'>tyConFields</span> <span class='hs-varid'>tc</span> 
<a name="line-78"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isAlgTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nub</span> <span class='hs-layout'>(</span><span class='hs-varid'>concatMap</span> <span class='hs-varid'>dataConFieldLabels</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConDataCons</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-79"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
</pre>\end{code}

Note [Polymorphic selectors]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When a record has a polymorphic field, we pull the foralls out to the front.
   data T = MkT { f :: forall a. [a] -> a }
Then f :: forall a. T -> [a] -> a
NOT  f :: T -> forall a. [a] -> a

This is horrid.  It's only needed in deeply obscure cases, which I hate.
The only case I know is test tc163, which is worth looking at.  It's far
from clear that this test should succeed at all!

Note [Naughty record selectors]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
A "naughty" field is one for which we can't define a record 
selector, because an existential type variable would escape.  For example:
        data T = forall a. MkT { x,y::a }
We obviously can't define       
        x (MkT v _) = v
Nevertheless we *do* put a RecSelId into the type environment
so that if the user tries to use 'x' as a selector we can bleat
helpfully, rather than saying unhelpfully that 'x' is not in scope.
Hence the sel_naughty flag, to identify record selectors that don't really exist.

In general, a field is "naughty" if its type mentions a type variable that
isn't in the result type of the constructor.  Note that this *allows*
GADT record selectors (Note [GADT record selectors]) whose types may look 
like     sel :: T [a] -> a

For naughty selectors we make a dummy binding 
   sel = ()
for naughty selectors, so that the later type-check will add them to the
environment, and they'll be exported.  The function is never called, because
the tyepchecker spots the sel_naughty field.

Note [GADT record selectors]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For GADTs, we require that all constructors with a common field 'f' have the same
result type (modulo alpha conversion).  [Checked in TcTyClsDecls.checkValidTyCon]
E.g. 
        data T where
          T1 { f :: Maybe a } :: T [a]
          T2 { f :: Maybe a, y :: b  } :: T [a]
	  T3 :: T Int

and now the selector takes that result type as its argument:
   f :: forall a. T [a] -> Maybe a

Details: the "real" types of T1,T2 are:
   T1 :: forall r a.   (r~[a]) => a -> T r
   T2 :: forall r a b. (r~[a]) => a -> b -> T r

So the selector loooks like this:
   f :: forall a. T [a] -> Maybe a
   f (a:*) (t:T [a])
     = case t of
	 T1 c   (g:[a]~[c]) (v:Maybe c)       -> v `cast` Maybe (right (sym g))
         T2 c d (g:[a]~[c]) (v:Maybe c) (w:d) -> v `cast` Maybe (right (sym g))
         T3 -> error "T3 does not have field f"

Note the forall'd tyvars of the selector are just the free tyvars
of the result type; there may be other tyvars in the constructor's
type (e.g. 'b' in T2).

Note the need for casts in the result!

Note [Selector running example]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It's OK to combine GADTs and type families.  Here's a running example:

        data instance T [a] where 
          T1 { fld :: b } :: T [Maybe b]

The representation type looks like this
        data :R7T a where
          T1 { fld :: b } :: :R7T (Maybe b)

and there's coercion from the family type to the representation type
        :CoR7T a :: T [a] ~ :R7T a

The selector we want for fld looks like this:

        fld :: forall b. T [Maybe b] -> b
        fld = /\b. \(d::T [Maybe b]).
              case d `cast` :CoR7T (Maybe b) of 
                T1 (x::b) -> x

The scrutinee of the case has type :R7T (Maybe b), which can be
gotten by appying the eq_spec to the univ_tvs of the data con.

%************************************************************************
%*									*
		Error messages
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="tcAddDefaultAssocDeclCtxt"></a><span class='hs-definition'>tcAddDefaultAssocDeclCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-2"></a><span class='hs-definition'>tcAddDefaultAssocDeclCtxt</span> <span class='hs-varid'>name</span> <span class='hs-varid'>thing_inside</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>thing_inside</span>
<a name="line-4"></a>  <span class='hs-keyword'>where</span>
<a name="line-5"></a>     <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In the type synonym instance default declaration for"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-6"></a>                  <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="resultTypeMisMatch"></a><span class='hs-definition'>resultTypeMisMatch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-9"></a><span class='hs-definition'>resultTypeMisMatch</span> <span class='hs-varid'>field_name</span> <span class='hs-varid'>con1</span> <span class='hs-varid'>con2</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Constructors"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>con1</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"and"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>con2</span><span class='hs-layout'>,</span> 
<a name="line-11"></a>		<span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"have a common field"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>field_name</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-12"></a>	  <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"but have different result types"</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="fieldTypeMisMatch"></a><span class='hs-definition'>fieldTypeMisMatch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-15"></a><span class='hs-definition'>fieldTypeMisMatch</span> <span class='hs-varid'>field_name</span> <span class='hs-varid'>con1</span> <span class='hs-varid'>con2</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Constructors"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>con1</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"and"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>con2</span><span class='hs-layout'>,</span> 
<a name="line-17"></a>	 <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"give different types for field"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>field_name</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="dataConCtxt"></a><span class='hs-definition'>dataConCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-20"></a><span class='hs-definition'>dataConCtxt</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In the definition of data constructor"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="classOpCtxt"></a><span class='hs-definition'>classOpCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-23"></a><span class='hs-definition'>classOpCtxt</span> <span class='hs-varid'>sel_id</span> <span class='hs-varid'>tau</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"When checking the class method:"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-24"></a>			      <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>sel_id</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="nullaryClassErr"></a><span class='hs-definition'>nullaryClassErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-27"></a><span class='hs-definition'>nullaryClassErr</span> <span class='hs-varid'>cls</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"No parameters for class"</span><span class='hs-layout'>)</span>  <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span>
<a name="line-29"></a>
<a name="line-30"></a><a name="classArityErr"></a><span class='hs-definition'>classArityErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-31"></a><span class='hs-definition'>classArityErr</span> <span class='hs-varid'>cls</span>
<a name="line-32"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Too many parameters for class"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-33"></a>	  <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Use -XMultiParamTypeClasses to allow multi-parameter classes"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-34"></a>
<a name="line-35"></a><a name="classFunDepsErr"></a><span class='hs-definition'>classFunDepsErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-36"></a><span class='hs-definition'>classFunDepsErr</span> <span class='hs-varid'>cls</span>
<a name="line-37"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Fundeps in class"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-38"></a>	  <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Use -XFunctionalDependencies to allow fundeps"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-39"></a>
<a name="line-40"></a><a name="noClassTyVarErr"></a><span class='hs-definition'>noClassTyVarErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-41"></a><span class='hs-definition'>noClassTyVarErr</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>op</span>
<a name="line-42"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The class method"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-43"></a>	 <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"mentions none of the type variables of the class"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> 
<a name="line-44"></a>		<span class='hs-varid'>ppr</span> <span class='hs-varid'>clas</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>hsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>classTyVars</span> <span class='hs-varid'>clas</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-45"></a>
<a name="line-46"></a><a name="recSynErr"></a><span class='hs-definition'>recSynErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LTyClDecl</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRn</span> <span class='hs-conid'>()</span>
<a name="line-47"></a><span class='hs-definition'>recSynErr</span> <span class='hs-varid'>syn_decls</span>
<a name="line-48"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>sorted_decls</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-49"></a>    <span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Cycle in type synonym declarations:"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-50"></a>		 <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr_decl</span> <span class='hs-varid'>sorted_decls</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-51"></a>  <span class='hs-keyword'>where</span>
<a name="line-52"></a>    <span class='hs-varid'>sorted_decls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortLocated</span> <span class='hs-varid'>syn_decls</span>
<a name="line-53"></a>    <span class='hs-varid'>ppr_decl</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>decl</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>decl</span>
<a name="line-54"></a>
<a name="line-55"></a><a name="recClsErr"></a><span class='hs-definition'>recClsErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCon</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRn</span> <span class='hs-conid'>()</span>
<a name="line-56"></a><span class='hs-definition'>recClsErr</span> <span class='hs-varid'>cycles</span>
<a name="line-57"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Cycle in class declaration (via superclasses):"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-58"></a>                 <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>intersperse</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"-&gt;"</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cycles</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-59"></a>
<a name="line-60"></a><a name="sortLocated"></a><span class='hs-definition'>sortLocated</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Located</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Located</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-61"></a><span class='hs-definition'>sortLocated</span> <span class='hs-varid'>things</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortLe</span> <span class='hs-varid'>le</span> <span class='hs-varid'>things</span>
<a name="line-62"></a>  <span class='hs-keyword'>where</span>
<a name="line-63"></a>    <span class='hs-varid'>le</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l1</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l2</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>l1</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>l2</span>
<a name="line-64"></a>
<a name="line-65"></a><a name="badDataConTyCon"></a><span class='hs-definition'>badDataConTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-66"></a><span class='hs-definition'>badDataConTyCon</span> <span class='hs-varid'>data_con</span> <span class='hs-varid'>res_ty_tmpl</span> <span class='hs-varid'>actual_res_ty</span>
<a name="line-67"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Data constructor"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>data_con</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-68"></a>		<span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"returns type"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>actual_res_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-69"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"instead of an instance of its parent type"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>res_ty_tmpl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-70"></a>
<a name="line-71"></a><a name="badATErr"></a><span class='hs-definition'>badATErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-72"></a><span class='hs-definition'>badATErr</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>op</span>
<a name="line-73"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Class"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>clas</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> 
<a name="line-74"></a>          <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"does not have an associated type"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-75"></a>
<a name="line-76"></a><a name="badGadtDecl"></a><span class='hs-definition'>badGadtDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-77"></a><span class='hs-definition'>badGadtDecl</span> <span class='hs-varid'>tc_name</span>
<a name="line-78"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal generalised algebraic data declaration for"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc_name</span><span class='hs-layout'>)</span>
<a name="line-79"></a>	 <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>parens</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Use -XGADTs to allow GADTs"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-80"></a>
<a name="line-81"></a><a name="badExistential"></a><span class='hs-definition'>badExistential</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Located</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-82"></a><span class='hs-definition'>badExistential</span> <span class='hs-varid'>con_name</span>
<a name="line-83"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Data constructor"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>con_name</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-84"></a>		<span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"has existential type variables, a context, or a specialised result type"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-85"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>parens</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Use -XExistentialQuantification or -XGADTs to allow this"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-86"></a>
<a name="line-87"></a><a name="badStupidTheta"></a><span class='hs-definition'>badStupidTheta</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-88"></a><span class='hs-definition'>badStupidTheta</span> <span class='hs-varid'>tc_name</span>
<a name="line-89"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"A data type declared in GADT style cannot have a context:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc_name</span><span class='hs-layout'>)</span>
<a name="line-90"></a>
<a name="line-91"></a><a name="newtypeConError"></a><span class='hs-definition'>newtypeConError</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-92"></a><span class='hs-definition'>newtypeConError</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>n</span>
<a name="line-93"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"A newtype must have exactly one constructor,"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-94"></a>	 <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"but"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"has"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>speakN</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>]</span>
<a name="line-95"></a>
<a name="line-96"></a><a name="newtypeExError"></a><span class='hs-definition'>newtypeExError</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-97"></a><span class='hs-definition'>newtypeExError</span> <span class='hs-varid'>con</span>
<a name="line-98"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"A newtype constructor cannot have an existential context,"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-99"></a>	 <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"but"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"does"</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-100"></a>
<a name="line-101"></a><a name="newtypeStrictError"></a><span class='hs-definition'>newtypeStrictError</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-102"></a><span class='hs-definition'>newtypeStrictError</span> <span class='hs-varid'>con</span>
<a name="line-103"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"A newtype constructor cannot have a strictness annotation,"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-104"></a>	 <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"but"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"does"</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-105"></a>
<a name="line-106"></a><a name="newtypePredError"></a><span class='hs-definition'>newtypePredError</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-107"></a><span class='hs-definition'>newtypePredError</span> <span class='hs-varid'>con</span>
<a name="line-108"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"A newtype constructor must have a return type of form T a1 ... an"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-109"></a>	 <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"but"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"does not"</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-110"></a>
<a name="line-111"></a><a name="newtypeFieldErr"></a><span class='hs-definition'>newtypeFieldErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-112"></a><span class='hs-definition'>newtypeFieldErr</span> <span class='hs-varid'>con_name</span> <span class='hs-varid'>n_flds</span>
<a name="line-113"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The constructor of a newtype must have exactly one field"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> 
<a name="line-114"></a>	 <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"but"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>con_name</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"has"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>speakN</span> <span class='hs-varid'>n_flds</span><span class='hs-keyglyph'>]</span>
<a name="line-115"></a>
<a name="line-116"></a><a name="badSigTyDecl"></a><span class='hs-definition'>badSigTyDecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-117"></a><span class='hs-definition'>badSigTyDecl</span> <span class='hs-varid'>tc_name</span>
<a name="line-118"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal kind signature"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-119"></a>	   <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc_name</span><span class='hs-layout'>)</span>
<a name="line-120"></a>	 <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>parens</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Use -XKindSignatures to allow kind signatures"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-121"></a>
<a name="line-122"></a><a name="emptyConDeclsErr"></a><span class='hs-definition'>emptyConDeclsErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-123"></a><span class='hs-definition'>emptyConDeclsErr</span> <span class='hs-varid'>tycon</span>
<a name="line-124"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"has no constructors"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-125"></a>	 <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"(-XEmptyDataDecls permits this)"</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-126"></a>
<a name="line-127"></a><a name="wrongATArgErr"></a><span class='hs-definition'>wrongATArgErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-128"></a><span class='hs-definition'>wrongATArgErr</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>instTy</span> <span class='hs-keyglyph'>=</span>
<a name="line-129"></a>  <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Type indexes must match class instance head"</span><span class='hs-layout'>)</span>
<a name="line-130"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Found"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-131"></a>        <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"but expected"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>instTy</span><span class='hs-layout'>)</span>
<a name="line-132"></a>      <span class='hs-keyglyph'>]</span>
<a name="line-133"></a><a name="wrongNumberOfParmsErr"></a><span class='hs-comment'>{-
<a name="line-134"></a>tooManyParmsErr :: Name -&gt; SDoc
<a name="line-135"></a>tooManyParmsErr tc_name
<a name="line-136"></a>  = ptext (sLit "Family instance has too many parameters:") &lt;+&gt;
<a name="line-137"></a>    quotes (ppr tc_name)
<a name="line-138"></a>-}</span>
<a name="line-139"></a><span class='hs-definition'>wrongNumberOfParmsErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-140"></a><span class='hs-definition'>wrongNumberOfParmsErr</span> <span class='hs-varid'>exp_arity</span>
<a name="line-141"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Number of parameters must match family declaration; expected"</span><span class='hs-layout'>)</span>
<a name="line-142"></a>    <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>exp_arity</span>
<a name="line-143"></a>
<a name="line-144"></a><a name="wrongKindOfFamily"></a><span class='hs-definition'>wrongKindOfFamily</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-145"></a><span class='hs-definition'>wrongKindOfFamily</span> <span class='hs-varid'>family</span>
<a name="line-146"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Wrong category of family instance; declaration was for a"</span><span class='hs-layout'>)</span>
<a name="line-147"></a>    <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>kindOfFamily</span>
<a name="line-148"></a>  <span class='hs-keyword'>where</span>
<a name="line-149"></a>    <span class='hs-varid'>kindOfFamily</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isSynTyCon</span> <span class='hs-varid'>family</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"type synonym"</span><span class='hs-layout'>)</span>
<a name="line-150"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isAlgTyCon</span> <span class='hs-varid'>family</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"data type"</span><span class='hs-layout'>)</span>
<a name="line-151"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"wrongKindOfFamily"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>family</span><span class='hs-layout'>)</span>
</pre>\end{code}
</body>
</html>
