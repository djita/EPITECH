<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>typecheck/TcEvidence.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
%

\begin{code}
<pre><a name="line-1"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcEvidence</span> <span class='hs-layout'>(</span>
<a name="line-2"></a>
<a name="line-3"></a>  <span class='hs-comment'>-- HsWrapper</span>
<a name="line-4"></a>  <span class='hs-conid'>HsWrapper</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> 
<a name="line-5"></a>  <span class='hs-layout'>(</span><span class='hs-varop'>&lt;.&gt;</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkWpTyApps</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkWpEvApps</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkWpEvVarApps</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkWpTyLams</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkWpLams</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkWpLet</span><span class='hs-layout'>,</span> 
<a name="line-6"></a>  <span class='hs-varid'>idHsWrapper</span><span class='hs-layout'>,</span> <span class='hs-varid'>isIdHsWrapper</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprHsWrapper</span><span class='hs-layout'>,</span>
<a name="line-7"></a>
<a name="line-8"></a>  <span class='hs-comment'>-- Evidence bindin</span>
<a name="line-9"></a>  <span class='hs-conid'>TcEvBinds</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>EvBindsVar</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> 
<a name="line-10"></a>  <span class='hs-conid'>EvBindMap</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyEvBindMap</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendEvBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupEvBind</span><span class='hs-layout'>,</span> <span class='hs-varid'>evBindMapBinds</span><span class='hs-layout'>,</span>
<a name="line-11"></a>
<a name="line-12"></a>  <span class='hs-conid'>EvBind</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyTcEvBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>isEmptyTcEvBinds</span><span class='hs-layout'>,</span> 
<a name="line-13"></a>
<a name="line-14"></a>  <span class='hs-conid'>EvTerm</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkEvCast</span><span class='hs-layout'>,</span> <span class='hs-varid'>evVarsOfTerm</span><span class='hs-layout'>,</span>
<a name="line-15"></a>
<a name="line-16"></a>  <span class='hs-comment'>-- TcCoercion</span>
<a name="line-17"></a>  <span class='hs-conid'>TcCoercion</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> 
<a name="line-18"></a>  <span class='hs-varid'>mkTcReflCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcTyConAppCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcAppCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcAppCos</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcFunCo</span><span class='hs-layout'>,</span>
<a name="line-19"></a>  <span class='hs-varid'>mkTcAxInstCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcForAllCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcForAllCos</span><span class='hs-layout'>,</span> 
<a name="line-20"></a>  <span class='hs-varid'>mkTcSymCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcTransCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcNthCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcInstCos</span><span class='hs-layout'>,</span>
<a name="line-21"></a>  <span class='hs-varid'>tcCoercionKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>coVarsOfTcCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>isEqVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcCoVarCo</span><span class='hs-layout'>,</span> 
<a name="line-22"></a>  <span class='hs-varid'>isTcReflCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>isTcReflCo_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTcCoVar_maybe</span><span class='hs-layout'>,</span>
<a name="line-23"></a>  <span class='hs-varid'>liftTcCoSubstWith</span>
<a name="line-24"></a>
<a name="line-25"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-26"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-27"></a>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-29"></a>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PprCore</span> <span class='hs-conid'>()</span>   <span class='hs-comment'>-- Instance OutputableBndr TyVar</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TypeRep</span>  <span class='hs-comment'>-- Knows type representation</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span><span class='hs-layout'>(</span> <span class='hs-varid'>tyConAppArgN</span><span class='hs-layout'>,</span> <span class='hs-varid'>getEqPredTys_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyConAppTyCon_maybe</span> <span class='hs-layout'>)</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysPrim</span><span class='hs-layout'>(</span> <span class='hs-varid'>funTyCon</span> <span class='hs-layout'>)</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-40"></a>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Pair</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Applicative</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Traversable</span> <span class='hs-layout'>(</span><span class='hs-varid'>traverse</span><span class='hs-layout'>,</span> <span class='hs-varid'>sequenceA</span><span class='hs-layout'>)</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Data</span> 
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>IORef</span><span class='hs-layout'>(</span> <span class='hs-conid'>IORef</span> <span class='hs-layout'>)</span>
</pre>\end{code}


Note [TcCoercions]
~~~~~~~~~~~~~~~~~~
| LCoercions are a hack used by the typechecker. Normally,
Coercions have free variables of type (a ~# b): we call these
CoVars. However, the type checker passes around equality evidence
(boxed up) at type (a ~ b).

An LCoercion is simply a Coercion whose free variables have the
boxed type (a ~ b). After we are done with typechecking the
desugarer finds the free variables, unboxes them, and creates a
resulting real Coercion with kosher free variables.

We can use most of the Coercion "smart constructors" to build LCoercions. However,
mkCoVarCo will not work! The equivalent is mkTcCoVarCo.

The data type is similar to Coercion.Coercion, with the following
differences
  * Most important, TcLetCo adds let-bindings for coercions.
    This is what lets us unify two for-all types and generate
    equality constraints underneath

  * The kind of a TcCoercion is  t1 ~  t2 
             of a Coercion   is  t1 ~# t2

  * TcAxiomInstCo takes Types, not Coecions as arguments;
    the generality is required only in the Simplifier

  * UnsafeCo aren't required

  * Reprsentation invariants are weaker:
     - we are allowed to have type synonyms in TcTyConAppCo
     - the first arg of a TcAppCo can be a TcTyConAppCo
    Reason: they'll get established when we desugar to Coercion

\begin{code}
<pre><a name="line-1"></a><a name="TcCoercion"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcCoercion</span> 
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcRefl</span> <span class='hs-conid'>TcType</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcTyConAppCo</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcCoercion</span><span class='hs-keyglyph'>]</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcAppCo</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcForAllCo</span> <span class='hs-conid'>TyVar</span> <span class='hs-conid'>TcCoercion</span> 
<a name="line-6"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcInstCo</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-conid'>TcType</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcCoVarCo</span> <span class='hs-conid'>EqVar</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcAxiomInstCo</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcSymCo</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcTransCo</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcNthCo</span> <span class='hs-conid'>Int</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-12"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcLetCo</span> <span class='hs-conid'>TcEvBinds</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-13"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span><span class='hs-layout'>)</span>
<a name="line-14"></a>
<a name="line-15"></a><a name="isEqVar"></a><span class='hs-definition'>isEqVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> 
<a name="line-16"></a><span class='hs-comment'>-- Is lifted coercion variable (only!)</span>
<a name="line-17"></a><span class='hs-definition'>isEqVar</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tyConAppTyCon_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-18"></a>               <span class='hs-conid'>Just</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqTyConKey</span>
<a name="line-19"></a>               <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-20"></a>
<a name="line-21"></a><a name="isTcReflCo_maybe"></a><span class='hs-definition'>isTcReflCo_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TcType</span>
<a name="line-22"></a><span class='hs-definition'>isTcReflCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRefl</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty</span>
<a name="line-23"></a><span class='hs-definition'>isTcReflCo_maybe</span> <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-24"></a>
<a name="line-25"></a><a name="isTcReflCo"></a><span class='hs-definition'>isTcReflCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-26"></a><span class='hs-definition'>isTcReflCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRefl</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-27"></a><span class='hs-definition'>isTcReflCo</span> <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="getTcCoVar_maybe"></a><span class='hs-definition'>getTcCoVar_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CoVar</span>
<a name="line-30"></a><span class='hs-definition'>getTcCoVar_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoVarCo</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>v</span>
<a name="line-31"></a><span class='hs-definition'>getTcCoVar_maybe</span> <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="mkTcReflCo"></a><span class='hs-definition'>mkTcReflCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-34"></a><span class='hs-definition'>mkTcReflCo</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcRefl</span>
<a name="line-35"></a>
<a name="line-36"></a><a name="mkTcFunCo"></a><span class='hs-definition'>mkTcFunCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-37"></a><span class='hs-definition'>mkTcFunCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcTyConAppCo</span> <span class='hs-varid'>funTyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>co1</span><span class='hs-layout'>,</span> <span class='hs-varid'>co2</span><span class='hs-keyglyph'>]</span>
<a name="line-38"></a>
<a name="line-39"></a><a name="mkTcTyConAppCo"></a><span class='hs-definition'>mkTcTyConAppCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcCoercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-40"></a><span class='hs-definition'>mkTcTyConAppCo</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span>   <span class='hs-comment'>-- No need to expand type synonyms</span>
<a name="line-41"></a>                        <span class='hs-comment'>-- See Note [TcCoercions]</span>
<a name="line-42"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>traverse</span> <span class='hs-varid'>isTcReflCo_maybe</span> <span class='hs-varid'>cos</span> 
<a name="line-43"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcRefl</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- See Note [Refl invariant]</span>
<a name="line-44"></a>
<a name="line-45"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcTyConAppCo</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span>
<a name="line-46"></a>
<a name="line-47"></a><a name="mkTcAxInstCo"></a><span class='hs-definition'>mkTcAxInstCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-48"></a><span class='hs-definition'>mkTcAxInstCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>tys</span>
<a name="line-49"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>arity</span> <span class='hs-varop'>==</span> <span class='hs-varid'>n_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcAxiomInstCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>tys</span>
<a name="line-50"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>arity</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>n_tys</span> <span class='hs-layout'>)</span>
<a name="line-51"></a>                     <span class='hs-varid'>foldl</span> <span class='hs-conid'>TcAppCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcAxiomInstCo</span> <span class='hs-varid'>ax</span> <span class='hs-layout'>(</span><span class='hs-varid'>take</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-52"></a>                                   <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>TcRefl</span> <span class='hs-layout'>(</span><span class='hs-varid'>drop</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-53"></a>  <span class='hs-keyword'>where</span>
<a name="line-54"></a>    <span class='hs-varid'>n_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span>
<a name="line-55"></a>    <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomArity</span> <span class='hs-varid'>ax</span>
<a name="line-56"></a>
<a name="line-57"></a><a name="mkTcAppCo"></a><span class='hs-definition'>mkTcAppCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-58"></a><span class='hs-comment'>-- No need to deal with TyConApp on the left; see Note [TcCoercions]</span>
<a name="line-59"></a><span class='hs-definition'>mkTcAppCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRefl</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRefl</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcRefl</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-60"></a><span class='hs-definition'>mkTcAppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>                       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcAppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-61"></a>
<a name="line-62"></a><a name="mkTcSymCo"></a><span class='hs-definition'>mkTcSymCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-63"></a><span class='hs-definition'>mkTcSymCo</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TcRefl</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-64"></a><span class='hs-definition'>mkTcSymCo</span>    <span class='hs-layout'>(</span><span class='hs-conid'>TcSymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-65"></a><span class='hs-definition'>mkTcSymCo</span> <span class='hs-varid'>co</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcSymCo</span> <span class='hs-varid'>co</span>
<a name="line-66"></a>
<a name="line-67"></a><a name="mkTcTransCo"></a><span class='hs-definition'>mkTcTransCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-68"></a><span class='hs-definition'>mkTcTransCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRefl</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-69"></a><span class='hs-definition'>mkTcTransCo</span> <span class='hs-varid'>co</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRefl</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-70"></a><span class='hs-definition'>mkTcTransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcTransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-71"></a>
<a name="line-72"></a><a name="mkTcNthCo"></a><span class='hs-definition'>mkTcNthCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-73"></a><span class='hs-definition'>mkTcNthCo</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRefl</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcRefl</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConAppArgN</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-74"></a><span class='hs-definition'>mkTcNthCo</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcNthCo</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span>
<a name="line-75"></a>
<a name="line-76"></a><a name="mkTcAppCos"></a><span class='hs-definition'>mkTcAppCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcCoercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-77"></a><span class='hs-definition'>mkTcAppCos</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-varid'>mkTcAppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>tys</span>
<a name="line-78"></a>
<a name="line-79"></a><a name="mkTcForAllCo"></a><span class='hs-definition'>mkTcForAllCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-80"></a><span class='hs-comment'>-- note that a TyVar should be used here, not a CoVar (nor a TcTyVar)</span>
<a name="line-81"></a><span class='hs-definition'>mkTcForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRefl</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span> <span class='hs-conid'>TcRefl</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-82"></a><span class='hs-definition'>mkTcForAllCo</span> <span class='hs-varid'>tv</span>  <span class='hs-varid'>co</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span> <span class='hs-conid'>TcForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>co</span>
<a name="line-83"></a>
<a name="line-84"></a><a name="mkTcForAllCos"></a><span class='hs-definition'>mkTcForAllCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-85"></a><span class='hs-definition'>mkTcForAllCos</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRefl</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>)</span> <span class='hs-conid'>TcRefl</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkForAllTys</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-86"></a><span class='hs-definition'>mkTcForAllCos</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>co</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>)</span> <span class='hs-varid'>foldr</span> <span class='hs-conid'>TcForAllCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>tvs</span>
<a name="line-87"></a>
<a name="line-88"></a><a name="mkTcInstCos"></a><span class='hs-definition'>mkTcInstCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-89"></a><span class='hs-definition'>mkTcInstCos</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRefl</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcRefl</span> <span class='hs-layout'>(</span><span class='hs-varid'>applyTys</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-90"></a><span class='hs-definition'>mkTcInstCos</span> <span class='hs-varid'>co</span> <span class='hs-varid'>tys</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-conid'>TcInstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>tys</span>
<a name="line-91"></a>
<a name="line-92"></a><a name="mkTcCoVarCo"></a><span class='hs-definition'>mkTcCoVarCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EqVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-93"></a><span class='hs-comment'>-- ipv :: s ~ t  (the boxed equality type)</span>
<a name="line-94"></a><span class='hs-definition'>mkTcCoVarCo</span> <span class='hs-varid'>ipv</span>
<a name="line-95"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcRefl</span> <span class='hs-varid'>ty1</span>
<a name="line-96"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcCoVarCo</span> <span class='hs-varid'>ipv</span>
<a name="line-97"></a>  <span class='hs-keyword'>where</span>
<a name="line-98"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>getEqPredTys_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>ipv</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-99"></a>        <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"mkCoVarLCo"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ipv</span><span class='hs-layout'>)</span>
<a name="line-100"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tys</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="tcCoercionKind"></a><span class='hs-definition'>tcCoercionKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Pair</span> <span class='hs-conid'>Type</span>
<a name="line-2"></a><span class='hs-definition'>tcCoercionKind</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span> 
<a name="line-3"></a>  <span class='hs-keyword'>where</span> 
<a name="line-4"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRefl</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ty</span>
<a name="line-5"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcLetCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-6"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTyConAppCo</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>sequenceA</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-7"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcAppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppTy</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span>
<a name="line-8"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-9"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcInstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_inst</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span>
<a name="line-10"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqVarKind</span> <span class='hs-varid'>cv</span>
<a name="line-11"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcAxiomInstCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Pair</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTyWith</span> <span class='hs-layout'>(</span><span class='hs-varid'>co_ax_tvs</span> <span class='hs-varid'>ax</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>(</span><span class='hs-varid'>co_ax_lhs</span> <span class='hs-varid'>ax</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-12"></a>                                     <span class='hs-layout'>(</span><span class='hs-varid'>substTyWith</span> <span class='hs-layout'>(</span><span class='hs-varid'>co_ax_tvs</span> <span class='hs-varid'>ax</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>(</span><span class='hs-varid'>co_ax_rhs</span> <span class='hs-varid'>ax</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-13"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcSymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>swap</span> <span class='hs-varop'>$</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-14"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Pair</span> <span class='hs-layout'>(</span><span class='hs-varid'>pFst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>pSnd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-15"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcNthCo</span> <span class='hs-varid'>d</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConAppArgN</span> <span class='hs-varid'>d</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-16"></a>
<a name="line-17"></a>    <span class='hs-comment'>-- c.f. Coercion.coercionKind</span>
<a name="line-18"></a>    <span class='hs-varid'>go_inst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcInstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_inst</span> <span class='hs-varid'>co</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-conop'>:</span><span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-19"></a>    <span class='hs-varid'>go_inst</span> <span class='hs-varid'>co</span>               <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varop'>`applyTys`</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-20"></a>
<a name="line-21"></a><a name="eqVarKind"></a><span class='hs-definition'>eqVarKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EqVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Pair</span> <span class='hs-conid'>Type</span>
<a name="line-22"></a><span class='hs-definition'>eqVarKind</span> <span class='hs-varid'>cv</span>
<a name="line-23"></a> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-sel'>_kind</span><span class='hs-layout'>,</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span><span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSplitTyConApp_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>
<a name="line-24"></a> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqTyConKey</span><span class='hs-layout'>)</span>
<a name="line-25"></a>   <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-26"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"eqVarKind, non coercion variable"</span>
<a name="line-27"></a>
<a name="line-28"></a><a name="coVarsOfTcCo"></a><span class='hs-definition'>coVarsOfTcCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-29"></a><span class='hs-comment'>-- Only works on *zonked* coercions, because of TcLetCo</span>
<a name="line-30"></a><span class='hs-definition'>coVarsOfTcCo</span> <span class='hs-varid'>tc_co</span>
<a name="line-31"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tc_co</span>
<a name="line-32"></a>  <span class='hs-keyword'>where</span>
<a name="line-33"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRefl</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-34"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionVarSet</span> <span class='hs-varop'>.</span> <span class='hs-varid'>go</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyVarSet</span> <span class='hs-varid'>cos</span>
<a name="line-35"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcAppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span>
<a name="line-36"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcForAllCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-37"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcInstCo</span> <span class='hs-varid'>co</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-38"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoVarCo</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitVarSet</span> <span class='hs-varid'>v</span>
<a name="line-39"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcAxiomInstCo</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-40"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcSymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-41"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span>
<a name="line-42"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcNthCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-43"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcLetCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBinds</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionVarSet</span> <span class='hs-varop'>.</span> <span class='hs-varid'>go_bind</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>bs</span>
<a name="line-44"></a>                                   <span class='hs-varop'>`minusVarSet`</span> <span class='hs-varid'>get_bndrs</span> <span class='hs-varid'>bs</span>
<a name="line-45"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcLetCo</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"coVarsOfTcCo called on non-zonked TcCoercion"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc_co</span><span class='hs-layout'>)</span>
<a name="line-46"></a>
<a name="line-47"></a>    <span class='hs-comment'>-- We expect only coercion bindings</span>
<a name="line-48"></a>    <span class='hs-varid'>go_bind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-49"></a>    <span class='hs-varid'>go_bind</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCoercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-50"></a>    <span class='hs-varid'>go_bind</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvId</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitVarSet</span> <span class='hs-varid'>v</span>
<a name="line-51"></a>    <span class='hs-varid'>go_bind</span> <span class='hs-varid'>other</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"coVarsOfTcCo:Bind"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>other</span><span class='hs-layout'>)</span>
<a name="line-52"></a>
<a name="line-53"></a>    <span class='hs-varid'>get_bndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>EvBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-54"></a>    <span class='hs-varid'>get_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrBag</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>bs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extendVarSet</span> <span class='hs-varid'>bs</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyVarSet</span> 
<a name="line-55"></a>
<a name="line-56"></a><a name="liftTcCoSubstWith"></a><span class='hs-definition'>liftTcCoSubstWith</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcCoercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-57"></a><span class='hs-comment'>-- This version can ignore capture; the free varialbes of the </span>
<a name="line-58"></a><span class='hs-comment'>-- TcCoerion are all fresh.  Result is mush simpler code</span>
<a name="line-59"></a><span class='hs-definition'>liftTcCoSubstWith</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cos</span> <span class='hs-varid'>ty</span>
<a name="line-60"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>equalLength</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cos</span> <span class='hs-layout'>)</span>
<a name="line-61"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-62"></a>  <span class='hs-keyword'>where</span>
<a name="line-63"></a>    <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipVarEnv</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cos</span>
<a name="line-64"></a>
<a name="line-65"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-66"></a>                             <span class='hs-conid'>Just</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>co</span>
<a name="line-67"></a>                             <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkTcReflCo</span> <span class='hs-varid'>ty</span>
<a name="line-68"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcAppCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-69"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcTyConAppCo</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-70"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-71"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcFunCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
</pre>\end{code}

Pretty printing

\begin{code}
<pre><a name="line-1"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyword'>where</span>
<a name="line-2"></a>  <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTcCo</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="pprTcCo"></a><span class='hs-definition'>pprTcCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprParendTcCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-5"></a><span class='hs-definition'>pprTcCo</span>       <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_co</span> <span class='hs-conid'>TopPrec</span>   <span class='hs-varid'>co</span>
<a name="line-6"></a><a name="pprParendTcCo"></a><span class='hs-definition'>pprParendTcCo</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_co</span> <span class='hs-conid'>TyConPrec</span> <span class='hs-varid'>co</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="ppr_co"></a><span class='hs-definition'>ppr_co</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Prec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-9"></a><span class='hs-definition'>ppr_co</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRefl</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>angleBrackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TcTyConAppCo</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>[</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-12"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>funTyConKey</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_fun_co</span> <span class='hs-varid'>p</span> <span class='hs-varid'>co</span>
<a name="line-13"></a>
<a name="line-14"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTyConAppCo</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTcApp</span>   <span class='hs-varid'>p</span> <span class='hs-varid'>ppr_co</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span>
<a name="line-15"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcLetCo</span> <span class='hs-varid'>bs</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeParen</span> <span class='hs-varid'>p</span> <span class='hs-conid'>TopPrec</span> <span class='hs-varop'>$</span>
<a name="line-16"></a>                                   <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"let"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>]</span>
<a name="line-17"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcAppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeParen</span> <span class='hs-varid'>p</span> <span class='hs-conid'>TyConPrec</span> <span class='hs-varop'>$</span>
<a name="line-18"></a>                                   <span class='hs-varid'>pprTcCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_co</span> <span class='hs-conid'>TyConPrec</span> <span class='hs-varid'>co2</span>
<a name="line-19"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TcForAllCo</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_forall_co</span> <span class='hs-varid'>p</span> <span class='hs-varid'>co</span>
<a name="line-20"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcInstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeParen</span> <span class='hs-varid'>p</span> <span class='hs-conid'>TyConPrec</span> <span class='hs-varop'>$</span>
<a name="line-21"></a>                                   <span class='hs-varid'>pprParendTcCo</span> <span class='hs-varid'>co</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"@"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>pprType</span> <span class='hs-varid'>ty</span>
<a name="line-22"></a>                     
<a name="line-23"></a><span class='hs-definition'>ppr_co</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parenSymOcc</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>
<a name="line-24"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcAxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTypeNameApp</span> <span class='hs-varid'>p</span> <span class='hs-varid'>ppr_type</span> <span class='hs-layout'>(</span><span class='hs-varid'>getName</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-varid'>cos</span>
<a name="line-25"></a>
<a name="line-26"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeParen</span> <span class='hs-varid'>p</span> <span class='hs-conid'>FunPrec</span> <span class='hs-varop'>$</span>
<a name="line-27"></a>                               <span class='hs-varid'>ppr_co</span> <span class='hs-conid'>FunPrec</span> <span class='hs-varid'>co1</span>
<a name="line-28"></a>                               <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>";"</span><span class='hs-layout'>)</span>
<a name="line-29"></a>                               <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_co</span> <span class='hs-conid'>FunPrec</span> <span class='hs-varid'>co2</span>
<a name="line-30"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcSymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPrefixApp</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Sym"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pprParendTcCo</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>]</span>
<a name="line-31"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcNthCo</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPrefixApp</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Nth:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pprParendTcCo</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>]</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="ppr_fun_co"></a><span class='hs-definition'>ppr_fun_co</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Prec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-34"></a><span class='hs-definition'>ppr_fun_co</span> <span class='hs-varid'>p</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprArrowChain</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>split</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-35"></a>  <span class='hs-keyword'>where</span>
<a name="line-36"></a>    <span class='hs-varid'>split</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SDoc</span><span class='hs-keyglyph'>]</span>
<a name="line-37"></a>    <span class='hs-varid'>split</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTyConAppCo</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg</span><span class='hs-layout'>,</span><span class='hs-varid'>res</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-38"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>f</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>funTyConKey</span>
<a name="line-39"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_co</span> <span class='hs-conid'>FunPrec</span> <span class='hs-varid'>arg</span> <span class='hs-conop'>:</span> <span class='hs-varid'>split</span> <span class='hs-varid'>res</span>
<a name="line-40"></a>    <span class='hs-varid'>split</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr_co</span> <span class='hs-conid'>TopPrec</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>]</span>
<a name="line-41"></a>
<a name="line-42"></a><a name="ppr_forall_co"></a><span class='hs-definition'>ppr_forall_co</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Prec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-43"></a><span class='hs-definition'>ppr_forall_co</span> <span class='hs-varid'>p</span> <span class='hs-varid'>ty</span>
<a name="line-44"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeParen</span> <span class='hs-varid'>p</span> <span class='hs-conid'>FunPrec</span> <span class='hs-varop'>$</span>
<a name="line-45"></a>    <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pprForAll</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr_co</span> <span class='hs-conid'>TopPrec</span> <span class='hs-varid'>rho</span><span class='hs-keyglyph'>]</span>
<a name="line-46"></a>  <span class='hs-keyword'>where</span>
<a name="line-47"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span>  <span class='hs-varid'>rho</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split1</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>ty</span>
<a name="line-48"></a>    <span class='hs-varid'>split1</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split1</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-conop'>:</span><span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-49"></a>    <span class='hs-varid'>split1</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>ty</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
                  HsWrapper
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="HsWrapper"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WpHole</span>                      <span class='hs-comment'>-- The identity coercion</span>
<a name="line-3"></a>
<a name="line-4"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WpCompose</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-5"></a>       <span class='hs-comment'>-- (wrap1 `WpCompose` wrap2)[e] = wrap1[ wrap2[ e ]]</span>
<a name="line-6"></a>       <span class='hs-comment'>--</span>
<a name="line-7"></a>       <span class='hs-comment'>-- Hence  (\a. []) `WpCompose` (\b. []) = (\a b. [])</span>
<a name="line-8"></a>       <span class='hs-comment'>-- But    ([] a)   `WpCompose` ([] b)   = ([] b a)</span>
<a name="line-9"></a>
<a name="line-10"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WpCast</span> <span class='hs-conid'>TcCoercion</span>         <span class='hs-comment'>-- A cast:  [] `cast` co</span>
<a name="line-11"></a>                              <span class='hs-comment'>-- Guaranteed not the identity coercion</span>
<a name="line-12"></a>
<a name="line-13"></a>        <span class='hs-comment'>-- Evidence abstraction and application</span>
<a name="line-14"></a>        <span class='hs-comment'>-- (both dictionaries and coercions)</span>
<a name="line-15"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WpEvLam</span> <span class='hs-conid'>EvVar</span>               <span class='hs-comment'>-- \d. []       the 'd' is an evidence variable</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WpEvApp</span> <span class='hs-conid'>EvTerm</span>              <span class='hs-comment'>-- [] d         the 'd' is evidence for a constraint</span>
<a name="line-17"></a>
<a name="line-18"></a>        <span class='hs-comment'>-- Kind and Type abstraction and application</span>
<a name="line-19"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WpTyLam</span> <span class='hs-conid'>TyVar</span>       <span class='hs-comment'>-- \a. []  the 'a' is a type/kind variable (not coercion var)</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WpTyApp</span> <span class='hs-conid'>KindOrType</span>  <span class='hs-comment'>-- [] t    the 't' is a type (not coercion)</span>
<a name="line-21"></a>
<a name="line-22"></a>
<a name="line-23"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WpLet</span> <span class='hs-conid'>TcEvBinds</span>             <span class='hs-comment'>-- Non-empty (or possibly non-empty) evidence bindings,</span>
<a name="line-24"></a>                                <span class='hs-comment'>-- so that the identity coercion is always exactly WpHole</span>
<a name="line-25"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span><span class='hs-layout'>)</span>
<a name="line-26"></a>
<a name="line-27"></a>
<a name="line-28"></a><a name="<.>"></a><span class='hs-layout'>(</span><span class='hs-varop'>&lt;.&gt;</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-29"></a><span class='hs-conid'>WpHole</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>c</span>
<a name="line-30"></a><a name="c"></a><span class='hs-definition'>c</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-conid'>WpHole</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>c</span>
<a name="line-31"></a><a name="c1"></a><span class='hs-definition'>c1</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>c2</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>c1</span> <span class='hs-varop'>`WpCompose`</span> <span class='hs-varid'>c2</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="mkWpTyApps"></a><span class='hs-definition'>mkWpTyApps</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-34"></a><span class='hs-definition'>mkWpTyApps</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_co_app_fn</span> <span class='hs-conid'>WpTyApp</span> <span class='hs-varid'>tys</span>
<a name="line-35"></a>
<a name="line-36"></a><a name="mkWpEvApps"></a><span class='hs-definition'>mkWpEvApps</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvTerm</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-37"></a><span class='hs-definition'>mkWpEvApps</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_co_app_fn</span> <span class='hs-conid'>WpEvApp</span> <span class='hs-varid'>args</span>
<a name="line-38"></a>
<a name="line-39"></a><a name="mkWpEvVarApps"></a><span class='hs-definition'>mkWpEvVarApps</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-40"></a><span class='hs-definition'>mkWpEvVarApps</span> <span class='hs-varid'>vs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWpEvApps</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>EvId</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span>
<a name="line-41"></a>
<a name="line-42"></a><a name="mkWpTyLams"></a><span class='hs-definition'>mkWpTyLams</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-43"></a><span class='hs-definition'>mkWpTyLams</span> <span class='hs-varid'>ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_co_lam_fn</span> <span class='hs-conid'>WpTyLam</span> <span class='hs-varid'>ids</span>
<a name="line-44"></a>
<a name="line-45"></a><a name="mkWpLams"></a><span class='hs-definition'>mkWpLams</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-46"></a><span class='hs-definition'>mkWpLams</span> <span class='hs-varid'>ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_co_lam_fn</span> <span class='hs-conid'>WpEvLam</span> <span class='hs-varid'>ids</span>
<a name="line-47"></a>
<a name="line-48"></a><a name="mkWpLet"></a><span class='hs-definition'>mkWpLet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcEvBinds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-49"></a><span class='hs-comment'>-- This no-op is a quite a common case</span>
<a name="line-50"></a><span class='hs-definition'>mkWpLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBinds</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WpHole</span>
<a name="line-51"></a><span class='hs-definition'>mkWpLet</span> <span class='hs-varid'>ev_binds</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WpLet</span> <span class='hs-varid'>ev_binds</span>
<a name="line-52"></a>
<a name="line-53"></a><a name="mk_co_lam_fn"></a><span class='hs-definition'>mk_co_lam_fn</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-54"></a><span class='hs-definition'>mk_co_lam_fn</span> <span class='hs-varid'>f</span> <span class='hs-keyword'>as</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>x</span> <span class='hs-varid'>wrap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>f</span> <span class='hs-varid'>x</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>wrap</span><span class='hs-layout'>)</span> <span class='hs-conid'>WpHole</span> <span class='hs-keyword'>as</span>
<a name="line-55"></a>
<a name="line-56"></a><a name="mk_co_app_fn"></a><span class='hs-definition'>mk_co_app_fn</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-57"></a><span class='hs-comment'>-- For applications, the *first* argument must</span>
<a name="line-58"></a><span class='hs-comment'>-- come *last* in the composition sequence</span>
<a name="line-59"></a><span class='hs-definition'>mk_co_app_fn</span> <span class='hs-varid'>f</span> <span class='hs-keyword'>as</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>x</span> <span class='hs-varid'>wrap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrap</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>f</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-conid'>WpHole</span> <span class='hs-keyword'>as</span>
<a name="line-60"></a>
<a name="line-61"></a><a name="idHsWrapper"></a><span class='hs-definition'>idHsWrapper</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-62"></a><span class='hs-definition'>idHsWrapper</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WpHole</span>
<a name="line-63"></a>
<a name="line-64"></a><a name="isIdHsWrapper"></a><span class='hs-definition'>isIdHsWrapper</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-65"></a><span class='hs-definition'>isIdHsWrapper</span> <span class='hs-conid'>WpHole</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-66"></a><span class='hs-definition'>isIdHsWrapper</span> <span class='hs-keyword'>_</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
                  Evidence bindings
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="TcEvBinds"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcEvBinds</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcEvBinds</span>           <span class='hs-comment'>-- Mutable evidence bindings</span>
<a name="line-3"></a>       <span class='hs-conid'>EvBindsVar</span>       <span class='hs-comment'>-- Mutable because they are updated "later"</span>
<a name="line-4"></a>                        <span class='hs-comment'>--    when an implication constraint is solved</span>
<a name="line-5"></a>
<a name="line-6"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvBinds</span>             <span class='hs-comment'>-- Immutable after zonking</span>
<a name="line-7"></a>       <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-conid'>EvBind</span><span class='hs-layout'>)</span>
<a name="line-8"></a>
<a name="line-9"></a>  <span class='hs-keyword'>deriving</span><span class='hs-layout'>(</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span> <span class='hs-layout'>)</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="EvBindsVar"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>EvBindsVar</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvBindsVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>IORef</span> <span class='hs-conid'>EvBindMap</span><span class='hs-layout'>)</span> <span class='hs-conid'>Unique</span>
<a name="line-12"></a>     <span class='hs-comment'>-- The Unique is only for debug printing</span>
<a name="line-13"></a>
<a name="line-14"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span> <span class='hs-conid'>TcEvBinds</span> <span class='hs-keyword'>where</span>
<a name="line-15"></a>  <span class='hs-comment'>-- Placeholder; we can't travers into TcEvBinds</span>
<a name="line-16"></a>  <span class='hs-varid'>toConstr</span> <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>abstractConstr</span> <span class='hs-str'>"TcEvBinds"</span>
<a name="line-17"></a>  <span class='hs-varid'>gunfold</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"gunfold"</span>
<a name="line-18"></a>  <span class='hs-varid'>dataTypeOf</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-varid'>mkNoRepType</span> <span class='hs-str'>"TcEvBinds"</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="EvBindMap"></a><span class='hs-comment'>-----------------</span>
<a name="line-21"></a><a name="EvBindMap"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>EvBindMap</span> 
<a name="line-22"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvBindMap</span> <span class='hs-layout'>{</span> 
<a name="line-23"></a>       <span class='hs-varid'>ev_bind_varenv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>VarEnv</span> <span class='hs-conid'>EvBind</span>
<a name="line-24"></a>    <span class='hs-layout'>}</span>       <span class='hs-comment'>-- Map from evidence variables to evidence terms</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="emptyEvBindMap"></a><span class='hs-definition'>emptyEvBindMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindMap</span>
<a name="line-27"></a><span class='hs-definition'>emptyEvBindMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvBindMap</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev_bind_varenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarEnv</span> <span class='hs-layout'>}</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="extendEvBinds"></a><span class='hs-definition'>extendEvBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvBindMap</span>
<a name="line-30"></a><span class='hs-definition'>extendEvBinds</span> <span class='hs-varid'>bs</span> <span class='hs-varid'>v</span> <span class='hs-varid'>t</span> 
<a name="line-31"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvBindMap</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev_bind_varenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev_bind_varenv</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span> <span class='hs-varid'>v</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="lookupEvBind"></a><span class='hs-definition'>lookupEvBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>EvBind</span>
<a name="line-34"></a><span class='hs-definition'>lookupEvBind</span> <span class='hs-varid'>bs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev_bind_varenv</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
<a name="line-35"></a>
<a name="line-36"></a><a name="evBindMapBinds"></a><span class='hs-definition'>evBindMapBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>EvBind</span>
<a name="line-37"></a><span class='hs-definition'>evBindMapBinds</span> <span class='hs-varid'>bs</span> 
<a name="line-38"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldVarEnv</span> <span class='hs-varid'>consBag</span> <span class='hs-varid'>emptyBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev_bind_varenv</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
<a name="line-39"></a>
<a name="line-40"></a><a name="EvBind"></a><span class='hs-comment'>-----------------</span>
<a name="line-41"></a><a name="EvBind"></a><span class='hs-comment'>-- All evidence is bound by EvBinds; no side effects</span>
<a name="line-42"></a><a name="EvBind"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>EvBind</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvBind</span> <span class='hs-conid'>EvVar</span> <span class='hs-conid'>EvTerm</span>
<a name="line-43"></a>
<a name="line-44"></a><a name="EvTerm"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>EvTerm</span>
<a name="line-45"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvId</span> <span class='hs-conid'>EvId</span>                  <span class='hs-comment'>-- Term-level variable-to-variable bindings</span>
<a name="line-46"></a>                               <span class='hs-comment'>-- (no coercion variables! they come via EvCoercion)</span>
<a name="line-47"></a>
<a name="line-48"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvCoercion</span> <span class='hs-conid'>TcCoercion</span>      <span class='hs-comment'>-- (Boxed) coercion bindings</span>
<a name="line-49"></a>
<a name="line-50"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvCast</span> <span class='hs-conid'>EvVar</span> <span class='hs-conid'>TcCoercion</span>    <span class='hs-comment'>-- d |&gt; co</span>
<a name="line-51"></a>
<a name="line-52"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvDFunApp</span> <span class='hs-conid'>DFunId</span>           <span class='hs-comment'>-- Dictionary instance application</span>
<a name="line-53"></a>       <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span>
<a name="line-54"></a>
<a name="line-55"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvTupleSel</span> <span class='hs-conid'>EvId</span>  <span class='hs-conid'>Int</span>       <span class='hs-comment'>-- n'th component of the tuple</span>
<a name="line-56"></a>
<a name="line-57"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvTupleMk</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvId</span><span class='hs-keyglyph'>]</span>           <span class='hs-comment'>-- tuple built from this stuff</span>
<a name="line-58"></a>
<a name="line-59"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvSuperClass</span> <span class='hs-conid'>DictId</span> <span class='hs-conid'>Int</span>    <span class='hs-comment'>-- n'th superclass. Used for both equalities and</span>
<a name="line-60"></a>                               <span class='hs-comment'>-- dictionaries, even though the former have no</span>
<a name="line-61"></a>                               <span class='hs-comment'>-- selector Id.  We count up from _0_</span>
<a name="line-62"></a>
<a name="line-63"></a>  <span class='hs-keyword'>deriving</span><span class='hs-layout'>(</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span><span class='hs-layout'>)</span>
</pre>\end{code}

Note [EvBinds/EvTerm]
~~~~~~~~~~~~~~~~~~~~~
How evidence is created and updated. Bindings for dictionaries,
and coercions and implicit parameters are carried around in TcEvBinds
which during constraint generation and simplification is always of the
form (TcEvBinds ref). After constraint simplification is finished it
will be transformed to t an (EvBinds ev_bag).

Evidence for coercions *SHOULD* be filled in using the TcEvBinds
However, all EvVars that correspond to *wanted* coercion terms in
an EvBind must be mutable variables so that they can be readily
inlined (by zonking) after constraint simplification is finished.

Conclusion: a new wanted coercion variable should be made mutable.
[Notice though that evidence variables that bind coercion terms
 from super classes will be "given" and hence rigid]


\begin{code}
<pre><a name="line-1"></a><a name="mkEvCast"></a><span class='hs-definition'>mkEvCast</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvTerm</span>
<a name="line-2"></a><span class='hs-definition'>mkEvCast</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>lco</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTcReflCo</span> <span class='hs-varid'>lco</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvId</span> <span class='hs-varid'>ev</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvCast</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>lco</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="emptyTcEvBinds"></a><span class='hs-definition'>emptyTcEvBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcEvBinds</span>
<a name="line-7"></a><span class='hs-definition'>emptyTcEvBinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvBinds</span> <span class='hs-varid'>emptyBag</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="isEmptyTcEvBinds"></a><span class='hs-definition'>isEmptyTcEvBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcEvBinds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-10"></a><span class='hs-definition'>isEmptyTcEvBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBinds</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>b</span>
<a name="line-11"></a><span class='hs-definition'>isEmptyTcEvBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcEvBinds</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"isEmptyTcEvBinds"</span>
<a name="line-12"></a>
<a name="line-13"></a>
<a name="line-14"></a><a name="evVarsOfTerm"></a><span class='hs-definition'>evVarsOfTerm</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span>
<a name="line-15"></a><span class='hs-definition'>evVarsOfTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvId</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>v</span><span class='hs-keyglyph'>]</span>
<a name="line-16"></a><span class='hs-definition'>evVarsOfTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCoercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>varSetElems</span> <span class='hs-layout'>(</span><span class='hs-varid'>coVarsOfTcCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-17"></a><span class='hs-definition'>evVarsOfTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvDFunApp</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>evs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evs</span>
<a name="line-18"></a><span class='hs-definition'>evVarsOfTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvTupleSel</span> <span class='hs-varid'>v</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>v</span><span class='hs-keyglyph'>]</span>
<a name="line-19"></a><span class='hs-definition'>evVarsOfTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvSuperClass</span> <span class='hs-varid'>v</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>v</span><span class='hs-keyglyph'>]</span>
<a name="line-20"></a><span class='hs-definition'>evVarsOfTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCast</span> <span class='hs-varid'>v</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>v</span> <span class='hs-conop'>:</span> <span class='hs-varid'>varSetElems</span> <span class='hs-layout'>(</span><span class='hs-varid'>coVarsOfTcCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-21"></a><span class='hs-definition'>evVarsOfTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvTupleMk</span> <span class='hs-varid'>evs</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evs</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
                  Pretty printing
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-keyword'>where</span>
<a name="line-2"></a>  <span class='hs-varid'>ppr</span> <span class='hs-varid'>co_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprHsWrapper</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"&lt;&gt;"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>co_fn</span>
<a name="line-3"></a>
<a name="line-4"></a><a name="pprHsWrapper"></a><span class='hs-definition'>pprHsWrapper</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-5"></a><span class='hs-comment'>-- In debug mode, print the wrapper</span>
<a name="line-6"></a><span class='hs-comment'>-- otherwise just print what's inside</span>
<a name="line-7"></a><span class='hs-definition'>pprHsWrapper</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>wrap</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getPprStyle</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>debugStyle</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>then</span> <span class='hs-layout'>(</span><span class='hs-varid'>help</span> <span class='hs-layout'>(</span><span class='hs-varid'>add_parens</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span> <span class='hs-varid'>wrap</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span>
<a name="line-9"></a>  <span class='hs-keyword'>where</span>
<a name="line-10"></a>    <span class='hs-varid'>help</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-11"></a>    <span class='hs-comment'>-- True  &lt;=&gt; appears in function application position</span>
<a name="line-12"></a>    <span class='hs-comment'>-- False &lt;=&gt; appears as body of let or lambda</span>
<a name="line-13"></a>    <span class='hs-varid'>help</span> <span class='hs-varid'>it</span> <span class='hs-conid'>WpHole</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>it</span>
<a name="line-14"></a>    <span class='hs-varid'>help</span> <span class='hs-varid'>it</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpCompose</span> <span class='hs-varid'>f1</span> <span class='hs-varid'>f2</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>help</span> <span class='hs-layout'>(</span><span class='hs-varid'>help</span> <span class='hs-varid'>it</span> <span class='hs-varid'>f2</span><span class='hs-layout'>)</span> <span class='hs-varid'>f1</span>
<a name="line-15"></a>    <span class='hs-varid'>help</span> <span class='hs-varid'>it</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpCast</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>add_parens</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>it</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"|&gt;"</span><span class='hs-layout'>)</span>
<a name="line-16"></a>                                              <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprParendTcCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-17"></a>    <span class='hs-varid'>help</span> <span class='hs-varid'>it</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpEvApp</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>no_parens</span>  <span class='hs-varop'>$</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>it</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-18"></a>    <span class='hs-varid'>help</span> <span class='hs-varid'>it</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpTyApp</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>no_parens</span>  <span class='hs-varop'>$</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>it</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"@"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprParendType</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span>
<a name="line-19"></a>    <span class='hs-varid'>help</span> <span class='hs-varid'>it</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpEvLam</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>add_parens</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"\\"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>pp_bndr</span> <span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>it</span> <span class='hs-conid'>False</span><span class='hs-keyglyph'>]</span>
<a name="line-20"></a>    <span class='hs-varid'>help</span> <span class='hs-varid'>it</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpTyLam</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>add_parens</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"/\\"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>pp_bndr</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>it</span> <span class='hs-conid'>False</span><span class='hs-keyglyph'>]</span>
<a name="line-21"></a>    <span class='hs-varid'>help</span> <span class='hs-varid'>it</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpLet</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>add_parens</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"let"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>it</span> <span class='hs-conid'>False</span><span class='hs-keyglyph'>]</span>
<a name="line-22"></a>
<a name="line-23"></a>    <span class='hs-varid'>pp_bndr</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprBndr</span> <span class='hs-conid'>LambdaBind</span> <span class='hs-varid'>v</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>dot</span>
<a name="line-24"></a>
<a name="line-25"></a>    <span class='hs-varid'>add_parens</span><span class='hs-layout'>,</span> <span class='hs-varid'>no_parens</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-26"></a>    <span class='hs-varid'>add_parens</span> <span class='hs-varid'>d</span> <span class='hs-conid'>True</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-varid'>d</span>
<a name="line-27"></a>    <span class='hs-varid'>add_parens</span> <span class='hs-varid'>d</span> <span class='hs-conid'>False</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span>
<a name="line-28"></a>    <span class='hs-varid'>no_parens</span> <span class='hs-varid'>d</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span>
<a name="line-29"></a>
<a name="line-30"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TcEvBinds</span> <span class='hs-keyword'>where</span>
<a name="line-31"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcEvBinds</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span>
<a name="line-32"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBinds</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"EvBinds"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>bagToList</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-33"></a>
<a name="line-34"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>EvBindsVar</span> <span class='hs-keyword'>where</span>
<a name="line-35"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBindsVar</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"EvBindsVar"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>angleBrackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span>
<a name="line-36"></a>
<a name="line-37"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>EvBind</span> <span class='hs-keyword'>where</span>
<a name="line-38"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span> <span class='hs-varid'>v</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>equals</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>]</span>
<a name="line-39"></a>   <span class='hs-comment'>-- We cheat a bit and pretend EqVars are CoVars for the purposes of pretty printing</span>
<a name="line-40"></a>
<a name="line-41"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyword'>where</span>
<a name="line-42"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvId</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span>
<a name="line-43"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCast</span> <span class='hs-varid'>v</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"`cast`"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprParendTcCo</span> <span class='hs-varid'>co</span>
<a name="line-44"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCoercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"CO"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span>
<a name="line-45"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvTupleSel</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"tupsel"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-46"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvTupleMk</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"tupmk"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>vs</span>
<a name="line-47"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvSuperClass</span> <span class='hs-varid'>d</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"sc"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>d</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-48"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvDFunApp</span> <span class='hs-varid'>df</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>df</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'@'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ts</span> <span class='hs-keyglyph'>]</span>
</pre>\end{code}

</body>
</html>
