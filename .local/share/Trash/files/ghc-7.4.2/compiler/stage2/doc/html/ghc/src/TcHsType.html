<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>typecheck/TcHsType.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%
\section[TcMonoType]{Typechecking user-specified @MonoTypes@}

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcHsType</span> <span class='hs-layout'>(</span>
<a name="line-9"></a>	<span class='hs-varid'>tcHsSigType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsSigTypeNC</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsDeriv</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsVectInst</span><span class='hs-layout'>,</span> 
<a name="line-10"></a>	<span class='hs-varid'>tcHsInstHead</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsQuantifiedType</span><span class='hs-layout'>,</span>
<a name="line-11"></a>	<span class='hs-conid'>UserTypeCtxt</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> 
<a name="line-12"></a>
<a name="line-13"></a>		<span class='hs-comment'>-- Kind checking</span>
<a name="line-14"></a>	<span class='hs-varid'>kcHsTyVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>kcHsSigType</span><span class='hs-layout'>,</span> <span class='hs-varid'>kcHsLiftedSigType</span><span class='hs-layout'>,</span> 
<a name="line-15"></a>	<span class='hs-varid'>kcLHsType</span><span class='hs-layout'>,</span> <span class='hs-varid'>kcCheckLHsType</span><span class='hs-layout'>,</span> <span class='hs-varid'>kcHsContext</span><span class='hs-layout'>,</span> <span class='hs-varid'>kcApps</span><span class='hs-layout'>,</span>
<a name="line-16"></a>        <span class='hs-varid'>kindGeneralizeKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>kindGeneralizeKinds</span><span class='hs-layout'>,</span>
<a name="line-17"></a>
<a name="line-18"></a>		<span class='hs-comment'>-- Sort checking</span>
<a name="line-19"></a>	<span class='hs-varid'>scDsLHsKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>scDsLHsMaybeKind</span><span class='hs-layout'>,</span>
<a name="line-20"></a>
<a name="line-21"></a>                <span class='hs-comment'>-- Typechecking kinded types</span>
<a name="line-22"></a>	<span class='hs-varid'>tcHsType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcCheckHsType</span><span class='hs-layout'>,</span>
<a name="line-23"></a>        <span class='hs-varid'>tcHsKindedContext</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsKindedType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsBangType</span><span class='hs-layout'>,</span>
<a name="line-24"></a>	<span class='hs-varid'>tcTyVarBndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcTyVarBndrsKindGen</span><span class='hs-layout'>,</span> <span class='hs-varid'>dsHsType</span><span class='hs-layout'>,</span>
<a name="line-25"></a>	<span class='hs-varid'>tcDataKindSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcTyClTyVars</span><span class='hs-layout'>,</span>
<a name="line-26"></a>
<a name="line-27"></a>        <span class='hs-conid'>ExpKind</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ekConstraint</span><span class='hs-layout'>,</span> <span class='hs-varid'>expArgKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>checkExpectedKind</span><span class='hs-layout'>,</span>
<a name="line-28"></a>
<a name="line-29"></a>		<span class='hs-comment'>-- Pattern type signatures</span>
<a name="line-30"></a>	<span class='hs-varid'>tcHsPatSigType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcPatSig</span>
<a name="line-31"></a>   <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-32"></a>
<a name="line-33"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-34"></a>
<a name="line-35"></a><span class='hs-cpp'>#ifdef GHCI 	/* Only if bootstrapped */</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span>	<span class='hs-conid'>TcSplice</span><span class='hs-layout'>(</span> <span class='hs-varid'>kcSpliceType</span> <span class='hs-layout'>)</span>
<a name="line-37"></a><span class='hs-cpp'>#endif</span>
<a name="line-38"></a>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnHsSyn</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnEnv</span>   <span class='hs-layout'>(</span> <span class='hs-varid'>dataKindsErr</span> <span class='hs-layout'>)</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcHsSyn</span> <span class='hs-layout'>(</span> <span class='hs-varid'>mkZonkTcTyVar</span> <span class='hs-layout'>)</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span><span class='hs-layout'>(</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-layout'>)</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEnv</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcMType</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcUnify</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcIface</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{- Kind parts of -}</span> <span class='hs-conid'>Type</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Kind</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span> <span class='hs-layout'>(</span> <span class='hs-conid'>DataCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConUserType</span> <span class='hs-layout'>)</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysPrim</span> <span class='hs-layout'>(</span> <span class='hs-varid'>liftedTypeKindTyConName</span><span class='hs-layout'>,</span> <span class='hs-varid'>constraintKindTyConName</span> <span class='hs-layout'>)</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span> <span class='hs-varid'>rdrNameSpace</span><span class='hs-layout'>,</span> <span class='hs-varid'>nameRdrName</span> <span class='hs-layout'>)</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameSet</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysWiredIn</span>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-63"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-64"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span> <span class='hs-layout'>(</span> <span class='hs-conid'>ExtensionFlag</span><span class='hs-layout'>(</span> <span class='hs-conid'>Opt_DataKinds</span> <span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-65"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-66"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSupply</span>
<a name="line-67"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-68"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BuildTyCl</span> <span class='hs-layout'>(</span> <span class='hs-varid'>buildPromotedDataTyCon</span> <span class='hs-layout'>)</span>
<a name="line-69"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-70"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span> <span class='hs-layout'>(</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>)</span>
</pre>\end{code}


	----------------------------
		General notes
	----------------------------

Generally speaking we now type-check types in three phases

  1.  kcHsType: kind check the HsType
	*includes* performing any TH type splices;
	so it returns a translated, and kind-annotated, type

  2.  dsHsType: convert from HsType to Type:
	perform zonking
	expand type synonyms [mkGenTyApps]
	hoist the foralls [tcHsType]

  3.  checkValidType: check the validity of the resulting type

Often these steps are done one after the other (tcHsSigType).
But in mutually recursive groups of type and class decls we do
	1 kind-check the whole group
	2 build TyCons/Classes in a knot-tied way
	3 check the validity of types in the now-unknotted TyCons/Classes

For example, when we find
	(forall a m. m a -> m a)
we bind a,m to kind varibles and kind-check (m a -> m a).  This makes
a get kind *, and m get kind *->*.  Now we typecheck (m a -> m a) in
an environment that binds a and m suitably.

The kind checker passed to tcHsTyVars needs to look at enough to
establish the kind of the tyvar:
  * For a group of type and class decls, it's just the group, not
	the rest of the program
  * For a tyvar bound in a pattern type signature, its the types
	mentioned in the other type signatures in that bunch of patterns
  * For a tyvar bound in a RULE, it's the type signatures on other
	universally quantified variables in the rule

Note that this may occasionally give surprising results.  For example:

	data T a b = MkT (a b)

Here we deduce			a::*->*,       b::*
But equally valid would be	a::(*->*)-> *, b::*->*


Validity checking
~~~~~~~~~~~~~~~~~
Some of the validity check could in principle be done by the kind checker, 
but not all:

- During desugaring, we normalise by expanding type synonyms.  Only
  after this step can we check things like type-synonym saturation
  e.g. 	type T k = k Int
	type S a = a
  Then (T S) is ok, because T is saturated; (T S) expands to (S Int);
  and then S is saturated.  This is a GHC extension.

- Similarly, also a GHC extension, we look through synonyms before complaining
  about the form of a class or instance declaration

- Ambiguity checks involve functional dependencies, and it's easier to wait
  until knots have been resolved before poking into them

Also, in a mutually recursive group of types, we can't look at the TyCon until we've
finished building the loop.  So to keep things simple, we postpone most validity
checking until step (3).

Knot tying
~~~~~~~~~~
During step (1) we might fault in a TyCon defined in another module, and it might
(via a loop) refer back to a TyCon defined in this module. So when we tie a big
knot around type declarations with ARecThing, so that the fault-in code can get
the TyCon being defined.


%************************************************************************
%*									*
\subsection{Checking types}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="tcHsSigType"></a><span class='hs-definition'>tcHsSigType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsSigTypeNC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-2"></a>  <span class='hs-comment'>-- Do kind checking, and hoist for-alls to the top</span>
<a name="line-3"></a>  <span class='hs-comment'>-- NB: it's important that the foralls that come from the top-level</span>
<a name="line-4"></a>  <span class='hs-comment'>--	 HsForAllTy in hs_ty occur *first* in the returned type.</span>
<a name="line-5"></a>  <span class='hs-comment'>--     See Note [Scoped] with TcSigInfo</span>
<a name="line-6"></a><span class='hs-definition'>tcHsSigType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>hs_ty</span> 
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprHsSigCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-8"></a>    <span class='hs-varid'>tcHsSigTypeNC</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>hs_ty</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="tcHsSigTypeNC"></a><span class='hs-definition'>tcHsSigTypeNC</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>hs_ty</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>kinded_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>expectedKindInCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>of</span>
<a name="line-12"></a>                         <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>fst</span> <span class='hs-layout'>(</span><span class='hs-varid'>kc_lhs_type_fresh</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span>
<a name="line-13"></a>                         <span class='hs-conid'>Just</span> <span class='hs-varid'>k</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>kc_lhs_type</span> <span class='hs-varid'>hs_ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>EK</span> <span class='hs-varid'>k</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Expected"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-14"></a>          <span class='hs-comment'>-- The kind is checked by checkValidType, and isn't necessarily</span>
<a name="line-15"></a>          <span class='hs-comment'>-- of kind * in a Template Haskell quote eg [t| Maybe |]</span>
<a name="line-16"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsKindedType</span> <span class='hs-varid'>kinded_ty</span>
<a name="line-17"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkValidType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty</span>
<a name="line-18"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="tcCheckHsType"></a><span class='hs-comment'>-- Like tcHsType, but takes an expected kind</span>
<a name="line-21"></a><span class='hs-definition'>tcCheckHsType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-22"></a><span class='hs-definition'>tcCheckHsType</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-23"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kinded_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kcCheckLHsType</span> <span class='hs-varid'>hs_ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>EK</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Expected"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-24"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsKindedType</span> <span class='hs-varid'>kinded_ty</span>
<a name="line-25"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="tcHsType"></a><span class='hs-definition'>tcHsType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-28"></a><span class='hs-comment'>-- kind check and desugar</span>
<a name="line-29"></a><span class='hs-comment'>-- no validity checking because of knot-tying</span>
<a name="line-30"></a><span class='hs-definition'>tcHsType</span> <span class='hs-varid'>hs_ty</span>
<a name="line-31"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>kinded_ty</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kc_lhs_type_fresh</span> <span class='hs-varid'>hs_ty</span>
<a name="line-32"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsKindedType</span> <span class='hs-varid'>kinded_ty</span>
<a name="line-33"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-34"></a>
<a name="line-35"></a><a name="tcHsInstHead"></a><span class='hs-definition'>tcHsInstHead</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>ThetaType</span><span class='hs-layout'>,</span> <span class='hs-conid'>Class</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-36"></a><span class='hs-comment'>-- Typecheck an instance head.  We can't use </span>
<a name="line-37"></a><span class='hs-comment'>-- tcHsSigType, because it's not a valid user type.</span>
<a name="line-38"></a><span class='hs-definition'>tcHsInstHead</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>lhs_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span>
<a name="line-39"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span>   <span class='hs-varop'>$</span>	<span class='hs-comment'>-- No need for an "In the type..." context</span>
<a name="line-40"></a>                        <span class='hs-comment'>-- because that comes from the caller</span>
<a name="line-41"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kinded_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kc_hs_type</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>ekConstraint</span>
<a name="line-42"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ds_type</span> <span class='hs-varid'>kinded_ty</span>
<a name="line-43"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitSigmaTy</span> <span class='hs-varid'>ty</span>
<a name="line-44"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>getClassPredTys_maybe</span> <span class='hs-varid'>tau</span> <span class='hs-keyword'>of</span>
<a name="line-45"></a>           <span class='hs-conid'>Nothing</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Malformed instance type"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-46"></a>           <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>clas</span><span class='hs-layout'>,</span><span class='hs-varid'>tys</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkValidInstance</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>lhs_ty</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>theta</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tys</span>
<a name="line-47"></a>                                  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>clas</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-48"></a>
<a name="line-49"></a><a name="tcHsQuantifiedType"></a><span class='hs-definition'>tcHsQuantifiedType</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-50"></a><span class='hs-comment'>-- Behave very like type-checking (HsForAllTy sig_tvs hs_ty),</span>
<a name="line-51"></a><span class='hs-comment'>-- except that we want to keep the tvs separate</span>
<a name="line-52"></a><span class='hs-definition'>tcHsQuantifiedType</span> <span class='hs-varid'>tv_names</span> <span class='hs-varid'>hs_ty</span>
<a name="line-53"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kcHsTyVars</span> <span class='hs-varid'>tv_names</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>tv_names'</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-54"></a>    <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>kc_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kcHsSigType</span> <span class='hs-varid'>hs_ty</span>
<a name="line-55"></a>    	<span class='hs-layout'>;</span> <span class='hs-varid'>tcTyVarBndrs</span> <span class='hs-varid'>tv_names'</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-56"></a>    <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsHsType</span> <span class='hs-varid'>kc_ty</span>
<a name="line-57"></a>    	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-58"></a>
<a name="line-59"></a><a name="tcHsDeriv"></a><span class='hs-comment'>-- Used for the deriving(...) items</span>
<a name="line-60"></a><span class='hs-definition'>tcHsDeriv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Class</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-61"></a><span class='hs-definition'>tcHsDeriv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_hs_deriv</span> <span class='hs-conid'>[]</span>
<a name="line-62"></a>
<a name="line-63"></a><a name="tc_hs_deriv"></a><span class='hs-definition'>tc_hs_deriv</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span>
<a name="line-64"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Class</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-65"></a><span class='hs-definition'>tc_hs_deriv</span> <span class='hs-varid'>tv_names1</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsForAllTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tv_names2</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-66"></a>  <span class='hs-keyglyph'>=</span> 	<span class='hs-comment'>-- Funny newtype deriving form</span>
<a name="line-67"></a>	<span class='hs-comment'>-- 	forall a. C [a]</span>
<a name="line-68"></a>	<span class='hs-comment'>-- where C has arity 2.  Hence can't use regular functions</span>
<a name="line-69"></a>    <span class='hs-varid'>tc_hs_deriv</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv_names1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tv_names2</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-70"></a>
<a name="line-71"></a><span class='hs-definition'>tc_hs_deriv</span> <span class='hs-varid'>tv_names</span> <span class='hs-varid'>ty</span>
<a name="line-72"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>cls_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>hs_tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitHsClassTy_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-73"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kcHsTyVars</span> <span class='hs-varid'>tv_names</span>                 <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>tv_names'</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-74"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>cls_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kcClass</span> <span class='hs-varid'>cls_name</span>
<a name="line-75"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-sel'>_res_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kcApps</span> <span class='hs-varid'>cls_name</span> <span class='hs-varid'>cls_kind</span> <span class='hs-varid'>hs_tys</span>
<a name="line-76"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>tcTyVarBndrsKindGen</span> <span class='hs-varid'>tv_names'</span>        <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>tyvars</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-77"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>arg_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsHsTypes</span> <span class='hs-varid'>tys</span>
<a name="line-78"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>cls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupClass</span> <span class='hs-varid'>cls_name</span>
<a name="line-79"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-80"></a>
<a name="line-81"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-82"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal deriving item"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-83"></a>
<a name="line-84"></a><a name="tcHsVectInst"></a><span class='hs-comment'>-- Used for 'VECTORISE [SCALAR] instance' declarations</span>
<a name="line-85"></a><span class='hs-comment'>--</span>
<a name="line-86"></a><span class='hs-definition'>tcHsVectInst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Class</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-87"></a><span class='hs-definition'>tcHsVectInst</span> <span class='hs-varid'>ty</span>
<a name="line-88"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cls_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitLHsClassTy_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-89"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cls_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kcClass</span> <span class='hs-varid'>cls_name</span>
<a name="line-90"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-sel'>_res_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kcApps</span> <span class='hs-varid'>cls_name</span> <span class='hs-varid'>cls_kind</span> <span class='hs-varid'>tys</span>
<a name="line-91"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>arg_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsHsTypes</span> <span class='hs-varid'>tys</span>
<a name="line-92"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>cls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupClass</span> <span class='hs-varid'>cls_name</span>
<a name="line-93"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span>
<a name="line-94"></a>       <span class='hs-layout'>}</span>
<a name="line-95"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-96"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Malformed instance type"</span><span class='hs-layout'>)</span>
</pre>\end{code}

	These functions are used during knot-tying in
	type and class declarations, when we have to
 	separate kind-checking, desugaring, and validity checking

\begin{code}
<pre><a name="line-1"></a><a name="kcHsSigType"></a><span class='hs-definition'>kcHsSigType</span><span class='hs-layout'>,</span> <span class='hs-varid'>kcHsLiftedSigType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-2"></a>	<span class='hs-comment'>-- Used for type signatures</span>
<a name="line-3"></a><span class='hs-definition'>kcHsSigType</span> <span class='hs-varid'>ty</span> 	     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addKcTypeCtxt</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$</span> <span class='hs-varid'>kcArgType</span> <span class='hs-varid'>ty</span>
<a name="line-4"></a><a name="kcHsLiftedSigType"></a><span class='hs-definition'>kcHsLiftedSigType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addKcTypeCtxt</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$</span> <span class='hs-varid'>kcLiftedType</span> <span class='hs-varid'>ty</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="tcHsKindedType"></a><span class='hs-definition'>tcHsKindedType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-7"></a>  <span class='hs-comment'>-- Don't do kind checking, nor validity checking.</span>
<a name="line-8"></a>  <span class='hs-comment'>-- This is used in type and class decls, where kinding is</span>
<a name="line-9"></a>  <span class='hs-comment'>-- done in advance, and validity checking is done later</span>
<a name="line-10"></a>  <span class='hs-comment'>-- [Validity checking done later because of knot-tying issues.]</span>
<a name="line-11"></a><span class='hs-definition'>tcHsKindedType</span> <span class='hs-varid'>hs_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dsHsType</span> <span class='hs-varid'>hs_ty</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="tcHsBangType"></a><span class='hs-definition'>tcHsBangType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-14"></a><span class='hs-comment'>-- Permit a bang, but discard it</span>
<a name="line-15"></a><span class='hs-comment'>-- Input type has already been kind-checked</span>
<a name="line-16"></a><span class='hs-definition'>tcHsBangType</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsBangTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcHsKindedType</span> <span class='hs-varid'>ty</span>
<a name="line-17"></a><span class='hs-definition'>tcHsBangType</span> <span class='hs-varid'>ty</span>                    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcHsKindedType</span> <span class='hs-varid'>ty</span>
<a name="line-18"></a>
<a name="line-19"></a><a name="tcHsKindedContext"></a><span class='hs-definition'>tcHsKindedContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsContext</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>ThetaType</span>
<a name="line-20"></a><span class='hs-comment'>-- Used when we are expecting a ClassContext (i.e. no implicit params)</span>
<a name="line-21"></a><span class='hs-comment'>-- Does not do validity checking, like tcHsKindedType</span>
<a name="line-22"></a><span class='hs-definition'>tcHsKindedContext</span> <span class='hs-varid'>hs_theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addLocM</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapM</span> <span class='hs-varid'>dsHsType</span><span class='hs-layout'>)</span> <span class='hs-varid'>hs_theta</span>
</pre>\end{code}


%************************************************************************
%*									*
		The main kind checker: kcHsType
%*									*
%************************************************************************
	
	First a couple of simple wrappers for kcHsType

\begin{code}
<pre><a name="line-1"></a><a name="kcLiftedType"></a><span class='hs-comment'>---------------------------</span>
<a name="line-2"></a><span class='hs-definition'>kcLiftedType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-3"></a><span class='hs-comment'>-- The type ty must be a *lifted* *type*</span>
<a name="line-4"></a><span class='hs-definition'>kcLiftedType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kc_lhs_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ekLifted</span>
<a name="line-5"></a>    
<a name="line-6"></a><a name="kcArgs"></a><span class='hs-definition'>kcArgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-7"></a><span class='hs-definition'>kcArgs</span> <span class='hs-varid'>what</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>kind</span> 
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sequence</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>kc_lhs_type</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>expArgKind</span> <span class='hs-varid'>what</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-9"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>`zip`</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span><span class='hs-keyglyph'>..</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="kcArgType"></a><span class='hs-comment'>---------------------------</span>
<a name="line-12"></a><span class='hs-definition'>kcArgType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-13"></a><span class='hs-comment'>-- The type ty must be an *arg* *type* (lifted or unlifted)</span>
<a name="line-14"></a><span class='hs-definition'>kcArgType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kc_lhs_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ekArg</span>
<a name="line-15"></a>
<a name="line-16"></a><a name="kcCheckLHsType"></a><span class='hs-comment'>---------------------------</span>
<a name="line-17"></a><span class='hs-definition'>kcCheckLHsType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-18"></a><span class='hs-definition'>kcCheckLHsType</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addKcTypeCtxt</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$</span> <span class='hs-varid'>kc_lhs_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>kind</span>
</pre>\end{code}

Like tcExpr, kc_hs_type takes an expected kind which it unifies with
the kind it figures out. When we don't know what kind to expect, we use
kc_lhs_type_fresh, to first create a new meta kind variable and use that as
the expected kind.

\begin{code}
<pre><a name="line-1"></a><a name="kcLHsType"></a><span class='hs-definition'>kcLHsType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-comment'>-- Called from outside: set the context</span>
<a name="line-3"></a><span class='hs-definition'>kcLHsType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addKcTypeCtxt</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>kc_lhs_type_fresh</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="kc_lhs_type_fresh"></a><span class='hs-definition'>kc_lhs_type_fresh</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-6"></a><span class='hs-definition'>kc_lhs_type_fresh</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span>  <span class='hs-keyword'>do</span>
<a name="line-7"></a>  <span class='hs-varid'>kv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-8"></a>  <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kc_lhs_type</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>EK</span> <span class='hs-varid'>kv</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Expected"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-9"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>r</span><span class='hs-layout'>,</span> <span class='hs-varid'>kv</span><span class='hs-layout'>)</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="kc_lhs_types"></a><span class='hs-definition'>kc_lhs_types</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>ExpKind</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-12"></a><span class='hs-definition'>kc_lhs_types</span> <span class='hs-varid'>tys_w_kinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>uncurry</span> <span class='hs-varid'>kc_lhs_type</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys_w_kinds</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="kc_lhs_type"></a><span class='hs-definition'>kc_lhs_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-15"></a><span class='hs-definition'>kc_lhs_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>span</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>span</span> <span class='hs-varop'>$</span>
<a name="line-17"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"kc_lhs_type"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>exp_kind</span><span class='hs-layout'>)</span>
<a name="line-18"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kc_hs_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-19"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>span</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-20"></a>
<a name="line-21"></a><a name="kc_hs_type"></a><span class='hs-definition'>kc_hs_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-22"></a><span class='hs-definition'>kc_hs_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsParTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-23"></a>   <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kc_lhs_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-24"></a>   <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsParTy</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span>
<a name="line-25"></a>
<a name="line-26"></a><span class='hs-definition'>kc_hs_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-27"></a>  <span class='hs-comment'>-- Special case for the unit tycon so it benefits from kind overloading</span>
<a name="line-28"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>name</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tyConName</span> <span class='hs-varid'>unitTyCon</span>
<a name="line-29"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kc_hs_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTupleTy</span> <span class='hs-conid'>HsBoxedOrConstraintTuple</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-30"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 
<a name="line-31"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kcTyVar</span> <span class='hs-varid'>name</span>
<a name="line-32"></a>      <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>k</span> <span class='hs-varid'>exp_kind</span>
<a name="line-33"></a>      <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span>
<a name="line-34"></a>
<a name="line-35"></a><span class='hs-definition'>kc_hs_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsListTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-36"></a>    <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kcLiftedType</span> <span class='hs-varid'>ty</span>
<a name="line-37"></a>    <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-38"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsListTy</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span>
<a name="line-39"></a>
<a name="line-40"></a><span class='hs-definition'>kc_hs_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsPArrTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-41"></a>    <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kcLiftedType</span> <span class='hs-varid'>ty</span>
<a name="line-42"></a>    <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-43"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsPArrTy</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span>
<a name="line-44"></a>
<a name="line-45"></a><span class='hs-definition'>kc_hs_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsKindSig</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>sig_k</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-46"></a>    <span class='hs-varid'>sig_k'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>scDsLHsKind</span> <span class='hs-varid'>sig_k</span>
<a name="line-47"></a>    <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kc_lhs_type</span> <span class='hs-varid'>ty</span>
<a name="line-48"></a>             <span class='hs-layout'>(</span><span class='hs-conid'>EK</span> <span class='hs-varid'>sig_k'</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"An enclosing kind signature specified"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-49"></a>    <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>sig_k'</span> <span class='hs-varid'>exp_kind</span>
<a name="line-50"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsKindSig</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>sig_k</span><span class='hs-layout'>)</span>
<a name="line-51"></a>
<a name="line-52"></a><span class='hs-comment'>-- See Note [Distinguishing tuple kinds] in HsTypes</span>
<a name="line-53"></a><span class='hs-definition'>kc_hs_type</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsTupleTy</span> <span class='hs-conid'>HsBoxedOrConstraintTuple</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>EK</span> <span class='hs-varid'>exp_k</span> <span class='hs-sel'>_ctxt</span><span class='hs-layout'>)</span>
<a name="line-54"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isConstraintOrLiftedKind</span> <span class='hs-varid'>exp_k</span> <span class='hs-comment'>-- (NB: not zonking, to avoid left-right bias)</span>
<a name="line-55"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kcArgs</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a tuple"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>exp_k</span>
<a name="line-56"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isConstraintKind</span> <span class='hs-varid'>exp_k</span>
<a name="line-57"></a>                    <span class='hs-keyword'>then</span> <span class='hs-conid'>HsTupleTy</span> <span class='hs-conid'>HsConstraintTuple</span> <span class='hs-varid'>tys'</span>
<a name="line-58"></a>                    <span class='hs-keyword'>else</span> <span class='hs-conid'>HsTupleTy</span> <span class='hs-conid'>HsBoxedTuple</span>      <span class='hs-varid'>tys'</span> <span class='hs-layout'>}</span>
<a name="line-59"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-60"></a>  <span class='hs-comment'>-- It is not clear from the context if it's * or Constraint, </span>
<a name="line-61"></a>  <span class='hs-comment'>-- so we infer the kind from the arguments</span>
<a name="line-62"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-63"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kcArgs</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a tuple"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>k</span> 
<a name="line-64"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>k'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-varid'>k</span>
<a name="line-65"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isConstraintKind</span> <span class='hs-varid'>k'</span>
<a name="line-66"></a>         <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>k'</span> <span class='hs-varid'>exp_kind</span>
<a name="line-67"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTupleTy</span> <span class='hs-conid'>HsConstraintTuple</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-68"></a>         <span class='hs-comment'>-- If it's not clear from the arguments that it's Constraint, then</span>
<a name="line-69"></a>         <span class='hs-comment'>-- it must be *. Check the arguments again to give good error messages</span>
<a name="line-70"></a>         <span class='hs-comment'>-- in eg. `(Maybe, Maybe)`</span>
<a name="line-71"></a>         <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tys''</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kcArgs</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a tuple"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-72"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-73"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTupleTy</span> <span class='hs-conid'>HsBoxedTuple</span> <span class='hs-varid'>tys''</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-74"></a><span class='hs-comment'>{-
<a name="line-75"></a>Note that we will still fail to infer the correct kind in this case:
<a name="line-76"></a>
<a name="line-77"></a>  type T a = ((a,a), D a)
<a name="line-78"></a>  type family D :: Constraint -&gt; Constraint
<a name="line-79"></a>
<a name="line-80"></a>While kind checking T, we do not yet know the kind of D, so we will default the
<a name="line-81"></a>kind of T to * -&gt; *. It works if we annotate `a` with kind `Constraint`.
<a name="line-82"></a>-}</span>
<a name="line-83"></a>
<a name="line-84"></a><span class='hs-definition'>kc_hs_type</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsTupleTy</span> <span class='hs-varid'>tup_sort</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-85"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kcArgs</span> <span class='hs-varid'>cxt_doc</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>arg_kind</span>
<a name="line-86"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>out_kind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-87"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTupleTy</span> <span class='hs-varid'>tup_sort</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-88"></a>  <span class='hs-keyword'>where</span>
<a name="line-89"></a>    <span class='hs-varid'>arg_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tup_sort</span> <span class='hs-keyword'>of</span>
<a name="line-90"></a>                 <span class='hs-conid'>HsBoxedTuple</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-91"></a>                 <span class='hs-conid'>HsUnboxedTuple</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>argTypeKind</span>
<a name="line-92"></a>                 <span class='hs-conid'>HsConstraintTuple</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>constraintKind</span>
<a name="line-93"></a>                 <span class='hs-keyword'>_</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"kc_hs_type arg_kind"</span>
<a name="line-94"></a>    <span class='hs-varid'>out_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tup_sort</span> <span class='hs-keyword'>of</span>
<a name="line-95"></a>                 <span class='hs-conid'>HsUnboxedTuple</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ubxTupleKind</span>
<a name="line-96"></a>                 <span class='hs-keyword'>_</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>arg_kind</span>
<a name="line-97"></a>    <span class='hs-varid'>cxt_doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tup_sort</span> <span class='hs-keyword'>of</span>
<a name="line-98"></a>                 <span class='hs-conid'>HsBoxedTuple</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a tuple"</span><span class='hs-layout'>)</span>
<a name="line-99"></a>                 <span class='hs-conid'>HsUnboxedTuple</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"an unboxed tuple"</span><span class='hs-layout'>)</span>
<a name="line-100"></a>                 <span class='hs-conid'>HsConstraintTuple</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a constraint tuple"</span><span class='hs-layout'>)</span>
<a name="line-101"></a>                 <span class='hs-keyword'>_</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"kc_hs_type tup_sort"</span>
<a name="line-102"></a>
<a name="line-103"></a><span class='hs-definition'>kc_hs_type</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsFunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>EK</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-104"></a>    <span class='hs-varid'>ty1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kc_lhs_type</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-conid'>EK</span> <span class='hs-varid'>argTypeKind</span>  <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-105"></a>    <span class='hs-varid'>ty2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kc_lhs_type</span> <span class='hs-varid'>ty2</span> <span class='hs-layout'>(</span><span class='hs-conid'>EK</span> <span class='hs-varid'>openTypeKind</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-106"></a>    <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-107"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsFunTy</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>)</span>
<a name="line-108"></a>
<a name="line-109"></a><span class='hs-definition'>kc_hs_type</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsOpTy</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>l_op</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-110"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>wop</span><span class='hs-layout'>,</span> <span class='hs-varid'>op_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kcTyVar</span> <span class='hs-varid'>op</span>
<a name="line-111"></a>    <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty1'</span><span class='hs-layout'>,</span><span class='hs-varid'>ty2'</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kcCheckApps</span> <span class='hs-varid'>l_op</span> <span class='hs-varid'>op_kind</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span><span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-112"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>op'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>wop</span> <span class='hs-keyword'>of</span>
<a name="line-113"></a>                <span class='hs-conid'>HsTyVar</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpKiApps</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-114"></a>                <span class='hs-conid'>HsWrapTy</span> <span class='hs-varid'>wrap</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap</span><span class='hs-layout'>,</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-115"></a>                <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"kc_hs_type HsOpTy"</span>
<a name="line-116"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOpTy</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>op'</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>)</span>
<a name="line-117"></a>
<a name="line-118"></a><span class='hs-definition'>kc_hs_type</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsAppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-119"></a>    <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitHsAppTys</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span>
<a name="line-120"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>fun_ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kc_lhs_type_fresh</span> <span class='hs-varid'>fun_ty</span>
<a name="line-121"></a>    <span class='hs-varid'>arg_tys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kcCheckApps</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>fun_kind</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-122"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsAppTys</span> <span class='hs-varid'>fun_ty'</span> <span class='hs-varid'>arg_tys'</span><span class='hs-layout'>)</span>
<a name="line-123"></a>
<a name="line-124"></a><span class='hs-definition'>kc_hs_type</span> <span class='hs-varid'>ipTy</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsIParamTy</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-125"></a>    <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kc_lhs_type</span> <span class='hs-varid'>ty</span> 
<a name="line-126"></a>             <span class='hs-layout'>(</span><span class='hs-conid'>EK</span> <span class='hs-varid'>liftedTypeKind</span> 
<a name="line-127"></a>               <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The type argument of the implicit parameter had"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-128"></a>    <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>ipTy</span> <span class='hs-varid'>constraintKind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-129"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIParamTy</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span>
<a name="line-130"></a>
<a name="line-131"></a><span class='hs-definition'>kc_hs_type</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsEqTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-132"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>ty1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kc_lhs_type_fresh</span> <span class='hs-varid'>ty1</span>
<a name="line-133"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>ty2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kc_lhs_type_fresh</span> <span class='hs-varid'>ty2</span>
<a name="line-134"></a>    <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>kind2</span>
<a name="line-135"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>EK</span> <span class='hs-varid'>kind1</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The left argument of the equality predicate had"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-136"></a>    <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>constraintKind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-137"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsEqTy</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>)</span>
<a name="line-138"></a>
<a name="line-139"></a><span class='hs-definition'>kc_hs_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCoreTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-140"></a>    <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-141"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCoreTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-142"></a>
<a name="line-143"></a><span class='hs-definition'>kc_hs_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsForAllTy</span> <span class='hs-varid'>exp</span> <span class='hs-varid'>tv_names</span> <span class='hs-varid'>context</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-144"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kcHsTyVars</span> <span class='hs-varid'>tv_names</span>         <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>tv_names'</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-145"></a>    <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>ctxt'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kcHsContext</span> <span class='hs-varid'>context</span>
<a name="line-146"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kc_lhs_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-147"></a>	     <span class='hs-comment'>-- The body of a forall is usually a type, but in principle</span>
<a name="line-148"></a>	     <span class='hs-comment'>-- there's no reason to prohibit *unlifted* types.</span>
<a name="line-149"></a>	     <span class='hs-comment'>-- In fact, GHC can itself construct a function with an</span>
<a name="line-150"></a>	     <span class='hs-comment'>-- unboxed tuple inside a for-all (via CPR analyis; see </span>
<a name="line-151"></a>	     <span class='hs-comment'>-- typecheck/should_compile/tc170).</span>
<a name="line-152"></a>             <span class='hs-comment'>--</span>
<a name="line-153"></a>             <span class='hs-comment'>-- Moreover in instance heads we get forall-types with</span>
<a name="line-154"></a>             <span class='hs-comment'>-- kind Constraint.  </span>
<a name="line-155"></a>	     <span class='hs-comment'>--</span>
<a name="line-156"></a>	     <span class='hs-comment'>-- Really we should check that it's a type of value kind</span>
<a name="line-157"></a>             <span class='hs-comment'>-- {*, Constraint, #}, but I'm not doing that yet</span>
<a name="line-158"></a>             <span class='hs-comment'>-- Example that should be rejected:  </span>
<a name="line-159"></a>             <span class='hs-comment'>--          f :: (forall (a:*-&gt;*). a) Int</span>
<a name="line-160"></a>  	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsForAllTy</span> <span class='hs-varid'>exp</span> <span class='hs-varid'>tv_names'</span> <span class='hs-varid'>ctxt'</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-161"></a>
<a name="line-162"></a><span class='hs-definition'>kc_hs_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsBangTy</span> <span class='hs-varid'>b</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-163"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kc_lhs_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-164"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsBangTy</span> <span class='hs-varid'>b</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-165"></a>
<a name="line-166"></a><span class='hs-definition'>kc_hs_type</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsRecTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-sel'>_exp_kind</span>
<a name="line-167"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Unexpected record type"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-168"></a>      <span class='hs-comment'>-- Record types (which only show up temporarily in constructor signatures) </span>
<a name="line-169"></a>      <span class='hs-comment'>-- should have been removed by now</span>
<a name="line-170"></a>
<a name="line-171"></a><span class='hs-cpp'>#ifdef GHCI	/* Only if bootstrapped */</span>
<a name="line-172"></a><span class='hs-definition'>kc_hs_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSpliceTy</span> <span class='hs-varid'>sp</span> <span class='hs-varid'>fvs</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-173"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kcSpliceType</span> <span class='hs-varid'>sp</span> <span class='hs-varid'>fvs</span>
<a name="line-174"></a>    <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>k</span> <span class='hs-varid'>exp_kind</span>
<a name="line-175"></a>    <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span>
<a name="line-176"></a><span class='hs-cpp'>#else</span>
<a name="line-177"></a><span class='hs-definition'>kc_hs_type</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsSpliceTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-sel'>_exp_kind</span> <span class='hs-keyglyph'>=</span>
<a name="line-178"></a>    <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Unexpected type splice:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-179"></a><span class='hs-cpp'>#endif</span>
<a name="line-180"></a>
<a name="line-181"></a><span class='hs-definition'>kc_hs_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsQuasiQuoteTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-sel'>_exp_kind</span> <span class='hs-keyglyph'>=</span>
<a name="line-182"></a>    <span class='hs-varid'>panic</span> <span class='hs-str'>"kc_hs_type"</span>  <span class='hs-comment'>-- Eliminated by renamer</span>
<a name="line-183"></a>
<a name="line-184"></a><span class='hs-comment'>-- Remove the doc nodes here, no need to worry about the location since</span>
<a name="line-185"></a><span class='hs-comment'>-- it's the same for a doc node and its child type node</span>
<a name="line-186"></a><span class='hs-definition'>kc_hs_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDocTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-187"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kc_hs_type</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-188"></a>
<a name="line-189"></a><span class='hs-definition'>kc_hs_type</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsExplicitListTy</span> <span class='hs-sel'>_k</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-190"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty_k_s</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>kc_lhs_type_fresh</span> <span class='hs-varid'>tys</span>
<a name="line-191"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyKinds</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In a promoted list"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty_k_s</span>
<a name="line-192"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkListTy</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-193"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExplicitListTy</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>ty_k_s</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-194"></a>
<a name="line-195"></a><span class='hs-definition'>kc_hs_type</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsExplicitTupleTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-196"></a>  <span class='hs-varid'>ty_k_s</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>kc_lhs_type_fresh</span> <span class='hs-varid'>tys</span>
<a name="line-197"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>tupleKi</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>tupleTyCon</span> <span class='hs-conid'>BoxedTuple</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>ty_k_s</span><span class='hs-layout'>)</span>
<a name="line-198"></a>  <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>tupleKi</span> <span class='hs-varid'>exp_kind</span>
<a name="line-199"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExplicitTupleTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>ty_k_s</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>ty_k_s</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-200"></a>
<a name="line-201"></a><span class='hs-definition'>kc_hs_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrapTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-sel'>_exp_kind</span> <span class='hs-keyglyph'>=</span>
<a name="line-202"></a>    <span class='hs-varid'>panic</span> <span class='hs-str'>"kc_hs_type HsWrapTy"</span>  <span class='hs-comment'>-- We kind checked something twice</span>
<a name="line-203"></a>
<a name="line-204"></a><a name="kcApps"></a><span class='hs-comment'>---------------------------</span>
<a name="line-205"></a><span class='hs-definition'>kcApps</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span>
<a name="line-206"></a>       <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> 
<a name="line-207"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span>			<span class='hs-comment'>-- Function kind</span>
<a name="line-208"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>		<span class='hs-comment'>-- Arg types</span>
<a name="line-209"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>	<span class='hs-comment'>-- Kind-checked args</span>
<a name="line-210"></a><span class='hs-definition'>kcApps</span> <span class='hs-varid'>the_fun</span> <span class='hs-varid'>fun_kind</span> <span class='hs-varid'>args</span>
<a name="line-211"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>args_w_kinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitFunKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>the_fun</span><span class='hs-layout'>)</span> <span class='hs-num'>1</span> <span class='hs-varid'>fun_kind</span> <span class='hs-varid'>args</span>
<a name="line-212"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>args'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kc_lhs_types</span> <span class='hs-varid'>args_w_kinds</span>
<a name="line-213"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>args'</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-214"></a>
<a name="line-215"></a><a name="kcCheckApps"></a><span class='hs-definition'>kcCheckApps</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-216"></a>	    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span>     <span class='hs-comment'>-- The type being checked (for err messages only)</span>
<a name="line-217"></a>	    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpKind</span> 	       <span class='hs-comment'>-- Expected kind</span>
<a name="line-218"></a>	    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-219"></a><span class='hs-definition'>kcCheckApps</span> <span class='hs-varid'>the_fun</span> <span class='hs-varid'>fun_kind</span> <span class='hs-varid'>args</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-220"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>args_w_kinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitFunKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>the_fun</span><span class='hs-layout'>)</span> <span class='hs-num'>1</span> <span class='hs-varid'>fun_kind</span> <span class='hs-varid'>args</span>
<a name="line-221"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>args_w_kinds'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kc_lhs_types</span> <span class='hs-varid'>args_w_kinds</span>
<a name="line-222"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>res_kind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-223"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>args_w_kinds'</span> <span class='hs-layout'>}</span>
<a name="line-224"></a>
<a name="line-225"></a>
<a name="line-226"></a><a name="splitFunKind"></a><span class='hs-comment'>---------------------------</span>
<a name="line-227"></a><span class='hs-definition'>splitFunKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span><span class='hs-conid'>ExpKind</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-228"></a><span class='hs-definition'>splitFunKind</span> <span class='hs-keyword'>_</span>       <span class='hs-keyword'>_</span>      <span class='hs-varid'>fk</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>fk</span><span class='hs-layout'>)</span>
<a name="line-229"></a><span class='hs-definition'>splitFunKind</span> <span class='hs-varid'>the_fun</span> <span class='hs-varid'>arg_no</span> <span class='hs-varid'>fk</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-230"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_fk</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchExpectedFunKind</span> <span class='hs-varid'>fk</span>
<a name="line-231"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_fk</span> <span class='hs-keyword'>of</span>
<a name="line-232"></a>            <span class='hs-conid'>Nothing</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-varid'>too_many_args</span> 
<a name="line-233"></a>            <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ak</span><span class='hs-layout'>,</span><span class='hs-varid'>fk'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>aks</span><span class='hs-layout'>,</span> <span class='hs-varid'>rk</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitFunKind</span> <span class='hs-varid'>the_fun</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_no</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>fk'</span> <span class='hs-varid'>args</span>
<a name="line-234"></a>                                <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>arg</span>
<a name="line-235"></a>                                          <span class='hs-layout'>,</span><span class='hs-varid'>expArgKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotes</span> <span class='hs-varid'>the_fun</span><span class='hs-layout'>)</span> <span class='hs-varid'>ak</span> <span class='hs-varid'>arg_no</span><span class='hs-layout'>)</span>
<a name="line-236"></a>                                         <span class='hs-conop'>:</span><span class='hs-varid'>aks</span> <span class='hs-layout'>,</span><span class='hs-varid'>rk</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-237"></a>  <span class='hs-keyword'>where</span>
<a name="line-238"></a>    <span class='hs-varid'>too_many_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quotes</span> <span class='hs-varid'>the_fun</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-239"></a>		    <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is applied to too many type arguments"</span><span class='hs-layout'>)</span>
<a name="line-240"></a>
<a name="line-241"></a><a name="kcHsContext"></a><span class='hs-comment'>---------------------------</span>
<a name="line-242"></a><span class='hs-definition'>kcHsContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsContext</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsContext</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-243"></a><span class='hs-definition'>kcHsContext</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapLocM</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapM</span> <span class='hs-varid'>kcHsLPredType</span><span class='hs-layout'>)</span> <span class='hs-varid'>ctxt</span>
<a name="line-244"></a>
<a name="line-245"></a><a name="kcHsLPredType"></a><span class='hs-definition'>kcHsLPredType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-246"></a><span class='hs-definition'>kcHsLPredType</span> <span class='hs-varid'>pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kc_lhs_type</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>ekConstraint</span>
<a name="line-247"></a>
<a name="line-248"></a><a name="kcTyVar"></a><span class='hs-comment'>---------------------------</span>
<a name="line-249"></a><span class='hs-definition'>kcTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-250"></a><span class='hs-comment'>-- See Note [Type checking recursive type and class declarations]</span>
<a name="line-251"></a><span class='hs-comment'>-- in TcTyClsDecls</span>
<a name="line-252"></a><span class='hs-definition'>kcTyVar</span> <span class='hs-varid'>name</span>         <span class='hs-comment'>-- Could be a tyvar, a tycon, or a datacon</span>
<a name="line-253"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"lk1"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-254"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookup</span> <span class='hs-varid'>name</span>
<a name="line-255"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"lk2"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-256"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>thing</span> <span class='hs-keyword'>of</span>
<a name="line-257"></a>           <span class='hs-conid'>ATyVar</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrap_mono</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-258"></a>           <span class='hs-conid'>AThing</span> <span class='hs-varid'>kind</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrap_poly</span> <span class='hs-varid'>kind</span>
<a name="line-259"></a>           <span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrap_poly</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-260"></a>           <span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>ADataCon</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>kcDataCon</span> <span class='hs-varid'>dc</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>wrap_poly</span>
<a name="line-261"></a>           <span class='hs-keyword'>_</span>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrongThingErr</span> <span class='hs-str'>"type"</span> <span class='hs-varid'>thing</span> <span class='hs-varid'>name</span> <span class='hs-layout'>}</span>
<a name="line-262"></a>  <span class='hs-keyword'>where</span>
<a name="line-263"></a>    <span class='hs-varid'>wrap_mono</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"lk3"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-264"></a>                        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-265"></a>    <span class='hs-varid'>wrap_poly</span> <span class='hs-varid'>kind</span>
<a name="line-266"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>kvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrap_mono</span> <span class='hs-varid'>kind</span>
<a name="line-267"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-268"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"lk4"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-269"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>kvs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varid'>newMetaKindVar</span><span class='hs-layout'>)</span> <span class='hs-varid'>kvs</span>
<a name="line-270"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ki</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substKiWith</span> <span class='hs-varid'>kvs</span> <span class='hs-varid'>kvs'</span> <span class='hs-varid'>ki_body</span>
<a name="line-271"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrapTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpKiApps</span> <span class='hs-varid'>kvs'</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ki</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-272"></a>      <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ki_body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitForAllTys</span> <span class='hs-varid'>kind</span>
<a name="line-273"></a>
<a name="line-274"></a><a name="kcDataCon"></a><span class='hs-comment'>-- IA0_TODO: this function should disapear, and use the dcPromoted field of DataCon</span>
<a name="line-275"></a><span class='hs-definition'>kcDataCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcKind</span>
<a name="line-276"></a><span class='hs-definition'>kcDataCon</span> <span class='hs-varid'>dc</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-277"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConUserType</span> <span class='hs-varid'>dc</span>
<a name="line-278"></a>  <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isPromotableType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>promoteErr</span> <span class='hs-varid'>dc</span> <span class='hs-varid'>ty</span>
<a name="line-279"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>ki</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>promoteType</span> <span class='hs-varid'>ty</span>
<a name="line-280"></a>  <span class='hs-varid'>traceTc</span> <span class='hs-str'>"prm"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"~~&gt;"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ki</span><span class='hs-layout'>)</span>
<a name="line-281"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>ki</span>
<a name="line-282"></a>  <span class='hs-keyword'>where</span>
<a name="line-283"></a>    <span class='hs-varid'>promoteErr</span> <span class='hs-varid'>dc</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"of type"</span><span class='hs-layout'>)</span>
<a name="line-284"></a>      <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is not promotable"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-285"></a>
<a name="line-286"></a><a name="kcClass"></a><span class='hs-definition'>kcClass</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcKind</span>
<a name="line-287"></a><span class='hs-definition'>kcClass</span> <span class='hs-varid'>cls</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-comment'>-- Must be a class</span>
<a name="line-288"></a>    <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookup</span> <span class='hs-varid'>cls</span>
<a name="line-289"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>thing</span> <span class='hs-keyword'>of</span>
<a name="line-290"></a>        <span class='hs-conid'>AThing</span> <span class='hs-varid'>kind</span>                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>kind</span>
<a name="line-291"></a>        <span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-292"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConClass_maybe</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>classTyCon</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-293"></a>        <span class='hs-keyword'>_</span>                                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrongThingErr</span> <span class='hs-str'>"class"</span> <span class='hs-varid'>thing</span> <span class='hs-varid'>cls</span>
</pre>\end{code}


%************************************************************************
%*									*
		Desugaring
%*									*
%************************************************************************

Note [Desugaring types]
~~~~~~~~~~~~~~~~~~~~~~~
The type desugarer is phase 2 of dealing with HsTypes.  Specifically:

  * It transforms from HsType to Type

  * It zonks any kinds.  The returned type should have no mutable kind
    or type variables (hence returning Type not TcType):
      - any unconstrained kind variables are defaulted to AnyK just 
        as in TcHsSyn. 
      - there are no mutable type variables because we are 
        kind-checking a type
    Reason: the returned type may be put in a TyCon or DataCon where
    it will never subsequently be zonked.

You might worry about nested scopes:
        ..a:kappa in scope..
            let f :: forall b. T '[a,b] -> Int
In this case, f's type could have a mutable kind variable kappa in it;
and we might then default it to AnyK when dealing with f's type
signature.  But we don't expect this to happen because we can't get a
lexically scoped type variable with a mutable kind variable in it.  A
delicate point, this.  If it becomes an issue we might need to
distinguish top-level from nested uses.

Moreover
  * it cannot fail, 
  * it does no unifications
  * it does no validity checking, except for structural matters, such as
	(a) spurious ! annotations.
	(b) a class used as a type

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a><a name="zonkTcKindToKind"></a><span class='hs-definition'>zonkTcKindToKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Kind</span>
<a name="line-3"></a><span class='hs-comment'>-- When zonking a TcKind to a kind we instantiate kind variables to AnyK</span>
<a name="line-4"></a><span class='hs-definition'>zonkTcKindToKind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zonkType</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkZonkTcTyVar</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>anyKind</span><span class='hs-layout'>)</span> <span class='hs-varid'>mkTyVarTy</span><span class='hs-layout'>)</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="dsHsType"></a><span class='hs-definition'>dsHsType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-7"></a><span class='hs-comment'>-- All HsTyVarBndrs in the intput type are kind-annotated</span>
<a name="line-8"></a><span class='hs-comment'>-- See Note [Desugaring types]</span>
<a name="line-9"></a><span class='hs-definition'>dsHsType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ds_type</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="ds_type"></a><span class='hs-definition'>ds_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-12"></a><span class='hs-comment'>-- See Note [Desugaring types]</span>
<a name="line-13"></a><span class='hs-definition'>ds_type</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ds_app</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>[]</span>
<a name="line-15"></a>
<a name="line-16"></a><span class='hs-definition'>ds_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsParTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>		<span class='hs-comment'>-- Remove the parentheses markers</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dsHsType</span> <span class='hs-varid'>ty</span>
<a name="line-18"></a>
<a name="line-19"></a><span class='hs-definition'>ds_type</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsBangTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- No bangs should be here</span>
<a name="line-20"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Unexpected strictness annotation:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-21"></a>
<a name="line-22"></a><span class='hs-definition'>ds_type</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsRecTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>	    <span class='hs-comment'>-- No bangs should be here</span>
<a name="line-23"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Unexpected record type:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-24"></a>
<a name="line-25"></a><span class='hs-definition'>ds_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsKindSig</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-26"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dsHsType</span> <span class='hs-varid'>ty</span>	<span class='hs-comment'>-- Kind checking done already</span>
<a name="line-27"></a>
<a name="line-28"></a><span class='hs-definition'>ds_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsListTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-29"></a>    <span class='hs-varid'>tau_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsHsType</span> <span class='hs-varid'>ty</span>
<a name="line-30"></a>    <span class='hs-varid'>checkWiredInTyCon</span> <span class='hs-varid'>listTyCon</span>
<a name="line-31"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkListTy</span> <span class='hs-varid'>tau_ty</span><span class='hs-layout'>)</span>
<a name="line-32"></a>
<a name="line-33"></a><span class='hs-definition'>ds_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsPArrTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-34"></a>    <span class='hs-varid'>tau_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsHsType</span> <span class='hs-varid'>ty</span>
<a name="line-35"></a>    <span class='hs-varid'>checkWiredInTyCon</span> <span class='hs-varid'>parrTyCon</span>
<a name="line-36"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPArrTy</span> <span class='hs-varid'>tau_ty</span><span class='hs-layout'>)</span>
<a name="line-37"></a>
<a name="line-38"></a><span class='hs-definition'>ds_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTupleTy</span> <span class='hs-varid'>hs_con</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-39"></a>    <span class='hs-varid'>con</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>hs_con</span> <span class='hs-keyword'>of</span>
<a name="line-40"></a>        <span class='hs-conid'>HsUnboxedTuple</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>UnboxedTuple</span>
<a name="line-41"></a>        <span class='hs-conid'>HsBoxedTuple</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>BoxedTuple</span>
<a name="line-42"></a>        <span class='hs-conid'>HsConstraintTuple</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>ConstraintTuple</span>
<a name="line-43"></a>        <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"ds_type HsTupleTy"</span>
<a name="line-44"></a>        <span class='hs-comment'>-- failWithTc (ptext (sLit "Unexpected tuple component kind:") &lt;+&gt; ppr kind')</span>
<a name="line-45"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tupleTyCon</span> <span class='hs-varid'>con</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-46"></a>    <span class='hs-varid'>tau_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsHsTypes</span> <span class='hs-varid'>tys</span>
<a name="line-47"></a>    <span class='hs-varid'>checkWiredInTyCon</span> <span class='hs-varid'>tycon</span>
<a name="line-48"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>tau_tys</span><span class='hs-layout'>)</span>
<a name="line-49"></a>
<a name="line-50"></a><span class='hs-definition'>ds_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsFunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-51"></a>    <span class='hs-varid'>tau_ty1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsHsType</span> <span class='hs-varid'>ty1</span>
<a name="line-52"></a>    <span class='hs-varid'>tau_ty2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsHsType</span> <span class='hs-varid'>ty2</span>
<a name="line-53"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>tau_ty1</span> <span class='hs-varid'>tau_ty2</span><span class='hs-layout'>)</span>
<a name="line-54"></a>
<a name="line-55"></a><span class='hs-definition'>ds_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOpTy</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrap</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>span</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-56"></a>    <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>span</span> <span class='hs-layout'>(</span><span class='hs-varid'>ds_app</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrapTy</span> <span class='hs-varid'>wrap</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span><span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-57"></a>
<a name="line-58"></a><span class='hs-definition'>ds_type</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsAppTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-59"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ds_app</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>[]</span>
<a name="line-60"></a>
<a name="line-61"></a><span class='hs-definition'>ds_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIParamTy</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-62"></a>    <span class='hs-varid'>tau_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsHsType</span> <span class='hs-varid'>ty</span>
<a name="line-63"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkIPPred</span> <span class='hs-varid'>n</span> <span class='hs-varid'>tau_ty</span><span class='hs-layout'>)</span>
<a name="line-64"></a>
<a name="line-65"></a><span class='hs-definition'>ds_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsEqTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-66"></a>    <span class='hs-varid'>tau_ty1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsHsType</span> <span class='hs-varid'>ty1</span>
<a name="line-67"></a>    <span class='hs-varid'>tau_ty2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsHsType</span> <span class='hs-varid'>ty2</span>
<a name="line-68"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkEqPred</span> <span class='hs-layout'>(</span><span class='hs-varid'>tau_ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau_ty2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-69"></a>
<a name="line-70"></a><span class='hs-definition'>ds_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsForAllTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tv_names</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-71"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcTyVarBndrsKindGen</span> <span class='hs-varid'>tv_names</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>tyvars</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-72"></a>    <span class='hs-varid'>theta</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>dsHsType</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-73"></a>    <span class='hs-varid'>tau</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsHsType</span> <span class='hs-varid'>ty</span>
<a name="line-74"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSigmaTy</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>theta</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span>
<a name="line-75"></a>
<a name="line-76"></a><span class='hs-definition'>ds_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDocTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Remove the doc comment</span>
<a name="line-77"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dsHsType</span> <span class='hs-varid'>ty</span>
<a name="line-78"></a>
<a name="line-79"></a><span class='hs-definition'>ds_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSpliceTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> 
<a name="line-80"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkType</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkZonkTcTyVar</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>liftedTypeKind</span><span class='hs-layout'>)</span> <span class='hs-varid'>mkTyVarTy</span><span class='hs-layout'>)</span> 
<a name="line-81"></a>                           <span class='hs-varid'>kind</span>
<a name="line-82"></a>                     <span class='hs-comment'>-- See Note [Kind of a type splice]</span>
<a name="line-83"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>kind'</span> <span class='hs-layout'>}</span>
<a name="line-84"></a>
<a name="line-85"></a><span class='hs-definition'>ds_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsQuasiQuoteTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"ds_type"</span>	<span class='hs-comment'>-- Eliminated by renamer</span>
<a name="line-86"></a><span class='hs-definition'>ds_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCoreTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span>
<a name="line-87"></a>
<a name="line-88"></a><span class='hs-definition'>ds_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExplicitListTy</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-89"></a>  <span class='hs-varid'>kind'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcKindToKind</span> <span class='hs-varid'>kind</span>
<a name="line-90"></a>  <span class='hs-varid'>ds_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>dsHsType</span> <span class='hs-varid'>tys</span>
<a name="line-91"></a>  <span class='hs-varid'>return</span> <span class='hs-varop'>$</span>
<a name="line-92"></a>   <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>buildPromotedDataTyCon</span> <span class='hs-varid'>consDataCon</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>kind'</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-93"></a>         <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>buildPromotedDataTyCon</span> <span class='hs-varid'>nilDataCon</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>kind'</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-varid'>ds_tys</span>
<a name="line-94"></a>
<a name="line-95"></a><span class='hs-definition'>ds_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExplicitTupleTy</span> <span class='hs-varid'>kis</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-96"></a>  <span class='hs-conid'>MASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>length</span> <span class='hs-varid'>kis</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span>
<a name="line-97"></a>  <span class='hs-varid'>kis'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTcKindToKind</span> <span class='hs-varid'>kis</span>
<a name="line-98"></a>  <span class='hs-varid'>tys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>dsHsType</span> <span class='hs-varid'>tys</span>
<a name="line-99"></a>  <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>buildPromotedDataTyCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>tupleCon</span> <span class='hs-conid'>BoxedTuple</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>kis'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>kis'</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span>
<a name="line-100"></a>
<a name="line-101"></a><span class='hs-definition'>ds_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrapTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpKiApps</span> <span class='hs-varid'>kappas</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-102"></a>  <span class='hs-varid'>tau</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ds_type</span> <span class='hs-varid'>ty</span>
<a name="line-103"></a>  <span class='hs-varid'>kappas'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTcKindToKind</span> <span class='hs-varid'>kappas</span>
<a name="line-104"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppTys</span> <span class='hs-varid'>tau</span> <span class='hs-varid'>kappas'</span><span class='hs-layout'>)</span>
<a name="line-105"></a>
<a name="line-106"></a><a name="dsHsTypes"></a><span class='hs-definition'>dsHsTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-107"></a><span class='hs-definition'>dsHsTypes</span> <span class='hs-varid'>arg_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>dsHsType</span> <span class='hs-varid'>arg_tys</span>
</pre>\end{code}

Note [Kind of a type splice]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider these terms, each with TH type splice inside:
     [| e1 :: Maybe $(..blah..) |]
     [| e2 :: $(..blah..) |]
When kind-checking the type signature, we'll kind-check the splice
$(..blah..); we want to give it a kind that can fit in any context,
as if $(..blah..) :: forall k. k.  

In the e1 example, the context of the splice fixes kappa to *.  But
in the e2 example, we'll desugar the type, zonking the kind unification
variables as we go.  When we encournter the unconstrained kappa, we
want to default it to '*', not to AnyK.


Help functions for type applications
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

\begin{code}
<pre><a name="line-1"></a><a name="ds_app"></a><span class='hs-definition'>ds_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-2"></a><span class='hs-definition'>ds_app</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsAppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ds_app</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty2</span><span class='hs-conop'>:</span><span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-definition'>ds_app</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-6"></a>    <span class='hs-varid'>arg_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dsHsTypes</span> <span class='hs-varid'>tys</span>
<a name="line-7"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-8"></a>	<span class='hs-conid'>HsTyVar</span> <span class='hs-varid'>fun</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ds_var_app</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg_tys</span>
<a name="line-9"></a>	<span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>fun_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ds_type</span> <span class='hs-varid'>ty</span>
<a name="line-10"></a>                          <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppTys</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="ds_var_app"></a><span class='hs-definition'>ds_var_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-13"></a><span class='hs-comment'>-- See Note [Type checking recursive type and class declarations]</span>
<a name="line-14"></a><span class='hs-comment'>-- in TcTyClsDecls</span>
<a name="line-15"></a><span class='hs-definition'>ds_var_app</span> <span class='hs-varid'>name</span> <span class='hs-varid'>arg_tys</span> 
<a name="line-16"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTvNameSpace</span> <span class='hs-layout'>(</span><span class='hs-varid'>rdrNameSpace</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameRdrName</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-17"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookup</span> <span class='hs-varid'>name</span>
<a name="line-18"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>thing</span> <span class='hs-keyword'>of</span>
<a name="line-19"></a>           <span class='hs-conid'>ATyVar</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppTys</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span>
<a name="line-20"></a>	   <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrongThingErr</span> <span class='hs-str'>"type"</span> <span class='hs-varid'>thing</span> <span class='hs-varid'>name</span> <span class='hs-layout'>}</span>
<a name="line-21"></a>
<a name="line-22"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-23"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupGlobal</span> <span class='hs-varid'>name</span>
<a name="line-24"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>thing</span> <span class='hs-keyword'>of</span>
<a name="line-25"></a>           <span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span>
<a name="line-26"></a>           <span class='hs-conid'>ADataCon</span> <span class='hs-varid'>dc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>buildPromotedDataTyCon</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span> 
<a name="line-27"></a>	   <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrongThingErr</span> <span class='hs-str'>"type"</span> <span class='hs-layout'>(</span><span class='hs-conid'>AGlobal</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span> <span class='hs-layout'>}</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="addKcTypeCtxt"></a><span class='hs-definition'>addKcTypeCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-30"></a>	<span class='hs-comment'>-- Wrap a context around only if we want to show that contexts.  </span>
<a name="line-31"></a>	<span class='hs-comment'>-- Omit invisble ones and ones user's won't grok</span>
<a name="line-32"></a><span class='hs-definition'>addKcTypeCtxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>other_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeCtxt</span> <span class='hs-varid'>other_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing</span>
<a name="line-33"></a>
<a name="line-34"></a><a name="typeCtxt"></a><span class='hs-definition'>typeCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-35"></a><span class='hs-definition'>typeCtxt</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In the type"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*									*
		Type-variable binders
%*									*
%************************************************************************

Note [Kind-checking kind-polymorphic types]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider:
  f :: forall (f::k -> *) a. f a -> Int

Here, the [LHsTyVarBndr Name] of the forall type will be [f,a], where
  a is a  UserTyVar   -> type variable without kind annotation
  f is a  KindedTyVar -> type variable with kind annotation

If were were to allow binding sites for kind variables, thus
  f :: forall @k (f :: k -> *) a. f a -> Int
then we'd also need
  k is a   UserKiVar   -> kind variable (they don't need annotation,
                          since we only have BOX for a super kind)

\begin{code}
<pre><a name="line-1"></a><a name="kcHsTyVars"></a><span class='hs-definition'>kcHsTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> 
<a name="line-2"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> 	<span class='hs-comment'>-- These binders are kind-annotated</span>
<a name="line-3"></a>						<span class='hs-comment'>-- They scope over the thing inside</span>
<a name="line-4"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>r</span>
<a name="line-5"></a><span class='hs-definition'>kcHsTyVars</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kinded_tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapLocM</span> <span class='hs-varid'>kcHsTyVar</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs</span>
<a name="line-7"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcExtendKindEnvTvs</span> <span class='hs-varid'>kinded_tvs</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>}</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="kcHsTyVar"></a><span class='hs-definition'>kcHsTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsTyVarBndr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVarBndr</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-10"></a><span class='hs-comment'>-- Return a *kind-annotated* binder, whose PostTcKind is</span>
<a name="line-11"></a><span class='hs-comment'>-- initialised with a kind variable.</span>
<a name="line-12"></a><span class='hs-comment'>-- Typically the Kind inside the KindedTyVar will be a tyvar with a mutable kind </span>
<a name="line-13"></a><span class='hs-comment'>-- in it. We aren't yet sure whether the binder is a *type* variable or a *kind*</span>
<a name="line-14"></a><span class='hs-comment'>-- variable. See Note [Kind-checking kind-polymorphic types]</span>
<a name="line-15"></a><span class='hs-comment'>--</span>
<a name="line-16"></a><span class='hs-comment'>-- If the variable is already in scope return it, instead of introducing a new</span>
<a name="line-17"></a><span class='hs-comment'>-- one. This can occur in </span>
<a name="line-18"></a><span class='hs-comment'>--   instance C (a,b) where</span>
<a name="line-19"></a><span class='hs-comment'>--     type F (a,b) c = ...</span>
<a name="line-20"></a><span class='hs-comment'>-- Here a,b will be in scope when processing the associated type instance for F.</span>
<a name="line-21"></a><span class='hs-definition'>kcHsTyVar</span> <span class='hs-varid'>tyvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInLocalScope</span>
<a name="line-22"></a>                     <span class='hs-keyword'>if</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsTyVarName</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>)</span>
<a name="line-23"></a>                      <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>inscope_tyvar</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupTyVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsTyVarName</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>)</span>
<a name="line-24"></a>                              <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>UserTyVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarName</span> <span class='hs-varid'>inscope_tyvar</span><span class='hs-layout'>)</span>
<a name="line-25"></a>                                <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>inscope_tyvar</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-26"></a>                       <span class='hs-keyword'>else</span> <span class='hs-varid'>kcHsTyVar'</span> <span class='hs-varid'>tyvar</span>
<a name="line-27"></a>    <span class='hs-keyword'>where</span>
<a name="line-28"></a>        <span class='hs-varid'>kcHsTyVar'</span> <span class='hs-layout'>(</span><span class='hs-conid'>UserTyVar</span> <span class='hs-varid'>name</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UserTyVar</span> <span class='hs-varid'>name</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-29"></a>        <span class='hs-varid'>kcHsTyVar'</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindedTyVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-30"></a>          <span class='hs-varid'>kind'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>scDsLHsKind</span> <span class='hs-varid'>kind</span>
<a name="line-31"></a>          <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindedTyVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>kind'</span><span class='hs-layout'>)</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="tcTyVarBndrs"></a><span class='hs-comment'>------------------</span>
<a name="line-34"></a><span class='hs-definition'>tcTyVarBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- Kind-annotated binders, which need kind-zonking</span>
<a name="line-35"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-36"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>r</span>
<a name="line-37"></a><span class='hs-comment'>-- Used when type-checking types/classes/type-decls</span>
<a name="line-38"></a><span class='hs-comment'>-- Brings into scope immutable TyVars, not mutable ones that require later zonking</span>
<a name="line-39"></a><span class='hs-comment'>-- Fix #5426: avoid abstraction over kinds containing # or (#)</span>
<a name="line-40"></a><span class='hs-definition'>tcTyVarBndrs</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>thing_inside</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-41"></a>    <span class='hs-varid'>tyvars</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>zonk</span> <span class='hs-varop'>.</span> <span class='hs-varid'>hsTyVarNameKind</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>bndrs</span>
<a name="line-42"></a>    <span class='hs-varid'>tcExtendTyVarEnv</span> <span class='hs-varid'>tyvars</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing_inside</span> <span class='hs-varid'>tyvars</span><span class='hs-layout'>)</span>
<a name="line-43"></a>  <span class='hs-keyword'>where</span>
<a name="line-44"></a>    <span class='hs-varid'>zonk</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-45"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-varid'>kind</span>
<a name="line-46"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>noHashInKind</span> <span class='hs-varid'>kind'</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Kind signature contains # or (#)"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-47"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-48"></a>
<a name="line-49"></a><a name="tcTyVarBndrsKindGen"></a><span class='hs-definition'>tcTyVarBndrsKindGen</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>r</span>
<a name="line-50"></a><span class='hs-comment'>-- tcTyVarBndrsKindGen [(f :: ?k -&gt; *), (a :: ?k)] thing_inside</span>
<a name="line-51"></a><span class='hs-comment'>-- calls thing_inside with [(k :: BOX), (f :: k -&gt; *), (a :: k)]</span>
<a name="line-52"></a><span class='hs-definition'>tcTyVarBndrsKindGen</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-53"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>kinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsTyVarKind</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>bndrs</span>
<a name="line-54"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonked_kinds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kindGeneralizeKinds</span> <span class='hs-varid'>kinds</span>
<a name="line-55"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tyvars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>mkTyVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>hsLTyVarName</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>)</span> <span class='hs-varid'>zonked_kinds</span>
<a name="line-56"></a>             <span class='hs-varid'>ktvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tyvars</span>     <span class='hs-comment'>-- See Note [Kinds of quantified type variables]</span>
<a name="line-57"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcTyVarBndrsKindGen"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyvars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-58"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcExtendTyVarEnv</span> <span class='hs-varid'>ktvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing_inside</span> <span class='hs-varid'>ktvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}

Note [Kinds of quantified type variables]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
tcTyVarBndrsKindGen quantifies over a specified list of type variables,
*and* over the kind variables mentioned in the kinds of those tyvars.

Note that we must zonk those kinds (obviously) but less obviously, we
must return type variables whose kinds are zonked too. Example
    (a :: k7)  where  k7 := k9 -> k9
We must return
    [k9, a:k9->k9]
and NOT 
    [k9, a:k7]
Reason: we're going to turn this into a for-all type, 
   forall k9. forall (a:k7). blah
which the type checker will then instantiate, and instantiate does not
look through unification variables!  

Hence using zonked_kinds when forming 'tyvars'.

\begin{code}
<pre><a name="line-1"></a><a name="tcTyClTyVars"></a><span class='hs-definition'>tcTyClTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>	<span class='hs-comment'>-- LHS of the type or class decl</span>
<a name="line-2"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-3"></a><span class='hs-comment'>-- tcTyClTyVars T [a,b] calls thing_inside with</span>
<a name="line-4"></a><span class='hs-comment'>-- [k1,k2,a,b] (k2 -&gt; *)  where T : forall k1 k2 (a:k1 -&gt; *) (b:k1). k2 -&gt; *</span>
<a name="line-5"></a><span class='hs-comment'>--</span>
<a name="line-6"></a><span class='hs-comment'>-- No need to freshen the k's because they are just skolem </span>
<a name="line-7"></a><span class='hs-comment'>-- constants here, and we are at top level anyway.</span>
<a name="line-8"></a><span class='hs-definition'>tcTyClTyVars</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>thing_inside</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookup</span> <span class='hs-varid'>tycon</span>
<a name="line-10"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span>
<a name="line-11"></a>                 <span class='hs-keyword'>case</span> <span class='hs-varid'>thing</span> <span class='hs-keyword'>of</span>
<a name="line-12"></a>                   <span class='hs-conid'>AThing</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>kind</span>
<a name="line-13"></a>                   <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tcTyClTyVars"</span>
<a name="line-14"></a>                     <span class='hs-comment'>-- We only call tcTyClTyVars during typechecking in</span>
<a name="line-15"></a>                     <span class='hs-comment'>-- TcTyClDecls, where the local env is extended with</span>
<a name="line-16"></a>                     <span class='hs-comment'>-- the generalized_env (mapping Names to AThings).</span>
<a name="line-17"></a>             <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitForAllTys</span> <span class='hs-varid'>kind</span>
<a name="line-18"></a>             <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>kinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitKindFunTysN</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>names</span><span class='hs-layout'>)</span> <span class='hs-varid'>body</span>
<a name="line-19"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsLTyVarNames</span> <span class='hs-varid'>tyvars</span>
<a name="line-20"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>mkTyVar</span> <span class='hs-varid'>names</span> <span class='hs-varid'>kinds</span>
<a name="line-21"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>all_vs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>}</span>
<a name="line-22"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcExtendTyVarEnv</span> <span class='hs-varid'>all_vs</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing_inside</span> <span class='hs-varid'>all_vs</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-23"></a>
<a name="line-24"></a><a name="kindGeneralizeKinds"></a><span class='hs-comment'>-- Used when generalizing binders and type family patterns</span>
<a name="line-25"></a><span class='hs-comment'>-- It takes a kind from the type checker (like `k0 -&gt; *`), and returns the </span>
<a name="line-26"></a><span class='hs-comment'>-- final, kind-generalized kind (`forall k::BOX. k -&gt; *`)</span>
<a name="line-27"></a><span class='hs-definition'>kindGeneralizeKinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcKind</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>KindVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Kind</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-28"></a><span class='hs-comment'>-- INVARIANT: the returned kinds are zonked, and</span>
<a name="line-29"></a><span class='hs-comment'>--            mention the returned kind variables</span>
<a name="line-30"></a><span class='hs-definition'>kindGeneralizeKinds</span> <span class='hs-varid'>kinds</span> 
<a name="line-31"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- Quantify over kind variables free in</span>
<a name="line-32"></a>         <span class='hs-comment'>-- the kinds, and *not* in the environment</span>
<a name="line-33"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>zonked_kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-varid'>kinds</span>
<a name="line-34"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>gbl_tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetGlobalTyVars</span> <span class='hs-comment'>-- Already zonked</span>
<a name="line-35"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>kvs_to_quantify</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarsOfTypes</span> <span class='hs-varid'>zonked_kinds</span> 
<a name="line-36"></a>                               <span class='hs-varop'>`minusVarSet`</span> <span class='hs-varid'>gbl_tvs</span>
<a name="line-37"></a>
<a name="line-38"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>ASSERT2</span> <span class='hs-layout'>(</span><span class='hs-varid'>all</span> <span class='hs-varid'>isKiVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>varSetElems</span> <span class='hs-varid'>kvs_to_quantify</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kvs_to_quantify</span><span class='hs-layout'>)</span>
<a name="line-39"></a>                <span class='hs-varid'>zonkQuantifiedTyVars</span> <span class='hs-varid'>kvs_to_quantify</span>
<a name="line-40"></a>
<a name="line-41"></a>         <span class='hs-comment'>-- Zonk the kinds again, to pick up either the kind </span>
<a name="line-42"></a>         <span class='hs-comment'>-- variables we quantify over, or *, depending on whether</span>
<a name="line-43"></a>         <span class='hs-comment'>-- zonkQuantifiedTyVars decided to generalise (which in</span>
<a name="line-44"></a>         <span class='hs-comment'>-- turn depends on DataKinds)</span>
<a name="line-45"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>final_kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-varid'>zonked_kinds</span>
<a name="line-46"></a>
<a name="line-47"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"generalizeKind"</span> <span class='hs-layout'>(</span>    <span class='hs-varid'>ppr</span> <span class='hs-varid'>kinds</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kvs_to_quantify</span>
<a name="line-48"></a>                                   <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kvs</span>   <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>final_kinds</span><span class='hs-layout'>)</span>
<a name="line-49"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>final_kinds</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-50"></a>
<a name="line-51"></a><a name="kindGeneralizeKind"></a><span class='hs-definition'>kindGeneralizeKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>KindVar</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- these were flexi kind vars</span>
<a name="line-52"></a>                                    <span class='hs-layout'>,</span> <span class='hs-conid'>Kind</span> <span class='hs-layout'>)</span>     <span class='hs-comment'>-- this is the old kind where flexis got zonked</span>
<a name="line-53"></a><span class='hs-definition'>kindGeneralizeKind</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-54"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>kind'</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kindGeneralizeKinds</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>kind</span><span class='hs-keyglyph'>]</span>
<a name="line-55"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind'</span><span class='hs-layout'>)</span>
<a name="line-56"></a>
<a name="line-57"></a><a name="tcDataKindSig"></a><span class='hs-comment'>-----------------------------------</span>
<a name="line-58"></a><span class='hs-definition'>tcDataKindSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-59"></a><span class='hs-comment'>-- GADT decls can have a (perhaps partial) kind signature</span>
<a name="line-60"></a><span class='hs-comment'>--	e.g.  data T :: * -&gt; * -&gt; * where ...</span>
<a name="line-61"></a><span class='hs-comment'>-- This function makes up suitable (kinded) type variables for </span>
<a name="line-62"></a><span class='hs-comment'>-- the argument kinds, and checks that the result kind is indeed *.</span>
<a name="line-63"></a><span class='hs-comment'>-- We use it also to make up argument type variables for for data instances.</span>
<a name="line-64"></a><span class='hs-definition'>tcDataKindSig</span> <span class='hs-varid'>kind</span>
<a name="line-65"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>isLiftedTypeKind</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>badKindSig</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-66"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>span</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-67"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>us</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUniqueSupply</span> 
<a name="line-68"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>uniqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqsFromSupply</span> <span class='hs-varid'>us</span>
<a name="line-69"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>mk_tv</span> <span class='hs-varid'>span</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>str</span> <span class='hs-varid'>kind</span> 
<a name="line-70"></a>		 <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>kind</span><span class='hs-layout'>,</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>uniq</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>arg_kinds</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>dnames</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>uniqs</span> <span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-71"></a>  <span class='hs-keyword'>where</span>
<a name="line-72"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>arg_kinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitKindFunTys</span> <span class='hs-varid'>kind</span>
<a name="line-73"></a>    <span class='hs-varid'>mk_tv</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>str</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span>
<a name="line-74"></a>	<span class='hs-keyword'>where</span>
<a name="line-75"></a>	   <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInternalName</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>loc</span>
<a name="line-76"></a>	   <span class='hs-varid'>occ</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkOccName</span> <span class='hs-varid'>tvName</span> <span class='hs-varid'>str</span>
<a name="line-77"></a>	  
<a name="line-78"></a>    <span class='hs-varid'>dnames</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-chr'>'$'</span> <span class='hs-conop'>:</span><span class='hs-layout'>)</span> <span class='hs-varid'>names</span>	<span class='hs-comment'>-- Note [Avoid name clashes for associated data types]</span>
<a name="line-79"></a>
<a name="line-80"></a>    <span class='hs-varid'>names</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-81"></a>    <span class='hs-varid'>names</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>c</span><span class='hs-conop'>:</span><span class='hs-varid'>cs</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>cs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-str'>""</span> <span class='hs-conop'>:</span> <span class='hs-varid'>names</span><span class='hs-layout'>,</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-chr'>'a'</span><span class='hs-keyglyph'>..</span><span class='hs-chr'>'z'</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span> 
<a name="line-82"></a>
<a name="line-83"></a><a name="badKindSig"></a><span class='hs-definition'>badKindSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-84"></a><span class='hs-definition'>badKindSig</span> <span class='hs-varid'>kind</span> 
<a name="line-85"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Kind signature on data type declaration has non-* return kind"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-86"></a>	<span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
</pre>\end{code}

Note [Avoid name clashes for associated data types]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider    class C a b where
               data D b :: * -> *
When typechecking the decl for D, we'll invent an extra type variable for D,
to fill out its kind.  We *don't* want this type variable to be 'a', because
in an .hi file we'd get
            class C a b where
               data D b a 
which makes it look as if there are *two* type indices.  But there aren't!
So we use $a instead, which cannot clash with a user-written type variable.
Remember that type variable binders in interface files are just FastStrings,
not proper Names.

(The tidying phase can't help here because we don't tidy TyCons.  Another
alternative would be to record the number of indexing parameters in the 
interface file.)


%************************************************************************
%*									*
		Scoped type variables
%*									*
%************************************************************************


tcAddScopedTyVars is used for scoped type variables added by pattern
type signatures
	e.g.  \ ((x::a), (y::a)) -> x+y
They never have explicit kinds (because this is source-code only)
They are mutable (because they can get bound to a more specific type).

Usually we kind-infer and expand type splices, and then
tupecheck/desugar the type.  That doesn't work well for scoped type
variables, because they scope left-right in patterns.  (e.g. in the
example above, the 'a' in (y::a) is bound by the 'a' in (x::a).

The current not-very-good plan is to
  * find all the types in the patterns
  * find their free tyvars
  * do kind inference
  * bring the kinded type vars into scope
  * BUT throw away the kind-checked type
  	(we'll kind-check it again when we type-check the pattern)

This is bad because throwing away the kind checked type throws away
its splices.  But too bad for now.  [July 03]

Historical note:
    We no longer specify that these type variables must be univerally 
    quantified (lots of email on the subject).  If you want to put that 
    back in, you need to
	a) Do a checkSigTyVars after thing_inside
	b) More insidiously, don't pass in expected_ty, else
	   we unify with it too early and checkSigTyVars barfs
	   Instead you have to pass in a fresh ty var, and unify
	   it with expected_ty afterwards

\begin{code}
<pre><a name="line-1"></a><a name="tcHsPatSigType"></a><span class='hs-definition'>tcHsPatSigType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span>
<a name="line-2"></a>	       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> 		<span class='hs-comment'>-- The type signature</span>
<a name="line-3"></a>	       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> 	<span class='hs-comment'>-- Newly in-scope type variables</span>
<a name="line-4"></a>			<span class='hs-conid'>Type</span><span class='hs-layout'>)</span>		<span class='hs-comment'>-- The signature</span>
<a name="line-5"></a><span class='hs-comment'>-- Used for type-checking type signatures in</span>
<a name="line-6"></a><span class='hs-comment'>-- (a) patterns 	  e.g  f (x::Int) = e</span>
<a name="line-7"></a><span class='hs-comment'>-- (b) result signatures  e.g. g x :: Int = e</span>
<a name="line-8"></a><span class='hs-comment'>-- (c) RULE forall bndrs  e.g. forall (x::Int). f x = x</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-definition'>tcHsPatSigType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>hs_ty</span> 
<a name="line-11"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprHsSigCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-12"></a>    <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> 	<span class='hs-comment'>-- Find the type variables that are mentioned in the type</span>
<a name="line-13"></a>		<span class='hs-comment'>-- but not already in scope.  These are the ones that</span>
<a name="line-14"></a>		<span class='hs-comment'>-- should be bound by the pattern signature</span>
<a name="line-15"></a> 	  <span class='hs-varid'>in_scope</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInLocalScope</span>
<a name="line-16"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>span</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getLoc</span> <span class='hs-varid'>hs_ty</span>
<a name="line-17"></a>	      <span class='hs-varid'>sig_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>userHsTyVarBndrs</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>span</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> 
<a name="line-18"></a>			<span class='hs-varid'>filterOut</span> <span class='hs-varid'>in_scope</span> <span class='hs-varop'>$</span>
<a name="line-19"></a>                        <span class='hs-varid'>nameSetToList</span> <span class='hs-layout'>(</span><span class='hs-varid'>extractHsTyVars</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span>
<a name="line-20"></a>
<a name="line-21"></a>	<span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsQuantifiedType</span> <span class='hs-varid'>sig_tvs</span> <span class='hs-varid'>hs_ty</span>
<a name="line-22"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>checkValidType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig_ty</span> 
<a name="line-23"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span>
<a name="line-24"></a>      <span class='hs-layout'>}</span>
<a name="line-25"></a>
<a name="line-26"></a><a name="tcPatSig"></a><span class='hs-definition'>tcPatSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span>
<a name="line-27"></a>	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span>
<a name="line-28"></a>	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span>
<a name="line-29"></a>	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span>	   <span class='hs-comment'>-- The type to use for "inside" the signature</span>
<a name="line-30"></a>		 <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- The new bit of type environment, binding</span>
<a name="line-31"></a>				   <span class='hs-comment'>-- the scoped type variables</span>
<a name="line-32"></a>                 <span class='hs-conid'>HsWrapper</span><span class='hs-layout'>)</span>        <span class='hs-comment'>-- Coercion due to unification with actual ty</span>
<a name="line-33"></a>                                   <span class='hs-comment'>-- Of shape:  res_ty ~ sig_ty</span>
<a name="line-34"></a><span class='hs-definition'>tcPatSig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig</span> <span class='hs-varid'>res_ty</span>
<a name="line-35"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsPatSigType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig</span>
<a name="line-36"></a>    	<span class='hs-comment'>-- sig_tvs are the type variables free in 'sig', </span>
<a name="line-37"></a>	<span class='hs-comment'>-- and not already in scope. These are the ones</span>
<a name="line-38"></a>	<span class='hs-comment'>-- that should be brought into scope</span>
<a name="line-39"></a>
<a name="line-40"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>sig_tvs</span> <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-41"></a>		<span class='hs-comment'>-- The type signature binds no type variables, </span>
<a name="line-42"></a>		<span class='hs-comment'>-- and hence is rigid, so use it to zap the res_ty</span>
<a name="line-43"></a>                  <span class='hs-varid'>wrap</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSubType</span> <span class='hs-conid'>PatSigOrigin</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>sig_ty</span>
<a name="line-44"></a>		<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig_ty</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrap</span><span class='hs-layout'>)</span>
<a name="line-45"></a>        <span class='hs-layout'>}</span> <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-46"></a>		<span class='hs-comment'>-- Type signature binds at least one scoped type variable</span>
<a name="line-47"></a>	
<a name="line-48"></a>		<span class='hs-comment'>-- A pattern binding cannot bind scoped type variables</span>
<a name="line-49"></a>		<span class='hs-comment'>-- The renamer fails with a name-out-of-scope error </span>
<a name="line-50"></a>		<span class='hs-comment'>-- if a pattern binding tries to bind a type variable,</span>
<a name="line-51"></a>		<span class='hs-comment'>-- So we just have an ASSERT here</span>
<a name="line-52"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>in_pat_bind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>of</span>
<a name="line-53"></a>				<span class='hs-conid'>BindPatSigCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-54"></a>				<span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-55"></a>	<span class='hs-layout'>;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-varid'>in_pat_bind</span> <span class='hs-varop'>||</span> <span class='hs-varid'>null</span> <span class='hs-varid'>sig_tvs</span> <span class='hs-layout'>)</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-56"></a>
<a name="line-57"></a>		<span class='hs-comment'>-- Check that all newly-in-scope tyvars are in fact</span>
<a name="line-58"></a>		<span class='hs-comment'>-- constrained by the pattern.  This catches tiresome</span>
<a name="line-59"></a>		<span class='hs-comment'>-- cases like	</span>
<a name="line-60"></a>		<span class='hs-comment'>--	type T a = Int</span>
<a name="line-61"></a>		<span class='hs-comment'>--	f :: Int -&gt; Int</span>
<a name="line-62"></a>		<span class='hs-comment'>-- 	f (x :: T a) = ...</span>
<a name="line-63"></a>		<span class='hs-comment'>-- Here 'a' doesn't get a binding.  Sigh</span>
<a name="line-64"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>bad_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterOut</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>exactTyVarsOfType</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>sig_tvs</span>
<a name="line-65"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>bad_tvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>badPatSigTvs</span> <span class='hs-varid'>sig_ty</span> <span class='hs-varid'>bad_tvs</span><span class='hs-layout'>)</span>
<a name="line-66"></a>
<a name="line-67"></a>	<span class='hs-comment'>-- Now do a subsumption check of the pattern signature against res_ty</span>
<a name="line-68"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>sig_tvs'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInstSigTyVars</span> <span class='hs-varid'>sig_tvs</span>
<a name="line-69"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>sig_ty'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTyWith</span> <span class='hs-varid'>sig_tvs</span> <span class='hs-varid'>sig_tv_tys'</span> <span class='hs-varid'>sig_ty</span>
<a name="line-70"></a>              <span class='hs-varid'>sig_tv_tys'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>sig_tvs'</span>
<a name="line-71"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>wrap</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSubType</span> <span class='hs-conid'>PatSigOrigin</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>sig_ty'</span>
<a name="line-72"></a>
<a name="line-73"></a>	<span class='hs-comment'>-- Check that each is bound to a distinct type variable,</span>
<a name="line-74"></a>	<span class='hs-comment'>-- and one that is not already in scope</span>
<a name="line-75"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>binds_in_scope</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getScopedTyVarBinds</span>
<a name="line-76"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tv_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>tyVarName</span> <span class='hs-varid'>sig_tvs</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>sig_tv_tys'</span>
<a name="line-77"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>check</span> <span class='hs-varid'>binds_in_scope</span> <span class='hs-varid'>tv_binds</span>
<a name="line-78"></a>	
<a name="line-79"></a>	<span class='hs-comment'>-- Phew!</span>
<a name="line-80"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig_ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrap</span><span class='hs-layout'>)</span>
<a name="line-81"></a>        <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-82"></a>  <span class='hs-keyword'>where</span>
<a name="line-83"></a>    <span class='hs-varid'>check</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-84"></a>    <span class='hs-varid'>check</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>rest</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>check_one</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty</span>
<a name="line-85"></a>				      <span class='hs-layout'>;</span> <span class='hs-varid'>check</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>in_scope</span><span class='hs-layout'>)</span> <span class='hs-varid'>rest</span> <span class='hs-layout'>}</span>
<a name="line-86"></a>
<a name="line-87"></a>    <span class='hs-varid'>check_one</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty</span>
<a name="line-88"></a>	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>dups</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>dupInScope</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-varid'>dups</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-89"></a>		<span class='hs-comment'>-- Must not bind to the same type variable</span>
<a name="line-90"></a>		<span class='hs-comment'>-- as some other in-scope type variable</span>
<a name="line-91"></a>	<span class='hs-keyword'>where</span>
<a name="line-92"></a>	  <span class='hs-varid'>dups</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>n'</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>n'</span><span class='hs-layout'>,</span><span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>in_scope</span><span class='hs-layout'>,</span> <span class='hs-varid'>eqType</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
        Checking kinds
%*                                                                      *
%************************************************************************

We would like to get a decent error message from
  (a) Under-applied type constructors
             f :: (Maybe, Maybe)
  (b) Over-applied type constructors
             f :: Int x -> Int x

\begin{code}
<pre><a name="line-1"></a><a name="ExpKind"></a><span class='hs-comment'>-- The ExpKind datatype means "expected kind" and contains </span>
<a name="line-2"></a><a name="ExpKind"></a><span class='hs-comment'>-- some info about just why that kind is expected, to improve</span>
<a name="line-3"></a><a name="ExpKind"></a><span class='hs-comment'>-- the error message on a mis-match</span>
<a name="line-4"></a><a name="ExpKind"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ExpKind</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EK</span> <span class='hs-conid'>TcKind</span> <span class='hs-conid'>SDoc</span>
<a name="line-5"></a>
<a name="line-6"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>ExpKind</span> <span class='hs-keyword'>where</span>
<a name="line-7"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EK</span> <span class='hs-varid'>k</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Expected kind:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>k</span>
<a name="line-8"></a>
<a name="line-9"></a><a name="ekLifted"></a><span class='hs-definition'>ekLifted</span><span class='hs-layout'>,</span> <span class='hs-varid'>ekArg</span><span class='hs-layout'>,</span> <span class='hs-varid'>ekConstraint</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ExpKind</span>
<a name="line-10"></a><span class='hs-definition'>ekLifted</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EK</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Expected"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-11"></a><a name="ekArg"></a><span class='hs-definition'>ekArg</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EK</span> <span class='hs-varid'>argTypeKind</span>    <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Expected"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-12"></a><a name="ekConstraint"></a><span class='hs-definition'>ekConstraint</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EK</span> <span class='hs-varid'>constraintKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Expected"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="expArgKind"></a><span class='hs-comment'>-- Build an ExpKind for arguments</span>
<a name="line-15"></a><span class='hs-definition'>expArgKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpKind</span>
<a name="line-16"></a><span class='hs-definition'>expArgKind</span> <span class='hs-varid'>exp</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>arg_no</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EK</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>speakNth</span> <span class='hs-varid'>arg_no</span> 
<a name="line-17"></a>                                  <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"argument of"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>exp</span>
<a name="line-18"></a>                                  <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"should have"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-19"></a>
<a name="line-20"></a><a name="unifyKinds"></a><span class='hs-definition'>unifyKinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcKind</span>
<a name="line-21"></a><span class='hs-definition'>unifyKinds</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>act_kinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-22"></a>  <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-23"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>checkArgs</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_no</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>act_kind</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> 
<a name="line-24"></a>        <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>act_kind</span> <span class='hs-layout'>(</span><span class='hs-varid'>expArgKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotes</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>arg_no</span><span class='hs-layout'>)</span>
<a name="line-25"></a>  <span class='hs-varid'>mapM_</span> <span class='hs-varid'>checkArgs</span> <span class='hs-layout'>(</span><span class='hs-varid'>zip</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span><span class='hs-keyglyph'>..</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>act_kinds</span><span class='hs-layout'>)</span>
<a name="line-26"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>kind</span>
<a name="line-27"></a>
<a name="line-28"></a><a name="checkExpectedKind"></a><span class='hs-definition'>checkExpectedKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-29"></a><span class='hs-comment'>-- A fancy wrapper for 'unifyKind', which tries</span>
<a name="line-30"></a><span class='hs-comment'>-- to give decent error messages.</span>
<a name="line-31"></a><span class='hs-comment'>--      (checkExpectedKind ty act_kind exp_kind)</span>
<a name="line-32"></a><span class='hs-comment'>-- checks that the actual kind act_kind is compatible</span>
<a name="line-33"></a><span class='hs-comment'>--      with the expected kind exp_kind</span>
<a name="line-34"></a><span class='hs-comment'>-- The first argument, ty, is used only in the error message generation</span>
<a name="line-35"></a><span class='hs-definition'>checkExpectedKind</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>act_kind</span> <span class='hs-varid'>ek</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>EK</span> <span class='hs-varid'>exp_kind</span> <span class='hs-varid'>ek_ctxt</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-36"></a>    <span class='hs-varid'>traceTc</span> <span class='hs-str'>"checkExpectedKind"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>act_kind</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ek</span><span class='hs-layout'>)</span>
<a name="line-37"></a>    <span class='hs-layout'>(</span><span class='hs-sel'>_errs</span><span class='hs-layout'>,</span> <span class='hs-varid'>mb_r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tryTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>unifyKind</span> <span class='hs-varid'>act_kind</span> <span class='hs-varid'>exp_kind</span><span class='hs-layout'>)</span>
<a name="line-38"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_r</span> <span class='hs-keyword'>of</span>
<a name="line-39"></a>        <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>  <span class='hs-comment'>-- Unification succeeded</span>
<a name="line-40"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-41"></a>
<a name="line-42"></a>        <span class='hs-comment'>-- So there's definitely an error</span>
<a name="line-43"></a>        <span class='hs-comment'>-- Now to find out what sort</span>
<a name="line-44"></a>           <span class='hs-varid'>exp_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-45"></a>           <span class='hs-varid'>act_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-varid'>act_kind</span>
<a name="line-46"></a>
<a name="line-47"></a>           <span class='hs-varid'>env0</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInitTidyEnv</span>
<a name="line-48"></a>           <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>exp_as</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitKindFunTys</span> <span class='hs-varid'>exp_kind</span>
<a name="line-49"></a>               <span class='hs-layout'>(</span><span class='hs-varid'>act_as</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitKindFunTys</span> <span class='hs-varid'>act_kind</span>
<a name="line-50"></a>               <span class='hs-varid'>n_exp_as</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>exp_as</span>
<a name="line-51"></a>               <span class='hs-varid'>n_act_as</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>act_as</span>
<a name="line-52"></a>               <span class='hs-varid'>n_diff_as</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n_act_as</span> <span class='hs-comment'>-</span> <span class='hs-varid'>n_exp_as</span>
<a name="line-53"></a>
<a name="line-54"></a>               <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidy_exp_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenKind</span> <span class='hs-varid'>env0</span> <span class='hs-varid'>exp_kind</span>
<a name="line-55"></a>               <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidy_act_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenKind</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>act_kind</span>
<a name="line-56"></a>
<a name="line-57"></a>               <span class='hs-varid'>err</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n_exp_as</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>n_act_as</span>     <span class='hs-comment'>-- E.g. [Maybe]</span>
<a name="line-58"></a>                   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Expecting"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-59"></a>                     <span class='hs-varid'>speakN</span> <span class='hs-varid'>n_diff_as</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"more argument"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span>
<a name="line-60"></a>                     <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>n_diff_as</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>1</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'s'</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>empty</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-61"></a>                     <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"to"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-62"></a>
<a name="line-63"></a>                     <span class='hs-comment'>-- Now n_exp_as &gt;= n_act_as. In the next two cases,</span>
<a name="line-64"></a>                     <span class='hs-comment'>-- n_exp_as == 0, and hence so is n_act_as</span>
<a name="line-65"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isConstraintKind</span> <span class='hs-varid'>tidy_act_kind</span>
<a name="line-66"></a>                   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Predicate"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"used as a type"</span>
<a name="line-67"></a>                   
<a name="line-68"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isConstraintKind</span> <span class='hs-varid'>tidy_exp_kind</span>
<a name="line-69"></a>                   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Type of kind"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tidy_act_kind</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"used as a constraint"</span>
<a name="line-70"></a>                   
<a name="line-71"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isLiftedTypeKind</span> <span class='hs-varid'>exp_kind</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isUnliftedTypeKind</span> <span class='hs-varid'>act_kind</span>
<a name="line-72"></a>                   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Expecting a lifted type, but"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-73"></a>                       <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is unlifted"</span><span class='hs-layout'>)</span>
<a name="line-74"></a>
<a name="line-75"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isUnliftedTypeKind</span> <span class='hs-varid'>exp_kind</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isLiftedTypeKind</span> <span class='hs-varid'>act_kind</span>
<a name="line-76"></a>                   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Expecting an unlifted type, but"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-77"></a>                       <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is lifted"</span><span class='hs-layout'>)</span>
<a name="line-78"></a>
<a name="line-79"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>               <span class='hs-comment'>-- E.g. Monad [Int]</span>
<a name="line-80"></a>                   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Kind mis-match"</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>more_info</span>
<a name="line-81"></a>
<a name="line-82"></a>               <span class='hs-varid'>more_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ek_ctxt</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"kind"</span><span class='hs-layout'>)</span> 
<a name="line-83"></a>                                    <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprKind</span> <span class='hs-varid'>tidy_exp_kind</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span><span class='hs-layout'>,</span>
<a name="line-84"></a>                                 <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"but"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-85"></a>                                     <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"has kind"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprKind</span> <span class='hs-varid'>tidy_act_kind</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-86"></a>
<a name="line-87"></a>           <span class='hs-varid'>failWithTcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
        Sort checking kinds
%*                                                                      *
%************************************************************************

scDsLHsKind converts a user-written kind to an internal, sort-checked kind.
It does sort checking and desugaring at the same time, in one single pass.
It fails when the kinds are not well-formed (eg. data A :: * Int), or if there
are non-promotable or non-fully applied kinds.

\begin{code}
<pre><a name="line-1"></a><a name="scDsLHsKind"></a><span class='hs-definition'>scDsLHsKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsKind</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Kind</span>
<a name="line-2"></a><span class='hs-definition'>scDsLHsKind</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In the kind"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-3"></a>                  <span class='hs-varid'>sc_ds_lhs_kind</span> <span class='hs-varid'>k</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="scDsLHsMaybeKind"></a><span class='hs-definition'>scDsLHsMaybeKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsKind</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Kind</span><span class='hs-layout'>)</span>
<a name="line-6"></a><span class='hs-definition'>scDsLHsMaybeKind</span> <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-7"></a><span class='hs-definition'>scDsLHsMaybeKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>k'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>scDsLHsKind</span> <span class='hs-varid'>k</span>
<a name="line-8"></a>                               <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>k'</span><span class='hs-layout'>)</span>
<a name="line-9"></a>
<a name="line-10"></a><a name="sc_ds_lhs_kind"></a><span class='hs-definition'>sc_ds_lhs_kind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsKind</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Kind</span>
<a name="line-11"></a><span class='hs-definition'>sc_ds_lhs_kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>span</span> <span class='hs-varid'>ki</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>span</span> <span class='hs-layout'>(</span><span class='hs-varid'>sc_ds_hs_kind</span> <span class='hs-varid'>ki</span><span class='hs-layout'>)</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="sc_ds_hs_kind"></a><span class='hs-comment'>-- The main worker</span>
<a name="line-14"></a><span class='hs-definition'>sc_ds_hs_kind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsKind</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Kind</span>
<a name="line-15"></a><span class='hs-definition'>sc_ds_hs_kind</span> <span class='hs-varid'>k</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sc_ds_app</span> <span class='hs-varid'>k</span> <span class='hs-conid'>[]</span>
<a name="line-16"></a><span class='hs-definition'>sc_ds_hs_kind</span> <span class='hs-varid'>k</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsAppTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sc_ds_app</span> <span class='hs-varid'>k</span> <span class='hs-conid'>[]</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-definition'>sc_ds_hs_kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsParTy</span> <span class='hs-varid'>ki</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sc_ds_lhs_kind</span> <span class='hs-varid'>ki</span>
<a name="line-19"></a>
<a name="line-20"></a><span class='hs-definition'>sc_ds_hs_kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsFunTy</span> <span class='hs-varid'>ki1</span> <span class='hs-varid'>ki2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-21"></a>  <span class='hs-keyword'>do</span> <span class='hs-varid'>kappa_ki1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sc_ds_lhs_kind</span> <span class='hs-varid'>ki1</span>
<a name="line-22"></a>     <span class='hs-varid'>kappa_ki2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sc_ds_lhs_kind</span> <span class='hs-varid'>ki2</span>
<a name="line-23"></a>     <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkArrowKind</span> <span class='hs-varid'>kappa_ki1</span> <span class='hs-varid'>kappa_ki2</span><span class='hs-layout'>)</span>
<a name="line-24"></a>
<a name="line-25"></a><span class='hs-definition'>sc_ds_hs_kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsListTy</span> <span class='hs-varid'>ki</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-26"></a>  <span class='hs-keyword'>do</span> <span class='hs-varid'>kappa</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sc_ds_lhs_kind</span> <span class='hs-varid'>ki</span>
<a name="line-27"></a>     <span class='hs-varid'>checkWiredInTyCon</span> <span class='hs-varid'>listTyCon</span>
<a name="line-28"></a>     <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkListTy</span> <span class='hs-varid'>kappa</span>
<a name="line-29"></a>
<a name="line-30"></a><span class='hs-definition'>sc_ds_hs_kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTupleTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>kis</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-31"></a>  <span class='hs-keyword'>do</span> <span class='hs-varid'>kappas</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>sc_ds_lhs_kind</span> <span class='hs-varid'>kis</span>
<a name="line-32"></a>     <span class='hs-varid'>checkWiredInTyCon</span> <span class='hs-varid'>tycon</span>
<a name="line-33"></a>     <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>kappas</span>
<a name="line-34"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tupleTyCon</span> <span class='hs-conid'>BoxedTuple</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>kis</span><span class='hs-layout'>)</span>
<a name="line-35"></a>
<a name="line-36"></a><span class='hs-comment'>-- Argument not kind-shaped</span>
<a name="line-37"></a><span class='hs-definition'>sc_ds_hs_kind</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-layout'>(</span><span class='hs-str'>"sc_ds_hs_kind: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>showPpr</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>
<a name="line-38"></a>
<a name="line-39"></a><a name="sc_ds_app"></a><span class='hs-comment'>-- Special case for kind application</span>
<a name="line-40"></a><span class='hs-definition'>sc_ds_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsKind</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsKind</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Kind</span>
<a name="line-41"></a><span class='hs-definition'>sc_ds_app</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsAppTy</span> <span class='hs-varid'>ki1</span> <span class='hs-varid'>ki2</span><span class='hs-layout'>)</span> <span class='hs-varid'>kis</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sc_ds_app</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>ki1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ki2</span><span class='hs-conop'>:</span><span class='hs-varid'>kis</span><span class='hs-layout'>)</span>
<a name="line-42"></a><span class='hs-definition'>sc_ds_app</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>      <span class='hs-varid'>kis</span> <span class='hs-keyglyph'>=</span>
<a name="line-43"></a>  <span class='hs-keyword'>do</span> <span class='hs-varid'>arg_kis</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>sc_ds_lhs_kind</span> <span class='hs-varid'>kis</span>
<a name="line-44"></a>     <span class='hs-varid'>sc_ds_var_app</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>arg_kis</span>
<a name="line-45"></a><span class='hs-definition'>sc_ds_app</span> <span class='hs-varid'>ki</span>                <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ki</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> 
<a name="line-46"></a>                                    <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is not a kind constructor"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-47"></a>
<a name="line-48"></a><a name="sc_ds_var_app"></a><span class='hs-comment'>-- IA0_TODO: With explicit kind polymorphism I might need to add ATyVar</span>
<a name="line-49"></a><span class='hs-definition'>sc_ds_var_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Kind</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Kind</span>
<a name="line-50"></a><span class='hs-comment'>-- Special case for * and Constraint kinds</span>
<a name="line-51"></a><span class='hs-definition'>sc_ds_var_app</span> <span class='hs-varid'>name</span> <span class='hs-varid'>arg_kis</span>
<a name="line-52"></a>  <span class='hs-keyglyph'>|</span>    <span class='hs-varid'>name</span> <span class='hs-varop'>==</span> <span class='hs-varid'>liftedTypeKindTyConName</span>
<a name="line-53"></a>    <span class='hs-varop'>||</span> <span class='hs-varid'>name</span> <span class='hs-varop'>==</span> <span class='hs-varid'>constraintKindTyConName</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-54"></a>    <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>arg_kis</span><span class='hs-layout'>)</span>
<a name="line-55"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Kind"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"cannot be applied"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-56"></a>    <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookup</span> <span class='hs-varid'>name</span>
<a name="line-57"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>thing</span> <span class='hs-keyword'>of</span>
<a name="line-58"></a>      <span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-59"></a>      <span class='hs-keyword'>_</span>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"sc_ds_var_app 1"</span>
<a name="line-60"></a>
<a name="line-61"></a><span class='hs-comment'>-- General case</span>
<a name="line-62"></a><span class='hs-definition'>sc_ds_var_app</span> <span class='hs-varid'>name</span> <span class='hs-varid'>arg_kis</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-63"></a>  <span class='hs-layout'>(</span><span class='hs-sel'>_errs</span><span class='hs-layout'>,</span> <span class='hs-varid'>mb_thing</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tryTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcLookup</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-64"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_thing</span> <span class='hs-keyword'>of</span>
<a name="line-65"></a>    <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-66"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isAlgTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isTupleTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-67"></a>      <span class='hs-varid'>data_kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_DataKinds</span>
<a name="line-68"></a>      <span class='hs-varid'>unless</span> <span class='hs-varid'>data_kinds</span> <span class='hs-varop'>$</span> <span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataKindsErr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-69"></a>      <span class='hs-keyword'>let</span> <span class='hs-varid'>tc_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span>
<a name="line-70"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>isPromotableKind</span> <span class='hs-varid'>tc_kind</span> <span class='hs-keyword'>of</span>
<a name="line-71"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>arg_kis</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-72"></a>          <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPromotedTypeTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_kis</span><span class='hs-layout'>)</span>
<a name="line-73"></a>        <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>err</span> <span class='hs-varid'>tc_kind</span> <span class='hs-str'>"is not fully applied"</span>
<a name="line-74"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>err</span> <span class='hs-varid'>tc_kind</span> <span class='hs-str'>"is not promotable"</span>
<a name="line-75"></a>    <span class='hs-comment'>-- It is in scope, but not what we expected</span>
<a name="line-76"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrongThingErr</span> <span class='hs-str'>"promoted type"</span> <span class='hs-varid'>thing</span> <span class='hs-varid'>name</span>
<a name="line-77"></a>    <span class='hs-comment'>-- It is not in scope, but it passed the renamer: staging error</span>
<a name="line-78"></a>    <span class='hs-conid'>Nothing</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT2</span> <span class='hs-layout'>(</span> <span class='hs-varid'>isTyConName</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-layout'>)</span>
<a name="line-79"></a>                  <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Promoted kind"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> 
<a name="line-80"></a>                              <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-81"></a>                              <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"used in a mutually recursive group"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-82"></a>
<a name="line-83"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>err</span> <span class='hs-varid'>k</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span>    <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"of kind"</span><span class='hs-layout'>)</span>
<a name="line-84"></a>                              <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>    <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-85"></a>
</pre>\end{code}

%************************************************************************
%*									*
		Scoped type variables
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="pprHsSigCtxt"></a><span class='hs-definition'>pprHsSigCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2"></a><span class='hs-definition'>pprHsSigCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>hs_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprUserTypeCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span><span class='hs-layout'>,</span> 
<a name="line-3"></a>				 <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pp_sig</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-4"></a>  <span class='hs-keyword'>where</span>
<a name="line-5"></a>    <span class='hs-varid'>pp_sig</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunSigCtxt</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pp_n_colon</span> <span class='hs-varid'>n</span>
<a name="line-6"></a>    <span class='hs-varid'>pp_sig</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConArgCtxt</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pp_n_colon</span> <span class='hs-varid'>n</span>
<a name="line-7"></a>    <span class='hs-varid'>pp_sig</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForSigCtxt</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pp_n_colon</span> <span class='hs-varid'>n</span>
<a name="line-8"></a>    <span class='hs-varid'>pp_sig</span> <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span>
<a name="line-9"></a>
<a name="line-10"></a>    <span class='hs-varid'>pp_n_colon</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="badPatSigTvs"></a><span class='hs-definition'>badPatSigTvs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-13"></a><span class='hs-definition'>badPatSigTvs</span> <span class='hs-varid'>sig_ty</span> <span class='hs-varid'>bad_tvs</span>
<a name="line-14"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>fsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The type variable"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>plural</span> <span class='hs-varid'>bad_tvs</span><span class='hs-layout'>,</span> 
<a name="line-15"></a>                 <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprWithCommas</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>bad_tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> 
<a name="line-16"></a>          	 <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"should be bound by the pattern signature"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-17"></a>	  	 <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"but are actually discarded by a type synonym"</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-18"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"To fix this, expand the type synonym"</span><span class='hs-layout'>)</span> 
<a name="line-19"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"[Note: I hope to lift this restriction in due course]"</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-20"></a>
<a name="line-21"></a><a name="dupInScope"></a><span class='hs-definition'>dupInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-22"></a><span class='hs-definition'>dupInScope</span> <span class='hs-varid'>n</span> <span class='hs-varid'>n'</span> <span class='hs-keyword'>_</span>
<a name="line-23"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The scoped type variables"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"and"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>n'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-24"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"are bound to the same type (variable)"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-25"></a>		<span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Distinct scoped type variables must be distinct"</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
</pre>\end{code}

</body>
</html>
