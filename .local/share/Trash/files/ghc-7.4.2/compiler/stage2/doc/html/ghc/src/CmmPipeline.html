<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>cmm/CmmPipeline.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS_GHC -XNoMonoLocalBinds #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- Norman likes local bindings</span>
<a name="line-3"></a><span class='hs-comment'>-- If this module lives on I'd like to get rid of this flag in due course</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>CmmPipeline</span> <span class='hs-layout'>(</span>
<a name="line-6"></a>  <span class='hs-comment'>-- | Converts C-- with an implicit stack and native C-- calls into</span>
<a name="line-7"></a>  <span class='hs-comment'>-- optimized, CPS converted and native-call-less C--.  The latter</span>
<a name="line-8"></a>  <span class='hs-comment'>-- C-- can be used to generate assembly.</span>
<a name="line-9"></a>  <span class='hs-varid'>cmmPipeline</span>
<a name="line-10"></a><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CLabel</span>
<a name="line-13"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Cmm</span>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CmmLive</span>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CmmBuildInfoTables</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CmmCommonBlockElim</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CmmProcPoint</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CmmSpillReload</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CmmRewriteAssignments</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CmmStackLayout</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CmmContFlowOpt</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OptimizationFuel</span>
<a name="line-23"></a>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ErrUtils</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HscTypes</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Maybe</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-layout'>)</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Map</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>StaticFlags</span>
<a name="line-33"></a>
<a name="line-34"></a><a name="cmmPipeline"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-35"></a><span class='hs-comment'>-- | Top level driver for C-- pipeline</span>
<a name="line-36"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-37"></a><span class='hs-comment'>-- There are two complications here:</span>
<a name="line-38"></a><span class='hs-comment'>-- 1. We need to compile the procedures in two stages because we need</span>
<a name="line-39"></a><span class='hs-comment'>--    an analysis of the procedures to tell us what CAFs they use.</span>
<a name="line-40"></a><span class='hs-comment'>--    The first stage returns a map from procedure labels to CAFs,</span>
<a name="line-41"></a><span class='hs-comment'>--    along with a closure that will compute SRTs and attach them to</span>
<a name="line-42"></a><span class='hs-comment'>--    the compiled procedures.</span>
<a name="line-43"></a><span class='hs-comment'>--    The second stage is to combine the CAF information into a top-level</span>
<a name="line-44"></a><span class='hs-comment'>--    CAF environment mapping non-static closures to the CAFs they keep live,</span>
<a name="line-45"></a><span class='hs-comment'>--    then pass that environment to the closures returned in the first</span>
<a name="line-46"></a><span class='hs-comment'>--    stage of compilation.</span>
<a name="line-47"></a><span class='hs-comment'>-- 2. We need to thread the module's SRT around when the SRT tables</span>
<a name="line-48"></a><span class='hs-comment'>--    are computed for each procedure.</span>
<a name="line-49"></a><span class='hs-comment'>--    The SRT needs to be threaded because it is grown lazily.</span>
<a name="line-50"></a><span class='hs-comment'>-- 3. We run control flow optimizations twice, once before any pipeline</span>
<a name="line-51"></a><span class='hs-comment'>--    work is done, and once again at the very end on all of the</span>
<a name="line-52"></a><span class='hs-comment'>--    resulting C-- blocks.  EZY: It's unclear whether or not whether</span>
<a name="line-53"></a><span class='hs-comment'>--    we actually need to do the initial pass.</span>
<a name="line-54"></a><span class='hs-definition'>cmmPipeline</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-comment'>-- Compilation env including</span>
<a name="line-55"></a>                       <span class='hs-comment'>-- dynamic flags: -dcmm-lint -ddump-cps-cmm</span>
<a name="line-56"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TopSRT</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmGroup</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- SRT table and accumulating list of compiled procs</span>
<a name="line-57"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmGroup</span>             <span class='hs-comment'>-- Input C-- with Procedures</span>
<a name="line-58"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>TopSRT</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmGroup</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Output CPS transformed C--</span>
<a name="line-59"></a><span class='hs-definition'>cmmPipeline</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>topSRT</span><span class='hs-layout'>,</span> <span class='hs-varid'>rst</span><span class='hs-layout'>)</span> <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>=</span>
<a name="line-60"></a>  <span class='hs-keyword'>do</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-61"></a>     <span class='hs-comment'>--</span>
<a name="line-62"></a>     <span class='hs-varid'>showPass</span> <span class='hs-varid'>dflags</span> <span class='hs-str'>"CPSZ"</span>
<a name="line-63"></a>
<a name="line-64"></a>     <span class='hs-keyword'>let</span> <span class='hs-varid'>tops</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runCmmContFlowOpts</span> <span class='hs-varid'>prog</span>
<a name="line-65"></a>     <span class='hs-layout'>(</span><span class='hs-varid'>cafEnvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tops</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftM</span> <span class='hs-varid'>unzip</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>cpsTop</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tops</span>
<a name="line-66"></a>     <span class='hs-comment'>-- tops :: [[(CmmDecl,CAFSet]]  (one list per group)</span>
<a name="line-67"></a>
<a name="line-68"></a>     <span class='hs-keyword'>let</span> <span class='hs-varid'>topCAFEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTopCAFInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>concat</span> <span class='hs-varid'>cafEnvs</span><span class='hs-layout'>)</span>
<a name="line-69"></a>
<a name="line-70"></a>     <span class='hs-comment'>-- folding over the groups</span>
<a name="line-71"></a>     <span class='hs-layout'>(</span><span class='hs-varid'>topSRT</span><span class='hs-layout'>,</span> <span class='hs-varid'>tops</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>foldM</span> <span class='hs-layout'>(</span><span class='hs-varid'>toTops</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>topCAFEnv</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>topSRT</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-varid'>tops</span>
<a name="line-72"></a>
<a name="line-73"></a>     <span class='hs-keyword'>let</span> <span class='hs-varid'>cmms</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmGroup</span>
<a name="line-74"></a>         <span class='hs-varid'>cmms</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reverse</span> <span class='hs-layout'>(</span><span class='hs-varid'>concat</span> <span class='hs-varid'>tops</span><span class='hs-layout'>)</span>
<a name="line-75"></a>
<a name="line-76"></a>     <span class='hs-varid'>dumpIfSet_dyn</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Opt_D_dump_cps_cmm</span> <span class='hs-str'>"Post CPS Cmm"</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprPlatform</span> <span class='hs-layout'>(</span><span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varid'>cmms</span><span class='hs-layout'>)</span>
<a name="line-77"></a>
<a name="line-78"></a>     <span class='hs-comment'>-- SRT is not affected by control flow optimization pass</span>
<a name="line-79"></a>     <span class='hs-keyword'>let</span> <span class='hs-varid'>prog'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runCmmContFlowOpts</span> <span class='hs-varid'>cmms</span>
<a name="line-80"></a>
<a name="line-81"></a>     <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>topSRT</span><span class='hs-layout'>,</span> <span class='hs-varid'>prog'</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rst</span><span class='hs-layout'>)</span>
<a name="line-82"></a>
<a name="line-83"></a><span class='hs-comment'>{- [Note global fuel]
<a name="line-84"></a>~~~~~~~~~~~~~~~~~~~~~
<a name="line-85"></a>The identity and the last pass are stored in
<a name="line-86"></a>mutable reference cells in an 'HscEnv' and are
<a name="line-87"></a>global to one compiler session.
<a name="line-88"></a>-}</span>
<a name="line-89"></a>
<a name="line-90"></a><span class='hs-comment'>-- EZY: It might be helpful to have an easy way of dumping the "pre"</span>
<a name="line-91"></a><span class='hs-comment'>-- input for any given phase, besides just turning it all on with</span>
<a name="line-92"></a><span class='hs-comment'>-- -ddump-cmmz</span>
<a name="line-93"></a>
<a name="line-94"></a><a name="cpsTop"></a><span class='hs-definition'>cpsTop</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmDecl</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>CLabel</span><span class='hs-layout'>,</span> <span class='hs-conid'>CAFSet</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>CAFSet</span><span class='hs-layout'>,</span> <span class='hs-conid'>CmmDecl</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-95"></a><span class='hs-definition'>cpsTop</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>p</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CmmData</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span><span class='hs-layout'>,</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-96"></a><span class='hs-definition'>cpsTop</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmProc</span> <span class='hs-varid'>h</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TopInfo</span> <span class='hs-layout'>{</span><span class='hs-varid'>stack_info</span><span class='hs-keyglyph'>=</span><span class='hs-conid'>StackInfo</span> <span class='hs-layout'>{</span><span class='hs-varid'>arg_space</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>entry_off</span><span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>l</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-97"></a>    <span class='hs-keyword'>do</span>
<a name="line-98"></a>       <span class='hs-comment'>-- Why bother doing these early: dualLivenessWithInsertion,</span>
<a name="line-99"></a>       <span class='hs-comment'>-- insertLateReloads, rewriteAssignments?</span>
<a name="line-100"></a>
<a name="line-101"></a>       <span class='hs-comment'>----------- Eliminate common blocks -------------------</span>
<a name="line-102"></a>       <span class='hs-varid'>g</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>elimCommonBlocks</span> <span class='hs-varid'>g</span>
<a name="line-103"></a>       <span class='hs-varid'>dumpPlatform</span> <span class='hs-varid'>platform</span> <span class='hs-conid'>Opt_D_dump_cmmz_cbe</span> <span class='hs-str'>"Post common block elimination"</span> <span class='hs-varid'>g</span>
<a name="line-104"></a>       <span class='hs-comment'>-- Any work storing block Labels must be performed _after_ elimCommonBlocks</span>
<a name="line-105"></a>
<a name="line-106"></a>       <span class='hs-comment'>----------- Proc points -------------------</span>
<a name="line-107"></a>       <span class='hs-keyword'>let</span> <span class='hs-varid'>callPPs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>callProcPoints</span> <span class='hs-varid'>g</span>
<a name="line-108"></a>       <span class='hs-varid'>procPoints</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>run</span> <span class='hs-varop'>$</span> <span class='hs-varid'>minimalProcPointSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varid'>callPPs</span> <span class='hs-varid'>g</span>
<a name="line-109"></a>       <span class='hs-varid'>g</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>run</span> <span class='hs-varop'>$</span> <span class='hs-varid'>addProcPointProtocols</span> <span class='hs-varid'>callPPs</span> <span class='hs-varid'>procPoints</span> <span class='hs-varid'>g</span>
<a name="line-110"></a>       <span class='hs-varid'>dumpPlatform</span> <span class='hs-varid'>platform</span> <span class='hs-conid'>Opt_D_dump_cmmz_proc</span> <span class='hs-str'>"Post Proc Points Added"</span> <span class='hs-varid'>g</span>
<a name="line-111"></a>
<a name="line-112"></a>       <span class='hs-comment'>----------- Spills and reloads -------------------</span>
<a name="line-113"></a>       <span class='hs-varid'>g</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>run</span> <span class='hs-varop'>$</span> <span class='hs-varid'>dualLivenessWithInsertion</span> <span class='hs-varid'>procPoints</span> <span class='hs-varid'>g</span>
<a name="line-114"></a>       <span class='hs-varid'>dumpPlatform</span> <span class='hs-varid'>platform</span> <span class='hs-conid'>Opt_D_dump_cmmz_spills</span> <span class='hs-str'>"Post spills and reloads"</span> <span class='hs-varid'>g</span>
<a name="line-115"></a>
<a name="line-116"></a>       <span class='hs-comment'>----------- Sink and inline assignments -------------------</span>
<a name="line-117"></a>       <span class='hs-varid'>g</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runOptimization</span> <span class='hs-varop'>$</span> <span class='hs-varid'>rewriteAssignments</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>g</span>
<a name="line-118"></a>       <span class='hs-varid'>dumpPlatform</span> <span class='hs-varid'>platform</span> <span class='hs-conid'>Opt_D_dump_cmmz_rewrite</span> <span class='hs-str'>"Post rewrite assignments"</span> <span class='hs-varid'>g</span>
<a name="line-119"></a>
<a name="line-120"></a>       <span class='hs-comment'>----------- Eliminate dead assignments -------------------</span>
<a name="line-121"></a>       <span class='hs-varid'>g</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runOptimization</span> <span class='hs-varop'>$</span> <span class='hs-varid'>removeDeadAssignments</span> <span class='hs-varid'>g</span>
<a name="line-122"></a>       <span class='hs-varid'>dumpPlatform</span> <span class='hs-varid'>platform</span> <span class='hs-conid'>Opt_D_dump_cmmz_dead</span> <span class='hs-str'>"Post remove dead assignments"</span> <span class='hs-varid'>g</span>
<a name="line-123"></a>
<a name="line-124"></a>       <span class='hs-comment'>----------- Zero dead stack slots (Debug only) ---------------</span>
<a name="line-125"></a>       <span class='hs-comment'>-- Debugging: stubbing slots on death can cause crashes early</span>
<a name="line-126"></a>       <span class='hs-varid'>g</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>opt_StubDeadValues</span>
<a name="line-127"></a>                <span class='hs-keyword'>then</span> <span class='hs-varid'>run</span> <span class='hs-varop'>$</span> <span class='hs-varid'>stubSlotsOnDeath</span> <span class='hs-varid'>g</span>
<a name="line-128"></a>                <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-varid'>g</span>
<a name="line-129"></a>       <span class='hs-varid'>dumpPlatform</span> <span class='hs-varid'>platform</span> <span class='hs-conid'>Opt_D_dump_cmmz_stub</span> <span class='hs-str'>"Post stub dead stack slots"</span> <span class='hs-varid'>g</span>
<a name="line-130"></a>
<a name="line-131"></a>       <span class='hs-comment'>--------------- Stack layout ----------------</span>
<a name="line-132"></a>       <span class='hs-varid'>slotEnv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>run</span> <span class='hs-varop'>$</span> <span class='hs-varid'>liveSlotAnal</span> <span class='hs-varid'>g</span>
<a name="line-133"></a>       <span class='hs-keyword'>let</span> <span class='hs-varid'>spEntryMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getSpEntryMap</span> <span class='hs-varid'>entry_off</span> <span class='hs-varid'>g</span>
<a name="line-134"></a>       <span class='hs-varid'>mbpprTrace</span> <span class='hs-str'>"live slot analysis results: "</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>slotEnv</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-135"></a>       <span class='hs-keyword'>let</span> <span class='hs-varid'>areaMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>layout</span> <span class='hs-varid'>procPoints</span> <span class='hs-varid'>spEntryMap</span> <span class='hs-varid'>slotEnv</span> <span class='hs-varid'>entry_off</span> <span class='hs-varid'>g</span>
<a name="line-136"></a>       <span class='hs-varid'>mbpprTrace</span> <span class='hs-str'>"areaMap"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>areaMap</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-137"></a>
<a name="line-138"></a>       <span class='hs-comment'>------------  Manifest the stack pointer --------</span>
<a name="line-139"></a>       <span class='hs-varid'>g</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>run</span> <span class='hs-varop'>$</span> <span class='hs-varid'>manifestSP</span> <span class='hs-varid'>spEntryMap</span> <span class='hs-varid'>areaMap</span> <span class='hs-varid'>entry_off</span> <span class='hs-varid'>g</span>
<a name="line-140"></a>       <span class='hs-varid'>dumpPlatform</span> <span class='hs-varid'>platform</span> <span class='hs-conid'>Opt_D_dump_cmmz_sp</span> <span class='hs-str'>"Post manifestSP"</span> <span class='hs-varid'>g</span>
<a name="line-141"></a>       <span class='hs-comment'>-- UGH... manifestSP can require updates to the procPointMap.</span>
<a name="line-142"></a>       <span class='hs-comment'>-- We can probably do something quicker here for the update...</span>
<a name="line-143"></a>
<a name="line-144"></a>       <span class='hs-comment'>------------- Split into separate procedures ------------</span>
<a name="line-145"></a>       <span class='hs-varid'>procPointMap</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>run</span> <span class='hs-varop'>$</span> <span class='hs-varid'>procPointAnalysis</span> <span class='hs-varid'>procPoints</span> <span class='hs-varid'>g</span>
<a name="line-146"></a>       <span class='hs-varid'>dump</span> <span class='hs-conid'>Opt_D_dump_cmmz_procmap</span> <span class='hs-str'>"procpoint map"</span> <span class='hs-varid'>procPointMap</span>
<a name="line-147"></a>       <span class='hs-varid'>gs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>run</span> <span class='hs-varop'>$</span> <span class='hs-varid'>splitAtProcPoints</span> <span class='hs-varid'>l</span> <span class='hs-varid'>callPPs</span> <span class='hs-varid'>procPoints</span> <span class='hs-varid'>procPointMap</span>
<a name="line-148"></a>                                       <span class='hs-layout'>(</span><span class='hs-conid'>CmmProc</span> <span class='hs-varid'>h</span> <span class='hs-varid'>l</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span>
<a name="line-149"></a>       <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>dumpPlatform</span> <span class='hs-varid'>platform</span> <span class='hs-conid'>Opt_D_dump_cmmz_split</span> <span class='hs-str'>"Post splitting"</span><span class='hs-layout'>)</span> <span class='hs-varid'>gs</span>
<a name="line-150"></a>
<a name="line-151"></a>       <span class='hs-comment'>------------- More CAFs and foreign calls ------------</span>
<a name="line-152"></a>       <span class='hs-varid'>cafEnv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>run</span> <span class='hs-varop'>$</span> <span class='hs-varid'>cafAnal</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>g</span>
<a name="line-153"></a>       <span class='hs-keyword'>let</span> <span class='hs-varid'>localCAFs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>catMaybes</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>localCAFInfo</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>cafEnv</span><span class='hs-layout'>)</span> <span class='hs-varid'>gs</span>
<a name="line-154"></a>       <span class='hs-varid'>mbpprTrace</span> <span class='hs-str'>"localCAFs"</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprPlatform</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>localCAFs</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-155"></a>
<a name="line-156"></a>       <span class='hs-varid'>gs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>run</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>lowerSafeForeignCalls</span> <span class='hs-varid'>areaMap</span><span class='hs-layout'>)</span> <span class='hs-varid'>gs</span>
<a name="line-157"></a>       <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>dumpPlatform</span> <span class='hs-varid'>platform</span> <span class='hs-conid'>Opt_D_dump_cmmz_lower</span> <span class='hs-str'>"Post lowerSafeForeignCalls"</span><span class='hs-layout'>)</span> <span class='hs-varid'>gs</span>
<a name="line-158"></a>
<a name="line-159"></a>       <span class='hs-comment'>-- NO MORE GRAPH TRANSFORMATION AFTER HERE -- JUST MAKING INFOTABLES</span>
<a name="line-160"></a>       <span class='hs-varid'>gs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>setInfoTableStackMap</span> <span class='hs-varid'>slotEnv</span> <span class='hs-varid'>areaMap</span><span class='hs-layout'>)</span> <span class='hs-varid'>gs</span>
<a name="line-161"></a>       <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>dumpPlatform</span> <span class='hs-varid'>platform</span> <span class='hs-conid'>Opt_D_dump_cmmz_info</span> <span class='hs-str'>"after setInfoTableStackMap"</span><span class='hs-layout'>)</span> <span class='hs-varid'>gs</span>
<a name="line-162"></a>       <span class='hs-varid'>gs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>bundleCAFs</span> <span class='hs-varid'>cafEnv</span><span class='hs-layout'>)</span> <span class='hs-varid'>gs</span>
<a name="line-163"></a>       <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>dumpPlatform</span> <span class='hs-varid'>platform</span> <span class='hs-conid'>Opt_D_dump_cmmz_cafs</span> <span class='hs-str'>"after bundleCAFs"</span><span class='hs-layout'>)</span> <span class='hs-varid'>gs</span>
<a name="line-164"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>localCAFs</span><span class='hs-layout'>,</span> <span class='hs-varid'>gs</span><span class='hs-layout'>)</span>
<a name="line-165"></a>
<a name="line-166"></a>              <span class='hs-comment'>-- gs        :: [ (CAFSet, CmmDecl) ]</span>
<a name="line-167"></a>              <span class='hs-comment'>-- localCAFs :: [ (CLabel, CAFSet) ] -- statics filtered out(?)</span>
<a name="line-168"></a>
<a name="line-169"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-170"></a>        <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span>
<a name="line-171"></a>        <span class='hs-varid'>mbpprTrace</span> <span class='hs-varid'>x</span> <span class='hs-varid'>y</span> <span class='hs-varid'>z</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_D_dump_cmmz</span> <span class='hs-varid'>dflags</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>pprTrace</span> <span class='hs-varid'>x</span> <span class='hs-varid'>y</span> <span class='hs-varid'>z</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>z</span>
<a name="line-172"></a>        <span class='hs-varid'>dump</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dumpWith</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>f</span>
<a name="line-173"></a>        <span class='hs-varid'>dumpPlatform</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dumpWith</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprPlatform</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span>
<a name="line-174"></a>        <span class='hs-varid'>dumpWith</span> <span class='hs-varid'>pprFun</span> <span class='hs-varid'>f</span> <span class='hs-varid'>txt</span> <span class='hs-varid'>g</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-175"></a>            <span class='hs-comment'>-- ToDo: No easy way of say "dump all the cmmz, *and* split</span>
<a name="line-176"></a>            <span class='hs-comment'>-- them into files."  Also, -ddump-cmmz doesn't play nicely</span>
<a name="line-177"></a>            <span class='hs-comment'>-- with -ddump-to-file, since the headers get omitted.</span>
<a name="line-178"></a>            <span class='hs-varid'>dumpIfSet_dyn</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>f</span> <span class='hs-varid'>txt</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprFun</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span>
<a name="line-179"></a>            <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>dopt</span> <span class='hs-varid'>f</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-180"></a>                <span class='hs-varid'>dumpIfSet_dyn</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Opt_D_dump_cmmz</span> <span class='hs-varid'>txt</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprFun</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span>
<a name="line-181"></a>        <span class='hs-comment'>-- Runs a required transformation/analysis</span>
<a name="line-182"></a>        <span class='hs-varid'>run</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runInfiniteFuelIO</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_OptFuel</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-183"></a>        <span class='hs-comment'>-- Runs an optional transformation/analysis (and should</span>
<a name="line-184"></a>        <span class='hs-comment'>-- thus be subject to optimization fuel)</span>
<a name="line-185"></a>        <span class='hs-varid'>runOptimization</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runFuelIO</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_OptFuel</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-186"></a>
<a name="line-187"></a><a name="toTops"></a><span class='hs-comment'>-- This probably belongs in CmmBuildInfoTables?</span>
<a name="line-188"></a><span class='hs-comment'>-- We're just finishing the job here: once we know what CAFs are defined</span>
<a name="line-189"></a><span class='hs-comment'>-- in non-static closures, we can build the SRTs.</span>
<a name="line-190"></a><span class='hs-definition'>toTops</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Map</span> <span class='hs-conid'>CLabel</span> <span class='hs-conid'>CAFSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TopSRT</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmDecl</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-191"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>CAFSet</span><span class='hs-layout'>,</span> <span class='hs-conid'>CmmDecl</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>TopSRT</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmDecl</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-192"></a><span class='hs-definition'>toTops</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>topCAFEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>topSRT</span><span class='hs-layout'>,</span> <span class='hs-varid'>tops</span><span class='hs-layout'>)</span> <span class='hs-varid'>gs</span> <span class='hs-keyglyph'>=</span>
<a name="line-193"></a>  <span class='hs-keyword'>do</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>setSRT</span> <span class='hs-layout'>(</span><span class='hs-varid'>topSRT</span><span class='hs-layout'>,</span> <span class='hs-varid'>rst</span><span class='hs-layout'>)</span> <span class='hs-varid'>g</span> <span class='hs-keyglyph'>=</span>
<a name="line-194"></a>           <span class='hs-keyword'>do</span> <span class='hs-layout'>(</span><span class='hs-varid'>topSRT</span><span class='hs-layout'>,</span> <span class='hs-varid'>gs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setInfoTableSRT</span> <span class='hs-varid'>topCAFEnv</span> <span class='hs-varid'>topSRT</span> <span class='hs-varid'>g</span>
<a name="line-195"></a>              <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>topSRT</span><span class='hs-layout'>,</span> <span class='hs-varid'>gs</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rst</span><span class='hs-layout'>)</span>
<a name="line-196"></a>     <span class='hs-layout'>(</span><span class='hs-varid'>topSRT</span><span class='hs-layout'>,</span> <span class='hs-varid'>gs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runFuelIO</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_OptFuel</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>foldM</span> <span class='hs-varid'>setSRT</span> <span class='hs-layout'>(</span><span class='hs-varid'>topSRT</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-varid'>gs</span>
<a name="line-197"></a>     <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>topSRT</span><span class='hs-layout'>,</span> <span class='hs-varid'>concat</span> <span class='hs-varid'>gs'</span> <span class='hs-conop'>:</span> <span class='hs-varid'>tops</span><span class='hs-layout'>)</span>
</pre></body>
</html>
