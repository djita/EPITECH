<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>main/StaticFlags.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-comment'>{-# OPTIONS -fno-cse #-}</span>
<a name="line-9"></a><span class='hs-comment'>-- -fno-cse is needed for GLOBAL_VAR's to behave properly</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-12"></a><span class='hs-comment'>--</span>
<a name="line-13"></a><span class='hs-comment'>-- Static flags</span>
<a name="line-14"></a><span class='hs-comment'>--</span>
<a name="line-15"></a><span class='hs-comment'>-- Static flags can only be set once, on the command-line.  Inside GHC,</span>
<a name="line-16"></a><span class='hs-comment'>-- each static flag corresponds to a top-level value, usually of type Bool.</span>
<a name="line-17"></a><span class='hs-comment'>--</span>
<a name="line-18"></a><span class='hs-comment'>-- (c) The University of Glasgow 2005</span>
<a name="line-19"></a><span class='hs-comment'>--</span>
<a name="line-20"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-21"></a>
<a name="line-22"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>StaticFlags</span> <span class='hs-layout'>(</span>
<a name="line-23"></a>	<span class='hs-varid'>staticFlags</span><span class='hs-layout'>,</span>
<a name="line-24"></a>        <span class='hs-varid'>initStaticOpts</span><span class='hs-layout'>,</span>
<a name="line-25"></a>
<a name="line-26"></a>	<span class='hs-comment'>-- Ways</span>
<a name="line-27"></a>	<span class='hs-conid'>WayName</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Way</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>v_Ways</span><span class='hs-layout'>,</span> <span class='hs-varid'>isRTSWay</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkBuildTag</span><span class='hs-layout'>,</span>
<a name="line-28"></a>
<a name="line-29"></a>	<span class='hs-comment'>-- Output style options</span>
<a name="line-30"></a>	<span class='hs-varid'>opt_PprUserLength</span><span class='hs-layout'>,</span>
<a name="line-31"></a>	<span class='hs-varid'>opt_PprCols</span><span class='hs-layout'>,</span>
<a name="line-32"></a>	<span class='hs-varid'>opt_PprCaseAsLet</span><span class='hs-layout'>,</span>
<a name="line-33"></a>	<span class='hs-varid'>opt_PprStyle_Debug</span><span class='hs-layout'>,</span> <span class='hs-varid'>opt_TraceLevel</span><span class='hs-layout'>,</span>
<a name="line-34"></a>        <span class='hs-varid'>opt_NoDebugOutput</span><span class='hs-layout'>,</span>
<a name="line-35"></a>
<a name="line-36"></a>	<span class='hs-comment'>-- Suppressing boring aspects of core dumps</span>
<a name="line-37"></a>	<span class='hs-varid'>opt_SuppressAll</span><span class='hs-layout'>,</span>
<a name="line-38"></a>	<span class='hs-varid'>opt_SuppressUniques</span><span class='hs-layout'>,</span>
<a name="line-39"></a>        <span class='hs-varid'>opt_SuppressCoercions</span><span class='hs-layout'>,</span>
<a name="line-40"></a>	<span class='hs-varid'>opt_SuppressModulePrefixes</span><span class='hs-layout'>,</span>
<a name="line-41"></a>	<span class='hs-varid'>opt_SuppressTypeApplications</span><span class='hs-layout'>,</span>
<a name="line-42"></a>	<span class='hs-varid'>opt_SuppressIdInfo</span><span class='hs-layout'>,</span>
<a name="line-43"></a>	<span class='hs-varid'>opt_SuppressTypeSignatures</span><span class='hs-layout'>,</span>
<a name="line-44"></a>        <span class='hs-varid'>opt_SuppressVarKinds</span><span class='hs-layout'>,</span>
<a name="line-45"></a>
<a name="line-46"></a>	<span class='hs-comment'>-- profiling opts</span>
<a name="line-47"></a>	<span class='hs-varid'>opt_SccProfilingOn</span><span class='hs-layout'>,</span>
<a name="line-48"></a>
<a name="line-49"></a>        <span class='hs-comment'>-- Hpc opts</span>
<a name="line-50"></a>	<span class='hs-varid'>opt_Hpc</span><span class='hs-layout'>,</span>
<a name="line-51"></a>
<a name="line-52"></a>	<span class='hs-comment'>-- language opts</span>
<a name="line-53"></a>	<span class='hs-varid'>opt_DictsStrict</span><span class='hs-layout'>,</span>
<a name="line-54"></a>	<span class='hs-varid'>opt_IrrefutableTuples</span><span class='hs-layout'>,</span>
<a name="line-55"></a>	<span class='hs-varid'>opt_Parallel</span><span class='hs-layout'>,</span>
<a name="line-56"></a>
<a name="line-57"></a>	<span class='hs-comment'>-- optimisation opts</span>
<a name="line-58"></a>	<span class='hs-varid'>opt_NoStateHack</span><span class='hs-layout'>,</span>
<a name="line-59"></a>        <span class='hs-varid'>opt_SimpleListLiterals</span><span class='hs-layout'>,</span>
<a name="line-60"></a>	<span class='hs-varid'>opt_CprOff</span><span class='hs-layout'>,</span>
<a name="line-61"></a>	<span class='hs-varid'>opt_SimplNoPreInlining</span><span class='hs-layout'>,</span>
<a name="line-62"></a>	<span class='hs-varid'>opt_SimplExcessPrecision</span><span class='hs-layout'>,</span>
<a name="line-63"></a>	<span class='hs-varid'>opt_NoOptCoercion</span><span class='hs-layout'>,</span>
<a name="line-64"></a>	<span class='hs-varid'>opt_MaxWorkerArgs</span><span class='hs-layout'>,</span>
<a name="line-65"></a>
<a name="line-66"></a>	<span class='hs-comment'>-- Unfolding control</span>
<a name="line-67"></a>	<span class='hs-varid'>opt_UF_CreationThreshold</span><span class='hs-layout'>,</span>
<a name="line-68"></a>	<span class='hs-varid'>opt_UF_UseThreshold</span><span class='hs-layout'>,</span>
<a name="line-69"></a>	<span class='hs-varid'>opt_UF_FunAppDiscount</span><span class='hs-layout'>,</span>
<a name="line-70"></a>	<span class='hs-varid'>opt_UF_DictDiscount</span><span class='hs-layout'>,</span>
<a name="line-71"></a>	<span class='hs-varid'>opt_UF_KeenessFactor</span><span class='hs-layout'>,</span>
<a name="line-72"></a>	<span class='hs-varid'>opt_UF_DearOp</span><span class='hs-layout'>,</span>
<a name="line-73"></a>
<a name="line-74"></a>	<span class='hs-comment'>-- Optimization fuel controls</span>
<a name="line-75"></a>	<span class='hs-varid'>opt_Fuel</span><span class='hs-layout'>,</span>
<a name="line-76"></a>
<a name="line-77"></a>	<span class='hs-comment'>-- Related to linking</span>
<a name="line-78"></a>	<span class='hs-varid'>opt_PIC</span><span class='hs-layout'>,</span>
<a name="line-79"></a>	<span class='hs-varid'>opt_Static</span><span class='hs-layout'>,</span>
<a name="line-80"></a>
<a name="line-81"></a>	<span class='hs-comment'>-- misc opts</span>
<a name="line-82"></a>	<span class='hs-varid'>opt_IgnoreDotGhci</span><span class='hs-layout'>,</span>
<a name="line-83"></a>	<span class='hs-varid'>opt_GhciScripts</span><span class='hs-layout'>,</span>
<a name="line-84"></a>	<span class='hs-varid'>opt_ErrorSpans</span><span class='hs-layout'>,</span>
<a name="line-85"></a>	<span class='hs-varid'>opt_GranMacros</span><span class='hs-layout'>,</span>
<a name="line-86"></a>	<span class='hs-varid'>opt_HiVersion</span><span class='hs-layout'>,</span>
<a name="line-87"></a>	<span class='hs-varid'>opt_HistorySize</span><span class='hs-layout'>,</span>
<a name="line-88"></a>        <span class='hs-varid'>opt_Unregisterised</span><span class='hs-layout'>,</span>
<a name="line-89"></a>	<span class='hs-varid'>v_Ld_inputs</span><span class='hs-layout'>,</span>
<a name="line-90"></a>	<span class='hs-varid'>tablesNextToCode</span><span class='hs-layout'>,</span>
<a name="line-91"></a>        <span class='hs-varid'>opt_StubDeadValues</span><span class='hs-layout'>,</span>
<a name="line-92"></a>        <span class='hs-varid'>opt_Ticky</span><span class='hs-layout'>,</span>
<a name="line-93"></a>
<a name="line-94"></a>    <span class='hs-comment'>-- For the parser</span>
<a name="line-95"></a>    <span class='hs-varid'>addOpt</span><span class='hs-layout'>,</span> <span class='hs-varid'>removeOpt</span><span class='hs-layout'>,</span> <span class='hs-varid'>addWay</span><span class='hs-layout'>,</span> <span class='hs-varid'>getWayFlags</span><span class='hs-layout'>,</span> <span class='hs-varid'>v_opt_C_ready</span><span class='hs-layout'>,</span>
<a name="line-96"></a>
<a name="line-97"></a>    <span class='hs-comment'>-- Saving/restoring globals</span>
<a name="line-98"></a>    <span class='hs-varid'>saveStaticFlagGlobals</span><span class='hs-layout'>,</span> <span class='hs-varid'>restoreStaticFlagGlobals</span>
<a name="line-99"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-100"></a>
<a name="line-101"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-102"></a>
<a name="line-103"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Config</span>
<a name="line-104"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-105"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-106"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>		<span class='hs-layout'>(</span> <span class='hs-varid'>firstJusts</span><span class='hs-layout'>,</span> <span class='hs-varid'>catMaybes</span> <span class='hs-layout'>)</span>
<a name="line-107"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Panic</span>
<a name="line-108"></a>
<a name="line-109"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>    <span class='hs-layout'>(</span> <span class='hs-varid'>liftM3</span> <span class='hs-layout'>)</span>
<a name="line-110"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Maybe</span>       <span class='hs-layout'>(</span> <span class='hs-varid'>listToMaybe</span> <span class='hs-layout'>)</span>
<a name="line-111"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>IORef</span>
<a name="line-112"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>IO</span><span class='hs-varop'>.</span><span class='hs-conid'>Unsafe</span>	<span class='hs-layout'>(</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-layout'>)</span>
<a name="line-113"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>
<a name="line-114"></a>
<a name="line-115"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-116"></a><span class='hs-comment'>-- Static flags</span>
<a name="line-117"></a>
<a name="line-118"></a><a name="initStaticOpts"></a><span class='hs-definition'>initStaticOpts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-119"></a><span class='hs-definition'>initStaticOpts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>v_opt_C_ready</span> <span class='hs-conid'>True</span>
<a name="line-120"></a>
<a name="line-121"></a><a name="addOpt"></a><span class='hs-definition'>addOpt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-122"></a><span class='hs-definition'>addOpt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>consIORef</span> <span class='hs-varid'>v_opt_C</span>
<a name="line-123"></a>
<a name="line-124"></a><a name="addWay"></a><span class='hs-definition'>addWay</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WayName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-125"></a><span class='hs-definition'>addWay</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>consIORef</span> <span class='hs-varid'>v_Ways</span> <span class='hs-varop'>.</span> <span class='hs-varid'>lkupWay</span>
<a name="line-126"></a>
<a name="line-127"></a><a name="removeOpt"></a><span class='hs-definition'>removeOpt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-128"></a><span class='hs-definition'>removeOpt</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-129"></a>  <span class='hs-varid'>fs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>v_opt_C</span>
<a name="line-130"></a>  <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>v_opt_C</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varop'>/=</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-varid'>fs</span>
<a name="line-131"></a>
<a name="line-132"></a><a name="lookUp"></a><span class='hs-definition'>lookUp</span>	       	 <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FastString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-133"></a><a name="lookup_def_int"></a><span class='hs-definition'>lookup_def_int</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-134"></a><a name="lookup_def_float"></a><span class='hs-definition'>lookup_def_float</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Float</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Float</span>
<a name="line-135"></a><a name="lookup_str"></a><span class='hs-definition'>lookup_str</span>       <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>String</span>
<a name="line-136"></a><a name="lookup_all_str"></a><span class='hs-definition'>lookup_all_str</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-137"></a>
<a name="line-138"></a><span class='hs-comment'>-- holds the static opts while they're being collected, before</span>
<a name="line-139"></a><span class='hs-comment'>-- being unsafely read by unpacked_static_opts below.</span>
<a name="line-140"></a><span class='hs-conid'>GLOBAL_VAR</span><span class='hs-layout'>(</span><span class='hs-varid'>v_opt_C</span><span class='hs-layout'>,</span> <span class='hs-varid'>defaultStaticOpts</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-141"></a><span class='hs-conid'>GLOBAL_VAR</span><span class='hs-layout'>(</span><span class='hs-varid'>v_opt_C_ready</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span>
<a name="line-142"></a>
<a name="line-143"></a><a name="staticFlags"></a><span class='hs-definition'>staticFlags</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-144"></a><span class='hs-definition'>staticFlags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-145"></a>  <span class='hs-varid'>ready</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>v_opt_C_ready</span>
<a name="line-146"></a>  <span class='hs-keyword'>if</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varid'>ready</span><span class='hs-layout'>)</span>
<a name="line-147"></a>        <span class='hs-keyword'>then</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"Static flags have not been initialised!\n        Please call GHC.newSession or GHC.parseStaticFlags early enough."</span>
<a name="line-148"></a>        <span class='hs-keyword'>else</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>v_opt_C</span>
<a name="line-149"></a>
<a name="line-150"></a><a name="defaultStaticOpts"></a><span class='hs-comment'>-- -static is the default</span>
<a name="line-151"></a><span class='hs-definition'>defaultStaticOpts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-152"></a><span class='hs-definition'>defaultStaticOpts</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"-static"</span><span class='hs-keyglyph'>]</span>
<a name="line-153"></a>
<a name="line-154"></a><a name="packed_static_opts"></a><span class='hs-definition'>packed_static_opts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FastString</span><span class='hs-keyglyph'>]</span>
<a name="line-155"></a><span class='hs-definition'>packed_static_opts</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>mkFastString</span> <span class='hs-varid'>staticFlags</span>
<a name="line-156"></a>
<a name="line-157"></a><span class='hs-definition'>lookUp</span>     <span class='hs-varid'>sw</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sw</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>packed_static_opts</span>
<a name="line-158"></a>
<a name="line-159"></a><span class='hs-comment'>-- (lookup_str "foo") looks for the flag -foo=X or -fooX,</span>
<a name="line-160"></a><span class='hs-comment'>-- and returns the string X</span>
<a name="line-161"></a><span class='hs-definition'>lookup_str</span> <span class='hs-varid'>sw</span>
<a name="line-162"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>firstJusts</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>stripPrefix</span> <span class='hs-varid'>sw</span><span class='hs-layout'>)</span> <span class='hs-varid'>staticFlags</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-163"></a>	<span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-chr'>'='</span> <span class='hs-conop'>:</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>str</span>
<a name="line-164"></a>	<span class='hs-conid'>Just</span> <span class='hs-varid'>str</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>str</span>
<a name="line-165"></a>	<span class='hs-conid'>Nothing</span>		 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-166"></a>
<a name="line-167"></a><span class='hs-definition'>lookup_all_str</span> <span class='hs-varid'>sw</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>f</span> <span class='hs-varop'>$</span> <span class='hs-varid'>catMaybes</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>stripPrefix</span> <span class='hs-varid'>sw</span><span class='hs-layout'>)</span> <span class='hs-varid'>staticFlags</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-168"></a>   <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-chr'>'='</span> <span class='hs-conop'>:</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>str</span>
<a name="line-169"></a>   <span class='hs-varid'>f</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>str</span>
<a name="line-170"></a>
<a name="line-171"></a><span class='hs-definition'>lookup_def_int</span> <span class='hs-varid'>sw</span> <span class='hs-varid'>def</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookup_str</span> <span class='hs-varid'>sw</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-172"></a>			    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>def</span>		<span class='hs-comment'>-- Use default</span>
<a name="line-173"></a>		  	    <span class='hs-conid'>Just</span> <span class='hs-varid'>xx</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>try_read</span> <span class='hs-varid'>sw</span> <span class='hs-varid'>xx</span>
<a name="line-174"></a>
<a name="line-175"></a><span class='hs-definition'>lookup_def_float</span> <span class='hs-varid'>sw</span> <span class='hs-varid'>def</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookup_str</span> <span class='hs-varid'>sw</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-176"></a>			    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>def</span>		<span class='hs-comment'>-- Use default</span>
<a name="line-177"></a>		  	    <span class='hs-conid'>Just</span> <span class='hs-varid'>xx</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>try_read</span> <span class='hs-varid'>sw</span> <span class='hs-varid'>xx</span>
<a name="line-178"></a>
<a name="line-179"></a>
<a name="line-180"></a><a name="try_read"></a><span class='hs-definition'>try_read</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Read</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-181"></a><span class='hs-comment'>-- (try_read sw str) tries to read s; if it fails, it</span>
<a name="line-182"></a><span class='hs-comment'>-- bleats about flag sw</span>
<a name="line-183"></a><span class='hs-definition'>try_read</span> <span class='hs-varid'>sw</span> <span class='hs-varid'>str</span>
<a name="line-184"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>reads</span> <span class='hs-varid'>str</span> <span class='hs-keyword'>of</span>
<a name="line-185"></a>	<span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>x</span>	<span class='hs-comment'>-- Be forgiving: ignore trailing goop, and alternative parses</span>
<a name="line-186"></a>	<span class='hs-conid'>[]</span>	  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ghcError</span> <span class='hs-layout'>(</span><span class='hs-conid'>UsageError</span> <span class='hs-layout'>(</span><span class='hs-str'>"Malformed argument "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>str</span> <span class='hs-varop'>++</span> <span class='hs-str'>" for flag "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>sw</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-187"></a>			<span class='hs-comment'>-- ToDo: hack alert. We should really parse the arguments</span>
<a name="line-188"></a>			<span class='hs-comment'>-- 	 and announce errors in a more civilised way.</span>
<a name="line-189"></a>
<a name="line-190"></a>
<a name="line-191"></a><span class='hs-comment'>{-
<a name="line-192"></a> Putting the compiler options into temporary at-files
<a name="line-193"></a> may turn out to be necessary later on if we turn hsc into
<a name="line-194"></a> a pure Win32 application where I think there's a command-line
<a name="line-195"></a> length limit of 255. unpacked_opts understands the @ option.
<a name="line-196"></a>
<a name="line-197"></a>unpacked_opts :: [String]
<a name="line-198"></a>unpacked_opts =
<a name="line-199"></a>  concat $
<a name="line-200"></a>  map (expandAts) $
<a name="line-201"></a>  map unpackFS argv  -- NOT ARGV any more: v_Static_hsc_opts
<a name="line-202"></a>  where
<a name="line-203"></a>   expandAts ('@':fname) = words (unsafePerformIO (readFile fname))
<a name="line-204"></a>   expandAts l = [l]
<a name="line-205"></a>-}</span>
<a name="line-206"></a>
<a name="line-207"></a><a name="opt_IgnoreDotGhci"></a><span class='hs-definition'>opt_IgnoreDotGhci</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-208"></a><span class='hs-definition'>opt_IgnoreDotGhci</span>		<span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookUp</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-ignore-dot-ghci"</span><span class='hs-layout'>)</span>
<a name="line-209"></a>
<a name="line-210"></a><a name="opt_GhciScripts"></a><span class='hs-definition'>opt_GhciScripts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-211"></a><span class='hs-definition'>opt_GhciScripts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookup_all_str</span> <span class='hs-str'>"-ghci-script"</span>
<a name="line-212"></a>
<a name="line-213"></a><a name="opt_SuppressAll"></a><span class='hs-comment'>-- debugging options</span>
<a name="line-214"></a><span class='hs-comment'>-- | Suppress all that is suppressable in core dumps.</span>
<a name="line-215"></a><span class='hs-comment'>--   Except for uniques, as some simplifier phases introduce new varibles that</span>
<a name="line-216"></a><span class='hs-comment'>--   have otherwise identical names.</span>
<a name="line-217"></a><span class='hs-definition'>opt_SuppressAll</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-218"></a><span class='hs-definition'>opt_SuppressAll</span>
<a name="line-219"></a>	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookUp</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-dsuppress-all"</span><span class='hs-layout'>)</span>
<a name="line-220"></a>
<a name="line-221"></a><a name="opt_SuppressCoercions"></a><span class='hs-comment'>-- | Suppress all coercions, them replacing with '...'</span>
<a name="line-222"></a><span class='hs-definition'>opt_SuppressCoercions</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-223"></a><span class='hs-definition'>opt_SuppressCoercions</span>
<a name="line-224"></a>	<span class='hs-keyglyph'>=</span>  <span class='hs-varid'>lookUp</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-dsuppress-all"</span><span class='hs-layout'>)</span>
<a name="line-225"></a>	<span class='hs-varop'>||</span> <span class='hs-varid'>lookUp</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-dsuppress-coercions"</span><span class='hs-layout'>)</span>
<a name="line-226"></a>
<a name="line-227"></a><a name="opt_SuppressVarKinds"></a><span class='hs-definition'>opt_SuppressVarKinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-228"></a><span class='hs-definition'>opt_SuppressVarKinds</span>
<a name="line-229"></a>	<span class='hs-keyglyph'>=</span>  <span class='hs-varid'>lookUp</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-dsuppress-all"</span><span class='hs-layout'>)</span>
<a name="line-230"></a>	<span class='hs-varop'>||</span> <span class='hs-varid'>lookUp</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-dsuppress-var-kinds"</span><span class='hs-layout'>)</span>
<a name="line-231"></a>
<a name="line-232"></a><a name="opt_SuppressModulePrefixes"></a><span class='hs-comment'>-- | Suppress module id prefixes on variables.</span>
<a name="line-233"></a><span class='hs-definition'>opt_SuppressModulePrefixes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-234"></a><span class='hs-definition'>opt_SuppressModulePrefixes</span>
<a name="line-235"></a>	<span class='hs-keyglyph'>=</span>  <span class='hs-varid'>lookUp</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-dsuppress-all"</span><span class='hs-layout'>)</span>
<a name="line-236"></a>	<span class='hs-varop'>||</span> <span class='hs-varid'>lookUp</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-dsuppress-module-prefixes"</span><span class='hs-layout'>)</span>
<a name="line-237"></a>
<a name="line-238"></a><a name="opt_SuppressTypeApplications"></a><span class='hs-comment'>-- | Suppress type applications.</span>
<a name="line-239"></a><span class='hs-definition'>opt_SuppressTypeApplications</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-240"></a><span class='hs-definition'>opt_SuppressTypeApplications</span>
<a name="line-241"></a>	<span class='hs-keyglyph'>=</span>  <span class='hs-varid'>lookUp</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-dsuppress-all"</span><span class='hs-layout'>)</span>
<a name="line-242"></a>	<span class='hs-varop'>||</span> <span class='hs-varid'>lookUp</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-dsuppress-type-applications"</span><span class='hs-layout'>)</span>
<a name="line-243"></a>
<a name="line-244"></a><a name="opt_SuppressIdInfo"></a><span class='hs-comment'>-- | Suppress info such as arity and unfoldings on identifiers.</span>
<a name="line-245"></a><span class='hs-definition'>opt_SuppressIdInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-246"></a><span class='hs-definition'>opt_SuppressIdInfo</span>
<a name="line-247"></a>	<span class='hs-keyglyph'>=</span>  <span class='hs-varid'>lookUp</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-dsuppress-all"</span><span class='hs-layout'>)</span>
<a name="line-248"></a>	<span class='hs-varop'>||</span> <span class='hs-varid'>lookUp</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-dsuppress-idinfo"</span><span class='hs-layout'>)</span>
<a name="line-249"></a>
<a name="line-250"></a><a name="opt_SuppressTypeSignatures"></a><span class='hs-comment'>-- | Suppress separate type signatures in core, but leave types on lambda bound vars</span>
<a name="line-251"></a><span class='hs-definition'>opt_SuppressTypeSignatures</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-252"></a><span class='hs-definition'>opt_SuppressTypeSignatures</span>
<a name="line-253"></a>	<span class='hs-keyglyph'>=</span>  <span class='hs-varid'>lookUp</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-dsuppress-all"</span><span class='hs-layout'>)</span>
<a name="line-254"></a>	<span class='hs-varop'>||</span> <span class='hs-varid'>lookUp</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-dsuppress-type-signatures"</span><span class='hs-layout'>)</span>
<a name="line-255"></a>
<a name="line-256"></a><a name="opt_SuppressUniques"></a><span class='hs-comment'>-- | Suppress unique ids on variables.</span>
<a name="line-257"></a><span class='hs-comment'>--   Except for uniques, as some simplifier phases introduce new variables that</span>
<a name="line-258"></a><span class='hs-comment'>--   have otherwise identical names.</span>
<a name="line-259"></a><span class='hs-definition'>opt_SuppressUniques</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-260"></a><span class='hs-definition'>opt_SuppressUniques</span>
<a name="line-261"></a>	<span class='hs-keyglyph'>=</span>  <span class='hs-varid'>lookUp</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-dsuppress-uniques"</span><span class='hs-layout'>)</span>
<a name="line-262"></a>
<a name="line-263"></a><a name="opt_PprCaseAsLet"></a><span class='hs-comment'>-- | Display case expressions with a single alternative as strict let bindings</span>
<a name="line-264"></a><span class='hs-definition'>opt_PprCaseAsLet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-265"></a><span class='hs-definition'>opt_PprCaseAsLet</span>	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookUp</span>   <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-dppr-case-as-let"</span><span class='hs-layout'>)</span>
<a name="line-266"></a>
<a name="line-267"></a><a name="opt_PprCols"></a><span class='hs-comment'>-- | Set the maximum width of the dumps</span>
<a name="line-268"></a><span class='hs-comment'>--   If GHC's command line options are bad then the options parser uses the</span>
<a name="line-269"></a><span class='hs-comment'>--   pretty printer display the error message. In this case the staticFlags</span>
<a name="line-270"></a><span class='hs-comment'>--   won't be initialized yet, so we must check for this case explicitly</span>
<a name="line-271"></a><span class='hs-comment'>--   and return the default value.</span>
<a name="line-272"></a><span class='hs-definition'>opt_PprCols</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-273"></a><span class='hs-definition'>opt_PprCols</span>
<a name="line-274"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafePerformIO</span>
<a name="line-275"></a> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>	<span class='hs-varid'>ready</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>v_opt_C_ready</span>
<a name="line-276"></a>	<span class='hs-keyword'>if</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varid'>ready</span><span class='hs-layout'>)</span>
<a name="line-277"></a>		<span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-num'>100</span>
<a name="line-278"></a>		<span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>lookup_def_int</span> <span class='hs-str'>"-dppr-cols"</span> <span class='hs-num'>100</span>
<a name="line-279"></a>
<a name="line-280"></a>
<a name="line-281"></a><a name="opt_PprStyle_Debug"></a><span class='hs-definition'>opt_PprStyle_Debug</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-282"></a><span class='hs-definition'>opt_PprStyle_Debug</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookUp</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-dppr-debug"</span><span class='hs-layout'>)</span>
<a name="line-283"></a>
<a name="line-284"></a><a name="opt_TraceLevel"></a><span class='hs-definition'>opt_TraceLevel</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-285"></a><span class='hs-definition'>opt_TraceLevel</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookup_def_int</span> <span class='hs-str'>"-dtrace-level"</span> <span class='hs-num'>1</span>  	<span class='hs-comment'>-- Standard level is 1</span>
<a name="line-286"></a>	       	 			    	        <span class='hs-comment'>-- Less verbose is 0</span>
<a name="line-287"></a>
<a name="line-288"></a><a name="opt_PprUserLength"></a><span class='hs-definition'>opt_PprUserLength</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-289"></a><span class='hs-definition'>opt_PprUserLength</span>	        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookup_def_int</span> <span class='hs-str'>"-dppr-user-length"</span> <span class='hs-num'>5</span> <span class='hs-comment'>--ToDo: give this a name</span>
<a name="line-290"></a>
<a name="line-291"></a><a name="opt_Fuel"></a><span class='hs-definition'>opt_Fuel</span>            <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-292"></a><span class='hs-definition'>opt_Fuel</span>                        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookup_def_int</span> <span class='hs-str'>"-dopt-fuel"</span> <span class='hs-varid'>maxBound</span>
<a name="line-293"></a>
<a name="line-294"></a><a name="opt_NoDebugOutput"></a><span class='hs-definition'>opt_NoDebugOutput</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-295"></a><span class='hs-definition'>opt_NoDebugOutput</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookUp</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-dno-debug-output"</span><span class='hs-layout'>)</span>
<a name="line-296"></a>
<a name="line-297"></a><a name="opt_SccProfilingOn"></a><span class='hs-comment'>-- profiling opts</span>
<a name="line-298"></a><span class='hs-definition'>opt_SccProfilingOn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-299"></a><span class='hs-definition'>opt_SccProfilingOn</span>		<span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookUp</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-fscc-profiling"</span><span class='hs-layout'>)</span>
<a name="line-300"></a>
<a name="line-301"></a><a name="opt_Hpc"></a><span class='hs-comment'>-- Hpc opts</span>
<a name="line-302"></a><span class='hs-definition'>opt_Hpc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-303"></a><span class='hs-definition'>opt_Hpc</span>				<span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookUp</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-fhpc"</span><span class='hs-layout'>)</span>
<a name="line-304"></a>
<a name="line-305"></a><a name="opt_DictsStrict"></a><span class='hs-comment'>-- language opts</span>
<a name="line-306"></a><span class='hs-definition'>opt_DictsStrict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-307"></a><span class='hs-definition'>opt_DictsStrict</span>			<span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookUp</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-fdicts-strict"</span><span class='hs-layout'>)</span>
<a name="line-308"></a>
<a name="line-309"></a><a name="opt_IrrefutableTuples"></a><span class='hs-definition'>opt_IrrefutableTuples</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-310"></a><span class='hs-definition'>opt_IrrefutableTuples</span>		<span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookUp</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-firrefutable-tuples"</span><span class='hs-layout'>)</span>
<a name="line-311"></a>
<a name="line-312"></a><a name="opt_Parallel"></a><span class='hs-definition'>opt_Parallel</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-313"></a><span class='hs-definition'>opt_Parallel</span>			<span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookUp</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-fparallel"</span><span class='hs-layout'>)</span>
<a name="line-314"></a>
<a name="line-315"></a><a name="opt_SimpleListLiterals"></a><span class='hs-definition'>opt_SimpleListLiterals</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-316"></a><span class='hs-definition'>opt_SimpleListLiterals</span>	        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookUp</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-fsimple-list-literals"</span><span class='hs-layout'>)</span>
<a name="line-317"></a>
<a name="line-318"></a><a name="opt_NoStateHack"></a><span class='hs-definition'>opt_NoStateHack</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-319"></a><span class='hs-definition'>opt_NoStateHack</span>			<span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookUp</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-fno-state-hack"</span><span class='hs-layout'>)</span>
<a name="line-320"></a>
<a name="line-321"></a><a name="opt_CprOff"></a><span class='hs-definition'>opt_CprOff</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-322"></a><span class='hs-definition'>opt_CprOff</span>			<span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookUp</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-fcpr-off"</span><span class='hs-layout'>)</span>
<a name="line-323"></a>	<span class='hs-comment'>-- Switch off CPR analysis in the new demand analyser</span>
<a name="line-324"></a><a name="opt_MaxWorkerArgs"></a><span class='hs-definition'>opt_MaxWorkerArgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-325"></a><span class='hs-definition'>opt_MaxWorkerArgs</span>		<span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookup_def_int</span> <span class='hs-str'>"-fmax-worker-args"</span> <span class='hs-layout'>(</span><span class='hs-num'>10</span><span class='hs-keyglyph'>::</span><span class='hs-conid'>Int</span><span class='hs-layout'>)</span>
<a name="line-326"></a>
<a name="line-327"></a><a name="opt_GranMacros"></a><span class='hs-definition'>opt_GranMacros</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-328"></a><span class='hs-definition'>opt_GranMacros</span>			<span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookUp</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-fgransim"</span><span class='hs-layout'>)</span>
<a name="line-329"></a>
<a name="line-330"></a><a name="opt_HiVersion"></a><span class='hs-definition'>opt_HiVersion</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Integer</span>
<a name="line-331"></a><span class='hs-definition'>opt_HiVersion</span>			<span class='hs-keyglyph'>=</span> <span class='hs-varid'>read</span> <span class='hs-layout'>(</span><span class='hs-varid'>cProjectVersionInt</span> <span class='hs-varop'>++</span> <span class='hs-varid'>cProjectPatchLevel</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Integer</span>
<a name="line-332"></a>
<a name="line-333"></a><a name="opt_HistorySize"></a><span class='hs-definition'>opt_HistorySize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-334"></a><span class='hs-definition'>opt_HistorySize</span>			<span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookup_def_int</span> <span class='hs-str'>"-fhistory-size"</span> <span class='hs-num'>20</span>
<a name="line-335"></a>
<a name="line-336"></a><a name="opt_StubDeadValues"></a><span class='hs-definition'>opt_StubDeadValues</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-337"></a><span class='hs-definition'>opt_StubDeadValues</span>		<span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookUp</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-dstub-dead-values"</span><span class='hs-layout'>)</span>
<a name="line-338"></a>
<a name="line-339"></a><a name="opt_SimplNoPreInlining"></a><span class='hs-comment'>-- Simplifier switches</span>
<a name="line-340"></a><span class='hs-definition'>opt_SimplNoPreInlining</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-341"></a><span class='hs-definition'>opt_SimplNoPreInlining</span>		<span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookUp</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-fno-pre-inlining"</span><span class='hs-layout'>)</span>
<a name="line-342"></a>	<span class='hs-comment'>-- NoPreInlining is there just to see how bad things</span>
<a name="line-343"></a>	<span class='hs-comment'>-- get if you don't do it!</span>
<a name="line-344"></a><a name="opt_SimplExcessPrecision"></a><span class='hs-definition'>opt_SimplExcessPrecision</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-345"></a><span class='hs-definition'>opt_SimplExcessPrecision</span>	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookUp</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-fexcess-precision"</span><span class='hs-layout'>)</span>
<a name="line-346"></a>
<a name="line-347"></a><a name="opt_NoOptCoercion"></a><span class='hs-definition'>opt_NoOptCoercion</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-348"></a><span class='hs-definition'>opt_NoOptCoercion</span>    	        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookUp</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-fno-opt-coercion"</span><span class='hs-layout'>)</span>
<a name="line-349"></a>
<a name="line-350"></a><span class='hs-comment'>-- Unfolding control</span>
<a name="line-351"></a><span class='hs-comment'>-- See Note [Discounts and thresholds] in CoreUnfold</span>
<a name="line-352"></a>
<a name="line-353"></a><a name="opt_UF_CreationThreshold"></a><span class='hs-definition'>opt_UF_CreationThreshold</span><span class='hs-layout'>,</span> <span class='hs-varid'>opt_UF_UseThreshold</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-354"></a><a name="opt_UF_DearOp"></a><span class='hs-definition'>opt_UF_DearOp</span><span class='hs-layout'>,</span> <span class='hs-varid'>opt_UF_FunAppDiscount</span><span class='hs-layout'>,</span> <span class='hs-varid'>opt_UF_DictDiscount</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-355"></a><a name="opt_UF_KeenessFactor"></a><span class='hs-definition'>opt_UF_KeenessFactor</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Float</span>
<a name="line-356"></a>
<a name="line-357"></a><span class='hs-definition'>opt_UF_CreationThreshold</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookup_def_int</span> <span class='hs-str'>"-funfolding-creation-threshold"</span> <span class='hs-layout'>(</span><span class='hs-num'>750</span><span class='hs-keyglyph'>::</span><span class='hs-conid'>Int</span><span class='hs-layout'>)</span>
<a name="line-358"></a><span class='hs-comment'>-- This threshold must be reasonably high to take</span>
<a name="line-359"></a><span class='hs-comment'>-- account of possible discounts.</span>
<a name="line-360"></a><span class='hs-comment'>-- E.g. 450 is not enough in 'fulsom' for Interval.sqr to inline into Csg.calc</span>
<a name="line-361"></a><span class='hs-comment'>--      (The unfolding for sqr never makes it into the interface file.)</span>
<a name="line-362"></a>
<a name="line-363"></a><a name="opt_UF_UseThreshold"></a><span class='hs-definition'>opt_UF_UseThreshold</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookup_def_int</span> <span class='hs-str'>"-funfolding-use-threshold"</span>      <span class='hs-layout'>(</span><span class='hs-num'>60</span><span class='hs-keyglyph'>::</span><span class='hs-conid'>Int</span><span class='hs-layout'>)</span>
<a name="line-364"></a><a name="opt_UF_FunAppDiscount"></a><span class='hs-definition'>opt_UF_FunAppDiscount</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookup_def_int</span> <span class='hs-str'>"-funfolding-fun-discount"</span>       <span class='hs-layout'>(</span><span class='hs-num'>60</span><span class='hs-keyglyph'>::</span><span class='hs-conid'>Int</span><span class='hs-layout'>)</span>
<a name="line-365"></a>
<a name="line-366"></a><a name="opt_UF_DictDiscount"></a><span class='hs-definition'>opt_UF_DictDiscount</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookup_def_int</span> <span class='hs-str'>"-funfolding-dict-discount"</span>      <span class='hs-layout'>(</span><span class='hs-num'>30</span><span class='hs-keyglyph'>::</span><span class='hs-conid'>Int</span><span class='hs-layout'>)</span>
<a name="line-367"></a>   <span class='hs-comment'>-- Be fairly keen to inline a fuction if that means</span>
<a name="line-368"></a>   <span class='hs-comment'>-- we'll be able to pick the right method from a dictionary</span>
<a name="line-369"></a>
<a name="line-370"></a><span class='hs-definition'>opt_UF_KeenessFactor</span>	 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookup_def_float</span> <span class='hs-str'>"-funfolding-keeness-factor"</span>   <span class='hs-layout'>(</span><span class='hs-num'>1.5</span><span class='hs-keyglyph'>::</span><span class='hs-conid'>Float</span><span class='hs-layout'>)</span>
<a name="line-371"></a><span class='hs-definition'>opt_UF_DearOp</span>            <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span> <span class='hs-num'>40</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span>
<a name="line-372"></a>
<a name="line-373"></a>
<a name="line-374"></a><a name="opt_PIC"></a><span class='hs-comment'>-- Related to linking</span>
<a name="line-375"></a><span class='hs-definition'>opt_PIC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-376"></a><span class='hs-cpp'>#if darwin_TARGET_OS &amp;&amp; x86_64_TARGET_ARCH</span>
<a name="line-377"></a><span class='hs-definition'>opt_PIC</span>                         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-378"></a><span class='hs-cpp'>#elif darwin_TARGET_OS</span>
<a name="line-379"></a><span class='hs-definition'>opt_PIC</span>                         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookUp</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-fPIC"</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span> <span class='hs-varid'>not</span> <span class='hs-varid'>opt_Static</span>
<a name="line-380"></a><span class='hs-cpp'>#else</span>
<a name="line-381"></a><span class='hs-definition'>opt_PIC</span>                         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookUp</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-fPIC"</span><span class='hs-layout'>)</span>
<a name="line-382"></a><span class='hs-cpp'>#endif</span>
<a name="line-383"></a><a name="opt_Static"></a><span class='hs-definition'>opt_Static</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-384"></a><span class='hs-definition'>opt_Static</span>			<span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookUp</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-static"</span><span class='hs-layout'>)</span>
<a name="line-385"></a><a name="opt_Unregisterised"></a><span class='hs-definition'>opt_Unregisterised</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-386"></a><span class='hs-definition'>opt_Unregisterised</span>		<span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookUp</span>  <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-funregisterised"</span><span class='hs-layout'>)</span>
<a name="line-387"></a>
<a name="line-388"></a><a name="tablesNextToCode"></a><span class='hs-comment'>-- Derived, not a real option.  Determines whether we will be compiling</span>
<a name="line-389"></a><span class='hs-comment'>-- info tables that reside just before the entry code, or with an</span>
<a name="line-390"></a><span class='hs-comment'>-- indirection to the entry code.  See TABLES_NEXT_TO_CODE in</span>
<a name="line-391"></a><span class='hs-comment'>-- includes/rts/storage/InfoTables.h.</span>
<a name="line-392"></a><span class='hs-definition'>tablesNextToCode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-393"></a><span class='hs-definition'>tablesNextToCode</span> 		<span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-varid'>opt_Unregisterised</span>
<a name="line-394"></a>		 		  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>cGhcEnableTablesNextToCode</span> <span class='hs-varop'>==</span> <span class='hs-str'>"YES"</span>
<a name="line-395"></a>
<a name="line-396"></a><a name="opt_ErrorSpans"></a><span class='hs-comment'>-- Include full span info in error messages, instead of just the start position.</span>
<a name="line-397"></a><span class='hs-definition'>opt_ErrorSpans</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-398"></a><span class='hs-definition'>opt_ErrorSpans</span>			<span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookUp</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-ferror-spans"</span><span class='hs-layout'>)</span>
<a name="line-399"></a>
<a name="line-400"></a><a name="opt_Ticky"></a><span class='hs-definition'>opt_Ticky</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-401"></a><span class='hs-definition'>opt_Ticky</span>                       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookUp</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"-ticky"</span><span class='hs-layout'>)</span>
<a name="line-402"></a>
<a name="line-403"></a><span class='hs-comment'>-- object files and libraries to be linked in are collected here.</span>
<a name="line-404"></a><span class='hs-comment'>-- ToDo: perhaps this could be done without a global, it wasn't obvious</span>
<a name="line-405"></a><span class='hs-comment'>-- how to do it though --SDM.</span>
<a name="line-406"></a><span class='hs-conid'>GLOBAL_VAR</span><span class='hs-layout'>(</span><span class='hs-varid'>v_Ld_inputs</span><span class='hs-layout'>,</span>	<span class='hs-conid'>[]</span><span class='hs-layout'>,</span>      <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-407"></a>
<a name="line-408"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-409"></a><span class='hs-comment'>-- Ways</span>
<a name="line-410"></a>
<a name="line-411"></a><span class='hs-comment'>-- The central concept of a "way" is that all objects in a given</span>
<a name="line-412"></a><span class='hs-comment'>-- program must be compiled in the same "way".  Certain options change</span>
<a name="line-413"></a><span class='hs-comment'>-- parameters of the virtual machine, eg. profiling adds an extra word</span>
<a name="line-414"></a><span class='hs-comment'>-- to the object header, so profiling objects cannot be linked with</span>
<a name="line-415"></a><span class='hs-comment'>-- non-profiling objects.</span>
<a name="line-416"></a>
<a name="line-417"></a><span class='hs-comment'>-- After parsing the command-line options, we determine which "way" we</span>
<a name="line-418"></a><span class='hs-comment'>-- are building - this might be a combination way, eg. profiling+threaded.</span>
<a name="line-419"></a>
<a name="line-420"></a><span class='hs-comment'>-- We then find the "build-tag" associated with this way, and this</span>
<a name="line-421"></a><span class='hs-comment'>-- becomes the suffix used to find .hi files and libraries used in</span>
<a name="line-422"></a><span class='hs-comment'>-- this compilation.</span>
<a name="line-423"></a>
<a name="line-424"></a><a name="WayName"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>WayName</span>
<a name="line-425"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WayThreaded</span>
<a name="line-426"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WayDebug</span>
<a name="line-427"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WayProf</span>
<a name="line-428"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WayEventLog</span>
<a name="line-429"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WayPar</span>
<a name="line-430"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WayGran</span>
<a name="line-431"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WayNDP</span>
<a name="line-432"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WayDyn</span>
<a name="line-433"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>,</span><span class='hs-conid'>Ord</span><span class='hs-layout'>)</span>
<a name="line-434"></a>
<a name="line-435"></a><span class='hs-conid'>GLOBAL_VAR</span><span class='hs-layout'>(</span><span class='hs-varid'>v_Ways</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>,</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Way</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-436"></a>
<a name="line-437"></a><a name="allowed_combination"></a><span class='hs-definition'>allowed_combination</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>WayName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-438"></a><span class='hs-definition'>allowed_combination</span> <span class='hs-varid'>way</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>and</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>x</span> <span class='hs-varop'>`allowedWith`</span> <span class='hs-varid'>y</span>
<a name="line-439"></a>			      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>way</span><span class='hs-layout'>,</span> <span class='hs-varid'>y</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>way</span><span class='hs-layout'>,</span> <span class='hs-varid'>x</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>y</span> <span class='hs-keyglyph'>]</span>
<a name="line-440"></a>  <span class='hs-keyword'>where</span>
<a name="line-441"></a>	<span class='hs-comment'>-- Note ordering in these tests: the left argument is</span>
<a name="line-442"></a>	<span class='hs-comment'>-- &lt;= the right argument, according to the Ord instance</span>
<a name="line-443"></a>	<span class='hs-comment'>-- on Way above.</span>
<a name="line-444"></a>
<a name="line-445"></a>	<span class='hs-comment'>-- dyn is allowed with everything</span>
<a name="line-446"></a>	<span class='hs-keyword'>_</span> <span class='hs-varop'>`allowedWith`</span> <span class='hs-conid'>WayDyn</span>  		<span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-447"></a>	<span class='hs-conid'>WayDyn</span> <span class='hs-varop'>`allowedWith`</span> <span class='hs-keyword'>_</span>		        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-448"></a>
<a name="line-449"></a>	<span class='hs-comment'>-- debug is allowed with everything</span>
<a name="line-450"></a>	<span class='hs-keyword'>_</span> <span class='hs-varop'>`allowedWith`</span> <span class='hs-conid'>WayDebug</span>		<span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-451"></a>	<span class='hs-conid'>WayDebug</span> <span class='hs-varop'>`allowedWith`</span> <span class='hs-keyword'>_</span>		<span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-452"></a>
<a name="line-453"></a>	<span class='hs-conid'>WayProf</span> <span class='hs-varop'>`allowedWith`</span> <span class='hs-conid'>WayNDP</span>		<span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-454"></a>	<span class='hs-conid'>WayThreaded</span> <span class='hs-varop'>`allowedWith`</span> <span class='hs-conid'>WayProf</span>	<span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-455"></a>	<span class='hs-conid'>WayThreaded</span> <span class='hs-varop'>`allowedWith`</span> <span class='hs-conid'>WayEventLog</span>	<span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-456"></a>	<span class='hs-keyword'>_</span> <span class='hs-varop'>`allowedWith`</span> <span class='hs-keyword'>_</span> 			<span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-457"></a>
<a name="line-458"></a>
<a name="line-459"></a><a name="getWayFlags"></a><span class='hs-definition'>getWayFlags</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- new options</span>
<a name="line-460"></a><span class='hs-definition'>getWayFlags</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-461"></a>  <span class='hs-varid'>unsorted</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>v_Ways</span>
<a name="line-462"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>ways</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortBy</span> <span class='hs-layout'>(</span><span class='hs-varid'>compare</span> <span class='hs-varop'>`on`</span> <span class='hs-varid'>wayName</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-463"></a>             <span class='hs-varid'>nubBy</span>  <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>==</span><span class='hs-layout'>)</span> <span class='hs-varop'>`on`</span> <span class='hs-varid'>wayName</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unsorted</span>
<a name="line-464"></a>  <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>v_Ways</span> <span class='hs-varid'>ways</span>
<a name="line-465"></a>
<a name="line-466"></a>  <span class='hs-keyword'>if</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>allowed_combination</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>wayName</span> <span class='hs-varid'>ways</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-467"></a>      <span class='hs-keyword'>then</span> <span class='hs-varid'>ghcError</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmdLineError</span> <span class='hs-varop'>$</span>
<a name="line-468"></a>      		    <span class='hs-str'>"combination not supported: "</span>  <span class='hs-varop'>++</span>
<a name="line-469"></a>      		    <span class='hs-varid'>foldr1</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-varop'>++</span> <span class='hs-chr'>'/'</span><span class='hs-conop'>:</span><span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-470"></a>      		    <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>wayDesc</span> <span class='hs-varid'>ways</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-471"></a>      <span class='hs-keyword'>else</span>
<a name="line-472"></a>      	   <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>concatMap</span> <span class='hs-varid'>wayOpts</span> <span class='hs-varid'>ways</span><span class='hs-layout'>)</span>
<a name="line-473"></a>
<a name="line-474"></a><a name="mkBuildTag"></a><span class='hs-definition'>mkBuildTag</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Way</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-475"></a><span class='hs-definition'>mkBuildTag</span> <span class='hs-varid'>ways</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concat</span> <span class='hs-layout'>(</span><span class='hs-varid'>intersperse</span> <span class='hs-str'>"_"</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>wayTag</span> <span class='hs-varid'>ways</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-476"></a>
<a name="line-477"></a><a name="lkupWay"></a><span class='hs-definition'>lkupWay</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WayName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Way</span>
<a name="line-478"></a><span class='hs-definition'>lkupWay</span> <span class='hs-varid'>w</span> <span class='hs-keyglyph'>=</span>
<a name="line-479"></a>   <span class='hs-keyword'>case</span> <span class='hs-varid'>listToMaybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>==</span><span class='hs-layout'>)</span> <span class='hs-varid'>w</span> <span class='hs-varop'>.</span> <span class='hs-varid'>wayName</span><span class='hs-layout'>)</span> <span class='hs-varid'>way_details</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-480"></a>	<span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>error</span> <span class='hs-str'>"findBuildTag"</span>
<a name="line-481"></a>	<span class='hs-conid'>Just</span> <span class='hs-varid'>details</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>details</span>
<a name="line-482"></a>
<a name="line-483"></a><a name="isRTSWay"></a><span class='hs-definition'>isRTSWay</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WayName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-484"></a><span class='hs-definition'>isRTSWay</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wayRTSOnly</span> <span class='hs-varop'>.</span> <span class='hs-varid'>lkupWay</span>
<a name="line-485"></a>
<a name="line-486"></a><a name="Way"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Way</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Way</span> <span class='hs-layout'>{</span>
<a name="line-487"></a>  <span class='hs-varid'>wayName</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WayName</span><span class='hs-layout'>,</span>
<a name="line-488"></a>  <span class='hs-varid'>wayTag</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span><span class='hs-layout'>,</span>
<a name="line-489"></a>  <span class='hs-varid'>wayRTSOnly</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>,</span>
<a name="line-490"></a>  <span class='hs-varid'>wayDesc</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span><span class='hs-layout'>,</span>
<a name="line-491"></a>  <span class='hs-varid'>wayOpts</span>    <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-492"></a>  <span class='hs-layout'>}</span>
<a name="line-493"></a>
<a name="line-494"></a><a name="way_details"></a><span class='hs-definition'>way_details</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>Way</span> <span class='hs-keyglyph'>]</span>
<a name="line-495"></a><span class='hs-definition'>way_details</span> <span class='hs-keyglyph'>=</span>
<a name="line-496"></a>  <span class='hs-keyglyph'>[</span> <span class='hs-conid'>Way</span> <span class='hs-conid'>WayThreaded</span> <span class='hs-str'>"thr"</span> <span class='hs-conid'>True</span> <span class='hs-str'>"Threaded"</span> <span class='hs-keyglyph'>[</span>
<a name="line-497"></a><span class='hs-cpp'>#if defined(freebsd_TARGET_OS)</span>
<a name="line-498"></a><span class='hs-comment'>--	  "-optc-pthread"</span>
<a name="line-499"></a><span class='hs-comment'>--      , "-optl-pthread"</span>
<a name="line-500"></a>	<span class='hs-comment'>-- FreeBSD's default threading library is the KSE-based M:N libpthread,</span>
<a name="line-501"></a>	<span class='hs-comment'>-- which GHC has some problems with.  It's currently not clear whether</span>
<a name="line-502"></a>	<span class='hs-comment'>-- the problems are our fault or theirs, but it seems that using the</span>
<a name="line-503"></a>	<span class='hs-comment'>-- alternative 1:1 threading library libthr works around it:</span>
<a name="line-504"></a>	  <span class='hs-str'>"-optl-lthr"</span>
<a name="line-505"></a><span class='hs-cpp'>#elif defined(openbsd_TARGET_OS) || defined(netbsd_TARGET_OS)</span>
<a name="line-506"></a>	  <span class='hs-str'>"-optc-pthread"</span>
<a name="line-507"></a>	<span class='hs-layout'>,</span> <span class='hs-str'>"-optl-pthread"</span>
<a name="line-508"></a><span class='hs-cpp'>#elif defined(solaris2_TARGET_OS)</span>
<a name="line-509"></a>          <span class='hs-str'>"-optl-lrt"</span>
<a name="line-510"></a><span class='hs-cpp'>#endif</span>
<a name="line-511"></a>	<span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-512"></a>
<a name="line-513"></a>    <span class='hs-conid'>Way</span> <span class='hs-conid'>WayDebug</span> <span class='hs-str'>"debug"</span> <span class='hs-conid'>True</span> <span class='hs-str'>"Debug"</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-514"></a>
<a name="line-515"></a>    <span class='hs-conid'>Way</span> <span class='hs-conid'>WayDyn</span> <span class='hs-str'>"dyn"</span> <span class='hs-conid'>False</span> <span class='hs-str'>"Dynamic"</span>
<a name="line-516"></a>	<span class='hs-keyglyph'>[</span> <span class='hs-str'>"-DDYNAMIC"</span>
<a name="line-517"></a>	<span class='hs-layout'>,</span> <span class='hs-str'>"-optc-DDYNAMIC"</span>
<a name="line-518"></a><span class='hs-cpp'>#if defined(mingw32_TARGET_OS)</span>
<a name="line-519"></a>	<span class='hs-comment'>-- On Windows, code that is to be linked into a dynamic library must be compiled</span>
<a name="line-520"></a>	<span class='hs-comment'>--	with -fPIC. Labels not in the current package are assumed to be in a DLL</span>
<a name="line-521"></a>	<span class='hs-comment'>--	different from the current one.</span>
<a name="line-522"></a>	<span class='hs-layout'>,</span> <span class='hs-str'>"-fPIC"</span>
<a name="line-523"></a><span class='hs-cpp'>#elif defined(openbsd_TARGET_OS) || defined(netbsd_TARGET_OS)</span>
<a name="line-524"></a>	<span class='hs-comment'>-- Without this, linking the shared libHSffi fails because</span>
<a name="line-525"></a>	<span class='hs-comment'>-- it uses pthread mutexes.</span>
<a name="line-526"></a>	<span class='hs-layout'>,</span> <span class='hs-str'>"-optl-pthread"</span>
<a name="line-527"></a><span class='hs-cpp'>#endif</span>
<a name="line-528"></a>	<span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-529"></a>
<a name="line-530"></a>    <span class='hs-conid'>Way</span> <span class='hs-conid'>WayProf</span> <span class='hs-str'>"p"</span> <span class='hs-conid'>False</span> <span class='hs-str'>"Profiling"</span>
<a name="line-531"></a>	<span class='hs-keyglyph'>[</span> <span class='hs-str'>"-fscc-profiling"</span>
<a name="line-532"></a>	<span class='hs-layout'>,</span> <span class='hs-str'>"-DPROFILING"</span>
<a name="line-533"></a>	<span class='hs-layout'>,</span> <span class='hs-str'>"-optc-DPROFILING"</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-534"></a>
<a name="line-535"></a>    <span class='hs-conid'>Way</span> <span class='hs-conid'>WayEventLog</span> <span class='hs-str'>"l"</span> <span class='hs-conid'>True</span> <span class='hs-str'>"RTS Event Logging"</span>
<a name="line-536"></a>	<span class='hs-keyglyph'>[</span> <span class='hs-str'>"-DTRACING"</span>
<a name="line-537"></a>	<span class='hs-layout'>,</span> <span class='hs-str'>"-optc-DTRACING"</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-538"></a>
<a name="line-539"></a>    <span class='hs-conid'>Way</span> <span class='hs-conid'>WayPar</span> <span class='hs-str'>"mp"</span> <span class='hs-conid'>False</span> <span class='hs-str'>"Parallel"</span>
<a name="line-540"></a>	<span class='hs-keyglyph'>[</span> <span class='hs-str'>"-fparallel"</span>
<a name="line-541"></a>	<span class='hs-layout'>,</span> <span class='hs-str'>"-D__PARALLEL_HASKELL__"</span>
<a name="line-542"></a>	<span class='hs-layout'>,</span> <span class='hs-str'>"-optc-DPAR"</span>
<a name="line-543"></a>	<span class='hs-layout'>,</span> <span class='hs-str'>"-package concurrent"</span>
<a name="line-544"></a>        <span class='hs-layout'>,</span> <span class='hs-str'>"-optc-w"</span>
<a name="line-545"></a>        <span class='hs-layout'>,</span> <span class='hs-str'>"-optl-L${PVM_ROOT}/lib/${PVM_ARCH}"</span>
<a name="line-546"></a>        <span class='hs-layout'>,</span> <span class='hs-str'>"-optl-lpvm3"</span>
<a name="line-547"></a>        <span class='hs-layout'>,</span> <span class='hs-str'>"-optl-lgpvm3"</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-548"></a>
<a name="line-549"></a>    <span class='hs-comment'>-- at the moment we only change the RTS and could share compiler and libs!</span>
<a name="line-550"></a>    <span class='hs-conid'>Way</span> <span class='hs-conid'>WayPar</span> <span class='hs-str'>"mt"</span> <span class='hs-conid'>False</span> <span class='hs-str'>"Parallel ticky profiling"</span>
<a name="line-551"></a>	<span class='hs-keyglyph'>[</span> <span class='hs-str'>"-fparallel"</span>
<a name="line-552"></a>	<span class='hs-layout'>,</span> <span class='hs-str'>"-D__PARALLEL_HASKELL__"</span>
<a name="line-553"></a>	<span class='hs-layout'>,</span> <span class='hs-str'>"-optc-DPAR"</span>
<a name="line-554"></a>	<span class='hs-layout'>,</span> <span class='hs-str'>"-optc-DPAR_TICKY"</span>
<a name="line-555"></a>	<span class='hs-layout'>,</span> <span class='hs-str'>"-package concurrent"</span>
<a name="line-556"></a>        <span class='hs-layout'>,</span> <span class='hs-str'>"-optc-w"</span>
<a name="line-557"></a>        <span class='hs-layout'>,</span> <span class='hs-str'>"-optl-L${PVM_ROOT}/lib/${PVM_ARCH}"</span>
<a name="line-558"></a>        <span class='hs-layout'>,</span> <span class='hs-str'>"-optl-lpvm3"</span>
<a name="line-559"></a>        <span class='hs-layout'>,</span> <span class='hs-str'>"-optl-lgpvm3"</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-560"></a>
<a name="line-561"></a>    <span class='hs-conid'>Way</span> <span class='hs-conid'>WayPar</span> <span class='hs-str'>"md"</span> <span class='hs-conid'>False</span> <span class='hs-str'>"Distributed"</span>
<a name="line-562"></a>	<span class='hs-keyglyph'>[</span> <span class='hs-str'>"-fparallel"</span>
<a name="line-563"></a>	<span class='hs-layout'>,</span> <span class='hs-str'>"-D__PARALLEL_HASKELL__"</span>
<a name="line-564"></a>	<span class='hs-layout'>,</span> <span class='hs-str'>"-D__DISTRIBUTED_HASKELL__"</span>
<a name="line-565"></a>	<span class='hs-layout'>,</span> <span class='hs-str'>"-optc-DPAR"</span>
<a name="line-566"></a>	<span class='hs-layout'>,</span> <span class='hs-str'>"-optc-DDIST"</span>
<a name="line-567"></a>	<span class='hs-layout'>,</span> <span class='hs-str'>"-package concurrent"</span>
<a name="line-568"></a>        <span class='hs-layout'>,</span> <span class='hs-str'>"-optc-w"</span>
<a name="line-569"></a>        <span class='hs-layout'>,</span> <span class='hs-str'>"-optl-L${PVM_ROOT}/lib/${PVM_ARCH}"</span>
<a name="line-570"></a>        <span class='hs-layout'>,</span> <span class='hs-str'>"-optl-lpvm3"</span>
<a name="line-571"></a>        <span class='hs-layout'>,</span> <span class='hs-str'>"-optl-lgpvm3"</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-572"></a>
<a name="line-573"></a>    <span class='hs-conid'>Way</span> <span class='hs-conid'>WayGran</span> <span class='hs-str'>"mg"</span> <span class='hs-conid'>False</span> <span class='hs-str'>"GranSim"</span>
<a name="line-574"></a>	<span class='hs-keyglyph'>[</span> <span class='hs-str'>"-fgransim"</span>
<a name="line-575"></a>	<span class='hs-layout'>,</span> <span class='hs-str'>"-D__GRANSIM__"</span>
<a name="line-576"></a>	<span class='hs-layout'>,</span> <span class='hs-str'>"-optc-DGRAN"</span>
<a name="line-577"></a>	<span class='hs-layout'>,</span> <span class='hs-str'>"-package concurrent"</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-578"></a>
<a name="line-579"></a>    <span class='hs-conid'>Way</span> <span class='hs-conid'>WayNDP</span> <span class='hs-str'>"ndp"</span> <span class='hs-conid'>False</span> <span class='hs-str'>"Nested data parallelism"</span>
<a name="line-580"></a>	<span class='hs-keyglyph'>[</span> <span class='hs-str'>"-XParr"</span>
<a name="line-581"></a>	<span class='hs-layout'>,</span> <span class='hs-str'>"-fvectorise"</span><span class='hs-keyglyph'>]</span>
<a name="line-582"></a>  <span class='hs-keyglyph'>]</span>
<a name="line-583"></a>
<a name="line-584"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-585"></a><span class='hs-comment'>-- Tunneling our global variables into a new instance of the GHC library</span>
<a name="line-586"></a>
<a name="line-587"></a><a name="saveStaticFlagGlobals"></a><span class='hs-comment'>-- Ignore the v_Ld_inputs global because:</span>
<a name="line-588"></a><span class='hs-comment'>--  a) It is mutated even once GHC has been initialised, which means that I'd</span>
<a name="line-589"></a><span class='hs-comment'>--     have to add another layer of indirection to truly share the value</span>
<a name="line-590"></a><span class='hs-comment'>--  b) We can get away without sharing it because it only affects the link,</span>
<a name="line-591"></a><span class='hs-comment'>--     and is mutated by the GHC exe. Users who load up a new copy of the GHC</span>
<a name="line-592"></a><span class='hs-comment'>--     library while another is running almost certainly won't actually access it.</span>
<a name="line-593"></a><span class='hs-definition'>saveStaticFlagGlobals</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Way</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-594"></a><span class='hs-definition'>saveStaticFlagGlobals</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM3</span> <span class='hs-conid'>(,,)</span> <span class='hs-layout'>(</span><span class='hs-varid'>readIORef</span> <span class='hs-varid'>v_opt_C_ready</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>readIORef</span> <span class='hs-varid'>v_opt_C</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>readIORef</span> <span class='hs-varid'>v_Ways</span><span class='hs-layout'>)</span>
<a name="line-595"></a>
<a name="line-596"></a><a name="restoreStaticFlagGlobals"></a><span class='hs-definition'>restoreStaticFlagGlobals</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Way</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-597"></a><span class='hs-definition'>restoreStaticFlagGlobals</span> <span class='hs-layout'>(</span><span class='hs-varid'>c_ready</span><span class='hs-layout'>,</span> <span class='hs-varid'>c</span><span class='hs-layout'>,</span> <span class='hs-varid'>ways</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-598"></a>    <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>v_opt_C_ready</span> <span class='hs-varid'>c_ready</span>
<a name="line-599"></a>    <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>v_opt_C</span> <span class='hs-varid'>c</span>
<a name="line-600"></a>    <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>v_Ways</span> <span class='hs-varid'>ways</span>
<a name="line-601"></a>
</pre></body>
</html>
