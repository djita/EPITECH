<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>codeGen/CgCon.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The GRASP Project, Glasgow University, 1992-1998
%
\section[CgCon]{Code generation for constructors}

This module provides the support code for @StgToAbstractC@ to deal
with {\em constructors} on the RHSs of let(rec)s.  See also
@CgClosure@, which deals with closures.

\begin{code}
<pre><a name="line-1"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>CgCon</span> <span class='hs-layout'>(</span>
<a name="line-2"></a>        <span class='hs-varid'>cgTopRhsCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>buildDynCon</span><span class='hs-layout'>,</span>
<a name="line-3"></a>        <span class='hs-varid'>bindConArgs</span><span class='hs-layout'>,</span> <span class='hs-varid'>bindUnboxedTupleComponents</span><span class='hs-layout'>,</span>
<a name="line-4"></a>        <span class='hs-varid'>cgReturnDataCon</span><span class='hs-layout'>,</span>
<a name="line-5"></a>        <span class='hs-varid'>cgTyCon</span>
<a name="line-6"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgMonad</span>
<a name="line-11"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>StgSyn</span>
<a name="line-12"></a>
<a name="line-13"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgBindery</span>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgStackery</span>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgUtils</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgCallConv</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgHeapery</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgTailCall</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgProf</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgTicky</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgInfoTbls</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CLabel</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ClosureInfo</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OldCmmUtils</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OldCmm</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SMRep</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CostCentre</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Constants</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>IdInfo</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelInfo</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ListSetOps</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Platform</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>StaticFlags</span>
<a name="line-43"></a>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
\subsection[toplevel-constructors]{Top-level constructors}
%*                                                                      *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="cgTopRhsCon"></a><span class='hs-definition'>cgTopRhsCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span>               <span class='hs-comment'>-- Name of thing bound to this RHS</span>
<a name="line-2"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DataCon</span>          <span class='hs-comment'>-- Id</span>
<a name="line-3"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StgArg</span><span class='hs-keyglyph'>]</span>         <span class='hs-comment'>-- Args</span>
<a name="line-4"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>CgIdInfo</span><span class='hs-layout'>)</span>
<a name="line-5"></a><span class='hs-definition'>cgTopRhsCon</span> <span class='hs-varid'>id</span> <span class='hs-varid'>con</span> <span class='hs-varid'>args</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-7"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>platformOS</span> <span class='hs-layout'>(</span><span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varop'>==</span> <span class='hs-conid'>OSMinGW32</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-8"></a>              <span class='hs-comment'>-- Windows DLLs have a problem with static cross-DLL refs.</span>
<a name="line-9"></a>              <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isDllConApp</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>con</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-10"></a>        <span class='hs-layout'>;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>args</span> <span class='hs-varop'>`lengthIs`</span> <span class='hs-varid'>dataConRepArity</span> <span class='hs-varid'>con</span> <span class='hs-layout'>)</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-11"></a>
<a name="line-12"></a>        <span class='hs-comment'>-- LAY IT OUT</span>
<a name="line-13"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>amodes</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getArgAmodes</span> <span class='hs-varid'>args</span>
<a name="line-14"></a>
<a name="line-15"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span>
<a name="line-16"></a>            <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span>
<a name="line-17"></a>            <span class='hs-varid'>name</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idName</span> <span class='hs-varid'>id</span>
<a name="line-18"></a>            <span class='hs-varid'>lf_info</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkConLFInfo</span> <span class='hs-varid'>con</span>
<a name="line-19"></a>            <span class='hs-varid'>closure_label</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkClosureLabel</span> <span class='hs-varid'>name</span> <span class='hs-varop'>$</span> <span class='hs-varid'>idCafInfo</span> <span class='hs-varid'>id</span>
<a name="line-20"></a>            <span class='hs-varid'>caffy</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>any</span> <span class='hs-varid'>stgArgHasCafRefs</span> <span class='hs-varid'>args</span>
<a name="line-21"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>closure_info</span><span class='hs-layout'>,</span> <span class='hs-varid'>amodes_w_offsets</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>layOutStaticConstr</span> <span class='hs-varid'>con</span> <span class='hs-varid'>amodes</span>
<a name="line-22"></a>            <span class='hs-varid'>closure_rep</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkStaticClosureFields</span>
<a name="line-23"></a>                             <span class='hs-varid'>closure_info</span>
<a name="line-24"></a>                             <span class='hs-varid'>dontCareCCS</span>                <span class='hs-comment'>-- Because it's static data</span>
<a name="line-25"></a>                             <span class='hs-varid'>caffy</span>                      <span class='hs-comment'>-- Has CAF refs</span>
<a name="line-26"></a>                             <span class='hs-varid'>payload</span>
<a name="line-27"></a>
<a name="line-28"></a>            <span class='hs-varid'>payload</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>get_lit</span> <span class='hs-varid'>amodes_w_offsets</span>
<a name="line-29"></a>            <span class='hs-varid'>get_lit</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLit</span> <span class='hs-varid'>lit</span><span class='hs-layout'>,</span> <span class='hs-sel'>_offset</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lit</span>
<a name="line-30"></a>            <span class='hs-varid'>get_lit</span> <span class='hs-varid'>other</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"CgCon.get_lit"</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprPlatform</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>other</span><span class='hs-layout'>)</span>
<a name="line-31"></a>                <span class='hs-comment'>-- NB1: amodes_w_offsets is sorted into ptrs first, then non-ptrs</span>
<a name="line-32"></a>                <span class='hs-comment'>-- NB2: all the amodes should be Lits!</span>
<a name="line-33"></a>
<a name="line-34"></a>                <span class='hs-comment'>-- BUILD THE OBJECT</span>
<a name="line-35"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>emitDataLits</span> <span class='hs-varid'>closure_label</span> <span class='hs-varid'>closure_rep</span>
<a name="line-36"></a>
<a name="line-37"></a>                <span class='hs-comment'>-- RETURN</span>
<a name="line-38"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>returnFC</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>taggedStableIdInfo</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLblExpr</span> <span class='hs-varid'>closure_label</span><span class='hs-layout'>)</span> <span class='hs-varid'>lf_info</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
%* non-top-level constructors                                           *
%*                                                                      *
%************************************************************************
\subsection[code-for-constructors]{The code for constructors}

\begin{code}
<pre><a name="line-1"></a><a name="buildDynCon"></a><span class='hs-definition'>buildDynCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span>                 <span class='hs-comment'>-- Name of the thing to which this constr will</span>
<a name="line-2"></a>                                  <span class='hs-comment'>-- be bound</span>
<a name="line-3"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CostCentreStack</span>    <span class='hs-comment'>-- Where to grab cost centre from;</span>
<a name="line-4"></a>                                  <span class='hs-comment'>-- current CCS if currentOrSubsumedCCS</span>
<a name="line-5"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DataCon</span>            <span class='hs-comment'>-- The data constructor</span>
<a name="line-6"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>CgRep</span><span class='hs-layout'>,</span><span class='hs-conid'>CmmExpr</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- Its args</span>
<a name="line-7"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>CgIdInfo</span>     <span class='hs-comment'>-- Return details about how to find it</span>
<a name="line-8"></a><span class='hs-definition'>buildDynCon</span> <span class='hs-varid'>binder</span> <span class='hs-varid'>ccs</span> <span class='hs-varid'>con</span> <span class='hs-varid'>args</span>
<a name="line-9"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-10"></a>         <span class='hs-varid'>buildDynCon'</span> <span class='hs-layout'>(</span><span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varid'>binder</span> <span class='hs-varid'>ccs</span> <span class='hs-varid'>con</span> <span class='hs-varid'>args</span>
<a name="line-11"></a>
<a name="line-12"></a><a name="buildDynCon'"></a><span class='hs-definition'>buildDynCon'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span>
<a name="line-13"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>
<a name="line-14"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CostCentreStack</span>
<a name="line-15"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DataCon</span>
<a name="line-16"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>CgRep</span><span class='hs-layout'>,</span><span class='hs-conid'>CmmExpr</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-17"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>CgIdInfo</span>
<a name="line-18"></a>
<a name="line-19"></a><span class='hs-comment'>-- We used to pass a boolean indicating whether all the</span>
<a name="line-20"></a><span class='hs-comment'>-- args were of size zero, so we could use a static</span>
<a name="line-21"></a><span class='hs-comment'>-- construtor; but I concluded that it just isn't worth it.</span>
<a name="line-22"></a><span class='hs-comment'>-- Now I/O uses unboxed tuples there just aren't any constructors</span>
<a name="line-23"></a><span class='hs-comment'>-- with all size-zero args.</span>
<a name="line-24"></a><span class='hs-comment'>--</span>
<a name="line-25"></a><span class='hs-comment'>-- The reason for having a separate argument, rather than looking at</span>
<a name="line-26"></a><span class='hs-comment'>-- the addr modes of the args is that we may be in a "knot", and</span>
<a name="line-27"></a><span class='hs-comment'>-- premature looking at the args will cause the compiler to black-hole!</span>
</pre>\end{code}

First we deal with the case of zero-arity constructors.  Now, they
will probably be unfolded, so we don't expect to see this case much,
if at all, but it does no harm, and sets the scene for characters.

In the case of zero-arity constructors, or, more accurately, those
which have exclusively size-zero (VoidRep) args, we generate no code
at all.

\begin{code}
<pre><a name="line-1"></a><a name="buildDynCon'"></a><span class='hs-definition'>buildDynCon'</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>binder</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>con</span> <span class='hs-conid'>[]</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>returnFC</span> <span class='hs-layout'>(</span><span class='hs-varid'>taggedStableIdInfo</span> <span class='hs-varid'>binder</span>
<a name="line-3"></a>                           <span class='hs-layout'>(</span><span class='hs-varid'>mkLblExpr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkClosureLabel</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConName</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span>
<a name="line-4"></a>                                      <span class='hs-layout'>(</span><span class='hs-varid'>idCafInfo</span> <span class='hs-varid'>binder</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-5"></a>                           <span class='hs-layout'>(</span><span class='hs-varid'>mkConLFInfo</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span>
<a name="line-6"></a>                           <span class='hs-varid'>con</span><span class='hs-layout'>)</span>
</pre>\end{code}

The following three paragraphs about @Char@-like and @Int@-like
closures are obsolete, but I don't understand the details well enough
to properly word them, sorry. I've changed the treatment of @Char@s to
be analogous to @Int@s: only a subset is preallocated, because @Char@
has now 31 bits. Only literals are handled here. -- Qrczak

Now for @Char@-like closures.  We generate an assignment of the
address of the closure to a temporary.  It would be possible simply to
generate no code, and record the addressing mode in the environment,
but we'd have to be careful if the argument wasn't a constant --- so
for simplicity we just always asssign to a temporary.

Last special case: @Int@-like closures.  We only special-case the
situation in which the argument is a literal in the range
@mIN_INTLIKE@..@mAX_INTLILKE@.  NB: for @Char@-like closures we can
work with any old argument, but for @Int@-like ones the argument has
to be a literal.  Reason: @Char@ like closures have an argument type
which is guaranteed in range.

Because of this, we use can safely return an addressing mode.

We don't support this optimisation when compiling into Windows DLLs yet
because they don't support cross package data references well.

\begin{code}
<pre><a name="line-1"></a>
<a name="line-2"></a>
<a name="line-3"></a><a name="buildDynCon'"></a><span class='hs-definition'>buildDynCon'</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>binder</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg_amode</span><span class='hs-keyglyph'>]</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>maybeIntLikeCon</span> <span class='hs-varid'>con</span>
<a name="line-5"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>platformOS</span> <span class='hs-varid'>platform</span> <span class='hs-varop'>/=</span> <span class='hs-conid'>OSMinGW32</span> <span class='hs-varop'>||</span> <span class='hs-varid'>not</span> <span class='hs-varid'>opt_PIC</span>
<a name="line-6"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>CmmLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmInt</span> <span class='hs-varid'>val</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>arg_amode</span>
<a name="line-7"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>val_int</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>val</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-8"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>val_int</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>mAX_INTLIKE</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>val_int</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>mIN_INTLIKE</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>intlike_lbl</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCmmGcPtrLabel</span> <span class='hs-varid'>rtsPackageId</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"stg_INTLIKE_closure"</span><span class='hs-layout'>)</span>
<a name="line-10"></a>              <span class='hs-varid'>offsetW</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>val_int</span> <span class='hs-comment'>-</span> <span class='hs-varid'>mIN_INTLIKE</span><span class='hs-layout'>)</span> <span class='hs-varop'>*</span> <span class='hs-layout'>(</span><span class='hs-varid'>fixedHdrSize</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-11"></a>                <span class='hs-comment'>-- INTLIKE closures consist of a header and one word payload</span>
<a name="line-12"></a>              <span class='hs-varid'>intlike_amode</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmLit</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmmLabelOffW</span> <span class='hs-varid'>intlike_lbl</span> <span class='hs-varid'>offsetW</span><span class='hs-layout'>)</span>
<a name="line-13"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>returnFC</span> <span class='hs-layout'>(</span><span class='hs-varid'>taggedStableIdInfo</span> <span class='hs-varid'>binder</span> <span class='hs-varid'>intlike_amode</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkConLFInfo</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-14"></a>
<a name="line-15"></a><span class='hs-definition'>buildDynCon'</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>binder</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg_amode</span><span class='hs-keyglyph'>]</span>
<a name="line-16"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>maybeCharLikeCon</span> <span class='hs-varid'>con</span>
<a name="line-17"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>platformOS</span> <span class='hs-varid'>platform</span> <span class='hs-varop'>/=</span> <span class='hs-conid'>OSMinGW32</span> <span class='hs-varop'>||</span> <span class='hs-varid'>not</span> <span class='hs-varid'>opt_PIC</span>
<a name="line-18"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>CmmLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmInt</span> <span class='hs-varid'>val</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>arg_amode</span>
<a name="line-19"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>val_int</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>val</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-20"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>val_int</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>mAX_CHARLIKE</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>val_int</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>mIN_CHARLIKE</span>
<a name="line-21"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>charlike_lbl</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCmmGcPtrLabel</span> <span class='hs-varid'>rtsPackageId</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"stg_CHARLIKE_closure"</span><span class='hs-layout'>)</span>
<a name="line-22"></a>              <span class='hs-varid'>offsetW</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>val_int</span> <span class='hs-comment'>-</span> <span class='hs-varid'>mIN_CHARLIKE</span><span class='hs-layout'>)</span> <span class='hs-varop'>*</span> <span class='hs-layout'>(</span><span class='hs-varid'>fixedHdrSize</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-23"></a>                <span class='hs-comment'>-- CHARLIKE closures consist of a header and one word payload</span>
<a name="line-24"></a>              <span class='hs-varid'>charlike_amode</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmLit</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmmLabelOffW</span> <span class='hs-varid'>charlike_lbl</span> <span class='hs-varid'>offsetW</span><span class='hs-layout'>)</span>
<a name="line-25"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>returnFC</span> <span class='hs-layout'>(</span><span class='hs-varid'>taggedStableIdInfo</span> <span class='hs-varid'>binder</span> <span class='hs-varid'>charlike_amode</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkConLFInfo</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-26"></a>
</pre>\end{code}

Now the general case.

\begin{code}
<pre><a name="line-1"></a><a name="buildDynCon'"></a><span class='hs-definition'>buildDynCon'</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>binder</span> <span class='hs-varid'>ccs</span> <span class='hs-varid'>con</span> <span class='hs-varid'>args</span>
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span>
<a name="line-3"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span>
<a name="line-4"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>closure_info</span><span class='hs-layout'>,</span> <span class='hs-varid'>amodes_w_offsets</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>layOutDynConstr</span> <span class='hs-varid'>con</span> <span class='hs-varid'>args</span>
<a name="line-5"></a>
<a name="line-6"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>hp_off</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>allocDynClosure</span> <span class='hs-varid'>closure_info</span> <span class='hs-varid'>use_cc</span> <span class='hs-varid'>blame_cc</span> <span class='hs-varid'>amodes_w_offsets</span>
<a name="line-7"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>returnFC</span> <span class='hs-layout'>(</span><span class='hs-varid'>taggedHeapIdInfo</span> <span class='hs-varid'>binder</span> <span class='hs-varid'>hp_off</span> <span class='hs-varid'>lf_info</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-8"></a>  <span class='hs-keyword'>where</span>
<a name="line-9"></a>    <span class='hs-varid'>lf_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkConLFInfo</span> <span class='hs-varid'>con</span>
<a name="line-10"></a>
<a name="line-11"></a>    <span class='hs-varid'>use_cc</span>  <span class='hs-comment'>-- cost-centre to stick in the object</span>
<a name="line-12"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isCurrentCCS</span> <span class='hs-varid'>ccs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>curCCS</span>
<a name="line-13"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"buildDynCon: non-current CCS not implemented"</span>
<a name="line-14"></a>
<a name="line-15"></a>    <span class='hs-varid'>blame_cc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>use_cc</span> <span class='hs-comment'>-- cost-centre on which to blame the alloc (same)</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
%* constructor-related utility function:                                *
%*              bindConArgs is called from cgAlt of a case              *
%*                                                                      *
%************************************************************************
\subsection[constructor-utilities]{@bindConArgs@: constructor-related utility}

@bindConArgs@ $con args$ augments the environment with bindings for the
binders $args$, assuming that we have just returned from a @case@ which
found a $con$.

\begin{code}
<pre><a name="line-1"></a><a name="bindConArgs"></a><span class='hs-definition'>bindConArgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-2"></a><span class='hs-definition'>bindConArgs</span> <span class='hs-varid'>con</span> <span class='hs-varid'>args</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-4"></a>       <span class='hs-keyword'>let</span>
<a name="line-5"></a>          <span class='hs-comment'>-- The binding below forces the masking out of the tag bits</span>
<a name="line-6"></a>          <span class='hs-comment'>-- when accessing the constructor field.</span>
<a name="line-7"></a>          <span class='hs-varid'>bind_arg</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>offset</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindNewToUntagNode</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>offset</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLFArgument</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tagForCon</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span>
<a name="line-8"></a>          <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>args_w_offsets</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>layOutDynConstr</span> <span class='hs-varid'>con</span> <span class='hs-layout'>(</span><span class='hs-varid'>addIdReps</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-9"></a>        <span class='hs-comment'>--</span>
<a name="line-10"></a>       <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isUnboxedTupleCon</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-11"></a>       <span class='hs-varid'>mapCs</span> <span class='hs-varid'>bind_arg</span> <span class='hs-varid'>args_w_offsets</span>
</pre>\end{code}

Unboxed tuples are handled slightly differently - the object is
returned in registers and on the stack instead of the heap.

\begin{code}
<pre><a name="line-1"></a><a name="bindUnboxedTupleComponents"></a><span class='hs-definition'>bindUnboxedTupleComponents</span>
<a name="line-2"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>                         <span class='hs-comment'>-- Args</span>
<a name="line-3"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>GlobalReg</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- Regs assigned</span>
<a name="line-4"></a>                  <span class='hs-conid'>WordOff</span><span class='hs-layout'>,</span>              <span class='hs-comment'>-- Number of pointer stack slots</span>
<a name="line-5"></a>                  <span class='hs-conid'>WordOff</span><span class='hs-layout'>,</span>              <span class='hs-comment'>-- Number of non-pointer stack slots</span>
<a name="line-6"></a>                  <span class='hs-conid'>VirtualSpOffset</span><span class='hs-layout'>)</span>      <span class='hs-comment'>-- Offset of return address slot</span>
<a name="line-7"></a>                                        <span class='hs-comment'>-- (= realSP on entry)</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-definition'>bindUnboxedTupleComponents</span> <span class='hs-varid'>args</span>
<a name="line-10"></a> <span class='hs-keyglyph'>=</span>  <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span>
<a name="line-11"></a>          <span class='hs-varid'>vsp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getVirtSp</span>
<a name="line-12"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>rsp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getRealSp</span>
<a name="line-13"></a>
<a name="line-14"></a>           <span class='hs-comment'>-- Assign as many components as possible to registers</span>
<a name="line-15"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>reg_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>stk_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>assignReturnRegs</span> <span class='hs-layout'>(</span><span class='hs-varid'>addIdReps</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-16"></a>
<a name="line-17"></a>                <span class='hs-comment'>-- Separate the rest of the args into pointers and non-pointers</span>
<a name="line-18"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>ptr_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>nptr_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>separateByPtrFollowness</span> <span class='hs-varid'>stk_args</span>
<a name="line-19"></a>
<a name="line-20"></a>                <span class='hs-comment'>-- Allocate the rest on the stack</span>
<a name="line-21"></a>                <span class='hs-comment'>-- The real SP points to the return address, above which any</span>
<a name="line-22"></a>                <span class='hs-comment'>-- leftover unboxed-tuple components will be allocated</span>
<a name="line-23"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>ptr_sp</span><span class='hs-layout'>,</span>  <span class='hs-varid'>ptr_offsets</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVirtStkOffsets</span> <span class='hs-varid'>rsp</span>    <span class='hs-varid'>ptr_args</span>
<a name="line-24"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>nptr_sp</span><span class='hs-layout'>,</span> <span class='hs-varid'>nptr_offsets</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVirtStkOffsets</span> <span class='hs-varid'>ptr_sp</span> <span class='hs-varid'>nptr_args</span>
<a name="line-25"></a>              <span class='hs-varid'>ptrs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptr_sp</span>  <span class='hs-comment'>-</span> <span class='hs-varid'>rsp</span>
<a name="line-26"></a>              <span class='hs-varid'>nptrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nptr_sp</span> <span class='hs-comment'>-</span> <span class='hs-varid'>ptr_sp</span>
<a name="line-27"></a>
<a name="line-28"></a>            <span class='hs-comment'>-- The stack pointer points to the last stack-allocated component</span>
<a name="line-29"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>setRealAndVirtualSp</span> <span class='hs-varid'>nptr_sp</span>
<a name="line-30"></a>
<a name="line-31"></a>            <span class='hs-comment'>-- We have just allocated slots starting at real SP + 1, and set the new</span>
<a name="line-32"></a>            <span class='hs-comment'>-- virtual SP to the topmost allocated slot.</span>
<a name="line-33"></a>            <span class='hs-comment'>-- If the virtual SP started *below* the real SP, we've just jumped over</span>
<a name="line-34"></a>            <span class='hs-comment'>-- some slots that won't be in the free-list, so put them there</span>
<a name="line-35"></a>            <span class='hs-comment'>-- This commonly happens because we've freed the return-address slot</span>
<a name="line-36"></a>            <span class='hs-comment'>-- (trimming back the virtual SP), but the real SP still points to that slot</span>
<a name="line-37"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>freeStackSlots</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>vsp</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>,</span><span class='hs-varid'>vsp</span><span class='hs-varop'>+</span><span class='hs-num'>2</span> <span class='hs-keyglyph'>..</span> <span class='hs-varid'>rsp</span><span class='hs-keyglyph'>]</span>
<a name="line-38"></a>
<a name="line-39"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>bindArgsToRegs</span> <span class='hs-varid'>reg_args</span>
<a name="line-40"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>bindArgsToStack</span> <span class='hs-varid'>ptr_offsets</span>
<a name="line-41"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>bindArgsToStack</span> <span class='hs-varid'>nptr_offsets</span>
<a name="line-42"></a>
<a name="line-43"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>returnFC</span> <span class='hs-layout'>(</span><span class='hs-varid'>reg_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>nptrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rsp</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}

%************************************************************************
%*                                                                      *
        Actually generate code for a constructor return
%*                                                                      *
%************************************************************************


Note: it's the responsibility of the @cgReturnDataCon@ caller to be
sure the @amodes@ passed don't conflict with each other.
\begin{code}
<pre><a name="line-1"></a><a name="cgReturnDataCon"></a><span class='hs-definition'>cgReturnDataCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>CgRep</span><span class='hs-layout'>,</span> <span class='hs-conid'>CmmExpr</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-definition'>cgReturnDataCon</span> <span class='hs-varid'>con</span> <span class='hs-varid'>amodes</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isUnboxedTupleCon</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>returnUnboxedTuple</span> <span class='hs-varid'>amodes</span>
<a name="line-5"></a>      <span class='hs-comment'>-- when profiling we can't shortcut here, we have to enter the closure</span>
<a name="line-6"></a>      <span class='hs-comment'>-- for it to be marked as "used" for LDV profiling.</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>opt_SccProfilingOn</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>build_it_then</span> <span class='hs-varid'>enter_it</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>amodes</span> <span class='hs-varop'>`lengthIs`</span> <span class='hs-varid'>dataConRepArity</span> <span class='hs-varid'>con</span> <span class='hs-layout'>)</span>
<a name="line-10"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-conid'>EndOfBlockInfo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>sequel</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getEndOfBlockInfo</span>
<a name="line-11"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>sequel</span> <span class='hs-keyword'>of</span>
<a name="line-12"></a>            <span class='hs-conid'>CaseAlts</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>alts</span><span class='hs-layout'>,</span> <span class='hs-varid'>deflt_lbl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>bndr</span>
<a name="line-13"></a>              <span class='hs-keyglyph'>-&gt;</span>    <span class='hs-comment'>-- Ho! We know the constructor so we can</span>
<a name="line-14"></a>                    <span class='hs-comment'>-- go straight to the right alternative</span>
<a name="line-15"></a>                 <span class='hs-keyword'>case</span> <span class='hs-varid'>assocMaybe</span> <span class='hs-varid'>alts</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConTagZ</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span>
<a name="line-16"></a>                    <span class='hs-conid'>Just</span> <span class='hs-varid'>join_lbl</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>build_it_then</span> <span class='hs-layout'>(</span><span class='hs-varid'>jump_to</span> <span class='hs-varid'>join_lbl</span><span class='hs-layout'>)</span><span class='hs-layout'>;</span>
<a name="line-17"></a>                    <span class='hs-conid'>Nothing</span>
<a name="line-18"></a>                        <span class='hs-comment'>-- Special case!  We're returning a constructor to the default case</span>
<a name="line-19"></a>                        <span class='hs-comment'>-- of an enclosing case.  For example:</span>
<a name="line-20"></a>                        <span class='hs-comment'>--</span>
<a name="line-21"></a>                        <span class='hs-comment'>--      case (case e of (a,b) -&gt; C a b) of</span>
<a name="line-22"></a>                        <span class='hs-comment'>--        D x -&gt; ...</span>
<a name="line-23"></a>                        <span class='hs-comment'>--        y   -&gt; ...&lt;returning here!&gt;...</span>
<a name="line-24"></a>                        <span class='hs-comment'>--</span>
<a name="line-25"></a>                        <span class='hs-comment'>-- In this case,</span>
<a name="line-26"></a>                        <span class='hs-comment'>--      if the default is a non-bind-default (ie does not use y),</span>
<a name="line-27"></a>                        <span class='hs-comment'>--      then we should simply jump to the default join point;</span>
<a name="line-28"></a>
<a name="line-29"></a>                        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isDeadBinder</span> <span class='hs-varid'>bndr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>performReturn</span> <span class='hs-layout'>(</span><span class='hs-varid'>jump_to</span> <span class='hs-varid'>deflt_lbl</span><span class='hs-layout'>)</span>
<a name="line-30"></a>                        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>build_it_then</span> <span class='hs-layout'>(</span><span class='hs-varid'>jump_to</span> <span class='hs-varid'>deflt_lbl</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-31"></a>
<a name="line-32"></a>            <span class='hs-sel'>_otherwise</span>  <span class='hs-comment'>-- The usual case</span>
<a name="line-33"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>build_it_then</span> <span class='hs-varid'>emitReturnInstr</span>
<a name="line-34"></a>        <span class='hs-layout'>}</span>
<a name="line-35"></a>  <span class='hs-keyword'>where</span>
<a name="line-36"></a>    <span class='hs-varid'>enter_it</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stmtsC</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>CmmAssign</span> <span class='hs-varid'>nodeReg</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmmUntag</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-varid'>nodeReg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-37"></a>                           <span class='hs-conid'>CmmJump</span> <span class='hs-layout'>(</span><span class='hs-varid'>entryCode</span> <span class='hs-layout'>(</span><span class='hs-varid'>closureInfoPtr</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-varid'>nodeReg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>]</span>
<a name="line-38"></a>    <span class='hs-varid'>jump_to</span> <span class='hs-varid'>lbl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stmtC</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmJump</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLit</span> <span class='hs-varid'>lbl</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-39"></a>    <span class='hs-varid'>build_it_then</span> <span class='hs-varid'>return_code</span>
<a name="line-40"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>    <span class='hs-comment'>-- BUILD THE OBJECT IN THE HEAP</span>
<a name="line-41"></a>                <span class='hs-comment'>-- The first "con" says that the name bound to this</span>
<a name="line-42"></a>                <span class='hs-comment'>-- closure is "con", which is a bit of a fudge, but it only</span>
<a name="line-43"></a>                <span class='hs-comment'>-- affects profiling</span>
<a name="line-44"></a>
<a name="line-45"></a>                <span class='hs-comment'>-- This Id is also used to get a unique for a</span>
<a name="line-46"></a>                <span class='hs-comment'>-- temporary variable, if the closure is a CHARLIKE.</span>
<a name="line-47"></a>                <span class='hs-comment'>-- funnily enough, this makes the unique always come</span>
<a name="line-48"></a>                <span class='hs-comment'>-- out as '54' :-)</span>
<a name="line-49"></a>             <span class='hs-varid'>tickyReturnNewCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>amodes</span><span class='hs-layout'>)</span>
<a name="line-50"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>idinfo</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>buildDynCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConWorkId</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-varid'>currentCCS</span> <span class='hs-varid'>con</span> <span class='hs-varid'>amodes</span>
<a name="line-51"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>amode</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>idInfoToAmode</span> <span class='hs-varid'>idinfo</span>
<a name="line-52"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>checkedAbsC</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmAssign</span> <span class='hs-varid'>nodeReg</span> <span class='hs-varid'>amode</span><span class='hs-layout'>)</span>
<a name="line-53"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>performReturn</span> <span class='hs-varid'>return_code</span> <span class='hs-layout'>}</span>
</pre>\end{code}


%************************************************************************
%*                                                                      *
        Generating static stuff for algebraic data types
%*                                                                      *
%************************************************************************

        [These comments are rather out of date]

\begin{tabular}{lll}
Info tbls &      Macro  &            Kind of constructor \\
\hline
info & @CONST_INFO_TABLE@&    Zero arity (no info -- compiler uses static closure)\\
info & @CHARLIKE_INFO_TABLE@& Charlike   (no info -- compiler indexes fixed array)\\
info & @INTLIKE_INFO_TABLE@&  Intlike; the one macro generates both info tbls\\
info & @SPEC_INFO_TABLE@&     SPECish, and bigger than or equal to @MIN_UPD_SIZE@\\
info & @GEN_INFO_TABLE@&      GENish (hence bigger than or equal to @MIN_UPD_SIZE@)\\
\end{tabular}

Possible info tables for constructor con:

\begin{description}
\item[@_con_info@:]
Used for dynamically let(rec)-bound occurrences of
the constructor, and for updates.  For constructors
which are int-like, char-like or nullary, when GC occurs,
the closure tries to get rid of itself.

\item[@_static_info@:]
Static occurrences of the constructor
macro: @STATIC_INFO_TABLE@.
\end{description}

For zero-arity constructors, \tr{con}, we NO LONGER generate a static closure;
it's place is taken by the top level defn of the constructor.

For charlike and intlike closures there is a fixed array of static
closures predeclared.

\begin{code}
<pre><a name="line-1"></a><a name="cgTyCon"></a><span class='hs-definition'>cgTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>CmmGroup</span>  <span class='hs-comment'>-- each constructor gets a separate CmmGroup</span>
<a name="line-2"></a><span class='hs-definition'>cgTyCon</span> <span class='hs-varid'>tycon</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>constrs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>getCmm</span> <span class='hs-varop'>.</span> <span class='hs-varid'>cgDataCon</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConDataCons</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span>
<a name="line-4"></a>
<a name="line-5"></a>            <span class='hs-comment'>-- Generate a table of static closures for an enumeration type</span>
<a name="line-6"></a>            <span class='hs-comment'>-- Put the table after the data constructor decls, because the</span>
<a name="line-7"></a>            <span class='hs-comment'>-- datatype closure table (for enumeration types)</span>
<a name="line-8"></a>            <span class='hs-comment'>-- to (say) PrelBase_$wTrue_closure, which is defined in code_stuff</span>
<a name="line-9"></a>            <span class='hs-comment'>-- Note that the closure pointers are tagged.</span>
<a name="line-10"></a>
<a name="line-11"></a>            <span class='hs-comment'>-- XXX comment says to put table after constructor decls, but</span>
<a name="line-12"></a>            <span class='hs-comment'>-- code appears to put it before --- NR 16 Aug 2007</span>
<a name="line-13"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>extra</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-14"></a>           <span class='hs-keyword'>if</span> <span class='hs-varid'>isEnumerationTyCon</span> <span class='hs-varid'>tycon</span> <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span>
<a name="line-15"></a>                <span class='hs-varid'>tbl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCmm</span> <span class='hs-layout'>(</span><span class='hs-varid'>emitRODataLits</span> <span class='hs-str'>"cgTyCon"</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLocalClosureTableLabel</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConName</span> <span class='hs-varid'>tycon</span><span class='hs-layout'>)</span> <span class='hs-conid'>NoCafRefs</span><span class='hs-layout'>)</span>
<a name="line-16"></a>                           <span class='hs-keyglyph'>[</span> <span class='hs-conid'>CmmLabelOff</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLocalClosureLabel</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConName</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-conid'>NoCafRefs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tagForCon</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span>
<a name="line-17"></a>                           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>con</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConDataCons</span> <span class='hs-varid'>tycon</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-18"></a>                <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tbl</span><span class='hs-keyglyph'>]</span>
<a name="line-19"></a>           <span class='hs-keyword'>else</span>
<a name="line-20"></a>                <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>
<a name="line-21"></a>
<a name="line-22"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>concat</span> <span class='hs-layout'>(</span><span class='hs-varid'>extra</span> <span class='hs-varop'>++</span> <span class='hs-varid'>constrs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-23"></a>    <span class='hs-layout'>}</span>
</pre>\end{code}

Generate the entry code, info tables, and (for niladic constructor) the
static closure, for a constructor.

\begin{code}
<pre><a name="line-1"></a><a name="cgDataCon"></a><span class='hs-definition'>cgDataCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-2"></a><span class='hs-definition'>cgDataCon</span> <span class='hs-varid'>data_con</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span>     <span class='hs-comment'>-- Don't need any dynamic closure code for zero-arity constructors</span>
<a name="line-4"></a>
<a name="line-5"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span>
<a name="line-6"></a>            <span class='hs-comment'>-- To allow the debuggers, interpreters, etc to cope with</span>
<a name="line-7"></a>            <span class='hs-comment'>-- static data structures (ie those built at compile</span>
<a name="line-8"></a>            <span class='hs-comment'>-- time), we take care that info-table contains the</span>
<a name="line-9"></a>            <span class='hs-comment'>-- information we need.</span>
<a name="line-10"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>static_cl_info</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-11"></a>                <span class='hs-varid'>layOutStaticConstr</span> <span class='hs-varid'>data_con</span> <span class='hs-varid'>arg_reps</span>
<a name="line-12"></a>
<a name="line-13"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>dyn_cl_info</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_things</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-14"></a>                <span class='hs-varid'>layOutDynConstr</span>    <span class='hs-varid'>data_con</span> <span class='hs-varid'>arg_reps</span>
<a name="line-15"></a>
<a name="line-16"></a>            <span class='hs-varid'>emit_info</span> <span class='hs-varid'>cl_info</span> <span class='hs-varid'>ticky_code</span>
<a name="line-17"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>code_blks</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCgStmts</span> <span class='hs-varid'>the_code</span>
<a name="line-18"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>emitClosureCodeAndInfoTable</span> <span class='hs-varid'>cl_info</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>code_blks</span> <span class='hs-layout'>}</span>
<a name="line-19"></a>                <span class='hs-keyword'>where</span>
<a name="line-20"></a>                  <span class='hs-varid'>the_code</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ticky_code</span>
<a name="line-21"></a>                                <span class='hs-layout'>;</span> <span class='hs-varid'>ldvEnter</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-varid'>nodeReg</span><span class='hs-layout'>)</span>
<a name="line-22"></a>                                <span class='hs-layout'>;</span> <span class='hs-varid'>body_code</span> <span class='hs-layout'>}</span>
<a name="line-23"></a>
<a name="line-24"></a>            <span class='hs-varid'>arg_reps</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>CgRep</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-25"></a>            <span class='hs-varid'>arg_reps</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>typeCgRep</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dataConRepArgTys</span> <span class='hs-varid'>data_con</span><span class='hs-keyglyph'>]</span>
<a name="line-26"></a>
<a name="line-27"></a>            <span class='hs-varid'>body_code</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-28"></a>                        <span class='hs-comment'>-- NB: We don't set CC when entering data (WDP 94/06)</span>
<a name="line-29"></a>                             <span class='hs-varid'>tickyReturnOldCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>arg_things</span><span class='hs-layout'>)</span>
<a name="line-30"></a>                           <span class='hs-comment'>-- The case continuation code is expecting a tagged pointer</span>
<a name="line-31"></a>                           <span class='hs-layout'>;</span> <span class='hs-varid'>stmtC</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmAssign</span> <span class='hs-varid'>nodeReg</span>
<a name="line-32"></a>                                              <span class='hs-layout'>(</span><span class='hs-varid'>tagCons</span> <span class='hs-varid'>data_con</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-varid'>nodeReg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-33"></a>                           <span class='hs-layout'>;</span> <span class='hs-varid'>performReturn</span> <span class='hs-varid'>emitReturnInstr</span> <span class='hs-layout'>}</span>
<a name="line-34"></a>                                <span class='hs-comment'>-- noStmts: Ptr to thing already in Node</span>
<a name="line-35"></a>
<a name="line-36"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>whenC</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isNullaryRepDataCon</span> <span class='hs-varid'>data_con</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-37"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>emit_info</span> <span class='hs-varid'>dyn_cl_info</span> <span class='hs-varid'>tickyEnterDynCon</span><span class='hs-layout'>)</span>
<a name="line-38"></a>
<a name="line-39"></a>                <span class='hs-comment'>-- Dynamic-Closure first, to reduce forward references</span>
<a name="line-40"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>emit_info</span> <span class='hs-varid'>static_cl_info</span> <span class='hs-varid'>tickyEnterStaticCon</span> <span class='hs-layout'>}</span>
</pre>\end{code}
</body>
</html>
