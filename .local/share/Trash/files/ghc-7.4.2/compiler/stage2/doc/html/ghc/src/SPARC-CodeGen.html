<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>nativeGen/SPARC/CodeGen.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-2"></a><span class='hs-comment'>--</span>
<a name="line-3"></a><span class='hs-comment'>-- Generating machine code (instruction selection)</span>
<a name="line-4"></a><span class='hs-comment'>--</span>
<a name="line-5"></a><span class='hs-comment'>-- (c) The University of Glasgow 1996-2004</span>
<a name="line-6"></a><span class='hs-comment'>--</span>
<a name="line-7"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-10"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-11"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-12"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-13"></a><span class='hs-comment'>--     <a href="http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-14"></a><span class='hs-comment'>-- for details</span>
<a name="line-15"></a>
<a name="line-16"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>SPARC</span><span class='hs-varop'>.</span><span class='hs-conid'>CodeGen</span> <span class='hs-layout'>(</span> 
<a name="line-17"></a>	<span class='hs-varid'>cmmTopCodeGen</span><span class='hs-layout'>,</span> 
<a name="line-18"></a>	<span class='hs-varid'>generateJumpTableForInstr</span><span class='hs-layout'>,</span>
<a name="line-19"></a>	<span class='hs-conid'>InstrBlock</span> 
<a name="line-20"></a><span class='hs-layout'>)</span> 
<a name="line-21"></a>
<a name="line-22"></a><span class='hs-keyword'>where</span>
<a name="line-23"></a>
<a name="line-24"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-25"></a><span class='hs-cpp'>#include "nativeGen/NCG.h"</span>
<a name="line-26"></a><span class='hs-cpp'>#include "../includes/MachDeps.h"</span>
<a name="line-27"></a>
<a name="line-28"></a><span class='hs-comment'>-- NCG stuff:</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SPARC</span><span class='hs-varop'>.</span><span class='hs-conid'>CodeGen</span><span class='hs-varop'>.</span><span class='hs-conid'>Sanity</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SPARC</span><span class='hs-varop'>.</span><span class='hs-conid'>CodeGen</span><span class='hs-varop'>.</span><span class='hs-conid'>Amode</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SPARC</span><span class='hs-varop'>.</span><span class='hs-conid'>CodeGen</span><span class='hs-varop'>.</span><span class='hs-conid'>CondCode</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SPARC</span><span class='hs-varop'>.</span><span class='hs-conid'>CodeGen</span><span class='hs-varop'>.</span><span class='hs-conid'>Gen64</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SPARC</span><span class='hs-varop'>.</span><span class='hs-conid'>CodeGen</span><span class='hs-varop'>.</span><span class='hs-conid'>Gen32</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SPARC</span><span class='hs-varop'>.</span><span class='hs-conid'>CodeGen</span><span class='hs-varop'>.</span><span class='hs-conid'>CCall</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SPARC</span><span class='hs-varop'>.</span><span class='hs-conid'>CodeGen</span><span class='hs-varop'>.</span><span class='hs-conid'>Base</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SPARC</span><span class='hs-varop'>.</span><span class='hs-conid'>Ppr</span>	<span class='hs-conid'>()</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SPARC</span><span class='hs-varop'>.</span><span class='hs-conid'>Instr</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SPARC</span><span class='hs-varop'>.</span><span class='hs-conid'>Imm</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SPARC</span><span class='hs-varop'>.</span><span class='hs-conid'>AddrMode</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SPARC</span><span class='hs-varop'>.</span><span class='hs-conid'>Regs</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Instruction</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Size</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NCGMonad</span>
<a name="line-44"></a>
<a name="line-45"></a><span class='hs-comment'>-- Our intermediate code:</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BlockId</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OldCmm</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CLabel</span>
<a name="line-49"></a>
<a name="line-50"></a><span class='hs-comment'>-- The rest:</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>StaticFlags</span>	<span class='hs-layout'>(</span> <span class='hs-varid'>opt_PIC</span> <span class='hs-layout'>)</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OrdList</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Platform</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unique</span>
<a name="line-57"></a>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>	<span class='hs-layout'>(</span> <span class='hs-varid'>mapAndUnzipM</span> <span class='hs-layout'>)</span>
<a name="line-59"></a>
<a name="line-60"></a><a name="cmmTopCodeGen"></a><span class='hs-comment'>-- | Top level code generation</span>
<a name="line-61"></a><span class='hs-definition'>cmmTopCodeGen</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RawCmmDecl</span>
<a name="line-62"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NatM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>NatCmmDecl</span> <span class='hs-conid'>CmmStatics</span> <span class='hs-conid'>Instr</span><span class='hs-keyglyph'>]</span>
<a name="line-63"></a>
<a name="line-64"></a><span class='hs-definition'>cmmTopCodeGen</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmProc</span> <span class='hs-varid'>info</span> <span class='hs-varid'>lab</span> <span class='hs-layout'>(</span><span class='hs-conid'>ListGraph</span> <span class='hs-varid'>blocks</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-65"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-66"></a>      <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlagsNat</span>
<a name="line-67"></a>      <span class='hs-keyword'>let</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span>
<a name="line-68"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>nat_blocks</span><span class='hs-layout'>,</span><span class='hs-varid'>statics</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndUnzipM</span> <span class='hs-layout'>(</span><span class='hs-varid'>basicBlockCodeGen</span> <span class='hs-varid'>platform</span><span class='hs-layout'>)</span> <span class='hs-varid'>blocks</span>
<a name="line-69"></a>
<a name="line-70"></a>      <span class='hs-keyword'>let</span> <span class='hs-varid'>proc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmProc</span> <span class='hs-varid'>info</span> <span class='hs-varid'>lab</span> <span class='hs-layout'>(</span><span class='hs-conid'>ListGraph</span> <span class='hs-varop'>$</span> <span class='hs-varid'>concat</span> <span class='hs-varid'>nat_blocks</span><span class='hs-layout'>)</span>
<a name="line-71"></a>      <span class='hs-keyword'>let</span> <span class='hs-varid'>tops</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>proc</span> <span class='hs-conop'>:</span> <span class='hs-varid'>concat</span> <span class='hs-varid'>statics</span>
<a name="line-72"></a>
<a name="line-73"></a>      <span class='hs-varid'>return</span> <span class='hs-varid'>tops</span>
<a name="line-74"></a>
<a name="line-75"></a><span class='hs-definition'>cmmTopCodeGen</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmData</span> <span class='hs-varid'>sec</span> <span class='hs-varid'>dat</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-76"></a>  <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmData</span> <span class='hs-varid'>sec</span> <span class='hs-varid'>dat</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- no translation, we just use CmmStatic</span>
<a name="line-77"></a>
<a name="line-78"></a>
<a name="line-79"></a><a name="basicBlockCodeGen"></a><span class='hs-comment'>-- | Do code generation on a single block of CMM code.</span>
<a name="line-80"></a><span class='hs-comment'>--	code generation may introduce new basic block boundaries, which</span>
<a name="line-81"></a><span class='hs-comment'>-- 	are indicated by the NEWBLOCK instruction.  We must split up the</span>
<a name="line-82"></a><span class='hs-comment'>-- 	instruction stream into basic blocks again.  Also, we extract</span>
<a name="line-83"></a><span class='hs-comment'>-- 	LDATAs here too.</span>
<a name="line-84"></a><span class='hs-definition'>basicBlockCodeGen</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span>
<a name="line-85"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmBasicBlock</span>
<a name="line-86"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NatM</span> <span class='hs-layout'>(</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>NatBasicBlock</span> <span class='hs-conid'>Instr</span><span class='hs-keyglyph'>]</span>
<a name="line-87"></a>                          <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>NatCmmDecl</span> <span class='hs-conid'>CmmStatics</span> <span class='hs-conid'>Instr</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-88"></a>
<a name="line-89"></a><span class='hs-definition'>basicBlockCodeGen</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>cmm</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>BasicBlock</span> <span class='hs-varid'>id</span> <span class='hs-varid'>stmts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-90"></a>  <span class='hs-varid'>instrs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stmtsToInstrs</span> <span class='hs-varid'>stmts</span>
<a name="line-91"></a>  <span class='hs-keyword'>let</span>
<a name="line-92"></a>	<span class='hs-layout'>(</span><span class='hs-varid'>top</span><span class='hs-layout'>,</span><span class='hs-varid'>other_blocks</span><span class='hs-layout'>,</span><span class='hs-varid'>statics</span><span class='hs-layout'>)</span> 
<a name="line-93"></a>		<span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrOL</span> <span class='hs-varid'>mkBlocks</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-varid'>instrs</span>
<a name="line-94"></a>	
<a name="line-95"></a>	<span class='hs-varid'>mkBlocks</span> <span class='hs-layout'>(</span><span class='hs-conid'>NEWBLOCK</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>instrs</span><span class='hs-layout'>,</span><span class='hs-varid'>blocks</span><span class='hs-layout'>,</span><span class='hs-varid'>statics</span><span class='hs-layout'>)</span> 
<a name="line-96"></a>	  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>BasicBlock</span> <span class='hs-varid'>id</span> <span class='hs-varid'>instrs</span> <span class='hs-conop'>:</span> <span class='hs-varid'>blocks</span><span class='hs-layout'>,</span> <span class='hs-varid'>statics</span><span class='hs-layout'>)</span>
<a name="line-97"></a>
<a name="line-98"></a>	<span class='hs-varid'>mkBlocks</span> <span class='hs-layout'>(</span><span class='hs-conid'>LDATA</span> <span class='hs-varid'>sec</span> <span class='hs-varid'>dat</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>instrs</span><span class='hs-layout'>,</span><span class='hs-varid'>blocks</span><span class='hs-layout'>,</span><span class='hs-varid'>statics</span><span class='hs-layout'>)</span> 
<a name="line-99"></a>	  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>instrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>blocks</span><span class='hs-layout'>,</span> <span class='hs-conid'>CmmData</span> <span class='hs-varid'>sec</span> <span class='hs-varid'>dat</span><span class='hs-conop'>:</span><span class='hs-varid'>statics</span><span class='hs-layout'>)</span>
<a name="line-100"></a>
<a name="line-101"></a>	<span class='hs-varid'>mkBlocks</span> <span class='hs-varid'>instr</span> <span class='hs-layout'>(</span><span class='hs-varid'>instrs</span><span class='hs-layout'>,</span><span class='hs-varid'>blocks</span><span class='hs-layout'>,</span><span class='hs-varid'>statics</span><span class='hs-layout'>)</span>
<a name="line-102"></a>	  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>instr</span><span class='hs-conop'>:</span><span class='hs-varid'>instrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>blocks</span><span class='hs-layout'>,</span> <span class='hs-varid'>statics</span><span class='hs-layout'>)</span>
<a name="line-103"></a>
<a name="line-104"></a>	<span class='hs-comment'>-- do intra-block sanity checking</span>
<a name="line-105"></a>	<span class='hs-varid'>blocksChecked</span>
<a name="line-106"></a>	  	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>checkBlock</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>cmm</span><span class='hs-layout'>)</span>
<a name="line-107"></a>	  	<span class='hs-varop'>$</span> <span class='hs-conid'>BasicBlock</span> <span class='hs-varid'>id</span> <span class='hs-varid'>top</span> <span class='hs-conop'>:</span> <span class='hs-varid'>other_blocks</span>
<a name="line-108"></a>
<a name="line-109"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>blocksChecked</span><span class='hs-layout'>,</span> <span class='hs-varid'>statics</span><span class='hs-layout'>)</span>
<a name="line-110"></a>
<a name="line-111"></a>
<a name="line-112"></a><a name="stmtsToInstrs"></a><span class='hs-comment'>-- | Convert some Cmm statements to SPARC instructions.</span>
<a name="line-113"></a><span class='hs-definition'>stmtsToInstrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmStmt</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NatM</span> <span class='hs-conid'>InstrBlock</span>
<a name="line-114"></a><span class='hs-definition'>stmtsToInstrs</span> <span class='hs-varid'>stmts</span>
<a name="line-115"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>instrss</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>stmtToInstrs</span> <span class='hs-varid'>stmts</span>
<a name="line-116"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>concatOL</span> <span class='hs-varid'>instrss</span><span class='hs-layout'>)</span>
<a name="line-117"></a>
<a name="line-118"></a>
<a name="line-119"></a><a name="stmtToInstrs"></a><span class='hs-definition'>stmtToInstrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmStmt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NatM</span> <span class='hs-conid'>InstrBlock</span>
<a name="line-120"></a><span class='hs-definition'>stmtToInstrs</span> <span class='hs-varid'>stmt</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>stmt</span> <span class='hs-keyword'>of</span>
<a name="line-121"></a>    <span class='hs-conid'>CmmNop</span>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>nilOL</span>
<a name="line-122"></a>    <span class='hs-conid'>CmmComment</span> <span class='hs-varid'>s</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitOL</span> <span class='hs-layout'>(</span><span class='hs-conid'>COMMENT</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-123"></a>
<a name="line-124"></a>    <span class='hs-conid'>CmmAssign</span> <span class='hs-varid'>reg</span> <span class='hs-varid'>src</span>
<a name="line-125"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isFloatType</span> <span class='hs-varid'>ty</span>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>assignReg_FltCode</span> <span class='hs-varid'>size</span> <span class='hs-varid'>reg</span> <span class='hs-varid'>src</span>
<a name="line-126"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isWord64</span> <span class='hs-varid'>ty</span>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>assignReg_I64Code</span>      <span class='hs-varid'>reg</span> <span class='hs-varid'>src</span>
<a name="line-127"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>assignReg_IntCode</span> <span class='hs-varid'>size</span> <span class='hs-varid'>reg</span> <span class='hs-varid'>src</span>
<a name="line-128"></a>	<span class='hs-keyword'>where</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmmRegType</span> <span class='hs-varid'>reg</span>
<a name="line-129"></a>	      <span class='hs-varid'>size</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmmTypeSize</span> <span class='hs-varid'>ty</span>
<a name="line-130"></a>
<a name="line-131"></a>    <span class='hs-conid'>CmmStore</span> <span class='hs-varid'>addr</span> <span class='hs-varid'>src</span>
<a name="line-132"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isFloatType</span> <span class='hs-varid'>ty</span>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>assignMem_FltCode</span> <span class='hs-varid'>size</span> <span class='hs-varid'>addr</span> <span class='hs-varid'>src</span>
<a name="line-133"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isWord64</span> <span class='hs-varid'>ty</span>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>assignMem_I64Code</span>      <span class='hs-varid'>addr</span> <span class='hs-varid'>src</span>
<a name="line-134"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>assignMem_IntCode</span> <span class='hs-varid'>size</span> <span class='hs-varid'>addr</span> <span class='hs-varid'>src</span>
<a name="line-135"></a>	<span class='hs-keyword'>where</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmmExprType</span> <span class='hs-varid'>src</span>
<a name="line-136"></a>	      <span class='hs-varid'>size</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmmTypeSize</span> <span class='hs-varid'>ty</span>
<a name="line-137"></a>
<a name="line-138"></a>    <span class='hs-conid'>CmmCall</span> <span class='hs-varid'>target</span> <span class='hs-varid'>result_regs</span> <span class='hs-varid'>args</span> <span class='hs-keyword'>_</span>
<a name="line-139"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>genCCall</span> <span class='hs-varid'>target</span> <span class='hs-varid'>result_regs</span> <span class='hs-varid'>args</span>
<a name="line-140"></a>
<a name="line-141"></a>    <span class='hs-conid'>CmmBranch</span>	<span class='hs-varid'>id</span>		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>genBranch</span> <span class='hs-varid'>id</span>
<a name="line-142"></a>    <span class='hs-conid'>CmmCondBranch</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>id</span>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>genCondJump</span> <span class='hs-varid'>id</span> <span class='hs-varid'>arg</span>
<a name="line-143"></a>    <span class='hs-conid'>CmmSwitch</span>	<span class='hs-varid'>arg</span> <span class='hs-varid'>ids</span>		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>genSwitch</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>ids</span>
<a name="line-144"></a>    <span class='hs-conid'>CmmJump</span>	<span class='hs-varid'>arg</span> <span class='hs-keyword'>_</span>		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>genJump</span> <span class='hs-varid'>arg</span>
<a name="line-145"></a>
<a name="line-146"></a>    <span class='hs-conid'>CmmReturn</span>	<span class='hs-keyword'>_</span>		
<a name="line-147"></a>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"stmtToInstrs: return statement should have been cps'd away"</span>
<a name="line-148"></a>
<a name="line-149"></a>
<a name="line-150"></a><span class='hs-comment'>{-
<a name="line-151"></a>Now, given a tree (the argument to an CmmLoad) that references memory,
<a name="line-152"></a>produce a suitable addressing mode.
<a name="line-153"></a>
<a name="line-154"></a>A Rule of the Game (tm) for Amodes: use of the addr bit must
<a name="line-155"></a>immediately follow use of the code part, since the code part puts
<a name="line-156"></a>values in registers which the addr then refers to.  So you can't put
<a name="line-157"></a>anything in between, lest it overwrite some of those registers.  If
<a name="line-158"></a>you need to do some other computation between the code part and use of
<a name="line-159"></a>the addr bit, first store the effective address from the amode in a
<a name="line-160"></a>temporary, then do the other computation, and then use the temporary:
<a name="line-161"></a>
<a name="line-162"></a>    code
<a name="line-163"></a>    LEA amode, tmp
<a name="line-164"></a>    ... other computation ...
<a name="line-165"></a>    ... (tmp) ...
<a name="line-166"></a>-}</span>
<a name="line-167"></a>
<a name="line-168"></a>
<a name="line-169"></a>
<a name="line-170"></a><a name="jumpTableEntry"></a><span class='hs-comment'>-- | Convert a BlockId to some CmmStatic data</span>
<a name="line-171"></a><span class='hs-definition'>jumpTableEntry</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>BlockId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmStatic</span>
<a name="line-172"></a><span class='hs-definition'>jumpTableEntry</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmStaticLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmInt</span> <span class='hs-num'>0</span> <span class='hs-varid'>wordWidth</span><span class='hs-layout'>)</span>
<a name="line-173"></a><span class='hs-definition'>jumpTableEntry</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>blockid</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmStaticLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLabel</span> <span class='hs-varid'>blockLabel</span><span class='hs-layout'>)</span>
<a name="line-174"></a>    <span class='hs-keyword'>where</span> <span class='hs-varid'>blockLabel</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAsmTempLabel</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varid'>blockid</span><span class='hs-layout'>)</span>
<a name="line-175"></a>
<a name="line-176"></a>
<a name="line-177"></a>
<a name="line-178"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-179"></a><span class='hs-comment'>-- Generating assignments</span>
<a name="line-180"></a>
<a name="line-181"></a><span class='hs-comment'>-- Assignments are really at the heart of the whole code generation</span>
<a name="line-182"></a><span class='hs-comment'>-- business.  Almost all top-level nodes of any real importance are</span>
<a name="line-183"></a><span class='hs-comment'>-- assignments, which correspond to loads, stores, or register</span>
<a name="line-184"></a><span class='hs-comment'>-- transfers.  If we're really lucky, some of the register transfers</span>
<a name="line-185"></a><span class='hs-comment'>-- will go away, because we can use the destination register to</span>
<a name="line-186"></a><span class='hs-comment'>-- complete the code generation for the right hand side.  This only</span>
<a name="line-187"></a><span class='hs-comment'>-- fails when the right hand side is forced into a fixed register</span>
<a name="line-188"></a><span class='hs-comment'>-- (e.g. the result of a call).</span>
<a name="line-189"></a>
<a name="line-190"></a><a name="assignMem_IntCode"></a><span class='hs-definition'>assignMem_IntCode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Size</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NatM</span> <span class='hs-conid'>InstrBlock</span>
<a name="line-191"></a><span class='hs-definition'>assignMem_IntCode</span> <span class='hs-varid'>pk</span> <span class='hs-varid'>addr</span> <span class='hs-varid'>src</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-192"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>srcReg</span><span class='hs-layout'>,</span> <span class='hs-varid'>code</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSomeReg</span> <span class='hs-varid'>src</span>
<a name="line-193"></a>    <span class='hs-conid'>Amode</span> <span class='hs-varid'>dstAddr</span> <span class='hs-varid'>addr_code</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getAmode</span> <span class='hs-varid'>addr</span>
<a name="line-194"></a>    <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>code</span> <span class='hs-varop'>`appOL`</span> <span class='hs-varid'>addr_code</span> <span class='hs-varop'>`snocOL`</span> <span class='hs-conid'>ST</span> <span class='hs-varid'>pk</span> <span class='hs-varid'>srcReg</span> <span class='hs-varid'>dstAddr</span>
<a name="line-195"></a>
<a name="line-196"></a>
<a name="line-197"></a><a name="assignReg_IntCode"></a><span class='hs-definition'>assignReg_IntCode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Size</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmReg</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NatM</span> <span class='hs-conid'>InstrBlock</span>
<a name="line-198"></a><span class='hs-definition'>assignReg_IntCode</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>reg</span> <span class='hs-varid'>src</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-199"></a>    <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getRegister</span> <span class='hs-varid'>src</span>
<a name="line-200"></a>    <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>r</span> <span class='hs-keyword'>of</span>
<a name="line-201"></a>	<span class='hs-conid'>Any</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>code</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>code</span> <span class='hs-varid'>dst</span>
<a name="line-202"></a>	<span class='hs-conid'>Fixed</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>freg</span> <span class='hs-varid'>fcode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fcode</span> <span class='hs-varop'>`snocOL`</span> <span class='hs-conid'>OR</span> <span class='hs-conid'>False</span> <span class='hs-varid'>g0</span> <span class='hs-layout'>(</span><span class='hs-conid'>RIReg</span> <span class='hs-varid'>freg</span><span class='hs-layout'>)</span> <span class='hs-varid'>dst</span>
<a name="line-203"></a>    <span class='hs-keyword'>where</span>
<a name="line-204"></a>      <span class='hs-varid'>dst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getRegisterReg</span> <span class='hs-varid'>reg</span>
<a name="line-205"></a>
<a name="line-206"></a>
<a name="line-207"></a>
<a name="line-208"></a><a name="assignMem_FltCode"></a><span class='hs-comment'>-- Floating point assignment to memory</span>
<a name="line-209"></a><span class='hs-definition'>assignMem_FltCode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Size</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NatM</span> <span class='hs-conid'>InstrBlock</span>
<a name="line-210"></a><span class='hs-definition'>assignMem_FltCode</span> <span class='hs-varid'>pk</span> <span class='hs-varid'>addr</span> <span class='hs-varid'>src</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-211"></a>    <span class='hs-conid'>Amode</span> <span class='hs-varid'>dst__2</span> <span class='hs-varid'>code1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getAmode</span> <span class='hs-varid'>addr</span>
<a name="line-212"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>src__2</span><span class='hs-layout'>,</span> <span class='hs-varid'>code2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSomeReg</span> <span class='hs-varid'>src</span>
<a name="line-213"></a>    <span class='hs-varid'>tmp1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getNewRegNat</span> <span class='hs-varid'>pk</span>
<a name="line-214"></a>    <span class='hs-keyword'>let</span>
<a name="line-215"></a>    	<span class='hs-varid'>pk__2</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cmmExprType</span> <span class='hs-varid'>src</span>
<a name="line-216"></a>    	<span class='hs-varid'>code__2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>code1</span> <span class='hs-varop'>`appOL`</span> <span class='hs-varid'>code2</span> <span class='hs-varop'>`appOL`</span>
<a name="line-217"></a>	    <span class='hs-keyword'>if</span>   <span class='hs-varid'>sizeToWidth</span> <span class='hs-varid'>pk</span> <span class='hs-varop'>==</span> <span class='hs-varid'>typeWidth</span> <span class='hs-varid'>pk__2</span> 
<a name="line-218"></a>            <span class='hs-keyword'>then</span> <span class='hs-varid'>unitOL</span> <span class='hs-layout'>(</span><span class='hs-conid'>ST</span> <span class='hs-varid'>pk</span> <span class='hs-varid'>src__2</span> <span class='hs-varid'>dst__2</span><span class='hs-layout'>)</span>
<a name="line-219"></a>	    <span class='hs-keyword'>else</span> <span class='hs-varid'>toOL</span> 	<span class='hs-keyglyph'>[</span> <span class='hs-conid'>FxTOy</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmmTypeSize</span> <span class='hs-varid'>pk__2</span><span class='hs-layout'>)</span> <span class='hs-varid'>pk</span> <span class='hs-varid'>src__2</span> <span class='hs-varid'>tmp1</span>
<a name="line-220"></a>	    		<span class='hs-layout'>,</span> <span class='hs-conid'>ST</span>    <span class='hs-varid'>pk</span> <span class='hs-varid'>tmp1</span> <span class='hs-varid'>dst__2</span><span class='hs-keyglyph'>]</span>
<a name="line-221"></a>    <span class='hs-varid'>return</span> <span class='hs-varid'>code__2</span>
<a name="line-222"></a>
<a name="line-223"></a><a name="assignReg_FltCode"></a><span class='hs-comment'>-- Floating point assignment to a register/temporary</span>
<a name="line-224"></a><span class='hs-definition'>assignReg_FltCode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Size</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmReg</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NatM</span> <span class='hs-conid'>InstrBlock</span>
<a name="line-225"></a><span class='hs-definition'>assignReg_FltCode</span> <span class='hs-varid'>pk</span> <span class='hs-varid'>dstCmmReg</span> <span class='hs-varid'>srcCmmExpr</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-226"></a>    <span class='hs-varid'>srcRegister</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getRegister</span> <span class='hs-varid'>srcCmmExpr</span>
<a name="line-227"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>dstReg</span>	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>getRegisterReg</span> <span class='hs-varid'>dstCmmReg</span>
<a name="line-228"></a>
<a name="line-229"></a>    <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>srcRegister</span> <span class='hs-keyword'>of</span>
<a name="line-230"></a>        <span class='hs-conid'>Any</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>code</span>         	    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>code</span> <span class='hs-varid'>dstReg</span>
<a name="line-231"></a>	<span class='hs-conid'>Fixed</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>srcFixedReg</span> <span class='hs-varid'>srcCode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>srcCode</span> <span class='hs-varop'>`snocOL`</span> <span class='hs-conid'>FMOV</span> <span class='hs-varid'>pk</span> <span class='hs-varid'>srcFixedReg</span> <span class='hs-varid'>dstReg</span>
<a name="line-232"></a>
<a name="line-233"></a>
<a name="line-234"></a>
<a name="line-235"></a>
<a name="line-236"></a><a name="genJump"></a><span class='hs-definition'>genJump</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmExpr</span><span class='hs-comment'>{-the branch target-}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NatM</span> <span class='hs-conid'>InstrBlock</span>
<a name="line-237"></a>
<a name="line-238"></a><span class='hs-definition'>genJump</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLabel</span> <span class='hs-varid'>lbl</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-239"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>toOL</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CALL</span> <span class='hs-layout'>(</span><span class='hs-conid'>Left</span> <span class='hs-varid'>target</span><span class='hs-layout'>)</span> <span class='hs-num'>0</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-conid'>NOP</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-240"></a>  <span class='hs-keyword'>where</span>
<a name="line-241"></a>    <span class='hs-varid'>target</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ImmCLbl</span> <span class='hs-varid'>lbl</span>
<a name="line-242"></a>
<a name="line-243"></a><span class='hs-definition'>genJump</span> <span class='hs-varid'>tree</span>
<a name="line-244"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-245"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>target</span><span class='hs-layout'>,</span> <span class='hs-varid'>code</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSomeReg</span> <span class='hs-varid'>tree</span>
<a name="line-246"></a>	<span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>code</span> <span class='hs-varop'>`snocOL`</span> <span class='hs-conid'>JMP</span> <span class='hs-layout'>(</span><span class='hs-conid'>AddrRegReg</span> <span class='hs-varid'>target</span> <span class='hs-varid'>g0</span><span class='hs-layout'>)</span>  <span class='hs-varop'>`snocOL`</span> <span class='hs-conid'>NOP</span><span class='hs-layout'>)</span>
<a name="line-247"></a>
<a name="line-248"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-249"></a><span class='hs-comment'>--  Unconditional branches</span>
<a name="line-250"></a>
<a name="line-251"></a><a name="genBranch"></a><span class='hs-definition'>genBranch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BlockId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NatM</span> <span class='hs-conid'>InstrBlock</span>
<a name="line-252"></a><span class='hs-definition'>genBranch</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>toOL</span> <span class='hs-varop'>.</span> <span class='hs-varid'>mkJumpInstr</span>
<a name="line-253"></a>
<a name="line-254"></a>
<a name="line-255"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-256"></a><span class='hs-comment'>--  Conditional jumps</span>
<a name="line-257"></a>
<a name="line-258"></a><span class='hs-comment'>{-
<a name="line-259"></a>Conditional jumps are always to local labels, so we can use branch
<a name="line-260"></a>instructions.  We peek at the arguments to decide what kind of
<a name="line-261"></a>comparison to do.
<a name="line-262"></a>
<a name="line-263"></a>SPARC: First, we have to ensure that the condition codes are set
<a name="line-264"></a>according to the supplied comparison operation.  We generate slightly
<a name="line-265"></a>different code for floating point comparisons, because a floating
<a name="line-266"></a>point operation cannot directly precede a @BF@.  We assume the worst
<a name="line-267"></a>and fill that slot with a @NOP@.
<a name="line-268"></a>
<a name="line-269"></a>SPARC: Do not fill the delay slots here; you will confuse the register
<a name="line-270"></a>allocator.
<a name="line-271"></a>-}</span>
<a name="line-272"></a>
<a name="line-273"></a>
<a name="line-274"></a><a name="genCondJump"></a><span class='hs-definition'>genCondJump</span>
<a name="line-275"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BlockId</span>	    <span class='hs-comment'>-- the branch target</span>
<a name="line-276"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmExpr</span>      <span class='hs-comment'>-- the condition on which to branch</span>
<a name="line-277"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NatM</span> <span class='hs-conid'>InstrBlock</span>
<a name="line-278"></a>
<a name="line-279"></a>
<a name="line-280"></a>
<a name="line-281"></a><span class='hs-definition'>genCondJump</span> <span class='hs-varid'>bid</span> <span class='hs-varid'>bool</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-282"></a>  <span class='hs-conid'>CondCode</span> <span class='hs-varid'>is_float</span> <span class='hs-varid'>cond</span> <span class='hs-varid'>code</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCondCode</span> <span class='hs-varid'>bool</span>
<a name="line-283"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span>
<a name="line-284"></a>       <span class='hs-varid'>code</span> <span class='hs-varop'>`appOL`</span> 
<a name="line-285"></a>       <span class='hs-varid'>toOL</span> <span class='hs-layout'>(</span>
<a name="line-286"></a>         <span class='hs-keyword'>if</span>   <span class='hs-varid'>is_float</span>
<a name="line-287"></a>         <span class='hs-keyword'>then</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>NOP</span><span class='hs-layout'>,</span> <span class='hs-conid'>BF</span> <span class='hs-varid'>cond</span> <span class='hs-conid'>False</span> <span class='hs-varid'>bid</span><span class='hs-layout'>,</span> <span class='hs-conid'>NOP</span><span class='hs-keyglyph'>]</span>
<a name="line-288"></a>         <span class='hs-keyword'>else</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>BI</span> <span class='hs-varid'>cond</span> <span class='hs-conid'>False</span> <span class='hs-varid'>bid</span><span class='hs-layout'>,</span> <span class='hs-conid'>NOP</span><span class='hs-keyglyph'>]</span>
<a name="line-289"></a>       <span class='hs-layout'>)</span>
<a name="line-290"></a>    <span class='hs-layout'>)</span>
<a name="line-291"></a>
<a name="line-292"></a>
<a name="line-293"></a>
<a name="line-294"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-295"></a><span class='hs-comment'>-- Generating a table-branch</span>
<a name="line-296"></a>
<a name="line-297"></a><a name="genSwitch"></a><span class='hs-definition'>genSwitch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CmmExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>BlockId</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NatM</span> <span class='hs-conid'>InstrBlock</span>
<a name="line-298"></a><span class='hs-definition'>genSwitch</span> <span class='hs-varid'>expr</span> <span class='hs-varid'>ids</span>
<a name="line-299"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-varid'>opt_PIC</span>
<a name="line-300"></a>	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"MachCodeGen: sparc genSwitch PIC not finished\n"</span>
<a name="line-301"></a>  
<a name="line-302"></a>	<span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-303"></a>	<span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-layout'>(</span><span class='hs-varid'>e_reg</span><span class='hs-layout'>,</span> <span class='hs-varid'>e_code</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSomeReg</span> <span class='hs-varid'>expr</span>
<a name="line-304"></a>
<a name="line-305"></a>		<span class='hs-varid'>base_reg</span>	<span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getNewRegNat</span> <span class='hs-conid'>II32</span>
<a name="line-306"></a>		<span class='hs-varid'>offset_reg</span>	<span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getNewRegNat</span> <span class='hs-conid'>II32</span>
<a name="line-307"></a>		<span class='hs-varid'>dst</span>		<span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getNewRegNat</span> <span class='hs-conid'>II32</span>
<a name="line-308"></a>
<a name="line-309"></a>		<span class='hs-varid'>label</span> 		<span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getNewLabelNat</span>
<a name="line-310"></a>
<a name="line-311"></a>		<span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>e_code</span> <span class='hs-varop'>`appOL`</span>
<a name="line-312"></a>		 <span class='hs-varid'>toOL</span>	
<a name="line-313"></a>			<span class='hs-keyglyph'>[</span> <span class='hs-comment'>-- load base of jump table</span>
<a name="line-314"></a>			  <span class='hs-conid'>SETHI</span> <span class='hs-layout'>(</span><span class='hs-conid'>HI</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImmCLbl</span> <span class='hs-varid'>label</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>base_reg</span>
<a name="line-315"></a>			<span class='hs-layout'>,</span> <span class='hs-conid'>OR</span>    <span class='hs-conid'>False</span> <span class='hs-varid'>base_reg</span> <span class='hs-layout'>(</span><span class='hs-conid'>RIImm</span> <span class='hs-varop'>$</span> <span class='hs-conid'>LO</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ImmCLbl</span> <span class='hs-varid'>label</span><span class='hs-layout'>)</span> <span class='hs-varid'>base_reg</span>
<a name="line-316"></a>			
<a name="line-317"></a>			<span class='hs-comment'>-- the addrs in the table are 32 bits wide..</span>
<a name="line-318"></a>			<span class='hs-layout'>,</span> <span class='hs-conid'>SLL</span>   <span class='hs-varid'>e_reg</span> <span class='hs-layout'>(</span><span class='hs-conid'>RIImm</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ImmInt</span> <span class='hs-num'>2</span><span class='hs-layout'>)</span> <span class='hs-varid'>offset_reg</span>
<a name="line-319"></a>
<a name="line-320"></a>			<span class='hs-comment'>-- load and jump to the destination</span>
<a name="line-321"></a>			<span class='hs-layout'>,</span> <span class='hs-conid'>LD</span> 	  <span class='hs-conid'>II32</span> <span class='hs-layout'>(</span><span class='hs-conid'>AddrRegReg</span> <span class='hs-varid'>base_reg</span> <span class='hs-varid'>offset_reg</span><span class='hs-layout'>)</span> <span class='hs-varid'>dst</span>
<a name="line-322"></a>			<span class='hs-layout'>,</span> <span class='hs-conid'>JMP_TBL</span> <span class='hs-layout'>(</span><span class='hs-conid'>AddrRegImm</span> <span class='hs-varid'>dst</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImmInt</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>label</span>
<a name="line-323"></a>			<span class='hs-layout'>,</span> <span class='hs-conid'>NOP</span> <span class='hs-keyglyph'>]</span>
<a name="line-324"></a>
<a name="line-325"></a><a name="generateJumpTableForInstr"></a><span class='hs-definition'>generateJumpTableForInstr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Instr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>NatCmmDecl</span> <span class='hs-conid'>CmmStatics</span> <span class='hs-conid'>Instr</span><span class='hs-layout'>)</span>
<a name="line-326"></a><span class='hs-definition'>generateJumpTableForInstr</span> <span class='hs-layout'>(</span><span class='hs-conid'>JMP_TBL</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ids</span> <span class='hs-varid'>label</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-327"></a>	<span class='hs-keyword'>let</span> <span class='hs-varid'>jumpTable</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>jumpTableEntry</span> <span class='hs-varid'>ids</span>
<a name="line-328"></a>	<span class='hs-keyword'>in</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmData</span> <span class='hs-conid'>ReadOnlyData</span> <span class='hs-layout'>(</span><span class='hs-conid'>Statics</span> <span class='hs-varid'>label</span> <span class='hs-varid'>jumpTable</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-329"></a><span class='hs-definition'>generateJumpTableForInstr</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
</pre></body>
</html>
