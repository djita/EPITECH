<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>codeGen/CgClosure.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
%
% (c) The University of Glasgow 2006
% (c) The GRASP/AQUA Project, Glasgow University, 1992-1998
%
\section[CgClosure]{Code generation for closures}

This module provides the support code for @StgToAbstractC@ to deal
with {\em closures} on the RHSs of let(rec)s.  See also
@CgCon@, which deals with constructors.

\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-2"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-3"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-4"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-5"></a><span class='hs-comment'>--     <a href="http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-6"></a><span class='hs-comment'>-- for details</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>CgClosure</span> <span class='hs-layout'>(</span> <span class='hs-varid'>cgTopRhsClosure</span><span class='hs-layout'>,</span> 
<a name="line-9"></a>		   <span class='hs-varid'>cgStdRhsClosure</span><span class='hs-layout'>,</span> 
<a name="line-10"></a>		   <span class='hs-varid'>cgRhsClosure</span><span class='hs-layout'>,</span>
<a name="line-11"></a>		   <span class='hs-varid'>emitBlackHoleCode</span><span class='hs-layout'>,</span>
<a name="line-12"></a>		   <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-13"></a>
<a name="line-14"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-15"></a>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>CgExpr</span> <span class='hs-layout'>(</span> <span class='hs-varid'>cgExpr</span> <span class='hs-layout'>)</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgMonad</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgBindery</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgHeapery</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgStackery</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgProf</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgTicky</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgParallel</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgInfoTbls</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgCallConv</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CgUtils</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ClosureInfo</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SMRep</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OldCmm</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OldCmmUtils</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CLabel</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>StgSyn</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CostCentre</span>	
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ListSetOps</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>StaticFlags</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-45"></a>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>
</pre>\end{code}

%********************************************************
%*							*
\subsection[closures-no-free-vars]{Top-level closures}
%*							*
%********************************************************

For closures bound at top level, allocate in static space.
They should have no free variables.

\begin{code}
<pre><a name="line-1"></a><a name="cgTopRhsClosure"></a><span class='hs-definition'>cgTopRhsClosure</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span>
<a name="line-2"></a>		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CostCentreStack</span>	<span class='hs-comment'>-- Optional cost centre annotation</span>
<a name="line-3"></a>		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgBinderInfo</span>
<a name="line-4"></a>		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UpdateFlag</span>
<a name="line-5"></a>		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>		<span class='hs-comment'>-- Args</span>
<a name="line-6"></a>		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgExpr</span>
<a name="line-7"></a>		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>CgIdInfo</span><span class='hs-layout'>)</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-definition'>cgTopRhsClosure</span> <span class='hs-varid'>id</span> <span class='hs-varid'>ccs</span> <span class='hs-varid'>binder_info</span> <span class='hs-varid'>upd_flag</span> <span class='hs-varid'>args</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-10"></a>  <span class='hs-layout'>{</span>	<span class='hs-comment'>-- LAY OUT THE OBJECT</span>
<a name="line-11"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idName</span> <span class='hs-varid'>id</span>
<a name="line-12"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>lf_info</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkClosureLFInfo</span> <span class='hs-varid'>id</span> <span class='hs-conid'>TopLevel</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>upd_flag</span> <span class='hs-varid'>args</span>
<a name="line-13"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>srt_info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSRTInfo</span>
<a name="line-14"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>mod_name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModuleName</span>
<a name="line-15"></a>  <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>descr</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>closureDescription</span> <span class='hs-varid'>mod_name</span> <span class='hs-varid'>name</span>
<a name="line-16"></a>	<span class='hs-varid'>closure_info</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkClosureInfo</span> <span class='hs-conid'>True</span> <span class='hs-varid'>id</span> <span class='hs-varid'>lf_info</span> <span class='hs-num'>0</span> <span class='hs-num'>0</span> <span class='hs-varid'>srt_info</span> <span class='hs-varid'>descr</span>
<a name="line-17"></a>	<span class='hs-varid'>closure_label</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLocalClosureLabel</span> <span class='hs-varid'>name</span> <span class='hs-varop'>$</span> <span class='hs-varid'>idCafInfo</span> <span class='hs-varid'>id</span>
<a name="line-18"></a>    	<span class='hs-varid'>cg_id_info</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stableIdInfo</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLblExpr</span> <span class='hs-varid'>closure_label</span><span class='hs-layout'>)</span> <span class='hs-varid'>lf_info</span>
<a name="line-19"></a>	<span class='hs-varid'>closure_rep</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkStaticClosureFields</span> <span class='hs-varid'>closure_info</span> <span class='hs-varid'>ccs</span> <span class='hs-conid'>True</span> <span class='hs-conid'>[]</span>
<a name="line-20"></a>
<a name="line-21"></a>  	 <span class='hs-comment'>-- BUILD THE OBJECT, AND GENERATE INFO TABLE (IF NECESSARY)</span>
<a name="line-22"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>emitDataLits</span> <span class='hs-varid'>closure_label</span> <span class='hs-varid'>closure_rep</span>
<a name="line-23"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>forkClosureBody</span> <span class='hs-layout'>(</span><span class='hs-varid'>closureCodeBody</span> <span class='hs-varid'>binder_info</span> <span class='hs-varid'>closure_info</span>
<a name="line-24"></a>				     <span class='hs-varid'>ccs</span> <span class='hs-varid'>args</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-25"></a>
<a name="line-26"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>returnFC</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>cg_id_info</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}

%********************************************************
%*							*
\subsection[non-top-level-closures]{Non top-level closures}
%*							*
%********************************************************

For closures with free vars, allocate in heap.

\begin{code}
<pre><a name="line-1"></a><a name="cgStdRhsClosure"></a><span class='hs-definition'>cgStdRhsClosure</span>
<a name="line-2"></a>	<span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span>
<a name="line-3"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CostCentreStack</span>	<span class='hs-comment'>-- Optional cost centre annotation</span>
<a name="line-4"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgBinderInfo</span>
<a name="line-5"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>			<span class='hs-comment'>-- Free vars</span>
<a name="line-6"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>			<span class='hs-comment'>-- Args</span>
<a name="line-7"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgExpr</span>
<a name="line-8"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LambdaFormInfo</span>
<a name="line-9"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StgArg</span><span class='hs-keyglyph'>]</span>		<span class='hs-comment'>-- payload</span>
<a name="line-10"></a>	<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>CgIdInfo</span><span class='hs-layout'>)</span>
<a name="line-11"></a>
<a name="line-12"></a><span class='hs-definition'>cgStdRhsClosure</span> <span class='hs-varid'>bndr</span> <span class='hs-sel'>_cc</span> <span class='hs-sel'>_bndr_info</span> <span class='hs-sel'>_fvs</span> <span class='hs-sel'>_args</span> <span class='hs-sel'>_body</span> <span class='hs-varid'>lf_info</span> <span class='hs-varid'>payload</span>
<a name="line-13"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>	<span class='hs-comment'>-- AHA!  A STANDARD-FORM THUNK</span>
<a name="line-14"></a>  <span class='hs-layout'>{</span>	<span class='hs-comment'>-- LAY OUT THE OBJECT</span>
<a name="line-15"></a>    <span class='hs-varid'>amodes</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getArgAmodes</span> <span class='hs-varid'>payload</span>
<a name="line-16"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>mod_name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModuleName</span>
<a name="line-17"></a>  <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>tot_wds</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptr_wds</span><span class='hs-layout'>,</span> <span class='hs-varid'>amodes_w_offsets</span><span class='hs-layout'>)</span> 
<a name="line-18"></a>	    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVirtHeapOffsets</span> <span class='hs-layout'>(</span><span class='hs-varid'>isLFThunk</span> <span class='hs-varid'>lf_info</span><span class='hs-layout'>)</span> <span class='hs-varid'>amodes</span>
<a name="line-19"></a>
<a name="line-20"></a>	<span class='hs-varid'>descr</span>	     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>closureDescription</span> <span class='hs-varid'>mod_name</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span>
<a name="line-21"></a>	<span class='hs-varid'>closure_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkClosureInfo</span> <span class='hs-conid'>False</span> 	<span class='hs-comment'>-- Not static</span>
<a name="line-22"></a>				     <span class='hs-varid'>bndr</span> <span class='hs-varid'>lf_info</span> <span class='hs-varid'>tot_wds</span> <span class='hs-varid'>ptr_wds</span> 
<a name="line-23"></a>				     <span class='hs-conid'>NoC_SRT</span>	<span class='hs-comment'>-- No SRT for a std-form closure</span>
<a name="line-24"></a>				     <span class='hs-varid'>descr</span>
<a name="line-25"></a>		
<a name="line-26"></a><span class='hs-comment'>--  ; (use_cc, blame_cc) &lt;- chooseDynCostCentres cc args body</span>
<a name="line-27"></a>
<a name="line-28"></a>	<span class='hs-comment'>-- BUILD THE OBJECT</span>
<a name="line-29"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>heap_offset</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>allocDynClosure</span> <span class='hs-varid'>closure_info</span> <span class='hs-varid'>curCCS</span> <span class='hs-varid'>curCCS</span> <span class='hs-varid'>amodes_w_offsets</span>
<a name="line-30"></a>
<a name="line-31"></a>	<span class='hs-comment'>-- RETURN</span>
<a name="line-32"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>returnFC</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>heapIdInfo</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>heap_offset</span> <span class='hs-varid'>lf_info</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}

Here's the general case.

\begin{code}
<pre><a name="line-1"></a><a name="cgRhsClosure"></a><span class='hs-definition'>cgRhsClosure</span>	<span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span>
<a name="line-2"></a>		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CostCentreStack</span>	<span class='hs-comment'>-- Optional cost centre annotation</span>
<a name="line-3"></a>		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgBinderInfo</span>
<a name="line-4"></a>		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>			<span class='hs-comment'>-- Free vars</span>
<a name="line-5"></a>		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UpdateFlag</span>
<a name="line-6"></a>		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>			<span class='hs-comment'>-- Args</span>
<a name="line-7"></a>		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgExpr</span>
<a name="line-8"></a>		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>CgIdInfo</span><span class='hs-layout'>)</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-definition'>cgRhsClosure</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>cc</span> <span class='hs-varid'>bndr_info</span> <span class='hs-varid'>fvs</span> <span class='hs-varid'>upd_flag</span> <span class='hs-varid'>args</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-11"></a>  <span class='hs-layout'>{</span> 	<span class='hs-comment'>-- LAY OUT THE OBJECT</span>
<a name="line-12"></a>	<span class='hs-comment'>-- If the binder is itself a free variable, then don't store</span>
<a name="line-13"></a>	<span class='hs-comment'>-- it in the closure.  Instead, just bind it to Node on entry.</span>
<a name="line-14"></a>	<span class='hs-comment'>-- NB we can be sure that Node will point to it, because we</span>
<a name="line-15"></a>	<span class='hs-comment'>-- havn't told mkClosureLFInfo about this; so if the binder</span>
<a name="line-16"></a>	<span class='hs-comment'>-- _was_ a free var of its RHS, mkClosureLFInfo thinks it *is*</span>
<a name="line-17"></a>	<span class='hs-comment'>-- stored in the closure itself, so it will make sure that</span>
<a name="line-18"></a>	<span class='hs-comment'>-- Node points to it...</span>
<a name="line-19"></a>    <span class='hs-keyword'>let</span>
<a name="line-20"></a>	<span class='hs-varid'>name</span> 	     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idName</span> <span class='hs-varid'>bndr</span>
<a name="line-21"></a>	<span class='hs-varid'>bndr_is_a_fv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndr</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>fvs</span>
<a name="line-22"></a>	<span class='hs-varid'>reduced_fvs</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>bndr_is_a_fv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvs</span> <span class='hs-varop'>`minusList`</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>bndr</span><span class='hs-keyglyph'>]</span>
<a name="line-23"></a>		    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>	   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvs</span>
<a name="line-24"></a>
<a name="line-25"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>lf_info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkClosureLFInfo</span> <span class='hs-varid'>bndr</span> <span class='hs-conid'>NotTopLevel</span> <span class='hs-varid'>fvs</span> <span class='hs-varid'>upd_flag</span> <span class='hs-varid'>args</span>
<a name="line-26"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>fv_infos</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapFCs</span> <span class='hs-varid'>getCgIdInfo</span> <span class='hs-varid'>reduced_fvs</span>
<a name="line-27"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>srt_info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSRTInfo</span>
<a name="line-28"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>mod_name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModuleName</span>
<a name="line-29"></a>  <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span>	<span class='hs-varid'>bind_details</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>CgIdInfo</span><span class='hs-layout'>,</span> <span class='hs-conid'>VirtualHpOffset</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-30"></a>	<span class='hs-layout'>(</span><span class='hs-varid'>tot_wds</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptr_wds</span><span class='hs-layout'>,</span> <span class='hs-varid'>bind_details</span><span class='hs-layout'>)</span> 
<a name="line-31"></a>	   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVirtHeapOffsets</span> <span class='hs-layout'>(</span><span class='hs-varid'>isLFThunk</span> <span class='hs-varid'>lf_info</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>add_rep</span> <span class='hs-varid'>fv_infos</span><span class='hs-layout'>)</span>
<a name="line-32"></a>
<a name="line-33"></a>	<span class='hs-varid'>add_rep</span> <span class='hs-varid'>info</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>cgIdInfoArgRep</span> <span class='hs-varid'>info</span><span class='hs-layout'>,</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span>
<a name="line-34"></a>
<a name="line-35"></a>	<span class='hs-varid'>descr</span>	     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>closureDescription</span> <span class='hs-varid'>mod_name</span> <span class='hs-varid'>name</span>
<a name="line-36"></a>	<span class='hs-varid'>closure_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkClosureInfo</span> <span class='hs-conid'>False</span>	<span class='hs-comment'>-- Not static</span>
<a name="line-37"></a>				     <span class='hs-varid'>bndr</span> <span class='hs-varid'>lf_info</span> <span class='hs-varid'>tot_wds</span> <span class='hs-varid'>ptr_wds</span>
<a name="line-38"></a>				     <span class='hs-varid'>srt_info</span> <span class='hs-varid'>descr</span>
<a name="line-39"></a>
<a name="line-40"></a>	<span class='hs-comment'>-- BUILD ITS INFO TABLE AND CODE</span>
<a name="line-41"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>forkClosureBody</span> <span class='hs-layout'>(</span><span class='hs-keyword'>do</span>
<a name="line-42"></a>	<span class='hs-layout'>{</span>	<span class='hs-comment'>-- Bind the fvs</span>
<a name="line-43"></a>	  <span class='hs-keyword'>let</span> 
<a name="line-44"></a>              <span class='hs-comment'>-- A function closure pointer may be tagged, so we</span>
<a name="line-45"></a>              <span class='hs-comment'>-- must take it into account when accessing the free variables.</span>
<a name="line-46"></a>              <span class='hs-varid'>mbtag</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tagForArity</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-47"></a>              <span class='hs-varid'>bind_fv</span> <span class='hs-layout'>(</span><span class='hs-varid'>info</span><span class='hs-layout'>,</span> <span class='hs-varid'>offset</span><span class='hs-layout'>)</span>
<a name="line-48"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tag</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mbtag</span>
<a name="line-49"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindNewToUntagNode</span> <span class='hs-layout'>(</span><span class='hs-varid'>cgIdInfoId</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span> <span class='hs-varid'>offset</span> <span class='hs-layout'>(</span><span class='hs-varid'>cgIdInfoLF</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span> <span class='hs-varid'>tag</span>
<a name="line-50"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-51"></a>		<span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindNewToNode</span> <span class='hs-layout'>(</span><span class='hs-varid'>cgIdInfoId</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span> <span class='hs-varid'>offset</span> <span class='hs-layout'>(</span><span class='hs-varid'>cgIdInfoLF</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span>
<a name="line-52"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>mapCs</span> <span class='hs-varid'>bind_fv</span> <span class='hs-varid'>bind_details</span>
<a name="line-53"></a>
<a name="line-54"></a>	  	<span class='hs-comment'>-- Bind the binder itself, if it is a free var</span>
<a name="line-55"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>whenC</span> <span class='hs-varid'>bndr_is_a_fv</span> <span class='hs-layout'>(</span><span class='hs-varid'>bindNewToReg</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>nodeReg</span> <span class='hs-varid'>lf_info</span><span class='hs-layout'>)</span>
<a name="line-56"></a>	
<a name="line-57"></a>		<span class='hs-comment'>-- Compile the body</span>
<a name="line-58"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>closureCodeBody</span> <span class='hs-varid'>bndr_info</span> <span class='hs-varid'>closure_info</span> <span class='hs-varid'>cc</span> <span class='hs-varid'>args</span> <span class='hs-varid'>body</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-59"></a>
<a name="line-60"></a>	<span class='hs-comment'>-- BUILD THE OBJECT</span>
<a name="line-61"></a>  <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span>
<a name="line-62"></a>	<span class='hs-varid'>to_amode</span> <span class='hs-layout'>(</span><span class='hs-varid'>info</span><span class='hs-layout'>,</span> <span class='hs-varid'>offset</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>amode</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>idInfoToAmode</span> <span class='hs-varid'>info</span>
<a name="line-63"></a>				     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>amode</span><span class='hs-layout'>,</span> <span class='hs-varid'>offset</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-64"></a><span class='hs-comment'>--  ; (use_cc, blame_cc) &lt;- chooseDynCostCentres cc args body</span>
<a name="line-65"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>amodes_w_offsets</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapFCs</span> <span class='hs-varid'>to_amode</span> <span class='hs-varid'>bind_details</span>
<a name="line-66"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>heap_offset</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>allocDynClosure</span> <span class='hs-varid'>closure_info</span> <span class='hs-varid'>curCCS</span> <span class='hs-varid'>curCCS</span> <span class='hs-varid'>amodes_w_offsets</span>
<a name="line-67"></a>
<a name="line-68"></a>	<span class='hs-comment'>-- RETURN</span>
<a name="line-69"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>returnFC</span> <span class='hs-layout'>(</span><span class='hs-varid'>bndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>heapIdInfo</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>heap_offset</span> <span class='hs-varid'>lf_info</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-70"></a>
<a name="line-71"></a>
<a name="line-72"></a><a name="mkClosureLFInfo"></a><span class='hs-definition'>mkClosureLFInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Id</span>		<span class='hs-comment'>-- The binder</span>
<a name="line-73"></a>		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TopLevelFlag</span>	<span class='hs-comment'>-- True of top level</span>
<a name="line-74"></a>		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>		<span class='hs-comment'>-- Free vars</span>
<a name="line-75"></a>		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UpdateFlag</span> 	<span class='hs-comment'>-- Update flag</span>
<a name="line-76"></a>		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span> 	<span class='hs-comment'>-- Args</span>
<a name="line-77"></a>		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>LambdaFormInfo</span>
<a name="line-78"></a><span class='hs-definition'>mkClosureLFInfo</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>top</span> <span class='hs-varid'>fvs</span> <span class='hs-varid'>upd_flag</span> <span class='hs-varid'>args</span>
<a name="line-79"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLFThunk</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span> <span class='hs-varid'>top</span> <span class='hs-varid'>fvs</span> <span class='hs-varid'>upd_flag</span><span class='hs-layout'>)</span>
<a name="line-80"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>arg_descr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkArgDescr</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span>
<a name="line-81"></a>		   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLFReEntrant</span> <span class='hs-varid'>top</span> <span class='hs-varid'>fvs</span> <span class='hs-varid'>args</span> <span class='hs-varid'>arg_descr</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}


%************************************************************************
%*									*
\subsection[code-for-closures]{The code for closures}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="closureCodeBody"></a><span class='hs-definition'>closureCodeBody</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StgBinderInfo</span>
<a name="line-2"></a>		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ClosureInfo</span>	   <span class='hs-comment'>-- Lots of information about this closure</span>
<a name="line-3"></a>		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CostCentreStack</span> <span class='hs-comment'>-- Optional cost centre attached to closure</span>
<a name="line-4"></a>		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>
<a name="line-5"></a>		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgExpr</span>
<a name="line-6"></a>		<span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
</pre>\end{code}

There are two main cases for the code for closures.  If there are {\em
no arguments}, then the closure is a thunk, and not in normal form.
So it should set up an update frame (if it is shared).
NB: Thunks cannot have a primitive type!

\begin{code}
<pre><a name="line-1"></a><a name="closureCodeBody"></a><span class='hs-definition'>closureCodeBody</span> <span class='hs-sel'>_binder_info</span> <span class='hs-varid'>cl_info</span> <span class='hs-sel'>_cc</span> <span class='hs-keyglyph'>[</span><span class='hs-comment'>{- No args i.e. thunk -}</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-2"></a>  <span class='hs-layout'>{</span> <span class='hs-varid'>body_absC</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCgStmts</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-3"></a>	<span class='hs-layout'>{</span> <span class='hs-varid'>tickyEnterThunk</span> <span class='hs-varid'>cl_info</span>
<a name="line-4"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>ldvEnterClosure</span> <span class='hs-varid'>cl_info</span>  <span class='hs-comment'>-- NB: Node always points when profiling</span>
<a name="line-5"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>thunkWrapper</span> <span class='hs-varid'>cl_info</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-6"></a>		<span class='hs-comment'>-- We only enter cc after setting up update so</span>
<a name="line-7"></a>		<span class='hs-comment'>-- that cc of enclosing scope will be recorded</span>
<a name="line-8"></a>                <span class='hs-comment'>-- in the update frame</span>
<a name="line-9"></a>            <span class='hs-layout'>{</span> <span class='hs-varid'>enterCostCentreThunk</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-varid'>nodeReg</span><span class='hs-layout'>)</span>
<a name="line-10"></a>	    <span class='hs-layout'>;</span> <span class='hs-varid'>cgExpr</span> <span class='hs-varid'>body</span> <span class='hs-layout'>}</span>
<a name="line-11"></a>	<span class='hs-layout'>}</span>
<a name="line-12"></a>    
<a name="line-13"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>emitClosureCodeAndInfoTable</span> <span class='hs-varid'>cl_info</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>body_absC</span> <span class='hs-layout'>}</span>
</pre>\end{code}

If there is /at least one argument/, then this closure is in
normal form, so there is no need to set up an update frame.

The Macros for GrAnSim are produced at the beginning of the
argSatisfactionCheck (by calling fetchAndReschedule).  There info if
Node points to closure is available. -- HWL

\begin{code}
<pre><a name="line-1"></a><a name="closureCodeBody"></a><span class='hs-definition'>closureCodeBody</span> <span class='hs-sel'>_binder_info</span> <span class='hs-varid'>cl_info</span> <span class='hs-varid'>cc</span> <span class='hs-varid'>args</span> <span class='hs-varid'>body</span> 
<a name="line-2"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>length</span> <span class='hs-varid'>args</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span> <span class='hs-layout'>)</span>
<a name="line-3"></a>  <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> 	<span class='hs-comment'>-- Get the current virtual Sp (it might not be zero, </span>
<a name="line-4"></a>	<span class='hs-comment'>-- eg. if we're compiling a let-no-escape).</span>
<a name="line-5"></a>    <span class='hs-varid'>vSp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getVirtSp</span>
<a name="line-6"></a>  <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>reg_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>other_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>assignCallRegs</span> <span class='hs-layout'>(</span><span class='hs-varid'>addIdReps</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-7"></a>	<span class='hs-layout'>(</span><span class='hs-varid'>sp_top</span><span class='hs-layout'>,</span> <span class='hs-varid'>stk_args</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVirtStkOffsets</span> <span class='hs-varid'>vSp</span> <span class='hs-varid'>other_args</span>
<a name="line-8"></a>
<a name="line-9"></a>	<span class='hs-comment'>-- Allocate the global ticky counter</span>
<a name="line-10"></a>  <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ticky_ctr_lbl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRednCountsLabel</span> <span class='hs-layout'>(</span><span class='hs-varid'>closureName</span> <span class='hs-varid'>cl_info</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>clHasCafRefs</span> <span class='hs-varid'>cl_info</span><span class='hs-layout'>)</span>
<a name="line-11"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>emitTickyCounter</span> <span class='hs-varid'>cl_info</span> <span class='hs-varid'>args</span> <span class='hs-varid'>sp_top</span>
<a name="line-12"></a>
<a name="line-13"></a>   	<span class='hs-comment'>-- ...and establish the ticky-counter </span>
<a name="line-14"></a>	<span class='hs-comment'>-- label for this block</span>
<a name="line-15"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>setTickyCtrLabel</span> <span class='hs-varid'>ticky_ctr_lbl</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-16"></a>
<a name="line-17"></a>    	<span class='hs-comment'>-- Emit the slow-entry code</span>
<a name="line-18"></a>  <span class='hs-layout'>{</span> <span class='hs-varid'>reg_save_code</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkSlowEntryCode</span> <span class='hs-varid'>cl_info</span> <span class='hs-varid'>reg_args</span>
<a name="line-19"></a>
<a name="line-20"></a>	<span class='hs-comment'>-- Emit the main entry code</span>
<a name="line-21"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>blks</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>forkProc</span> <span class='hs-varop'>$</span>
<a name="line-22"></a>	    <span class='hs-varid'>mkFunEntryCode</span> <span class='hs-varid'>cl_info</span> <span class='hs-varid'>cc</span> <span class='hs-varid'>reg_args</span> <span class='hs-varid'>stk_args</span>
<a name="line-23"></a>			   <span class='hs-varid'>sp_top</span> <span class='hs-varid'>reg_save_code</span> <span class='hs-varid'>body</span>
<a name="line-24"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>emitClosureCodeAndInfoTable</span> <span class='hs-varid'>cl_info</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>blks</span>
<a name="line-25"></a>  <span class='hs-layout'>}</span><span class='hs-layout'>}</span>
<a name="line-26"></a>
<a name="line-27"></a>
<a name="line-28"></a>
<a name="line-29"></a><a name="mkFunEntryCode"></a><span class='hs-definition'>mkFunEntryCode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ClosureInfo</span>
<a name="line-30"></a>	       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CostCentreStack</span>
<a name="line-31"></a>	       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>GlobalReg</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> 	  <span class='hs-comment'>-- Args in regs</span>
<a name="line-32"></a>	       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>VirtualSpOffset</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- Args on stack</span>
<a name="line-33"></a>	       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VirtualSpOffset</span>	  <span class='hs-comment'>-- Last allocated word on stack</span>
<a name="line-34"></a>	       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmStmts</span> 		  <span class='hs-comment'>-- Register-save code in case of GC</span>
<a name="line-35"></a>	       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgExpr</span>
<a name="line-36"></a>	       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-37"></a><span class='hs-comment'>-- The main entry code for the closure</span>
<a name="line-38"></a><span class='hs-definition'>mkFunEntryCode</span> <span class='hs-varid'>cl_info</span> <span class='hs-varid'>cc</span> <span class='hs-varid'>reg_args</span> <span class='hs-varid'>stk_args</span> <span class='hs-varid'>sp_top</span> <span class='hs-varid'>reg_save_code</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-39"></a>  <span class='hs-layout'>{</span> 	<span class='hs-comment'>-- Bind args to regs/stack as appropriate,</span>
<a name="line-40"></a>	<span class='hs-comment'>-- and record expected position of sps</span>
<a name="line-41"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>bindArgsToRegs</span>  <span class='hs-varid'>reg_args</span>
<a name="line-42"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>bindArgsToStack</span> <span class='hs-varid'>stk_args</span>
<a name="line-43"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>setRealAndVirtualSp</span> <span class='hs-varid'>sp_top</span>
<a name="line-44"></a>
<a name="line-45"></a>        <span class='hs-comment'>-- Do the business</span>
<a name="line-46"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>funWrapper</span> <span class='hs-varid'>cl_info</span> <span class='hs-varid'>reg_args</span> <span class='hs-varid'>reg_save_code</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-47"></a>	<span class='hs-layout'>{</span> <span class='hs-varid'>tickyEnterFun</span> <span class='hs-varid'>cl_info</span>
<a name="line-48"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>enterCostCentreFun</span> <span class='hs-varid'>cc</span>
<a name="line-49"></a>              <span class='hs-layout'>(</span><span class='hs-conid'>CmmMachOp</span> <span class='hs-varid'>mo_wordSub</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>CmmReg</span> <span class='hs-varid'>nodeReg</span>
<a name="line-50"></a>                                    <span class='hs-layout'>,</span> <span class='hs-conid'>CmmLit</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkIntCLit</span> <span class='hs-layout'>(</span><span class='hs-varid'>funTag</span> <span class='hs-varid'>cl_info</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-51"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>node</span> <span class='hs-conop'>:</span> <span class='hs-varid'>map</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>reg_args</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- live regs</span>
<a name="line-52"></a>
<a name="line-53"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>cgExpr</span> <span class='hs-varid'>body</span> <span class='hs-layout'>}</span>
<a name="line-54"></a>  <span class='hs-layout'>}</span>
</pre>\end{code}

The "slow entry" code for a function.  This entry point takes its
arguments on the stack.  It loads the arguments into registers
according to the calling convention, and jumps to the function's
normal entry point.  The function's closure is assumed to be in
R1/node.

The slow entry point is used in two places:

 (a) unknown calls: eg. stg_PAP_entry 
 (b) returning from a heap-check failure

\begin{code}
<pre><a name="line-1"></a><a name="mkSlowEntryCode"></a><span class='hs-definition'>mkSlowEntryCode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ClosureInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>GlobalReg</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>CmmStmts</span>
<a name="line-2"></a><span class='hs-comment'>-- If this function doesn't have a specialised ArgDescr, we need</span>
<a name="line-3"></a><span class='hs-comment'>-- to generate the function's arg bitmap, slow-entry code, and</span>
<a name="line-4"></a><span class='hs-comment'>-- register-save code for the heap-check failure</span>
<a name="line-5"></a><span class='hs-comment'>-- Here, we emit the slow-entry code, and </span>
<a name="line-6"></a><span class='hs-comment'>-- return the register-save assignments</span>
<a name="line-7"></a><span class='hs-definition'>mkSlowEntryCode</span> <span class='hs-varid'>cl_info</span> <span class='hs-varid'>reg_args</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>ArgGen</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>closureFunInfo</span> <span class='hs-varid'>cl_info</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 	<span class='hs-layout'>{</span> <span class='hs-varid'>emitSimpleProc</span> <span class='hs-varid'>slow_lbl</span> <span class='hs-layout'>(</span><span class='hs-varid'>emitStmts</span> <span class='hs-varid'>load_stmts</span><span class='hs-layout'>)</span>
<a name="line-10"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>save_stmts</span> <span class='hs-layout'>}</span>
<a name="line-11"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>noStmts</span>
<a name="line-12"></a>  <span class='hs-keyword'>where</span>
<a name="line-13"></a>     <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>closureName</span> <span class='hs-varid'>cl_info</span>
<a name="line-14"></a>     <span class='hs-varid'>has_caf_refs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>clHasCafRefs</span> <span class='hs-varid'>cl_info</span>
<a name="line-15"></a>     <span class='hs-varid'>slow_lbl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSlowEntryLabel</span> <span class='hs-varid'>name</span> <span class='hs-varid'>has_caf_refs</span>
<a name="line-16"></a>
<a name="line-17"></a>     <span class='hs-varid'>load_stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkStmts</span> <span class='hs-varid'>load_assts</span> <span class='hs-varop'>`plusStmts`</span> <span class='hs-varid'>mkStmts</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>stk_adj_pop</span><span class='hs-layout'>,</span> <span class='hs-varid'>jump_to_entry</span><span class='hs-keyglyph'>]</span>
<a name="line-18"></a>     <span class='hs-varid'>save_stmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>oneStmt</span> <span class='hs-varid'>stk_adj_push</span> <span class='hs-varop'>`plusStmts`</span>  <span class='hs-varid'>mkStmts</span> <span class='hs-varid'>save_assts</span>
<a name="line-19"></a>
<a name="line-20"></a>     <span class='hs-varid'>reps_w_regs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>CgRep</span><span class='hs-layout'>,</span><span class='hs-conid'>GlobalReg</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-21"></a>     <span class='hs-varid'>reps_w_regs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>idCgRep</span> <span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>id</span><span class='hs-layout'>,</span><span class='hs-varid'>reg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>reg_args</span><span class='hs-keyglyph'>]</span>
<a name="line-22"></a>     <span class='hs-layout'>(</span><span class='hs-varid'>final_stk_offset</span><span class='hs-layout'>,</span> <span class='hs-varid'>stk_offsets</span><span class='hs-layout'>)</span>
<a name="line-23"></a>	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>off</span> <span class='hs-layout'>(</span><span class='hs-varid'>rep</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>off</span> <span class='hs-varop'>+</span> <span class='hs-varid'>cgRepSizeW</span> <span class='hs-varid'>rep</span><span class='hs-layout'>,</span> <span class='hs-varid'>off</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-24"></a>		    <span class='hs-num'>0</span> <span class='hs-varid'>reps_w_regs</span>
<a name="line-25"></a>
<a name="line-26"></a>     <span class='hs-varid'>load_assts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWithEqual</span> <span class='hs-str'>"mk_load"</span> <span class='hs-varid'>mk_load</span> <span class='hs-varid'>reps_w_regs</span> <span class='hs-varid'>stk_offsets</span>
<a name="line-27"></a>     <span class='hs-varid'>mk_load</span> <span class='hs-layout'>(</span><span class='hs-varid'>rep</span><span class='hs-layout'>,</span><span class='hs-varid'>reg</span><span class='hs-layout'>)</span> <span class='hs-varid'>offset</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmAssign</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmGlobal</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span> 
<a name="line-28"></a>					  <span class='hs-layout'>(</span><span class='hs-conid'>CmmLoad</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmmRegOffW</span> <span class='hs-varid'>spReg</span> <span class='hs-varid'>offset</span><span class='hs-layout'>)</span>
<a name="line-29"></a>						   <span class='hs-layout'>(</span><span class='hs-varid'>argMachRep</span> <span class='hs-varid'>rep</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-30"></a>
<a name="line-31"></a>     <span class='hs-varid'>save_assts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWithEqual</span> <span class='hs-str'>"mk_save"</span> <span class='hs-varid'>mk_save</span> <span class='hs-varid'>reps_w_regs</span> <span class='hs-varid'>stk_offsets</span>
<a name="line-32"></a>     <span class='hs-varid'>mk_save</span> <span class='hs-layout'>(</span><span class='hs-varid'>rep</span><span class='hs-layout'>,</span><span class='hs-varid'>reg</span><span class='hs-layout'>)</span> <span class='hs-varid'>offset</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>argMachRep</span> <span class='hs-varid'>rep</span> <span class='hs-varop'>`cmmEqType`</span> <span class='hs-varid'>globalRegType</span> <span class='hs-varid'>reg</span> <span class='hs-layout'>)</span>
<a name="line-33"></a>				<span class='hs-conid'>CmmStore</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmmRegOffW</span> <span class='hs-varid'>spReg</span> <span class='hs-varid'>offset</span><span class='hs-layout'>)</span> 
<a name="line-34"></a>					 <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmGlobal</span> <span class='hs-varid'>reg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-35"></a>
<a name="line-36"></a>     <span class='hs-varid'>stk_adj_pop</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmAssign</span> <span class='hs-varid'>spReg</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmmRegOffW</span> <span class='hs-varid'>spReg</span> <span class='hs-varid'>final_stk_offset</span><span class='hs-layout'>)</span>
<a name="line-37"></a>     <span class='hs-varid'>stk_adj_push</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmAssign</span> <span class='hs-varid'>spReg</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmmRegOffW</span> <span class='hs-varid'>spReg</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span> <span class='hs-varid'>final_stk_offset</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-38"></a>     <span class='hs-varid'>jump_to_entry</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmJump</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLblExpr</span> <span class='hs-layout'>(</span><span class='hs-varid'>entryLabelFromCI</span> <span class='hs-varid'>cl_info</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span>
</pre>\end{code}


%************************************************************************
%*									*
\subsubsection[closure-code-wrappers]{Wrappers around closure code}
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="thunkWrapper"></a><span class='hs-definition'>thunkWrapper</span><span class='hs-keyglyph'>::</span> <span class='hs-conid'>ClosureInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-2"></a><span class='hs-definition'>thunkWrapper</span> <span class='hs-varid'>closure_info</span> <span class='hs-varid'>thunk_code</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-3"></a>  <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>node_points</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nodeMustPointToIt</span> <span class='hs-layout'>(</span><span class='hs-varid'>closureLFInfo</span> <span class='hs-varid'>closure_info</span><span class='hs-layout'>)</span>
<a name="line-4"></a>
<a name="line-5"></a>    <span class='hs-comment'>-- HWL: insert macros for GrAnSim; 2 versions depending on liveness of node</span>
<a name="line-6"></a>    <span class='hs-comment'>-- (we prefer fetchAndReschedule-style context switches to yield ones)</span>
<a name="line-7"></a>  <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>node_points</span> 
<a name="line-8"></a>    <span class='hs-keyword'>then</span> <span class='hs-varid'>granFetchAndReschedule</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>node_points</span> 
<a name="line-9"></a>    <span class='hs-keyword'>else</span> <span class='hs-varid'>granYield</span> 		<span class='hs-conid'>[]</span> <span class='hs-varid'>node_points</span>
<a name="line-10"></a>
<a name="line-11"></a>        <span class='hs-comment'>-- Stack and/or heap checks</span>
<a name="line-12"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>thunkEntryChecks</span> <span class='hs-varid'>closure_info</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-13"></a>      	<span class='hs-layout'>{</span>
<a name="line-14"></a>          <span class='hs-comment'>-- Overwrite with black hole if necessary</span>
<a name="line-15"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>whenC</span> <span class='hs-layout'>(</span><span class='hs-varid'>blackHoleOnEntry</span> <span class='hs-varid'>closure_info</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>node_points</span><span class='hs-layout'>)</span>
<a name="line-16"></a> 	        <span class='hs-layout'>(</span><span class='hs-varid'>blackHoleIt</span> <span class='hs-varid'>closure_info</span><span class='hs-layout'>)</span>
<a name="line-17"></a>	<span class='hs-layout'>;</span> <span class='hs-varid'>setupUpdate</span> <span class='hs-varid'>closure_info</span> <span class='hs-varid'>thunk_code</span> <span class='hs-layout'>}</span>
<a name="line-18"></a>		<span class='hs-comment'>-- setupUpdate *encloses* the thunk_code</span>
<a name="line-19"></a>  <span class='hs-layout'>}</span>
<a name="line-20"></a>
<a name="line-21"></a><a name="funWrapper"></a><span class='hs-definition'>funWrapper</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ClosureInfo</span> 	<span class='hs-comment'>-- Closure whose code body this is</span>
<a name="line-22"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>GlobalReg</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> 	<span class='hs-comment'>-- List of argument registers (if any)</span>
<a name="line-23"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CmmStmts</span>		<span class='hs-comment'>-- reg saves for the heap check failure</span>
<a name="line-24"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>		<span class='hs-comment'>-- Body of function being compiled</span>
<a name="line-25"></a>	   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-26"></a><span class='hs-definition'>funWrapper</span> <span class='hs-varid'>closure_info</span> <span class='hs-varid'>arg_regs</span> <span class='hs-varid'>reg_save_code</span> <span class='hs-varid'>fun_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-27"></a>  <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>node_points</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nodeMustPointToIt</span> <span class='hs-layout'>(</span><span class='hs-varid'>closureLFInfo</span> <span class='hs-varid'>closure_info</span><span class='hs-layout'>)</span>
<a name="line-28"></a>
<a name="line-29"></a>  <span class='hs-comment'>{-
<a name="line-30"></a>        -- Debugging: check that R1 has the correct tag
<a name="line-31"></a>  ; let tag = funTag closure_info
<a name="line-32"></a>  ; whenC (tag /= 0 &amp;&amp; node_points) $ do
<a name="line-33"></a>        l &lt;- newLabelC
<a name="line-34"></a>        stmtC (CmmCondBranch (CmmMachOp mo_wordEq [cmmGetTag (CmmReg nodeReg),
<a name="line-35"></a>                                                   CmmLit (mkIntCLit tag)]) l)
<a name="line-36"></a>        stmtC (CmmStore (CmmLit (mkWordCLit 0)) (CmmLit (mkWordCLit 0)))
<a name="line-37"></a>        labelC l
<a name="line-38"></a>  -}</span>
<a name="line-39"></a>
<a name="line-40"></a>   	<span class='hs-comment'>-- Enter for Ldv profiling</span>
<a name="line-41"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>whenC</span> <span class='hs-varid'>node_points</span> <span class='hs-layout'>(</span><span class='hs-varid'>ldvEnterClosure</span> <span class='hs-varid'>closure_info</span><span class='hs-layout'>)</span>
<a name="line-42"></a>
<a name="line-43"></a>	<span class='hs-comment'>-- GranSim yeild poin</span>
<a name="line-44"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>granYield</span> <span class='hs-varid'>arg_regs</span> <span class='hs-varid'>node_points</span>
<a name="line-45"></a>
<a name="line-46"></a>        <span class='hs-comment'>-- Heap and/or stack checks wrap the function body</span>
<a name="line-47"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>funEntryChecks</span> <span class='hs-varid'>closure_info</span> <span class='hs-varid'>reg_save_code</span> 
<a name="line-48"></a>		   <span class='hs-varid'>fun_body</span>
<a name="line-49"></a>  <span class='hs-layout'>}</span>
</pre>\end{code}


%************************************************************************
%*									*
\subsubsubsection[update-and-BHs]{Update and black-hole wrappers}
%*									*
%************************************************************************


\begin{code}
<pre><a name="line-1"></a><a name="blackHoleIt"></a><span class='hs-definition'>blackHoleIt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ClosureInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-2"></a><span class='hs-comment'>-- Only called for closures with no args</span>
<a name="line-3"></a><span class='hs-comment'>-- Node points to the closure</span>
<a name="line-4"></a><span class='hs-definition'>blackHoleIt</span> <span class='hs-varid'>closure_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emitBlackHoleCode</span> <span class='hs-layout'>(</span><span class='hs-varid'>closureSingleEntry</span> <span class='hs-varid'>closure_info</span><span class='hs-layout'>)</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="emitBlackHoleCode"></a><span class='hs-definition'>emitBlackHoleCode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>
<a name="line-7"></a><span class='hs-definition'>emitBlackHoleCode</span> <span class='hs-varid'>is_single_entry</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-8"></a>  <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-9"></a>
<a name="line-10"></a>  <span class='hs-comment'>-- Eager blackholing is normally disabled, but can be turned on with</span>
<a name="line-11"></a>  <span class='hs-comment'>-- -feager-blackholing.  When it is on, we replace the info pointer</span>
<a name="line-12"></a>  <span class='hs-comment'>-- of the thunk with stg_EAGER_BLACKHOLE_info on entry.</span>
<a name="line-13"></a>  
<a name="line-14"></a>  <span class='hs-comment'>-- If we wanted to do eager blackholing with slop filling, we'd need</span>
<a name="line-15"></a>  <span class='hs-comment'>-- to do it at the *end* of a basic block, otherwise we overwrite</span>
<a name="line-16"></a>  <span class='hs-comment'>-- the free variables in the thunk that we still need.  We have a</span>
<a name="line-17"></a>  <span class='hs-comment'>-- patch for this from Andy Cheadle, but not incorporated yet. --SDM</span>
<a name="line-18"></a>  <span class='hs-comment'>-- [6/2004]</span>
<a name="line-19"></a>  <span class='hs-comment'>--</span>
<a name="line-20"></a>  <span class='hs-comment'>-- Previously, eager blackholing was enabled when ticky-ticky was</span>
<a name="line-21"></a>  <span class='hs-comment'>-- on. But it didn't work, and it wasn't strictly necessary to bring</span>
<a name="line-22"></a>  <span class='hs-comment'>-- back minimal ticky-ticky, so now EAGER_BLACKHOLING is</span>
<a name="line-23"></a>  <span class='hs-comment'>-- unconditionally disabled. -- krc 1/2007</span>
<a name="line-24"></a>  
<a name="line-25"></a>  <span class='hs-comment'>-- Note the eager-blackholing check is here rather than in blackHoleOnEntry,</span>
<a name="line-26"></a>  <span class='hs-comment'>-- because emitBlackHoleCode is called from CmmParse.</span>
<a name="line-27"></a>
<a name="line-28"></a>  <span class='hs-keyword'>let</span>  <span class='hs-varid'>eager_blackholing</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>not</span> <span class='hs-varid'>opt_SccProfilingOn</span>
<a name="line-29"></a>                         <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_EagerBlackHoling</span> <span class='hs-varid'>dflags</span>
<a name="line-30"></a>             <span class='hs-comment'>-- Profiling needs slop filling (to support LDV</span>
<a name="line-31"></a>             <span class='hs-comment'>-- profiling), so currently eager blackholing doesn't</span>
<a name="line-32"></a>             <span class='hs-comment'>-- work with profiling.</span>
<a name="line-33"></a>
<a name="line-34"></a>  <span class='hs-varid'>whenC</span> <span class='hs-varid'>eager_blackholing</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-35"></a>    <span class='hs-varid'>tickyBlackHole</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varid'>is_single_entry</span><span class='hs-layout'>)</span>
<a name="line-36"></a>    <span class='hs-varid'>stmtsC</span> <span class='hs-keyglyph'>[</span>
<a name="line-37"></a>       <span class='hs-conid'>CmmStore</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmmOffsetW</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-varid'>nodeReg</span><span class='hs-layout'>)</span> <span class='hs-varid'>fixedHdrSize</span><span class='hs-layout'>)</span>
<a name="line-38"></a>                <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmGlobal</span> <span class='hs-conid'>CurrentTSO</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-39"></a>       <span class='hs-conid'>CmmCall</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmPrim</span> <span class='hs-conid'>MO_WriteBarrier</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>CmmMayReturn</span><span class='hs-layout'>,</span>
<a name="line-40"></a>       <span class='hs-conid'>CmmStore</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-varid'>nodeReg</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmGlobal</span> <span class='hs-conid'>EagerBlackholeInfo</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-41"></a>     <span class='hs-keyglyph'>]</span>
</pre>\end{code}

\begin{code}
<pre><a name="line-1"></a><a name="setupUpdate"></a><span class='hs-definition'>setupUpdate</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ClosureInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Code</span>	<span class='hs-comment'>-- Only called for closures with no args</span>
<a name="line-2"></a>	<span class='hs-comment'>-- Nota Bene: this function does not change Node (even if it's a CAF),</span>
<a name="line-3"></a>	<span class='hs-comment'>-- so that the cost centre in the original closure can still be</span>
<a name="line-4"></a>	<span class='hs-comment'>-- extracted by a subsequent enterCostCentre</span>
<a name="line-5"></a><span class='hs-definition'>setupUpdate</span> <span class='hs-varid'>closure_info</span> <span class='hs-varid'>code</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>closureReEntrant</span> <span class='hs-varid'>closure_info</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>code</span>
<a name="line-8"></a>
<a name="line-9"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isStaticClosure</span> <span class='hs-varid'>closure_info</span><span class='hs-layout'>)</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-11"></a>   <span class='hs-keyword'>if</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>closureUpdReqd</span> <span class='hs-varid'>closure_info</span><span class='hs-layout'>)</span>
<a name="line-12"></a>      <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>tickyUpdateFrameOmitted</span><span class='hs-layout'>;</span> <span class='hs-varid'>code</span>
<a name="line-13"></a>      <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-14"></a>          <span class='hs-varid'>tickyPushUpdateFrame</span>
<a name="line-15"></a>          <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-16"></a>          <span class='hs-keyword'>if</span> <span class='hs-varid'>not</span> <span class='hs-varid'>opt_SccProfilingOn</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_EagerBlackHoling</span> <span class='hs-varid'>dflags</span>
<a name="line-17"></a>              <span class='hs-keyword'>then</span> <span class='hs-varid'>pushBHUpdateFrame</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-varid'>nodeReg</span><span class='hs-layout'>)</span> <span class='hs-varid'>code</span>
<a name="line-18"></a>              <span class='hs-keyword'>else</span> <span class='hs-varid'>pushUpdateFrame</span>   <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-varid'>nodeReg</span><span class='hs-layout'>)</span> <span class='hs-varid'>code</span>
<a name="line-19"></a>  
<a name="line-20"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>	<span class='hs-comment'>-- A static closure</span>
<a name="line-21"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> 	<span class='hs-layout'>{</span> <span class='hs-varid'>tickyUpdateBhCaf</span> <span class='hs-varid'>closure_info</span>
<a name="line-22"></a>
<a name="line-23"></a>	<span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>closureUpdReqd</span> <span class='hs-varid'>closure_info</span>
<a name="line-24"></a>	  <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span>	<span class='hs-comment'>-- Blackhole the (updatable) CAF:</span>
<a name="line-25"></a>		<span class='hs-layout'>{</span> <span class='hs-varid'>upd_closure</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>link_caf</span> <span class='hs-varid'>closure_info</span> <span class='hs-conid'>True</span>
<a name="line-26"></a>		<span class='hs-layout'>;</span> <span class='hs-varid'>pushBHUpdateFrame</span> <span class='hs-varid'>upd_closure</span> <span class='hs-varid'>code</span> <span class='hs-layout'>}</span>
<a name="line-27"></a>	  <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-28"></a>		<span class='hs-layout'>{</span> <span class='hs-comment'>-- krc: removed some ticky-related code here.</span>
<a name="line-29"></a>		<span class='hs-layout'>;</span> <span class='hs-varid'>tickyUpdateFrameOmitted</span>
<a name="line-30"></a>		<span class='hs-layout'>;</span> <span class='hs-varid'>code</span> <span class='hs-layout'>}</span>
<a name="line-31"></a>    <span class='hs-layout'>}</span>
<a name="line-32"></a>
<a name="line-33"></a>
<a name="line-34"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-35"></a><span class='hs-comment'>-- Entering a CAF</span>
<a name="line-36"></a><span class='hs-comment'>--</span>
<a name="line-37"></a><span class='hs-comment'>-- When a CAF is first entered, it creates a black hole in the heap,</span>
<a name="line-38"></a><span class='hs-comment'>-- and updates itself with an indirection to this new black hole.</span>
<a name="line-39"></a><span class='hs-comment'>--</span>
<a name="line-40"></a><span class='hs-comment'>-- We update the CAF with an indirection to a newly-allocated black</span>
<a name="line-41"></a><span class='hs-comment'>-- hole in the heap.  We also set the blocking queue on the newly</span>
<a name="line-42"></a><span class='hs-comment'>-- allocated black hole to be empty.</span>
<a name="line-43"></a><span class='hs-comment'>--</span>
<a name="line-44"></a><span class='hs-comment'>-- Why do we make a black hole in the heap when we enter a CAF?</span>
<a name="line-45"></a><span class='hs-comment'>--    </span>
<a name="line-46"></a><span class='hs-comment'>--     - for a  generational garbage collector, which needs a fast</span>
<a name="line-47"></a><span class='hs-comment'>--       test for whether an updatee is in an old generation or not</span>
<a name="line-48"></a><span class='hs-comment'>--</span>
<a name="line-49"></a><span class='hs-comment'>--     - for the parallel system, which can implement updates more</span>
<a name="line-50"></a><span class='hs-comment'>--       easily if the updatee is always in the heap. (allegedly).</span>
<a name="line-51"></a><span class='hs-comment'>--</span>
<a name="line-52"></a><span class='hs-comment'>-- When debugging, we maintain a separate CAF list so we can tell when</span>
<a name="line-53"></a><span class='hs-comment'>-- a CAF has been garbage collected.</span>
<a name="line-54"></a>
<a name="line-55"></a><span class='hs-comment'>-- newCAF must be called before the itbl ptr is overwritten, since</span>
<a name="line-56"></a><span class='hs-comment'>-- newCAF records the old itbl ptr in order to do CAF reverting</span>
<a name="line-57"></a><span class='hs-comment'>-- (which Hugs needs to do in order that combined mode works right.)</span>
<a name="line-58"></a><span class='hs-comment'>--</span>
<a name="line-59"></a>
<a name="line-60"></a><span class='hs-comment'>-- ToDo [Feb 04]  This entire link_caf nonsense could all be moved</span>
<a name="line-61"></a><span class='hs-comment'>-- into the "newCAF" RTS procedure, which we call anyway, including</span>
<a name="line-62"></a><span class='hs-comment'>-- the allocation of the black-hole indirection closure.</span>
<a name="line-63"></a><span class='hs-comment'>-- That way, code size would fall, the CAF-handling code would </span>
<a name="line-64"></a><span class='hs-comment'>-- be closer together, and the compiler wouldn't need to know</span>
<a name="line-65"></a><span class='hs-comment'>-- about off_indirectee etc.</span>
<a name="line-66"></a>
<a name="line-67"></a><a name="link_caf"></a><span class='hs-definition'>link_caf</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ClosureInfo</span>
<a name="line-68"></a>	 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>		<span class='hs-comment'>-- True &lt;=&gt; updatable, False &lt;=&gt; single-entry</span>
<a name="line-69"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FCode</span> <span class='hs-conid'>CmmExpr</span>       <span class='hs-comment'>-- Returns amode for closure to be updated</span>
<a name="line-70"></a><span class='hs-comment'>-- To update a CAF we must allocate a black hole, link the CAF onto the</span>
<a name="line-71"></a><span class='hs-comment'>-- CAF list, then update the CAF to point to the fresh black hole.</span>
<a name="line-72"></a><span class='hs-comment'>-- This function returns the address of the black hole, so it can be</span>
<a name="line-73"></a><span class='hs-comment'>-- updated with the new value when available.  The reason for all of this</span>
<a name="line-74"></a><span class='hs-comment'>-- is that we only want to update dynamic heap objects, not static ones,</span>
<a name="line-75"></a><span class='hs-comment'>-- so that generational GC is easier.</span>
<a name="line-76"></a><span class='hs-definition'>link_caf</span> <span class='hs-varid'>cl_info</span> <span class='hs-sel'>_is_upd</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-77"></a>  <span class='hs-layout'>{</span> 	<span class='hs-comment'>-- Alloc black hole specifying CC_HDR(Node) as the cost centre</span>
<a name="line-78"></a>  <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span>	<span class='hs-varid'>use_cc</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>costCentreFrom</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-varid'>nodeReg</span><span class='hs-layout'>)</span>
<a name="line-79"></a>        <span class='hs-varid'>blame_cc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>use_cc</span>
<a name="line-80"></a>        <span class='hs-varid'>tso</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CmmReg</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmGlobal</span> <span class='hs-conid'>CurrentTSO</span><span class='hs-layout'>)</span>
<a name="line-81"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>hp_offset</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>allocDynClosure</span> <span class='hs-varid'>bh_cl_info</span> <span class='hs-varid'>use_cc</span> <span class='hs-varid'>blame_cc</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>tso</span><span class='hs-layout'>,</span><span class='hs-varid'>fixedHdrSize</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-82"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>hp_rel</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHpRelOffset</span> <span class='hs-varid'>hp_offset</span>
<a name="line-83"></a>
<a name="line-84"></a>	<span class='hs-comment'>-- Call the RTS function newCAF to add the CAF to the CafList</span>
<a name="line-85"></a>	<span class='hs-comment'>-- so that the garbage collector can find them</span>
<a name="line-86"></a>	<span class='hs-comment'>-- This must be done *before* the info table pointer is overwritten, </span>
<a name="line-87"></a>	<span class='hs-comment'>-- because the old info table ptr is needed for reversion</span>
<a name="line-88"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>ret</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTemp</span> <span class='hs-varid'>bWord</span>
<a name="line-89"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>emitRtsCallGen</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CmmHinted</span> <span class='hs-varid'>ret</span> <span class='hs-conid'>NoHint</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>rtsPackageId</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"newCAF"</span><span class='hs-layout'>)</span>
<a name="line-90"></a>      <span class='hs-keyglyph'>[</span> <span class='hs-conid'>CmmHinted</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmGlobal</span> <span class='hs-conid'>BaseReg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conid'>AddrHint</span><span class='hs-layout'>,</span>
<a name="line-91"></a>        <span class='hs-conid'>CmmHinted</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-varid'>nodeReg</span><span class='hs-layout'>)</span> <span class='hs-conid'>AddrHint</span><span class='hs-layout'>,</span>
<a name="line-92"></a>        <span class='hs-conid'>CmmHinted</span> <span class='hs-varid'>hp_rel</span> <span class='hs-conid'>AddrHint</span> <span class='hs-keyglyph'>]</span>
<a name="line-93"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>node</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-94"></a>	<span class='hs-comment'>-- node is live, so save it.</span>
<a name="line-95"></a>
<a name="line-96"></a>  <span class='hs-comment'>-- see Note [atomic CAF entry] in rts/sm/Storage.c</span>
<a name="line-97"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>emitIf</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmMachOp</span> <span class='hs-varid'>mo_wordEq</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>CmmReg</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmLocal</span> <span class='hs-varid'>ret</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>CmmLit</span> <span class='hs-varid'>zeroCLit</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-98"></a>        <span class='hs-comment'>-- re-enter R1.  Doing this directly is slightly dodgy; we're</span>
<a name="line-99"></a>        <span class='hs-comment'>-- assuming lots of things, like the stack pointer hasn't</span>
<a name="line-100"></a>        <span class='hs-comment'>-- moved since we entered the CAF.</span>
<a name="line-101"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>target</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>entryCode</span> <span class='hs-layout'>(</span><span class='hs-varid'>closureInfoPtr</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmReg</span> <span class='hs-varid'>nodeReg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>in</span>
<a name="line-102"></a>        <span class='hs-varid'>stmtC</span> <span class='hs-layout'>(</span><span class='hs-conid'>CmmJump</span> <span class='hs-varid'>target</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-103"></a>
<a name="line-104"></a>  <span class='hs-layout'>;</span> <span class='hs-varid'>returnFC</span> <span class='hs-varid'>hp_rel</span> <span class='hs-layout'>}</span>
<a name="line-105"></a>  <span class='hs-keyword'>where</span>
<a name="line-106"></a>    <span class='hs-varid'>bh_cl_info</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ClosureInfo</span>
<a name="line-107"></a>    <span class='hs-varid'>bh_cl_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cafBlackHoleClosureInfo</span> <span class='hs-varid'>cl_info</span>
</pre>\end{code}


%************************************************************************
%*									*
\subsection[CgClosure-Description]{Profiling Closure Description.}
%*									*
%************************************************************************

For "global" data constructors the description is simply occurrence
name of the data constructor itself.  Otherwise it is determined by
@closureDescription@ from the let binding information.

\begin{code}
<pre><a name="line-1"></a><a name="closureDescription"></a><span class='hs-definition'>closureDescription</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span>		<span class='hs-comment'>-- Module</span>
<a name="line-2"></a>		   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>		<span class='hs-comment'>-- Id of closure binding</span>
<a name="line-3"></a>		   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-4"></a>	<span class='hs-comment'>-- Not called for StgRhsCon which have global info tables built in</span>
<a name="line-5"></a>	<span class='hs-comment'>-- CgConTbls.lhs with a description generated from the data constructor</span>
<a name="line-6"></a><span class='hs-definition'>closureDescription</span> <span class='hs-varid'>mod_name</span> <span class='hs-varid'>name</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>showSDocDumpOneLine</span> <span class='hs-layout'>(</span><span class='hs-varid'>char</span> <span class='hs-chr'>'&lt;'</span> <span class='hs-varop'>&lt;&gt;</span>
<a name="line-8"></a>		    <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>isExternalName</span> <span class='hs-varid'>name</span>
<a name="line-9"></a>		      <span class='hs-keyword'>then</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-comment'>-- ppr will include the module name prefix</span>
<a name="line-10"></a>		      <span class='hs-keyword'>else</span> <span class='hs-varid'>pprModule</span> <span class='hs-varid'>mod_name</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'.'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span>
<a name="line-11"></a>		    <span class='hs-varid'>char</span> <span class='hs-chr'>'&gt;'</span><span class='hs-layout'>)</span>
<a name="line-12"></a>   <span class='hs-comment'>-- showSDocDumpOneLine, because we want to see the unique on the Name.</span>
</pre>\end{code}
  
</body>
</html>
